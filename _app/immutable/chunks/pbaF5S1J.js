import{ba as _n,aV as Ze,av as rs,L as Pn,K as Nn,h as Ln,bb as as}from"./EigO5Itq.js";import{w as Q,j,g as T}from"./CE5Oy5gg.js";import{_ as Bt}from"./PPVm8Dsz.js";import{$ as me}from"./B3FtJd8P.js";import{a as wt,d as os}from"./2Gu058ss.js";function da(e,t,n=t){var s=new WeakSet;_n(e,"input",async r=>{var a=r?e.defaultValue:e.value;if(a=qt(e)?Ht(a):a,n(a),Ze!==null&&s.add(Ze),await rs(),a!==(a=t())){var o=e.selectionStart,l=e.selectionEnd,c=e.value.length;if(e.value=a??"",l!==null){var h=e.value.length;o===l&&l===c&&h>c?(e.selectionStart=h,e.selectionEnd=h):(e.selectionStart=o,e.selectionEnd=Math.min(l,h))}}}),(Ln&&e.defaultValue!==e.value||Pn(t)==null&&e.value)&&(n(qt(e)?Ht(e.value):e.value),Ze!==null&&s.add(Ze)),Nn(()=>{var r=t();if(e===document.activeElement){var a=as??Ze;if(s.has(a))return}qt(e)&&r===Ht(e.value)||e.type==="date"&&!r&&!e.value||r!==e.value&&(e.value=r??"")})}function ma(e,t,n=t){_n(e,"change",s=>{var r=s?e.defaultChecked:e.checked;n(r)}),(Ln&&e.defaultChecked!==e.checked||Pn(t)==null)&&n(e.checked),Nn(()=>{var s=t();e.checked=!!s})}function qt(e){var t=e.type;return t==="number"||t==="range"}function Ht(e){return e===""?null:+e}const bt="0123456789abcdef";class Oe{constructor(t){this.bytes=t}static ofInner(t){if(t.length!==16)throw new TypeError("not 128-bit length");return new Oe(t)}static fromFieldsV7(t,n,s,r){if(!Number.isInteger(t)||!Number.isInteger(n)||!Number.isInteger(s)||!Number.isInteger(r)||t<0||n<0||s<0||r<0||t>0xffffffffffff||n>4095||s>1073741823||r>4294967295)throw new RangeError("invalid field value");const a=new Uint8Array(16);return a[0]=t/2**40,a[1]=t/2**32,a[2]=t/2**24,a[3]=t/2**16,a[4]=t/2**8,a[5]=t,a[6]=112|n>>>8,a[7]=n,a[8]=128|s>>>24,a[9]=s>>>16,a[10]=s>>>8,a[11]=s,a[12]=r>>>24,a[13]=r>>>16,a[14]=r>>>8,a[15]=r,new Oe(a)}static parse(t){var n,s,r,a;let o;switch(t.length){case 32:o=(n=/^[0-9a-f]{32}$/i.exec(t))===null||n===void 0?void 0:n[0];break;case 36:o=(s=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(t))===null||s===void 0?void 0:s.slice(1,6).join("");break;case 38:o=(r=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(t))===null||r===void 0?void 0:r.slice(1,6).join("");break;case 45:o=(a=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(t))===null||a===void 0?void 0:a.slice(1,6).join("");break}if(o){const l=new Uint8Array(16);for(let c=0;c<16;c+=4){const h=parseInt(o.substring(2*c,2*c+8),16);l[c+0]=h>>>24,l[c+1]=h>>>16,l[c+2]=h>>>8,l[c+3]=h}return new Oe(l)}else throw new SyntaxError("could not parse UUID string")}toString(){let t="";for(let n=0;n<this.bytes.length;n++)t+=bt.charAt(this.bytes[n]>>>4),t+=bt.charAt(this.bytes[n]&15),(n===3||n===5||n===7||n===9)&&(t+="-");return t}toHex(){let t="";for(let n=0;n<this.bytes.length;n++)t+=bt.charAt(this.bytes[n]>>>4),t+=bt.charAt(this.bytes[n]&15);return t}toJSON(){return this.toString()}getVariant(){const t=this.bytes[8]>>>4;if(t<0)throw new Error("unreachable");if(t<=7)return this.bytes.every(n=>n===0)?"NIL":"VAR_0";if(t<=11)return"VAR_10";if(t<=13)return"VAR_110";if(t<=15)return this.bytes.every(n=>n===255)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return this.getVariant()==="VAR_10"?this.bytes[6]>>>4:void 0}clone(){return new Oe(this.bytes.slice(0))}equals(t){return this.compareTo(t)===0}compareTo(t){for(let n=0;n<16;n++){const s=this.bytes[n]-t.bytes[n];if(s!==0)return Math.sign(s)}return 0}}class is{constructor(t){this.timestamp_biased=0,this.counter=0,this.random=t??ls()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(t,n){let s=this.generateOrAbortCore(t,n);return s===void 0&&(this.timestamp_biased=0,s=this.generateOrAbortCore(t,n)),s}generateOrAbortCore(t,n){if(!Number.isInteger(t)||t<0||t>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit unsigned integer");if(n<0||n>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(t++,t>this.timestamp_biased)this.timestamp_biased=t,this.resetCounter();else if(t+n>=this.timestamp_biased)this.counter++,this.counter>4398046511103&&(this.timestamp_biased++,this.resetCounter());else return;return Oe.fromFieldsV7(this.timestamp_biased-1,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=this.random.nextUint32()*1024+(this.random.nextUint32()&1023)}generateV4(){const t=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return t[6]=64|t[6]>>>4,t[8]=128|t[8]>>>2,Oe.ofInner(t)}}const ls=()=>{if(typeof crypto<"u"&&typeof crypto.getRandomValues<"u")return new cs;if(typeof UUIDV7_DENY_WEAK_RNG<"u"&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>Math.trunc(Math.random()*65536)*65536+Math.trunc(Math.random()*65536)}};class cs{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}let fn;const ot=()=>us().toString(),us=()=>(fn||(fn=new is)).generate(),{floor:fs,random:ps}=Math,ct="Trystero",ut=(e,t)=>Array(e).fill().map(t),pn="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",Un=e=>ut(e,()=>pn[fs(ps()*pn.length)]).join(""),Ue=Un(20),ke=Promise.all.bind(Promise),Dn=typeof window<"u",{entries:jt,fromEntries:qn,keys:hs}=Object,he=()=>{},de=e=>new Error(`${ct}: ${e}`),ds=new TextEncoder,ms=new TextDecoder,He=e=>ds.encode(e),St=e=>ms.decode(e),At=(...e)=>e.join("@"),gs=(e,t,n,s)=>(e.relayUrls||t).slice(0,e.relayUrls?e.relayUrls.length:e.relayRedundancy||n),ft=JSON.stringify,pt=JSON.parse,hn=3333,Et={};let it=null,Jt=null;const ys=()=>{it||(it=new Promise(e=>{Jt=e}).finally(()=>{Jt=null,it=null}))},vs=()=>Jt?.(),ws=(e,t)=>{const n={},s=()=>{const r=new WebSocket(e);r.onclose=()=>{if(it){it.then(s);return}Et[e]??=hn,setTimeout(s,Et[e]),Et[e]*=2},r.onmessage=a=>t(a.data),n.socket=r,n.url=r.url,n.ready=new Promise(a=>r.onopen=()=>{a(n),Et[e]=hn}),n.send=a=>{r.readyState===1&&r.send(a)}};return s(),n},bs=()=>{if(Dn){const e=new AbortController;return addEventListener("online",vs,{signal:e.signal}),addEventListener("offline",ys,{signal:e.signal}),()=>e.abort()}return he},Yt="AES-GCM",As={},Es=e=>btoa(String.fromCharCode.apply(null,new Uint8Array(e))),Ms=e=>{const t=atob(e);return new Uint8Array(t.length).map((n,s)=>t.charCodeAt(s)).buffer},Ts=async(e,t)=>new Uint8Array(await crypto.subtle.digest(e,He(t))),st=async e=>As[e]||=Array.from(await Ts("SHA-1",e)).map(t=>t.toString(36)).join(""),Ss=async(e,t,n)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},He(`${e}:${t}:${n}`)),{name:Yt},!1,["encrypt","decrypt"]),Hn="$",Vn=",",ks=async(e,t)=>{const n=crypto.getRandomValues(new Uint8Array(16));return n.join(Vn)+Hn+Es(await crypto.subtle.encrypt({name:Yt,iv:n},await e,He(t)))},xs=async(e,t)=>{const[n,s]=t.split(Hn);return St(await crypto.subtle.decrypt({name:Yt,iv:new Uint8Array(n.split(Vn))},await e,Ms(s)))},Os=5e3,dn="icegatheringstatechange",mn="offer",Cs="answer",gn=(e,{rtcConfig:t,rtcPolyfill:n,turnConfig:s})=>{const r=new(n||RTCPeerConnection)({iceServers:Rs.concat(s||[]),...t}),a={};let o=!1,l=!1,c=null;const h=f=>{f.binaryType="arraybuffer",f.bufferedAmountLowThreshold=65535,f.onmessage=i=>a.data?.(i.data),f.onopen=()=>a.connect?.(),f.onclose=()=>a.close?.(),f.onerror=i=>a.error?.(i)},p=f=>Promise.race([new Promise(i=>{const m=()=>{f.iceGatheringState==="complete"&&(f.removeEventListener(dn,m),i())};f.addEventListener(dn,m),m()}),new Promise(i=>setTimeout(i,Os))]).then(()=>({type:f.localDescription.type,sdp:f.localDescription.sdp.replace(/a=ice-options:trickle\s\n/g,"")}));return e?(c=r.createDataChannel("data"),h(c)):r.ondatachannel=({channel:f})=>{c=f,h(f)},r.onnegotiationneeded=async()=>{try{o=!0,await r.setLocalDescription();const f=await p(r);a.signal?.(f)}catch(f){a.error?.(f)}finally{o=!1}},r.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(r.connectionState)&&a.close?.()},r.ontrack=f=>{a.track?.(f.track,f.streams[0]),a.stream?.(f.streams[0])},r.onremovestream=f=>a.stream?.(f.stream),e&&(r.canTrickleIceCandidates||r.onnegotiationneeded()),{created:Date.now(),connection:r,get channel(){return c},get isDead(){return r.connectionState==="closed"},async signal(f){if(!(c?.readyState==="open"&&!f.sdp?.includes("a=rtpmap")))try{if(f.type===mn){if(o||r.signalingState!=="stable"&&!l){if(e)return;await ke([r.setLocalDescription({type:"rollback"}),r.setRemoteDescription(f)])}else await r.setRemoteDescription(f);await r.setLocalDescription();const i=await p(r);return a.signal?.(i),i}else if(f.type===Cs){l=!0;try{await r.setRemoteDescription(f)}finally{l=!1}}}catch(i){a.error?.(i)}},sendData:f=>c.send(f),destroy:()=>{c?.close(),r.close(),o=!1,l=!1},setHandlers:f=>Object.assign(a,f),offerPromise:e?new Promise(f=>a.signal=i=>{i.type===mn&&f(i)}):Promise.resolve(),addStream:f=>f.getTracks().forEach(i=>r.addTrack(i,f)),removeStream:f=>r.getSenders().filter(i=>f.getTracks().includes(i.track)).forEach(i=>r.removeTrack(i)),addTrack:(f,i)=>r.addTrack(f,i),removeTrack:f=>{const i=r.getSenders().find(m=>m.track===f);i&&r.removeTrack(i)},replaceTrack:(f,i)=>{const m=r.getSenders().find(S=>S.track===f);if(m)return m.replaceTrack(i)}}},Rs=[...ut(3,(e,t)=>`stun:stun${t||""}.l.google.com:19302`),"stun:stun.cloudflare.com:3478"].map(e=>({urls:e})),Is=Object.getPrototypeOf(Uint8Array),kt=12,$n=0,xt=$n+kt,Ot=xt+1,rt=Ot+1,at=rt+1,Te=16*2**10-at,Mt=255,yn="bufferedamountlow",Le=e=>"@_"+e,_s=(e,t,n)=>{const s={},r={},a={},o={},l={},c={},h={},p={onPeerJoin:he,onPeerLeave:he,onPeerStream:he,onPeerTrack:he},f=(d,y)=>(d?Array.isArray(d)?d:[d]:hs(s)).flatMap(k=>{const C=s[k];return C?y(k,C):(console.warn(`${ct}: no peer with id ${k} found`),[])}),i=d=>{s[d]&&(s[d].destroy(),delete s[d],delete o[d],delete l[d],p.onPeerLeave(d),t(d))},m=d=>{if(r[d])return a[d];if(!d)throw de("action type argument is required");const y=He(d);if(y.byteLength>kt)throw de(`action type string "${d}" (${y.byteLength}b) exceeds byte limit (${kt}). Hint: choose a shorter name.`);const k=new Uint8Array(kt);k.set(y);let C=0;return r[d]={onComplete:he,onProgress:he,setOnComplete:q=>r[d]={...r[d],onComplete:q},setOnProgress:q=>r[d]={...r[d],onProgress:q},send:async(q,v,E,$)=>{if(E&&typeof E!="object")throw de("action meta argument must be an object");const Z=typeof q;if(Z==="undefined")throw de("action data cannot be undefined");const W=Z!=="string",ie=q instanceof Blob,L=ie||q instanceof ArrayBuffer||q instanceof Is;if(E&&!L)throw de("action meta argument can only be used with binary data");const X=L?new Uint8Array(ie?await q.arrayBuffer():q):He(W?ft(q):q),ae=E?He(ft(E)):null,B=Math.ceil(X.byteLength/Te)+(E?1:0)||1,z=ut(B,(K,Y)=>{const le=Y===B-1,ce=E&&Y===0,ue=new Uint8Array(at+(ce?ae.byteLength:le?X.byteLength-Te*(B-(E?2:1)):Te));return ue.set(k),ue.set([C],xt),ue.set([le|ce<<1|L<<2|W<<3],Ot),ue.set([Math.round((Y+1)/B*Mt)],rt),ue.set(E?ce?ae:X.subarray((Y-1)*Te,Y*Te):X.subarray(Y*Te,(Y+1)*Te),at),ue});return C=C+1&Mt,ke(f(v,async(K,Y)=>{const{channel:le}=Y;let ce=0;for(;ce<B;){const ue=z[ce];if(le.bufferedAmount>le.bufferedAmountLowThreshold&&await new Promise(ss=>{const un=()=>{le.removeEventListener(yn,un),ss()};le.addEventListener(yn,un)}),!s[K])break;Y.sendData(ue),ce++,$?.(ue[rt]/Mt,K,E)}}))}},a[d]||=[r[d].send,r[d].setOnComplete,r[d].setOnProgress]},S=(d,y)=>{const k=new Uint8Array(y),C=St(k.subarray($n,xt)).replaceAll("\0",""),[q]=k.subarray(xt,Ot),[v]=k.subarray(Ot,rt),[E]=k.subarray(rt,at),$=k.subarray(at),Z=!!(v&1),W=!!(v&2),ie=!!(v&4),L=!!(v&8);if(!r[C]){console.warn(`${ct}: received message with unregistered type (${C})`);return}o[d]||={},o[d][C]||={};const X=o[d][C][q]||={chunks:[]};if(W?X.meta=pt(St($)):X.chunks.push($),r[C].onProgress(E/Mt,d,X.meta),!Z)return;const ae=new Uint8Array(X.chunks.reduce((B,z)=>B+z.byteLength,0));if(X.chunks.reduce((B,z)=>(ae.set(z,B),B+z.byteLength),0),delete o[d][C][q],ie)r[C].onComplete(ae,d,X.meta);else{const B=St(ae);r[C].onComplete(L?pt(B):B,d)}},u=async()=>{await x(""),await new Promise(d=>setTimeout(d,99)),jt(s).forEach(([d,y])=>{y.destroy(),delete s[d]}),n()},[g,I]=m(Le("ping")),[H,_]=m(Le("pong")),[M,N]=m(Le("signal")),[P,R]=m(Le("stream")),[J,b]=m(Le("track")),[x,se]=m(Le("leave"));return e((d,y)=>{s[y]||(s[y]=d,d.setHandlers({data:k=>S(y,k),stream:k=>{p.onPeerStream(k,y,c[y]),delete c[y]},track:(k,C)=>{p.onPeerTrack(k,C,y,h[y]),delete h[y]},signal:k=>M(k,y),close:()=>i(y),error:k=>{console.error(k),i(y)}}),p.onPeerJoin(y))}),I((d,y)=>H("",y)),_((d,y)=>{l[y]?.(),delete l[y]}),N((d,y)=>s[y]?.signal(d)),R((d,y)=>c[y]=d),b((d,y)=>h[y]=d),se((d,y)=>i(y)),Dn&&addEventListener("beforeunload",u),{makeAction:m,leave:u,ping:async d=>{if(!d)throw de("ping() must be called with target peer ID");const y=Date.now();return g("",d),await new Promise(k=>l[d]=k),Date.now()-y},getPeers:()=>qn(jt(s).map(([d,y])=>[d,y.connection])),addStream:(d,y,k)=>f(y,async(C,q)=>{k&&await P(k,C),q.addStream(d)}),removeStream:(d,y)=>f(y,(k,C)=>C.removeStream(d)),addTrack:(d,y,k,C)=>f(k,async(q,v)=>{C&&await J(C,q),v.addTrack(d,y)}),removeTrack:(d,y)=>f(y,(k,C)=>C.removeTrack(d)),replaceTrack:(d,y,k,C)=>f(k,async(q,v)=>{C&&await J(C,q),v.replaceTrack(d,y)}),onPeerJoin:d=>p.onPeerJoin=d,onPeerLeave:d=>p.onPeerLeave=d,onPeerStream:d=>p.onPeerStream=d,onPeerTrack:d=>p.onPeerTrack=d}},Ps=20,Ns=5333,vn=57333,Ls=({init:e,subscribe:t,announce:n})=>{const s={};let r=!1,a,o,l,c;return(h,p,f)=>{const{appId:i}=h;if(s[i]?.[p])return s[i][p];const m={},S={},u=At(ct,i,p),g=st(u),I=st(At(u,Ue)),H=Ss(h.password||"",i,p),_=v=>async E=>({type:E.type,sdp:await v(H,E.sdp)}),M=_(xs),N=_(ks),P=()=>gn(!0,h),R=(v,E,$)=>{if(S[E]){S[E]!==v&&v.destroy();return}S[E]=v,q(v,E),m[E]?.forEach((Z,W)=>{W!==$&&Z.destroy()}),delete m[E]},J=(v,E)=>{S[E]===v&&delete S[E]},b=(v,E)=>{if(S[v])return;const $=m[v]?.[E];$&&(delete m[v][E],$.destroy())},x=v=>(o.push(...ut(v,P)),ke(o.splice(0,v).map(E=>E.offerPromise.then(N).then($=>({peer:E,offer:$}))))),se=(v,E)=>f?.({error:`incorrect password (${h.password}) when decrypting ${E}`,appId:i,peerId:v,roomId:p}),d=v=>async(E,$,Z)=>{const[W,ie]=await ke([g,I]);if(E!==W&&E!==ie)return;const{peerId:L,offer:X,answer:ae,peer:B}=typeof $=="string"?pt($):$;if(!(L===Ue||S[L])){if(L&&!X&&!ae){if(m[L]?.[v])return;const[[{peer:z,offer:K}],Y]=await ke([x(1),st(At(u,L))]);m[L]||=[],m[L][v]=z,setTimeout(()=>b(L,v),y[v]*.9),z.setHandlers({connect:()=>R(z,L,v),close:()=>J(z,L)}),Z(Y,ft({peerId:Ue,offer:K}))}else if(X){if(m[L]?.[v]&&Ue>L)return;const K=gn(!1,h);K.setHandlers({connect:()=>R(K,L,v),close:()=>J(K,L)});let Y;try{Y=await M(X)}catch{se(L,"offer");return}if(K.isDead)return;const[le,ce]=await ke([st(At(u,L)),K.signal(Y)]);Z(le,ft({peerId:Ue,answer:await N(ce)}))}else if(ae){let z;try{z=await M(ae)}catch{se(L,"answer");return}if(B)B.setHandlers({connect:()=>R(B,L,v),close:()=>J(B,L)}),B.signal(z);else{const K=m[L]?.[v];K&&!K.isDead&&K.signal(z)}}}};if(!h)throw de("requires a config map as the first argument");if(!i&&!h.firebaseApp)throw de("config map is missing appId field");if(!p)throw de("roomId argument required");if(!r){const v=e(h);o=ut(Ps,P),a=Array.isArray(v)?v:[v],r=!0,l=setInterval(()=>o=o.filter(E=>{const $=Date.now()-E.created<vn;return $||E.destroy(),$}),vn*1.03),c=h.manualRelayReconnection?he:bs()}const y=a.map(()=>Ns),k=[],C=a.map(async(v,E)=>t(await v,await g,await I,d(E),x));ke([g,I]).then(([v,E])=>{const $=async(Z,W)=>{const ie=await n(Z,v,E);typeof ie=="number"&&(y[W]=ie),k[W]=setTimeout(()=>$(Z,W),y[W])};C.forEach(async(Z,W)=>{await Z,$(await a[W],W)})});let q=he;return s[i]||={},s[i][p]=_s(v=>q=v,v=>delete S[v],()=>{delete s[i][p],k.forEach(clearTimeout),C.forEach(async v=>(await v)()),clearInterval(l),c(),r=!1})}},Vt={},Fn={},et={},tt={},nt={},wn={},Tt={},Us="announce",Bn=20,bn=10,Ds=33333,qs=120333,Hs=3,Vs=async e=>{if(Vt[e])return Vt[e];const t=(await st(e)).slice(0,Bn);return Vt[e]=t,Fn[t]=e,t},An=async(e,t,n)=>e.send(ft({action:Us,info_hash:await Vs(t),peer_id:Ue,...n})),En=(e,t,n)=>console.warn(`${ct}: torrent tracker ${n?"failure":"warning"} from ${e} - ${t}`),jn=Ls({init:e=>gs(e,$s,Hs).map(t=>{const n=ws(t,r=>{const a=pt(r),o=a["failure reason"],l=a["warning message"],{interval:c}=a,h=Fn[a.info_hash];if(o){En(s,o,!0);return}if(l&&En(s,l),c&&c*1e3>nt[s]&&tt[s][h]){const p=Math.min(c*1e3,qs);clearInterval(et[s][h]),nt[s]=p,et[s][h]=setInterval(tt[s][h],p)}wn[a.offer_id]||(a.offer||a.answer)&&(wn[a.offer_id]=!0,Tt[s][h]?.(a))}),{url:s}=n;return Tt[s]={},n.ready}),subscribe:(e,t,n,s,r)=>{const{url:a}=e,o=async()=>{const l=qn((await r(bn)).map(c=>[Un(Bn),c]));Tt[e.url][t]=c=>{if(c.offer)s(t,{offer:c.offer,peerId:c.peer_id},(h,p)=>An(e,t,{answer:pt(p).answer,offer_id:c.offer_id,to_peer_id:c.peer_id}));else if(c.answer){const h=l[c.offer_id];h&&s(t,{answer:c.answer,peerId:c.peer_id,peer:h.peer})}},An(e,t,{numwant:bn,offers:jt(l).map(([c,{offer:h}])=>({offer_id:c,offer:h}))})};return nt[a]=Ds,tt[a]||={},tt[a][t]=o,et[a]||={},et[a][t]=setInterval(o,nt[a]),o(),()=>{clearInterval(et[a][t]),delete Tt[a][t],delete tt[a][t]}},announce:e=>nt[e.url]}),$s=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.btorrent.xyz","tracker.files.fm:7073/announce"].map(e=>"wss://"+e);var ne="INUMBER",ze="IOP1",Ke="IOP2",Xe="IOP3",ve="IVAR",Ie="IVARNAME",je="IFUNCALL",Ct="IFUNDEF",ee="IEXPR",Qt="IEXPREVAL",_e="IMEMBER",Rt="IENDSTATEMENT",Je="IARRAY";function O(e,t){this.type=e,this.value=t??0}O.prototype.toString=function(){switch(this.type){case ne:case ze:case Ke:case Xe:case ve:case Ie:case Rt:return this.value;case je:return"CALL "+this.value;case Ct:return"DEF "+this.value;case Je:return"ARRAY "+this.value;case _e:return"."+this.value;default:return"Invalid Instruction"}};function It(e){return new O(ze,e)}function be(e){return new O(Ke,e)}function Jn(e){return new O(Xe,e)}function Gt(e,t,n,s,r){for(var a=[],o=[],l,c,h,p,f=0;f<e.length;f++){var i=e[f],m=i.type;if(m===ne||m===Ie)Array.isArray(i.value)?a.push.apply(a,Gt(i.value.map(function(S){return new O(ne,S)}).concat(new O(Je,i.value.length)),t,n,s,r)):a.push(i);else if(m===ve&&r.hasOwnProperty(i.value))i=new O(ne,r[i.value]),a.push(i);else if(m===Ke&&a.length>1)c=a.pop(),l=a.pop(),p=n[i.value],i=new O(ne,p(l.value,c.value)),a.push(i);else if(m===Xe&&a.length>2)h=a.pop(),c=a.pop(),l=a.pop(),i.value==="?"?a.push(l.value?c.value:h.value):(p=s[i.value],i=new O(ne,p(l.value,c.value,h.value)),a.push(i));else if(m===ze&&a.length>0)l=a.pop(),p=t[i.value],i=new O(ne,p(l.value)),a.push(i);else if(m===ee){for(;a.length>0;)o.push(a.shift());o.push(new O(ee,Gt(i.value,t,n,s,r)))}else if(m===_e&&a.length>0)l=a.pop(),a.push(new O(ne,l.value[i.value]));else{for(;a.length>0;)o.push(a.shift());o.push(i)}}for(;a.length>0;)o.push(a.shift());return o}function Gn(e,t,n){for(var s=[],r=0;r<e.length;r++){var a=e[r],o=a.type;if(o===ve&&a.value===t)for(var l=0;l<n.tokens.length;l++){var c=n.tokens[l],h;c.type===ze?h=It(c.value):c.type===Ke?h=be(c.value):c.type===Xe?h=Jn(c.value):h=new O(c.type,c.value),s.push(h)}else o===ee?s.push(new O(ee,Gn(a.value,t,n))):s.push(a)}return s}function xe(e,t,n){var s=[],r,a,o,l,c,h;if(Zt(e))return fe(e,n);for(var p=e.length,f=0;f<p;f++){var i=e[f],m=i.type;if(m===ne||m===Ie)s.push(i.value);else if(m===Ke)a=s.pop(),r=s.pop(),i.value==="and"?s.push(r?!!xe(a,t,n):!1):i.value==="or"?s.push(r?!0:!!xe(a,t,n)):i.value==="="?(l=t.binaryOps[i.value],s.push(l(r,xe(a,t,n),n))):(l=t.binaryOps[i.value],s.push(l(fe(r,n),fe(a,n))));else if(m===Xe)o=s.pop(),a=s.pop(),r=s.pop(),i.value==="?"?s.push(xe(r?a:o,t,n)):(l=t.ternaryOps[i.value],s.push(l(fe(r,n),fe(a,n),fe(o,n))));else if(m===ve)if(i.value in t.functions)s.push(t.functions[i.value]);else if(i.value in t.unaryOps&&t.parser.isOperatorEnabled(i.value))s.push(t.unaryOps[i.value]);else{var S=n[i.value];if(S!==void 0)s.push(S);else throw new Error("undefined variable: "+i.value)}else if(m===ze)r=s.pop(),l=t.unaryOps[i.value],s.push(l(fe(r,n)));else if(m===je){for(h=i.value,c=[];h-- >0;)c.unshift(fe(s.pop(),n));if(l=s.pop(),l.apply&&l.call)s.push(l.apply(void 0,c));else throw new Error(l+" is not a function")}else if(m===Ct)s.push((function(){for(var u=s.pop(),g=[],I=i.value;I-- >0;)g.unshift(s.pop());var H=s.pop(),_=function(){for(var M=Object.assign({},n),N=0,P=g.length;N<P;N++)M[g[N]]=arguments[N];return xe(u,t,M)};return Object.defineProperty(_,"name",{value:H,writable:!1}),n[H]=_,_})());else if(m===ee)s.push(Fs(i,t));else if(m===Qt)s.push(i);else if(m===_e)r=s.pop(),s.push(r[i.value]);else if(m===Rt)s.pop();else if(m===Je){for(h=i.value,c=[];h-- >0;)c.unshift(s.pop());s.push(c)}else throw new Error("invalid Expression")}if(s.length>1)throw new Error("invalid Expression (parity)");return s[0]===0?0:fe(s[0],n)}function Fs(e,t,n){return Zt(e)?e:{type:Qt,value:function(s){return xe(e.value,t,s)}}}function Zt(e){return e&&e.type===Qt}function fe(e,t){return Zt(e)?e.value(t):e}function en(e,t){for(var n=[],s,r,a,o,l,c,h=0;h<e.length;h++){var p=e[h],f=p.type;if(f===ne)typeof p.value=="number"&&p.value<0?n.push("("+p.value+")"):Array.isArray(p.value)?n.push("["+p.value.map(Mn).join(", ")+"]"):n.push(Mn(p.value));else if(f===Ke)r=n.pop(),s=n.pop(),o=p.value,t?o==="^"?n.push("Math.pow("+s+", "+r+")"):o==="and"?n.push("(!!"+s+" && !!"+r+")"):o==="or"?n.push("(!!"+s+" || !!"+r+")"):o==="||"?n.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+s+"),("+r+")))"):o==="=="?n.push("("+s+" === "+r+")"):o==="!="?n.push("("+s+" !== "+r+")"):o==="["?n.push(s+"[("+r+") | 0]"):n.push("("+s+" "+o+" "+r+")"):o==="["?n.push(s+"["+r+"]"):n.push("("+s+" "+o+" "+r+")");else if(f===Xe)if(a=n.pop(),r=n.pop(),s=n.pop(),o=p.value,o==="?")n.push("("+s+" ? "+r+" : "+a+")");else throw new Error("invalid Expression");else if(f===ve||f===Ie)n.push(p.value);else if(f===ze)s=n.pop(),o=p.value,o==="-"||o==="+"?n.push("("+o+s+")"):t?o==="not"?n.push("(!"+s+")"):o==="!"?n.push("fac("+s+")"):n.push(o+"("+s+")"):o==="!"?n.push("("+s+"!)"):n.push("("+o+" "+s+")");else if(f===je){for(c=p.value,l=[];c-- >0;)l.unshift(n.pop());o=n.pop(),n.push(o+"("+l.join(", ")+")")}else if(f===Ct){for(r=n.pop(),c=p.value,l=[];c-- >0;)l.unshift(n.pop());s=n.pop(),t?n.push("("+s+" = function("+l.join(", ")+") { return "+r+" })"):n.push("("+s+"("+l.join(", ")+") = "+r+")")}else if(f===_e)s=n.pop(),n.push(s+"."+p.value);else if(f===Je){for(c=p.value,l=[];c-- >0;)l.unshift(n.pop());n.push("["+l.join(", ")+"]")}else if(f===ee)n.push("("+en(p.value,t)+")");else if(f!==Rt)throw new Error("invalid Expression")}return n.length>1&&(t?n=[n.join(",")]:n=[n.join(";")]),String(n[0])}function Mn(e){return typeof e=="string"?JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):e}function De(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return!0;return!1}function tn(e,t,n){n=n||{};for(var s=!!n.withMembers,r=null,a=0;a<e.length;a++){var o=e[a];o.type===ve||o.type===Ie?!s&&!De(t,o.value)?t.push(o.value):(r!==null&&(De(t,r)||t.push(r)),r=o.value):o.type===_e&&s&&r!==null?r+="."+o.value:o.type===ee?tn(o.value,t,n):r!==null&&(De(t,r)||t.push(r),r=null)}r!==null&&!De(t,r)&&t.push(r)}function re(e,t){this.tokens=e,this.parser=t,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.functions=t.functions}re.prototype.simplify=function(e){return e=e||{},new re(Gt(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,e),this.parser)};re.prototype.substitute=function(e,t){return t instanceof re||(t=this.parser.parse(String(t))),new re(Gn(this.tokens,e,t),this.parser)};re.prototype.evaluate=function(e){return e=e||{},xe(this.tokens,this,e)};re.prototype.toString=function(){return en(this.tokens,!1)};re.prototype.symbols=function(e){e=e||{};var t=[];return tn(this.tokens,t,e),t};re.prototype.variables=function(e){e=e||{};var t=[];tn(this.tokens,t,e);var n=this.functions;return t.filter(function(s){return!(s in n)})};re.prototype.toJSFunction=function(e,t){var n=this,s=new Function(e,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+en(this.simplify(t).tokens,!0)+"; }");return function(){return s.apply(n,arguments)}};var ht="TEOF",U="TOP",_t="TNUMBER",Wn="TSTRING",we="TPAREN",Ge="TBRACKET",Pt="TCOMMA",nn="TNAME",sn="TSEMICOLON";function zn(e,t,n){this.type=e,this.value=t,this.index=n}zn.prototype.toString=function(){return this.type+": "+this.value};function V(e,t){this.pos=0,this.current=null,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.consts=e.consts,this.expression=t,this.savedPosition=0,this.savedCurrent=null,this.options=e.options,this.parser=e}V.prototype.newToken=function(e,t,n){return new zn(e,t,n??this.pos)};V.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};V.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};V.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(ht,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};V.prototype.isString=function(){var e=!1,t=this.pos,n=this.expression.charAt(t);if(n==="'"||n==='"')for(var s=this.expression.indexOf(n,t+1);s>=0&&this.pos<this.expression.length;){if(this.pos=s+1,this.expression.charAt(s-1)!=="\\"){var r=this.expression.substring(t+1,s);this.current=this.newToken(Wn,this.unescape(r),t),e=!0;break}s=this.expression.indexOf(n,s+1)}return e};V.prototype.isParen=function(){var e=this.expression.charAt(this.pos);return e==="("||e===")"?(this.current=this.newToken(we,e),this.pos++,!0):!1};V.prototype.isBracket=function(){var e=this.expression.charAt(this.pos);return(e==="["||e==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken(Ge,e),this.pos++,!0):!1};V.prototype.isComma=function(){var e=this.expression.charAt(this.pos);return e===","?(this.current=this.newToken(Pt,","),this.pos++,!0):!1};V.prototype.isSemicolon=function(){var e=this.expression.charAt(this.pos);return e===";"?(this.current=this.newToken(sn,";"),this.pos++,!0):!1};V.prototype.isConst=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var n=this.expression.charAt(t);if(n.toUpperCase()===n.toLowerCase()&&(t===this.pos||n!=="_"&&n!=="."&&(n<"0"||n>"9")))break}if(t>e){var s=this.expression.substring(e,t);if(s in this.consts)return this.current=this.newToken(_t,this.consts[s]),this.pos+=s.length,!0}return!1};V.prototype.isNamedOp=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var n=this.expression.charAt(t);if(n.toUpperCase()===n.toLowerCase()&&(t===this.pos||n!=="_"&&(n<"0"||n>"9")))break}if(t>e){var s=this.expression.substring(e,t);if(this.isOperatorEnabled(s)&&(s in this.binaryOps||s in this.unaryOps||s in this.ternaryOps))return this.current=this.newToken(U,s),this.pos+=s.length,!0}return!1};V.prototype.isName=function(){for(var e=this.pos,t=e,n=!1;t<this.expression.length;t++){var s=this.expression.charAt(t);if(s.toUpperCase()===s.toLowerCase()){if(t===this.pos&&(s==="$"||s==="_")){s==="_"&&(n=!0);continue}else if(t===this.pos||!n||s!=="_"&&(s<"0"||s>"9"))break}else n=!0}if(n){var r=this.expression.substring(e,t);return this.current=this.newToken(nn,r),this.pos+=r.length,!0}return!1};V.prototype.isWhitespace=function(){for(var e=!1,t=this.expression.charAt(this.pos);(t===" "||t==="	"||t===`
`||t==="\r")&&(e=!0,this.pos++,!(this.pos>=this.expression.length));)t=this.expression.charAt(this.pos);return e};var Bs=/^[0-9a-f]{4}$/i;V.prototype.unescape=function(e){var t=e.indexOf("\\");if(t<0)return e;for(var n=e.substring(0,t);t>=0;){var s=e.charAt(++t);switch(s){case"'":n+="'";break;case'"':n+='"';break;case"\\":n+="\\";break;case"/":n+="/";break;case"b":n+="\b";break;case"f":n+="\f";break;case"n":n+=`
`;break;case"r":n+="\r";break;case"t":n+="	";break;case"u":var r=e.substring(t+1,t+5);Bs.test(r)||this.parseError("Illegal escape sequence: \\u"+r),n+=String.fromCharCode(parseInt(r,16)),t+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+s+'"')}++t;var a=e.indexOf("\\",t);n+=e.substring(t,a<0?e.length:a),t=a}return n};V.prototype.isComment=function(){var e=this.expression.charAt(this.pos);return e==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};V.prototype.isRadixInteger=function(){var e=this.pos;if(e>=this.expression.length-2||this.expression.charAt(e)!=="0")return!1;++e;var t,n;if(this.expression.charAt(e)==="x")t=16,n=/^[0-9a-f]$/i,++e;else if(this.expression.charAt(e)==="b")t=2,n=/^[01]$/i,++e;else return!1;for(var s=!1,r=e;e<this.expression.length;){var a=this.expression.charAt(e);if(n.test(a))e++,s=!0;else break}return s&&(this.current=this.newToken(_t,parseInt(this.expression.substring(r,e),t)),this.pos=e),s};V.prototype.isNumber=function(){for(var e=!1,t=this.pos,n=t,s=t,r=!1,a=!1,o;t<this.expression.length&&(o=this.expression.charAt(t),o>="0"&&o<="9"||!r&&o===".");)o==="."?r=!0:a=!0,t++,e=a;if(e&&(s=t),o==="e"||o==="E"){t++;for(var l=!0,c=!1;t<this.expression.length;){if(o=this.expression.charAt(t),l&&(o==="+"||o==="-"))l=!1;else if(o>="0"&&o<="9")c=!0,l=!1;else break;t++}c||(t=s)}return e?(this.current=this.newToken(_t,parseFloat(this.expression.substring(n,t))),this.pos=t):this.pos=s,e};V.prototype.isOperator=function(){var e=this.pos,t=this.expression.charAt(this.pos);if(t==="+"||t==="-"||t==="*"||t==="/"||t==="%"||t==="^"||t==="?"||t===":"||t===".")this.current=this.newToken(U,t);else if(t==="∙"||t==="•")this.current=this.newToken(U,"*");else if(t===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(U,">="),this.pos++):this.current=this.newToken(U,">");else if(t==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(U,"<="),this.pos++):this.current=this.newToken(U,"<");else if(t==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(U,"||"),this.pos++;else return!1;else if(t==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(U,"=="),this.pos++):this.current=this.newToken(U,t);else if(t==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(U,"!="),this.pos++):this.current=this.newToken(U,t);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=e,!1)};V.prototype.isOperatorEnabled=function(e){return this.parser.isOperatorEnabled(e)};V.prototype.getCoordinates=function(){var e=0,t,n=-1;do e++,t=this.pos-n,n=this.expression.indexOf(`
`,n+1);while(n>=0&&n<this.pos);return{line:e,column:t}};V.prototype.parseError=function(e){var t=this.getCoordinates();throw new Error("parse error ["+t.line+":"+t.column+"]: "+e)};function D(e,t,n){this.parser=e,this.tokens=t,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=n.allowMemberAccess!==!1}D.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};D.prototype.tokenMatches=function(e,t){return typeof t>"u"?!0:Array.isArray(t)?De(t,e.value):typeof t=="function"?t(e):e.value===t};D.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};D.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};D.prototype.accept=function(e,t){return this.nextToken.type===e&&this.tokenMatches(this.nextToken,t)?(this.next(),!0):!1};D.prototype.expect=function(e,t){if(!this.accept(e,t)){var n=this.tokens.getCoordinates();throw new Error("parse error ["+n.line+":"+n.column+"]: Expected "+(t||e))}};D.prototype.parseAtom=function(e){var t=this.tokens.unaryOps;function n(r){return r.value in t}if(this.accept(nn)||this.accept(U,n))e.push(new O(ve,this.current.value));else if(this.accept(_t))e.push(new O(ne,this.current.value));else if(this.accept(Wn))e.push(new O(ne,this.current.value));else if(this.accept(we,"("))this.parseExpression(e),this.expect(we,")");else if(this.accept(Ge,"["))if(this.accept(Ge,"]"))e.push(new O(Je,0));else{var s=this.parseArrayList(e);e.push(new O(Je,s))}else throw new Error("unexpected "+this.nextToken)};D.prototype.parseExpression=function(e){var t=[];this.parseUntilEndStatement(e,t)||(this.parseVariableAssignmentExpression(t),!this.parseUntilEndStatement(e,t)&&this.pushExpression(e,t))};D.prototype.pushExpression=function(e,t){for(var n=0,s=t.length;n<s;n++)e.push(t[n])};D.prototype.parseUntilEndStatement=function(e,t){return this.accept(sn)?(this.nextToken&&this.nextToken.type!==ht&&!(this.nextToken.type===we&&this.nextToken.value===")")&&t.push(new O(Rt)),this.nextToken.type!==ht&&this.parseExpression(t),e.push(new O(ee,t)),!0):!1};D.prototype.parseArrayList=function(e){for(var t=0;!this.accept(Ge,"]");)for(this.parseExpression(e),++t;this.accept(Pt);)this.parseExpression(e),++t;return t};D.prototype.parseVariableAssignmentExpression=function(e){for(this.parseConditionalExpression(e);this.accept(U,"=");){var t=e.pop(),n=[],s=e.length-1;if(t.type===je){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var r=0,a=t.value+1;r<a;r++){var o=s-r;e[o].type===ve&&(e[o]=new O(Ie,e[o].value))}this.parseVariableAssignmentExpression(n),e.push(new O(ee,n)),e.push(new O(Ct,t.value));continue}if(t.type!==ve&&t.type!==_e)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(n),e.push(new O(Ie,t.value)),e.push(new O(ee,n)),e.push(be("="))}};D.prototype.parseConditionalExpression=function(e){for(this.parseOrExpression(e);this.accept(U,"?");){var t=[],n=[];this.parseConditionalExpression(t),this.expect(U,":"),this.parseConditionalExpression(n),e.push(new O(ee,t)),e.push(new O(ee,n)),e.push(Jn("?"))}};D.prototype.parseOrExpression=function(e){for(this.parseAndExpression(e);this.accept(U,"or");){var t=[];this.parseAndExpression(t),e.push(new O(ee,t)),e.push(be("or"))}};D.prototype.parseAndExpression=function(e){for(this.parseComparison(e);this.accept(U,"and");){var t=[];this.parseComparison(t),e.push(new O(ee,t)),e.push(be("and"))}};var js=["==","!=","<","<=",">=",">","in"];D.prototype.parseComparison=function(e){for(this.parseAddSub(e);this.accept(U,js);){var t=this.current;this.parseAddSub(e),e.push(be(t.value))}};var Js=["+","-","||"];D.prototype.parseAddSub=function(e){for(this.parseTerm(e);this.accept(U,Js);){var t=this.current;this.parseTerm(e),e.push(be(t.value))}};var Gs=["*","/","%"];D.prototype.parseTerm=function(e){for(this.parseFactor(e);this.accept(U,Gs);){var t=this.current;this.parseFactor(e),e.push(be(t.value))}};D.prototype.parseFactor=function(e){var t=this.tokens.unaryOps;function n(r){return r.value in t}if(this.save(),this.accept(U,n)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===we&&this.nextToken.value==="("){this.restore(),this.parseExponential(e);return}else if(this.nextToken.type===sn||this.nextToken.type===Pt||this.nextToken.type===ht||this.nextToken.type===we&&this.nextToken.value===")"){this.restore(),this.parseAtom(e);return}}var s=this.current;this.parseFactor(e),e.push(It(s.value))}else this.parseExponential(e)};D.prototype.parseExponential=function(e){for(this.parsePostfixExpression(e);this.accept(U,"^");)this.parseFactor(e),e.push(be("^"))};D.prototype.parsePostfixExpression=function(e){for(this.parseFunctionCall(e);this.accept(U,"!");)e.push(It("!"))};D.prototype.parseFunctionCall=function(e){var t=this.tokens.unaryOps;function n(a){return a.value in t}if(this.accept(U,n)){var s=this.current;this.parseAtom(e),e.push(It(s.value))}else for(this.parseMemberExpression(e);this.accept(we,"(");)if(this.accept(we,")"))e.push(new O(je,0));else{var r=this.parseArgumentList(e);e.push(new O(je,r))}};D.prototype.parseArgumentList=function(e){for(var t=0;!this.accept(we,")");)for(this.parseExpression(e),++t;this.accept(Pt);)this.parseExpression(e),++t;return t};D.prototype.parseMemberExpression=function(e){for(this.parseAtom(e);this.accept(U,".")||this.accept(Ge,"[");){var t=this.current;if(t.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(nn),e.push(new O(_e,this.current.value))}else if(t.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(e),this.expect(Ge,"]"),e.push(be("["))}else throw new Error("unexpected symbol: "+t.value)}};function Ws(e,t){return Number(e)+Number(t)}function zs(e,t){return e-t}function Ks(e,t){return e*t}function Xs(e,t){return e/t}function Ys(e,t){return e%t}function Qs(e,t){return Array.isArray(e)&&Array.isArray(t)?e.concat(t):""+e+t}function Zs(e,t){return e===t}function er(e,t){return e!==t}function tr(e,t){return e>t}function nr(e,t){return e<t}function sr(e,t){return e>=t}function rr(e,t){return e<=t}function ar(e,t){return!!(e&&t)}function or(e,t){return!!(e||t)}function ir(e,t){return De(t,e)}function lr(e){return(Math.exp(e)-Math.exp(-e))/2}function cr(e){return(Math.exp(e)+Math.exp(-e))/2}function ur(e){return e===1/0?1:e===-1/0?-1:(Math.exp(e)-Math.exp(-e))/(Math.exp(e)+Math.exp(-e))}function fr(e){return e===-1/0?e:Math.log(e+Math.sqrt(e*e+1))}function pr(e){return Math.log(e+Math.sqrt(e*e-1))}function hr(e){return Math.log((1+e)/(1-e))/2}function Tn(e){return Math.log(e)*Math.LOG10E}function dr(e){return-e}function mr(e){return!e}function gr(e){return e<0?Math.ceil(e):Math.floor(e)}function yr(e){return Math.random()*(e||1)}function Sn(e){return rn(e+1)}function vr(e){return isFinite(e)&&e===Math.round(e)}var wr=4.7421875,$t=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function rn(e){var t,n;if(vr(e)){if(e<=0)return isFinite(e)?1/0:NaN;if(e>171)return 1/0;for(var s=e-2,r=e-1;s>1;)r*=s,s--;return r===0&&(r=1),r}if(e<.5)return Math.PI/(Math.sin(Math.PI*e)*rn(1-e));if(e>=171.35)return 1/0;if(e>85){var a=e*e,o=a*e,l=o*e,c=l*e;return Math.sqrt(2*Math.PI/e)*Math.pow(e/Math.E,e)*(1+1/(12*e)+1/(288*a)-139/(51840*o)-571/(2488320*l)+163879/(209018880*c)+5246819/(75246796800*c*e))}--e,n=$t[0];for(var h=1;h<$t.length;++h)n+=$t[h]/(e+h);return t=e+wr+.5,Math.sqrt(2*Math.PI)*Math.pow(t,e+.5)*Math.exp(-t)*n}function br(e){return Array.isArray(e)?e.length:String(e).length}function kn(){for(var e=0,t=0,n=0;n<arguments.length;n++){var s=Math.abs(arguments[n]),r;t<s?(r=t/s,e=e*r*r+1,t=s):s>0?(r=s/t,e+=r*r):e+=s}return t===1/0?1/0:t*Math.sqrt(e)}function xn(e,t,n){return e?t:n}function Ar(e,t){return typeof t>"u"||+t==0?Math.round(e):(e=+e,t=-+t,isNaN(e)||!(typeof t=="number"&&t%1===0)?NaN:(e=e.toString().split("e"),e=Math.round(+(e[0]+"e"+(e[1]?+e[1]-t:-t))),e=e.toString().split("e"),+(e[0]+"e"+(e[1]?+e[1]+t:t))))}function Er(e,t,n){return n&&(n[e]=t),t}function Mr(e,t){return e[t|0]}function Tr(e){return arguments.length===1&&Array.isArray(e)?Math.max.apply(Math,e):Math.max.apply(Math,arguments)}function Sr(e){return arguments.length===1&&Array.isArray(e)?Math.min.apply(Math,e):Math.min.apply(Math,arguments)}function kr(e,t){if(typeof e!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(t))throw new Error("Second argument to map is not an array");return t.map(function(n,s){return e(n,s)})}function xr(e,t,n){if(typeof e!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(n))throw new Error("Second argument to fold is not an array");return n.reduce(function(s,r,a){return e(s,r,a)},t)}function Or(e,t){if(typeof e!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(t))throw new Error("Second argument to filter is not an array");return t.filter(function(n,s){return e(n,s)})}function Cr(e,t){if(!(Array.isArray(t)||typeof t=="string"))throw new Error("Second argument to indexOf is not a string or array");return t.indexOf(e)}function Rr(e,t){if(!Array.isArray(t))throw new Error("Second argument to join is not an array");return t.join(e)}function Ir(e){return(e>0)-(e<0)||+e}var On=1/3;function _r(e){return e<0?-Math.pow(-e,On):Math.pow(e,On)}function Pr(e){return Math.exp(e)-1}function Nr(e){return Math.log(1+e)}function Lr(e){return Math.log(e)/Math.LN2}function Me(e){this.options=e||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||lr,cosh:Math.cosh||cr,tanh:Math.tanh||ur,asinh:Math.asinh||fr,acosh:Math.acosh||pr,atanh:Math.atanh||hr,sqrt:Math.sqrt,cbrt:Math.cbrt||_r,log:Math.log,log2:Math.log2||Lr,ln:Math.log,lg:Math.log10||Tn,log10:Math.log10||Tn,expm1:Math.expm1||Pr,log1p:Math.log1p||Nr,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||gr,"-":dr,"+":Number,exp:Math.exp,not:mr,length:br,"!":Sn,sign:Math.sign||Ir},this.binaryOps={"+":Ws,"-":zs,"*":Ks,"/":Xs,"%":Ys,"^":Math.pow,"||":Qs,"==":Zs,"!=":er,">":tr,"<":nr,">=":sr,"<=":rr,and:ar,or,in:ir,"=":Er,"[":Mr},this.ternaryOps={"?":xn},this.functions={random:yr,fac:Sn,min:Sr,max:Tr,hypot:Math.hypot||kn,pyt:Math.hypot||kn,pow:Math.pow,atan2:Math.atan2,if:xn,gamma:rn,roundTo:Ar,map:kr,fold:xr,filter:Or,indexOf:Cr,join:Rr},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}Me.prototype.parse=function(e){var t=[],n=new D(this,new V(this,e),{allowMemberAccess:this.options.allowMemberAccess});return n.parseExpression(t),n.expect(ht,"EOF"),new re(t,this)};Me.prototype.evaluate=function(e,t){return this.parse(e).evaluate(t)};var Kn=new Me;Me.parse=function(e){return Kn.parse(e)};Me.evaluate=function(e,t){return Kn.parse(e).evaluate(t)};var Cn={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function Ur(e){return Cn.hasOwnProperty(e)?Cn[e]:e}Me.prototype.isOperatorEnabled=function(e){var t=Ur(e),n=this.options.operators||{};return!(t in n)||!!n[t]};const ga={NEXT_ROLL:"Próxima Rolagem",ROUNDS:"Rodadas",MINUTES:"Minutos",HOURS:"Horas",DAYS:"Dias",LUCK_ENDS:"Sorte Encerra",PERMANENT:"Indeterminado",END_OF_ROUND:"Fim da Rodada",CONCENTRATION:"Concentração"},Ve={ADD:"ADD",SET:"SET",MULT:"MULT"},ya={str:"Força",agi:"Agilidade",int:"Intelecto",wil:"Vontade",defense:"Defesa",speed:"Deslocamento",health:"Vida",damage:"Dano (Dados)",boons:"Boons/Banes",healing_rate:"Taxa de Cura"},Ae={WEAPON:"Weapon",ARMOR:"Armor",SHIELD:"Shield",CONSUMABLE:"Consumable",EXPLOSIVE:"Explosive",OTHER:"Other"},va=["Aeromancy","Alchemy","Alteration","Animism","Astromancy","Chaos","Chronomancy","Conjuration","Cryomancy","Dark Arts","Destruction","Divination","Eldritch","Enchantment","Evocation","Geomancy","Hydromancy","Illusion","Invocation","Necromancy","Oneiromancy","Order","Primal","Protection","Psychomancy","Pyromancy","Shadowmancy","Skullduggery","Spiritualism","Symbolism","Technomancy","Teleportation","War"],Dr=[[1,0,0,0,0,0,0,0,0,0,0],[2,1,0,0,0,0,0,0,0,0,0],[3,2,1,0,0,0,0,0,0,0,0],[4,2,1,1,0,0,0,0,0,0,0],[5,2,2,1,1,0,0,0,0,0,0],[6,3,2,2,1,1,0,0,0,0,0],[7,3,2,2,2,1,1,0,0,0,0],[8,3,2,2,2,1,1,1,0,0,0],[9,3,3,2,2,2,1,1,1,0,0],[10,3,3,3,2,2,1,1,1,1,0],[11,3,3,3,3,2,1,1,1,1,1]],wa=["Air","Alteration","Arcana","Battle","Celestial","Chaos","Conjuration","Curse","Death","Demonology","Destruction","Divination","Enchantment","Ether","Fey","Fire","Forbidden","Illusion","Life","Metal","Nature","Necromancy","Order","Primal","Protection","Rune","Shadow","Song","Soul","Spiritualism","Storm","Technomancy","Telekinesis","Telepathy","Teleportation","Theurgy","Time","Transformation","Water"];function ba(e,t){return e<0||e>10||t<0||t>10?0:Dr[e]?.[t]??0}const qr=new Me,Xn={name:"",level:1,ancestry:"",paths:{novice:"",expert:"",master:""},attributes:[{name:"Strength",value:10,key:"str"},{name:"Agility",value:10,key:"agi"},{name:"Intellect",value:10,key:"int"},{name:"Will",value:10,key:"wil"}],currency:{gp:0,sp:0,cp:0},naturalDefense:10,bonusDamage:0,size:1,speed:10,currentRound:1,languages:[],professions:[],senses:[],afflictions:[],effects:[],notes:"",campaignId:null,campaignName:null,gmName:null,combatActive:!1,initiative:!1,acted:!1,spells:[],talents:[],equipment:[]},w=Q(JSON.parse(JSON.stringify(Xn))),lt=Q([]),$e=Q({type:null,isOpen:!1,data:null}),Hr=Q("acoes"),Nt=Q(24),Pe=Q(24),Ye=Q(0),We=Q(!1),Lt=Q(!1),Rn={autoOpenHistory:!1,stickyHistory:!1,theme:"dark",userName:"",enable3DDice:!1,diceTheme:"default"};function Vr(){const e=typeof localStorage<"u"?localStorage.getItem("wwv_app_settings"):null,{subscribe:t,set:n,update:s}=Q(e?{...Rn,...JSON.parse(e)}:Rn);return{subscribe:t,set:r=>{typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(r)),n(r)},update:r=>{s(a=>{const o=r(a);return typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(o)),o})}}}const an=Vr();We.subscribe(e=>{e&&Lt.set(!1)});const Qe=j(w,e=>{const t=e.effects.filter(s=>s.isActive),n=e.talents.filter(s=>(s.isPassive||s.activityType==="Passive")&&s.effect).map(s=>({...s.effect,id:`talent-effect-${s.id}`,name:s.name,sourceType:"talent",sourceId:s.id}));return[...t,...n]});function Re(e,t){if(typeof e=="number")return e;if(!e)return 0;const n=String(e).trim();if(!isNaN(Number(n)))return Number(n);try{const s={};Array.isArray(t.attributes)&&t.attributes.forEach(a=>{s[a.key]=a.value}),s.level=t.level||0,s.defense=t.naturalDefense||0,s.speed=t.speed||0,s.bonusDamage=t.bonusDamage||0,s.currentRound=t.currentRound||0;const r=n.replace(/@(\w+)/g,"$1");return qr.evaluate(r,s)}catch{return 0}}function Ut(e,t,n,s){let r=t||0;const a=n.flatMap(h=>Array.isArray(h.modifiers)?h.modifiers:[]),o=a.filter(h=>h.target===e&&h.type===Ve.SET);return o.length>0&&(r=Re(o[o.length-1].value,s)),a.filter(h=>h.target===e&&h.type===Ve.ADD).forEach(h=>{r+=Re(h.value,s)}),a.filter(h=>h.target===e&&h.type===Ve.MULT).forEach(h=>{r*=Re(h.value,s)}),Math.floor(r)}const on=j([w,Qe],([e,t])=>{const n={};return Array.isArray(e.attributes)&&e.attributes.forEach(s=>{n[s.key]=Ut(s.key,s.value,t,e)}),n}),Yn=j([w,Pe,Qe],([e,t,n])=>Ut("health",t,n,e)),$r=j([Yn,Nt],([e,t])=>Math.max(0,e-t)),Fr=j([Ye,Pe],([e,t])=>t>0?Math.min(100,e/t*100):100),Qn=j([Ye,Pe],([e,t])=>e>=t),Br=j([Ye,Pe,Qn],([e,t,n])=>e>=t/2&&!n),jr=j([w,on,Qe],([e,t,n])=>{let s=Ut("speed",e.speed,n,e);const r=e.afflictions;return r.includes("Held")||r.includes("Stunned")||r.includes("Unconscious")||r.includes("Incapacitated")?0:((r.includes("Blinded")||r.includes("Weakened"))&&(s=Math.floor(s/2)),r.includes("Slowed")&&(s=Math.min(s,2)),Math.max(0,s))}),Jr=j([w,Qe],([e,t])=>{let n=e.naturalDefense,s=0;const r=e.equipment.find(a=>a.type===Ae.ARMOR&&a.equipped);if(r){const a=r.defenseFixed||0,o=e.naturalDefense+(r.defenseMod||0);r.defenseFixed&&r.defenseMod?n=Math.max(a,o):r.defenseFixed?n=a:r.defenseMod&&(n=e.naturalDefense+r.defenseMod)}return e.equipment.filter(a=>a.type===Ae.SHIELD&&a.equippedState).forEach(a=>{s+=a.defenseMod||0}),Ut("defense",n+s,t,e)});j([w,Qe],([e,t])=>{const s=t.flatMap(r=>Array.isArray(r.modifiers)?r.modifiers:[]).filter(r=>r.target==="damage"&&r.type===Ve.ADD).reduce((r,a)=>r+Re(a.value,e),0);return(e.bonusDamage||0)+s});const te={updateCurrency:(e,t)=>{w.update(n=>{let s=n.currency.gp*100+n.currency.sp*10+n.currency.cp,r=0;return e==="gp"&&(r=t*100),e==="sp"&&(r=t*10),e==="cp"&&(r=t),s+=r,s<0&&(s=0),{...n,currency:{gp:Math.floor(s/100),sp:Math.floor(s%100/10),cp:s%100%10}}})},advanceRound:e=>{w.update(t=>{const n=t.currentRound||1;if(e==="next"){const s=(t.effects||[]).map(r=>{if(r.isActive&&r.duration==="ROUNDS"&&r.roundsLeft>0){const a=r.roundsLeft-1;return a<=0?{...r,roundsLeft:0,isActive:!1}:{...r,roundsLeft:a}}return r});return{...t,currentRound:n+1,effects:s}}else return{...t,currentRound:Math.max(1,n-1)}})},addToHistory:(e,t=!0)=>{const n=T(w),s=T(lt);if(e.id&&s.find(o=>o.id===e.id))return;const r={id:e.id||ot(),timestamp:e.timestamp||new Date,charName:n.name,source:e.source||"gm",name:e.name||"Action",...e};lt.update(o=>[r,...o]),T(an).autoOpenHistory?We.set(!0):T(We)||Lt.set(!0),t&&n.campaignId&&Bt(async()=>{const{syncRoll:o}=await Promise.resolve().then(()=>Xt);return{syncRoll:o}},void 0,import.meta.url).then(({syncRoll:o})=>{o(r)})},clearHistory:()=>lt.set([]),addItem:e=>w.update(t=>({...t,equipment:[...t.equipment,e]})),updateItem:e=>w.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?e:n)})),deleteItem:e=>w.update(t=>({...t,equipment:t.equipment.filter(n=>n.id!==e)})),useConsumable:e=>{if(e.quantity>0){const t=T(me);te.updateItem({...e,quantity:e.quantity-1}),te.addToHistory({source:"item",name:e.name,description:t("sofww.item_types.consumable")+`: ${e.name}`})}},equipItem:(e,t=null)=>{w.update(n=>{let s=[...n.equipment];return e.type===Ae.ARMOR?s=s.map(r=>r.id===e.id?{...r,equipped:!r.equipped}:r.type===Ae.ARMOR&&e.type===Ae.ARMOR&&!e.equipped?{...r,equipped:!1}:r):(e.type===Ae.WEAPON||e.type===Ae.SHIELD)&&(s=s.map(r=>r.id===e.id?{...r,equippedState:t}:r)),{...n,equipment:s}})},toggleAffliction:e=>{w.update(t=>t.afflictions.includes(e)?{...t,afflictions:t.afflictions.filter(n=>n!==e)}:{...t,afflictions:[...t.afflictions,e]})},addLanguage:e=>w.update(t=>({...t,languages:[...t.languages,e]})),removeLanguage:e=>w.update(t=>({...t,languages:t.languages.filter((n,s)=>s!==e)})),addSense:e=>w.update(t=>({...t,senses:[...t.senses||[],e]})),removeSense:e=>w.update(t=>({...t,senses:(t.senses||[]).filter((n,s)=>s!==e)})),confirmRest:()=>{w.update(t=>{const n=t.spells.map(r=>({...r,castings:r.maxCastings})),s=t.talents.map(r=>({...r,uses:r.maxUses}));return{...t,spells:n,talents:s}}),Ye.set(0);const e=T(Nt);Pe.set(e),$e.set({type:null,isOpen:!1,data:null})},finalizeRoll:(e,t,n=[],s={})=>{const r=T(w),a=T(on),o=T(me),l=e.type==="weapon_attack",c=e.type==="luck",h=e.type==="weapon_damage",p=e?.source,f=p?.name||o("common.labels.action"),i=(u,g)=>u.traits&&u.traits.toLowerCase().includes(g.toLowerCase());let m={},S=()=>{};if(h){let u=parseInt(p.damageDice)||0;const g=p.grip&&p.grip.toLowerCase()==="two"||p.equippedState&&p.equippedState.toLowerCase()==="two";i(p,"Versatile")&&g&&(u+=1);let I=r.bonusDamage||0;i(p,"Light")&&I>1&&(I-=1);const H=n.flatMap(b=>Array.isArray(b.modifiers)?b.modifiers:[]).filter(b=>b.target==="damage"&&b.type===Ve.ADD).reduce((b,x)=>b+Re(x.value,r),0),_=I+H,M=Math.max(0,u+_+t);let N=[],P=0,R=[];for(let b=0;b<M;b++){let x=Math.floor(Math.random()*6)+1;if(x===1&&i(p,"Brutal")){const se=Math.floor(Math.random()*6)+1;R.push(`1->${se}`),x=se}else R.push(`${x}`);N.push(x),P+=x}const J=`${M}d6 [${N.join(", ")}] ${R.some(b=>b.includes("->"))?`(Rolagens: ${R.join(", ")})`:""}`;m={damageDice:N,total:P,formula:J},S=()=>{te.addToHistory({source:"damage",name:p.name,description:`${o("history.source.damage")}: ${M}d6 ${i(p,"Brutal")?"(Brutal)":""}`,formula:J,total:P,effectsApplied:n.map(b=>b.name)}),p.type===Ae.EXPLOSIVE&&te.useConsumable(p)}}else{const u=Math.floor(Math.random()*20)+1;let g=0,I=o("history.source.luck");if(e.type==="attribute")g=(a[e.source.key]||e.source.value)-10,I=o(`sofww.attributes.${e.source.key}`);else if(l){let b="str",x=o("sofww.attributes.str");p.range==="Ranged"&&(b="agi",x=o("sofww.attributes.agi"),i(p,"Thrown")&&(b="str",x=o("sofww.attributes.str"))),i(p,"Nimble")&&(b="agi",x=o("sofww.attributes.agi")),g=(a[b]||10)-10,I=x}const H=Math.floor(n.flatMap(b=>Array.isArray(b.modifiers)?b.modifiers:[]).filter(b=>b.target==="boons"&&b.type===Ve.ADD).reduce((b,x)=>b+Re(x.value,r),0));t+=H;let _=0,M="",N=[];if(t!==0){const b=Math.abs(t);for(let se=0;se<b;se++)N.push(Math.floor(Math.random()*6)+1);const x=Math.max(...N);t>0?(_=x,M=` + ${x} [${o("sofdl.rolls.boon")}]`):(_=-x,M=` - ${x} [${o("sofdl.rolls.bane")}]`)}const P=u+g+_;let R="";if(l?R=`${o("history.source.attack")} (${I})`:c?R=o("history.source.luck"):R=`${o("history.source.attribute")}: ${f}`,t!==0&&(R+=` ${o("sofdl.rolls.attribute_test",{values:{attr:"",modifier:t}}).replace(/^[^ ]+ /,"")}`),l&&u===20){let b=[];i(p,"Bludgeoning")&&b.push(o("sofww.afflictions.vulnerable.name")),i(p,"Piercing")&&b.push(o("sofww.afflictions.weakened.name")),i(p,"Slashing")&&b.push("+1d6 Dmg"),b.length>0&&(R+=`
CRÍTICO! ${b.join(" ")} `)}const J=`d20(${u})${g!==0?(g>=0?"+":"")+g:""}${M}`;m={d20:u,boonBaneDice:N,total:P,formula:J},S=()=>{te.addToHistory({source:l?"attack":c?"luck":"attribute",name:f,description:R,formula:J,total:P,crit:u===20,effectsApplied:n.map(b=>b.name)}),w.update(b=>({...b,effects:b.effects.map(x=>x.isActive&&x.duration==="NEXT_ROLL"?{...x,isActive:!1}:x)})),l&&i(p,"Reload")&&w.update(b=>({...b,equipment:b.equipment.map(x=>x.id===p.id?{...x,isLoaded:!1}:x)}))}}return s.suppressHistory||S(),{...m,commit:S}},reloadWeapon:e=>{const t=T(me);w.update(n=>({...n,equipment:n.equipment.map(s=>s.id===e.id?{...s,isLoaded:!0}:s)})),te.addToHistory({source:"attribute",name:t("actions.reload"),description:`${t("actions.reload")}: ${e.name}`})},addSpell:e=>w.update(t=>({...t,spells:[...t.spells,e]})),updateSpell:e=>w.update(t=>({...t,spells:t.spells.map(n=>n.id===e.id?e:n)})),deleteSpell:e=>w.update(t=>({...t,spells:t.spells.filter(n=>n.id!==e)})),commitSpellCast:e=>{e.castings>0&&(w.update(t=>({...t,spells:t.spells.map(n=>n.id===e.id?{...n,castings:n.castings-1}:n)})),te.addToHistory({source:"spell",name:e.name,description:e.description}),$e.set({type:null,isOpen:!1,data:null}))},addTalent:e=>w.update(t=>({...t,talents:[...t.talents,e]})),updateTalent:e=>w.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?e:n)})),deleteTalent:e=>w.update(t=>({...t,talents:t.talents.filter(n=>n.id!==e)})),commitTalentUse:e=>{e.activityType==="Duration"&&e.duration==="LUCK_ENDS"?w.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?{...n,uses:0}:n)})):e.maxUses&&w.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?{...n,uses:n.uses-1}:n)})),te.addToHistory({source:"talent",name:e.name,description:e.description}),$e.set({type:null,isOpen:!1,data:null})},recoverTalent:e=>{w.update(t=>({...t,talents:t.talents.map(n=>n.id===e&&n.uses<n.maxUses?{...n,uses:(n.uses||0)+1}:n)}))},rollLuckTalent:e=>{const t=T(me),n=Math.floor(Math.random()*20)+1,s=n>=10,a=T(w).talents.find(o=>o.id===e);te.addToHistory({source:"luck",name:`${t("character.history.source.luck")} - ${a?.name||t("character.talents.title")}`,formula:`d20(${n})`,total:n,description:s?t("character.dice_roll.luck_success",{values:{total:n}}):t("character.dice_roll.luck_failure",{values:{total:n}})}),s&&w.update(o=>({...o,talents:o.talents.map(l=>l.id===e?{...l,uses:1}:l)}))},addEffect:e=>w.update(t=>({...t,effects:[...t.effects,e]})),updateEffect:e=>w.update(t=>({...t,effects:t.effects.map(n=>n.id===e.id?e:n)})),deleteEffect:e=>w.update(t=>({...t,effects:t.effects.filter(n=>n.id!==e)})),toggleEffect:e=>w.update(t=>({...t,effects:t.effects.map(n=>{if(n.id===e){const s=!n.isActive;return{...n,isActive:s,roundsLeft:s&&n.duration==="ROUNDS"&&n.initialRounds||n.roundsLeft}}return n})})),cleanInactiveEffects:()=>w.update(e=>({...e,effects:e.effects.filter(t=>t.isActive)})),applyEffectToCharacter:(e,t)=>{const n=e.name||(t?t.name:"Effect"),s=e.description||(t?t.description:""),r={id:ot(),isActive:!0,name:n,description:s,roundsLeft:0,duration:"PERMANENT",modifiers:[],...e};r.duration==="ROUNDS"&&!r.initialRounds&&(r.initialRounds=r.roundsLeft),w.update(a=>({...a,effects:[...a.effects,r]}))},checkLuckEnds:e=>{const t=T(me),n=Math.floor(Math.random()*20)+1,s=n>=10;te.addToHistory({source:"luck",name:t("sofww.duration.luck_ends"),description:s?t("character.dice_roll.luck_success",{values:{total:n}}):t("character.dice_roll.luck_failure",{values:{total:n}})}),s&&w.update(r=>({...r,effects:r.effects.map(a=>a.id===e?{...a,isActive:!1}:a)}))},joinCampaign:e=>{w.update(t=>({...t,campaignId:e.id,campaignName:e.name,gmName:e.gmName||"Game Master"})),Bt(async()=>{const{joinCampaignRoom:t}=await Promise.resolve().then(()=>Xt);return{joinCampaignRoom:t}},void 0,import.meta.url).then(({joinCampaignRoom:t})=>{t(e.id,!1)})},leaveCampaign:()=>{w.update(e=>({...e,campaignId:null,campaignName:null,gmName:null,combatActive:!1}))}},Aa=Object.freeze(Object.defineProperty({__proto__:null,activeEffects:Qe,activeTab:Hr,appSettings:an,character:w,characterActions:te,currentHealth:Pe,damage:Ye,damagePercentage:Fr,defaultCharacter:Xn,derivedStats:on,effectiveMaxHealth:Yn,effectiveSpeed:jr,evaluateModifierValue:Re,hasUnreadRolls:Lt,isHistoryOpen:We,isIncapacitated:Qn,isInjured:Br,modalState:$e,normalHealth:Nt,rollHistory:lt,tempHealth:$r,totalDefense:Jr},Symbol.toStringTag,{value:"Module"})),Gr=new Me,Wr={id:"",system:"sofdl",name:"",ancestry:"",level:0,paths:{novice:"",expert:"",master:""},imageUrl:"",attributes:{strength:10,agility:10,intellect:10,will:10},perception:10,defense:10,health:10,healingRate:2,size:1,speed:10,power:0,damage:0,insanity:0,corruption:0,description:"",notes:"",professions:[],languages:["Comum"],senses:[],afflictions:[],talents:[],spells:[],equipment:[],currency:{gc:0,ss:0,cp:0,bits:0},effects:[],campaignId:null,campaignName:null,gmName:null,campaignApproval:null,combatActive:!1,currentRound:1,initiative:!1,acted:!1,magicSystem:"standard"},A=Q(JSON.parse(JSON.stringify(Wr))),zr=j(A,e=>e.effects.filter(t=>t.isActive)),Ne=j([A,zr],([e,t])=>{const n={strength:e.attributes.strength,agility:e.attributes.agility,intellect:e.attributes.intellect,will:e.attributes.will,perception:e.perception,defense:e.defense,health:e.health,speed:e.speed,healingRate:e.healingRate,power:e.power,boons:0},s=[];t.forEach(o=>{o.modifiers&&o.modifiers.forEach(l=>{s.push(l)})});const r=o=>o==="healing_rate"?"healingRate":o;return Object.keys(n).forEach(o=>{const l=s.filter(p=>r(p.target)===o);if(l.length===0)return;const c=l.filter(p=>p.type==="SET");if(c.length>0){const p=c[c.length-1];n[o]=Ft(p.value,e)}c.length===0&&l.filter(f=>f.type==="ADD").forEach(f=>{n[o]+=Ft(f.value,e)}),l.filter(p=>p.type==="MULT").forEach(p=>{n[o]*=Ft(p.value,e)}),n[o]=Math.floor(n[o])}),{strength:n.strength,agility:n.agility,intellect:n.intellect,will:n.will,perception:n.perception,defense:n.defense,health:n.health,speed:n.speed,healingRate:n.healingRate,power:n.power,boons:n.boons}}),Ea=j(Ne,e=>({strength:e.strength,agility:e.agility,intellect:e.intellect,will:e.will})),Kr=j(Ne,e=>({strength:e.strength-10,agility:e.agility-10,intellect:e.intellect-10,will:e.will-10}));j([A,Ne],([e,t])=>t.health-e.damage);j([A,Ne],([e,t])=>e.damage>=t.health/2);j([A,Ne],([e,t])=>e.damage>=t.health);function Ft(e,t){if(typeof e=="number")return e;if(!e)return 0;const n=String(e).trim();if(!isNaN(Number(n)))return Number(n);try{const s={};t.attributes&&Object.entries(t.attributes).forEach(([a,o])=>{s[a]=o}),s.level=t.level||0,s.perception=t.perception||0,s.defense=t.defense||0,s.health=t.health||0,s.healingRate=t.healingRate||0,s.size=t.size||0,s.speed=t.speed||0,s.power=t.power||0,s.damage=t.damage||0,s.insanity=t.insanity||0,s.corruption=t.corruption||0;const r=n.replace(/@(\w+)/g,"$1");return Gr.evaluate(r,s)}catch{return 0}}const Ma=j(Ne,e=>Math.max(0,e.healingRate)),qe={set:e=>{A.update(t=>{const n={...t,...e};return e.health!==void 0&&e.healingRate===void 0&&(n.healingRate=Math.floor(n.health/4)),n})},updateAttribute:(e,t)=>{A.update(n=>({...n,attributes:{...n.attributes,[e]:t}}))},takeDamage:e=>{A.update(t=>{const n=Math.max(0,Math.min(t.health,t.damage+e));return{...t,damage:n}})},heal:e=>{A.update(t=>{const n=Math.max(0,t.damage-e);return{...t,damage:n}})},updateStat:(e,t)=>{A.update(n=>({...n,[e]:Math.max(0,t)}))},toggleEffect:e=>{A.update(t=>({...t,effects:t.effects.map(n=>n.id===e?{...n,isActive:!n.isActive}:n)}))},deleteEffect:e=>{A.update(t=>({...t,effects:t.effects.filter(n=>n.id!==e)}))},cleanInactiveEffects:()=>{A.update(e=>({...e,effects:e.effects.filter(t=>t.isActive)}))},advanceRound:e=>{A.update(t=>{if(e==="next"){const n=t.effects.map(s=>s.isActive&&s.duration==="END_OF_ROUND"?{...s,isActive:!1}:s);return{...t,currentRound:t.currentRound+1,effects:n}}return{...t,currentRound:Math.max(1,t.currentRound-1)}})},checkLuckEnds:e=>{const n=T(A).effects.find(r=>r.id===e),s=T(me);$e.set({type:"pre_roll",isOpen:!0,data:{type:"luck_ends",system:"sofdl",effectId:e,source:{name:n?.name||s("sofdl.rolls.effect")}}})},checkConcentration:e=>{const n=T(A).effects.find(r=>r.id===e),s=T(me);$e.set({type:"pre_roll",isOpen:!0,data:{type:"concentration",system:"sofdl",effectId:e,key:"will",source:{name:n?.name||s("sofdl.rolls.concentration")}}})},addSpell:e=>{A.update(t=>({...t,spells:[...t.spells,{...e,id:e.id||ot()}]}))},updateSpell:e=>{A.update(t=>({...t,spells:t.spells.map(n=>n.id===e.id?e:n)}))},deleteSpell:e=>{A.update(t=>({...t,spells:t.spells.filter(n=>n.id!==e)}))},castSpell:e=>{const n=T(A).spells.find(s=>s.id===e);n&&(A.update(s=>({...s,spells:s.spells.map(r=>r.id===e?{...r,castingsUsed:(r.castingsUsed||0)+1}:r)})),qe.addToHistory({source:"spell",name:n.name,description:n.description,type:"spell"}))},resetSpellCastings:()=>{A.update(e=>({...e,spells:e.spells.map(t=>({...t,castingsUsed:0}))}))},addTalent:e=>{A.update(t=>({...t,talents:[...t.talents,{...e,id:e.id||ot()}]}))},updateTalent:e=>{A.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?e:n)}))},deleteTalent:e=>{A.update(t=>({...t,talents:t.talents.filter(n=>n.id!==e)}))},useTalent:e=>{const n=T(A).talents.find(s=>s.id===e);n&&(A.update(s=>({...s,talents:s.talents.map(r=>r.id===e&&r.uses>0?{...r,uses:r.uses-1}:r)})),qe.addToHistory({source:"talent",name:n.name,description:n.description,type:"talent"}))},resetTalentUses:()=>{A.update(e=>({...e,talents:e.talents.map(t=>({...t,uses:t.maxUses}))}))},addSense:e=>{A.update(t=>({...t,senses:t.senses.includes(e)?t.senses:[...t.senses,e]}))},removeSense:e=>{A.update(t=>({...t,senses:t.senses.filter((n,s)=>s!==e)}))},toggleAffliction:e=>{A.update(t=>({...t,afflictions:t.afflictions.includes(e)?t.afflictions.filter(n=>n!==e):[...t.afflictions,e]}))},leaveCampaign:()=>{A.update(e=>({...e,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}))},addToHistory:(e,t=!0)=>{const n=T(A),s={id:e.id||ot(),timestamp:e.timestamp||new Date,charName:n.name,...e};lt.update(a=>[s,...a]),T(an).autoOpenHistory?We.set(!0):T(We)||Lt.set(!0),t&&n.campaignId&&Bt(async()=>{const{syncRoll:a}=await Promise.resolve().then(()=>Xt);return{syncRoll:a}},void 0,import.meta.url).then(({syncRoll:a})=>{a(s)})},addLanguage:e=>A.update(t=>({...t,languages:[...t.languages,e]})),removeLanguage:e=>A.update(t=>({...t,languages:t.languages.filter((n,s)=>s!==e)})),addProfession:e=>A.update(t=>({...t,professions:[...t.professions,e]})),removeProfession:e=>A.update(t=>({...t,professions:t.professions.filter((n,s)=>s!==e)})),updateCurrency:(e,t)=>{A.update(n=>{const s=Math.max(0,(n.currency[e]||0)+t);return{...n,currency:{...n.currency,[e]:s}}})},addItem:e=>A.update(t=>({...t,equipment:[...t.equipment,e]})),updateItem:e=>A.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?e:n)})),deleteItem:e=>A.update(t=>({...t,equipment:t.equipment.filter(n=>n.id!==e)})),useConsumable:e=>{A.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?{...n,quantity:Math.max(0,n.quantity-1)}:n)}))},reloadWeapon:e=>A.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?{...n,isLoaded:!0}:n)})),finalizeRoll:(e,t,n=[],s={})=>{T(A);const r=T(Kr),a=T(Ne),o=e?.type==="weapon_damage"||e?.type==="spell_damage",l=T(me),c=e?.source?.name||e?.key||l("character.modals.attribute");let h={},p=()=>{};if(o){const f=e.source?.damage??e.source?.damageDice??"1d6",i=String(f),m=Number(e.source?.damageMod)||0;let S=0,u=[],g="";if(i==="0")S=0,g="0";else if(!i.includes("d"))S=parseInt(i)||0,g=`${S}`,u=[S];else{const M=i.match(/(\d+)d(\d+)/);if(M){const N=parseInt(M[1])||1,P=parseInt(M[2])||6;for(let R=0;R<N;R++){const J=Math.floor(Math.random()*P)+1;S+=J,u.push(J)}g=`${i} [${u.join(", ")}]`}else S=1,g="1"}const I=S+t+m,H=t+m!==0?`${t+m>0?"+":""}${t+m}`:"",_=`${g}${H}`;h={damageDice:u,total:I,formula:_},p=()=>{const M=T(me);qe.addToHistory({source:"damage",name:c,description:M("sofdl.rolls.damage_description",{values:{source:c}}),formula:_,total:I,effectsApplied:n})}}else{const f=Math.floor(Math.random()*20)+1;let i=0,m=c;e.type==="attribute"?(i=r[e.key]||0,m=l(`sofdl.attributes.${e.key}`)):e.type==="luck"&&(i=0,m=l("character.luck_test"));let S=t+(a.boons||0),u=0,g="",I=[];if(S!==0){const N=Math.abs(S);for(let R=0;R<N;R++)I.push(Math.floor(Math.random()*6)+1);const P=Math.max(...I);S>0?(u=P,g=` + ${P} [${l("sofdl.rolls.boon")}]`):(u=-P,g=` - ${P} [${l("sofdl.rolls.bane")}]`)}let H="attribute";e.type==="weapon_attack"?H="attack":(e.type==="luck"||e.type==="luck_ends")&&(H="luck");const _=f+i+u,M=`d20(${f})${i!==0?(i>=0?"+":"")+i:""}${g}`;h={d20:f,boonBaneDice:I,total:_,formula:M},p=()=>{qe.addToHistory({source:H,name:m,description:e.type==="luck_ends"?l("sofdl.rolls.luck_ends",{values:{effect:c}}):l("sofdl.rolls.attribute_test",{values:{attr:m,modifier:t}}),formula:M,total:_,crit:f===20,effectsApplied:n}),e.type==="luck_ends"&&_>=10&&A.update(N=>({...N,effects:N.effects.map(P=>P.id===e.effectId?{...P,isActive:!1}:P)}))}}return s.suppressHistory||p(),{...h,commit:p}},rest:()=>{A.update(e=>{const t=e.spells.map(r=>({...r,castingsUsed:0})),n=e.talents.map(r=>({...r,uses:r.isPassive?0:r.maxUses})),s=Math.max(0,e.damage-e.healingRate);return{...e,spells:t,talents:n,damage:s}})}},Xr="wss://tracker.openwebtorrent.com",Ta=[{label:"OpenWebTorrent (Standard)",value:"wss://tracker.openwebtorrent.com"},{label:"Files.fm",value:"wss://tracker.files.fm:7073/announce"},{label:"WebTorrent Dev",value:"wss://tracker.webtorrent.dev"},{label:"Vibe Community",value:"wss://toad.vibe.community:443/announce"},{label:"BTorrent",value:"wss://tracker.btorrent.xyz"}],Yr=(e,t)=>{let n=t;if(typeof window<"u"){const o=localStorage.getItem(e);o&&(n=JSON.parse(o))}const{subscribe:s,set:r,update:a}=Q(n);return{subscribe:s,set:o=>{typeof window<"u"&&localStorage.setItem(e,JSON.stringify(o)),r(o)},update:o=>{a(l=>{const c=o(l);return typeof window<"u"&&localStorage.setItem(e,JSON.stringify(c)),c})}}},dt=Yr("app_tracker_url",Xr);function ln(){const e=T(dt);return{appId:os,trackerUrls:[e]}}const F=Q({roomId:null,peers:[],currentCharacterId:null,lastGmUpdate:0,isGM:!1,isConnected:!1,connectionStatus:"disconnected"}),Qr=j(F,e=>e.lastGmUpdate?Date.now()-e.lastGmUpdate<6e4:!1);let G=null,pe=null,mt=null,gt=null,Fe=null,yt=null,Ce=null,oe=null,ye=null,Wt=0,zt=0;const Zr=2e3,Zn=12e4,Kt=Q([]),ge=Q("disconnected");async function Dt(e,t=6e4){return e?new Promise(n=>{let s=null,r=!1;const a=setTimeout(()=>{if(!r){if(r=!0,s){s.onopen=null,s.onerror=null;try{(s.readyState===WebSocket.CONNECTING||s.readyState===WebSocket.OPEN)&&s.close()}catch{}}n(!1)}},t);try{s=new WebSocket(e),s.onopen=()=>{if(r){try{s?.close()}catch{}return}r=!0,clearTimeout(a);try{s?.close()}catch{}n(!0)},s.onerror=()=>{r||(r=!0,clearTimeout(a),n(!1))}}catch{r||(r=!0,clearTimeout(a),n(!1))}}):!1}function ea(e){ye&&clearInterval(ye),ye=setInterval(async()=>{const t=await Dt(e,6e4);F.update(n=>!t&&n.connectionStatus==="connected"?{...n,connectionStatus:"reconnecting"}:t&&n.connectionStatus==="reconnecting"?{...n,connectionStatus:"connected"}:n)},Zn)}function vt(e,t){if(!e)return!0;try{return e.leave(),!0}catch(n){return console.warn(`Failed to leave ${t}:`,n),!1}}function es(e){return Date.now()-e>=Zr}let Be=null;function In(e){Be&&clearInterval(Be),Be=setInterval(async()=>{const t=await Dt(e,6e4);ge.update(n=>!t&&n==="connected"?(console.warn("Lobby monitor: Tracker unreachable"),"error"):t&&(n==="disconnected"||n==="error")?"connected":n)},Zn)}let Ee;async function cn(){const e=T(dt);if(pe&&Ee)return console.log("Lobby already connected, reusing existing connection"),ge.set("connected"),In(e),Ee;if(!es(Wt))return console.warn("Lobby join rate limited. Skipping duplicate join attempt."),null;if(Wt=Date.now(),Ce&&(clearInterval(Ce),Ce=null),vt(pe,"existing lobby"),pe=null,ge.set("connecting"),!await Dt(e))return console.warn(`Tracker ${e} appears offline.`),ge.set("error"),pe=null,null;try{const n=ln();pe=jn(n,"public-discovery");const[s,r]=pe.makeAction("discovery");return r(a=>{Kt.update(o=>{const l=o.findIndex(c=>c.id===a.id);if(l!==-1){const c=[...o];return c[l]={...a,lastSeen:Date.now()},c}return[...o,{...a,lastSeen:Date.now()}]})}),Ce=setInterval(()=>{const a=Date.now();Kt.update(o=>o.filter(l=>a-l.lastSeen<12e4))},6e4),ge.set("connected"),Ee=s,In(e),s}catch(n){return console.error("Failed to join lobby:",n),pe=null,ge.set("error"),null}}function ta(e){return Ee?(Ee({id:e.id,name:e.name,gmName:e.gmName||"Mestre",description:e.description,system:e.system}),!0):(console.warn("Cannot announce campaign: lobby not initialized"),!1)}function na(){typeof window<"u"&&cn().catch(e=>console.error("Error initializing lobby:",e))}if(typeof window<"u"){na();let e=T(dt);dt.subscribe(t=>{t!==e&&(e=t,console.log("Tracker URL changed, reconnecting..."),T(ge)!=="disconnected"&&(Wt=0,cn()),T(F).roomId&&(zt=0,ns()))}),window.addEventListener("beforeunload",()=>{sa()}),window.addEventListener("online",()=>{F.update(t=>t.isConnected?{...t,connectionStatus:"reconnecting"}:t),setTimeout(()=>{T(F).isConnected&&F.update(t=>({...t,connectionStatus:"connected"}))},2e3)}),window.addEventListener("offline",()=>{F.update(t=>t.isConnected?{...t,connectionStatus:"disconnected"}:t)})}function sa(){Ce&&(clearInterval(Ce),Ce=null),Be&&(clearInterval(Be),Be=null),oe&&(clearInterval(oe),oe=null),ye&&(clearInterval(ye),ye=null),vt(pe,"lobby"),vt(G,"room"),pe=null,G=null,Ee=null,ge.set("disconnected"),F.update(e=>({...e,isConnected:!1,connectionStatus:"disconnected"}))}let Se=null;async function ts(e,t=!1,n=null){const s=`campaign-${e}`;if(Se===s&&G)return F.update(o=>({...o,isGM:t,currentCharacterId:n,connectionStatus:"connected"})),G;if(!es(zt)&&Se!==s)return console.warn("Campaign join rate limited. Skipping duplicate join attempt."),G;zt=Date.now(),oe&&(clearInterval(oe),oe=null),vt(G,"existing campaign room"),G=null,Se=null,F.update(o=>({...o,connectionStatus:"connecting"})),mt=null,gt=null,Fe=null,yt=null;const r=T(dt);if(!await Dt(r))return console.warn(`Tracker ${r} appears offline.`),F.update(o=>({...o,connectionStatus:"error",isConnected:!1})),null;try{Se=s;const o=ln();G=jn(o,Se),F.set({isConnected:!0,connectionStatus:"connected",isGM:t,currentCharacterId:n,peers:[],roomId:e,lastGmUpdate:0}),ea(r);const[l,c]=G.makeAction("combat"),[h,p]=G.makeAction("history"),[f,i]=G.makeAction("charUpdate"),[m,S]=G.makeAction("campaign");return mt=l,gt=h,Fe=f,yt=m,c(u=>{t||w.update(g=>({...g,currentRound:u.round,combatActive:u.active}))}),S(u=>{F.update(g=>({...g,lastGmUpdate:Date.now()})),t||w.update(g=>({...g,campaignName:u.name,gmName:u.gmName,passwordHash:u.passwordHash,system:u.system}))}),t&&(oe=setInterval(()=>{if(!Ee)return;const u=wt.get(e);u&&u.isPublished&&Ee({id:e,name:u.name,gmName:u.gmName||"Mestre",description:u.description,system:u.system})},3e4)),p(u=>{te.addToHistory(u,!1)}),i(u=>{if(t){const g=wt.get(e);if(g){const I=g.members||[],H=I.findIndex(R=>R.id===u.id);let _;if(H!==-1){_=[...I];const R=_[H],J={...u};R.campaignApproval==="approved"&&u.campaignApproval==="pending"&&delete J.campaignApproval,_[H]={...R,...J,lastUpdate:Date.now()}}else _=[...I,{...u,lastUpdate:Date.now()}];const M=g.activeEnemies||[],N=M.findIndex(R=>R.id===u.id&&R.type==="player");let P=M;N!==-1&&(P=[...M],P[N]={...P[N],...u}),wt.set(e,{...g,members:_,activeEnemies:P})}}else{const g=T(F),I=T(w),H=g.currentCharacterId||I?.id;if(H&&H===u.id){const _=u.system==="sofdl";if(u.campaignApproval==="rejected"||u.campaignId===null){_?qe.leaveCampaign():w.update(M=>({...M,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}));return}_?qe.set({name:u.name,afflictions:u.afflictions,senses:u.senses,initiative:u.initiative,acted:u.acted,campaignApproval:u.campaignApproval,imageUrl:u.imageUrl,notes:u.notes,damage:u.damage,health:u.health,healingRate:u.healingRate,insanity:u.insanity,corruption:u.corruption,defense:u.defense,speed:u.speed,power:u.power,attributes:u.attributes}):(w.update(M=>({...M,name:u.name||M.name,afflictions:u.afflictions||M.afflictions,senses:u.senses||M.senses,initiative:u.initiative!==void 0?u.initiative:M.initiative??!1,acted:u.acted!==void 0?u.acted:M.acted??!1,campaignApproval:u.campaignApproval||M.campaignApproval,imageUrl:u.imageUrl||M.imageUrl,notes:u.notes!==void 0?u.notes:M.notes})),u.damage!==void 0&&Ye.set(u.damage),u.currentHealth!==void 0&&Pe.set(u.currentHealth),u.normalHealth!==void 0&&Nt.set(u.normalHealth))}}}),G.onPeerJoin(u=>{if(console.log("Peer joined:",u),!t&&n&&Fe({type:"full",character:T(appSettings).characters?.[n]}),F.update(g=>({...g,peers:[...g.peers,u]})),t){const g=wt.get(e);g&&(g.combat&&l(g.combat),m({name:g.name,gmName:g.gmName||"Mestre",passwordHash:g.passwordHash,system:g.system}))}}),G.onPeerLeave(u=>{console.log("Peer left:",u),F.update(g=>({...g,peers:g.peers.filter(I=>I!==u)}))}),G}catch(o){return console.error("Failed to join campaign room:",o),G=null,Se=null,F.update(l=>({...l,isConnected:!1,connectionStatus:"error"})),null}}function ra(e,t){mt&&mt(t)}function aa(e,t){yt&&yt({name:t.name,gmName:t.gmName||"Mestre",passwordHash:t.passwordHash,system:t.system})}function oa(e){gt&&gt(e)}function ia(e){Fe&&Fe(e)}function la(){oe&&(clearInterval(oe),oe=null),ye&&(clearInterval(ye),ye=null),vt(G,"campaign room"),G=null,Se=null,mt=null,gt=null,Fe=null,yt=null,F.set({isConnected:!1,connectionStatus:"disconnected",isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0})}function ns(){const e=T(F);e.roomId?(console.log("Manual reconnection triggered"),F.update(t=>({...t,connectionStatus:"connecting"})),setTimeout(()=>{ts(e.roomId,e.isGM,e.currentCharacterId)},100)):console.warn("Cannot reconnect: no active campaign session found")}const Xt=Object.freeze(Object.defineProperty({__proto__:null,announceCampaign:ta,getTrackerConfig:ln,isGmOnline:Qr,joinCampaignRoom:ts,joinLobby:cn,leaveCampaignRoom:la,lobbyStatus:ge,publicCampaigns:Kt,reconnectCampaign:ns,syncCampaign:aa,syncCharacter:ia,syncCombat:ra,syncRoll:oa,syncState:F},Symbol.toStringTag,{value:"Module"}));export{Kr as $,Ta as A,Ye as B,$r as C,Xr as D,Br as E,Qn as F,Fr as G,$e as H,Ae as I,ga as J,Ve as K,qe as L,va as M,Ea as N,on as O,Ft as P,Re as Q,zr as R,Qe as S,A as T,Ne as U,Nt as V,Pe as W,Jr as X,jr as Y,Hr as Z,ya as _,jn as a,Ma as a0,ba as a1,wa as a2,Wr as a3,Xn as a4,Aa as a5,da as b,w as c,an as d,te as e,ia as f,ln as g,aa as h,Qr as i,ts as j,We as k,la as l,ta as m,ra as n,ma as o,F as p,Lt as q,lt as r,Ue as s,ns as t,ot as u,dt as v,ge as w,Kt as x,cn as y,Yn as z};
