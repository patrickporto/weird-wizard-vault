import{ba as Sn,aV as We,aw as Xn,L as xn,K as On,h as Rn,bb as Yn}from"./DfayzYqb.js";import{w as Z,j as B,g as C}from"./Cx0o8vWd.js";import{_ as qt}from"./PPVm8Dsz.js";import{$ as de}from"./Bs3V2B0j.js";import{d as Qn,a as dt}from"./CdkHlkWG.js";function sa(e,t,n=t){var s=new WeakSet;Sn(e,"input",async r=>{var a=r?e.defaultValue:e.value;if(a=Pt(e)?Nt(a):a,n(a),We!==null&&s.add(We),await Xn(),a!==(a=t())){var o=e.selectionStart,l=e.selectionEnd,u=e.value.length;if(e.value=a??"",l!==null){var h=e.value.length;o===l&&l===u&&h>u?(e.selectionStart=h,e.selectionEnd=h):(e.selectionStart=o,e.selectionEnd=Math.min(l,h))}}}),(Rn&&e.defaultValue!==e.value||xn(t)==null&&e.value)&&(n(Pt(e)?Nt(e.value):e.value),We!==null&&s.add(We)),On(()=>{var r=t();if(e===document.activeElement){var a=Yn??We;if(s.has(a))return}Pt(e)&&r===Nt(e.value)||e.type==="date"&&!r&&!e.value||r!==e.value&&(e.value=r??"")})}function ra(e,t,n=t){Sn(e,"change",s=>{var r=s?e.defaultChecked:e.checked;n(r)}),(Rn&&e.defaultChecked!==e.checked||xn(t)==null)&&n(e.checked),On(()=>{var s=t();e.checked=!!s})}function Pt(e){var t=e.type;return t==="number"||t==="range"}function Nt(e){return e===""?null:+e}const mt="0123456789abcdef";class ke{constructor(t){this.bytes=t}static ofInner(t){if(t.length!==16)throw new TypeError("not 128-bit length");return new ke(t)}static fromFieldsV7(t,n,s,r){if(!Number.isInteger(t)||!Number.isInteger(n)||!Number.isInteger(s)||!Number.isInteger(r)||t<0||n<0||s<0||r<0||t>0xffffffffffff||n>4095||s>1073741823||r>4294967295)throw new RangeError("invalid field value");const a=new Uint8Array(16);return a[0]=t/2**40,a[1]=t/2**32,a[2]=t/2**24,a[3]=t/2**16,a[4]=t/2**8,a[5]=t,a[6]=112|n>>>8,a[7]=n,a[8]=128|s>>>24,a[9]=s>>>16,a[10]=s>>>8,a[11]=s,a[12]=r>>>24,a[13]=r>>>16,a[14]=r>>>8,a[15]=r,new ke(a)}static parse(t){var n,s,r,a;let o;switch(t.length){case 32:o=(n=/^[0-9a-f]{32}$/i.exec(t))===null||n===void 0?void 0:n[0];break;case 36:o=(s=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(t))===null||s===void 0?void 0:s.slice(1,6).join("");break;case 38:o=(r=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(t))===null||r===void 0?void 0:r.slice(1,6).join("");break;case 45:o=(a=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(t))===null||a===void 0?void 0:a.slice(1,6).join("");break}if(o){const l=new Uint8Array(16);for(let u=0;u<16;u+=4){const h=parseInt(o.substring(2*u,2*u+8),16);l[u+0]=h>>>24,l[u+1]=h>>>16,l[u+2]=h>>>8,l[u+3]=h}return new ke(l)}else throw new SyntaxError("could not parse UUID string")}toString(){let t="";for(let n=0;n<this.bytes.length;n++)t+=mt.charAt(this.bytes[n]>>>4),t+=mt.charAt(this.bytes[n]&15),(n===3||n===5||n===7||n===9)&&(t+="-");return t}toHex(){let t="";for(let n=0;n<this.bytes.length;n++)t+=mt.charAt(this.bytes[n]>>>4),t+=mt.charAt(this.bytes[n]&15);return t}toJSON(){return this.toString()}getVariant(){const t=this.bytes[8]>>>4;if(t<0)throw new Error("unreachable");if(t<=7)return this.bytes.every(n=>n===0)?"NIL":"VAR_0";if(t<=11)return"VAR_10";if(t<=13)return"VAR_110";if(t<=15)return this.bytes.every(n=>n===255)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return this.getVariant()==="VAR_10"?this.bytes[6]>>>4:void 0}clone(){return new ke(this.bytes.slice(0))}equals(t){return this.compareTo(t)===0}compareTo(t){for(let n=0;n<16;n++){const s=this.bytes[n]-t.bytes[n];if(s!==0)return Math.sign(s)}return 0}}class Zn{constructor(t){this.timestamp_biased=0,this.counter=0,this.random=t??es()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(t,n){let s=this.generateOrAbortCore(t,n);return s===void 0&&(this.timestamp_biased=0,s=this.generateOrAbortCore(t,n)),s}generateOrAbortCore(t,n){if(!Number.isInteger(t)||t<0||t>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit unsigned integer");if(n<0||n>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(t++,t>this.timestamp_biased)this.timestamp_biased=t,this.resetCounter();else if(t+n>=this.timestamp_biased)this.counter++,this.counter>4398046511103&&(this.timestamp_biased++,this.resetCounter());else return;return ke.fromFieldsV7(this.timestamp_biased-1,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=this.random.nextUint32()*1024+(this.random.nextUint32()&1023)}generateV4(){const t=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return t[6]=64|t[6]>>>4,t[8]=128|t[8]>>>2,ke.ofInner(t)}}const es=()=>{if(typeof crypto<"u"&&typeof crypto.getRandomValues<"u")return new ts;if(typeof UUIDV7_DENY_WEAK_RNG<"u"&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>Math.trunc(Math.random()*65536)*65536+Math.trunc(Math.random()*65536)}};class ts{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}let nn;const tt=()=>ns().toString(),ns=()=>(nn||(nn=new Zn)).generate(),{floor:ss,random:rs}=Math,rt="Trystero",at=(e,t)=>Array(e).fill().map(t),sn="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",Cn=e=>at(e,()=>sn[ss(rs()*sn.length)]).join(""),_e=Cn(20),Ee=Promise.all.bind(Promise),In=typeof window<"u",{entries:Ht,fromEntries:_n,keys:as}=Object,pe=()=>{},he=e=>new Error(`${rt}: ${e}`),is=new TextEncoder,os=new TextDecoder,Ue=e=>is.encode(e),bt=e=>os.decode(e),gt=(...e)=>e.join("@"),ls=(e,t,n,s)=>(e.relayUrls||t).slice(0,e.relayUrls?e.relayUrls.length:e.relayRedundancy||n),it=JSON.stringify,ot=JSON.parse,rn=3333,yt={};let nt=null,Vt=null;const us=()=>{nt||(nt=new Promise(e=>{Vt=e}).finally(()=>{Vt=null,nt=null}))},cs=()=>Vt?.(),fs=(e,t)=>{const n={},s=()=>{const r=new WebSocket(e);r.onclose=()=>{if(nt){nt.then(s);return}yt[e]??=rn,setTimeout(s,yt[e]),yt[e]*=2},r.onmessage=a=>t(a.data),n.socket=r,n.url=r.url,n.ready=new Promise(a=>r.onopen=()=>{a(n),yt[e]=rn}),n.send=a=>{r.readyState===1&&r.send(a)}};return s(),n},ps=()=>{if(In){const e=new AbortController;return addEventListener("online",cs,{signal:e.signal}),addEventListener("offline",us,{signal:e.signal}),()=>e.abort()}return pe},Jt="AES-GCM",hs={},ds=e=>btoa(String.fromCharCode.apply(null,new Uint8Array(e))),ms=e=>{const t=atob(e);return new Uint8Array(t.length).map((n,s)=>t.charCodeAt(s)).buffer},gs=async(e,t)=>new Uint8Array(await crypto.subtle.digest(e,Ue(t))),Qe=async e=>hs[e]||=Array.from(await gs("SHA-1",e)).map(t=>t.toString(36)).join(""),ys=async(e,t,n)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},Ue(`${e}:${t}:${n}`)),{name:Jt},!1,["encrypt","decrypt"]),Pn="$",Nn=",",vs=async(e,t)=>{const n=crypto.getRandomValues(new Uint8Array(16));return n.join(Nn)+Pn+ds(await crypto.subtle.encrypt({name:Jt,iv:n},await e,Ue(t)))},ws=async(e,t)=>{const[n,s]=t.split(Pn);return bt(await crypto.subtle.decrypt({name:Jt,iv:new Uint8Array(n.split(Nn))},await e,ms(s)))},bs=5e3,an="icegatheringstatechange",on="offer",As="answer",ln=(e,{rtcConfig:t,rtcPolyfill:n,turnConfig:s})=>{const r=new(n||RTCPeerConnection)({iceServers:Es.concat(s||[]),...t}),a={};let o=!1,l=!1,u=null;const h=c=>{c.binaryType="arraybuffer",c.bufferedAmountLowThreshold=65535,c.onmessage=i=>a.data?.(i.data),c.onopen=()=>a.connect?.(),c.onclose=()=>a.close?.(),c.onerror=i=>a.error?.(i)},f=c=>Promise.race([new Promise(i=>{const p=()=>{c.iceGatheringState==="complete"&&(c.removeEventListener(an,p),i())};c.addEventListener(an,p),p()}),new Promise(i=>setTimeout(i,bs))]).then(()=>({type:c.localDescription.type,sdp:c.localDescription.sdp.replace(/a=ice-options:trickle\s\n/g,"")}));return e?(u=r.createDataChannel("data"),h(u)):r.ondatachannel=({channel:c})=>{u=c,h(c)},r.onnegotiationneeded=async()=>{try{o=!0,await r.setLocalDescription();const c=await f(r);a.signal?.(c)}catch(c){a.error?.(c)}finally{o=!1}},r.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(r.connectionState)&&a.close?.()},r.ontrack=c=>{a.track?.(c.track,c.streams[0]),a.stream?.(c.streams[0])},r.onremovestream=c=>a.stream?.(c.stream),e&&(r.canTrickleIceCandidates||r.onnegotiationneeded()),{created:Date.now(),connection:r,get channel(){return u},get isDead(){return r.connectionState==="closed"},async signal(c){if(!(u?.readyState==="open"&&!c.sdp?.includes("a=rtpmap")))try{if(c.type===on){if(o||r.signalingState!=="stable"&&!l){if(e)return;await Ee([r.setLocalDescription({type:"rollback"}),r.setRemoteDescription(c)])}else await r.setRemoteDescription(c);await r.setLocalDescription();const i=await f(r);return a.signal?.(i),i}else if(c.type===As){l=!0;try{await r.setRemoteDescription(c)}finally{l=!1}}}catch(i){a.error?.(i)}},sendData:c=>u.send(c),destroy:()=>{u?.close(),r.close(),o=!1,l=!1},setHandlers:c=>Object.assign(a,c),offerPromise:e?new Promise(c=>a.signal=i=>{i.type===on&&c(i)}):Promise.resolve(),addStream:c=>c.getTracks().forEach(i=>r.addTrack(i,c)),removeStream:c=>r.getSenders().filter(i=>c.getTracks().includes(i.track)).forEach(i=>r.removeTrack(i)),addTrack:(c,i)=>r.addTrack(c,i),removeTrack:c=>{const i=r.getSenders().find(p=>p.track===c);i&&r.removeTrack(i)},replaceTrack:(c,i)=>{const p=r.getSenders().find(A=>A.track===c);if(p)return p.replaceTrack(i)}}},Es=[...at(3,(e,t)=>`stun:stun${t||""}.l.google.com:19302`),"stun:stun.cloudflare.com:3478"].map(e=>({urls:e})),Ms=Object.getPrototypeOf(Uint8Array),At=12,Ln=0,Et=Ln+At,Mt=Et+1,Ze=Mt+1,et=Ze+1,Ae=16*2**10-et,vt=255,un="bufferedamountlow",Ie=e=>"@_"+e,ks=(e,t,n)=>{const s={},r={},a={},o={},l={},u={},h={},f={onPeerJoin:pe,onPeerLeave:pe,onPeerStream:pe,onPeerTrack:pe},c=(d,m)=>(d?Array.isArray(d)?d:[d]:as(s)).flatMap(T=>{const R=s[T];return R?m(T,R):(console.warn(`${rt}: no peer with id ${T} found`),[])}),i=d=>{s[d]&&(s[d].destroy(),delete s[d],delete o[d],delete l[d],f.onPeerLeave(d),t(d))},p=d=>{if(r[d])return a[d];if(!d)throw he("action type argument is required");const m=Ue(d);if(m.byteLength>At)throw he(`action type string "${d}" (${m.byteLength}b) exceeds byte limit (${At}). Hint: choose a shorter name.`);const T=new Uint8Array(At);T.set(m);let R=0;return r[d]={onComplete:pe,onProgress:pe,setOnComplete:D=>r[d]={...r[d],onComplete:D},setOnProgress:D=>r[d]={...r[d],onProgress:D},send:async(D,g,b,V)=>{if(b&&typeof b!="object")throw he("action meta argument must be an object");const Y=typeof D;if(Y==="undefined")throw he("action data cannot be undefined");const J=Y!=="string",oe=D instanceof Blob,P=oe||D instanceof ArrayBuffer||D instanceof Ms;if(b&&!P)throw he("action meta argument can only be used with binary data");const K=P?new Uint8Array(oe?await D.arrayBuffer():D):Ue(J?it(D):D),re=b?Ue(it(b)):null,$=Math.ceil(K.byteLength/Ae)+(b?1:0)||1,G=at($,(z,X)=>{const le=X===$-1,ue=b&&X===0,ce=new Uint8Array(et+(ue?re.byteLength:le?K.byteLength-Ae*($-(b?2:1)):Ae));return ce.set(T),ce.set([R],Et),ce.set([le|ue<<1|P<<2|J<<3],Mt),ce.set([Math.round((X+1)/$*vt)],Ze),ce.set(b?ue?re:K.subarray((X-1)*Ae,X*Ae):K.subarray(X*Ae,(X+1)*Ae),et),ce});return R=R+1&vt,Ee(c(g,async(z,X)=>{const{channel:le}=X;let ue=0;for(;ue<$;){const ce=G[ue];if(le.bufferedAmount>le.bufferedAmountLowThreshold&&await new Promise(Kn=>{const tn=()=>{le.removeEventListener(un,tn),Kn()};le.addEventListener(un,tn)}),!s[z])break;X.sendData(ce),ue++,V?.(ce[Ze]/vt,z,b)}}))}},a[d]||=[r[d].send,r[d].setOnComplete,r[d].setOnProgress]},A=(d,m)=>{const T=new Uint8Array(m),R=bt(T.subarray(Ln,Et)).replaceAll("\0",""),[D]=T.subarray(Et,Mt),[g]=T.subarray(Mt,Ze),[b]=T.subarray(Ze,et),V=T.subarray(et),Y=!!(g&1),J=!!(g&2),oe=!!(g&4),P=!!(g&8);if(!r[R]){console.warn(`${rt}: received message with unregistered type (${R})`);return}o[d]||={},o[d][R]||={};const K=o[d][R][D]||={chunks:[]};if(J?K.meta=ot(bt(V)):K.chunks.push(V),r[R].onProgress(b/vt,d,K.meta),!Y)return;const re=new Uint8Array(K.chunks.reduce(($,G)=>$+G.byteLength,0));if(K.chunks.reduce(($,G)=>(re.set(G,$),$+G.byteLength),0),delete o[d][R][D],oe)r[R].onComplete(re,d,K.meta);else{const $=bt(re);r[R].onComplete(P?ot($):$,d)}},k=async()=>{await S(""),await new Promise(d=>setTimeout(d,99)),Ht(s).forEach(([d,m])=>{m.destroy(),delete s[d]}),n()},[E,M]=p(Ie("ping")),[F,_]=p(Ie("pong")),[O,I]=p(Ie("signal")),[U,q]=p(Ie("stream")),[W,v]=p(Ie("track")),[S,ne]=p(Ie("leave"));return e((d,m)=>{s[m]||(s[m]=d,d.setHandlers({data:T=>A(m,T),stream:T=>{f.onPeerStream(T,m,u[m]),delete u[m]},track:(T,R)=>{f.onPeerTrack(T,R,m,h[m]),delete h[m]},signal:T=>O(T,m),close:()=>i(m),error:T=>{console.error(T),i(m)}}),f.onPeerJoin(m))}),M((d,m)=>F("",m)),_((d,m)=>{l[m]?.(),delete l[m]}),I((d,m)=>s[m]?.signal(d)),q((d,m)=>u[m]=d),v((d,m)=>h[m]=d),ne((d,m)=>i(m)),In&&addEventListener("beforeunload",k),{makeAction:p,leave:k,ping:async d=>{if(!d)throw he("ping() must be called with target peer ID");const m=Date.now();return E("",d),await new Promise(T=>l[d]=T),Date.now()-m},getPeers:()=>_n(Ht(s).map(([d,m])=>[d,m.connection])),addStream:(d,m,T)=>c(m,async(R,D)=>{T&&await U(T,R),D.addStream(d)}),removeStream:(d,m)=>c(m,(T,R)=>R.removeStream(d)),addTrack:(d,m,T,R)=>c(T,async(D,g)=>{R&&await W(R,D),g.addTrack(d,m)}),removeTrack:(d,m)=>c(m,(T,R)=>R.removeTrack(d)),replaceTrack:(d,m,T,R)=>c(T,async(D,g)=>{R&&await W(R,D),g.replaceTrack(d,m)}),onPeerJoin:d=>f.onPeerJoin=d,onPeerLeave:d=>f.onPeerLeave=d,onPeerStream:d=>f.onPeerStream=d,onPeerTrack:d=>f.onPeerTrack=d}},Ts=20,Ss=5333,cn=57333,xs=({init:e,subscribe:t,announce:n})=>{const s={};let r=!1,a,o,l,u;return(h,f,c)=>{const{appId:i}=h;if(s[i]?.[f])return s[i][f];const p={},A={},k=gt(rt,i,f),E=Qe(k),M=Qe(gt(k,_e)),F=ys(h.password||"",i,f),_=g=>async b=>({type:b.type,sdp:await g(F,b.sdp)}),O=_(ws),I=_(vs),U=()=>ln(!0,h),q=(g,b,V)=>{if(A[b]){A[b]!==g&&g.destroy();return}A[b]=g,D(g,b),p[b]?.forEach((Y,J)=>{J!==V&&Y.destroy()}),delete p[b]},W=(g,b)=>{A[b]===g&&delete A[b]},v=(g,b)=>{if(A[g])return;const V=p[g]?.[b];V&&(delete p[g][b],V.destroy())},S=g=>(o.push(...at(g,U)),Ee(o.splice(0,g).map(b=>b.offerPromise.then(I).then(V=>({peer:b,offer:V}))))),ne=(g,b)=>c?.({error:`incorrect password (${h.password}) when decrypting ${b}`,appId:i,peerId:g,roomId:f}),d=g=>async(b,V,Y)=>{const[J,oe]=await Ee([E,M]);if(b!==J&&b!==oe)return;const{peerId:P,offer:K,answer:re,peer:$}=typeof V=="string"?ot(V):V;if(!(P===_e||A[P])){if(P&&!K&&!re){if(p[P]?.[g])return;const[[{peer:G,offer:z}],X]=await Ee([S(1),Qe(gt(k,P))]);p[P]||=[],p[P][g]=G,setTimeout(()=>v(P,g),m[g]*.9),G.setHandlers({connect:()=>q(G,P,g),close:()=>W(G,P)}),Y(X,it({peerId:_e,offer:z}))}else if(K){if(p[P]?.[g]&&_e>P)return;const z=ln(!1,h);z.setHandlers({connect:()=>q(z,P,g),close:()=>W(z,P)});let X;try{X=await O(K)}catch{ne(P,"offer");return}if(z.isDead)return;const[le,ue]=await Ee([Qe(gt(k,P)),z.signal(X)]);Y(le,it({peerId:_e,answer:await I(ue)}))}else if(re){let G;try{G=await O(re)}catch{ne(P,"answer");return}if($)$.setHandlers({connect:()=>q($,P,g),close:()=>W($,P)}),$.signal(G);else{const z=p[P]?.[g];z&&!z.isDead&&z.signal(G)}}}};if(!h)throw he("requires a config map as the first argument");if(!i&&!h.firebaseApp)throw he("config map is missing appId field");if(!f)throw he("roomId argument required");if(!r){const g=e(h);o=at(Ts,U),a=Array.isArray(g)?g:[g],r=!0,l=setInterval(()=>o=o.filter(b=>{const V=Date.now()-b.created<cn;return V||b.destroy(),V}),cn*1.03),u=h.manualRelayReconnection?pe:ps()}const m=a.map(()=>Ss),T=[],R=a.map(async(g,b)=>t(await g,await E,await M,d(b),S));Ee([E,M]).then(([g,b])=>{const V=async(Y,J)=>{const oe=await n(Y,g,b);typeof oe=="number"&&(m[J]=oe),T[J]=setTimeout(()=>V(Y,J),m[J])};R.forEach(async(Y,J)=>{await Y,V(await a[J],J)})});let D=pe;return s[i]||={},s[i][f]=ks(g=>D=g,g=>delete A[g],()=>{delete s[i][f],T.forEach(clearTimeout),R.forEach(async g=>(await g)()),clearInterval(l),u(),r=!1})}},Lt={},Un={},Ke={},Xe={},Ye={},fn={},wt={},Os="announce",Dn=20,pn=10,Rs=33333,Cs=120333,Is=3,_s=async e=>{if(Lt[e])return Lt[e];const t=(await Qe(e)).slice(0,Dn);return Lt[e]=t,Un[t]=e,t},hn=async(e,t,n)=>e.send(it({action:Os,info_hash:await _s(t),peer_id:_e,...n})),dn=(e,t,n)=>console.warn(`${rt}: torrent tracker ${n?"failure":"warning"} from ${e} - ${t}`),qn=xs({init:e=>ls(e,Ps,Is).map(t=>{const n=fs(t,r=>{const a=ot(r),o=a["failure reason"],l=a["warning message"],{interval:u}=a,h=Un[a.info_hash];if(o){dn(s,o,!0);return}if(l&&dn(s,l),u&&u*1e3>Ye[s]&&Xe[s][h]){const f=Math.min(u*1e3,Cs);clearInterval(Ke[s][h]),Ye[s]=f,Ke[s][h]=setInterval(Xe[s][h],f)}fn[a.offer_id]||(a.offer||a.answer)&&(fn[a.offer_id]=!0,wt[s][h]?.(a))}),{url:s}=n;return wt[s]={},n.ready}),subscribe:(e,t,n,s,r)=>{const{url:a}=e,o=async()=>{const l=_n((await r(pn)).map(u=>[Cn(Dn),u]));wt[e.url][t]=u=>{if(u.offer)s(t,{offer:u.offer,peerId:u.peer_id},(h,f)=>hn(e,t,{answer:ot(f).answer,offer_id:u.offer_id,to_peer_id:u.peer_id}));else if(u.answer){const h=l[u.offer_id];h&&s(t,{answer:u.answer,peerId:u.peer_id,peer:h.peer})}},hn(e,t,{numwant:pn,offers:Ht(l).map(([u,{offer:h}])=>({offer_id:u,offer:h}))})};return Ye[a]=Rs,Xe[a]||={},Xe[a][t]=o,Ke[a]||={},Ke[a][t]=setInterval(o,Ye[a]),o(),()=>{clearInterval(Ke[a][t]),delete wt[a][t],delete Xe[a][t]}},announce:e=>Ye[e.url]}),Ps=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.btorrent.xyz","tracker.files.fm:7073/announce"].map(e=>"wss://"+e);var te="INUMBER",Be="IOP1",je="IOP2",Je="IOP3",me="IVAR",xe="IVARNAME",He="IFUNCALL",Tt="IFUNDEF",Q="IEXPR",Gt="IEXPREVAL",Oe="IMEMBER",St="IENDSTATEMENT",Ve="IARRAY";function x(e,t){this.type=e,this.value=t??0}x.prototype.toString=function(){switch(this.type){case te:case Be:case je:case Je:case me:case xe:case St:return this.value;case He:return"CALL "+this.value;case Tt:return"DEF "+this.value;case Ve:return"ARRAY "+this.value;case Oe:return"."+this.value;default:return"Invalid Instruction"}};function xt(e){return new x(Be,e)}function ye(e){return new x(je,e)}function Hn(e){return new x(Je,e)}function Ft(e,t,n,s,r){for(var a=[],o=[],l,u,h,f,c=0;c<e.length;c++){var i=e[c],p=i.type;if(p===te||p===xe)Array.isArray(i.value)?a.push.apply(a,Ft(i.value.map(function(A){return new x(te,A)}).concat(new x(Ve,i.value.length)),t,n,s,r)):a.push(i);else if(p===me&&r.hasOwnProperty(i.value))i=new x(te,r[i.value]),a.push(i);else if(p===je&&a.length>1)u=a.pop(),l=a.pop(),f=n[i.value],i=new x(te,f(l.value,u.value)),a.push(i);else if(p===Je&&a.length>2)h=a.pop(),u=a.pop(),l=a.pop(),i.value==="?"?a.push(l.value?u.value:h.value):(f=s[i.value],i=new x(te,f(l.value,u.value,h.value)),a.push(i));else if(p===Be&&a.length>0)l=a.pop(),f=t[i.value],i=new x(te,f(l.value)),a.push(i);else if(p===Q){for(;a.length>0;)o.push(a.shift());o.push(new x(Q,Ft(i.value,t,n,s,r)))}else if(p===Oe&&a.length>0)l=a.pop(),a.push(new x(te,l.value[i.value]));else{for(;a.length>0;)o.push(a.shift());o.push(i)}}for(;a.length>0;)o.push(a.shift());return o}function Vn(e,t,n){for(var s=[],r=0;r<e.length;r++){var a=e[r],o=a.type;if(o===me&&a.value===t)for(var l=0;l<n.tokens.length;l++){var u=n.tokens[l],h;u.type===Be?h=xt(u.value):u.type===je?h=ye(u.value):u.type===Je?h=Hn(u.value):h=new x(u.type,u.value),s.push(h)}else o===Q?s.push(new x(Q,Vn(a.value,t,n))):s.push(a)}return s}function Me(e,t,n){var s=[],r,a,o,l,u,h;if(zt(e))return fe(e,n);for(var f=e.length,c=0;c<f;c++){var i=e[c],p=i.type;if(p===te||p===xe)s.push(i.value);else if(p===je)a=s.pop(),r=s.pop(),i.value==="and"?s.push(r?!!Me(a,t,n):!1):i.value==="or"?s.push(r?!0:!!Me(a,t,n)):i.value==="="?(l=t.binaryOps[i.value],s.push(l(r,Me(a,t,n),n))):(l=t.binaryOps[i.value],s.push(l(fe(r,n),fe(a,n))));else if(p===Je)o=s.pop(),a=s.pop(),r=s.pop(),i.value==="?"?s.push(Me(r?a:o,t,n)):(l=t.ternaryOps[i.value],s.push(l(fe(r,n),fe(a,n),fe(o,n))));else if(p===me)if(i.value in t.functions)s.push(t.functions[i.value]);else if(i.value in t.unaryOps&&t.parser.isOperatorEnabled(i.value))s.push(t.unaryOps[i.value]);else{var A=n[i.value];if(A!==void 0)s.push(A);else throw new Error("undefined variable: "+i.value)}else if(p===Be)r=s.pop(),l=t.unaryOps[i.value],s.push(l(fe(r,n)));else if(p===He){for(h=i.value,u=[];h-- >0;)u.unshift(fe(s.pop(),n));if(l=s.pop(),l.apply&&l.call)s.push(l.apply(void 0,u));else throw new Error(l+" is not a function")}else if(p===Tt)s.push((function(){for(var k=s.pop(),E=[],M=i.value;M-- >0;)E.unshift(s.pop());var F=s.pop(),_=function(){for(var O=Object.assign({},n),I=0,U=E.length;I<U;I++)O[E[I]]=arguments[I];return Me(k,t,O)};return Object.defineProperty(_,"name",{value:F,writable:!1}),n[F]=_,_})());else if(p===Q)s.push(Ns(i,t));else if(p===Gt)s.push(i);else if(p===Oe)r=s.pop(),s.push(r[i.value]);else if(p===St)s.pop();else if(p===Ve){for(h=i.value,u=[];h-- >0;)u.unshift(s.pop());s.push(u)}else throw new Error("invalid Expression")}if(s.length>1)throw new Error("invalid Expression (parity)");return s[0]===0?0:fe(s[0],n)}function Ns(e,t,n){return zt(e)?e:{type:Gt,value:function(s){return Me(e.value,t,s)}}}function zt(e){return e&&e.type===Gt}function fe(e,t){return zt(e)?e.value(t):e}function Wt(e,t){for(var n=[],s,r,a,o,l,u,h=0;h<e.length;h++){var f=e[h],c=f.type;if(c===te)typeof f.value=="number"&&f.value<0?n.push("("+f.value+")"):Array.isArray(f.value)?n.push("["+f.value.map(mn).join(", ")+"]"):n.push(mn(f.value));else if(c===je)r=n.pop(),s=n.pop(),o=f.value,t?o==="^"?n.push("Math.pow("+s+", "+r+")"):o==="and"?n.push("(!!"+s+" && !!"+r+")"):o==="or"?n.push("(!!"+s+" || !!"+r+")"):o==="||"?n.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+s+"),("+r+")))"):o==="=="?n.push("("+s+" === "+r+")"):o==="!="?n.push("("+s+" !== "+r+")"):o==="["?n.push(s+"[("+r+") | 0]"):n.push("("+s+" "+o+" "+r+")"):o==="["?n.push(s+"["+r+"]"):n.push("("+s+" "+o+" "+r+")");else if(c===Je)if(a=n.pop(),r=n.pop(),s=n.pop(),o=f.value,o==="?")n.push("("+s+" ? "+r+" : "+a+")");else throw new Error("invalid Expression");else if(c===me||c===xe)n.push(f.value);else if(c===Be)s=n.pop(),o=f.value,o==="-"||o==="+"?n.push("("+o+s+")"):t?o==="not"?n.push("(!"+s+")"):o==="!"?n.push("fac("+s+")"):n.push(o+"("+s+")"):o==="!"?n.push("("+s+"!)"):n.push("("+o+" "+s+")");else if(c===He){for(u=f.value,l=[];u-- >0;)l.unshift(n.pop());o=n.pop(),n.push(o+"("+l.join(", ")+")")}else if(c===Tt){for(r=n.pop(),u=f.value,l=[];u-- >0;)l.unshift(n.pop());s=n.pop(),t?n.push("("+s+" = function("+l.join(", ")+") { return "+r+" })"):n.push("("+s+"("+l.join(", ")+") = "+r+")")}else if(c===Oe)s=n.pop(),n.push(s+"."+f.value);else if(c===Ve){for(u=f.value,l=[];u-- >0;)l.unshift(n.pop());n.push("["+l.join(", ")+"]")}else if(c===Q)n.push("("+Wt(f.value,t)+")");else if(c!==St)throw new Error("invalid Expression")}return n.length>1&&(t?n=[n.join(",")]:n=[n.join(";")]),String(n[0])}function mn(e){return typeof e=="string"?JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):e}function Ne(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return!0;return!1}function Kt(e,t,n){n=n||{};for(var s=!!n.withMembers,r=null,a=0;a<e.length;a++){var o=e[a];o.type===me||o.type===xe?!s&&!Ne(t,o.value)?t.push(o.value):(r!==null&&(Ne(t,r)||t.push(r)),r=o.value):o.type===Oe&&s&&r!==null?r+="."+o.value:o.type===Q?Kt(o.value,t,n):r!==null&&(Ne(t,r)||t.push(r),r=null)}r!==null&&!Ne(t,r)&&t.push(r)}function se(e,t){this.tokens=e,this.parser=t,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.functions=t.functions}se.prototype.simplify=function(e){return e=e||{},new se(Ft(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,e),this.parser)};se.prototype.substitute=function(e,t){return t instanceof se||(t=this.parser.parse(String(t))),new se(Vn(this.tokens,e,t),this.parser)};se.prototype.evaluate=function(e){return e=e||{},Me(this.tokens,this,e)};se.prototype.toString=function(){return Wt(this.tokens,!1)};se.prototype.symbols=function(e){e=e||{};var t=[];return Kt(this.tokens,t,e),t};se.prototype.variables=function(e){e=e||{};var t=[];Kt(this.tokens,t,e);var n=this.functions;return t.filter(function(s){return!(s in n)})};se.prototype.toJSFunction=function(e,t){var n=this,s=new Function(e,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+Wt(this.simplify(t).tokens,!0)+"; }");return function(){return s.apply(n,arguments)}};var lt="TEOF",N="TOP",Ot="TNUMBER",Fn="TSTRING",ge="TPAREN",Fe="TBRACKET",Rt="TCOMMA",Xt="TNAME",Yt="TSEMICOLON";function $n(e,t,n){this.type=e,this.value=t,this.index=n}$n.prototype.toString=function(){return this.type+": "+this.value};function H(e,t){this.pos=0,this.current=null,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.consts=e.consts,this.expression=t,this.savedPosition=0,this.savedCurrent=null,this.options=e.options,this.parser=e}H.prototype.newToken=function(e,t,n){return new $n(e,t,n??this.pos)};H.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};H.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};H.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(lt,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};H.prototype.isString=function(){var e=!1,t=this.pos,n=this.expression.charAt(t);if(n==="'"||n==='"')for(var s=this.expression.indexOf(n,t+1);s>=0&&this.pos<this.expression.length;){if(this.pos=s+1,this.expression.charAt(s-1)!=="\\"){var r=this.expression.substring(t+1,s);this.current=this.newToken(Fn,this.unescape(r),t),e=!0;break}s=this.expression.indexOf(n,s+1)}return e};H.prototype.isParen=function(){var e=this.expression.charAt(this.pos);return e==="("||e===")"?(this.current=this.newToken(ge,e),this.pos++,!0):!1};H.prototype.isBracket=function(){var e=this.expression.charAt(this.pos);return(e==="["||e==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken(Fe,e),this.pos++,!0):!1};H.prototype.isComma=function(){var e=this.expression.charAt(this.pos);return e===","?(this.current=this.newToken(Rt,","),this.pos++,!0):!1};H.prototype.isSemicolon=function(){var e=this.expression.charAt(this.pos);return e===";"?(this.current=this.newToken(Yt,";"),this.pos++,!0):!1};H.prototype.isConst=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var n=this.expression.charAt(t);if(n.toUpperCase()===n.toLowerCase()&&(t===this.pos||n!=="_"&&n!=="."&&(n<"0"||n>"9")))break}if(t>e){var s=this.expression.substring(e,t);if(s in this.consts)return this.current=this.newToken(Ot,this.consts[s]),this.pos+=s.length,!0}return!1};H.prototype.isNamedOp=function(){for(var e=this.pos,t=e;t<this.expression.length;t++){var n=this.expression.charAt(t);if(n.toUpperCase()===n.toLowerCase()&&(t===this.pos||n!=="_"&&(n<"0"||n>"9")))break}if(t>e){var s=this.expression.substring(e,t);if(this.isOperatorEnabled(s)&&(s in this.binaryOps||s in this.unaryOps||s in this.ternaryOps))return this.current=this.newToken(N,s),this.pos+=s.length,!0}return!1};H.prototype.isName=function(){for(var e=this.pos,t=e,n=!1;t<this.expression.length;t++){var s=this.expression.charAt(t);if(s.toUpperCase()===s.toLowerCase()){if(t===this.pos&&(s==="$"||s==="_")){s==="_"&&(n=!0);continue}else if(t===this.pos||!n||s!=="_"&&(s<"0"||s>"9"))break}else n=!0}if(n){var r=this.expression.substring(e,t);return this.current=this.newToken(Xt,r),this.pos+=r.length,!0}return!1};H.prototype.isWhitespace=function(){for(var e=!1,t=this.expression.charAt(this.pos);(t===" "||t==="	"||t===`
`||t==="\r")&&(e=!0,this.pos++,!(this.pos>=this.expression.length));)t=this.expression.charAt(this.pos);return e};var Ls=/^[0-9a-f]{4}$/i;H.prototype.unescape=function(e){var t=e.indexOf("\\");if(t<0)return e;for(var n=e.substring(0,t);t>=0;){var s=e.charAt(++t);switch(s){case"'":n+="'";break;case'"':n+='"';break;case"\\":n+="\\";break;case"/":n+="/";break;case"b":n+="\b";break;case"f":n+="\f";break;case"n":n+=`
`;break;case"r":n+="\r";break;case"t":n+="	";break;case"u":var r=e.substring(t+1,t+5);Ls.test(r)||this.parseError("Illegal escape sequence: \\u"+r),n+=String.fromCharCode(parseInt(r,16)),t+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+s+'"')}++t;var a=e.indexOf("\\",t);n+=e.substring(t,a<0?e.length:a),t=a}return n};H.prototype.isComment=function(){var e=this.expression.charAt(this.pos);return e==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};H.prototype.isRadixInteger=function(){var e=this.pos;if(e>=this.expression.length-2||this.expression.charAt(e)!=="0")return!1;++e;var t,n;if(this.expression.charAt(e)==="x")t=16,n=/^[0-9a-f]$/i,++e;else if(this.expression.charAt(e)==="b")t=2,n=/^[01]$/i,++e;else return!1;for(var s=!1,r=e;e<this.expression.length;){var a=this.expression.charAt(e);if(n.test(a))e++,s=!0;else break}return s&&(this.current=this.newToken(Ot,parseInt(this.expression.substring(r,e),t)),this.pos=e),s};H.prototype.isNumber=function(){for(var e=!1,t=this.pos,n=t,s=t,r=!1,a=!1,o;t<this.expression.length&&(o=this.expression.charAt(t),o>="0"&&o<="9"||!r&&o===".");)o==="."?r=!0:a=!0,t++,e=a;if(e&&(s=t),o==="e"||o==="E"){t++;for(var l=!0,u=!1;t<this.expression.length;){if(o=this.expression.charAt(t),l&&(o==="+"||o==="-"))l=!1;else if(o>="0"&&o<="9")u=!0,l=!1;else break;t++}u||(t=s)}return e?(this.current=this.newToken(Ot,parseFloat(this.expression.substring(n,t))),this.pos=t):this.pos=s,e};H.prototype.isOperator=function(){var e=this.pos,t=this.expression.charAt(this.pos);if(t==="+"||t==="-"||t==="*"||t==="/"||t==="%"||t==="^"||t==="?"||t===":"||t===".")this.current=this.newToken(N,t);else if(t==="∙"||t==="•")this.current=this.newToken(N,"*");else if(t===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(N,">="),this.pos++):this.current=this.newToken(N,">");else if(t==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(N,"<="),this.pos++):this.current=this.newToken(N,"<");else if(t==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(N,"||"),this.pos++;else return!1;else if(t==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(N,"=="),this.pos++):this.current=this.newToken(N,t);else if(t==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(N,"!="),this.pos++):this.current=this.newToken(N,t);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=e,!1)};H.prototype.isOperatorEnabled=function(e){return this.parser.isOperatorEnabled(e)};H.prototype.getCoordinates=function(){var e=0,t,n=-1;do e++,t=this.pos-n,n=this.expression.indexOf(`
`,n+1);while(n>=0&&n<this.pos);return{line:e,column:t}};H.prototype.parseError=function(e){var t=this.getCoordinates();throw new Error("parse error ["+t.line+":"+t.column+"]: "+e)};function L(e,t,n){this.parser=e,this.tokens=t,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=n.allowMemberAccess!==!1}L.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};L.prototype.tokenMatches=function(e,t){return typeof t>"u"?!0:Array.isArray(t)?Ne(t,e.value):typeof t=="function"?t(e):e.value===t};L.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};L.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};L.prototype.accept=function(e,t){return this.nextToken.type===e&&this.tokenMatches(this.nextToken,t)?(this.next(),!0):!1};L.prototype.expect=function(e,t){if(!this.accept(e,t)){var n=this.tokens.getCoordinates();throw new Error("parse error ["+n.line+":"+n.column+"]: Expected "+(t||e))}};L.prototype.parseAtom=function(e){var t=this.tokens.unaryOps;function n(r){return r.value in t}if(this.accept(Xt)||this.accept(N,n))e.push(new x(me,this.current.value));else if(this.accept(Ot))e.push(new x(te,this.current.value));else if(this.accept(Fn))e.push(new x(te,this.current.value));else if(this.accept(ge,"("))this.parseExpression(e),this.expect(ge,")");else if(this.accept(Fe,"["))if(this.accept(Fe,"]"))e.push(new x(Ve,0));else{var s=this.parseArrayList(e);e.push(new x(Ve,s))}else throw new Error("unexpected "+this.nextToken)};L.prototype.parseExpression=function(e){var t=[];this.parseUntilEndStatement(e,t)||(this.parseVariableAssignmentExpression(t),!this.parseUntilEndStatement(e,t)&&this.pushExpression(e,t))};L.prototype.pushExpression=function(e,t){for(var n=0,s=t.length;n<s;n++)e.push(t[n])};L.prototype.parseUntilEndStatement=function(e,t){return this.accept(Yt)?(this.nextToken&&this.nextToken.type!==lt&&!(this.nextToken.type===ge&&this.nextToken.value===")")&&t.push(new x(St)),this.nextToken.type!==lt&&this.parseExpression(t),e.push(new x(Q,t)),!0):!1};L.prototype.parseArrayList=function(e){for(var t=0;!this.accept(Fe,"]");)for(this.parseExpression(e),++t;this.accept(Rt);)this.parseExpression(e),++t;return t};L.prototype.parseVariableAssignmentExpression=function(e){for(this.parseConditionalExpression(e);this.accept(N,"=");){var t=e.pop(),n=[],s=e.length-1;if(t.type===He){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var r=0,a=t.value+1;r<a;r++){var o=s-r;e[o].type===me&&(e[o]=new x(xe,e[o].value))}this.parseVariableAssignmentExpression(n),e.push(new x(Q,n)),e.push(new x(Tt,t.value));continue}if(t.type!==me&&t.type!==Oe)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(n),e.push(new x(xe,t.value)),e.push(new x(Q,n)),e.push(ye("="))}};L.prototype.parseConditionalExpression=function(e){for(this.parseOrExpression(e);this.accept(N,"?");){var t=[],n=[];this.parseConditionalExpression(t),this.expect(N,":"),this.parseConditionalExpression(n),e.push(new x(Q,t)),e.push(new x(Q,n)),e.push(Hn("?"))}};L.prototype.parseOrExpression=function(e){for(this.parseAndExpression(e);this.accept(N,"or");){var t=[];this.parseAndExpression(t),e.push(new x(Q,t)),e.push(ye("or"))}};L.prototype.parseAndExpression=function(e){for(this.parseComparison(e);this.accept(N,"and");){var t=[];this.parseComparison(t),e.push(new x(Q,t)),e.push(ye("and"))}};var Us=["==","!=","<","<=",">=",">","in"];L.prototype.parseComparison=function(e){for(this.parseAddSub(e);this.accept(N,Us);){var t=this.current;this.parseAddSub(e),e.push(ye(t.value))}};var Ds=["+","-","||"];L.prototype.parseAddSub=function(e){for(this.parseTerm(e);this.accept(N,Ds);){var t=this.current;this.parseTerm(e),e.push(ye(t.value))}};var qs=["*","/","%"];L.prototype.parseTerm=function(e){for(this.parseFactor(e);this.accept(N,qs);){var t=this.current;this.parseFactor(e),e.push(ye(t.value))}};L.prototype.parseFactor=function(e){var t=this.tokens.unaryOps;function n(r){return r.value in t}if(this.save(),this.accept(N,n)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===ge&&this.nextToken.value==="("){this.restore(),this.parseExponential(e);return}else if(this.nextToken.type===Yt||this.nextToken.type===Rt||this.nextToken.type===lt||this.nextToken.type===ge&&this.nextToken.value===")"){this.restore(),this.parseAtom(e);return}}var s=this.current;this.parseFactor(e),e.push(xt(s.value))}else this.parseExponential(e)};L.prototype.parseExponential=function(e){for(this.parsePostfixExpression(e);this.accept(N,"^");)this.parseFactor(e),e.push(ye("^"))};L.prototype.parsePostfixExpression=function(e){for(this.parseFunctionCall(e);this.accept(N,"!");)e.push(xt("!"))};L.prototype.parseFunctionCall=function(e){var t=this.tokens.unaryOps;function n(a){return a.value in t}if(this.accept(N,n)){var s=this.current;this.parseAtom(e),e.push(xt(s.value))}else for(this.parseMemberExpression(e);this.accept(ge,"(");)if(this.accept(ge,")"))e.push(new x(He,0));else{var r=this.parseArgumentList(e);e.push(new x(He,r))}};L.prototype.parseArgumentList=function(e){for(var t=0;!this.accept(ge,")");)for(this.parseExpression(e),++t;this.accept(Rt);)this.parseExpression(e),++t;return t};L.prototype.parseMemberExpression=function(e){for(this.parseAtom(e);this.accept(N,".")||this.accept(Fe,"[");){var t=this.current;if(t.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(Xt),e.push(new x(Oe,this.current.value))}else if(t.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(e),this.expect(Fe,"]"),e.push(ye("["))}else throw new Error("unexpected symbol: "+t.value)}};function Hs(e,t){return Number(e)+Number(t)}function Vs(e,t){return e-t}function Fs(e,t){return e*t}function $s(e,t){return e/t}function Bs(e,t){return e%t}function js(e,t){return Array.isArray(e)&&Array.isArray(t)?e.concat(t):""+e+t}function Js(e,t){return e===t}function Gs(e,t){return e!==t}function zs(e,t){return e>t}function Ws(e,t){return e<t}function Ks(e,t){return e>=t}function Xs(e,t){return e<=t}function Ys(e,t){return!!(e&&t)}function Qs(e,t){return!!(e||t)}function Zs(e,t){return Ne(t,e)}function er(e){return(Math.exp(e)-Math.exp(-e))/2}function tr(e){return(Math.exp(e)+Math.exp(-e))/2}function nr(e){return e===1/0?1:e===-1/0?-1:(Math.exp(e)-Math.exp(-e))/(Math.exp(e)+Math.exp(-e))}function sr(e){return e===-1/0?e:Math.log(e+Math.sqrt(e*e+1))}function rr(e){return Math.log(e+Math.sqrt(e*e-1))}function ar(e){return Math.log((1+e)/(1-e))/2}function gn(e){return Math.log(e)*Math.LOG10E}function ir(e){return-e}function or(e){return!e}function lr(e){return e<0?Math.ceil(e):Math.floor(e)}function ur(e){return Math.random()*(e||1)}function yn(e){return Qt(e+1)}function cr(e){return isFinite(e)&&e===Math.round(e)}var fr=4.7421875,Ut=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function Qt(e){var t,n;if(cr(e)){if(e<=0)return isFinite(e)?1/0:NaN;if(e>171)return 1/0;for(var s=e-2,r=e-1;s>1;)r*=s,s--;return r===0&&(r=1),r}if(e<.5)return Math.PI/(Math.sin(Math.PI*e)*Qt(1-e));if(e>=171.35)return 1/0;if(e>85){var a=e*e,o=a*e,l=o*e,u=l*e;return Math.sqrt(2*Math.PI/e)*Math.pow(e/Math.E,e)*(1+1/(12*e)+1/(288*a)-139/(51840*o)-571/(2488320*l)+163879/(209018880*u)+5246819/(75246796800*u*e))}--e,n=Ut[0];for(var h=1;h<Ut.length;++h)n+=Ut[h]/(e+h);return t=e+fr+.5,Math.sqrt(2*Math.PI)*Math.pow(t,e+.5)*Math.exp(-t)*n}function pr(e){return Array.isArray(e)?e.length:String(e).length}function vn(){for(var e=0,t=0,n=0;n<arguments.length;n++){var s=Math.abs(arguments[n]),r;t<s?(r=t/s,e=e*r*r+1,t=s):s>0?(r=s/t,e+=r*r):e+=s}return t===1/0?1/0:t*Math.sqrt(e)}function wn(e,t,n){return e?t:n}function hr(e,t){return typeof t>"u"||+t==0?Math.round(e):(e=+e,t=-+t,isNaN(e)||!(typeof t=="number"&&t%1===0)?NaN:(e=e.toString().split("e"),e=Math.round(+(e[0]+"e"+(e[1]?+e[1]-t:-t))),e=e.toString().split("e"),+(e[0]+"e"+(e[1]?+e[1]+t:t))))}function dr(e,t,n){return n&&(n[e]=t),t}function mr(e,t){return e[t|0]}function gr(e){return arguments.length===1&&Array.isArray(e)?Math.max.apply(Math,e):Math.max.apply(Math,arguments)}function yr(e){return arguments.length===1&&Array.isArray(e)?Math.min.apply(Math,e):Math.min.apply(Math,arguments)}function vr(e,t){if(typeof e!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(t))throw new Error("Second argument to map is not an array");return t.map(function(n,s){return e(n,s)})}function wr(e,t,n){if(typeof e!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(n))throw new Error("Second argument to fold is not an array");return n.reduce(function(s,r,a){return e(s,r,a)},t)}function br(e,t){if(typeof e!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(t))throw new Error("Second argument to filter is not an array");return t.filter(function(n,s){return e(n,s)})}function Ar(e,t){if(!(Array.isArray(t)||typeof t=="string"))throw new Error("Second argument to indexOf is not a string or array");return t.indexOf(e)}function Er(e,t){if(!Array.isArray(t))throw new Error("Second argument to join is not an array");return t.join(e)}function Mr(e){return(e>0)-(e<0)||+e}var bn=1/3;function kr(e){return e<0?-Math.pow(-e,bn):Math.pow(e,bn)}function Tr(e){return Math.exp(e)-1}function Sr(e){return Math.log(1+e)}function xr(e){return Math.log(e)/Math.LN2}function be(e){this.options=e||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||er,cosh:Math.cosh||tr,tanh:Math.tanh||nr,asinh:Math.asinh||sr,acosh:Math.acosh||rr,atanh:Math.atanh||ar,sqrt:Math.sqrt,cbrt:Math.cbrt||kr,log:Math.log,log2:Math.log2||xr,ln:Math.log,lg:Math.log10||gn,log10:Math.log10||gn,expm1:Math.expm1||Tr,log1p:Math.log1p||Sr,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||lr,"-":ir,"+":Number,exp:Math.exp,not:or,length:pr,"!":yn,sign:Math.sign||Mr},this.binaryOps={"+":Hs,"-":Vs,"*":Fs,"/":$s,"%":Bs,"^":Math.pow,"||":js,"==":Js,"!=":Gs,">":zs,"<":Ws,">=":Ks,"<=":Xs,and:Ys,or:Qs,in:Zs,"=":dr,"[":mr},this.ternaryOps={"?":wn},this.functions={random:ur,fac:yn,min:yr,max:gr,hypot:Math.hypot||vn,pyt:Math.hypot||vn,pow:Math.pow,atan2:Math.atan2,if:wn,gamma:Qt,roundTo:hr,map:vr,fold:wr,filter:br,indexOf:Ar,join:Er},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}be.prototype.parse=function(e){var t=[],n=new L(this,new H(this,e),{allowMemberAccess:this.options.allowMemberAccess});return n.parseExpression(t),n.expect(lt,"EOF"),new se(t,this)};be.prototype.evaluate=function(e,t){return this.parse(e).evaluate(t)};var Bn=new be;be.parse=function(e){return Bn.parse(e)};be.evaluate=function(e,t){return Bn.parse(e).evaluate(t)};var An={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function Or(e){return An.hasOwnProperty(e)?An[e]:e}be.prototype.isOperatorEnabled=function(e){var t=Or(e),n=this.options.operators||{};return!(t in n)||!!n[t]};const aa={NEXT_ROLL:"Próxima Rolagem",ROUNDS:"Rodadas",MINUTES:"Minutos",HOURS:"Horas",DAYS:"Dias",LUCK_ENDS:"Sorte Encerra",PERMANENT:"Indeterminado",END_OF_ROUND:"Fim da Rodada",CONCENTRATION:"Concentração"},De={ADD:"ADD",SET:"SET",MULT:"MULT"},ia={str:"Força",agi:"Agilidade",int:"Intelecto",wil:"Vontade",defense:"Defesa",speed:"Deslocamento",health:"Vida",damage:"Dano (Dados)",boons:"Boons/Banes",healing_rate:"Taxa de Cura"},ve={WEAPON:"Weapon",ARMOR:"Armor",SHIELD:"Shield",CONSUMABLE:"Consumable",EXPLOSIVE:"Explosive",OTHER:"Other"},oa=["Aeromancy","Alchemy","Alteration","Animism","Astromancy","Chaos","Chronomancy","Conjuration","Cryomancy","Dark Arts","Destruction","Divination","Eldritch","Enchantment","Evocation","Geomancy","Hydromancy","Illusion","Invocation","Necromancy","Oneiromancy","Order","Primal","Protection","Psychomancy","Pyromancy","Shadowmancy","Skullduggery","Spiritualism","Symbolism","Technomancy","Teleportation","War"],Rr=[[1,0,0,0,0,0,0,0,0,0,0],[2,1,0,0,0,0,0,0,0,0,0],[3,2,1,0,0,0,0,0,0,0,0],[4,2,1,1,0,0,0,0,0,0,0],[5,2,2,1,1,0,0,0,0,0,0],[6,3,2,2,1,1,0,0,0,0,0],[7,3,2,2,2,1,1,0,0,0,0],[8,3,2,2,2,1,1,1,0,0,0],[9,3,3,2,2,2,1,1,1,0,0],[10,3,3,3,2,2,1,1,1,1,0],[11,3,3,3,3,2,1,1,1,1,1]],la=["Air","Alteration","Arcana","Battle","Celestial","Chaos","Conjuration","Curse","Death","Demonology","Destruction","Divination","Enchantment","Ether","Fey","Fire","Forbidden","Illusion","Life","Metal","Nature","Necromancy","Order","Primal","Protection","Rune","Shadow","Song","Soul","Spiritualism","Storm","Technomancy","Telekinesis","Telepathy","Teleportation","Theurgy","Time","Transformation","Water"];function ua(e,t){return e<0||e>10||t<0||t>10?0:Rr[e]?.[t]??0}const Cr=new be,jn={name:"",level:1,ancestry:"",paths:{novice:"",expert:"",master:""},attributes:[{name:"Strength",value:10,key:"str"},{name:"Agility",value:10,key:"agi"},{name:"Intellect",value:10,key:"int"},{name:"Will",value:10,key:"wil"}],currency:{gp:0,sp:0,cp:0},naturalDefense:10,bonusDamage:0,size:1,speed:10,currentRound:1,languages:[],professions:[],senses:[],afflictions:[],effects:[],notes:"",campaignId:null,campaignName:null,gmName:null,combatActive:!1,initiative:!1,acted:!1,spells:[],talents:[],equipment:[]},y=Z(JSON.parse(JSON.stringify(jn))),st=Z([]),qe=Z({type:null,isOpen:!1,data:null}),Ir=Z("acoes"),Ct=Z(24),Re=Z(24),Ge=Z(0),$e=Z(!1),It=Z(!1),En={autoOpenHistory:!1,stickyHistory:!1,theme:"dark",userName:"",enable3DDice:!1,diceTheme:"default"};function _r(){const e=typeof localStorage<"u"?localStorage.getItem("wwv_app_settings"):null,{subscribe:t,set:n,update:s}=Z(e?{...En,...JSON.parse(e)}:En);return{subscribe:t,set:r=>{typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(r)),n(r)},update:r=>{s(a=>{const o=r(a);return typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(o)),o})}}}const Zt=_r();$e.subscribe(e=>{e&&It.set(!1)});const ze=B(y,e=>{const t=e.effects.filter(s=>s.isActive),n=e.talents.filter(s=>(s.isPassive||s.activityType==="Passive")&&s.effect).map(s=>({...s.effect,id:`talent-effect-${s.id}`,name:s.name,sourceType:"talent",sourceId:s.id}));return[...t,...n]});function Se(e,t){if(typeof e=="number")return e;if(!e)return 0;const n=String(e).trim();if(!isNaN(Number(n)))return Number(n);try{const s={};Array.isArray(t.attributes)&&t.attributes.forEach(a=>{s[a.key]=a.value}),s.level=t.level||0,s.defense=t.naturalDefense||0,s.speed=t.speed||0,s.bonusDamage=t.bonusDamage||0,s.currentRound=t.currentRound||0;const r=n.replace(/@(\w+)/g,"$1");return Cr.evaluate(r,s)}catch{return 0}}function _t(e,t,n,s){let r=t||0;const a=n.flatMap(h=>Array.isArray(h.modifiers)?h.modifiers:[]),o=a.filter(h=>h.target===e&&h.type===De.SET);return o.length>0&&(r=Se(o[o.length-1].value,s)),a.filter(h=>h.target===e&&h.type===De.ADD).forEach(h=>{r+=Se(h.value,s)}),a.filter(h=>h.target===e&&h.type===De.MULT).forEach(h=>{r*=Se(h.value,s)}),Math.floor(r)}const en=B([y,ze],([e,t])=>{const n={};return Array.isArray(e.attributes)&&e.attributes.forEach(s=>{n[s.key]=_t(s.key,s.value,t,e)}),n}),Jn=B([y,Re,ze],([e,t,n])=>_t("health",t,n,e)),Pr=B([Jn,Ct],([e,t])=>Math.max(0,e-t)),Nr=B([Ge,Re],([e,t])=>t>0?Math.min(100,e/t*100):100),Gn=B([Ge,Re],([e,t])=>e>=t),Lr=B([Ge,Re,Gn],([e,t,n])=>e>=t/2&&!n),Ur=B([y,en,ze],([e,t,n])=>{let s=_t("speed",e.speed,n,e);const r=e.afflictions;return r.includes("Held")||r.includes("Stunned")||r.includes("Unconscious")||r.includes("Incapacitated")?0:((r.includes("Blinded")||r.includes("Weakened"))&&(s=Math.floor(s/2)),r.includes("Slowed")&&(s=Math.min(s,2)),Math.max(0,s))}),Dr=B([y,ze],([e,t])=>{let n=e.naturalDefense,s=0;const r=e.equipment.find(a=>a.type===ve.ARMOR&&a.equipped);if(r){const a=r.defenseFixed||0,o=e.naturalDefense+(r.defenseMod||0);r.defenseFixed&&r.defenseMod?n=Math.max(a,o):r.defenseFixed?n=a:r.defenseMod&&(n=e.naturalDefense+r.defenseMod)}return e.equipment.filter(a=>a.type===ve.SHIELD&&a.equippedState).forEach(a=>{s+=a.defenseMod||0}),_t("defense",n+s,t,e)});B([y,ze],([e,t])=>{const s=t.flatMap(r=>Array.isArray(r.modifiers)?r.modifiers:[]).filter(r=>r.target==="damage"&&r.type===De.ADD).reduce((r,a)=>r+Se(a.value,e),0);return(e.bonusDamage||0)+s});const ee={updateCurrency:(e,t)=>{y.update(n=>{let s=n.currency.gp*100+n.currency.sp*10+n.currency.cp,r=0;return e==="gp"&&(r=t*100),e==="sp"&&(r=t*10),e==="cp"&&(r=t),s+=r,s<0&&(s=0),{...n,currency:{gp:Math.floor(s/100),sp:Math.floor(s%100/10),cp:s%100%10}}})},advanceRound:e=>{y.update(t=>{const n=t.currentRound||1;if(e==="next"){const s=(t.effects||[]).map(r=>{if(r.isActive&&r.duration==="ROUNDS"&&r.roundsLeft>0){const a=r.roundsLeft-1;return a<=0?{...r,roundsLeft:0,isActive:!1}:{...r,roundsLeft:a}}return r});return{...t,currentRound:n+1,effects:s}}else return{...t,currentRound:Math.max(1,n-1)}})},addToHistory:(e,t=!0)=>{const n=C(y),s=C(st);if(e.id&&s.find(o=>o.id===e.id))return;const r={id:e.id||tt(),timestamp:e.timestamp||new Date,charName:n.name,source:e.source||"gm",name:e.name||"Action",...e};st.update(o=>[r,...o]),C(Zt).autoOpenHistory?$e.set(!0):C($e)||It.set(!0),t&&n.campaignId&&qt(async()=>{const{syncRoll:o}=await Promise.resolve().then(()=>jt);return{syncRoll:o}},void 0,import.meta.url).then(({syncRoll:o})=>{o(r)})},clearHistory:()=>st.set([]),addItem:e=>y.update(t=>({...t,equipment:[...t.equipment,e]})),updateItem:e=>y.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?e:n)})),deleteItem:e=>y.update(t=>({...t,equipment:t.equipment.filter(n=>n.id!==e)})),useConsumable:e=>{if(e.quantity>0){const t=C(de);ee.updateItem({...e,quantity:e.quantity-1}),ee.addToHistory({source:"item",name:e.name,description:t("sofww.item_types.consumable")+`: ${e.name}`})}},equipItem:(e,t=null)=>{y.update(n=>{let s=[...n.equipment];return e.type===ve.ARMOR?s=s.map(r=>r.id===e.id?{...r,equipped:!r.equipped}:r.type===ve.ARMOR&&e.type===ve.ARMOR&&!e.equipped?{...r,equipped:!1}:r):(e.type===ve.WEAPON||e.type===ve.SHIELD)&&(s=s.map(r=>r.id===e.id?{...r,equippedState:t}:r)),{...n,equipment:s}})},toggleAffliction:e=>{y.update(t=>t.afflictions.includes(e)?{...t,afflictions:t.afflictions.filter(n=>n!==e)}:{...t,afflictions:[...t.afflictions,e]})},addLanguage:e=>y.update(t=>({...t,languages:[...t.languages,e]})),removeLanguage:e=>y.update(t=>({...t,languages:t.languages.filter((n,s)=>s!==e)})),addSense:e=>y.update(t=>({...t,senses:[...t.senses||[],e]})),removeSense:e=>y.update(t=>({...t,senses:(t.senses||[]).filter((n,s)=>s!==e)})),confirmRest:()=>{y.update(t=>{const n=t.spells.map(r=>({...r,castings:r.maxCastings})),s=t.talents.map(r=>({...r,uses:r.maxUses}));return{...t,spells:n,talents:s}}),Ge.set(0);const e=C(Ct);Re.set(e),qe.set({type:null,isOpen:!1,data:null})},finalizeRoll:(e,t,n=[],s={})=>{const r=C(y),a=C(en),o=C(de),l=e.type==="weapon_attack",u=e.type==="luck",h=e.type==="weapon_damage",f=e?.source,c=f?.name||o("common.labels.action"),i=(k,E)=>k.traits&&k.traits.toLowerCase().includes(E.toLowerCase());let p={},A=()=>{};if(h){let k=parseInt(f.damageDice)||0;const E=f.grip&&f.grip.toLowerCase()==="two"||f.equippedState&&f.equippedState.toLowerCase()==="two";i(f,"Versatile")&&E&&(k+=1);let M=r.bonusDamage||0;i(f,"Light")&&M>1&&(M-=1);const F=n.flatMap(v=>Array.isArray(v.modifiers)?v.modifiers:[]).filter(v=>v.target==="damage"&&v.type===De.ADD).reduce((v,S)=>v+Se(S.value,r),0),_=M+F,O=Math.max(0,k+_+t);let I=[],U=0,q=[];for(let v=0;v<O;v++){let S=Math.floor(Math.random()*6)+1;if(S===1&&i(f,"Brutal")){const ne=Math.floor(Math.random()*6)+1;q.push(`1->${ne}`),S=ne}else q.push(`${S}`);I.push(S),U+=S}const W=`${O}d6 [${I.join(", ")}] ${q.some(v=>v.includes("->"))?`(Rolagens: ${q.join(", ")})`:""}`;p={damageDice:I,total:U,formula:W},A=()=>{ee.addToHistory({source:"damage",name:f.name,description:`${o("history.source.damage")}: ${O}d6 ${i(f,"Brutal")?"(Brutal)":""}`,formula:W,total:U,effectsApplied:n.map(v=>v.name)}),f.type===ve.EXPLOSIVE&&ee.useConsumable(f)}}else{const k=Math.floor(Math.random()*20)+1;let E=0,M=o("history.source.luck");if(e.type==="attribute")E=(a[e.source.key]||e.source.value)-10,M=o(`sofww.attributes.${e.source.key}`);else if(l){let v="str",S=o("sofww.attributes.str");f.range==="Ranged"&&(v="agi",S=o("sofww.attributes.agi"),i(f,"Thrown")&&(v="str",S=o("sofww.attributes.str"))),i(f,"Nimble")&&(v="agi",S=o("sofww.attributes.agi")),E=(a[v]||10)-10,M=S}const F=Math.floor(n.flatMap(v=>Array.isArray(v.modifiers)?v.modifiers:[]).filter(v=>v.target==="boons"&&v.type===De.ADD).reduce((v,S)=>v+Se(S.value,r),0));t+=F;let _=0,O="",I=[];if(t!==0){const v=Math.abs(t);for(let ne=0;ne<v;ne++)I.push(Math.floor(Math.random()*6)+1);const S=Math.max(...I);t>0?(_=S,O=` + ${S} [${o("sofdl.rolls.boon")}]`):(_=-S,O=` - ${S} [${o("sofdl.rolls.bane")}]`)}const U=k+E+_;let q="";if(l?q=`${o("history.source.attack")} (${M})`:u?q=o("history.source.luck"):q=`${o("history.source.attribute")}: ${c}`,t!==0&&(q+=` ${o("sofdl.rolls.attribute_test",{values:{attr:"",modifier:t}}).replace(/^[^ ]+ /,"")}`),l&&k===20){let v=[];i(f,"Bludgeoning")&&v.push(o("sofww.afflictions.vulnerable.name")),i(f,"Piercing")&&v.push(o("sofww.afflictions.weakened.name")),i(f,"Slashing")&&v.push("+1d6 Dmg"),v.length>0&&(q+=`
CRÍTICO! ${v.join(" ")} `)}const W=`d20(${k})${E!==0?(E>=0?"+":"")+E:""}${O}`;p={d20:k,boonBaneDice:I,total:U,formula:W},A=()=>{ee.addToHistory({source:l?"attack":u?"luck":"attribute",name:c,description:q,formula:W,total:U,crit:k===20,effectsApplied:n.map(v=>v.name)}),y.update(v=>({...v,effects:v.effects.map(S=>S.isActive&&S.duration==="NEXT_ROLL"?{...S,isActive:!1}:S)})),l&&i(f,"Reload")&&y.update(v=>({...v,equipment:v.equipment.map(S=>S.id===f.id?{...S,isLoaded:!1}:S)}))}}return s.suppressHistory||A(),{...p,commit:A}},reloadWeapon:e=>{const t=C(de);y.update(n=>({...n,equipment:n.equipment.map(s=>s.id===e.id?{...s,isLoaded:!0}:s)})),ee.addToHistory({source:"attribute",name:t("actions.reload"),description:`${t("actions.reload")}: ${e.name}`})},addSpell:e=>y.update(t=>({...t,spells:[...t.spells,e]})),updateSpell:e=>y.update(t=>({...t,spells:t.spells.map(n=>n.id===e.id?e:n)})),deleteSpell:e=>y.update(t=>({...t,spells:t.spells.filter(n=>n.id!==e)})),commitSpellCast:e=>{e.castings>0&&(y.update(t=>({...t,spells:t.spells.map(n=>n.id===e.id?{...n,castings:n.castings-1}:n)})),ee.addToHistory({source:"spell",name:e.name,description:e.description}),qe.set({type:null,isOpen:!1,data:null}))},addTalent:e=>y.update(t=>({...t,talents:[...t.talents,e]})),updateTalent:e=>y.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?e:n)})),deleteTalent:e=>y.update(t=>({...t,talents:t.talents.filter(n=>n.id!==e)})),commitTalentUse:e=>{e.activityType==="Duration"&&e.duration==="LUCK_ENDS"?y.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?{...n,uses:0}:n)})):e.maxUses&&y.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?{...n,uses:n.uses-1}:n)})),ee.addToHistory({source:"talent",name:e.name,description:e.description}),qe.set({type:null,isOpen:!1,data:null})},recoverTalent:e=>{y.update(t=>({...t,talents:t.talents.map(n=>n.id===e&&n.uses<n.maxUses?{...n,uses:(n.uses||0)+1}:n)}))},rollLuckTalent:e=>{const t=C(de),n=Math.floor(Math.random()*20)+1,s=n>=10,a=C(y).talents.find(o=>o.id===e);ee.addToHistory({source:"luck",name:`${t("character.history.source.luck")} - ${a?.name||t("character.talents.title")}`,formula:`d20(${n})`,total:n,description:s?t("character.dice_roll.luck_success",{values:{total:n}}):t("character.dice_roll.luck_failure",{values:{total:n}})}),s&&y.update(o=>({...o,talents:o.talents.map(l=>l.id===e?{...l,uses:1}:l)}))},addEffect:e=>y.update(t=>({...t,effects:[...t.effects,e]})),updateEffect:e=>y.update(t=>({...t,effects:t.effects.map(n=>n.id===e.id?e:n)})),deleteEffect:e=>y.update(t=>({...t,effects:t.effects.filter(n=>n.id!==e)})),toggleEffect:e=>y.update(t=>({...t,effects:t.effects.map(n=>{if(n.id===e){const s=!n.isActive;return{...n,isActive:s,roundsLeft:s&&n.duration==="ROUNDS"&&n.initialRounds||n.roundsLeft}}return n})})),cleanInactiveEffects:()=>y.update(e=>({...e,effects:e.effects.filter(t=>t.isActive)})),applyEffectToCharacter:(e,t)=>{const n=e.name||(t?t.name:"Effect"),s=e.description||(t?t.description:""),r={id:tt(),isActive:!0,name:n,description:s,roundsLeft:0,duration:"PERMANENT",modifiers:[],...e};r.duration==="ROUNDS"&&!r.initialRounds&&(r.initialRounds=r.roundsLeft),y.update(a=>({...a,effects:[...a.effects,r]}))},checkLuckEnds:e=>{const t=C(de),n=Math.floor(Math.random()*20)+1,s=n>=10;ee.addToHistory({source:"luck",name:t("sofww.duration.luck_ends"),description:s?t("character.dice_roll.luck_success",{values:{total:n}}):t("character.dice_roll.luck_failure",{values:{total:n}})}),s&&y.update(r=>({...r,effects:r.effects.map(a=>a.id===e?{...a,isActive:!1}:a)}))},joinCampaign:e=>{y.update(t=>({...t,campaignId:e.id,campaignName:e.name,gmName:e.gmName||"Game Master"})),qt(async()=>{const{joinCampaignRoom:t}=await Promise.resolve().then(()=>jt);return{joinCampaignRoom:t}},void 0,import.meta.url).then(({joinCampaignRoom:t})=>{t(e.id,!1)})},leaveCampaign:()=>{y.update(e=>({...e,campaignId:null,campaignName:null,gmName:null,combatActive:!1}))}},ca=Object.freeze(Object.defineProperty({__proto__:null,activeEffects:ze,activeTab:Ir,appSettings:Zt,character:y,characterActions:ee,currentHealth:Re,damage:Ge,damagePercentage:Nr,defaultCharacter:jn,derivedStats:en,effectiveMaxHealth:Jn,effectiveSpeed:Ur,evaluateModifierValue:Se,hasUnreadRolls:It,isHistoryOpen:$e,isIncapacitated:Gn,isInjured:Lr,modalState:qe,normalHealth:Ct,rollHistory:st,tempHealth:Pr,totalDefense:Dr},Symbol.toStringTag,{value:"Module"})),qr=new be,Hr={id:"",system:"sofdl",name:"",ancestry:"",level:0,paths:{novice:"",expert:"",master:""},imageUrl:"",attributes:{strength:10,agility:10,intellect:10,will:10},perception:10,defense:10,health:10,healingRate:2,size:1,speed:10,power:0,damage:0,insanity:0,corruption:0,description:"",notes:"",professions:[],languages:["Comum"],senses:[],afflictions:[],talents:[],spells:[],equipment:[],currency:{gc:0,ss:0,cp:0,bits:0},effects:[],campaignId:null,campaignName:null,gmName:null,campaignApproval:null,combatActive:!1,currentRound:1,initiative:!1,acted:!1,magicSystem:"standard"},w=Z(JSON.parse(JSON.stringify(Hr))),Vr=B(w,e=>e.effects.filter(t=>t.isActive)),Ce=B([w,Vr],([e,t])=>{const n={strength:e.attributes.strength,agility:e.attributes.agility,intellect:e.attributes.intellect,will:e.attributes.will,perception:e.perception,defense:e.defense,health:e.health,speed:e.speed,healingRate:e.healingRate,power:e.power,boons:0},s=[];t.forEach(o=>{o.modifiers&&o.modifiers.forEach(l=>{s.push(l)})});const r=o=>o==="healing_rate"?"healingRate":o;return Object.keys(n).forEach(o=>{const l=s.filter(f=>r(f.target)===o);if(l.length===0)return;const u=l.filter(f=>f.type==="SET");if(u.length>0){const f=u[u.length-1];n[o]=Dt(f.value,e)}u.length===0&&l.filter(c=>c.type==="ADD").forEach(c=>{n[o]+=Dt(c.value,e)}),l.filter(f=>f.type==="MULT").forEach(f=>{n[o]*=Dt(f.value,e)}),n[o]=Math.floor(n[o])}),{strength:n.strength,agility:n.agility,intellect:n.intellect,will:n.will,perception:n.perception,defense:n.defense,health:n.health,speed:n.speed,healingRate:n.healingRate,power:n.power,boons:n.boons}}),fa=B(Ce,e=>({strength:e.strength,agility:e.agility,intellect:e.intellect,will:e.will})),Fr=B(Ce,e=>({strength:e.strength-10,agility:e.agility-10,intellect:e.intellect-10,will:e.will-10}));B([w,Ce],([e,t])=>t.health-e.damage);B([w,Ce],([e,t])=>e.damage>=t.health/2);B([w,Ce],([e,t])=>e.damage>=t.health);function Dt(e,t){if(typeof e=="number")return e;if(!e)return 0;const n=String(e).trim();if(!isNaN(Number(n)))return Number(n);try{const s={};t.attributes&&Object.entries(t.attributes).forEach(([a,o])=>{s[a]=o}),s.level=t.level||0,s.perception=t.perception||0,s.defense=t.defense||0,s.health=t.health||0,s.healingRate=t.healingRate||0,s.size=t.size||0,s.speed=t.speed||0,s.power=t.power||0,s.damage=t.damage||0,s.insanity=t.insanity||0,s.corruption=t.corruption||0;const r=n.replace(/@(\w+)/g,"$1");return qr.evaluate(r,s)}catch{return 0}}const pa=B(Ce,e=>Math.max(0,e.healingRate)),Le={set:e=>{w.update(t=>{const n={...t,...e};return e.health!==void 0&&e.healingRate===void 0&&(n.healingRate=Math.floor(n.health/4)),n})},updateAttribute:(e,t)=>{w.update(n=>({...n,attributes:{...n.attributes,[e]:t}}))},takeDamage:e=>{w.update(t=>{const n=Math.max(0,Math.min(t.health,t.damage+e));return{...t,damage:n}})},heal:e=>{w.update(t=>{const n=Math.max(0,t.damage-e);return{...t,damage:n}})},updateStat:(e,t)=>{w.update(n=>({...n,[e]:Math.max(0,t)}))},toggleEffect:e=>{w.update(t=>({...t,effects:t.effects.map(n=>n.id===e?{...n,isActive:!n.isActive}:n)}))},deleteEffect:e=>{w.update(t=>({...t,effects:t.effects.filter(n=>n.id!==e)}))},cleanInactiveEffects:()=>{w.update(e=>({...e,effects:e.effects.filter(t=>t.isActive)}))},advanceRound:e=>{w.update(t=>{if(e==="next"){const n=t.effects.map(s=>s.isActive&&s.duration==="END_OF_ROUND"?{...s,isActive:!1}:s);return{...t,currentRound:t.currentRound+1,effects:n}}return{...t,currentRound:Math.max(1,t.currentRound-1)}})},checkLuckEnds:e=>{const n=C(w).effects.find(r=>r.id===e),s=C(de);qe.set({type:"pre_roll",isOpen:!0,data:{type:"luck_ends",system:"sofdl",effectId:e,source:{name:n?.name||s("sofdl.rolls.effect")}}})},checkConcentration:e=>{const n=C(w).effects.find(r=>r.id===e),s=C(de);qe.set({type:"pre_roll",isOpen:!0,data:{type:"concentration",system:"sofdl",effectId:e,key:"will",source:{name:n?.name||s("sofdl.rolls.concentration")}}})},addSpell:e=>{w.update(t=>({...t,spells:[...t.spells,{...e,id:e.id||tt()}]}))},updateSpell:e=>{w.update(t=>({...t,spells:t.spells.map(n=>n.id===e.id?e:n)}))},deleteSpell:e=>{w.update(t=>({...t,spells:t.spells.filter(n=>n.id!==e)}))},castSpell:e=>{const n=C(w).spells.find(s=>s.id===e);n&&(w.update(s=>({...s,spells:s.spells.map(r=>r.id===e?{...r,castingsUsed:(r.castingsUsed||0)+1}:r)})),Le.addToHistory({source:"spell",name:n.name,description:n.description,type:"spell"}))},resetSpellCastings:()=>{w.update(e=>({...e,spells:e.spells.map(t=>({...t,castingsUsed:0}))}))},addTalent:e=>{w.update(t=>({...t,talents:[...t.talents,{...e,id:e.id||tt()}]}))},updateTalent:e=>{w.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?e:n)}))},deleteTalent:e=>{w.update(t=>({...t,talents:t.talents.filter(n=>n.id!==e)}))},useTalent:e=>{const n=C(w).talents.find(s=>s.id===e);n&&(w.update(s=>({...s,talents:s.talents.map(r=>r.id===e&&r.uses>0?{...r,uses:r.uses-1}:r)})),Le.addToHistory({source:"talent",name:n.name,description:n.description,type:"talent"}))},resetTalentUses:()=>{w.update(e=>({...e,talents:e.talents.map(t=>({...t,uses:t.maxUses}))}))},addSense:e=>{w.update(t=>({...t,senses:t.senses.includes(e)?t.senses:[...t.senses,e]}))},removeSense:e=>{w.update(t=>({...t,senses:t.senses.filter((n,s)=>s!==e)}))},toggleAffliction:e=>{w.update(t=>({...t,afflictions:t.afflictions.includes(e)?t.afflictions.filter(n=>n!==e):[...t.afflictions,e]}))},leaveCampaign:()=>{w.update(e=>({...e,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}))},addToHistory:(e,t=!0)=>{const n=C(w),s={id:e.id||tt(),timestamp:e.timestamp||new Date,charName:n.name,...e};st.update(a=>[s,...a]),C(Zt).autoOpenHistory?$e.set(!0):C($e)||It.set(!0),t&&n.campaignId&&qt(async()=>{const{syncRoll:a}=await Promise.resolve().then(()=>jt);return{syncRoll:a}},void 0,import.meta.url).then(({syncRoll:a})=>{a(s)})},addLanguage:e=>w.update(t=>({...t,languages:[...t.languages,e]})),removeLanguage:e=>w.update(t=>({...t,languages:t.languages.filter((n,s)=>s!==e)})),addProfession:e=>w.update(t=>({...t,professions:[...t.professions,e]})),removeProfession:e=>w.update(t=>({...t,professions:t.professions.filter((n,s)=>s!==e)})),updateCurrency:(e,t)=>{w.update(n=>{const s=Math.max(0,(n.currency[e]||0)+t);return{...n,currency:{...n.currency,[e]:s}}})},addItem:e=>w.update(t=>({...t,equipment:[...t.equipment,e]})),updateItem:e=>w.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?e:n)})),deleteItem:e=>w.update(t=>({...t,equipment:t.equipment.filter(n=>n.id!==e)})),useConsumable:e=>{w.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?{...n,quantity:Math.max(0,n.quantity-1)}:n)}))},reloadWeapon:e=>w.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?{...n,isLoaded:!0}:n)})),finalizeRoll:(e,t,n=[],s={})=>{C(w);const r=C(Fr),a=C(Ce),o=e?.type==="weapon_damage"||e?.type==="spell_damage",l=C(de),u=e?.source?.name||e?.key||l("character.modals.attribute");let h={},f=()=>{};if(o){const c=e.source?.damage??e.source?.damageDice??"1d6",i=String(c),p=Number(e.source?.damageMod)||0;let A=0,k=[],E="";if(i==="0")A=0,E="0";else if(!i.includes("d"))A=parseInt(i)||0,E=`${A}`,k=[A];else{const O=i.match(/(\d+)d(\d+)/);if(O){const I=parseInt(O[1])||1,U=parseInt(O[2])||6;for(let q=0;q<I;q++){const W=Math.floor(Math.random()*U)+1;A+=W,k.push(W)}E=`${i} [${k.join(", ")}]`}else A=1,E="1"}const M=A+t+p,F=t+p!==0?`${t+p>0?"+":""}${t+p}`:"",_=`${E}${F}`;h={damageDice:k,total:M,formula:_},f=()=>{const O=C(de);Le.addToHistory({source:"damage",name:u,description:O("sofdl.rolls.damage_description",{values:{source:u}}),formula:_,total:M,effectsApplied:n})}}else{const c=Math.floor(Math.random()*20)+1;let i=0,p=u;e.type==="attribute"?(i=r[e.key]||0,p=l(`sofdl.attributes.${e.key}`)):e.type==="luck"&&(i=0,p=l("character.luck_test"));let A=t+(a.boons||0),k=0,E="",M=[];if(A!==0){const I=Math.abs(A);for(let q=0;q<I;q++)M.push(Math.floor(Math.random()*6)+1);const U=Math.max(...M);A>0?(k=U,E=` + ${U} [${l("sofdl.rolls.boon")}]`):(k=-U,E=` - ${U} [${l("sofdl.rolls.bane")}]`)}let F="attribute";e.type==="weapon_attack"?F="attack":(e.type==="luck"||e.type==="luck_ends")&&(F="luck");const _=c+i+k,O=`d20(${c})${i!==0?(i>=0?"+":"")+i:""}${E}`;h={d20:c,boonBaneDice:M,total:_,formula:O},f=()=>{Le.addToHistory({source:F,name:p,description:e.type==="luck_ends"?l("sofdl.rolls.luck_ends",{values:{effect:u}}):l("sofdl.rolls.attribute_test",{values:{attr:p,modifier:t}}),formula:O,total:_,crit:c===20,effectsApplied:n}),e.type==="luck_ends"&&_>=10&&w.update(I=>({...I,effects:I.effects.map(U=>U.id===e.effectId?{...U,isActive:!1}:U)}))}}return s.suppressHistory||f(),{...h,commit:f}},rest:()=>{w.update(e=>{const t=e.spells.map(r=>({...r,castingsUsed:0})),n=e.talents.map(r=>({...r,uses:r.isPassive?0:r.maxUses})),s=Math.max(0,e.damage-e.healingRate);return{...e,spells:t,talents:n,damage:s}})}},zn={appId:Qn,trackerUrls:["wss://tracker.openwebtorrent.com","wss://tracker.files.fm:7073/announce","wss://tracker.webtorrent.dev","wss://toad.vibe.community:443/announce","wss://tracker.btorrent.xyz"]},ae=Z({roomId:null,peers:[],currentCharacterId:null,lastGmUpdate:0,isGM:!1,isConnected:!1}),$r=B(ae,e=>e.lastGmUpdate?Date.now()-e.lastGmUpdate<6e4:!1);let j=null,we=null,ut=null,ct=null,ft=null,pt=null,Te=null,ie=null,Mn=0,kn=0;const Br=2e3,jr={appId:"weird-wizard-vault-lobby"},$t=Z([]);function ht(e,t){if(!e)return!0;try{return e.leave(),!0}catch(n){return console.warn(`Failed to leave ${t}:`,n),!1}}function Wn(e){return Date.now()-e>=Br}function Bt(){if(!Wn(Mn))return console.warn("Lobby join rate limited. Skipping duplicate join attempt."),null;Mn=Date.now(),Te&&(clearInterval(Te),Te=null),ht(we,"existing lobby"),we=null;try{we=qn(jr,"public-discovery");const[e,t]=we.makeAction("discovery");return t(n=>{$t.update(s=>{const r=s.findIndex(a=>a.id===n.id);if(r!==-1){const a=[...s];return a[r]={...n,lastSeen:Date.now()},a}return[...s,{...n,lastSeen:Date.now()}]})}),Te=setInterval(()=>{const n=Date.now();$t.update(s=>s.filter(r=>n-r.lastSeen<12e4))},6e4),e}catch(e){return console.error("Failed to join lobby:",e),we=null,null}}let kt;function Jr(){typeof window<"u"&&(sessionStorage.getItem("lobby-initialized")?we||(kt=Bt()):(sessionStorage.setItem("lobby-initialized","true"),kt=Bt()))}typeof window<"u"&&(Jr(),window.addEventListener("beforeunload",()=>{Tn()}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Tn()}));function Tn(){Te&&(clearInterval(Te),Te=null),ie&&(clearInterval(ie),ie=null),ht(we,"lobby"),ht(j,"room"),we=null,j=null}let Pe=null;function Gr(e,t=!1,n=null){const s=`campaign-${e}`;if(Pe===s&&j)return ae.update(r=>({...r,isGM:t,currentCharacterId:n})),j;if(!Wn(kn))return console.warn("Campaign join rate limited. Skipping duplicate join attempt."),j;kn=Date.now(),ie&&(clearInterval(ie),ie=null),ht(j,"existing campaign room"),j=null,Pe=null,ut=null,ct=null,ft=null,pt=null;try{Pe=s,j=qn(zn,Pe),ae.set({isConnected:!0,isGM:t,currentCharacterId:n,peers:[],roomId:e,lastGmUpdate:0});const[r,a]=j.makeAction("combat"),[o,l]=j.makeAction("history"),[u,h]=j.makeAction("charUpdate"),[f,c]=j.makeAction("campaign");return ut=r,ct=o,ft=u,pt=f,a(i=>{t||y.update(p=>({...p,currentRound:i.round,combatActive:i.active}))}),c(i=>{ae.update(p=>({...p,lastGmUpdate:Date.now()})),t||y.update(p=>({...p,campaignName:i.name,gmName:i.gmName,passwordHash:i.passwordHash,system:i.system}))}),t&&kt&&(ie=setInterval(()=>{const i=dt.get(e);i&&i.isPublished&&kt({id:e,name:i.name,gmName:i.gmName||"Mestre",description:i.description})},3e4)),l(i=>{ee.addToHistory(i,!1)}),h(i=>{if(t){const p=dt.get(e);if(p){const A=p.members||[],k=A.findIndex(O=>O.id===i.id);let E;if(k!==-1){E=[...A];const O=E[k],I={...i};O.campaignApproval==="approved"&&i.campaignApproval==="pending"&&delete I.campaignApproval,E[k]={...O,...I,lastUpdate:Date.now()}}else E=[...A,{...i,lastUpdate:Date.now()}];const M=p.activeEnemies||[],F=M.findIndex(O=>O.id===i.id&&O.type==="player");let _=M;F!==-1&&(_=[...M],_[F]={..._[F],...i}),dt.set(e,{...p,members:E,activeEnemies:_})}}else{const p=C(ae),A=C(y),k=p.currentCharacterId||A?.id;if(k&&k===i.id){const E=i.system==="sofdl";if(i.campaignApproval==="rejected"||i.campaignId===null){E?Le.leaveCampaign():y.update(M=>({...M,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}));return}E?Le.set({name:i.name,afflictions:i.afflictions,senses:i.senses,initiative:i.initiative,acted:i.acted,campaignApproval:i.campaignApproval,imageUrl:i.imageUrl,notes:i.notes,damage:i.damage,health:i.health,healingRate:i.healingRate,insanity:i.insanity,corruption:i.corruption,defense:i.defense,speed:i.speed,power:i.power,attributes:i.attributes}):(y.update(M=>({...M,name:i.name||M.name,afflictions:i.afflictions||M.afflictions,senses:i.senses||M.senses,initiative:i.initiative!==void 0?i.initiative:M.initiative??!1,acted:i.acted!==void 0?i.acted:M.acted??!1,campaignApproval:i.campaignApproval||M.campaignApproval,imageUrl:i.imageUrl||M.imageUrl,notes:i.notes!==void 0?i.notes:M.notes})),i.damage!==void 0&&Ge.set(i.damage),i.currentHealth!==void 0&&Re.set(i.currentHealth),i.normalHealth!==void 0&&Ct.set(i.normalHealth))}}}),j.onPeerJoin(i=>{if(ae.update(p=>({...p,peers:[...p.peers,i]})),t){const p=dt.get(e);p&&(p.combat&&r(p.combat),f({name:p.name,gmName:p.gmName||"Mestre",passwordHash:p.passwordHash,system:p.system}))}}),j.onPeerLeave(i=>{ae.update(p=>({...p,peers:p.peers.filter(A=>A!==i)}))}),j}catch(r){return console.error("Failed to join campaign room:",r),j=null,Pe=null,ae.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0}),null}}function zr(e,t){ut&&ut(t)}function Wr(e,t){pt&&pt({name:t.name,gmName:t.gmName||"Mestre",passwordHash:t.passwordHash,system:t.system})}function Kr(e){ct&&ct(e)}function Xr(e){ft&&ft(e)}function Yr(){ie&&(clearInterval(ie),ie=null),ht(j,"campaign room"),j=null,Pe=null,ut=null,ct=null,ft=null,pt=null,ae.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0})}const jt=Object.freeze(Object.defineProperty({__proto__:null,isGmOnline:$r,joinCampaignRoom:Gr,joinLobby:Bt,leaveCampaignRoom:Yr,publicCampaigns:$t,roomConfig:zn,syncCampaign:Wr,syncCharacter:Xr,syncCombat:zr,syncRoll:Kr,syncState:ae},Symbol.toStringTag,{value:"Module"}));export{qe as A,De as B,Le as C,aa as D,fa as E,en as F,Dt as G,Se as H,ve as I,Vr as J,ze as K,w as L,oa as M,Ce as N,Ct as O,Re as P,Dr as Q,Ur as R,Ir as S,ia as T,Fr as U,pa as V,ua as W,la as X,Hr as Y,jn as Z,ca as _,qn as a,sa as b,y as c,Zt as d,ee as e,st as f,Xr as g,Wr as h,$r as i,Gr as j,$e as k,Yr as l,zr as m,ra as n,ae as o,It as p,$t as q,zn as r,_e as s,Jn as t,tt as u,Ge as v,Pr as w,Lr as x,Gn as y,Nr as z};
