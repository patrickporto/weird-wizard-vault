import{bj as Ic,as as Cc,u as Dc,p as Tc,h as Rc,aS as en,bk as Uc}from"./DzRT0qSm.js";import{q as Ut,w as Ht,g as te}from"./9QvhKPlK.js";import{_ as Ys}from"./FHgTlLI2.js";import{k as Ks}from"./DmTIwYKB.js";function xf(e,t,n=t){var r=new WeakSet;Ic(e,"input",async s=>{var i=s?e.defaultValue:e.value;if(i=Vr(e)?Pr(i):i,n(i),en!==null&&r.add(en),await Cc(),i!==(i=t())){var l=e.selectionStart,f=e.selectionEnd,h=e.value.length;if(e.value=i??"",f!==null){var g=e.value.length;l===f&&f===h&&g>h?(e.selectionStart=g,e.selectionEnd=g):(e.selectionStart=l,e.selectionEnd=Math.min(f,g))}}}),(Rc&&e.defaultValue!==e.value||Dc(t)==null&&e.value)&&(n(Vr(e)?Pr(e.value):e.value),en!==null&&r.add(en)),Tc(()=>{var s=t();if(e===document.activeElement){var i=Uc??en;if(r.has(i))return}Vr(e)&&s===Pr(e.value)||e.type==="date"&&!s&&!e.value||s!==e.value&&(e.value=s??"")})}function Vr(e){var t=e.type;return t==="number"||t==="range"}function Pr(e){return e===""?null:+e}function Bc(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Ni={exports:{}},Y=Ni.exports={},Lt,Mt;function rs(){throw new Error("setTimeout has not been defined")}function ss(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?Lt=setTimeout:Lt=rs}catch{Lt=rs}try{typeof clearTimeout=="function"?Mt=clearTimeout:Mt=ss}catch{Mt=ss}})();function $i(e){if(Lt===setTimeout)return setTimeout(e,0);if((Lt===rs||!Lt)&&setTimeout)return Lt=setTimeout,setTimeout(e,0);try{return Lt(e,0)}catch{try{return Lt.call(null,e,0)}catch{return Lt.call(this,e,0)}}}function vc(e){if(Mt===clearTimeout)return clearTimeout(e);if((Mt===ss||!Mt)&&clearTimeout)return Mt=clearTimeout,clearTimeout(e);try{return Mt(e)}catch{try{return Mt.call(null,e)}catch{return Mt.call(this,e)}}}var zt=[],Le=!1,fe,Xn=-1;function Lc(){!Le||!fe||(Le=!1,fe.length?zt=fe.concat(zt):Xn=-1,zt.length&&Vi())}function Vi(){if(!Le){var e=$i(Lc);Le=!0;for(var t=zt.length;t;){for(fe=zt,zt=[];++Xn<t;)fe&&fe[Xn].run();Xn=-1,t=zt.length}fe=null,Le=!1,vc(e)}}Y.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];zt.push(new Pi(e,t)),zt.length===1&&!Le&&$i(Vi)};function Pi(e,t){this.fun=e,this.array=t}Pi.prototype.run=function(){this.fun.apply(null,this.array)};Y.title="browser";Y.browser=!0;Y.env={};Y.argv=[];Y.version="";Y.versions={};function Yt(){}Y.on=Yt;Y.addListener=Yt;Y.once=Yt;Y.off=Yt;Y.removeListener=Yt;Y.removeAllListeners=Yt;Y.emit=Yt;Y.prependListener=Yt;Y.prependOnceListener=Yt;Y.listeners=function(e){return[]};Y.binding=function(e){throw new Error("process.binding is not supported")};Y.cwd=function(){return"/"};Y.chdir=function(e){throw new Error("process.chdir is not supported")};Y.umask=function(){return 0};var Mc=Ni.exports;const ue=Bc(Mc);var Oc={},Sr={};Sr.byteLength=$c;Sr.toByteArray=Pc;Sr.fromByteArray=qc;var Ft=[],St=[],Fc=typeof Uint8Array<"u"?Uint8Array:Array,jr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var De=0,Nc=jr.length;De<Nc;++De)Ft[De]=jr[De],St[jr.charCodeAt(De)]=De;St[45]=62;St[95]=63;function ji(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");n===-1&&(n=t);var r=n===t?0:4-n%4;return[n,r]}function $c(e){var t=ji(e),n=t[0],r=t[1];return(n+r)*3/4-r}function Vc(e,t,n){return(t+n)*3/4-n}function Pc(e){var t,n=ji(e),r=n[0],s=n[1],i=new Fc(Vc(e,r,s)),l=0,f=s>0?r-4:r,h;for(h=0;h<f;h+=4)t=St[e.charCodeAt(h)]<<18|St[e.charCodeAt(h+1)]<<12|St[e.charCodeAt(h+2)]<<6|St[e.charCodeAt(h+3)],i[l++]=t>>16&255,i[l++]=t>>8&255,i[l++]=t&255;return s===2&&(t=St[e.charCodeAt(h)]<<2|St[e.charCodeAt(h+1)]>>4,i[l++]=t&255),s===1&&(t=St[e.charCodeAt(h)]<<10|St[e.charCodeAt(h+1)]<<4|St[e.charCodeAt(h+2)]>>2,i[l++]=t>>8&255,i[l++]=t&255),i}function jc(e){return Ft[e>>18&63]+Ft[e>>12&63]+Ft[e>>6&63]+Ft[e&63]}function Hc(e,t,n){for(var r,s=[],i=t;i<n;i+=3)r=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(e[i+2]&255),s.push(jc(r));return s.join("")}function qc(e){for(var t,n=e.length,r=n%3,s=[],i=16383,l=0,f=n-r;l<f;l+=i)s.push(Hc(e,l,l+i>f?f:l+i));return r===1?(t=e[n-1],s.push(Ft[t>>2]+Ft[t<<4&63]+"==")):r===2&&(t=(e[n-2]<<8)+e[n-1],s.push(Ft[t>>10]+Ft[t>>4&63]+Ft[t<<2&63]+"=")),s.join("")}var bs={};bs.read=function(e,t,n,r,s){var i,l,f=s*8-r-1,h=(1<<f)-1,g=h>>1,u=-7,w=n?s-1:0,p=n?-1:1,y=e[t+w];for(w+=p,i=y&(1<<-u)-1,y>>=-u,u+=f;u>0;i=i*256+e[t+w],w+=p,u-=8);for(l=i&(1<<-u)-1,i>>=-u,u+=r;u>0;l=l*256+e[t+w],w+=p,u-=8);if(i===0)i=1-g;else{if(i===h)return l?NaN:(y?-1:1)*(1/0);l=l+Math.pow(2,r),i=i-g}return(y?-1:1)*l*Math.pow(2,i-r)};bs.write=function(e,t,n,r,s,i){var l,f,h,g=i*8-s-1,u=(1<<g)-1,w=u>>1,p=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,y=r?0:i-1,k=r?1:-1,_=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(f=isNaN(t)?1:0,l=u):(l=Math.floor(Math.log(t)/Math.LN2),t*(h=Math.pow(2,-l))<1&&(l--,h*=2),l+w>=1?t+=p/h:t+=p*Math.pow(2,1-w),t*h>=2&&(l++,h/=2),l+w>=u?(f=0,l=u):l+w>=1?(f=(t*h-1)*Math.pow(2,s),l=l+w):(f=t*Math.pow(2,w-1)*Math.pow(2,s),l=0));s>=8;e[n+y]=f&255,y+=k,f/=256,s-=8);for(l=l<<s|f,g+=s;g>0;e[n+y]=l&255,y+=k,l/=256,g-=8);e[n+y-k]|=_*128};(function(e){const t=Sr,n=bs,r=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;e.Buffer=u,e.SlowBuffer=q,e.INSPECT_MAX_BYTES=50;const s=2147483647;e.kMaxLength=s;const{Uint8Array:i,ArrayBuffer:l,SharedArrayBuffer:f}=globalThis;u.TYPED_ARRAY_SUPPORT=h(),!u.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function h(){try{const a=new i(1),o={foo:function(){return 42}};return Object.setPrototypeOf(o,i.prototype),Object.setPrototypeOf(a,o),a.foo()===42}catch{return!1}}Object.defineProperty(u.prototype,"parent",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.buffer}}),Object.defineProperty(u.prototype,"offset",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.byteOffset}});function g(a){if(a>s)throw new RangeError('The value "'+a+'" is invalid for option "size"');const o=new i(a);return Object.setPrototypeOf(o,u.prototype),o}function u(a,o,c){if(typeof a=="number"){if(typeof o=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return k(a)}return w(a,o,c)}u.poolSize=8192;function w(a,o,c){if(typeof a=="string")return _(a,o);if(l.isView(a))return at(a);if(a==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof a);if(Bt(a,l)||a&&Bt(a.buffer,l)||typeof f<"u"&&(Bt(a,f)||a&&Bt(a.buffer,f)))return X(a,o,c);if(typeof a=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const d=a.valueOf&&a.valueOf();if(d!=null&&d!==a)return u.from(d,o,c);const m=C(a);if(m)return m;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof a[Symbol.toPrimitive]=="function")return u.from(a[Symbol.toPrimitive]("string"),o,c);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof a)}u.from=function(a,o,c){return w(a,o,c)},Object.setPrototypeOf(u.prototype,i.prototype),Object.setPrototypeOf(u,i);function p(a){if(typeof a!="number")throw new TypeError('"size" argument must be of type number');if(a<0)throw new RangeError('The value "'+a+'" is invalid for option "size"')}function y(a,o,c){return p(a),a<=0?g(a):o!==void 0?typeof c=="string"?g(a).fill(o,c):g(a).fill(o):g(a)}u.alloc=function(a,o,c){return y(a,o,c)};function k(a){return p(a),g(a<0?0:I(a)|0)}u.allocUnsafe=function(a){return k(a)},u.allocUnsafeSlow=function(a){return k(a)};function _(a,o){if((typeof o!="string"||o==="")&&(o="utf8"),!u.isEncoding(o))throw new TypeError("Unknown encoding: "+o);const c=pt(a,o)|0;let d=g(c);const m=d.write(a,o);return m!==c&&(d=d.slice(0,m)),d}function R(a){const o=a.length<0?0:I(a.length)|0,c=g(o);for(let d=0;d<o;d+=1)c[d]=a[d]&255;return c}function at(a){if(Bt(a,i)){const o=new i(a);return X(o.buffer,o.byteOffset,o.byteLength)}return R(a)}function X(a,o,c){if(o<0||a.byteLength<o)throw new RangeError('"offset" is outside of buffer bounds');if(a.byteLength<o+(c||0))throw new RangeError('"length" is outside of buffer bounds');let d;return o===void 0&&c===void 0?d=new i(a):c===void 0?d=new i(a,o):d=new i(a,o,c),Object.setPrototypeOf(d,u.prototype),d}function C(a){if(u.isBuffer(a)){const o=I(a.length)|0,c=g(o);return c.length===0||a.copy(c,0,0,o),c}if(a.length!==void 0)return typeof a.length!="number"||$r(a.length)?g(0):R(a);if(a.type==="Buffer"&&Array.isArray(a.data))return R(a.data)}function I(a){if(a>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return a|0}function q(a){return+a!=a&&(a=0),u.alloc(+a)}u.isBuffer=function(o){return o!=null&&o._isBuffer===!0&&o!==u.prototype},u.compare=function(o,c){if(Bt(o,i)&&(o=u.from(o,o.offset,o.byteLength)),Bt(c,i)&&(c=u.from(c,c.offset,c.byteLength)),!u.isBuffer(o)||!u.isBuffer(c))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(o===c)return 0;let d=o.length,m=c.length;for(let b=0,E=Math.min(d,m);b<E;++b)if(o[b]!==c[b]){d=o[b],m=c[b];break}return d<m?-1:m<d?1:0},u.isEncoding=function(o){switch(String(o).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(o,c){if(!Array.isArray(o))throw new TypeError('"list" argument must be an Array of Buffers');if(o.length===0)return u.alloc(0);let d;if(c===void 0)for(c=0,d=0;d<o.length;++d)c+=o[d].length;const m=u.allocUnsafe(c);let b=0;for(d=0;d<o.length;++d){let E=o[d];if(Bt(E,i))b+E.length>m.length?(u.isBuffer(E)||(E=u.from(E)),E.copy(m,b)):i.prototype.set.call(m,E,b);else if(u.isBuffer(E))E.copy(m,b);else throw new TypeError('"list" argument must be an Array of Buffers');b+=E.length}return m};function pt(a,o){if(u.isBuffer(a))return a.length;if(l.isView(a)||Bt(a,l))return a.byteLength;if(typeof a!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof a);const c=a.length,d=arguments.length>2&&arguments[2]===!0;if(!d&&c===0)return 0;let m=!1;for(;;)switch(o){case"ascii":case"latin1":case"binary":return c;case"utf8":case"utf-8":return Nr(a).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return c*2;case"hex":return c>>>1;case"base64":return Ws(a).length;default:if(m)return d?-1:Nr(a).length;o=(""+o).toLowerCase(),m=!0}}u.byteLength=pt;function ce(a,o,c){let d=!1;if((o===void 0||o<0)&&(o=0),o>this.length||((c===void 0||c>this.length)&&(c=this.length),c<=0)||(c>>>=0,o>>>=0,c<=o))return"";for(a||(a="utf8");;)switch(a){case"hex":return Ct(this,o,c);case"utf8":case"utf-8":return x(this,o,c);case"ascii":return ut(this,o,c);case"latin1":case"binary":return nt(this,o,c);case"base64":return P(this,o,c);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return N(this,o,c);default:if(d)throw new TypeError("Unknown encoding: "+a);a=(a+"").toLowerCase(),d=!0}}u.prototype._isBuffer=!0;function gt(a,o,c){const d=a[o];a[o]=a[c],a[c]=d}u.prototype.swap16=function(){const o=this.length;if(o%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let c=0;c<o;c+=2)gt(this,c,c+1);return this},u.prototype.swap32=function(){const o=this.length;if(o%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let c=0;c<o;c+=4)gt(this,c,c+3),gt(this,c+1,c+2);return this},u.prototype.swap64=function(){const o=this.length;if(o%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let c=0;c<o;c+=8)gt(this,c,c+7),gt(this,c+1,c+6),gt(this,c+2,c+5),gt(this,c+3,c+4);return this},u.prototype.toString=function(){const o=this.length;return o===0?"":arguments.length===0?x(this,0,o):ce.apply(this,arguments)},u.prototype.toLocaleString=u.prototype.toString,u.prototype.equals=function(o){if(!u.isBuffer(o))throw new TypeError("Argument must be a Buffer");return this===o?!0:u.compare(this,o)===0},u.prototype.inspect=function(){let o="";const c=e.INSPECT_MAX_BYTES;return o=this.toString("hex",0,c).replace(/(.{2})/g,"$1 ").trim(),this.length>c&&(o+=" ... "),"<Buffer "+o+">"},r&&(u.prototype[r]=u.prototype.inspect),u.prototype.compare=function(o,c,d,m,b){if(Bt(o,i)&&(o=u.from(o,o.offset,o.byteLength)),!u.isBuffer(o))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof o);if(c===void 0&&(c=0),d===void 0&&(d=o?o.length:0),m===void 0&&(m=0),b===void 0&&(b=this.length),c<0||d>o.length||m<0||b>this.length)throw new RangeError("out of range index");if(m>=b&&c>=d)return 0;if(m>=b)return-1;if(c>=d)return 1;if(c>>>=0,d>>>=0,m>>>=0,b>>>=0,this===o)return 0;let E=b-m,v=d-c;const z=Math.min(E,v),H=this.slice(m,b),W=o.slice(c,d);for(let $=0;$<z;++$)if(H[$]!==W[$]){E=H[$],v=W[$];break}return E<v?-1:v<E?1:0};function xe(a,o,c,d,m){if(a.length===0)return-1;if(typeof c=="string"?(d=c,c=0):c>2147483647?c=2147483647:c<-2147483648&&(c=-2147483648),c=+c,$r(c)&&(c=m?0:a.length-1),c<0&&(c=a.length+c),c>=a.length){if(m)return-1;c=a.length-1}else if(c<0)if(m)c=0;else return-1;if(typeof o=="string"&&(o=u.from(o,d)),u.isBuffer(o))return o.length===0?-1:le(a,o,c,d,m);if(typeof o=="number")return o=o&255,typeof i.prototype.indexOf=="function"?m?i.prototype.indexOf.call(a,o,c):i.prototype.lastIndexOf.call(a,o,c):le(a,[o],c,d,m);throw new TypeError("val must be string, number or Buffer")}function le(a,o,c,d,m){let b=1,E=a.length,v=o.length;if(d!==void 0&&(d=String(d).toLowerCase(),d==="ucs2"||d==="ucs-2"||d==="utf16le"||d==="utf-16le")){if(a.length<2||o.length<2)return-1;b=2,E/=2,v/=2,c/=2}function z(W,$){return b===1?W[$]:W.readUInt16BE($*b)}let H;if(m){let W=-1;for(H=c;H<E;H++)if(z(a,H)===z(o,W===-1?0:H-W)){if(W===-1&&(W=H),H-W+1===v)return W*b}else W!==-1&&(H-=H-W),W=-1}else for(c+v>E&&(c=E-v),H=c;H>=0;H--){let W=!0;for(let $=0;$<v;$++)if(z(a,H+$)!==z(o,$)){W=!1;break}if(W)return H}return-1}u.prototype.includes=function(o,c,d){return this.indexOf(o,c,d)!==-1},u.prototype.indexOf=function(o,c,d){return xe(this,o,c,d,!0)},u.prototype.lastIndexOf=function(o,c,d){return xe(this,o,c,d,!1)};function Ie(a,o,c,d){c=Number(c)||0;const m=a.length-c;d?(d=Number(d),d>m&&(d=m)):d=m;const b=o.length;d>b/2&&(d=b/2);let E;for(E=0;E<d;++E){const v=parseInt(o.substr(E*2,2),16);if($r(v))return E;a[c+E]=v}return E}function S(a,o,c,d){return Pn(Nr(o,a.length-c),a,c,d)}function A(a,o,c,d){return Pn(Sc(o),a,c,d)}function U(a,o,c,d){return Pn(Ws(o),a,c,d)}function M(a,o,c,d){return Pn(_c(o,a.length-c),a,c,d)}u.prototype.write=function(o,c,d,m){if(c===void 0)m="utf8",d=this.length,c=0;else if(d===void 0&&typeof c=="string")m=c,d=this.length,c=0;else if(isFinite(c))c=c>>>0,isFinite(d)?(d=d>>>0,m===void 0&&(m="utf8")):(m=d,d=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const b=this.length-c;if((d===void 0||d>b)&&(d=b),o.length>0&&(d<0||c<0)||c>this.length)throw new RangeError("Attempt to write outside buffer bounds");m||(m="utf8");let E=!1;for(;;)switch(m){case"hex":return Ie(this,o,c,d);case"utf8":case"utf-8":return S(this,o,c,d);case"ascii":case"latin1":case"binary":return A(this,o,c,d);case"base64":return U(this,o,c,d);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return M(this,o,c,d);default:if(E)throw new TypeError("Unknown encoding: "+m);m=(""+m).toLowerCase(),E=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function P(a,o,c){return o===0&&c===a.length?t.fromByteArray(a):t.fromByteArray(a.slice(o,c))}function x(a,o,c){c=Math.min(a.length,c);const d=[];let m=o;for(;m<c;){const b=a[m];let E=null,v=b>239?4:b>223?3:b>191?2:1;if(m+v<=c){let z,H,W,$;switch(v){case 1:b<128&&(E=b);break;case 2:z=a[m+1],(z&192)===128&&($=(b&31)<<6|z&63,$>127&&(E=$));break;case 3:z=a[m+1],H=a[m+2],(z&192)===128&&(H&192)===128&&($=(b&15)<<12|(z&63)<<6|H&63,$>2047&&($<55296||$>57343)&&(E=$));break;case 4:z=a[m+1],H=a[m+2],W=a[m+3],(z&192)===128&&(H&192)===128&&(W&192)===128&&($=(b&15)<<18|(z&63)<<12|(H&63)<<6|W&63,$>65535&&$<1114112&&(E=$))}}E===null?(E=65533,v=1):E>65535&&(E-=65536,d.push(E>>>10&1023|55296),E=56320|E&1023),d.push(E),m+=v}return G(d)}const D=4096;function G(a){const o=a.length;if(o<=D)return String.fromCharCode.apply(String,a);let c="",d=0;for(;d<o;)c+=String.fromCharCode.apply(String,a.slice(d,d+=D));return c}function ut(a,o,c){let d="";c=Math.min(a.length,c);for(let m=o;m<c;++m)d+=String.fromCharCode(a[m]&127);return d}function nt(a,o,c){let d="";c=Math.min(a.length,c);for(let m=o;m<c;++m)d+=String.fromCharCode(a[m]);return d}function Ct(a,o,c){const d=a.length;(!o||o<0)&&(o=0),(!c||c<0||c>d)&&(c=d);let m="";for(let b=o;b<c;++b)m+=Ac[a[b]];return m}function N(a,o,c){const d=a.slice(o,c);let m="";for(let b=0;b<d.length-1;b+=2)m+=String.fromCharCode(d[b]+d[b+1]*256);return m}u.prototype.slice=function(o,c){const d=this.length;o=~~o,c=c===void 0?d:~~c,o<0?(o+=d,o<0&&(o=0)):o>d&&(o=d),c<0?(c+=d,c<0&&(c=0)):c>d&&(c=d),c<o&&(c=o);const m=this.subarray(o,c);return Object.setPrototypeOf(m,u.prototype),m};function O(a,o,c){if(a%1!==0||a<0)throw new RangeError("offset is not uint");if(a+o>c)throw new RangeError("Trying to access beyond buffer length")}u.prototype.readUintLE=u.prototype.readUIntLE=function(o,c,d){o=o>>>0,c=c>>>0,d||O(o,c,this.length);let m=this[o],b=1,E=0;for(;++E<c&&(b*=256);)m+=this[o+E]*b;return m},u.prototype.readUintBE=u.prototype.readUIntBE=function(o,c,d){o=o>>>0,c=c>>>0,d||O(o,c,this.length);let m=this[o+--c],b=1;for(;c>0&&(b*=256);)m+=this[o+--c]*b;return m},u.prototype.readUint8=u.prototype.readUInt8=function(o,c){return o=o>>>0,c||O(o,1,this.length),this[o]},u.prototype.readUint16LE=u.prototype.readUInt16LE=function(o,c){return o=o>>>0,c||O(o,2,this.length),this[o]|this[o+1]<<8},u.prototype.readUint16BE=u.prototype.readUInt16BE=function(o,c){return o=o>>>0,c||O(o,2,this.length),this[o]<<8|this[o+1]},u.prototype.readUint32LE=u.prototype.readUInt32LE=function(o,c){return o=o>>>0,c||O(o,4,this.length),(this[o]|this[o+1]<<8|this[o+2]<<16)+this[o+3]*16777216},u.prototype.readUint32BE=u.prototype.readUInt32BE=function(o,c){return o=o>>>0,c||O(o,4,this.length),this[o]*16777216+(this[o+1]<<16|this[o+2]<<8|this[o+3])},u.prototype.readBigUInt64LE=Qt(function(o){o=o>>>0,Ce(o,"offset");const c=this[o],d=this[o+7];(c===void 0||d===void 0)&&tn(o,this.length-8);const m=c+this[++o]*2**8+this[++o]*2**16+this[++o]*2**24,b=this[++o]+this[++o]*2**8+this[++o]*2**16+d*2**24;return BigInt(m)+(BigInt(b)<<BigInt(32))}),u.prototype.readBigUInt64BE=Qt(function(o){o=o>>>0,Ce(o,"offset");const c=this[o],d=this[o+7];(c===void 0||d===void 0)&&tn(o,this.length-8);const m=c*2**24+this[++o]*2**16+this[++o]*2**8+this[++o],b=this[++o]*2**24+this[++o]*2**16+this[++o]*2**8+d;return(BigInt(m)<<BigInt(32))+BigInt(b)}),u.prototype.readIntLE=function(o,c,d){o=o>>>0,c=c>>>0,d||O(o,c,this.length);let m=this[o],b=1,E=0;for(;++E<c&&(b*=256);)m+=this[o+E]*b;return b*=128,m>=b&&(m-=Math.pow(2,8*c)),m},u.prototype.readIntBE=function(o,c,d){o=o>>>0,c=c>>>0,d||O(o,c,this.length);let m=c,b=1,E=this[o+--m];for(;m>0&&(b*=256);)E+=this[o+--m]*b;return b*=128,E>=b&&(E-=Math.pow(2,8*c)),E},u.prototype.readInt8=function(o,c){return o=o>>>0,c||O(o,1,this.length),this[o]&128?(255-this[o]+1)*-1:this[o]},u.prototype.readInt16LE=function(o,c){o=o>>>0,c||O(o,2,this.length);const d=this[o]|this[o+1]<<8;return d&32768?d|4294901760:d},u.prototype.readInt16BE=function(o,c){o=o>>>0,c||O(o,2,this.length);const d=this[o+1]|this[o]<<8;return d&32768?d|4294901760:d},u.prototype.readInt32LE=function(o,c){return o=o>>>0,c||O(o,4,this.length),this[o]|this[o+1]<<8|this[o+2]<<16|this[o+3]<<24},u.prototype.readInt32BE=function(o,c){return o=o>>>0,c||O(o,4,this.length),this[o]<<24|this[o+1]<<16|this[o+2]<<8|this[o+3]},u.prototype.readBigInt64LE=Qt(function(o){o=o>>>0,Ce(o,"offset");const c=this[o],d=this[o+7];(c===void 0||d===void 0)&&tn(o,this.length-8);const m=this[o+4]+this[o+5]*2**8+this[o+6]*2**16+(d<<24);return(BigInt(m)<<BigInt(32))+BigInt(c+this[++o]*2**8+this[++o]*2**16+this[++o]*2**24)}),u.prototype.readBigInt64BE=Qt(function(o){o=o>>>0,Ce(o,"offset");const c=this[o],d=this[o+7];(c===void 0||d===void 0)&&tn(o,this.length-8);const m=(c<<24)+this[++o]*2**16+this[++o]*2**8+this[++o];return(BigInt(m)<<BigInt(32))+BigInt(this[++o]*2**24+this[++o]*2**16+this[++o]*2**8+d)}),u.prototype.readFloatLE=function(o,c){return o=o>>>0,c||O(o,4,this.length),n.read(this,o,!0,23,4)},u.prototype.readFloatBE=function(o,c){return o=o>>>0,c||O(o,4,this.length),n.read(this,o,!1,23,4)},u.prototype.readDoubleLE=function(o,c){return o=o>>>0,c||O(o,8,this.length),n.read(this,o,!0,52,8)},u.prototype.readDoubleBE=function(o,c){return o=o>>>0,c||O(o,8,this.length),n.read(this,o,!1,52,8)};function j(a,o,c,d,m,b){if(!u.isBuffer(a))throw new TypeError('"buffer" argument must be a Buffer instance');if(o>m||o<b)throw new RangeError('"value" argument is out of bounds');if(c+d>a.length)throw new RangeError("Index out of range")}u.prototype.writeUintLE=u.prototype.writeUIntLE=function(o,c,d,m){if(o=+o,c=c>>>0,d=d>>>0,!m){const v=Math.pow(2,8*d)-1;j(this,o,c,d,v,0)}let b=1,E=0;for(this[c]=o&255;++E<d&&(b*=256);)this[c+E]=o/b&255;return c+d},u.prototype.writeUintBE=u.prototype.writeUIntBE=function(o,c,d,m){if(o=+o,c=c>>>0,d=d>>>0,!m){const v=Math.pow(2,8*d)-1;j(this,o,c,d,v,0)}let b=d-1,E=1;for(this[c+b]=o&255;--b>=0&&(E*=256);)this[c+b]=o/E&255;return c+d},u.prototype.writeUint8=u.prototype.writeUInt8=function(o,c,d){return o=+o,c=c>>>0,d||j(this,o,c,1,255,0),this[c]=o&255,c+1},u.prototype.writeUint16LE=u.prototype.writeUInt16LE=function(o,c,d){return o=+o,c=c>>>0,d||j(this,o,c,2,65535,0),this[c]=o&255,this[c+1]=o>>>8,c+2},u.prototype.writeUint16BE=u.prototype.writeUInt16BE=function(o,c,d){return o=+o,c=c>>>0,d||j(this,o,c,2,65535,0),this[c]=o>>>8,this[c+1]=o&255,c+2},u.prototype.writeUint32LE=u.prototype.writeUInt32LE=function(o,c,d){return o=+o,c=c>>>0,d||j(this,o,c,4,4294967295,0),this[c+3]=o>>>24,this[c+2]=o>>>16,this[c+1]=o>>>8,this[c]=o&255,c+4},u.prototype.writeUint32BE=u.prototype.writeUInt32BE=function(o,c,d){return o=+o,c=c>>>0,d||j(this,o,c,4,4294967295,0),this[c]=o>>>24,this[c+1]=o>>>16,this[c+2]=o>>>8,this[c+3]=o&255,c+4};function J(a,o,c,d,m){zs(o,d,m,a,c,7);let b=Number(o&BigInt(4294967295));a[c++]=b,b=b>>8,a[c++]=b,b=b>>8,a[c++]=b,b=b>>8,a[c++]=b;let E=Number(o>>BigInt(32)&BigInt(4294967295));return a[c++]=E,E=E>>8,a[c++]=E,E=E>>8,a[c++]=E,E=E>>8,a[c++]=E,c}function Z(a,o,c,d,m){zs(o,d,m,a,c,7);let b=Number(o&BigInt(4294967295));a[c+7]=b,b=b>>8,a[c+6]=b,b=b>>8,a[c+5]=b,b=b>>8,a[c+4]=b;let E=Number(o>>BigInt(32)&BigInt(4294967295));return a[c+3]=E,E=E>>8,a[c+2]=E,E=E>>8,a[c+1]=E,E=E>>8,a[c]=E,c+8}u.prototype.writeBigUInt64LE=Qt(function(o,c=0){return J(this,o,c,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeBigUInt64BE=Qt(function(o,c=0){return Z(this,o,c,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeIntLE=function(o,c,d,m){if(o=+o,c=c>>>0,!m){const z=Math.pow(2,8*d-1);j(this,o,c,d,z-1,-z)}let b=0,E=1,v=0;for(this[c]=o&255;++b<d&&(E*=256);)o<0&&v===0&&this[c+b-1]!==0&&(v=1),this[c+b]=(o/E>>0)-v&255;return c+d},u.prototype.writeIntBE=function(o,c,d,m){if(o=+o,c=c>>>0,!m){const z=Math.pow(2,8*d-1);j(this,o,c,d,z-1,-z)}let b=d-1,E=1,v=0;for(this[c+b]=o&255;--b>=0&&(E*=256);)o<0&&v===0&&this[c+b+1]!==0&&(v=1),this[c+b]=(o/E>>0)-v&255;return c+d},u.prototype.writeInt8=function(o,c,d){return o=+o,c=c>>>0,d||j(this,o,c,1,127,-128),o<0&&(o=255+o+1),this[c]=o&255,c+1},u.prototype.writeInt16LE=function(o,c,d){return o=+o,c=c>>>0,d||j(this,o,c,2,32767,-32768),this[c]=o&255,this[c+1]=o>>>8,c+2},u.prototype.writeInt16BE=function(o,c,d){return o=+o,c=c>>>0,d||j(this,o,c,2,32767,-32768),this[c]=o>>>8,this[c+1]=o&255,c+2},u.prototype.writeInt32LE=function(o,c,d){return o=+o,c=c>>>0,d||j(this,o,c,4,2147483647,-2147483648),this[c]=o&255,this[c+1]=o>>>8,this[c+2]=o>>>16,this[c+3]=o>>>24,c+4},u.prototype.writeInt32BE=function(o,c,d){return o=+o,c=c>>>0,d||j(this,o,c,4,2147483647,-2147483648),o<0&&(o=4294967295+o+1),this[c]=o>>>24,this[c+1]=o>>>16,this[c+2]=o>>>8,this[c+3]=o&255,c+4},u.prototype.writeBigInt64LE=Qt(function(o,c=0){return J(this,o,c,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),u.prototype.writeBigInt64BE=Qt(function(o,c=0){return Z(this,o,c,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function Q(a,o,c,d,m,b){if(c+d>a.length)throw new RangeError("Index out of range");if(c<0)throw new RangeError("Index out of range")}function rt(a,o,c,d,m){return o=+o,c=c>>>0,m||Q(a,o,c,4),n.write(a,o,c,d,23,4),c+4}u.prototype.writeFloatLE=function(o,c,d){return rt(this,o,c,!0,d)},u.prototype.writeFloatBE=function(o,c,d){return rt(this,o,c,!1,d)};function kt(a,o,c,d,m){return o=+o,c=c>>>0,m||Q(a,o,c,8),n.write(a,o,c,d,52,8),c+8}u.prototype.writeDoubleLE=function(o,c,d){return kt(this,o,c,!0,d)},u.prototype.writeDoubleBE=function(o,c,d){return kt(this,o,c,!1,d)},u.prototype.copy=function(o,c,d,m){if(!u.isBuffer(o))throw new TypeError("argument should be a Buffer");if(d||(d=0),!m&&m!==0&&(m=this.length),c>=o.length&&(c=o.length),c||(c=0),m>0&&m<d&&(m=d),m===d||o.length===0||this.length===0)return 0;if(c<0)throw new RangeError("targetStart out of bounds");if(d<0||d>=this.length)throw new RangeError("Index out of range");if(m<0)throw new RangeError("sourceEnd out of bounds");m>this.length&&(m=this.length),o.length-c<m-d&&(m=o.length-c+d);const b=m-d;return this===o&&typeof i.prototype.copyWithin=="function"?this.copyWithin(c,d,m):i.prototype.set.call(o,this.subarray(d,m),c),b},u.prototype.fill=function(o,c,d,m){if(typeof o=="string"){if(typeof c=="string"?(m=c,c=0,d=this.length):typeof d=="string"&&(m=d,d=this.length),m!==void 0&&typeof m!="string")throw new TypeError("encoding must be a string");if(typeof m=="string"&&!u.isEncoding(m))throw new TypeError("Unknown encoding: "+m);if(o.length===1){const E=o.charCodeAt(0);(m==="utf8"&&E<128||m==="latin1")&&(o=E)}}else typeof o=="number"?o=o&255:typeof o=="boolean"&&(o=Number(o));if(c<0||this.length<c||this.length<d)throw new RangeError("Out of range index");if(d<=c)return this;c=c>>>0,d=d===void 0?this.length:d>>>0,o||(o=0);let b;if(typeof o=="number")for(b=c;b<d;++b)this[b]=o;else{const E=u.isBuffer(o)?o:u.from(o,m),v=E.length;if(v===0)throw new TypeError('The value "'+o+'" is invalid for argument "value"');for(b=0;b<d-c;++b)this[b+c]=E[b%v]}return this};const ht={};function wt(a,o,c){ht[a]=class extends c{constructor(){super(),Object.defineProperty(this,"message",{value:o.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${a}]`,this.stack,delete this.name}get code(){return a}set code(m){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:m,writable:!0})}toString(){return`${this.name} [${a}]: ${this.message}`}}}wt("ERR_BUFFER_OUT_OF_BOUNDS",function(a){return a?`${a} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),wt("ERR_INVALID_ARG_TYPE",function(a,o){return`The "${a}" argument must be of type number. Received type ${typeof o}`},TypeError),wt("ERR_OUT_OF_RANGE",function(a,o,c){let d=`The value of "${a}" is out of range.`,m=c;return Number.isInteger(c)&&Math.abs(c)>2**32?m=$n(String(c)):typeof c=="bigint"&&(m=String(c),(c>BigInt(2)**BigInt(32)||c<-(BigInt(2)**BigInt(32)))&&(m=$n(m)),m+="n"),d+=` It must be ${o}. Received ${m}`,d},RangeError);function $n(a){let o="",c=a.length;const d=a[0]==="-"?1:0;for(;c>=d+4;c-=3)o=`_${a.slice(c-3,c)}${o}`;return`${a.slice(0,c)}${o}`}function Vn(a,o,c){Ce(o,"offset"),(a[o]===void 0||a[o+c]===void 0)&&tn(o,a.length-(c+1))}function zs(a,o,c,d,m,b){if(a>c||a<o){const E=typeof o=="bigint"?"n":"";let v;throw o===0||o===BigInt(0)?v=`>= 0${E} and < 2${E} ** ${(b+1)*8}${E}`:v=`>= -(2${E} ** ${(b+1)*8-1}${E}) and < 2 ** ${(b+1)*8-1}${E}`,new ht.ERR_OUT_OF_RANGE("value",v,a)}Vn(d,m,b)}function Ce(a,o){if(typeof a!="number")throw new ht.ERR_INVALID_ARG_TYPE(o,"number",a)}function tn(a,o,c){throw Math.floor(a)!==a?(Ce(a,c),new ht.ERR_OUT_OF_RANGE("offset","an integer",a)):o<0?new ht.ERR_BUFFER_OUT_OF_BOUNDS:new ht.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${o}`,a)}const Ec=/[^+/0-9A-Za-z-_]/g;function kc(a){if(a=a.split("=")[0],a=a.trim().replace(Ec,""),a.length<2)return"";for(;a.length%4!==0;)a=a+"=";return a}function Nr(a,o){o=o||1/0;let c;const d=a.length;let m=null;const b=[];for(let E=0;E<d;++E){if(c=a.charCodeAt(E),c>55295&&c<57344){if(!m){if(c>56319){(o-=3)>-1&&b.push(239,191,189);continue}else if(E+1===d){(o-=3)>-1&&b.push(239,191,189);continue}m=c;continue}if(c<56320){(o-=3)>-1&&b.push(239,191,189),m=c;continue}c=(m-55296<<10|c-56320)+65536}else m&&(o-=3)>-1&&b.push(239,191,189);if(m=null,c<128){if((o-=1)<0)break;b.push(c)}else if(c<2048){if((o-=2)<0)break;b.push(c>>6|192,c&63|128)}else if(c<65536){if((o-=3)<0)break;b.push(c>>12|224,c>>6&63|128,c&63|128)}else if(c<1114112){if((o-=4)<0)break;b.push(c>>18|240,c>>12&63|128,c>>6&63|128,c&63|128)}else throw new Error("Invalid code point")}return b}function Sc(a){const o=[];for(let c=0;c<a.length;++c)o.push(a.charCodeAt(c)&255);return o}function _c(a,o){let c,d,m;const b=[];for(let E=0;E<a.length&&!((o-=2)<0);++E)c=a.charCodeAt(E),d=c>>8,m=c%256,b.push(m),b.push(d);return b}function Ws(a){return t.toByteArray(kc(a))}function Pn(a,o,c,d){let m;for(m=0;m<d&&!(m+c>=o.length||m>=a.length);++m)o[m+c]=a[m];return m}function Bt(a,o){return a instanceof o||a!=null&&a.constructor!=null&&a.constructor.name!=null&&a.constructor.name===o.name}function $r(a){return a!==a}const Ac=(function(){const a="0123456789abcdef",o=new Array(256);for(let c=0;c<16;++c){const d=c*16;for(let m=0;m<16;++m)o[d+m]=a[c]+a[m]}return o})();function Qt(a){return typeof BigInt>"u"?xc:a}function xc(){throw new Error("BigInt not supported")}})(Oc);const mt=()=>new Map,is=e=>{const t=mt();return e.forEach((n,r)=>{t.set(r,n)}),t},Kt=(e,t,n)=>{let r=e.get(t);return r===void 0&&e.set(t,r=n()),r},Gc=(e,t)=>{const n=[];for(const[r,s]of e)n.push(t(s,r));return n},Jc=(e,t)=>{for(const[n,r]of e)if(t(r,n))return!0;return!1},we=()=>new Set,Hr=e=>e[e.length-1],zc=(e,t)=>{for(let n=0;n<t.length;n++)e.push(t[n])},se=Array.from,Es=(e,t)=>{for(let n=0;n<e.length;n++)if(!t(e[n],n,e))return!1;return!0},Hi=(e,t)=>{for(let n=0;n<e.length;n++)if(t(e[n],n,e))return!0;return!1},Wc=(e,t)=>{const n=new Array(e);for(let r=0;r<e;r++)n[r]=t(r,n);return n},_r=Array.isArray;class Yc{constructor(){this._observers=mt()}on(t,n){return Kt(this._observers,t,we).add(n),n}once(t,n){const r=(...s)=>{this.off(t,r),n(...s)};this.on(t,r)}off(t,n){const r=this._observers.get(t);r!==void 0&&(r.delete(n),r.size===0&&this._observers.delete(t))}emit(t,n){return se((this._observers.get(t)||mt()).values()).forEach(r=>r(...n))}destroy(){this._observers=mt()}}class Kc{constructor(){this._observers=mt()}on(t,n){Kt(this._observers,t,we).add(n)}once(t,n){const r=(...s)=>{this.off(t,r),n(...s)};this.on(t,r)}off(t,n){const r=this._observers.get(t);r!==void 0&&(r.delete(n),r.size===0&&this._observers.delete(t))}emit(t,n){return se((this._observers.get(t)||mt()).values()).forEach(r=>r(...n))}destroy(){this._observers=mt()}}const Vt=Math.floor,Zn=Math.abs,qi=(e,t)=>e<t?e:t,Se=(e,t)=>e>t?e:t,Gi=e=>e!==0?e<0:1/e<0,Xs=1,Zs=2,qr=4,Gr=8,dn=32,Wt=64,Et=128,Ar=31,os=63,ge=127,Xc=2147483647,lr=Number.MAX_SAFE_INTEGER,Qs=Number.MIN_SAFE_INTEGER,Zc=Number.isInteger||(e=>typeof e=="number"&&isFinite(e)&&Vt(e)===e),Qc=String.fromCharCode,tl=e=>e.toLowerCase(),el=/^\s*/g,nl=e=>e.replace(el,""),rl=/([A-Z])/g,ti=(e,t)=>nl(e.replace(rl,n=>`${t}${tl(n)}`)),sl=e=>{const t=unescape(encodeURIComponent(e)),n=t.length,r=new Uint8Array(n);for(let s=0;s<n;s++)r[s]=t.codePointAt(s);return r},pn=typeof TextEncoder<"u"?new TextEncoder:null,il=e=>pn.encode(e),ol=pn?il:sl;let hn=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});hn&&hn.decode(new Uint8Array).length===1&&(hn=null);const cl=(e,t)=>Wc(t,()=>e).join("");class Bn{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const xr=()=>new Bn,ll=e=>{let t=e.cpos;for(let n=0;n<e.bufs.length;n++)t+=e.bufs[n].length;return t},Nt=e=>{const t=new Uint8Array(ll(e));let n=0;for(let r=0;r<e.bufs.length;r++){const s=e.bufs[r];t.set(s,n),n+=s.length}return t.set(new Uint8Array(e.cbuf.buffer,0,e.cpos),n),t},al=(e,t)=>{const n=e.cbuf.length;n-e.cpos<t&&(e.bufs.push(new Uint8Array(e.cbuf.buffer,0,e.cpos)),e.cbuf=new Uint8Array(Se(n,t)*2),e.cpos=0)},it=(e,t)=>{const n=e.cbuf.length;e.cpos===n&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(n*2),e.cpos=0),e.cbuf[e.cpos++]=t},cs=it,F=(e,t)=>{for(;t>ge;)it(e,Et|ge&t),t=Vt(t/128);it(e,ge&t)},ks=(e,t)=>{const n=Gi(t);for(n&&(t=-t),it(e,(t>os?Et:0)|(n?Wt:0)|os&t),t=Vt(t/64);t>0;)it(e,(t>ge?Et:0)|ge&t),t=Vt(t/128)},ls=new Uint8Array(3e4),ul=ls.length/3,hl=(e,t)=>{if(t.length<ul){const n=pn.encodeInto(t,ls).written||0;F(e,n);for(let r=0;r<n;r++)it(e,ls[r])}else yt(e,ol(t))},fl=(e,t)=>{const n=unescape(encodeURIComponent(t)),r=n.length;F(e,r);for(let s=0;s<r;s++)it(e,n.codePointAt(s))},Me=pn&&pn.encodeInto?hl:fl,Ir=(e,t)=>{const n=e.cbuf.length,r=e.cpos,s=qi(n-r,t.length),i=t.length-s;e.cbuf.set(t.subarray(0,s),r),e.cpos+=s,i>0&&(e.bufs.push(e.cbuf),e.cbuf=new Uint8Array(Se(n*2,i)),e.cbuf.set(t.subarray(s)),e.cpos=i)},yt=(e,t)=>{F(e,t.byteLength),Ir(e,t)},Ss=(e,t)=>{al(e,t);const n=new DataView(e.cbuf.buffer,e.cpos,t);return e.cpos+=t,n},dl=(e,t)=>Ss(e,4).setFloat32(0,t,!1),pl=(e,t)=>Ss(e,8).setFloat64(0,t,!1),gl=(e,t)=>Ss(e,8).setBigInt64(0,t,!1),ei=new DataView(new ArrayBuffer(4)),ml=e=>(ei.setFloat32(0,e),ei.getFloat32(0)===e),gn=(e,t)=>{switch(typeof t){case"string":it(e,119),Me(e,t);break;case"number":Zc(t)&&Zn(t)<=Xc?(it(e,125),ks(e,t)):ml(t)?(it(e,124),dl(e,t)):(it(e,123),pl(e,t));break;case"bigint":it(e,122),gl(e,t);break;case"object":if(t===null)it(e,126);else if(_r(t)){it(e,117),F(e,t.length);for(let n=0;n<t.length;n++)gn(e,t[n])}else if(t instanceof Uint8Array)it(e,116),yt(e,t);else{it(e,118);const n=Object.keys(t);F(e,n.length);for(let r=0;r<n.length;r++){const s=n[r];Me(e,s),gn(e,t[s])}}break;case"boolean":it(e,t?120:121);break;default:it(e,127)}};class ni extends Bn{constructor(t){super(),this.w=t,this.s=null,this.count=0}write(t){this.s===t?this.count++:(this.count>0&&F(this,this.count-1),this.count=1,this.w(this,t),this.s=t)}}const ri=e=>{e.count>0&&(ks(e.encoder,e.count===1?e.s:-e.s),e.count>1&&F(e.encoder,e.count-2))};class Qn{constructor(){this.encoder=new Bn,this.s=0,this.count=0}write(t){this.s===t?this.count++:(ri(this),this.count=1,this.s=t)}toUint8Array(){return ri(this),Nt(this.encoder)}}const si=e=>{if(e.count>0){const t=e.diff*2+(e.count===1?0:1);ks(e.encoder,t),e.count>1&&F(e.encoder,e.count-2)}};class Jr{constructor(){this.encoder=new Bn,this.s=0,this.count=0,this.diff=0}write(t){this.diff===t-this.s?(this.s=t,this.count++):(si(this),this.count=1,this.diff=t-this.s,this.s=t)}toUint8Array(){return si(this),Nt(this.encoder)}}class wl{constructor(){this.sarr=[],this.s="",this.lensE=new Qn}write(t){this.s+=t,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(t.length)}toUint8Array(){const t=new Bn;return this.sarr.push(this.s),this.s="",Me(t,this.sarr.join("")),Ir(t,this.lensE.toUint8Array()),Nt(t)}}const Rt=e=>new Error(e),Tt=()=>{throw Rt("Method unimplemented")},It=()=>{throw Rt("Unexpected case")},Ji=Rt("Unexpected end of array"),zi=Rt("Integer out of Range");class Cr{constructor(t){this.arr=t,this.pos=0}}const We=e=>new Cr(e),yl=e=>e.pos!==e.arr.length,bl=(e,t)=>{const n=new Uint8Array(e.arr.buffer,e.pos+e.arr.byteOffset,t);return e.pos+=t,n},bt=e=>bl(e,B(e)),Pe=e=>e.arr[e.pos++],B=e=>{let t=0,n=1;const r=e.arr.length;for(;e.pos<r;){const s=e.arr[e.pos++];if(t=t+(s&ge)*n,n*=128,s<Et)return t;if(t>lr)throw zi}throw Ji},_s=e=>{let t=e.arr[e.pos++],n=t&os,r=64;const s=(t&Wt)>0?-1:1;if((t&Et)===0)return s*n;const i=e.arr.length;for(;e.pos<i;){if(t=e.arr[e.pos++],n=n+(t&ge)*r,r*=128,t<Et)return s*n;if(n>lr)throw zi}throw Ji},El=e=>{let t=B(e);if(t===0)return"";{let n=String.fromCodePoint(Pe(e));if(--t<100)for(;t--;)n+=String.fromCodePoint(Pe(e));else for(;t>0;){const r=t<1e4?t:1e4,s=e.arr.subarray(e.pos,e.pos+r);e.pos+=r,n+=String.fromCodePoint.apply(null,s),t-=r}return decodeURIComponent(escape(n))}},kl=e=>hn.decode(bt(e)),Oe=hn?kl:El,As=(e,t)=>{const n=new DataView(e.arr.buffer,e.arr.byteOffset+e.pos,t);return e.pos+=t,n},Sl=e=>As(e,4).getFloat32(0,!1),_l=e=>As(e,8).getFloat64(0,!1),Al=e=>As(e,8).getBigInt64(0,!1),xl=[e=>{},e=>null,_s,Sl,_l,Al,e=>!1,e=>!0,Oe,e=>{const t=B(e),n={};for(let r=0;r<t;r++){const s=Oe(e);n[s]=mn(e)}return n},e=>{const t=B(e),n=[];for(let r=0;r<t;r++)n.push(mn(e));return n},bt],mn=e=>xl[127-Pe(e)](e);class ii extends Cr{constructor(t,n){super(t),this.reader=n,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),yl(this)?this.count=B(this)+1:this.count=-1),this.count--,this.s}}class tr extends Cr{constructor(t){super(t),this.s=0,this.count=0}read(){if(this.count===0){this.s=_s(this);const t=Gi(this.s);this.count=1,t&&(this.s=-this.s,this.count=B(this)+2)}return this.count--,this.s}}class zr extends Cr{constructor(t){super(t),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const t=_s(this),n=t&1;this.diff=Vt(t/2),this.count=1,n&&(this.count=B(this)+2)}return this.s+=this.diff,this.count--,this.s}}class Il{constructor(t){this.decoder=new tr(t),this.str=Oe(this.decoder),this.spos=0}read(){const t=this.spos+this.decoder.read(),n=this.str.slice(this.spos,t);return this.spos=t,n}}const Cl=crypto.getRandomValues.bind(crypto),Wi=()=>Cl(new Uint32Array(1))[0],Dl="10000000-1000-4000-8000"+-1e11,Tl=()=>Dl.replace(/[018]/g,e=>(e^Wi()&15>>e/4).toString(16)),je=e=>new Promise(e);Promise.all.bind(Promise);const oi=e=>e===void 0?null:e;class Rl{constructor(){this.map=new Map}setItem(t,n){this.map.set(t,n)}getItem(t){return this.map.get(t)}}let Yi=new Rl,Ul=!0;try{typeof localStorage<"u"&&localStorage&&(Yi=localStorage,Ul=!1)}catch{}const Bl=Yi,wn=Symbol("Equality"),Ki=(e,t)=>e===t||!!e?.[wn]?.(t)||!1,vl=e=>typeof e=="object",Ll=Object.assign,Ml=Object.keys,Ol=(e,t)=>{for(const n in e)t(e[n],n)},ar=e=>Ml(e).length,Fl=e=>{for(const t in e)return!1;return!0},vn=(e,t)=>{for(const n in e)if(!t(e[n],n))return!1;return!0},xs=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),Nl=(e,t)=>e===t||ar(e)===ar(t)&&vn(e,(n,r)=>(n!==void 0||xs(t,r))&&Ki(t[r],n)),$l=Object.freeze,Xi=e=>{for(const t in e){const n=e[t];(typeof n=="object"||typeof n=="function")&&Xi(e[t])}return $l(e)},Is=(e,t,n=0)=>{try{for(;n<e.length;n++)e[n](...t)}finally{n<e.length&&Is(e,t,n+1)}},Vl=e=>e,er=(e,t)=>{if(e===t)return!0;if(e==null||t==null||e.constructor!==t.constructor&&(e.constructor||Object)!==(t.constructor||Object))return!1;if(e[wn]!=null)return e[wn](t);switch(e.constructor){case ArrayBuffer:e=new Uint8Array(e),t=new Uint8Array(t);case Uint8Array:{if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.length;n++)if(e[n]!==t[n])return!1;break}case Set:{if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;break}case Map:{if(e.size!==t.size)return!1;for(const n of e.keys())if(!t.has(n)||!er(e.get(n),t.get(n)))return!1;break}case void 0:case Object:if(ar(e)!==ar(t))return!1;for(const n in e)if(!xs(e,n)||!er(e[n],t[n]))return!1;break;case Array:if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!er(e[n],t[n]))return!1;break;default:return!1}return!0},Pl=(e,t)=>t.includes(e);var Zi={};const yn=typeof ue<"u"&&ue.release&&/node|io\.js/.test(ue.release.name)&&Object.prototype.toString.call(typeof ue<"u"?ue:0)==="[object process]";let vt;const jl=()=>{if(vt===void 0)if(yn){vt=mt();const e=ue.argv;let t=null;for(let n=0;n<e.length;n++){const r=e[n];r[0]==="-"?(t!==null&&vt.set(t,""),t=r):t!==null&&(vt.set(t,r),t=null)}t!==null&&vt.set(t,"")}else typeof location=="object"?(vt=mt(),(location.search||"?").slice(1).split("&").forEach(e=>{if(e.length!==0){const[t,n]=e.split("=");vt.set(`--${ti(t,"-")}`,n),vt.set(`-${ti(t,"-")}`,n)}})):vt=mt();return vt},as=e=>jl().has(e),ur=e=>oi(yn?Zi[e.toUpperCase().replaceAll("-","_")]:Bl.getItem(e)),Qi=e=>as("--"+e)||ur(e)!==null,Hl=Qi("production"),ql=yn&&Pl(Zi.FORCE_COLOR,["true","1","2"]),Gl=ql||!as("--no-colors")&&!Qi("no-color")&&(!yn||ue.stdout.isTTY)&&(!yn||as("--color")||ur("COLORTERM")!==null||(ur("TERM")||"").includes("color")),Jl=e=>new Uint8Array(e),zl=e=>{const t=Jl(e.byteLength);return t.set(e),t};class Wl{constructor(t,n){this.left=t,this.right=n}}const qt=(e,t)=>new Wl(e,t),ci=e=>e.next()>=.5,Wr=(e,t,n)=>Vt(e.next()*(n+1-t)+t),to=(e,t,n)=>Vt(e.next()*(n+1-t)+t),Cs=(e,t,n)=>to(e,t,n),Yl=e=>Qc(Cs(e,97,122)),Kl=(e,t=0,n=20)=>{const r=Cs(e,t,n);let s="";for(let i=0;i<r;i++)s+=Yl(e);return s},Yr=(e,t)=>t[Cs(e,0,t.length-1)],Xl=Symbol("0schema");class Zl{constructor(){this._rerrs=[]}extend(t,n,r,s=null){this._rerrs.push({path:t,expected:n,has:r,message:s})}toString(){const t=[];for(let n=this._rerrs.length-1;n>0;n--){const r=this._rerrs[n];t.push(cl(" ",(this._rerrs.length-n)*2)+`${r.path!=null?`[${r.path}] `:""}${r.has} doesn't match ${r.expected}. ${r.message}`)}return t.join(`
`)}}const us=(e,t)=>e===t?!0:e==null||t==null||e.constructor!==t.constructor?!1:e[wn]?Ki(e,t):_r(e)?Es(e,n=>Hi(t,r=>us(n,r))):vl(e)?vn(e,(n,r)=>us(n,t[r])):!1;class dt{static _dilutes=!1;extends(t){let[n,r]=[this.shape,t.shape];return this.constructor._dilutes&&([r,n]=[n,r]),us(n,r)}equals(t){return this.constructor===t.constructor&&er(this.shape,t.shape)}[Xl](){return!0}[wn](t){return this.equals(t)}validate(t){return this.check(t)}check(t,n){Tt()}get nullable(){return Ye(this,Br)}get optional(){return new ro(this)}cast(t){return li(t,this),t}expect(t){return li(t,this),t}}class Ds extends dt{constructor(t,n){super(),this.shape=t,this._c=n}check(t,n=void 0){const r=t?.constructor===this.shape&&(this._c==null||this._c(t));return!r&&n?.extend(null,this.shape.name,t?.constructor.name,t?.constructor!==this.shape?"Constructor match failed":"Check failed"),r}}const K=(e,t=null)=>new Ds(e,t);K(Ds);class Ts extends dt{constructor(t){super(),this.shape=t}check(t,n){const r=this.shape(t);return!r&&n?.extend(null,"custom prop",t?.constructor.name,"failed to check custom prop"),r}}const ct=e=>new Ts(e);K(Ts);class Dr extends dt{constructor(t){super(),this.shape=t}check(t,n){const r=this.shape.some(s=>s===t);return!r&&n?.extend(null,this.shape.join(" | "),t.toString()),r}}const Tr=(...e)=>new Dr(e),eo=K(Dr),Ql=RegExp.escape||(e=>e.replace(/[().|&,$^[\]]/g,t=>"\\"+t)),no=e=>{if(He.check(e))return[Ql(e)];if(eo.check(e))return e.shape.map(t=>t+"");if(fo.check(e))return["[+-]?\\d+.?\\d*"];if(po.check(e))return[".*"];if(hr.check(e))return e.shape.map(no).flat(1);It()};class ta extends dt{constructor(t){super(),this.shape=t,this._r=new RegExp("^"+t.map(no).map(n=>`(${n.join("|")})`).join("")+"$")}check(t,n){const r=this._r.exec(t)!=null;return!r&&n?.extend(null,this._r.toString(),t.toString(),"String doesn't match string template."),r}}K(ta);const ea=Symbol("optional");class ro extends dt{constructor(t){super(),this.shape=t}check(t,n){const r=t===void 0||this.shape.check(t);return!r&&n?.extend(null,"undefined (optional)","()"),r}get[ea](){return!0}}const na=K(ro);class ra extends dt{check(t,n){return n?.extend(null,"never",typeof t),!1}}K(ra);class Rr extends dt{constructor(t,n=!1){super(),this.shape=t,this._isPartial=n}static _dilutes=!0;get partial(){return new Rr(this.shape,!0)}check(t,n){return t==null?(n?.extend(null,"object","null"),!1):vn(this.shape,(r,s)=>{const i=this._isPartial&&!xs(t,s)||r.check(t[s],n);return!i&&n?.extend(s.toString(),r.toString(),typeof t[s],"Object property does not match"),i})}}const sa=e=>new Rr(e),ia=K(Rr),oa=ct(e=>e!=null&&(e.constructor===Object||e.constructor==null));class so extends dt{constructor(t,n){super(),this.shape={keys:t,values:n}}check(t,n){return t!=null&&vn(t,(r,s)=>{const i=this.shape.keys.check(s,n);return!i&&n?.extend(s+"","Record",typeof t,i?"Key doesn't match schema":"Value doesn't match value"),i&&this.shape.values.check(r,n)})}}const io=(e,t)=>new so(e,t),ca=K(so);class oo extends dt{constructor(t){super(),this.shape=t}check(t,n){return t!=null&&vn(this.shape,(r,s)=>{const i=r.check(t[s],n);return!i&&n?.extend(s.toString(),"Tuple",typeof r),i})}}const la=(...e)=>new oo(e);K(oo);class co extends dt{constructor(t){super(),this.shape=t.length===1?t[0]:new Rs(t)}check(t,n){const r=_r(t)&&Es(t,s=>this.shape.check(s));return!r&&n?.extend(null,"Array",""),r}}const lo=(...e)=>new co(e),aa=K(co),ua=ct(e=>_r(e));class ao extends dt{constructor(t,n){super(),this.shape=t,this._c=n}check(t,n){const r=t instanceof this.shape&&(this._c==null||this._c(t));return!r&&n?.extend(null,this.shape.name,t?.constructor.name),r}}const ha=(e,t=null)=>new ao(e,t);K(ao);const fa=ha(dt);class da extends dt{constructor(t){super(),this.len=t.length-1,this.args=la(...t.slice(-1)),this.res=t[this.len]}check(t,n){const r=t.constructor===Function&&t.length<=this.len;return!r&&n?.extend(null,"function",typeof t),r}}const pa=K(da),ga=ct(e=>typeof e=="function");class ma extends dt{constructor(t){super(),this.shape=t}check(t,n){const r=Es(this.shape,s=>s.check(t,n));return!r&&n?.extend(null,"Intersectinon",typeof t),r}}K(ma,e=>e.shape.length>0);class Rs extends dt{static _dilutes=!0;constructor(t){super(),this.shape=t}check(t,n){const r=Hi(this.shape,s=>s.check(t,n));return n?.extend(null,"Union",typeof t),r}}const Ye=(...e)=>e.findIndex(t=>hr.check(t))>=0?Ye(...e.map(t=>bn(t)).map(t=>hr.check(t)?t.shape:[t]).flat(1)):e.length===1?e[0]:new Rs(e),hr=K(Rs),uo=()=>!0,fr=ct(uo),wa=K(Ts,e=>e.shape===uo),Us=ct(e=>typeof e=="bigint"),ya=ct(e=>e===Us),ho=ct(e=>typeof e=="symbol");ct(e=>e===ho);const Fe=ct(e=>typeof e=="number"),fo=ct(e=>e===Fe),He=ct(e=>typeof e=="string"),po=ct(e=>e===He),Ur=ct(e=>typeof e=="boolean"),ba=ct(e=>e===Ur),go=Tr(void 0);K(Dr,e=>e.shape.length===1&&e.shape[0]===void 0);Tr(void 0);const Br=Tr(null),Ea=K(Dr,e=>e.shape.length===1&&e.shape[0]===null);K(Uint8Array);K(Ds,e=>e.shape===Uint8Array);const ka=Ye(Fe,He,Br,go,Us,Ur,ho);(()=>{const e=lo(fr),t=io(He,fr),n=Ye(Fe,He,Br,Ur,e,t);return e.shape=n,t.shape.values=n,n})();const bn=e=>{if(fa.check(e))return e;if(oa.check(e)){const t={};for(const n in e)t[n]=bn(e[n]);return sa(t)}else{if(ua.check(e))return Ye(...e.map(bn));if(ka.check(e))return Tr(e);if(ga.check(e))return K(e)}It()},li=Hl?()=>{}:(e,t)=>{const n=new Zl;if(!t.check(e,n))throw Rt(`Expected value to be of type ${t.constructor.name}.
${n.toString()}`)};class Sa{constructor(t){this.patterns=[],this.$state=t}if(t,n){return this.patterns.push({if:bn(t),h:n}),this}else(t){return this.if(fr,t)}done(){return(t,n)=>{for(let r=0;r<this.patterns.length;r++){const s=this.patterns[r];if(s.if.check(t))return s.h(t,n)}throw Rt("Unhandled pattern")}}}const _a=e=>new Sa(e),mo=_a(fr).if(fo,(e,t)=>Wr(t,Qs,lr)).if(po,(e,t)=>Kl(t)).if(ba,(e,t)=>ci(t)).if(ya,(e,t)=>BigInt(Wr(t,Qs,lr))).if(hr,(e,t)=>Te(t,Yr(t,e.shape))).if(ia,(e,t)=>{const n={};for(const r in e.shape){let s=e.shape[r];if(na.check(s)){if(ci(t))continue;s=s.shape}n[r]=mo(s,t)}return n}).if(aa,(e,t)=>{const n=[],r=to(t,0,42);for(let s=0;s<r;s++)n.push(Te(t,e.shape));return n}).if(eo,(e,t)=>Yr(t,e.shape)).if(Ea,(e,t)=>null).if(pa,(e,t)=>{const n=Te(t,e.res);return()=>n}).if(wa,(e,t)=>Te(t,Yr(t,[Fe,He,Br,go,Us,Ur,lo(Fe),io(Ye("a","b","c"),Fe)]))).if(ca,(e,t)=>{const n={},r=Wr(t,0,3);for(let s=0;s<r;s++){const i=Te(t,e.shape.keys),l=Te(t,e.shape.values);n[i]=l}return n}).done(),Te=(e,t)=>mo(bn(t),e),vr=typeof document<"u"?document:{};ct(e=>e.nodeType===Da);typeof DOMParser<"u"&&new DOMParser;ct(e=>e.nodeType===xa);ct(e=>e.nodeType===Ia);const Aa=e=>Gc(e,(t,n)=>`${n}:${t};`).join(""),xa=vr.ELEMENT_NODE,Ia=vr.TEXT_NODE,Ca=vr.DOCUMENT_NODE,Da=vr.DOCUMENT_FRAGMENT_NODE;ct(e=>e.nodeType===Ca);const Xt=Symbol,wo=Xt(),yo=Xt(),Ta=Xt(),Ra=Xt(),Ua=Xt(),bo=Xt(),Ba=Xt(),Bs=Xt(),va=Xt(),La=e=>{e.length===1&&e[0]?.constructor===Function&&(e=e[0]());const t=[],n=[];let r=0;for(;r<e.length;r++){const s=e[r];if(s===void 0)break;if(s.constructor===String||s.constructor===Number)t.push(s);else if(s.constructor===Object)break}for(r>0&&n.push(t.join(""));r<e.length;r++){const s=e[r];s instanceof Symbol||n.push(s)}return n},Ma={[wo]:qt("font-weight","bold"),[yo]:qt("font-weight","normal"),[Ta]:qt("color","blue"),[Ua]:qt("color","green"),[Ra]:qt("color","grey"),[bo]:qt("color","red"),[Ba]:qt("color","purple"),[Bs]:qt("color","orange"),[va]:qt("color","black")},Oa=e=>{e.length===1&&e[0]?.constructor===Function&&(e=e[0]());const t=[],n=[],r=mt();let s=[],i=0;for(;i<e.length;i++){const l=e[i],f=Ma[l];if(f!==void 0)r.set(f.left,f.right);else{if(l===void 0)break;if(l.constructor===String||l.constructor===Number){const h=Aa(r);i>0||h.length>0?(t.push("%c"+l),n.push(h)):t.push(l)}else break}}for(i>0&&(s=n,s.unshift(t.join("")));i<e.length;i++){const l=e[i];l instanceof Symbol||s.push(l)}return s},Eo=Gl?Oa:La,Fa=(...e)=>{console.log(...Eo(e)),ko.forEach(t=>t.print(e))},Na=(...e)=>{console.warn(...Eo(e)),e.unshift(Bs),ko.forEach(t=>t.print(e))},ko=we(),So=e=>({[Symbol.iterator](){return this},next:e}),$a=(e,t)=>So(()=>{let n;do n=e.next();while(!n.done&&!t(n.value));return n}),Kr=(e,t)=>So(()=>{const{done:n,value:r}=e.next();return{done:n,value:n?void 0:t(r)}});class vs{constructor(t,n){this.clock=t,this.len=n}}class Ln{constructor(){this.clients=new Map}}const _o=(e,t,n)=>t.clients.forEach((r,s)=>{const i=e.doc.store.clients.get(s);if(i!=null){const l=i[i.length-1],f=l.id.clock+l.length;for(let h=0,g=r[h];h<r.length&&g.clock<f;g=r[++h])Lo(e,i,g.clock,g.len,n)}}),Va=(e,t)=>{let n=0,r=e.length-1;for(;n<=r;){const s=Vt((n+r)/2),i=e[s],l=i.clock;if(l<=t){if(t<l+i.len)return s;n=s+1}else r=s-1}return null},Ao=(e,t)=>{const n=e.clients.get(t.client);return n!==void 0&&Va(n,t.clock)!==null},Ls=e=>{e.clients.forEach(t=>{t.sort((s,i)=>s.clock-i.clock);let n,r;for(n=1,r=1;n<t.length;n++){const s=t[r-1],i=t[n];s.clock+s.len>=i.clock?s.len=Se(s.len,i.clock+i.len-s.clock):(r<n&&(t[r]=i),r++)}t.length=r})},Pa=e=>{const t=new Ln;for(let n=0;n<e.length;n++)e[n].clients.forEach((r,s)=>{if(!t.clients.has(s)){const i=r.slice();for(let l=n+1;l<e.length;l++)zc(i,e[l].clients.get(s)||[]);t.clients.set(s,i)}});return Ls(t),t},dr=(e,t,n,r)=>{Kt(e.clients,t,()=>[]).push(new vs(n,r))},ja=()=>new Ln,Ha=e=>{const t=ja();return e.clients.forEach((n,r)=>{const s=[];for(let i=0;i<n.length;i++){const l=n[i];if(l.deleted){const f=l.id.clock;let h=l.length;if(i+1<n.length)for(let g=n[i+1];i+1<n.length&&g.deleted;g=n[++i+1])h+=g.length;s.push(new vs(f,h))}}s.length>0&&t.clients.set(r,s)}),t},Ke=(e,t)=>{F(e.restEncoder,t.clients.size),se(t.clients.entries()).sort((n,r)=>r[0]-n[0]).forEach(([n,r])=>{e.resetDsCurVal(),F(e.restEncoder,n);const s=r.length;F(e.restEncoder,s);for(let i=0;i<s;i++){const l=r[i];e.writeDsClock(l.clock),e.writeDsLen(l.len)}})},Ms=e=>{const t=new Ln,n=B(e.restDecoder);for(let r=0;r<n;r++){e.resetDsCurVal();const s=B(e.restDecoder),i=B(e.restDecoder);if(i>0){const l=Kt(t.clients,s,()=>[]);for(let f=0;f<i;f++)l.push(new vs(e.readDsClock(),e.readDsLen()))}}return t},ai=(e,t,n)=>{const r=new Ln,s=B(e.restDecoder);for(let i=0;i<s;i++){e.resetDsCurVal();const l=B(e.restDecoder),f=B(e.restDecoder),h=n.clients.get(l)||[],g=ot(n,l);for(let u=0;u<f;u++){const w=e.readDsClock(),p=w+e.readDsLen();if(w<g){g<p&&dr(r,l,g,p-g);let y=Pt(h,w),k=h[y];for(!k.deleted&&k.id.clock<w&&(h.splice(y+1,0,Er(t,k,w-k.id.clock)),y++);y<h.length&&(k=h[y++],k.id.clock<p);)k.deleted||(p<k.id.clock+k.length&&h.splice(y,0,Er(t,k,p-k.id.clock)),k.delete(t))}else dr(r,l,w,p-w)}}if(r.clients.size>0){const i=new ye;return F(i.restEncoder,0),Ke(i,r),i.toUint8Array()}return null},xo=Wi;class Xe extends Yc{constructor({guid:t=Tl(),collectionid:n=null,gc:r=!0,gcFilter:s=()=>!0,meta:i=null,autoLoad:l=!1,shouldLoad:f=!0}={}){super(),this.gc=r,this.gcFilter=s,this.clientID=xo(),this.guid=t,this.collectionid=n,this.share=new Map,this.store=new Bo,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=f,this.autoLoad=l,this.meta=i,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=je(g=>{this.on("load",()=>{this.isLoaded=!0,g(this)})});const h=()=>je(g=>{const u=w=>{(w===void 0||w===!0)&&(this.off("sync",u),g())};this.on("sync",u)});this.on("sync",g=>{g===!1&&this.isSynced&&(this.whenSynced=h()),this.isSynced=g===void 0||g===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=h()}load(){const t=this._item;t!==null&&!this.shouldLoad&&V(t.parent.doc,n=>{n.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(se(this.subdocs).map(t=>t.guid))}transact(t,n=null){return V(this,t,n)}get(t,n=lt){const r=Kt(this.share,t,()=>{const i=new n;return i._integrate(this,null),i}),s=r.constructor;if(n!==lt&&s!==n)if(s===lt){const i=new n;i._map=r._map,r._map.forEach(l=>{for(;l!==null;l=l.left)l.parent=i}),i._start=r._start;for(let l=i._start;l!==null;l=l.right)l.parent=i;return i._length=r._length,this.share.set(t,i),i._integrate(this,null),i}else throw new Error(`Type with the name ${t} has already been defined with a different constructor`);return r}getArray(t=""){return this.get(t,$e)}getText(t=""){return this.get(t,Je)}getMap(t=""){return this.get(t,Ge)}getXmlElement(t=""){return this.get(t,ze)}getXmlFragment(t=""){return this.get(t,be)}toJSON(){const t={};return this.share.forEach((n,r)=>{t[r]=n.toJSON()}),t}destroy(){this.isDestroyed=!0,se(this.subdocs).forEach(n=>n.destroy());const t=this._item;if(t!==null){this._item=null;const n=t.content;n.doc=new Xe({guid:this.guid,...n.opts,shouldLoad:!1}),n.doc._item=t,V(t.parent.doc,r=>{const s=n.doc;t.deleted||r.subdocsAdded.add(s),r.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}}class Io{constructor(t){this.restDecoder=t}resetDsCurVal(){}readDsClock(){return B(this.restDecoder)}readDsLen(){return B(this.restDecoder)}}class Co extends Io{readLeftID(){return L(B(this.restDecoder),B(this.restDecoder))}readRightID(){return L(B(this.restDecoder),B(this.restDecoder))}readClient(){return B(this.restDecoder)}readInfo(){return Pe(this.restDecoder)}readString(){return Oe(this.restDecoder)}readParentInfo(){return B(this.restDecoder)===1}readTypeRef(){return B(this.restDecoder)}readLen(){return B(this.restDecoder)}readAny(){return mn(this.restDecoder)}readBuf(){return zl(bt(this.restDecoder))}readJSON(){return JSON.parse(Oe(this.restDecoder))}readKey(){return Oe(this.restDecoder)}}class qa{constructor(t){this.dsCurrVal=0,this.restDecoder=t}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=B(this.restDecoder),this.dsCurrVal}readDsLen(){const t=B(this.restDecoder)+1;return this.dsCurrVal+=t,t}}class qe extends qa{constructor(t){super(t),this.keys=[],B(t),this.keyClockDecoder=new zr(bt(t)),this.clientDecoder=new tr(bt(t)),this.leftClockDecoder=new zr(bt(t)),this.rightClockDecoder=new zr(bt(t)),this.infoDecoder=new ii(bt(t),Pe),this.stringDecoder=new Il(bt(t)),this.parentInfoDecoder=new ii(bt(t),Pe),this.typeRefDecoder=new tr(bt(t)),this.lenDecoder=new tr(bt(t))}readLeftID(){return new Ne(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new Ne(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return mn(this.restDecoder)}readBuf(){return bt(this.restDecoder)}readJSON(){return mn(this.restDecoder)}readKey(){const t=this.keyClockDecoder.read();if(t<this.keys.length)return this.keys[t];{const n=this.stringDecoder.read();return this.keys.push(n),n}}}class Ga{constructor(){this.restEncoder=xr()}toUint8Array(){return Nt(this.restEncoder)}resetDsCurVal(){}writeDsClock(t){F(this.restEncoder,t)}writeDsLen(t){F(this.restEncoder,t)}}class Mn extends Ga{writeLeftID(t){F(this.restEncoder,t.client),F(this.restEncoder,t.clock)}writeRightID(t){F(this.restEncoder,t.client),F(this.restEncoder,t.clock)}writeClient(t){F(this.restEncoder,t)}writeInfo(t){cs(this.restEncoder,t)}writeString(t){Me(this.restEncoder,t)}writeParentInfo(t){F(this.restEncoder,t?1:0)}writeTypeRef(t){F(this.restEncoder,t)}writeLen(t){F(this.restEncoder,t)}writeAny(t){gn(this.restEncoder,t)}writeBuf(t){yt(this.restEncoder,t)}writeJSON(t){Me(this.restEncoder,JSON.stringify(t))}writeKey(t){Me(this.restEncoder,t)}}class Ja{constructor(){this.restEncoder=xr(),this.dsCurrVal=0}toUint8Array(){return Nt(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(t){const n=t-this.dsCurrVal;this.dsCurrVal=t,F(this.restEncoder,n)}writeDsLen(t){t===0&&It(),F(this.restEncoder,t-1),this.dsCurrVal+=t}}class ye extends Ja{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new Jr,this.clientEncoder=new Qn,this.leftClockEncoder=new Jr,this.rightClockEncoder=new Jr,this.infoEncoder=new ni(cs),this.stringEncoder=new wl,this.parentInfoEncoder=new ni(cs),this.typeRefEncoder=new Qn,this.lenEncoder=new Qn}toUint8Array(){const t=xr();return F(t,0),yt(t,this.keyClockEncoder.toUint8Array()),yt(t,this.clientEncoder.toUint8Array()),yt(t,this.leftClockEncoder.toUint8Array()),yt(t,this.rightClockEncoder.toUint8Array()),yt(t,Nt(this.infoEncoder)),yt(t,this.stringEncoder.toUint8Array()),yt(t,Nt(this.parentInfoEncoder)),yt(t,this.typeRefEncoder.toUint8Array()),yt(t,this.lenEncoder.toUint8Array()),Ir(t,Nt(this.restEncoder)),Nt(t)}writeLeftID(t){this.clientEncoder.write(t.client),this.leftClockEncoder.write(t.clock)}writeRightID(t){this.clientEncoder.write(t.client),this.rightClockEncoder.write(t.clock)}writeClient(t){this.clientEncoder.write(t)}writeInfo(t){this.infoEncoder.write(t)}writeString(t){this.stringEncoder.write(t)}writeParentInfo(t){this.parentInfoEncoder.write(t?1:0)}writeTypeRef(t){this.typeRefEncoder.write(t)}writeLen(t){this.lenEncoder.write(t)}writeAny(t){gn(this.restEncoder,t)}writeBuf(t){yt(this.restEncoder,t)}writeJSON(t){gn(this.restEncoder,t)}writeKey(t){const n=this.keyMap.get(t);n===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(t)):this.keyClockEncoder.write(n)}}const za=(e,t,n,r)=>{r=Se(r,t[0].id.clock);const s=Pt(t,r);F(e.restEncoder,t.length-s),e.writeClient(n),F(e.restEncoder,r);const i=t[s];i.write(e,r-i.id.clock);for(let l=s+1;l<t.length;l++)t[l].write(e,0)},Os=(e,t,n)=>{const r=new Map;n.forEach((s,i)=>{ot(t,i)>s&&r.set(i,s)}),Fs(t).forEach((s,i)=>{n.has(i)||r.set(i,0)}),F(e.restEncoder,r.size),se(r.entries()).sort((s,i)=>i[0]-s[0]).forEach(([s,i])=>{za(e,t.clients.get(s),s,i)})},Wa=(e,t)=>{const n=mt(),r=B(e.restDecoder);for(let s=0;s<r;s++){const i=B(e.restDecoder),l=new Array(i),f=e.readClient();let h=B(e.restDecoder);n.set(f,{i:0,refs:l});for(let g=0;g<i;g++){const u=e.readInfo();switch(Ar&u){case 0:{const w=e.readLen();l[g]=new At(L(f,h),w),h+=w;break}case 10:{const w=B(e.restDecoder);l[g]=new xt(L(f,h),w),h+=w;break}default:{const w=(u&(Wt|Et))===0,p=new tt(L(f,h),null,(u&Et)===Et?e.readLeftID():null,null,(u&Wt)===Wt?e.readRightID():null,w?e.readParentInfo()?t.get(e.readString()):e.readLeftID():null,w&&(u&dn)===dn?e.readString():null,Qo(e,u));l[g]=p,h+=p.length}}}}return n},Ya=(e,t,n)=>{const r=[];let s=se(n.keys()).sort((y,k)=>y-k);if(s.length===0)return null;const i=()=>{if(s.length===0)return null;let y=n.get(s[s.length-1]);for(;y.refs.length===y.i;)if(s.pop(),s.length>0)y=n.get(s[s.length-1]);else return null;return y};let l=i();if(l===null)return null;const f=new Bo,h=new Map,g=(y,k)=>{const _=h.get(y);(_==null||_>k)&&h.set(y,k)};let u=l.refs[l.i++];const w=new Map,p=()=>{for(const y of r){const k=y.id.client,_=n.get(k);_?(_.i--,f.clients.set(k,_.refs.slice(_.i)),n.delete(k),_.i=0,_.refs=[]):f.clients.set(k,[y]),s=s.filter(R=>R!==k)}r.length=0};for(;;){if(u.constructor!==xt){const k=Kt(w,u.id.client,()=>ot(t,u.id.client))-u.id.clock;if(k<0)r.push(u),g(u.id.client,u.id.clock-1),p();else{const _=u.getMissing(e,t);if(_!==null){r.push(u);const R=n.get(_)||{refs:[],i:0};if(R.refs.length===R.i)g(_,ot(t,_)),p();else{u=R.refs[R.i++];continue}}else(k===0||k<u.length)&&(u.integrate(e,k),w.set(u.id.client,u.id.clock+u.length))}}if(r.length>0)u=r.pop();else if(l!==null&&l.i<l.refs.length)u=l.refs[l.i++];else{if(l=i(),l===null)break;u=l.refs[l.i++]}}if(f.clients.size>0){const y=new ye;return Os(y,f,new Map),F(y.restEncoder,0),{missing:h,update:y.toUint8Array()}}return null},Ka=(e,t)=>Os(e,t.doc.store,t.beforeState),Xa=(e,t,n,r=new qe(e))=>V(t,s=>{s.local=!1;let i=!1;const l=s.doc,f=l.store,h=Wa(r,l),g=Ya(s,f,h),u=f.pendingStructs;if(u){for(const[p,y]of u.missing)if(y<ot(f,p)){i=!0;break}if(g){for(const[p,y]of g.missing){const k=u.missing.get(p);(k==null||k>y)&&u.missing.set(p,y)}u.update=pr([u.update,g.update])}}else f.pendingStructs=g;const w=ai(r,s,f);if(f.pendingDs){const p=new qe(We(f.pendingDs));B(p.restDecoder);const y=ai(p,s,f);w&&y?f.pendingDs=pr([w,y]):f.pendingDs=w||y}else f.pendingDs=w;if(i){const p=f.pendingStructs.update;f.pendingStructs=null,Do(s.doc,p)}},n,!1),Do=(e,t,n,r=qe)=>{const s=We(t);Xa(s,e,n,new r(s))},Za=(e,t,n)=>Do(e,t,n,Co),Qa=(e,t,n=new Map)=>{Os(e,t.store,n),Ke(e,Ha(t.store))},tu=(e,t=new Uint8Array([0]),n=new ye)=>{const r=Ro(t);Qa(n,e,r);const s=[n.toUint8Array()];if(e.store.pendingDs&&s.push(e.store.pendingDs),e.store.pendingStructs&&s.push(fu(e.store.pendingStructs.update,t)),s.length>1){if(n.constructor===Mn)return uu(s.map((i,l)=>l===0?i:pu(i)));if(n.constructor===ye)return pr(s)}return s[0]},To=(e,t)=>tu(e,t,new Mn),eu=e=>{const t=new Map,n=B(e.restDecoder);for(let r=0;r<n;r++){const s=B(e.restDecoder),i=B(e.restDecoder);t.set(s,i)}return t},Ro=e=>eu(new Io(We(e)));class nu{constructor(){this.l=[]}}const ui=()=>new nu,hi=(e,t)=>e.l.push(t),fi=(e,t)=>{const n=e.l,r=n.length;e.l=n.filter(s=>t!==s),r===e.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},Uo=(e,t,n)=>Is(e.l,[t,n]);class Ne{constructor(t,n){this.client=t,this.clock=n}}const jn=(e,t)=>e===t||e!==null&&t!==null&&e.client===t.client&&e.clock===t.clock,L=(e,t)=>new Ne(e,t),ru=e=>{for(const[t,n]of e.doc.share.entries())if(n===e)return t;throw It()},Ue=(e,t)=>t===void 0?!e.deleted:t.sv.has(e.id.client)&&(t.sv.get(e.id.client)||0)>e.id.clock&&!Ao(t.ds,e.id),hs=(e,t)=>{const n=Kt(e.meta,hs,we),r=e.doc.store;n.has(t)||(t.sv.forEach((s,i)=>{s<ot(r,i)&&ie(e,L(i,s))}),_o(e,t.ds,s=>{}),n.add(t))};class Bo{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const Fs=e=>{const t=new Map;return e.clients.forEach((n,r)=>{const s=n[n.length-1];t.set(r,s.id.clock+s.length)}),t},ot=(e,t)=>{const n=e.clients.get(t);if(n===void 0)return 0;const r=n[n.length-1];return r.id.clock+r.length},vo=(e,t)=>{let n=e.clients.get(t.id.client);if(n===void 0)n=[],e.clients.set(t.id.client,n);else{const r=n[n.length-1];if(r.id.clock+r.length!==t.id.clock)throw It()}n.push(t)},Pt=(e,t)=>{let n=0,r=e.length-1,s=e[r],i=s.id.clock;if(i===t)return r;let l=Vt(t/(i+s.length-1)*r);for(;n<=r;){if(s=e[l],i=s.id.clock,i<=t){if(t<i+s.length)return l;n=l+1}else r=l-1;l=Vt((n+r)/2)}throw It()},su=(e,t)=>{const n=e.clients.get(t.client);return n[Pt(n,t.clock)]},Xr=su,fs=(e,t,n)=>{const r=Pt(t,n),s=t[r];return s.id.clock<n&&s instanceof tt?(t.splice(r+1,0,Er(e,s,n-s.id.clock)),r+1):r},ie=(e,t)=>{const n=e.doc.store.clients.get(t.client);return n[fs(e,n,t.clock)]},di=(e,t,n)=>{const r=t.clients.get(n.client),s=Pt(r,n.clock),i=r[s];return n.clock!==i.id.clock+i.length-1&&i.constructor!==At&&r.splice(s+1,0,Er(e,i,n.clock-i.id.clock+1)),i},iu=(e,t,n)=>{const r=e.clients.get(t.id.client);r[Pt(r,t.id.clock)]=n},Lo=(e,t,n,r,s)=>{if(r===0)return;const i=n+r;let l=fs(e,t,n),f;do f=t[l++],i<f.id.clock+f.length&&fs(e,t,i),s(f);while(l<t.length&&t[l].id.clock<i)};class ou{constructor(t,n,r){this.doc=t,this.deleteSet=new Ln,this.beforeState=Fs(t.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=n,this.meta=new Map,this.local=r,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}}const pi=(e,t)=>t.deleteSet.clients.size===0&&!Jc(t.afterState,(n,r)=>t.beforeState.get(r)!==n)?!1:(Ls(t.deleteSet),Ka(e,t),Ke(e,t.deleteSet),!0),gi=(e,t,n)=>{const r=t._item;(r===null||r.id.clock<(e.beforeState.get(r.id.client)||0)&&!r.deleted)&&Kt(e.changed,t,we).add(n)},nr=(e,t)=>{let n=e[t],r=e[t-1],s=t;for(;s>0;n=r,r=e[--s-1]){if(r.deleted===n.deleted&&r.constructor===n.constructor&&r.mergeWith(n)){n instanceof tt&&n.parentSub!==null&&n.parent._map.get(n.parentSub)===n&&n.parent._map.set(n.parentSub,r);continue}break}const i=t-s;return i&&e.splice(t+1-i,i),i},cu=(e,t,n)=>{for(const[r,s]of e.clients.entries()){const i=t.clients.get(r);for(let l=s.length-1;l>=0;l--){const f=s[l],h=f.clock+f.len;for(let g=Pt(i,f.clock),u=i[g];g<i.length&&u.id.clock<h;u=i[++g]){const w=i[g];if(f.clock+f.len<=w.id.clock)break;w instanceof tt&&w.deleted&&!w.keep&&n(w)&&w.gc(t,!1)}}}},lu=(e,t)=>{e.clients.forEach((n,r)=>{const s=t.clients.get(r);for(let i=n.length-1;i>=0;i--){const l=n[i],f=qi(s.length-1,1+Pt(s,l.clock+l.len-1));for(let h=f,g=s[h];h>0&&g.id.clock>=l.clock;g=s[h])h-=1+nr(s,h)}})},Mo=(e,t)=>{if(t<e.length){const n=e[t],r=n.doc,s=r.store,i=n.deleteSet,l=n._mergeStructs;try{Ls(i),n.afterState=Fs(n.doc.store),r.emit("beforeObserverCalls",[n,r]);const f=[];n.changed.forEach((h,g)=>f.push(()=>{(g._item===null||!g._item.deleted)&&g._callObserver(n,h)})),f.push(()=>{n.changedParentTypes.forEach((h,g)=>{g._dEH.l.length>0&&(g._item===null||!g._item.deleted)&&(h=h.filter(u=>u.target._item===null||!u.target._item.deleted),h.forEach(u=>{u.currentTarget=g,u._path=null}),h.sort((u,w)=>u.path.length-w.path.length),Uo(g._dEH,h,n))})}),f.push(()=>r.emit("afterTransaction",[n,r])),Is(f,[]),n._needFormattingCleanup&&Du(n)}finally{r.gc&&cu(i,s,r.gcFilter),lu(i,s),n.afterState.forEach((u,w)=>{const p=n.beforeState.get(w)||0;if(p!==u){const y=s.clients.get(w),k=Se(Pt(y,p),1);for(let _=y.length-1;_>=k;)_-=1+nr(y,_)}});for(let u=l.length-1;u>=0;u--){const{client:w,clock:p}=l[u].id,y=s.clients.get(w),k=Pt(y,p);k+1<y.length&&nr(y,k+1)>1||k>0&&nr(y,k)}if(!n.local&&n.afterState.get(r.clientID)!==n.beforeState.get(r.clientID)&&(Fa(Bs,wo,"[yjs] ",yo,bo,"Changed the client-id because another client seems to be using it."),r.clientID=xo()),r.emit("afterTransactionCleanup",[n,r]),r._observers.has("update")){const u=new Mn;pi(u,n)&&r.emit("update",[u.toUint8Array(),n.origin,r,n])}if(r._observers.has("updateV2")){const u=new ye;pi(u,n)&&r.emit("updateV2",[u.toUint8Array(),n.origin,r,n])}const{subdocsAdded:f,subdocsLoaded:h,subdocsRemoved:g}=n;(f.size>0||g.size>0||h.size>0)&&(f.forEach(u=>{u.clientID=r.clientID,u.collectionid==null&&(u.collectionid=r.collectionid),r.subdocs.add(u)}),g.forEach(u=>r.subdocs.delete(u)),r.emit("subdocs",[{loaded:h,added:f,removed:g},r,n]),g.forEach(u=>u.destroy())),e.length<=t+1?(r._transactionCleanups=[],r.emit("afterAllTransactions",[r,e])):Mo(e,t+1)}}},V=(e,t,n=null,r=!0)=>{const s=e._transactionCleanups;let i=!1,l=null;e._transaction===null&&(i=!0,e._transaction=new ou(e,n,r),s.push(e._transaction),s.length===1&&e.emit("beforeAllTransactions",[e]),e.emit("beforeTransaction",[e._transaction,e]));try{l=t(e._transaction)}finally{if(i){const f=e._transaction===s[0];e._transaction=null,f&&Mo(s,0)}}return l};function*au(e){const t=B(e.restDecoder);for(let n=0;n<t;n++){const r=B(e.restDecoder),s=e.readClient();let i=B(e.restDecoder);for(let l=0;l<r;l++){const f=e.readInfo();if(f===10){const h=B(e.restDecoder);yield new xt(L(s,i),h),i+=h}else if((Ar&f)!==0){const h=(f&(Wt|Et))===0,g=new tt(L(s,i),null,(f&Et)===Et?e.readLeftID():null,null,(f&Wt)===Wt?e.readRightID():null,h?e.readParentInfo()?e.readString():e.readLeftID():null,h&&(f&dn)===dn?e.readString():null,Qo(e,f));yield g,i+=g.length}else{const h=e.readLen();yield new At(L(s,i),h),i+=h}}}}class Ns{constructor(t,n){this.gen=au(t),this.curr=null,this.done=!1,this.filterSkips=n,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===xt);return this.curr}}class $s{constructor(t){this.currClient=0,this.startClock=0,this.written=0,this.encoder=t,this.clientStructs=[]}}const uu=e=>pr(e,Co,Mn),hu=(e,t)=>{if(e.constructor===At){const{client:n,clock:r}=e.id;return new At(L(n,r+t),e.length-t)}else if(e.constructor===xt){const{client:n,clock:r}=e.id;return new xt(L(n,r+t),e.length-t)}else{const n=e,{client:r,clock:s}=n.id;return new tt(L(r,s+t),null,L(r,s+t-1),null,n.rightOrigin,n.parent,n.parentSub,n.content.splice(t))}},pr=(e,t=qe,n=ye)=>{if(e.length===1)return e[0];const r=e.map(u=>new t(We(u)));let s=r.map(u=>new Ns(u,!0)),i=null;const l=new n,f=new $s(l);for(;s=s.filter(p=>p.curr!==null),s.sort((p,y)=>{if(p.curr.id.client===y.curr.id.client){const k=p.curr.id.clock-y.curr.id.clock;return k===0?p.curr.constructor===y.curr.constructor?0:p.curr.constructor===xt?1:-1:k}else return y.curr.id.client-p.curr.id.client}),s.length!==0;){const u=s[0],w=u.curr.id.client;if(i!==null){let p=u.curr,y=!1;for(;p!==null&&p.id.clock+p.length<=i.struct.id.clock+i.struct.length&&p.id.client>=i.struct.id.client;)p=u.next(),y=!0;if(p===null||p.id.client!==w||y&&p.id.clock>i.struct.id.clock+i.struct.length)continue;if(w!==i.struct.id.client)ee(f,i.struct,i.offset),i={struct:p,offset:0},u.next();else if(i.struct.id.clock+i.struct.length<p.id.clock)if(i.struct.constructor===xt)i.struct.length=p.id.clock+p.length-i.struct.id.clock;else{ee(f,i.struct,i.offset);const k=p.id.clock-i.struct.id.clock-i.struct.length;i={struct:new xt(L(w,i.struct.id.clock+i.struct.length),k),offset:0}}else{const k=i.struct.id.clock+i.struct.length-p.id.clock;k>0&&(i.struct.constructor===xt?i.struct.length-=k:p=hu(p,k)),i.struct.mergeWith(p)||(ee(f,i.struct,i.offset),i={struct:p,offset:0},u.next())}}else i={struct:u.curr,offset:0},u.next();for(let p=u.curr;p!==null&&p.id.client===w&&p.id.clock===i.struct.id.clock+i.struct.length&&p.constructor!==xt;p=u.next())ee(f,i.struct,i.offset),i={struct:p,offset:0}}i!==null&&(ee(f,i.struct,i.offset),i=null),Vs(f);const h=r.map(u=>Ms(u)),g=Pa(h);return Ke(l,g),l.toUint8Array()},fu=(e,t,n=qe,r=ye)=>{const s=Ro(t),i=new r,l=new $s(i),f=new n(We(e)),h=new Ns(f,!1);for(;h.curr;){const u=h.curr,w=u.id.client,p=s.get(w)||0;if(h.curr.constructor===xt){h.next();continue}if(u.id.clock+u.length>p)for(ee(l,u,Se(p-u.id.clock,0)),h.next();h.curr&&h.curr.id.client===w;)ee(l,h.curr,0),h.next();else for(;h.curr&&h.curr.id.client===w&&h.curr.id.clock+h.curr.length<=p;)h.next()}Vs(l);const g=Ms(f);return Ke(i,g),i.toUint8Array()},Oo=e=>{e.written>0&&(e.clientStructs.push({written:e.written,restEncoder:Nt(e.encoder.restEncoder)}),e.encoder.restEncoder=xr(),e.written=0)},ee=(e,t,n)=>{e.written>0&&e.currClient!==t.id.client&&Oo(e),e.written===0&&(e.currClient=t.id.client,e.encoder.writeClient(t.id.client),F(e.encoder.restEncoder,t.id.clock+n)),t.write(e.encoder,n),e.written++},Vs=e=>{Oo(e);const t=e.encoder.restEncoder;F(t,e.clientStructs.length);for(let n=0;n<e.clientStructs.length;n++){const r=e.clientStructs[n];F(t,r.written),Ir(t,r.restEncoder)}},du=(e,t,n,r)=>{const s=new n(We(e)),i=new Ns(s,!1),l=new r,f=new $s(l);for(let g=i.curr;g!==null;g=i.next())ee(f,t(g),0);Vs(f);const h=Ms(s);return Ke(l,h),l.toUint8Array()},pu=e=>du(e,Vl,qe,Mn),mi="You must not compute changes after the event-handler fired.";class Lr{constructor(t,n){this.target=t,this.currentTarget=t,this.transaction=n,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=gu(this.currentTarget,this.target))}deletes(t){return Ao(this.transaction.deleteSet,t.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw Rt(mi);const t=new Map,n=this.target;this.transaction.changed.get(n).forEach(s=>{if(s!==null){const i=n._map.get(s);let l,f;if(this.adds(i)){let h=i.left;for(;h!==null&&this.adds(h);)h=h.left;if(this.deletes(i))if(h!==null&&this.deletes(h))l="delete",f=Hr(h.content.getContent());else return;else h!==null&&this.deletes(h)?(l="update",f=Hr(h.content.getContent())):(l="add",f=void 0)}else if(this.deletes(i))l="delete",f=Hr(i.content.getContent());else return;t.set(s,{action:l,oldValue:f})}}),this._keys=t}return this._keys}get delta(){return this.changes.delta}adds(t){return t.id.clock>=(this.transaction.beforeState.get(t.id.client)||0)}get changes(){let t=this._changes;if(t===null){if(this.transaction.doc._transactionCleanups.length===0)throw Rt(mi);const n=this.target,r=we(),s=we(),i=[];if(t={added:r,deleted:s,delta:i,keys:this.keys},this.transaction.changed.get(n).has(null)){let f=null;const h=()=>{f&&i.push(f)};for(let g=n._start;g!==null;g=g.right)g.deleted?this.deletes(g)&&!this.adds(g)&&((f===null||f.delete===void 0)&&(h(),f={delete:0}),f.delete+=g.length,s.add(g)):this.adds(g)?((f===null||f.insert===void 0)&&(h(),f={insert:[]}),f.insert=f.insert.concat(g.content.getContent()),r.add(g)):((f===null||f.retain===void 0)&&(h(),f={retain:0}),f.retain+=g.length);f!==null&&f.retain===void 0&&h()}this._changes=t}return t}}const gu=(e,t)=>{const n=[];for(;t._item!==null&&t!==e;){if(t._item.parentSub!==null)n.unshift(t._item.parentSub);else{let r=0,s=t._item.parent._start;for(;s!==t._item&&s!==null;)!s.deleted&&s.countable&&(r+=s.length),s=s.right;n.unshift(r)}t=t._item.parent}return n},ft=()=>{Na("Invalid access: Add Yjs type to a document before reading data.")},Fo=80;let Ps=0;class mu{constructor(t,n){t.marker=!0,this.p=t,this.index=n,this.timestamp=Ps++}}const wu=e=>{e.timestamp=Ps++},No=(e,t,n)=>{e.p.marker=!1,e.p=t,t.marker=!0,e.index=n,e.timestamp=Ps++},yu=(e,t,n)=>{if(e.length>=Fo){const r=e.reduce((s,i)=>s.timestamp<i.timestamp?s:i);return No(r,t,n),r}else{const r=new mu(t,n);return e.push(r),r}},Mr=(e,t)=>{if(e._start===null||t===0||e._searchMarker===null)return null;const n=e._searchMarker.length===0?null:e._searchMarker.reduce((i,l)=>Zn(t-i.index)<Zn(t-l.index)?i:l);let r=e._start,s=0;for(n!==null&&(r=n.p,s=n.index,wu(n));r.right!==null&&s<t;){if(!r.deleted&&r.countable){if(t<s+r.length)break;s+=r.length}r=r.right}for(;r.left!==null&&s>t;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);for(;r.left!==null&&r.left.id.client===r.id.client&&r.left.id.clock+r.left.length===r.id.clock;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);return n!==null&&Zn(n.index-s)<r.parent.length/Fo?(No(n,r,s),n):yu(e._searchMarker,r,s)},En=(e,t,n)=>{for(let r=e.length-1;r>=0;r--){const s=e[r];if(n>0){let i=s.p;for(i.marker=!1;i&&(i.deleted||!i.countable);)i=i.left,i&&!i.deleted&&i.countable&&(s.index-=i.length);if(i===null||i.marker===!0){e.splice(r,1);continue}s.p=i,i.marker=!0}(t<s.index||n>0&&t===s.index)&&(s.index=Se(t,s.index+n))}},Or=(e,t,n)=>{const r=e,s=t.changedParentTypes;for(;Kt(s,e,()=>[]).push(n),e._item!==null;)e=e._item.parent;Uo(r._eH,n,t)};class lt{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=ui(),this._dEH=ui(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(t,n){this.doc=t,this._item=n}_copy(){throw Tt()}clone(){throw Tt()}_write(t){}get _first(){let t=this._start;for(;t!==null&&t.deleted;)t=t.right;return t}_callObserver(t,n){!t.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(t){hi(this._eH,t)}observeDeep(t){hi(this._dEH,t)}unobserve(t){fi(this._eH,t)}unobserveDeep(t){fi(this._dEH,t)}toJSON(){}}const $o=(e,t,n)=>{e.doc??ft(),t<0&&(t=e._length+t),n<0&&(n=e._length+n);let r=n-t;const s=[];let i=e._start;for(;i!==null&&r>0;){if(i.countable&&!i.deleted){const l=i.content.getContent();if(l.length<=t)t-=l.length;else{for(let f=t;f<l.length&&r>0;f++)s.push(l[f]),r--;t=0}}i=i.right}return s},Vo=e=>{e.doc??ft();const t=[];let n=e._start;for(;n!==null;){if(n.countable&&!n.deleted){const r=n.content.getContent();for(let s=0;s<r.length;s++)t.push(r[s])}n=n.right}return t},kn=(e,t)=>{let n=0,r=e._start;for(e.doc??ft();r!==null;){if(r.countable&&!r.deleted){const s=r.content.getContent();for(let i=0;i<s.length;i++)t(s[i],n++,e)}r=r.right}},Po=(e,t)=>{const n=[];return kn(e,(r,s)=>{n.push(t(r,s,e))}),n},bu=e=>{let t=e._start,n=null,r=0;return{[Symbol.iterator](){return this},next:()=>{if(n===null){for(;t!==null&&t.deleted;)t=t.right;if(t===null)return{done:!0,value:void 0};n=t.content.getContent(),r=0,t=t.right}const s=n[r++];return n.length<=r&&(n=null),{done:!1,value:s}}}},jo=(e,t)=>{e.doc??ft();const n=Mr(e,t);let r=e._start;for(n!==null&&(r=n.p,t-=n.index);r!==null;r=r.right)if(!r.deleted&&r.countable){if(t<r.length)return r.content.getContent()[t];t-=r.length}},gr=(e,t,n,r)=>{let s=n;const i=e.doc,l=i.clientID,f=i.store,h=n===null?t._start:n.right;let g=[];const u=()=>{g.length>0&&(s=new tt(L(l,ot(f,l)),s,s&&s.lastId,h,h&&h.id,t,null,new Ee(g)),s.integrate(e,0),g=[])};r.forEach(w=>{if(w===null)g.push(w);else switch(w.constructor){case Number:case Object:case Boolean:case Array:case String:g.push(w);break;default:switch(u(),w.constructor){case Uint8Array:case ArrayBuffer:s=new tt(L(l,ot(f,l)),s,s&&s.lastId,h,h&&h.id,t,null,new On(new Uint8Array(w))),s.integrate(e,0);break;case Xe:s=new tt(L(l,ot(f,l)),s,s&&s.lastId,h,h&&h.id,t,null,new Fn(w)),s.integrate(e,0);break;default:if(w instanceof lt)s=new tt(L(l,ot(f,l)),s,s&&s.lastId,h,h&&h.id,t,null,new Zt(w)),s.integrate(e,0);else throw new Error("Unexpected content type in insert operation")}}}),u()},Ho=()=>Rt("Length exceeded!"),qo=(e,t,n,r)=>{if(n>t._length)throw Ho();if(n===0)return t._searchMarker&&En(t._searchMarker,n,r.length),gr(e,t,null,r);const s=n,i=Mr(t,n);let l=t._start;for(i!==null&&(l=i.p,n-=i.index,n===0&&(l=l.prev,n+=l&&l.countable&&!l.deleted?l.length:0));l!==null;l=l.right)if(!l.deleted&&l.countable){if(n<=l.length){n<l.length&&ie(e,L(l.id.client,l.id.clock+n));break}n-=l.length}return t._searchMarker&&En(t._searchMarker,s,r.length),gr(e,t,l,r)},Eu=(e,t,n)=>{let s=(t._searchMarker||[]).reduce((i,l)=>l.index>i.index?l:i,{index:0,p:t._start}).p;if(s)for(;s.right;)s=s.right;return gr(e,t,s,n)},Go=(e,t,n,r)=>{if(r===0)return;const s=n,i=r,l=Mr(t,n);let f=t._start;for(l!==null&&(f=l.p,n-=l.index);f!==null&&n>0;f=f.right)!f.deleted&&f.countable&&(n<f.length&&ie(e,L(f.id.client,f.id.clock+n)),n-=f.length);for(;r>0&&f!==null;)f.deleted||(r<f.length&&ie(e,L(f.id.client,f.id.clock+r)),f.delete(e),r-=f.length),f=f.right;if(r>0)throw Ho();t._searchMarker&&En(t._searchMarker,s,-i+r)},mr=(e,t,n)=>{const r=t._map.get(n);r!==void 0&&r.delete(e)},js=(e,t,n,r)=>{const s=t._map.get(n)||null,i=e.doc,l=i.clientID;let f;if(r==null)f=new Ee([r]);else switch(r.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:f=new Ee([r]);break;case Uint8Array:f=new On(r);break;case Xe:f=new Fn(r);break;default:if(r instanceof lt)f=new Zt(r);else throw new Error("Unexpected content type")}new tt(L(l,ot(i.store,l)),s,s&&s.lastId,null,null,t,n,f).integrate(e,0)},Hs=(e,t)=>{e.doc??ft();const n=e._map.get(t);return n!==void 0&&!n.deleted?n.content.getContent()[n.length-1]:void 0},Jo=e=>{const t={};return e.doc??ft(),e._map.forEach((n,r)=>{n.deleted||(t[r]=n.content.getContent()[n.length-1])}),t},zo=(e,t)=>{e.doc??ft();const n=e._map.get(t);return n!==void 0&&!n.deleted},ku=(e,t)=>{const n={};return e._map.forEach((r,s)=>{let i=r;for(;i!==null&&(!t.sv.has(i.id.client)||i.id.clock>=(t.sv.get(i.id.client)||0));)i=i.left;i!==null&&Ue(i,t)&&(n[s]=i.content.getContent()[i.length-1])}),n},Hn=e=>(e.doc??ft(),$a(e._map.entries(),t=>!t[1].deleted));class Su extends Lr{}class $e extends lt{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(t){const n=new $e;return n.push(t),n}_integrate(t,n){super._integrate(t,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new $e}clone(){const t=new $e;return t.insert(0,this.toArray().map(n=>n instanceof lt?n.clone():n)),t}get length(){return this.doc??ft(),this._length}_callObserver(t,n){super._callObserver(t,n),Or(this,t,new Su(this,t))}insert(t,n){this.doc!==null?V(this.doc,r=>{qo(r,this,t,n)}):this._prelimContent.splice(t,0,...n)}push(t){this.doc!==null?V(this.doc,n=>{Eu(n,this,t)}):this._prelimContent.push(...t)}unshift(t){this.insert(0,t)}delete(t,n=1){this.doc!==null?V(this.doc,r=>{Go(r,this,t,n)}):this._prelimContent.splice(t,n)}get(t){return jo(this,t)}toArray(){return Vo(this)}slice(t=0,n=this.length){return $o(this,t,n)}toJSON(){return this.map(t=>t instanceof lt?t.toJSON():t)}map(t){return Po(this,t)}forEach(t){kn(this,t)}[Symbol.iterator](){return bu(this)}_write(t){t.writeTypeRef(zu)}}const _u=e=>new $e;class Au extends Lr{constructor(t,n,r){super(t,n),this.keysChanged=r}}class Ge extends lt{constructor(t){super(),this._prelimContent=null,t===void 0?this._prelimContent=new Map:this._prelimContent=new Map(t)}_integrate(t,n){super._integrate(t,n),this._prelimContent.forEach((r,s)=>{this.set(s,r)}),this._prelimContent=null}_copy(){return new Ge}clone(){const t=new Ge;return this.forEach((n,r)=>{t.set(r,n instanceof lt?n.clone():n)}),t}_callObserver(t,n){Or(this,t,new Au(this,t,n))}toJSON(){this.doc??ft();const t={};return this._map.forEach((n,r)=>{if(!n.deleted){const s=n.content.getContent()[n.length-1];t[r]=s instanceof lt?s.toJSON():s}}),t}get size(){return[...Hn(this)].length}keys(){return Kr(Hn(this),t=>t[0])}values(){return Kr(Hn(this),t=>t[1].content.getContent()[t[1].length-1])}entries(){return Kr(Hn(this),t=>[t[0],t[1].content.getContent()[t[1].length-1]])}forEach(t){this.doc??ft(),this._map.forEach((n,r)=>{n.deleted||t(n.content.getContent()[n.length-1],r,this)})}[Symbol.iterator](){return this.entries()}delete(t){this.doc!==null?V(this.doc,n=>{mr(n,this,t)}):this._prelimContent.delete(t)}set(t,n){return this.doc!==null?V(this.doc,r=>{js(r,this,t,n)}):this._prelimContent.set(t,n),n}get(t){return Hs(this,t)}has(t){return zo(this,t)}clear(){this.doc!==null?V(this.doc,t=>{this.forEach(function(n,r,s){mr(t,s,r)})}):this._prelimContent.clear()}_write(t){t.writeTypeRef(Wu)}}const xu=e=>new Ge,re=(e,t)=>e===t||typeof e=="object"&&typeof t=="object"&&e&&t&&Nl(e,t);class ds{constructor(t,n,r,s){this.left=t,this.right=n,this.index=r,this.currentAttributes=s}forward(){switch(this.right===null&&It(),this.right.content.constructor){case et:this.right.deleted||Ze(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}}const wi=(e,t,n)=>{for(;t.right!==null&&n>0;){switch(t.right.content.constructor){case et:t.right.deleted||Ze(t.currentAttributes,t.right.content);break;default:t.right.deleted||(n<t.right.length&&ie(e,L(t.right.id.client,t.right.id.clock+n)),t.index+=t.right.length,n-=t.right.length);break}t.left=t.right,t.right=t.right.right}return t},qn=(e,t,n,r)=>{const s=new Map,i=r?Mr(t,n):null;if(i){const l=new ds(i.p.left,i.p,i.index,s);return wi(e,l,n-i.index)}else{const l=new ds(null,t._start,0,s);return wi(e,l,n)}},Wo=(e,t,n,r)=>{for(;n.right!==null&&(n.right.deleted===!0||n.right.content.constructor===et&&re(r.get(n.right.content.key),n.right.content.value));)n.right.deleted||r.delete(n.right.content.key),n.forward();const s=e.doc,i=s.clientID;r.forEach((l,f)=>{const h=n.left,g=n.right,u=new tt(L(i,ot(s.store,i)),h,h&&h.lastId,g,g&&g.id,t,null,new et(f,l));u.integrate(e,0),n.right=u,n.forward()})},Ze=(e,t)=>{const{key:n,value:r}=t;r===null?e.delete(n):e.set(n,r)},Yo=(e,t)=>{for(;e.right!==null;){if(!(e.right.deleted||e.right.content.constructor===et&&re(t[e.right.content.key]??null,e.right.content.value)))break;e.forward()}},Ko=(e,t,n,r)=>{const s=e.doc,i=s.clientID,l=new Map;for(const f in r){const h=r[f],g=n.currentAttributes.get(f)??null;if(!re(g,h)){l.set(f,g);const{left:u,right:w}=n;n.right=new tt(L(i,ot(s.store,i)),u,u&&u.lastId,w,w&&w.id,t,null,new et(f,h)),n.right.integrate(e,0),n.forward()}}return l},Zr=(e,t,n,r,s)=>{n.currentAttributes.forEach((p,y)=>{s[y]===void 0&&(s[y]=null)});const i=e.doc,l=i.clientID;Yo(n,s);const f=Ko(e,t,n,s),h=r.constructor===String?new jt(r):r instanceof lt?new Zt(r):new _e(r);let{left:g,right:u,index:w}=n;t._searchMarker&&En(t._searchMarker,n.index,h.getLength()),u=new tt(L(l,ot(i.store,l)),g,g&&g.lastId,u,u&&u.id,t,null,h),u.integrate(e,0),n.right=u,n.index=w,n.forward(),Wo(e,t,n,f)},yi=(e,t,n,r,s)=>{const i=e.doc,l=i.clientID;Yo(n,s);const f=Ko(e,t,n,s);t:for(;n.right!==null&&(r>0||f.size>0&&(n.right.deleted||n.right.content.constructor===et));){if(!n.right.deleted)switch(n.right.content.constructor){case et:{const{key:h,value:g}=n.right.content,u=s[h];if(u!==void 0){if(re(u,g))f.delete(h);else{if(r===0)break t;f.set(h,g)}n.right.delete(e)}else n.currentAttributes.set(h,g);break}default:r<n.right.length&&ie(e,L(n.right.id.client,n.right.id.clock+r)),r-=n.right.length;break}n.forward()}if(r>0){let h="";for(;r>0;r--)h+=`
`;n.right=new tt(L(l,ot(i.store,l)),n.left,n.left&&n.left.lastId,n.right,n.right&&n.right.id,t,null,new jt(h)),n.right.integrate(e,0),n.forward()}Wo(e,t,n,f)},Xo=(e,t,n,r,s)=>{let i=t;const l=mt();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===et){const g=i.content;l.set(g.key,g)}i=i.right}let f=0,h=!1;for(;t!==i;){if(n===t&&(h=!0),!t.deleted){const g=t.content;switch(g.constructor){case et:{const{key:u,value:w}=g,p=r.get(u)??null;(l.get(u)!==g||p===w)&&(t.delete(e),f++,!h&&(s.get(u)??null)===w&&p!==w&&(p===null?s.delete(u):s.set(u,p))),!h&&!t.deleted&&Ze(s,g);break}}}t=t.right}return f},Iu=(e,t)=>{for(;t&&t.right&&(t.right.deleted||!t.right.countable);)t=t.right;const n=new Set;for(;t&&(t.deleted||!t.countable);){if(!t.deleted&&t.content.constructor===et){const r=t.content.key;n.has(r)?t.delete(e):n.add(r)}t=t.left}},Cu=e=>{let t=0;return V(e.doc,n=>{let r=e._start,s=e._start,i=mt();const l=is(i);for(;s;){if(s.deleted===!1)switch(s.content.constructor){case et:Ze(l,s.content);break;default:t+=Xo(n,r,s,i,l),i=is(l),r=s;break}s=s.right}}),t},Du=e=>{const t=new Set,n=e.doc;for(const[r,s]of e.afterState.entries()){const i=e.beforeState.get(r)||0;s!==i&&Lo(e,n.store.clients.get(r),i,s,l=>{!l.deleted&&l.content.constructor===et&&l.constructor!==At&&t.add(l.parent)})}V(n,r=>{_o(e,e.deleteSet,s=>{if(s instanceof At||!s.parent._hasFormatting||t.has(s.parent))return;const i=s.parent;s.content.constructor===et?t.add(i):Iu(r,s)});for(const s of t)Cu(s)})},bi=(e,t,n)=>{const r=n,s=is(t.currentAttributes),i=t.right;for(;n>0&&t.right!==null;){if(t.right.deleted===!1)switch(t.right.content.constructor){case Zt:case _e:case jt:n<t.right.length&&ie(e,L(t.right.id.client,t.right.id.clock+n)),n-=t.right.length,t.right.delete(e);break}t.forward()}i&&Xo(e,i,t.right,s,t.currentAttributes);const l=(t.left||t.right).parent;return l._searchMarker&&En(l._searchMarker,t.index,-r+n),t};class Tu extends Lr{constructor(t,n,r){super(t,n),this.childListChanged=!1,this.keysChanged=new Set,r.forEach(s=>{s===null?this.childListChanged=!0:this.keysChanged.add(s)})}get changes(){if(this._changes===null){const t={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=t}return this._changes}get delta(){if(this._delta===null){const t=this.target.doc,n=[];V(t,r=>{const s=new Map,i=new Map;let l=this.target._start,f=null;const h={};let g="",u=0,w=0;const p=()=>{if(f!==null){let y=null;switch(f){case"delete":w>0&&(y={delete:w}),w=0;break;case"insert":(typeof g=="object"||g.length>0)&&(y={insert:g},s.size>0&&(y.attributes={},s.forEach((k,_)=>{k!==null&&(y.attributes[_]=k)}))),g="";break;case"retain":u>0&&(y={retain:u},Fl(h)||(y.attributes=Ll({},h))),u=0;break}y&&n.push(y),f=null}};for(;l!==null;){switch(l.content.constructor){case Zt:case _e:this.adds(l)?this.deletes(l)||(p(),f="insert",g=l.content.getContent()[0],p()):this.deletes(l)?(f!=="delete"&&(p(),f="delete"),w+=1):l.deleted||(f!=="retain"&&(p(),f="retain"),u+=1);break;case jt:this.adds(l)?this.deletes(l)||(f!=="insert"&&(p(),f="insert"),g+=l.content.str):this.deletes(l)?(f!=="delete"&&(p(),f="delete"),w+=l.length):l.deleted||(f!=="retain"&&(p(),f="retain"),u+=l.length);break;case et:{const{key:y,value:k}=l.content;if(this.adds(l)){if(!this.deletes(l)){const _=s.get(y)??null;re(_,k)?k!==null&&l.delete(r):(f==="retain"&&p(),re(k,i.get(y)??null)?delete h[y]:h[y]=k)}}else if(this.deletes(l)){i.set(y,k);const _=s.get(y)??null;re(_,k)||(f==="retain"&&p(),h[y]=_)}else if(!l.deleted){i.set(y,k);const _=h[y];_!==void 0&&(re(_,k)?_!==null&&l.delete(r):(f==="retain"&&p(),k===null?delete h[y]:h[y]=k))}l.deleted||(f==="insert"&&p(),Ze(s,l.content));break}}l=l.right}for(p();n.length>0;){const y=n[n.length-1];if(y.retain!==void 0&&y.attributes===void 0)n.pop();else break}}),this._delta=n}return this._delta}}class Je extends lt{constructor(t){super(),this._pending=t!==void 0?[()=>this.insert(0,t)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??ft(),this._length}_integrate(t,n){super._integrate(t,n);try{this._pending.forEach(r=>r())}catch(r){console.error(r)}this._pending=null}_copy(){return new Je}clone(){const t=new Je;return t.applyDelta(this.toDelta()),t}_callObserver(t,n){super._callObserver(t,n);const r=new Tu(this,t,n);Or(this,t,r),!t.local&&this._hasFormatting&&(t._needFormattingCleanup=!0)}toString(){this.doc??ft();let t="",n=this._start;for(;n!==null;)!n.deleted&&n.countable&&n.content.constructor===jt&&(t+=n.content.str),n=n.right;return t}toJSON(){return this.toString()}applyDelta(t,{sanitize:n=!0}={}){this.doc!==null?V(this.doc,r=>{const s=new ds(null,this._start,0,new Map);for(let i=0;i<t.length;i++){const l=t[i];if(l.insert!==void 0){const f=!n&&typeof l.insert=="string"&&i===t.length-1&&s.right===null&&l.insert.slice(-1)===`
`?l.insert.slice(0,-1):l.insert;(typeof f!="string"||f.length>0)&&Zr(r,this,s,f,l.attributes||{})}else l.retain!==void 0?yi(r,this,s,l.retain,l.attributes||{}):l.delete!==void 0&&bi(r,s,l.delete)}}):this._pending.push(()=>this.applyDelta(t))}toDelta(t,n,r){this.doc??ft();const s=[],i=new Map,l=this.doc;let f="",h=this._start;function g(){if(f.length>0){const w={};let p=!1;i.forEach((k,_)=>{p=!0,w[_]=k});const y={insert:f};p&&(y.attributes=w),s.push(y),f=""}}const u=()=>{for(;h!==null;){if(Ue(h,t)||n!==void 0&&Ue(h,n))switch(h.content.constructor){case jt:{const w=i.get("ychange");t!==void 0&&!Ue(h,t)?(w===void 0||w.user!==h.id.client||w.type!=="removed")&&(g(),i.set("ychange",r?r("removed",h.id):{type:"removed"})):n!==void 0&&!Ue(h,n)?(w===void 0||w.user!==h.id.client||w.type!=="added")&&(g(),i.set("ychange",r?r("added",h.id):{type:"added"})):w!==void 0&&(g(),i.delete("ychange")),f+=h.content.str;break}case Zt:case _e:{g();const w={insert:h.content.getContent()[0]};if(i.size>0){const p={};w.attributes=p,i.forEach((y,k)=>{p[k]=y})}s.push(w);break}case et:Ue(h,t)&&(g(),Ze(i,h.content));break}h=h.right}g()};return t||n?V(l,w=>{t&&hs(w,t),n&&hs(w,n),u()},"cleanup"):u(),s}insert(t,n,r){if(n.length<=0)return;const s=this.doc;s!==null?V(s,i=>{const l=qn(i,this,t,!r);r||(r={},l.currentAttributes.forEach((f,h)=>{r[h]=f})),Zr(i,this,l,n,r)}):this._pending.push(()=>this.insert(t,n,r))}insertEmbed(t,n,r){const s=this.doc;s!==null?V(s,i=>{const l=qn(i,this,t,!r);Zr(i,this,l,n,r||{})}):this._pending.push(()=>this.insertEmbed(t,n,r||{}))}delete(t,n){if(n===0)return;const r=this.doc;r!==null?V(r,s=>{bi(s,qn(s,this,t,!0),n)}):this._pending.push(()=>this.delete(t,n))}format(t,n,r){if(n===0)return;const s=this.doc;s!==null?V(s,i=>{const l=qn(i,this,t,!1);l.right!==null&&yi(i,this,l,n,r)}):this._pending.push(()=>this.format(t,n,r))}removeAttribute(t){this.doc!==null?V(this.doc,n=>{mr(n,this,t)}):this._pending.push(()=>this.removeAttribute(t))}setAttribute(t,n){this.doc!==null?V(this.doc,r=>{js(r,this,t,n)}):this._pending.push(()=>this.setAttribute(t,n))}getAttribute(t){return Hs(this,t)}getAttributes(){return Jo(this)}_write(t){t.writeTypeRef(Yu)}}const Ru=e=>new Je;class Qr{constructor(t,n=()=>!0){this._filter=n,this._root=t,this._currentNode=t._start,this._firstCall=!0,t.doc??ft()}[Symbol.iterator](){return this}next(){let t=this._currentNode,n=t&&t.content&&t.content.type;if(t!==null&&(!this._firstCall||t.deleted||!this._filter(n)))do if(n=t.content.type,!t.deleted&&(n.constructor===ze||n.constructor===be)&&n._start!==null)t=n._start;else for(;t!==null;){const r=t.next;if(r!==null){t=r;break}else t.parent===this._root?t=null:t=t.parent._item}while(t!==null&&(t.deleted||!this._filter(t.content.type)));return this._firstCall=!1,t===null?{value:void 0,done:!0}:(this._currentNode=t,{value:t.content.type,done:!1})}}class be extends lt{constructor(){super(),this._prelimContent=[]}get firstChild(){const t=this._first;return t?t.content.getContent()[0]:null}_integrate(t,n){super._integrate(t,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new be}clone(){const t=new be;return t.insert(0,this.toArray().map(n=>n instanceof lt?n.clone():n)),t}get length(){return this.doc??ft(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(t){return new Qr(this,t)}querySelector(t){t=t.toUpperCase();const r=new Qr(this,s=>s.nodeName&&s.nodeName.toUpperCase()===t).next();return r.done?null:r.value}querySelectorAll(t){return t=t.toUpperCase(),se(new Qr(this,n=>n.nodeName&&n.nodeName.toUpperCase()===t))}_callObserver(t,n){Or(this,t,new vu(this,n,t))}toString(){return Po(this,t=>t.toString()).join("")}toJSON(){return this.toString()}toDOM(t=document,n={},r){const s=t.createDocumentFragment();return r!==void 0&&r._createAssociation(s,this),kn(this,i=>{s.insertBefore(i.toDOM(t,n,r),null)}),s}insert(t,n){this.doc!==null?V(this.doc,r=>{qo(r,this,t,n)}):this._prelimContent.splice(t,0,...n)}insertAfter(t,n){if(this.doc!==null)V(this.doc,r=>{const s=t&&t instanceof lt?t._item:t;gr(r,this,s,n)});else{const r=this._prelimContent,s=t===null?0:r.findIndex(i=>i===t)+1;if(s===0&&t!==null)throw Rt("Reference item not found");r.splice(s,0,...n)}}delete(t,n=1){this.doc!==null?V(this.doc,r=>{Go(r,this,t,n)}):this._prelimContent.splice(t,n)}toArray(){return Vo(this)}push(t){this.insert(this.length,t)}unshift(t){this.insert(0,t)}get(t){return jo(this,t)}slice(t=0,n=this.length){return $o(this,t,n)}forEach(t){kn(this,t)}_write(t){t.writeTypeRef(Xu)}}const Uu=e=>new be;class ze extends be{constructor(t="UNDEFINED"){super(),this.nodeName=t,this._prelimAttrs=new Map}get nextSibling(){const t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){const t=this._item?this._item.prev:null;return t?t.content.type:null}_integrate(t,n){super._integrate(t,n),this._prelimAttrs.forEach((r,s)=>{this.setAttribute(s,r)}),this._prelimAttrs=null}_copy(){return new ze(this.nodeName)}clone(){const t=new ze(this.nodeName),n=this.getAttributes();return Ol(n,(r,s)=>{t.setAttribute(s,r)}),t.insert(0,this.toArray().map(r=>r instanceof lt?r.clone():r)),t}toString(){const t=this.getAttributes(),n=[],r=[];for(const f in t)r.push(f);r.sort();const s=r.length;for(let f=0;f<s;f++){const h=r[f];n.push(h+'="'+t[h]+'"')}const i=this.nodeName.toLocaleLowerCase(),l=n.length>0?" "+n.join(" "):"";return`<${i}${l}>${super.toString()}</${i}>`}removeAttribute(t){this.doc!==null?V(this.doc,n=>{mr(n,this,t)}):this._prelimAttrs.delete(t)}setAttribute(t,n){this.doc!==null?V(this.doc,r=>{js(r,this,t,n)}):this._prelimAttrs.set(t,n)}getAttribute(t){return Hs(this,t)}hasAttribute(t){return zo(this,t)}getAttributes(t){return t?ku(this,t):Jo(this)}toDOM(t=document,n={},r){const s=t.createElement(this.nodeName),i=this.getAttributes();for(const l in i){const f=i[l];typeof f=="string"&&s.setAttribute(l,f)}return kn(this,l=>{s.appendChild(l.toDOM(t,n,r))}),r!==void 0&&r._createAssociation(s,this),s}_write(t){t.writeTypeRef(Ku),t.writeKey(this.nodeName)}}const Bu=e=>new ze(e.readKey());class vu extends Lr{constructor(t,n,r){super(t,r),this.childListChanged=!1,this.attributesChanged=new Set,n.forEach(s=>{s===null?this.childListChanged=!0:this.attributesChanged.add(s)})}}class wr extends Ge{constructor(t){super(),this.hookName=t}_copy(){return new wr(this.hookName)}clone(){const t=new wr(this.hookName);return this.forEach((n,r)=>{t.set(r,n)}),t}toDOM(t=document,n={},r){const s=n[this.hookName];let i;return s!==void 0?i=s.createDom(this):i=document.createElement(this.hookName),i.setAttribute("data-yjs-hook",this.hookName),r!==void 0&&r._createAssociation(i,this),i}_write(t){t.writeTypeRef(Zu),t.writeKey(this.hookName)}}const Lu=e=>new wr(e.readKey());class yr extends Je{get nextSibling(){const t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){const t=this._item?this._item.prev:null;return t?t.content.type:null}_copy(){return new yr}clone(){const t=new yr;return t.applyDelta(this.toDelta()),t}toDOM(t=document,n,r){const s=t.createTextNode(this.toString());return r!==void 0&&r._createAssociation(s,this),s}toString(){return this.toDelta().map(t=>{const n=[];for(const s in t.attributes){const i=[];for(const l in t.attributes[s])i.push({key:l,value:t.attributes[s][l]});i.sort((l,f)=>l.key<f.key?-1:1),n.push({nodeName:s,attrs:i})}n.sort((s,i)=>s.nodeName<i.nodeName?-1:1);let r="";for(let s=0;s<n.length;s++){const i=n[s];r+=`<${i.nodeName}`;for(let l=0;l<i.attrs.length;l++){const f=i.attrs[l];r+=` ${f.key}="${f.value}"`}r+=">"}r+=t.insert;for(let s=n.length-1;s>=0;s--)r+=`</${n[s].nodeName}>`;return r}).join("")}toJSON(){return this.toString()}_write(t){t.writeTypeRef(Qu)}}const Mu=e=>new yr;class qs{constructor(t,n){this.id=t,this.length=n}get deleted(){throw Tt()}mergeWith(t){return!1}write(t,n,r){throw Tt()}integrate(t,n){throw Tt()}}const Ou=0;class At extends qs{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,n){n>0&&(this.id.clock+=n,this.length-=n),vo(t.doc.store,this)}write(t,n){t.writeInfo(Ou),t.writeLen(this.length-n)}getMissing(t,n){return null}}class On{constructor(t){this.content=t}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new On(this.content)}splice(t){throw Tt()}mergeWith(t){return!1}integrate(t,n){}delete(t){}gc(t){}write(t,n){t.writeBuf(this.content)}getRef(){return 3}}const Fu=e=>new On(e.readBuf());class Sn{constructor(t){this.len=t}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new Sn(this.len)}splice(t){const n=new Sn(this.len-t);return this.len=t,n}mergeWith(t){return this.len+=t.len,!0}integrate(t,n){dr(t.deleteSet,n.id.client,n.id.clock,this.len),n.markDeleted()}delete(t){}gc(t){}write(t,n){t.writeLen(this.len-n)}getRef(){return 1}}const Nu=e=>new Sn(e.readLen()),Zo=(e,t)=>new Xe({guid:e,...t,shouldLoad:t.shouldLoad||t.autoLoad||!1});class Fn{constructor(t){t._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=t;const n={};this.opts=n,t.gc||(n.gc=!1),t.autoLoad&&(n.autoLoad=!0),t.meta!==null&&(n.meta=t.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new Fn(Zo(this.doc.guid,this.opts))}splice(t){throw Tt()}mergeWith(t){return!1}integrate(t,n){this.doc._item=n,t.subdocsAdded.add(this.doc),this.doc.shouldLoad&&t.subdocsLoaded.add(this.doc)}delete(t){t.subdocsAdded.has(this.doc)?t.subdocsAdded.delete(this.doc):t.subdocsRemoved.add(this.doc)}gc(t){}write(t,n){t.writeString(this.doc.guid),t.writeAny(this.opts)}getRef(){return 9}}const $u=e=>new Fn(Zo(e.readString(),e.readAny()));class _e{constructor(t){this.embed=t}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new _e(this.embed)}splice(t){throw Tt()}mergeWith(t){return!1}integrate(t,n){}delete(t){}gc(t){}write(t,n){t.writeJSON(this.embed)}getRef(){return 5}}const Vu=e=>new _e(e.readJSON());class et{constructor(t,n){this.key=t,this.value=n}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new et(this.key,this.value)}splice(t){throw Tt()}mergeWith(t){return!1}integrate(t,n){const r=n.parent;r._searchMarker=null,r._hasFormatting=!0}delete(t){}gc(t){}write(t,n){t.writeKey(this.key),t.writeJSON(this.value)}getRef(){return 6}}const Pu=e=>new et(e.readKey(),e.readJSON());class br{constructor(t){this.arr=t}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new br(this.arr)}splice(t){const n=new br(this.arr.slice(t));return this.arr=this.arr.slice(0,t),n}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,n){}delete(t){}gc(t){}write(t,n){const r=this.arr.length;t.writeLen(r-n);for(let s=n;s<r;s++){const i=this.arr[s];t.writeString(i===void 0?"undefined":JSON.stringify(i))}}getRef(){return 2}}const ju=e=>{const t=e.readLen(),n=[];for(let r=0;r<t;r++){const s=e.readString();s==="undefined"?n.push(void 0):n.push(JSON.parse(s))}return new br(n)},Hu=ur("node_env")==="development";class Ee{constructor(t){this.arr=t,Hu&&Xi(t)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Ee(this.arr)}splice(t){const n=new Ee(this.arr.slice(t));return this.arr=this.arr.slice(0,t),n}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,n){}delete(t){}gc(t){}write(t,n){const r=this.arr.length;t.writeLen(r-n);for(let s=n;s<r;s++){const i=this.arr[s];t.writeAny(i)}}getRef(){return 8}}const qu=e=>{const t=e.readLen(),n=[];for(let r=0;r<t;r++)n.push(e.readAny());return new Ee(n)};class jt{constructor(t){this.str=t}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new jt(this.str)}splice(t){const n=new jt(this.str.slice(t));this.str=this.str.slice(0,t);const r=this.str.charCodeAt(t-1);return r>=55296&&r<=56319&&(this.str=this.str.slice(0,t-1)+"",n.str=""+n.str.slice(1)),n}mergeWith(t){return this.str+=t.str,!0}integrate(t,n){}delete(t){}gc(t){}write(t,n){t.writeString(n===0?this.str:this.str.slice(n))}getRef(){return 4}}const Gu=e=>new jt(e.readString()),Ju=[_u,xu,Ru,Bu,Uu,Lu,Mu],zu=0,Wu=1,Yu=2,Ku=3,Xu=4,Zu=5,Qu=6;class Zt{constructor(t){this.type=t}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new Zt(this.type._copy())}splice(t){throw Tt()}mergeWith(t){return!1}integrate(t,n){this.type._integrate(t.doc,n)}delete(t){let n=this.type._start;for(;n!==null;)n.deleted?n.id.clock<(t.beforeState.get(n.id.client)||0)&&t._mergeStructs.push(n):n.delete(t),n=n.right;this.type._map.forEach(r=>{r.deleted?r.id.clock<(t.beforeState.get(r.id.client)||0)&&t._mergeStructs.push(r):r.delete(t)}),t.changed.delete(this.type)}gc(t){let n=this.type._start;for(;n!==null;)n.gc(t,!0),n=n.right;this.type._start=null,this.type._map.forEach(r=>{for(;r!==null;)r.gc(t,!0),r=r.left}),this.type._map=new Map}write(t,n){this.type._write(t)}getRef(){return 7}}const th=e=>new Zt(Ju[e.readTypeRef()](e)),Er=(e,t,n)=>{const{client:r,clock:s}=t.id,i=new tt(L(r,s+n),t,L(r,s+n-1),t.right,t.rightOrigin,t.parent,t.parentSub,t.content.splice(n));return t.deleted&&i.markDeleted(),t.keep&&(i.keep=!0),t.redone!==null&&(i.redone=L(t.redone.client,t.redone.clock+n)),t.right=i,i.right!==null&&(i.right.left=i),e._mergeStructs.push(i),i.parentSub!==null&&i.right===null&&i.parent._map.set(i.parentSub,i),t.length=n,i};class tt extends qs{constructor(t,n,r,s,i,l,f,h){super(t,h.getLength()),this.origin=r,this.left=n,this.right=s,this.rightOrigin=i,this.parent=l,this.parentSub=f,this.redone=null,this.content=h,this.info=this.content.isCountable()?Zs:0}set marker(t){(this.info&Gr)>0!==t&&(this.info^=Gr)}get marker(){return(this.info&Gr)>0}get keep(){return(this.info&Xs)>0}set keep(t){this.keep!==t&&(this.info^=Xs)}get countable(){return(this.info&Zs)>0}get deleted(){return(this.info&qr)>0}set deleted(t){this.deleted!==t&&(this.info^=qr)}markDeleted(){this.info|=qr}getMissing(t,n){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=ot(n,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=ot(n,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===Ne&&this.id.client!==this.parent.client&&this.parent.clock>=ot(n,this.parent.client))return this.parent.client;if(this.origin&&(this.left=di(t,n,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=ie(t,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===At||this.right&&this.right.constructor===At)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===tt?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===tt&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===Ne){const r=Xr(n,this.parent);r.constructor===At?this.parent=null:this.parent=r.content.type}return null}integrate(t,n){if(n>0&&(this.id.clock+=n,this.left=di(t,t.doc.store,L(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(n),this.length-=n),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let r=this.left,s;if(r!==null)s=r.right;else if(this.parentSub!==null)for(s=this.parent._map.get(this.parentSub)||null;s!==null&&s.left!==null;)s=s.left;else s=this.parent._start;const i=new Set,l=new Set;for(;s!==null&&s!==this.right;){if(l.add(s),i.add(s),jn(this.origin,s.origin)){if(s.id.client<this.id.client)r=s,i.clear();else if(jn(this.rightOrigin,s.rightOrigin))break}else if(s.origin!==null&&l.has(Xr(t.doc.store,s.origin)))i.has(Xr(t.doc.store,s.origin))||(r=s,i.clear());else break;s=s.right}this.left=r}if(this.left!==null){const r=this.left.right;this.right=r,this.left.right=this}else{let r;if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start,this.parent._start=this;this.right=r}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(t)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),vo(t.doc.store,this),this.content.integrate(t,this),gi(t,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(t)}else new At(this.id,this.length).integrate(t,0)}get next(){let t=this.right;for(;t!==null&&t.deleted;)t=t.right;return t}get prev(){let t=this.left;for(;t!==null&&t.deleted;)t=t.left;return t}get lastId(){return this.length===1?this.id:L(this.id.client,this.id.clock+this.length-1)}mergeWith(t){if(this.constructor===t.constructor&&jn(t.origin,this.lastId)&&this.right===t&&jn(this.rightOrigin,t.rightOrigin)&&this.id.client===t.id.client&&this.id.clock+this.length===t.id.clock&&this.deleted===t.deleted&&this.redone===null&&t.redone===null&&this.content.constructor===t.content.constructor&&this.content.mergeWith(t.content)){const n=this.parent._searchMarker;return n&&n.forEach(r=>{r.p===t&&(r.p=this,!this.deleted&&this.countable&&(r.index-=this.length))}),t.keep&&(this.keep=!0),this.right=t.right,this.right!==null&&(this.right.left=this),this.length+=t.length,!0}return!1}delete(t){if(!this.deleted){const n=this.parent;this.countable&&this.parentSub===null&&(n._length-=this.length),this.markDeleted(),dr(t.deleteSet,this.id.client,this.id.clock,this.length),gi(t,n,this.parentSub),this.content.delete(t)}}gc(t,n){if(!this.deleted)throw It();this.content.gc(t),n?iu(t,this,new At(this.id,this.length)):this.content=new Sn(this.length)}write(t,n){const r=n>0?L(this.id.client,this.id.clock+n-1):this.origin,s=this.rightOrigin,i=this.parentSub,l=this.content.getRef()&Ar|(r===null?0:Et)|(s===null?0:Wt)|(i===null?0:dn);if(t.writeInfo(l),r!==null&&t.writeLeftID(r),s!==null&&t.writeRightID(s),r===null&&s===null){const f=this.parent;if(f._item!==void 0){const h=f._item;if(h===null){const g=ru(f);t.writeParentInfo(!0),t.writeString(g)}else t.writeParentInfo(!1),t.writeLeftID(h.id)}else f.constructor===String?(t.writeParentInfo(!0),t.writeString(f)):f.constructor===Ne?(t.writeParentInfo(!1),t.writeLeftID(f)):It();i!==null&&t.writeString(i)}this.content.write(t,n)}}const Qo=(e,t)=>eh[t&Ar](e),eh=[()=>{It()},Nu,ju,Fu,Gu,Vu,Pu,th,qu,$u,()=>{It()}],nh=10;class xt extends qs{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,n){It()}write(t,n){t.writeInfo(nh),F(t.restEncoder,this.length-n)}getMissing(t,n){return null}}const tc=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof Ks<"u"?Ks:{},ec="__ $YJS$ __";tc[ec]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");tc[ec]=!0;const Ae=e=>je((t,n)=>{e.onerror=r=>n(new Error(r.target.error)),e.onsuccess=r=>t(r.target.result)}),rh=(e,t)=>je((n,r)=>{const s=indexedDB.open(e);s.onupgradeneeded=i=>t(i.target.result),s.onerror=i=>r(Rt(i.target.error)),s.onsuccess=i=>{const l=i.target.result;l.onversionchange=()=>{l.close()},n(l)}}),sh=e=>Ae(indexedDB.deleteDatabase(e)),ih=(e,t)=>t.forEach(n=>e.createObjectStore.apply(e,n)),on=(e,t,n="readwrite")=>{const r=e.transaction(t,n);return t.map(s=>dh(r,s))},nc=(e,t)=>Ae(e.count(t)),oh=(e,t)=>Ae(e.get(t)),rc=(e,t)=>Ae(e.delete(t)),ch=(e,t,n)=>Ae(e.put(t,n)),ps=(e,t)=>Ae(e.add(t)),lh=(e,t,n)=>Ae(e.getAll(t,n)),ah=(e,t,n)=>{let r=null;return fh(e,t,s=>(r=s,!1),n).then(()=>r)},uh=(e,t=null)=>ah(e,t,"prev"),hh=(e,t)=>je((n,r)=>{e.onerror=r,e.onsuccess=async s=>{const i=s.target.result;if(i===null||await t(i)===!1)return n();i.continue()}}),fh=(e,t,n,r="next")=>hh(e.openKeyCursor(t,r),s=>n(s.key)),dh=(e,t)=>e.objectStore(t),ph=(e,t)=>IDBKeyRange.upperBound(e,t),gh=(e,t)=>IDBKeyRange.lowerBound(e,t),ts="custom",sc="updates",ic=500,oc=(e,t=()=>{},n=()=>{})=>{const[r]=on(e.db,[sc]);return lh(r,gh(e._dbref,!1)).then(s=>{e._destroyed||(t(r),V(e.doc,()=>{s.forEach(i=>Za(e.doc,i))},e,!1),n(r))}).then(()=>uh(r).then(s=>{e._dbref=s+1})).then(()=>nc(r).then(s=>{e._dbsize=s})).then(()=>r)},mh=(e,t=!0)=>oc(e).then(n=>{(t||e._dbsize>=ic)&&ps(n,To(e.doc)).then(()=>rc(n,ph(e._dbref,!0))).then(()=>nc(n).then(r=>{e._dbsize=r}))});class wh extends Kc{constructor(t,n){super(),this.doc=n,this.name=t,this._dbref=0,this._dbsize=0,this._destroyed=!1,this.db=null,this.synced=!1,this._db=rh(t,r=>ih(r,[["updates",{autoIncrement:!0}],["custom"]])),this.whenSynced=je(r=>this.on("synced",()=>r(this))),this._db.then(r=>{this.db=r,oc(this,l=>ps(l,To(n)),()=>{if(this._destroyed)return this;this.synced=!0,this.emit("synced",[this])})}),this._storeTimeout=1e3,this._storeTimeoutId=null,this._storeUpdate=(r,s)=>{if(this.db&&s!==this){const[i]=on(this.db,[sc]);ps(i,r),++this._dbsize>=ic&&(this._storeTimeoutId!==null&&clearTimeout(this._storeTimeoutId),this._storeTimeoutId=setTimeout(()=>{mh(this,!1),this._storeTimeoutId=null},this._storeTimeout))}},n.on("update",this._storeUpdate),this.destroy=this.destroy.bind(this),n.on("destroy",this.destroy)}destroy(){return this._storeTimeoutId&&clearTimeout(this._storeTimeoutId),this.doc.off("update",this._storeUpdate),this.doc.off("destroy",this.destroy),this._destroyed=!0,this._db.then(t=>{t.close()})}clearData(){return this.destroy().then(()=>{sh(this.name)})}get(t){return this._db.then(n=>{const[r]=on(n,[ts],"readonly");return oh(r,t)})}set(t,n){return this._db.then(r=>{const[s]=on(r,[ts]);return ch(s,n,t)})}del(t){return this._db.then(n=>{const[r]=on(n,[ts]);return rc(r,t)})}}const cc="schwalbvault",oe=new Xe,yh=typeof window<"u",rr=yh?new wh(cc,oe):null,bh=oe.getMap("characters"),cn=oe.getMap("campaigns"),Eh=oe.getMap("enemies"),kh=oe.getMap("encounters"),Sh=oe.getMap("images"),_h=oe.getMap("deletedIds"),Ah=()=>new Promise(e=>{if(!rr){e();return}rr.synced?e():rr.on("synced",()=>{e()})}),Cf=Object.freeze(Object.defineProperty({__proto__:null,campaignsMap:cn,charactersMap:bh,deletedIdsMap:_h,doc:oe,encountersMap:kh,enemiesMap:Eh,imagesMap:Sh,provider:rr,waitForSync:Ah},Symbol.toStringTag,{value:"Module"}));const Gn="0123456789abcdef";class de{constructor(t){this.bytes=t}static ofInner(t){if(t.length!==16)throw new TypeError("not 128-bit length");return new de(t)}static fromFieldsV7(t,n,r,s){if(!Number.isInteger(t)||!Number.isInteger(n)||!Number.isInteger(r)||!Number.isInteger(s)||t<0||n<0||r<0||s<0||t>0xffffffffffff||n>4095||r>1073741823||s>4294967295)throw new RangeError("invalid field value");const i=new Uint8Array(16);return i[0]=t/2**40,i[1]=t/2**32,i[2]=t/2**24,i[3]=t/2**16,i[4]=t/2**8,i[5]=t,i[6]=112|n>>>8,i[7]=n,i[8]=128|r>>>24,i[9]=r>>>16,i[10]=r>>>8,i[11]=r,i[12]=s>>>24,i[13]=s>>>16,i[14]=s>>>8,i[15]=s,new de(i)}static parse(t){var n,r,s,i;let l;switch(t.length){case 32:l=(n=/^[0-9a-f]{32}$/i.exec(t))===null||n===void 0?void 0:n[0];break;case 36:l=(r=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(t))===null||r===void 0?void 0:r.slice(1,6).join("");break;case 38:l=(s=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(t))===null||s===void 0?void 0:s.slice(1,6).join("");break;case 45:l=(i=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(t))===null||i===void 0?void 0:i.slice(1,6).join("");break}if(l){const f=new Uint8Array(16);for(let h=0;h<16;h+=4){const g=parseInt(l.substring(2*h,2*h+8),16);f[h+0]=g>>>24,f[h+1]=g>>>16,f[h+2]=g>>>8,f[h+3]=g}return new de(f)}else throw new SyntaxError("could not parse UUID string")}toString(){let t="";for(let n=0;n<this.bytes.length;n++)t+=Gn.charAt(this.bytes[n]>>>4),t+=Gn.charAt(this.bytes[n]&15),(n===3||n===5||n===7||n===9)&&(t+="-");return t}toHex(){let t="";for(let n=0;n<this.bytes.length;n++)t+=Gn.charAt(this.bytes[n]>>>4),t+=Gn.charAt(this.bytes[n]&15);return t}toJSON(){return this.toString()}getVariant(){const t=this.bytes[8]>>>4;if(t<0)throw new Error("unreachable");if(t<=7)return this.bytes.every(n=>n===0)?"NIL":"VAR_0";if(t<=11)return"VAR_10";if(t<=13)return"VAR_110";if(t<=15)return this.bytes.every(n=>n===255)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return this.getVariant()==="VAR_10"?this.bytes[6]>>>4:void 0}clone(){return new de(this.bytes.slice(0))}equals(t){return this.compareTo(t)===0}compareTo(t){for(let n=0;n<16;n++){const r=this.bytes[n]-t.bytes[n];if(r!==0)return Math.sign(r)}return 0}}class xh{constructor(t){this.timestamp_biased=0,this.counter=0,this.random=t??Ih()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(t,n){let r=this.generateOrAbortCore(t,n);return r===void 0&&(this.timestamp_biased=0,r=this.generateOrAbortCore(t,n)),r}generateOrAbortCore(t,n){if(!Number.isInteger(t)||t<0||t>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit unsigned integer");if(n<0||n>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(t++,t>this.timestamp_biased)this.timestamp_biased=t,this.resetCounter();else if(t+n>=this.timestamp_biased)this.counter++,this.counter>4398046511103&&(this.timestamp_biased++,this.resetCounter());else return;return de.fromFieldsV7(this.timestamp_biased-1,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=this.random.nextUint32()*1024+(this.random.nextUint32()&1023)}generateV4(){const t=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return t[6]=64|t[6]>>>4,t[8]=128|t[8]>>>2,de.ofInner(t)}}const Ih=()=>{if(typeof crypto<"u"&&typeof crypto.getRandomValues<"u")return new Ch;if(typeof UUIDV7_DENY_WEAK_RNG<"u"&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>Math.trunc(Math.random()*65536)*65536+Math.trunc(Math.random()*65536)}};class Ch{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}let Ei;const ki=()=>Dh().toString(),Dh=()=>(Ei||(Ei=new xh)).generate(),{floor:Th,random:Rh}=Math,_n="Trystero",An=(e,t)=>Array(e).fill().map(t),Si="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",lc=e=>An(e,()=>Si[Th(Rh()*Si.length)]).join(""),Be=lc(20),he=Promise.all.bind(Promise),ac=typeof window<"u",{entries:gs,fromEntries:uc,keys:Uh}=Object,Gt=()=>{},Jt=e=>new Error(`${_n}: ${e}`),Bh=new TextEncoder,vh=new TextDecoder,Ve=e=>Bh.encode(e),sr=e=>vh.decode(e),Jn=(...e)=>e.join("@"),Lh=(e,t,n,r)=>(e.relayUrls||t).slice(0,e.relayUrls?e.relayUrls.length:e.relayRedundancy||n),xn=JSON.stringify,In=JSON.parse,_i=3333,zn={};let fn=null,ms=null;const Mh=()=>{fn||(fn=new Promise(e=>{ms=e}).finally(()=>{ms=null,fn=null}))},Oh=()=>ms?.(),Fh=(e,t)=>{const n={},r=()=>{const s=new WebSocket(e);s.onclose=()=>{if(fn){fn.then(r);return}zn[e]??=_i,setTimeout(r,zn[e]),zn[e]*=2},s.onmessage=i=>t(i.data),n.socket=s,n.url=s.url,n.ready=new Promise(i=>s.onopen=()=>{i(n),zn[e]=_i}),n.send=i=>{s.readyState===1&&s.send(i)}};return r(),n},Nh=()=>{if(ac){const e=new AbortController;return addEventListener("online",Oh,{signal:e.signal}),addEventListener("offline",Mh,{signal:e.signal}),()=>e.abort()}return Gt},Gs="AES-GCM",$h={},Vh=e=>btoa(String.fromCharCode.apply(null,new Uint8Array(e))),Ph=e=>{const t=atob(e);return new Uint8Array(t.length).map((n,r)=>t.charCodeAt(r)).buffer},jh=async(e,t)=>new Uint8Array(await crypto.subtle.digest(e,Ve(t))),ln=async e=>$h[e]||=Array.from(await jh("SHA-1",e)).map(t=>t.toString(36)).join(""),Hh=async(e,t,n)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},Ve(`${e}:${t}:${n}`)),{name:Gs},!1,["encrypt","decrypt"]),hc="$",fc=",",qh=async(e,t)=>{const n=crypto.getRandomValues(new Uint8Array(16));return n.join(fc)+hc+Vh(await crypto.subtle.encrypt({name:Gs,iv:n},await e,Ve(t)))},Gh=async(e,t)=>{const[n,r]=t.split(hc);return sr(await crypto.subtle.decrypt({name:Gs,iv:new Uint8Array(n.split(fc))},await e,Ph(r)))},Jh=5e3,Ai="icegatheringstatechange",xi="offer",zh="answer",Ii=(e,{rtcConfig:t,rtcPolyfill:n,turnConfig:r})=>{const s=new(n||RTCPeerConnection)({iceServers:Wh.concat(r||[]),...t}),i={};let l=!1,f=!1,h=null;const g=w=>{w.binaryType="arraybuffer",w.bufferedAmountLowThreshold=65535,w.onmessage=p=>i.data?.(p.data),w.onopen=()=>i.connect?.(),w.onclose=()=>i.close?.(),w.onerror=p=>i.error?.(p)},u=w=>Promise.race([new Promise(p=>{const y=()=>{w.iceGatheringState==="complete"&&(w.removeEventListener(Ai,y),p())};w.addEventListener(Ai,y),y()}),new Promise(p=>setTimeout(p,Jh))]).then(()=>({type:w.localDescription.type,sdp:w.localDescription.sdp.replace(/a=ice-options:trickle\s\n/g,"")}));return e?(h=s.createDataChannel("data"),g(h)):s.ondatachannel=({channel:w})=>{h=w,g(w)},s.onnegotiationneeded=async()=>{try{l=!0,await s.setLocalDescription();const w=await u(s);i.signal?.(w)}catch(w){i.error?.(w)}finally{l=!1}},s.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(s.connectionState)&&i.close?.()},s.ontrack=w=>{i.track?.(w.track,w.streams[0]),i.stream?.(w.streams[0])},s.onremovestream=w=>i.stream?.(w.stream),e&&(s.canTrickleIceCandidates||s.onnegotiationneeded()),{created:Date.now(),connection:s,get channel(){return h},get isDead(){return s.connectionState==="closed"},async signal(w){if(!(h?.readyState==="open"&&!w.sdp?.includes("a=rtpmap")))try{if(w.type===xi){if(l||s.signalingState!=="stable"&&!f){if(e)return;await he([s.setLocalDescription({type:"rollback"}),s.setRemoteDescription(w)])}else await s.setRemoteDescription(w);await s.setLocalDescription();const p=await u(s);return i.signal?.(p),p}else if(w.type===zh){f=!0;try{await s.setRemoteDescription(w)}finally{f=!1}}}catch(p){i.error?.(p)}},sendData:w=>h.send(w),destroy:()=>{h?.close(),s.close(),l=!1,f=!1},setHandlers:w=>Object.assign(i,w),offerPromise:e?new Promise(w=>i.signal=p=>{p.type===xi&&w(p)}):Promise.resolve(),addStream:w=>w.getTracks().forEach(p=>s.addTrack(p,w)),removeStream:w=>s.getSenders().filter(p=>w.getTracks().includes(p.track)).forEach(p=>s.removeTrack(p)),addTrack:(w,p)=>s.addTrack(w,p),removeTrack:w=>{const p=s.getSenders().find(y=>y.track===w);p&&s.removeTrack(p)},replaceTrack:(w,p)=>{const y=s.getSenders().find(k=>k.track===w);if(y)return y.replaceTrack(p)}}},Wh=[...An(3,(e,t)=>`stun:stun${t||""}.l.google.com:19302`),"stun:stun.cloudflare.com:3478"].map(e=>({urls:e})),Yh=Object.getPrototypeOf(Uint8Array),ir=12,dc=0,or=dc+ir,cr=or+1,an=cr+1,un=an+1,ae=16*2**10-un,Wn=255,Ci="bufferedamountlow",Re=e=>"@_"+e,Kh=(e,t,n)=>{const r={},s={},i={},l={},f={},h={},g={},u={onPeerJoin:Gt,onPeerLeave:Gt,onPeerStream:Gt,onPeerTrack:Gt},w=(S,A)=>(S?Array.isArray(S)?S:[S]:Uh(r)).flatMap(U=>{const M=r[U];return M?A(U,M):(console.warn(`${_n}: no peer with id ${U} found`),[])}),p=S=>{r[S]&&(r[S].destroy(),delete r[S],delete l[S],delete f[S],u.onPeerLeave(S),t(S))},y=S=>{if(s[S])return i[S];if(!S)throw Jt("action type argument is required");const A=Ve(S);if(A.byteLength>ir)throw Jt(`action type string "${S}" (${A.byteLength}b) exceeds byte limit (${ir}). Hint: choose a shorter name.`);const U=new Uint8Array(ir);U.set(A);let M=0;return s[S]={onComplete:Gt,onProgress:Gt,setOnComplete:P=>s[S]={...s[S],onComplete:P},setOnProgress:P=>s[S]={...s[S],onProgress:P},send:async(P,x,D,G)=>{if(D&&typeof D!="object")throw Jt("action meta argument must be an object");const ut=typeof P;if(ut==="undefined")throw Jt("action data cannot be undefined");const nt=ut!=="string",Ct=P instanceof Blob,N=Ct||P instanceof ArrayBuffer||P instanceof Yh;if(D&&!N)throw Jt("action meta argument can only be used with binary data");const O=N?new Uint8Array(Ct?await P.arrayBuffer():P):Ve(nt?xn(P):P),j=D?Ve(xn(D)):null,J=Math.ceil(O.byteLength/ae)+(D?1:0)||1,Z=An(J,(Q,rt)=>{const kt=rt===J-1,ht=D&&rt===0,wt=new Uint8Array(un+(ht?j.byteLength:kt?O.byteLength-ae*(J-(D?2:1)):ae));return wt.set(U),wt.set([M],or),wt.set([kt|ht<<1|N<<2|nt<<3],cr),wt.set([Math.round((rt+1)/J*Wn)],an),wt.set(D?ht?j:O.subarray((rt-1)*ae,rt*ae):O.subarray(rt*ae,(rt+1)*ae),un),wt});return M=M+1&Wn,he(w(x,async(Q,rt)=>{const{channel:kt}=rt;let ht=0;for(;ht<J;){const wt=Z[ht];if(kt.bufferedAmount>kt.bufferedAmountLowThreshold&&await new Promise($n=>{const Vn=()=>{kt.removeEventListener(Ci,Vn),$n()};kt.addEventListener(Ci,Vn)}),!r[Q])break;rt.sendData(wt),ht++,G?.(wt[an]/Wn,Q,D)}}))}},i[S]||=[s[S].send,s[S].setOnComplete,s[S].setOnProgress]},k=(S,A)=>{const U=new Uint8Array(A),M=sr(U.subarray(dc,or)).replaceAll("\0",""),[P]=U.subarray(or,cr),[x]=U.subarray(cr,an),[D]=U.subarray(an,un),G=U.subarray(un),ut=!!(x&1),nt=!!(x&2),Ct=!!(x&4),N=!!(x&8);if(!s[M]){console.warn(`${_n}: received message with unregistered type (${M})`);return}l[S]||={},l[S][M]||={};const O=l[S][M][P]||={chunks:[]};if(nt?O.meta=In(sr(G)):O.chunks.push(G),s[M].onProgress(D/Wn,S,O.meta),!ut)return;const j=new Uint8Array(O.chunks.reduce((J,Z)=>J+Z.byteLength,0));if(O.chunks.reduce((J,Z)=>(j.set(Z,J),J+Z.byteLength),0),delete l[S][M][P],Ct)s[M].onComplete(j,S,O.meta);else{const J=sr(j);s[M].onComplete(N?In(J):J,S)}},_=async()=>{await le(""),await new Promise(S=>setTimeout(S,99)),gs(r).forEach(([S,A])=>{A.destroy(),delete r[S]}),n()},[R,at]=y(Re("ping")),[X,C]=y(Re("pong")),[I,q]=y(Re("signal")),[pt,ce]=y(Re("stream")),[gt,xe]=y(Re("track")),[le,Ie]=y(Re("leave"));return e((S,A)=>{r[A]||(r[A]=S,S.setHandlers({data:U=>k(A,U),stream:U=>{u.onPeerStream(U,A,h[A]),delete h[A]},track:(U,M)=>{u.onPeerTrack(U,M,A,g[A]),delete g[A]},signal:U=>I(U,A),close:()=>p(A),error:U=>{console.error(U),p(A)}}),u.onPeerJoin(A))}),at((S,A)=>X("",A)),C((S,A)=>{f[A]?.(),delete f[A]}),q((S,A)=>r[A]?.signal(S)),ce((S,A)=>h[A]=S),xe((S,A)=>g[A]=S),Ie((S,A)=>p(A)),ac&&addEventListener("beforeunload",_),{makeAction:y,leave:_,ping:async S=>{if(!S)throw Jt("ping() must be called with target peer ID");const A=Date.now();return R("",S),await new Promise(U=>f[S]=U),Date.now()-A},getPeers:()=>uc(gs(r).map(([S,A])=>[S,A.connection])),addStream:(S,A,U)=>w(A,async(M,P)=>{U&&await pt(U,M),P.addStream(S)}),removeStream:(S,A)=>w(A,(U,M)=>M.removeStream(S)),addTrack:(S,A,U,M)=>w(U,async(P,x)=>{M&&await gt(M,P),x.addTrack(S,A)}),removeTrack:(S,A)=>w(A,(U,M)=>M.removeTrack(S)),replaceTrack:(S,A,U,M)=>w(U,async(P,x)=>{M&&await gt(M,P),x.replaceTrack(S,A)}),onPeerJoin:S=>u.onPeerJoin=S,onPeerLeave:S=>u.onPeerLeave=S,onPeerStream:S=>u.onPeerStream=S,onPeerTrack:S=>u.onPeerTrack=S}},Xh=20,Zh=5333,Di=57333,Qh=({init:e,subscribe:t,announce:n})=>{const r={};let s=!1,i,l,f,h;return(g,u,w)=>{const{appId:p}=g;if(r[p]?.[u])return r[p][u];const y={},k={},_=Jn(_n,p,u),R=ln(_),at=ln(Jn(_,Be)),X=Hh(g.password||"",p,u),C=x=>async D=>({type:D.type,sdp:await x(X,D.sdp)}),I=C(Gh),q=C(qh),pt=()=>Ii(!0,g),ce=(x,D,G)=>{if(k[D]){k[D]!==x&&x.destroy();return}k[D]=x,P(x,D),y[D]?.forEach((ut,nt)=>{nt!==G&&ut.destroy()}),delete y[D]},gt=(x,D)=>{k[D]===x&&delete k[D]},xe=(x,D)=>{if(k[x])return;const G=y[x]?.[D];G&&(delete y[x][D],G.destroy())},le=x=>(l.push(...An(x,pt)),he(l.splice(0,x).map(D=>D.offerPromise.then(q).then(G=>({peer:D,offer:G}))))),Ie=(x,D)=>w?.({error:`incorrect password (${g.password}) when decrypting ${D}`,appId:p,peerId:x,roomId:u}),S=x=>async(D,G,ut)=>{const[nt,Ct]=await he([R,at]);if(D!==nt&&D!==Ct)return;const{peerId:N,offer:O,answer:j,peer:J}=typeof G=="string"?In(G):G;if(!(N===Be||k[N])){if(N&&!O&&!j){if(y[N]?.[x])return;const[[{peer:Z,offer:Q}],rt]=await he([le(1),ln(Jn(_,N))]);y[N]||=[],y[N][x]=Z,setTimeout(()=>xe(N,x),A[x]*.9),Z.setHandlers({connect:()=>ce(Z,N,x),close:()=>gt(Z,N)}),ut(rt,xn({peerId:Be,offer:Q}))}else if(O){if(y[N]?.[x]&&Be>N)return;const Q=Ii(!1,g);Q.setHandlers({connect:()=>ce(Q,N,x),close:()=>gt(Q,N)});let rt;try{rt=await I(O)}catch{Ie(N,"offer");return}if(Q.isDead)return;const[kt,ht]=await he([ln(Jn(_,N)),Q.signal(rt)]);ut(kt,xn({peerId:Be,answer:await q(ht)}))}else if(j){let Z;try{Z=await I(j)}catch{Ie(N,"answer");return}if(J)J.setHandlers({connect:()=>ce(J,N,x),close:()=>gt(J,N)}),J.signal(Z);else{const Q=y[N]?.[x];Q&&!Q.isDead&&Q.signal(Z)}}}};if(!g)throw Jt("requires a config map as the first argument");if(!p&&!g.firebaseApp)throw Jt("config map is missing appId field");if(!u)throw Jt("roomId argument required");if(!s){const x=e(g);l=An(Xh,pt),i=Array.isArray(x)?x:[x],s=!0,f=setInterval(()=>l=l.filter(D=>{const G=Date.now()-D.created<Di;return G||D.destroy(),G}),Di*1.03),h=g.manualRelayReconnection?Gt:Nh()}const A=i.map(()=>Zh),U=[],M=i.map(async(x,D)=>t(await x,await R,await at,S(D),le));he([R,at]).then(([x,D])=>{const G=async(ut,nt)=>{const Ct=await n(ut,x,D);typeof Ct=="number"&&(A[nt]=Ct),U[nt]=setTimeout(()=>G(ut,nt),A[nt])};M.forEach(async(ut,nt)=>{await ut,G(await i[nt],nt)})});let P=Gt;return r[p]||={},r[p][u]=Kh(x=>P=x,x=>delete k[x],()=>{delete r[p][u],U.forEach(clearTimeout),M.forEach(async x=>(await x)()),clearInterval(f),h(),s=!1})}},es={},pc={},nn={},rn={},sn={},Ti={},Yn={},tf="announce",gc=20,Ri=10,ef=33333,nf=120333,rf=3,sf=async e=>{if(es[e])return es[e];const t=(await ln(e)).slice(0,gc);return es[e]=t,pc[t]=e,t},Ui=async(e,t,n)=>e.send(xn({action:tf,info_hash:await sf(t),peer_id:Be,...n})),Bi=(e,t,n)=>console.warn(`${_n}: torrent tracker ${n?"failure":"warning"} from ${e} - ${t}`),mc=Qh({init:e=>Lh(e,of,rf).map(t=>{const n=Fh(t,s=>{const i=In(s),l=i["failure reason"],f=i["warning message"],{interval:h}=i,g=pc[i.info_hash];if(l){Bi(r,l,!0);return}if(f&&Bi(r,f),h&&h*1e3>sn[r]&&rn[r][g]){const u=Math.min(h*1e3,nf);clearInterval(nn[r][g]),sn[r]=u,nn[r][g]=setInterval(rn[r][g],u)}Ti[i.offer_id]||(i.offer||i.answer)&&(Ti[i.offer_id]=!0,Yn[r][g]?.(i))}),{url:r}=n;return Yn[r]={},n.ready}),subscribe:(e,t,n,r,s)=>{const{url:i}=e,l=async()=>{const f=uc((await s(Ri)).map(h=>[lc(gc),h]));Yn[e.url][t]=h=>{if(h.offer)r(t,{offer:h.offer,peerId:h.peer_id},(g,u)=>Ui(e,t,{answer:In(u).answer,offer_id:h.offer_id,to_peer_id:h.peer_id}));else if(h.answer){const g=f[h.offer_id];g&&r(t,{answer:h.answer,peerId:h.peer_id,peer:g.peer})}},Ui(e,t,{numwant:Ri,offers:gs(f).map(([h,{offer:g}])=>({offer_id:h,offer:g}))})};return sn[i]=ef,rn[i]||={},rn[i][t]=l,nn[i]||={},nn[i][t]=setInterval(l,sn[i]),l(),()=>{clearInterval(nn[i][t]),delete Yn[i][t],delete rn[i][t]}},announce:e=>sn[e.url]}),of=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.btorrent.xyz","tracker.files.fm:7073/announce"].map(e=>"wss://"+e),Df=["Aeromancy","Alchemy","Alteration","Animism","Astromancy","Chaos","Chronomancy","Conjuration","Cryomancy","Dark Arts","Destruction","Divination","Eldritch","Enchantment","Evocation","Geomancy","Hydromancy","Illusion","Invocation","Necromancy","Oneiromancy","Order","Primal","Protection","Psychomancy","Pyromancy","Shadowmancy","Skullduggery","Spiritualism","Symbolism","Technomancy","Teleportation","War"],Tf={NEXT_ROLL:"Prxima Rolagem",ROUNDS:"Rodadas",MINUTES:"Minutos",HOURS:"Horas",DAYS:"Dias",LUCK_ENDS:"Sorte Encerra",PERMANENT:"Indeterminado"},_t={WEAPON:"Weapon",ARMOR:"Armor",SHIELD:"Shield",CONSUMABLE:"Consumable",EXPLOSIVE:"Explosive",OTHER:"Other"},me={ADD:"ADD",SET:"SET",MULT:"MULT"},Rf={str:"Fora",agi:"Agilidade",int:"Intelecto",wil:"Vontade",defense:"Defesa",speed:"Deslocamento",health:"Vida",damage:"Dano (Dados)",boons:"Boons/Banes"},Uf={Blinded:{effect:"Make rolls with 3 banes. No sight reactions. Speed halved.",speedMult:.5,rollMod:-3},Confused:{effect:"No reactions. Intellect and Will rolls with 1 bane.",rollMod:-1,attributes:["int","wil"]},Controlled:{effect:"Controller decides your turn. Regard source as ally."},Cursed:{effect:"Luck rolls with 1 bane."},Deafened:{effect:"No hearing reactions. Immune to hearing effects."},Frightened:{effect:"Attribute rolls with 1 bane (while in LOS). Grant 1 boon on rolls against you.",rollMod:-1},Held:{effect:"Speed 0. Cannot increase Speed. Auto-fail Agility defense rolls.",speedFixed:0},Impaired:{effect:"Roll with 1 bane for specified attribute. Grant 1 boon against that attribute.",rollMod:-1},Incapacitated:{effect:"Damage equals or exceeds Health. You cannot use actions or reactions. Speed 0.",speedFixed:0},"On Fire":{effect:"Take 1d6 damage at end of round. Action/Luck roll to extinguish."},Poisoned:{effect:"Attribute rolls with 1 bane. Grant 1 boon against you. Lose 1d6 Health end of round.",rollMod:-1},Prone:{effect:"No reactions. Grant 1 boon to melee vs you, impose 1 bane to ranged vs you."},Slowed:{effect:"Speed drops to 2 (if higher). Cannot benefit from Speed increases.",speedCap:2},Stunned:{effect:"No actions/reactions. Speed 0. Grant 2 boons against you. Attribute rolls with 2 banes.",speedFixed:0,rollMod:-2},Unconscious:{effect:"No actions/reactions. Speed 0. Grant 3 boons against you. Auto-fail attribute rolls.",speedFixed:0,autoFail:!0},Vulnerable:{effect:"Grant 1 boon on attacks/rolls against you."},Weakened:{effect:"Strength/Agility rolls with 1 bane. Grant 1 boon vs Str/Agi. Speed halved.",speedMult:.5,attributes:["str","agi"],rollMod:-1}},cf={OFF:"Off",ONE:"One",TWO:"Two"},Bf=["NIMBLE","FIREARM","THROWN","BRUTAL","BLUDGEONING","SLASHING","DISARMING","RANGE","SPECIAL","MISFIRE","LARGE","SLOW","LIGHT","LONG","AMMUNITION","PIERCING","RELOAD","VERSATILE"],vf={ANCESTRY:"Ancestry",NOVICE:"Novice",EXPERT:"Expert",MASTER:"Master"},lf={name:"Alaric, o Errante",level:3,ancestry:"Humano",paths:{novice:"Mago",expert:"Alquimista",master:"-"},attributes:[{name:"Fora",value:10,key:"str"},{name:"Agilidade",value:12,key:"agi"},{name:"Intelecto",value:15,key:"int"},{name:"Vontade",value:11,key:"wil"}],currency:{gp:0,sp:0,cp:0},naturalDefense:10,bonusDamage:0,speed:10,currentRound:1,languages:["Comum","lfico"],afflictions:[],effects:[],notes:"",campaignId:null,campaignName:null,gmName:null,combatActive:!1,initiative:!1,acted:!1,spells:[{id:1,name:"Seta de Energia",tier:"Novice",type:"Ataque",tradition:"Destruction",description:"Causa 1d6 de dano a um alvo em alcance curto.",castings:3,maxCastings:3,effect:null},{id:2,name:"Escudo Mgico",tier:"Novice",type:"Utilidade",tradition:"Protection",description:"+2 em Defesa por 1 minuto.",castings:2,maxCastings:2,effect:{id:999,name:"Escudo Mgico",duration:"MINUTES",roundsLeft:10,initialRounds:10,description:"+2 Defesa",isActive:!0,modifiers:[{target:"defense",type:me.ADD,value:2}]}}],talents:[{id:1,name:"Sentido Arcano",description:"Voc detecta magia a curto alcance.",uses:0,maxUses:0,isPassive:!0,effect:null},{id:2,name:"Sorte do Principiante",description:"Pode refazer um teste falho.",uses:1,maxUses:1,isPassive:!1,effect:null}],equipment:[{id:1,name:"Cajado",type:_t.WEAPON,quantity:1,price:5,availability:"Common",quality:"Standard",grip:cf.TWO,range:"Melee",damageDice:1,boonsBanes:0,traits:"Finesse, Versatile",equippedState:null,equipped:!1},{id:2,name:"Poo de Cura",type:_t.CONSUMABLE,quantity:3,price:10,availability:"Common",quality:"Standard",notes:"Recupera Healing Rate",equippedState:null,equipped:!1},{id:3,name:"Granada Alqumica",type:_t.EXPLOSIVE,quantity:2,price:15,availability:"Uncommon",quality:"Standard",damageDice:2,range:"Short",traits:"Blast",description:"Explode em rea curta causando 2d6 de dano.",equippedState:null,equipped:!1},{id:4,name:"Couro Batido",type:_t.ARMOR,quantity:1,price:20,availability:"Common",quality:"Standard",defenseType:"fixed",defenseFixed:12,armorWeight:"Light",equipped:!1,equippedState:null}]},T=Ht(lf),ns=Ht([]),Kn=Ht({type:null,isOpen:!1,data:null}),Lf=Ht("acoes"),Js=Ht(24),Qe=Ht(24),ke=Ht(0),vi=Ht(!1),Nn=Ut(T,e=>{const t=e.effects.filter(r=>r.isActive),n=e.talents.filter(r=>(r.isPassive||r.activityType==="Passive")&&r.effect).map(r=>({...r.effect,id:`talent-effect-${r.id}`,name:r.name,sourceType:"talent",sourceId:r.id}));return[...t,...n]});function Fr(e,t,n){let r=t||0;const s=n.flatMap(h=>Array.isArray(h.modifiers)?h.modifiers:[]),i=s.filter(h=>h.target===e&&h.type===me.SET);return i.length>0&&(r=i[i.length-1].value),s.filter(h=>h.target===e&&h.type===me.ADD).forEach(h=>{r+=h.value}),s.filter(h=>h.target===e&&h.type===me.MULT).forEach(h=>{r*=h.value}),Math.floor(r)}const wc=Ut([T,Nn],([e,t])=>{const n={};return e.attributes.forEach(r=>{n[r.key]=Fr(r.key,r.value,t)}),n}),af=Ut([Qe,Nn],([e,t])=>Fr("health",e,t)),Mf=Ut([af,Js],([e,t])=>Math.max(0,e-t)),Of=Ut([ke,Qe],([e,t])=>t>0?Math.min(100,e/t*100):100),uf=Ut([ke,Qe],([e,t])=>e>=t),Ff=Ut([ke,Qe,uf],([e,t,n])=>e>=t/2&&!n),Nf=Ut([T,wc,Nn],([e,t,n])=>{let r=Fr("speed",e.speed,n);const s=e.afflictions;return s.includes("Held")||s.includes("Stunned")||s.includes("Unconscious")||s.includes("Incapacitated")?0:((s.includes("Blinded")||s.includes("Weakened"))&&(r=Math.floor(r/2)),s.includes("Slowed")&&(r=Math.min(r,2)),Math.max(0,r))}),$f=Ut([T,Nn],([e,t])=>{let n=e.naturalDefense,r=0;const s=e.equipment.find(i=>i.type===_t.ARMOR&&i.equipped);if(s){const i=s.defenseFixed||0,l=e.naturalDefense+(s.defenseMod||0);s.defenseFixed&&s.defenseMod?n=Math.max(i,l):s.defenseFixed?n=i:s.defenseMod&&(n=e.naturalDefense+s.defenseMod)}return e.equipment.filter(i=>i.type===_t.SHIELD&&i.equippedState).forEach(i=>{r+=i.defenseMod||0}),Fr("defense",n+r,t)});Ut([T,Nn],([e,t])=>{const r=t.flatMap(s=>Array.isArray(s.modifiers)?s.modifiers:[]).filter(s=>s.target==="damage"&&s.type===me.ADD).reduce((s,i)=>s+i.value,0);return(e.bonusDamage||0)+r});const Dt={updateCurrency:(e,t)=>{T.update(n=>{let r=n.currency.gp*100+n.currency.sp*10+n.currency.cp,s=0;return e==="gp"&&(s=t*100),e==="sp"&&(s=t*10),e==="cp"&&(s=t),r+=s,r<0&&(r=0),{...n,currency:{gp:Math.floor(r/100),sp:Math.floor(r%100/10),cp:r%100%10}}})},advanceRound:e=>{T.update(t=>{const n=t.currentRound||1;if(e==="next"){const r=(t.effects||[]).map(s=>{if(s.isActive&&s.duration==="ROUNDS"&&s.roundsLeft>0){const i=s.roundsLeft-1;return i<=0?{...s,roundsLeft:0,isActive:!1}:{...s,roundsLeft:i}}return s});return{...t,currentRound:n+1,effects:r}}else return{...t,currentRound:Math.max(1,n-1)}})},addToHistory:(e,t=!0)=>{const n=te(T),r=te(ns);if(e.id&&r.find(i=>i.id===e.id))return;const s={id:e.id||ki(),timestamp:e.timestamp||new Date,charName:n.name,...e};ns.update(i=>[s,...i]),vi.set(!0),t&&n.campaignId&&Ys(async()=>{const{syncRoll:i}=await Promise.resolve().then(()=>Fi);return{syncRoll:i}},void 0,import.meta.url).then(({syncRoll:i})=>{i(s)})},clearHistory:()=>ns.set([]),addItem:e=>T.update(t=>({...t,equipment:[...t.equipment,e]})),updateItem:e=>T.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?e:n)})),deleteItem:e=>T.update(t=>({...t,equipment:t.equipment.filter(n=>n.id!==e)})),useConsumable:e=>{e.quantity>0&&(Dt.updateItem({...e,quantity:e.quantity-1}),Dt.addToHistory({source:"Consumvel",name:e.name,description:`Usou ${e.name} `}))},equipItem:(e,t=null)=>{T.update(n=>{let r=[...n.equipment];return e.type===_t.ARMOR?r=r.map(s=>s.id===e.id?{...s,equipped:!s.equipped}:s.type===_t.ARMOR&&e.type===_t.ARMOR&&!e.equipped?{...s,equipped:!1}:s):(e.type===_t.WEAPON||e.type===_t.SHIELD)&&(r=r.map(s=>s.id===e.id?{...s,equippedState:t}:s)),{...n,equipment:r}})},toggleAffliction:e=>{T.update(t=>t.afflictions.includes(e)?{...t,afflictions:t.afflictions.filter(n=>n!==e)}:{...t,afflictions:[...t.afflictions,e]})},addLanguage:e=>T.update(t=>({...t,languages:[...t.languages,e]})),removeLanguage:e=>T.update(t=>({...t,languages:t.languages.filter((n,r)=>r!==e)})),confirmRest:()=>{T.update(t=>{const n=t.spells.map(s=>({...s,castings:s.maxCastings})),r=t.talents.map(s=>({...s,uses:s.maxUses}));return{...t,spells:n,talents:r}}),ke.set(0);const e=te(Js);Qe.set(e),Kn.set({type:null,isOpen:!1,data:null})},finalizeRoll:(e,t,n=[])=>{const r=te(T),s=te(wc),i=e.type==="weapon_attack",l=e.type==="luck",f=e.type==="weapon_damage",h=e.source,g=h.name||"Ao",u=(w,p)=>w.traits&&w.traits.toLowerCase().includes(p.toLowerCase());if(f){let w=parseInt(h.damageDice)||0;const p=h.grip&&h.grip.toLowerCase()==="two"||h.equippedState&&h.equippedState.toLowerCase()==="two";u(h,"Versatile")&&p&&(w+=1);let y=r.bonusDamage||0;u(h,"Light")&&y>1&&(y-=1);const k=n.flatMap(I=>Array.isArray(I.modifiers)?I.modifiers:[]).filter(I=>I.target==="damage"&&I.type===me.ADD).reduce((I,q)=>I+q.value,0),_=y+k,R=Math.max(0,w+_+t);let at=[],X=0,C=[];for(let I=0;I<R;I++){let q=Math.floor(Math.random()*6)+1;if(q===1&&u(h,"Brutal")){const pt=Math.floor(Math.random()*6)+1;C.push(`1->${pt}`),q=pt}else C.push(`${q}`);at.push(q),X+=q}ke.set(X),Dt.addToHistory({source:"Dano",name:h.name,description:`Dano: ${R}d6 ${u(h,"Brutal")?"(Brutal)":""}`,formula:`${R}d6 [${at.join(", ")}] ${C.some(I=>I.includes("->"))?`(Rolagens: ${C.join(", ")})`:""}`,total:X,effectsApplied:n.map(I=>I.name)}),h.type===_t.EXPLOSIVE&&Dt.useConsumable(h)}else{const w=Math.floor(Math.random()*20)+1;let p=0,y="Sorte";if(e.type==="attribute")p=(s[e.source.key]||e.source.value)-10,y=e.source.name;else if(i){let C="str",I="Fora";h.range==="Ranged"&&(C="agi",I="Agilidade",u(h,"Thrown")&&(C="str",I="Fora")),u(h,"Nimble")&&(C="agi",I="Agilidade"),p=(s[C]||10)-10,y=I}const k=n.flatMap(C=>Array.isArray(C.modifiers)?C.modifiers:[]).filter(C=>C.target==="boons"&&C.type===me.ADD).reduce((C,I)=>C+I.value,0);t+=k;let _=0,R="";if(t!==0){const C=Math.abs(t);let I=[];for(let pt=0;pt<C;pt++)I.push(Math.floor(Math.random()*6)+1);const q=Math.max(...I);t>0?(_=q,R=` + ${q} [Boon]`):(_=-q,R=` - ${q} [Bane]`)}const at=w+p+_;let X=i?`Ataque (${y})`:l?"Teste de Sorte":`Teste de ${g}`;if(t!==0&&(X+=` com ${t} boons/banes`),i&&w===20){let C=[];u(h,"Bludgeoning")&&C.push("Vuln"),u(h,"Piercing")&&C.push("Weakened"),u(h,"Slashing")&&C.push("+1d6 Dmg"),C.length>0&&(X+=`
CRTICO! ${C.join(" ")} `)}Dt.addToHistory({source:i?"Ataque":l?"Sorte":"Atributo",name:g,description:X,formula:`d20(${w})${p!==0?(p>=0?"+":"")+p:""}${R} `,total:at,crit:w===20,effectsApplied:n.map(C=>C.name)}),T.update(C=>({...C,effects:C.effects.map(I=>I.isActive&&I.duration==="NEXT_ROLL"?{...I,isActive:!1}:I)})),i&&u(h,"Reload")&&T.update(C=>({...C,equipment:C.equipment.map(I=>I.id===h.id?{...I,isLoaded:!1}:I)}))}Kn.set({type:null,isOpen:!1,data:null}),vi.set(!0)},reloadWeapon:e=>{T.update(t=>({...t,equipment:t.equipment.map(n=>n.id===e.id?{...n,isLoaded:!0}:n)})),Dt.addToHistory({source:"Ao",name:"Recarregar",description:`Recarregou ${e.name}`})},addSpell:e=>T.update(t=>({...t,spells:[...t.spells,e]})),updateSpell:e=>T.update(t=>({...t,spells:t.spells.map(n=>n.id===e.id?e:n)})),deleteSpell:e=>T.update(t=>({...t,spells:t.spells.filter(n=>n.id!==e)})),commitSpellCast:e=>{e.castings>0&&(T.update(t=>({...t,spells:t.spells.map(n=>n.id===e.id?{...n,castings:n.castings-1}:n)})),Dt.addToHistory({source:"Magia",name:e.name,description:e.description}),Kn.set({type:null,isOpen:!1,data:null}))},addTalent:e=>T.update(t=>({...t,talents:[...t.talents,e]})),updateTalent:e=>T.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?e:n)})),deleteTalent:e=>T.update(t=>({...t,talents:t.talents.filter(n=>n.id!==e)})),commitTalentUse:e=>{e.activityType==="Duration"&&e.duration==="LUCK_ENDS"?T.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?{...n,uses:0}:n)})):e.maxUses&&T.update(t=>({...t,talents:t.talents.map(n=>n.id===e.id?{...n,uses:n.uses-1}:n)})),Dt.addToHistory({source:"Talento",name:e.name,description:e.description}),Kn.set({type:null,isOpen:!1,data:null})},recoverTalent:e=>{T.update(t=>({...t,talents:t.talents.map(n=>n.id===e&&n.uses<n.maxUses?{...n,uses:n.uses+1}:n)}))},rollLuckTalent:e=>{const t=Math.floor(Math.random()*20)+1,n=t>=10,s=te(T).talents.find(i=>i.id===e);Dt.addToHistory({source:"Sorte",name:`Teste de Sorte - ${s?.name||"Talento"}`,formula:`d20(${t})`,total:t,description:`Rolou ${t}. ${n?"Sucesso! Talento recuperado.":"Falha. O talento continua indisponvel."}`}),n&&T.update(i=>({...i,talents:i.talents.map(l=>l.id===e?{...l,uses:1}:l)}))},addEffect:e=>T.update(t=>({...t,effects:[...t.effects,e]})),updateEffect:e=>T.update(t=>({...t,effects:t.effects.map(n=>n.id===e.id?e:n)})),deleteEffect:e=>T.update(t=>({...t,effects:t.effects.filter(n=>n.id!==e)})),toggleEffect:e=>T.update(t=>({...t,effects:t.effects.map(n=>{if(n.id===e){const r=!n.isActive;return{...n,isActive:r,roundsLeft:r&&n.duration==="ROUNDS"&&n.initialRounds||n.roundsLeft}}return n})})),cleanInactiveEffects:()=>T.update(e=>({...e,effects:e.effects.filter(t=>t.isActive)})),applyEffectToCharacter:(e,t)=>{const n=e.name||(t?t.name:"Efeito sem nome"),r=e.description||(t?t.description:""),s={...e,id:ki(),isActive:!0,name:n,description:r};s.duration==="ROUNDS"&&!s.initialRounds&&(s.initialRounds=s.roundsLeft),T.update(i=>({...i,effects:[...i.effects,s]}))},checkLuckEnds:e=>{const t=Math.floor(Math.random()*20)+1,n=t>=10;Dt.addToHistory({source:"Sorte",name:"Check Fim Efeito",description:`Rolou ${t}. ${n?"Sucesso (Encerra)":"Falha"} `}),n&&T.update(r=>({...r,effects:r.effects.map(s=>s.id===e?{...s,isActive:!1}:s)}))},joinCampaign:e=>{T.update(t=>({...t,campaignId:e.id,campaignName:e.name,gmName:e.gmName||"Mestre"})),Ys(async()=>{const{joinCampaignRoom:t}=await Promise.resolve().then(()=>Fi);return{joinCampaignRoom:t}},void 0,import.meta.url).then(({joinCampaignRoom:t})=>{t(e.id,!1)})},leaveCampaign:()=>{T.update(e=>({...e,campaignId:null,campaignName:null,gmName:null,combatActive:!1}))}};ke.subscribe(e=>{});const yc={appId:cc,trackerUrls:["wss://tracker.openwebtorrent.com","wss://tracker.files.fm:7073/announce","wss://tracker.webtorrent.dev","wss://toad.vibe.community:443/announce","wss://tracker.btorrent.xyz"]},Ot=Ht({roomId:null,peers:[],currentCharacterId:null,lastGmUpdate:0,isGM:!1,isConnected:!1}),hf=Ut(Ot,e=>e.lastGmUpdate?Date.now()-e.lastGmUpdate<6e4:!1);let st=null,ne=null,Cn=null,Dn=null,Tn=null,Rn=null,pe=null,$t=null,Li=0,Mi=0;const ff=2e3,df={appId:"weird-wizard-vault-lobby"},ws=Ht([]);function Un(e,t){if(!e)return!0;try{return e.leave(),!0}catch(n){return console.warn(`Failed to leave ${t}:`,n),!1}}function bc(e){return Date.now()-e>=ff}function ys(){if(!bc(Li))return console.warn("Lobby join rate limited. Skipping duplicate join attempt."),null;Li=Date.now(),pe&&(clearInterval(pe),pe=null),Un(ne,"existing lobby"),ne=null;try{ne=mc(df,"public-discovery");const[e,t]=ne.makeAction("discovery");return t(n=>{ws.update(r=>{const s=r.findIndex(i=>i.id===n.id);if(s!==-1){const i=[...r];return i[s]={...n,lastSeen:Date.now()},i}return[...r,{...n,lastSeen:Date.now()}]})}),pe=setInterval(()=>{const n=Date.now();ws.update(r=>r.filter(s=>n-s.lastSeen<12e4))},6e4),e}catch(e){return console.error("Failed to join lobby:",e),ne=null,null}}let kr;function pf(){typeof window<"u"&&(sessionStorage.getItem("lobby-initialized")?ne||(kr=ys()):(sessionStorage.setItem("lobby-initialized","true"),kr=ys()))}typeof window<"u"&&(pf(),window.addEventListener("beforeunload",()=>{Oi()}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Oi()}));function Oi(){pe&&(clearInterval(pe),pe=null),$t&&(clearInterval($t),$t=null),Un(ne,"lobby"),Un(st,"room"),ne=null,st=null}let ve=null;function gf(e,t=!1,n=null){const r=`campaign-${e}`;if(ve===r&&st)return Ot.update(s=>({...s,isGM:t,currentCharacterId:n})),st;if(!bc(Mi))return console.warn("Campaign join rate limited. Skipping duplicate join attempt."),st;Mi=Date.now(),$t&&(clearInterval($t),$t=null),Un(st,"existing campaign room"),st=null,ve=null,Cn=null,Dn=null,Tn=null,Rn=null;try{ve=r,st=mc(yc,ve),Ot.set({isConnected:!0,isGM:t,currentCharacterId:n,peers:[],roomId:e,lastGmUpdate:0});const[s,i]=st.makeAction("combat"),[l,f]=st.makeAction("history"),[h,g]=st.makeAction("charUpdate"),[u,w]=st.makeAction("campaign");return Cn=s,Dn=l,Tn=h,Rn=u,i(p=>{t||T.update(y=>({...y,currentRound:p.round,combatActive:p.active}))}),w(p=>{Ot.update(y=>({...y,lastGmUpdate:Date.now()})),t||T.update(y=>({...y,campaignName:p.name,gmName:p.gmName,passwordHash:p.passwordHash}))}),t&&kr&&($t=setInterval(()=>{const p=cn.get(e);p&&p.isPublished&&kr({id:e,name:p.name,gmName:p.gmName||"Mestre",description:p.description})},3e4)),f(p=>{Dt.addToHistory(p,!1)}),g(p=>{if(t){const y=cn.get(e);if(y){const k=y.members||[],_=k.findIndex(I=>I.id===p.id);let R;if(_!==-1){R=[...k];const I=R[_],q={...p};I.campaignApproval==="approved"&&p.campaignApproval==="pending"&&delete q.campaignApproval,R[_]={...I,...q,lastUpdate:Date.now()}}else R=[...k,{...p,lastUpdate:Date.now()}];const at=y.activeEnemies||[],X=at.findIndex(I=>I.id===p.id&&I.type==="player");let C=at;X!==-1&&(C=[...at],C[X]={...C[X],...p}),cn.set(e,{...y,members:R,activeEnemies:C})}}else{const y=te(Ot),k=te(T),_=y.currentCharacterId||k?.id;if(_&&_===p.id){if(p.campaignApproval==="rejected"||p.campaignId===null){T.update(R=>({...R,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}));return}T.update(R=>({...R,name:p.name||R.name,afflictions:p.afflictions||R.afflictions,initiative:p.initiative!==void 0?p.initiative:R.initiative??!1,acted:p.acted!==void 0?p.acted:R.acted??!1,campaignApproval:p.campaignApproval||R.campaignApproval,imageUrl:p.imageUrl||R.imageUrl})),p.damage!==void 0&&ke.set(p.damage),p.currentHealth!==void 0&&Qe.set(p.currentHealth),p.normalHealth!==void 0&&Js.set(p.normalHealth)}}}),st.onPeerJoin(p=>{if(Ot.update(y=>({...y,peers:[...y.peers,p]})),t){const y=cn.get(e);y&&(y.combat&&s(y.combat),u({name:y.name,gmName:y.gmName||"Mestre",passwordHash:y.passwordHash}))}}),st.onPeerLeave(p=>{Ot.update(y=>({...y,peers:y.peers.filter(k=>k!==p)}))}),st}catch(s){return console.error("Failed to join campaign room:",s),st=null,ve=null,Ot.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0}),null}}function mf(e,t){Cn&&Cn(t)}function wf(e,t){Rn&&Rn({name:t.name,gmName:t.gmName||"Mestre",passwordHash:t.passwordHash})}function yf(e){Dn&&Dn(e)}function bf(e){Tn&&Tn(e)}function Ef(){$t&&(clearInterval($t),$t=null),Un(st,"campaign room"),st=null,ve=null,Cn=null,Dn=null,Tn=null,Rn=null,Ot.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0})}const Fi=Object.freeze(Object.defineProperty({__proto__:null,isGmOnline:hf,joinCampaignRoom:gf,joinLobby:ys,leaveCampaignRoom:Ef,publicCampaigns:ws,roomConfig:yc,syncCampaign:wf,syncCharacter:bf,syncCombat:mf,syncRoll:yf,syncState:Ot},Symbol.toStringTag,{value:"Module"}));export{Uf as A,ke as B,af as C,Of as D,Mf as E,Kn as F,cf as G,Tf as H,_t as I,Rf as J,me as K,Js as L,Df as M,Qe as N,Nn as O,wc as P,$f as Q,Nf as R,Lf as S,vf as T,lf as U,Cf as V,Bf as W,gf as a,xf as b,T as c,bh as d,cn as e,Eh as f,kh as g,_h as h,hf as i,mc as j,Sh as k,bf as l,wf as m,Ef as n,vi as o,ws as p,mf as q,yc as r,Be as s,Ot as t,ki as u,ns as v,Ah as w,Dt as x,uf as y,Ff as z};
