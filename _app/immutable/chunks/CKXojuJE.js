import{bj as xa,at as _a,u as va,p as Ia,h as Ca,aS as _n,bk as Ta}from"./CeQBZBfG.js";import{w as Re,q as $e,g as je}from"./DGsQstmn.js";import{_ as Ui}from"./T6JPUUzi.js";import{k as Bi}from"./Bf8fp1vJ.js";function kp(t,e,n=e){var r=new WeakSet;xa(t,"input",async s=>{var i=s?t.defaultValue:t.value;if(i=gs(t)?ws(i):i,n(i),_n!==null&&r.add(_n),await _a(),i!==(i=e())){var a=t.selectionStart,h=t.selectionEnd,f=t.value.length;if(t.value=i??"",h!==null){var g=t.value.length;a===h&&h===f&&g>f?(t.selectionStart=g,t.selectionEnd=g):(t.selectionStart=a,t.selectionEnd=Math.min(h,g))}}}),(Ca&&t.defaultValue!==t.value||va(e)==null&&t.value)&&(n(gs(t)?ws(t.value):t.value),_n!==null&&r.add(_n)),Ia(()=>{var s=e();if(t===document.activeElement){var i=Ta??_n;if(r.has(i))return}gs(t)&&s===ws(t.value)||t.type==="date"&&!s&&!t.value||s!==t.value&&(t.value=s??"")})}function gs(t){var e=t.type;return e==="number"||e==="range"}function ws(t){return t===""?null:+t}function Ma(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Do={exports:{}},ee=Do.exports={},qe,He;function Rs(){throw new Error("setTimeout has not been defined")}function Us(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?qe=setTimeout:qe=Rs}catch{qe=Rs}try{typeof clearTimeout=="function"?He=clearTimeout:He=Us}catch{He=Us}})();function Oo(t){if(qe===setTimeout)return setTimeout(t,0);if((qe===Rs||!qe)&&setTimeout)return qe=setTimeout,setTimeout(t,0);try{return qe(t,0)}catch{try{return qe.call(null,t,0)}catch{return qe.call(this,t,0)}}}function Da(t){if(He===clearTimeout)return clearTimeout(t);if((He===Us||!He)&&clearTimeout)return He=clearTimeout,clearTimeout(t);try{return He(t)}catch{try{return He.call(null,t)}catch{return He.call(this,t)}}}var nt=[],Kt=!1,xt,kr=-1;function Oa(){!Kt||!xt||(Kt=!1,xt.length?nt=xt.concat(nt):kr=-1,nt.length&&Ro())}function Ro(){if(!Kt){var t=Oo(Oa);Kt=!0;for(var e=nt.length;e;){for(xt=nt,nt=[];++kr<e;)xt&&xt[kr].run();kr=-1,e=nt.length}xt=null,Kt=!1,Da(t)}}ee.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];nt.push(new Uo(t,e)),nt.length===1&&!Kt&&Oo(Ro)};function Uo(t,e){this.fun=t,this.array=e}Uo.prototype.run=function(){this.fun.apply(null,this.array)};ee.title="browser";ee.browser=!0;ee.env={};ee.argv=[];ee.version="";ee.versions={};function ot(){}ee.on=ot;ee.addListener=ot;ee.once=ot;ee.off=ot;ee.removeListener=ot;ee.removeAllListeners=ot;ee.emit=ot;ee.prependListener=ot;ee.prependOnceListener=ot;ee.listeners=function(t){return[]};ee.binding=function(t){throw new Error("process.binding is not supported")};ee.cwd=function(){return"/"};ee.chdir=function(t){throw new Error("process.chdir is not supported")};ee.umask=function(){return 0};var Ra=Do.exports;const kt=Ma(Ra);var Ua={},Jr={};Jr.byteLength=Na;Jr.toByteArray=$a;Jr.fromByteArray=ja;var Je=[],Ie=[],Ba=typeof Uint8Array<"u"?Uint8Array:Array,ys="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var qt=0,La=ys.length;qt<La;++qt)Je[qt]=ys[qt],Ie[ys.charCodeAt(qt)]=qt;Ie[45]=62;Ie[95]=63;function Bo(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=t.indexOf("=");n===-1&&(n=e);var r=n===e?0:4-n%4;return[n,r]}function Na(t){var e=Bo(t),n=e[0],r=e[1];return(n+r)*3/4-r}function Fa(t,e,n){return(e+n)*3/4-n}function $a(t){var e,n=Bo(t),r=n[0],s=n[1],i=new Ba(Fa(t,r,s)),a=0,h=s>0?r-4:r,f;for(f=0;f<h;f+=4)e=Ie[t.charCodeAt(f)]<<18|Ie[t.charCodeAt(f+1)]<<12|Ie[t.charCodeAt(f+2)]<<6|Ie[t.charCodeAt(f+3)],i[a++]=e>>16&255,i[a++]=e>>8&255,i[a++]=e&255;return s===2&&(e=Ie[t.charCodeAt(f)]<<2|Ie[t.charCodeAt(f+1)]>>4,i[a++]=e&255),s===1&&(e=Ie[t.charCodeAt(f)]<<10|Ie[t.charCodeAt(f+1)]<<4|Ie[t.charCodeAt(f+2)]>>2,i[a++]=e>>8&255,i[a++]=e&255),i}function Pa(t){return Je[t>>18&63]+Je[t>>12&63]+Je[t>>6&63]+Je[t&63]}function Va(t,e,n){for(var r,s=[],i=e;i<n;i+=3)r=(t[i]<<16&16711680)+(t[i+1]<<8&65280)+(t[i+2]&255),s.push(Pa(r));return s.join("")}function ja(t){for(var e,n=t.length,r=n%3,s=[],i=16383,a=0,h=n-r;a<h;a+=i)s.push(Va(t,a,a+i>h?h:a+i));return r===1?(e=t[n-1],s.push(Je[e>>2]+Je[e<<4&63]+"==")):r===2&&(e=(t[n-2]<<8)+t[n-1],s.push(Je[e>>10]+Je[e>>4&63]+Je[e<<2&63]+"=")),s.join("")}var Xs={};Xs.read=function(t,e,n,r,s){var i,a,h=s*8-r-1,f=(1<<h)-1,g=f>>1,u=-7,w=n?s-1:0,p=n?-1:1,m=t[e+w];for(w+=p,i=m&(1<<-u)-1,m>>=-u,u+=h;u>0;i=i*256+t[e+w],w+=p,u-=8);for(a=i&(1<<-u)-1,i>>=-u,u+=r;u>0;a=a*256+t[e+w],w+=p,u-=8);if(i===0)i=1-g;else{if(i===f)return a?NaN:(m?-1:1)*(1/0);a=a+Math.pow(2,r),i=i-g}return(m?-1:1)*a*Math.pow(2,i-r)};Xs.write=function(t,e,n,r,s,i){var a,h,f,g=i*8-s-1,u=(1<<g)-1,w=u>>1,p=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,m=r?0:i-1,k=r?1:-1,A=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(h=isNaN(e)?1:0,a=u):(a=Math.floor(Math.log(e)/Math.LN2),e*(f=Math.pow(2,-a))<1&&(a--,f*=2),a+w>=1?e+=p/f:e+=p*Math.pow(2,1-w),e*f>=2&&(a++,f/=2),a+w>=u?(h=0,a=u):a+w>=1?(h=(e*f-1)*Math.pow(2,s),a=a+w):(h=e*Math.pow(2,w-1)*Math.pow(2,s),a=0));s>=8;t[n+m]=h&255,m+=k,h/=256,s-=8);for(a=a<<s|h,g+=s;g>0;t[n+m]=a&255,m+=k,a/=256,g-=8);t[n+m-k]|=A*128};(function(t){const e=Jr,n=Xs,r=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=u,t.SlowBuffer=$,t.INSPECT_MAX_BYTES=50;const s=2147483647;t.kMaxLength=s;const{Uint8Array:i,ArrayBuffer:a,SharedArrayBuffer:h}=globalThis;u.TYPED_ARRAY_SUPPORT=f(),!u.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function f(){try{const l=new i(1),o={foo:function(){return 42}};return Object.setPrototypeOf(o,i.prototype),Object.setPrototypeOf(l,o),l.foo()===42}catch{return!1}}Object.defineProperty(u.prototype,"parent",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.buffer}}),Object.defineProperty(u.prototype,"offset",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.byteOffset}});function g(l){if(l>s)throw new RangeError('The value "'+l+'" is invalid for option "size"');const o=new i(l);return Object.setPrototypeOf(o,u.prototype),o}function u(l,o,c){if(typeof l=="number"){if(typeof o=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return k(l)}return w(l,o,c)}u.poolSize=8192;function w(l,o,c){if(typeof l=="string")return A(l,o);if(a.isView(l))return oe(l);if(l==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof l);if(Pe(l,a)||l&&Pe(l.buffer,a)||typeof h<"u"&&(Pe(l,h)||l&&Pe(l.buffer,h)))return Y(l,o,c);if(typeof l=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const d=l.valueOf&&l.valueOf();if(d!=null&&d!==l)return u.from(d,o,c);const y=I(l);if(y)return y;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof l[Symbol.toPrimitive]=="function")return u.from(l[Symbol.toPrimitive]("string"),o,c);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof l)}u.from=function(l,o,c){return w(l,o,c)},Object.setPrototypeOf(u.prototype,i.prototype),Object.setPrototypeOf(u,i);function p(l){if(typeof l!="number")throw new TypeError('"size" argument must be of type number');if(l<0)throw new RangeError('The value "'+l+'" is invalid for option "size"')}function m(l,o,c){return p(l),l<=0?g(l):o!==void 0?typeof c=="string"?g(l).fill(o,c):g(l).fill(o):g(l)}u.alloc=function(l,o,c){return m(l,o,c)};function k(l){return p(l),g(l<0?0:v(l)|0)}u.allocUnsafe=function(l){return k(l)},u.allocUnsafeSlow=function(l){return k(l)};function A(l,o){if((typeof o!="string"||o==="")&&(o="utf8"),!u.isEncoding(o))throw new TypeError("Unknown encoding: "+o);const c=pe(l,o)|0;let d=g(c);const y=d.write(l,o);return y!==c&&(d=d.slice(0,y)),d}function T(l){const o=l.length<0?0:v(l.length)|0,c=g(o);for(let d=0;d<o;d+=1)c[d]=l[d]&255;return c}function oe(l){if(Pe(l,i)){const o=new i(l);return Y(o.buffer,o.byteOffset,o.byteLength)}return T(l)}function Y(l,o,c){if(o<0||l.byteLength<o)throw new RangeError('"offset" is outside of buffer bounds');if(l.byteLength<o+(c||0))throw new RangeError('"length" is outside of buffer bounds');let d;return o===void 0&&c===void 0?d=new i(l):c===void 0?d=new i(l,o):d=new i(l,o,c),Object.setPrototypeOf(d,u.prototype),d}function I(l){if(u.isBuffer(l)){const o=v(l.length)|0,c=g(o);return c.length===0||l.copy(c,0,0,o),c}if(l.length!==void 0)return typeof l.length!="number"||ps(l.length)?g(0):T(l);if(l.type==="Buffer"&&Array.isArray(l.data))return T(l.data)}function v(l){if(l>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return l|0}function $(l){return+l!=l&&(l=0),u.alloc(+l)}u.isBuffer=function(o){return o!=null&&o._isBuffer===!0&&o!==u.prototype},u.compare=function(o,c){if(Pe(o,i)&&(o=u.from(o,o.offset,o.byteLength)),Pe(c,i)&&(c=u.from(c,c.offset,c.byteLength)),!u.isBuffer(o)||!u.isBuffer(c))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(o===c)return 0;let d=o.length,y=c.length;for(let b=0,E=Math.min(d,y);b<E;++b)if(o[b]!==c[b]){d=o[b],y=c[b];break}return d<y?-1:y<d?1:0},u.isEncoding=function(o){switch(String(o).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(o,c){if(!Array.isArray(o))throw new TypeError('"list" argument must be an Array of Buffers');if(o.length===0)return u.alloc(0);let d;if(c===void 0)for(c=0,d=0;d<o.length;++d)c+=o[d].length;const y=u.allocUnsafe(c);let b=0;for(d=0;d<o.length;++d){let E=o[d];if(Pe(E,i))b+E.length>y.length?(u.isBuffer(E)||(E=u.from(E)),E.copy(y,b)):i.prototype.set.call(y,E,b);else if(u.isBuffer(E))E.copy(y,b);else throw new TypeError('"list" argument must be an Array of Buffers');b+=E.length}return y};function pe(l,o){if(u.isBuffer(l))return l.length;if(a.isView(l)||Pe(l,a))return l.byteLength;if(typeof l!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof l);const c=l.length,d=arguments.length>2&&arguments[2]===!0;if(!d&&c===0)return 0;let y=!1;for(;;)switch(o){case"ascii":case"latin1":case"binary":return c;case"utf8":case"utf-8":return ds(l).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return c*2;case"hex":return c>>>1;case"base64":return Ri(l).length;default:if(y)return d?-1:ds(l).length;o=(""+o).toLowerCase(),y=!0}}u.byteLength=pe;function mt(l,o,c){let d=!1;if((o===void 0||o<0)&&(o=0),o>this.length||((c===void 0||c>this.length)&&(c=this.length),c<=0)||(c>>>=0,o>>>=0,c<=o))return"";for(l||(l="utf8");;)switch(l){case"hex":return Ue(this,o,c);case"utf8":case"utf-8":return _(this,o,c);case"ascii":return ge(this,o,c);case"latin1":case"binary":return ce(this,o,c);case"base64":return q(this,o,c);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return P(this,o,c);default:if(d)throw new TypeError("Unknown encoding: "+l);l=(l+"").toLowerCase(),d=!0}}u.prototype._isBuffer=!0;function be(l,o,c){const d=l[o];l[o]=l[c],l[c]=d}u.prototype.swap16=function(){const o=this.length;if(o%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let c=0;c<o;c+=2)be(this,c,c+1);return this},u.prototype.swap32=function(){const o=this.length;if(o%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let c=0;c<o;c+=4)be(this,c,c+3),be(this,c+1,c+2);return this},u.prototype.swap64=function(){const o=this.length;if(o%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let c=0;c<o;c+=8)be(this,c,c+7),be(this,c+1,c+6),be(this,c+2,c+5),be(this,c+3,c+4);return this},u.prototype.toString=function(){const o=this.length;return o===0?"":arguments.length===0?_(this,0,o):mt.apply(this,arguments)},u.prototype.toLocaleString=u.prototype.toString,u.prototype.equals=function(o){if(!u.isBuffer(o))throw new TypeError("Argument must be a Buffer");return this===o?!0:u.compare(this,o)===0},u.prototype.inspect=function(){let o="";const c=t.INSPECT_MAX_BYTES;return o=this.toString("hex",0,c).replace(/(.{2})/g,"$1 ").trim(),this.length>c&&(o+=" ... "),"<Buffer "+o+">"},r&&(u.prototype[r]=u.prototype.inspect),u.prototype.compare=function(o,c,d,y,b){if(Pe(o,i)&&(o=u.from(o,o.offset,o.byteLength)),!u.isBuffer(o))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof o);if(c===void 0&&(c=0),d===void 0&&(d=o?o.length:0),y===void 0&&(y=0),b===void 0&&(b=this.length),c<0||d>o.length||y<0||b>this.length)throw new RangeError("out of range index");if(y>=b&&c>=d)return 0;if(y>=b)return-1;if(c>=d)return 1;if(c>>>=0,d>>>=0,y>>>=0,b>>>=0,this===o)return 0;let E=b-y,R=d-c;const X=Math.min(E,R),W=this.slice(y,b),Z=o.slice(c,d);for(let V=0;V<X;++V)if(W[V]!==Z[V]){E=W[V],R=Z[V];break}return E<R?-1:R<E?1:0};function Pt(l,o,c,d,y){if(l.length===0)return-1;if(typeof c=="string"?(d=c,c=0):c>2147483647?c=2147483647:c<-2147483648&&(c=-2147483648),c=+c,ps(c)&&(c=y?0:l.length-1),c<0&&(c=l.length+c),c>=l.length){if(y)return-1;c=l.length-1}else if(c<0)if(y)c=0;else return-1;if(typeof o=="string"&&(o=u.from(o,d)),u.isBuffer(o))return o.length===0?-1:bt(l,o,c,d,y);if(typeof o=="number")return o=o&255,typeof i.prototype.indexOf=="function"?y?i.prototype.indexOf.call(l,o,c):i.prototype.lastIndexOf.call(l,o,c):bt(l,[o],c,d,y);throw new TypeError("val must be string, number or Buffer")}function bt(l,o,c,d,y){let b=1,E=l.length,R=o.length;if(d!==void 0&&(d=String(d).toLowerCase(),d==="ucs2"||d==="ucs-2"||d==="utf16le"||d==="utf-16le")){if(l.length<2||o.length<2)return-1;b=2,E/=2,R/=2,c/=2}function X(Z,V){return b===1?Z[V]:Z.readUInt16BE(V*b)}let W;if(y){let Z=-1;for(W=c;W<E;W++)if(X(l,W)===X(o,Z===-1?0:W-Z)){if(Z===-1&&(Z=W),W-Z+1===R)return Z*b}else Z!==-1&&(W-=W-Z),Z=-1}else for(c+R>E&&(c=E-R),W=c;W>=0;W--){let Z=!0;for(let V=0;V<R;V++)if(X(l,W+V)!==X(o,V)){Z=!1;break}if(Z)return W}return-1}u.prototype.includes=function(o,c,d){return this.indexOf(o,c,d)!==-1},u.prototype.indexOf=function(o,c,d){return Pt(this,o,c,d,!0)},u.prototype.lastIndexOf=function(o,c,d){return Pt(this,o,c,d,!1)};function Vt(l,o,c,d){c=Number(c)||0;const y=l.length-c;d?(d=Number(d),d>y&&(d=y)):d=y;const b=o.length;d>b/2&&(d=b/2);let E;for(E=0;E<d;++E){const R=parseInt(o.substr(E*2,2),16);if(ps(R))return E;l[c+E]=R}return E}function S(l,o,c,d){return hr(ds(o,l.length-c),l,c,d)}function x(l,o,c,d){return hr(Ea(o),l,c,d)}function D(l,o,c,d){return hr(Ri(o),l,c,d)}function B(l,o,c,d){return hr(ka(o,l.length-c),l,c,d)}u.prototype.write=function(o,c,d,y){if(c===void 0)y="utf8",d=this.length,c=0;else if(d===void 0&&typeof c=="string")y=c,d=this.length,c=0;else if(isFinite(c))c=c>>>0,isFinite(d)?(d=d>>>0,y===void 0&&(y="utf8")):(y=d,d=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const b=this.length-c;if((d===void 0||d>b)&&(d=b),o.length>0&&(d<0||c<0)||c>this.length)throw new RangeError("Attempt to write outside buffer bounds");y||(y="utf8");let E=!1;for(;;)switch(y){case"hex":return Vt(this,o,c,d);case"utf8":case"utf-8":return S(this,o,c,d);case"ascii":case"latin1":case"binary":return x(this,o,c,d);case"base64":return D(this,o,c,d);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return B(this,o,c,d);default:if(E)throw new TypeError("Unknown encoding: "+y);y=(""+y).toLowerCase(),E=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function q(l,o,c){return o===0&&c===l.length?e.fromByteArray(l):e.fromByteArray(l.slice(o,c))}function _(l,o,c){c=Math.min(l.length,c);const d=[];let y=o;for(;y<c;){const b=l[y];let E=null,R=b>239?4:b>223?3:b>191?2:1;if(y+R<=c){let X,W,Z,V;switch(R){case 1:b<128&&(E=b);break;case 2:X=l[y+1],(X&192)===128&&(V=(b&31)<<6|X&63,V>127&&(E=V));break;case 3:X=l[y+1],W=l[y+2],(X&192)===128&&(W&192)===128&&(V=(b&15)<<12|(X&63)<<6|W&63,V>2047&&(V<55296||V>57343)&&(E=V));break;case 4:X=l[y+1],W=l[y+2],Z=l[y+3],(X&192)===128&&(W&192)===128&&(Z&192)===128&&(V=(b&15)<<18|(X&63)<<12|(W&63)<<6|Z&63,V>65535&&V<1114112&&(E=V))}}E===null?(E=65533,R=1):E>65535&&(E-=65536,d.push(E>>>10&1023|55296),E=56320|E&1023),d.push(E),y+=R}return z(d)}const M=4096;function z(l){const o=l.length;if(o<=M)return String.fromCharCode.apply(String,l);let c="",d=0;for(;d<o;)c+=String.fromCharCode.apply(String,l.slice(d,d+=M));return c}function ge(l,o,c){let d="";c=Math.min(l.length,c);for(let y=o;y<c;++y)d+=String.fromCharCode(l[y]&127);return d}function ce(l,o,c){let d="";c=Math.min(l.length,c);for(let y=o;y<c;++y)d+=String.fromCharCode(l[y]);return d}function Ue(l,o,c){const d=l.length;(!o||o<0)&&(o=0),(!c||c<0||c>d)&&(c=d);let y="";for(let b=o;b<c;++b)y+=Sa[l[b]];return y}function P(l,o,c){const d=l.slice(o,c);let y="";for(let b=0;b<d.length-1;b+=2)y+=String.fromCharCode(d[b]+d[b+1]*256);return y}u.prototype.slice=function(o,c){const d=this.length;o=~~o,c=c===void 0?d:~~c,o<0?(o+=d,o<0&&(o=0)):o>d&&(o=d),c<0?(c+=d,c<0&&(c=0)):c>d&&(c=d),c<o&&(c=o);const y=this.subarray(o,c);return Object.setPrototypeOf(y,u.prototype),y};function L(l,o,c){if(l%1!==0||l<0)throw new RangeError("offset is not uint");if(l+o>c)throw new RangeError("Trying to access beyond buffer length")}u.prototype.readUintLE=u.prototype.readUIntLE=function(o,c,d){o=o>>>0,c=c>>>0,d||L(o,c,this.length);let y=this[o],b=1,E=0;for(;++E<c&&(b*=256);)y+=this[o+E]*b;return y},u.prototype.readUintBE=u.prototype.readUIntBE=function(o,c,d){o=o>>>0,c=c>>>0,d||L(o,c,this.length);let y=this[o+--c],b=1;for(;c>0&&(b*=256);)y+=this[o+--c]*b;return y},u.prototype.readUint8=u.prototype.readUInt8=function(o,c){return o=o>>>0,c||L(o,1,this.length),this[o]},u.prototype.readUint16LE=u.prototype.readUInt16LE=function(o,c){return o=o>>>0,c||L(o,2,this.length),this[o]|this[o+1]<<8},u.prototype.readUint16BE=u.prototype.readUInt16BE=function(o,c){return o=o>>>0,c||L(o,2,this.length),this[o]<<8|this[o+1]},u.prototype.readUint32LE=u.prototype.readUInt32LE=function(o,c){return o=o>>>0,c||L(o,4,this.length),(this[o]|this[o+1]<<8|this[o+2]<<16)+this[o+3]*16777216},u.prototype.readUint32BE=u.prototype.readUInt32BE=function(o,c){return o=o>>>0,c||L(o,4,this.length),this[o]*16777216+(this[o+1]<<16|this[o+2]<<8|this[o+3])},u.prototype.readBigUInt64LE=ht(function(o){o=o>>>0,jt(o,"offset");const c=this[o],d=this[o+7];(c===void 0||d===void 0)&&xn(o,this.length-8);const y=c+this[++o]*2**8+this[++o]*2**16+this[++o]*2**24,b=this[++o]+this[++o]*2**8+this[++o]*2**16+d*2**24;return BigInt(y)+(BigInt(b)<<BigInt(32))}),u.prototype.readBigUInt64BE=ht(function(o){o=o>>>0,jt(o,"offset");const c=this[o],d=this[o+7];(c===void 0||d===void 0)&&xn(o,this.length-8);const y=c*2**24+this[++o]*2**16+this[++o]*2**8+this[++o],b=this[++o]*2**24+this[++o]*2**16+this[++o]*2**8+d;return(BigInt(y)<<BigInt(32))+BigInt(b)}),u.prototype.readIntLE=function(o,c,d){o=o>>>0,c=c>>>0,d||L(o,c,this.length);let y=this[o],b=1,E=0;for(;++E<c&&(b*=256);)y+=this[o+E]*b;return b*=128,y>=b&&(y-=Math.pow(2,8*c)),y},u.prototype.readIntBE=function(o,c,d){o=o>>>0,c=c>>>0,d||L(o,c,this.length);let y=c,b=1,E=this[o+--y];for(;y>0&&(b*=256);)E+=this[o+--y]*b;return b*=128,E>=b&&(E-=Math.pow(2,8*c)),E},u.prototype.readInt8=function(o,c){return o=o>>>0,c||L(o,1,this.length),this[o]&128?(255-this[o]+1)*-1:this[o]},u.prototype.readInt16LE=function(o,c){o=o>>>0,c||L(o,2,this.length);const d=this[o]|this[o+1]<<8;return d&32768?d|4294901760:d},u.prototype.readInt16BE=function(o,c){o=o>>>0,c||L(o,2,this.length);const d=this[o+1]|this[o]<<8;return d&32768?d|4294901760:d},u.prototype.readInt32LE=function(o,c){return o=o>>>0,c||L(o,4,this.length),this[o]|this[o+1]<<8|this[o+2]<<16|this[o+3]<<24},u.prototype.readInt32BE=function(o,c){return o=o>>>0,c||L(o,4,this.length),this[o]<<24|this[o+1]<<16|this[o+2]<<8|this[o+3]},u.prototype.readBigInt64LE=ht(function(o){o=o>>>0,jt(o,"offset");const c=this[o],d=this[o+7];(c===void 0||d===void 0)&&xn(o,this.length-8);const y=this[o+4]+this[o+5]*2**8+this[o+6]*2**16+(d<<24);return(BigInt(y)<<BigInt(32))+BigInt(c+this[++o]*2**8+this[++o]*2**16+this[++o]*2**24)}),u.prototype.readBigInt64BE=ht(function(o){o=o>>>0,jt(o,"offset");const c=this[o],d=this[o+7];(c===void 0||d===void 0)&&xn(o,this.length-8);const y=(c<<24)+this[++o]*2**16+this[++o]*2**8+this[++o];return(BigInt(y)<<BigInt(32))+BigInt(this[++o]*2**24+this[++o]*2**16+this[++o]*2**8+d)}),u.prototype.readFloatLE=function(o,c){return o=o>>>0,c||L(o,4,this.length),n.read(this,o,!0,23,4)},u.prototype.readFloatBE=function(o,c){return o=o>>>0,c||L(o,4,this.length),n.read(this,o,!1,23,4)},u.prototype.readDoubleLE=function(o,c){return o=o>>>0,c||L(o,8,this.length),n.read(this,o,!0,52,8)},u.prototype.readDoubleBE=function(o,c){return o=o>>>0,c||L(o,8,this.length),n.read(this,o,!1,52,8)};function G(l,o,c,d,y,b){if(!u.isBuffer(l))throw new TypeError('"buffer" argument must be a Buffer instance');if(o>y||o<b)throw new RangeError('"value" argument is out of bounds');if(c+d>l.length)throw new RangeError("Index out of range")}u.prototype.writeUintLE=u.prototype.writeUIntLE=function(o,c,d,y){if(o=+o,c=c>>>0,d=d>>>0,!y){const R=Math.pow(2,8*d)-1;G(this,o,c,d,R,0)}let b=1,E=0;for(this[c]=o&255;++E<d&&(b*=256);)this[c+E]=o/b&255;return c+d},u.prototype.writeUintBE=u.prototype.writeUIntBE=function(o,c,d,y){if(o=+o,c=c>>>0,d=d>>>0,!y){const R=Math.pow(2,8*d)-1;G(this,o,c,d,R,0)}let b=d-1,E=1;for(this[c+b]=o&255;--b>=0&&(E*=256);)this[c+b]=o/E&255;return c+d},u.prototype.writeUint8=u.prototype.writeUInt8=function(o,c,d){return o=+o,c=c>>>0,d||G(this,o,c,1,255,0),this[c]=o&255,c+1},u.prototype.writeUint16LE=u.prototype.writeUInt16LE=function(o,c,d){return o=+o,c=c>>>0,d||G(this,o,c,2,65535,0),this[c]=o&255,this[c+1]=o>>>8,c+2},u.prototype.writeUint16BE=u.prototype.writeUInt16BE=function(o,c,d){return o=+o,c=c>>>0,d||G(this,o,c,2,65535,0),this[c]=o>>>8,this[c+1]=o&255,c+2},u.prototype.writeUint32LE=u.prototype.writeUInt32LE=function(o,c,d){return o=+o,c=c>>>0,d||G(this,o,c,4,4294967295,0),this[c+3]=o>>>24,this[c+2]=o>>>16,this[c+1]=o>>>8,this[c]=o&255,c+4},u.prototype.writeUint32BE=u.prototype.writeUInt32BE=function(o,c,d){return o=+o,c=c>>>0,d||G(this,o,c,4,4294967295,0),this[c]=o>>>24,this[c+1]=o>>>16,this[c+2]=o>>>8,this[c+3]=o&255,c+4};function K(l,o,c,d,y){Oi(o,d,y,l,c,7);let b=Number(o&BigInt(4294967295));l[c++]=b,b=b>>8,l[c++]=b,b=b>>8,l[c++]=b,b=b>>8,l[c++]=b;let E=Number(o>>BigInt(32)&BigInt(4294967295));return l[c++]=E,E=E>>8,l[c++]=E,E=E>>8,l[c++]=E,E=E>>8,l[c++]=E,c}function ne(l,o,c,d,y){Oi(o,d,y,l,c,7);let b=Number(o&BigInt(4294967295));l[c+7]=b,b=b>>8,l[c+6]=b,b=b>>8,l[c+5]=b,b=b>>8,l[c+4]=b;let E=Number(o>>BigInt(32)&BigInt(4294967295));return l[c+3]=E,E=E>>8,l[c+2]=E,E=E>>8,l[c+1]=E,E=E>>8,l[c]=E,c+8}u.prototype.writeBigUInt64LE=ht(function(o,c=0){return K(this,o,c,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeBigUInt64BE=ht(function(o,c=0){return ne(this,o,c,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeIntLE=function(o,c,d,y){if(o=+o,c=c>>>0,!y){const X=Math.pow(2,8*d-1);G(this,o,c,d,X-1,-X)}let b=0,E=1,R=0;for(this[c]=o&255;++b<d&&(E*=256);)o<0&&R===0&&this[c+b-1]!==0&&(R=1),this[c+b]=(o/E>>0)-R&255;return c+d},u.prototype.writeIntBE=function(o,c,d,y){if(o=+o,c=c>>>0,!y){const X=Math.pow(2,8*d-1);G(this,o,c,d,X-1,-X)}let b=d-1,E=1,R=0;for(this[c+b]=o&255;--b>=0&&(E*=256);)o<0&&R===0&&this[c+b+1]!==0&&(R=1),this[c+b]=(o/E>>0)-R&255;return c+d},u.prototype.writeInt8=function(o,c,d){return o=+o,c=c>>>0,d||G(this,o,c,1,127,-128),o<0&&(o=255+o+1),this[c]=o&255,c+1},u.prototype.writeInt16LE=function(o,c,d){return o=+o,c=c>>>0,d||G(this,o,c,2,32767,-32768),this[c]=o&255,this[c+1]=o>>>8,c+2},u.prototype.writeInt16BE=function(o,c,d){return o=+o,c=c>>>0,d||G(this,o,c,2,32767,-32768),this[c]=o>>>8,this[c+1]=o&255,c+2},u.prototype.writeInt32LE=function(o,c,d){return o=+o,c=c>>>0,d||G(this,o,c,4,2147483647,-2147483648),this[c]=o&255,this[c+1]=o>>>8,this[c+2]=o>>>16,this[c+3]=o>>>24,c+4},u.prototype.writeInt32BE=function(o,c,d){return o=+o,c=c>>>0,d||G(this,o,c,4,2147483647,-2147483648),o<0&&(o=4294967295+o+1),this[c]=o>>>24,this[c+1]=o>>>16,this[c+2]=o>>>8,this[c+3]=o&255,c+4},u.prototype.writeBigInt64LE=ht(function(o,c=0){return K(this,o,c,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),u.prototype.writeBigInt64BE=ht(function(o,c=0){return ne(this,o,c,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function re(l,o,c,d,y,b){if(c+d>l.length)throw new RangeError("Index out of range");if(c<0)throw new RangeError("Index out of range")}function ae(l,o,c,d,y){return o=+o,c=c>>>0,y||re(l,o,c,4),n.write(l,o,c,d,23,4),c+4}u.prototype.writeFloatLE=function(o,c,d){return ae(this,o,c,!0,d)},u.prototype.writeFloatBE=function(o,c,d){return ae(this,o,c,!1,d)};function ve(l,o,c,d,y){return o=+o,c=c>>>0,y||re(l,o,c,8),n.write(l,o,c,d,52,8),c+8}u.prototype.writeDoubleLE=function(o,c,d){return ve(this,o,c,!0,d)},u.prototype.writeDoubleBE=function(o,c,d){return ve(this,o,c,!1,d)},u.prototype.copy=function(o,c,d,y){if(!u.isBuffer(o))throw new TypeError("argument should be a Buffer");if(d||(d=0),!y&&y!==0&&(y=this.length),c>=o.length&&(c=o.length),c||(c=0),y>0&&y<d&&(y=d),y===d||o.length===0||this.length===0)return 0;if(c<0)throw new RangeError("targetStart out of bounds");if(d<0||d>=this.length)throw new RangeError("Index out of range");if(y<0)throw new RangeError("sourceEnd out of bounds");y>this.length&&(y=this.length),o.length-c<y-d&&(y=o.length-c+d);const b=y-d;return this===o&&typeof i.prototype.copyWithin=="function"?this.copyWithin(c,d,y):i.prototype.set.call(o,this.subarray(d,y),c),b},u.prototype.fill=function(o,c,d,y){if(typeof o=="string"){if(typeof c=="string"?(y=c,c=0,d=this.length):typeof d=="string"&&(y=d,d=this.length),y!==void 0&&typeof y!="string")throw new TypeError("encoding must be a string");if(typeof y=="string"&&!u.isEncoding(y))throw new TypeError("Unknown encoding: "+y);if(o.length===1){const E=o.charCodeAt(0);(y==="utf8"&&E<128||y==="latin1")&&(o=E)}}else typeof o=="number"?o=o&255:typeof o=="boolean"&&(o=Number(o));if(c<0||this.length<c||this.length<d)throw new RangeError("Out of range index");if(d<=c)return this;c=c>>>0,d=d===void 0?this.length:d>>>0,o||(o=0);let b;if(typeof o=="number")for(b=c;b<d;++b)this[b]=o;else{const E=u.isBuffer(o)?o:u.from(o,y),R=E.length;if(R===0)throw new TypeError('The value "'+o+'" is invalid for argument "value"');for(b=0;b<d-c;++b)this[b+c]=E[b%R]}return this};const we={};function Se(l,o,c){we[l]=class extends c{constructor(){super(),Object.defineProperty(this,"message",{value:o.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${l}]`,this.stack,delete this.name}get code(){return l}set code(y){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:y,writable:!0})}toString(){return`${this.name} [${l}]: ${this.message}`}}}Se("ERR_BUFFER_OUT_OF_BOUNDS",function(l){return l?`${l} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),Se("ERR_INVALID_ARG_TYPE",function(l,o){return`The "${l}" argument must be of type number. Received type ${typeof o}`},TypeError),Se("ERR_OUT_OF_RANGE",function(l,o,c){let d=`The value of "${l}" is out of range.`,y=c;return Number.isInteger(c)&&Math.abs(c)>2**32?y=lr(String(c)):typeof c=="bigint"&&(y=String(c),(c>BigInt(2)**BigInt(32)||c<-(BigInt(2)**BigInt(32)))&&(y=lr(y)),y+="n"),d+=` It must be ${o}. Received ${y}`,d},RangeError);function lr(l){let o="",c=l.length;const d=l[0]==="-"?1:0;for(;c>=d+4;c-=3)o=`_${l.slice(c-3,c)}${o}`;return`${l.slice(0,c)}${o}`}function ur(l,o,c){jt(o,"offset"),(l[o]===void 0||l[o+c]===void 0)&&xn(o,l.length-(c+1))}function Oi(l,o,c,d,y,b){if(l>c||l<o){const E=typeof o=="bigint"?"n":"";let R;throw o===0||o===BigInt(0)?R=`>= 0${E} and < 2${E} ** ${(b+1)*8}${E}`:R=`>= -(2${E} ** ${(b+1)*8-1}${E}) and < 2 ** ${(b+1)*8-1}${E}`,new we.ERR_OUT_OF_RANGE("value",R,l)}ur(d,y,b)}function jt(l,o){if(typeof l!="number")throw new we.ERR_INVALID_ARG_TYPE(o,"number",l)}function xn(l,o,c){throw Math.floor(l)!==l?(jt(l,c),new we.ERR_OUT_OF_RANGE("offset","an integer",l)):o<0?new we.ERR_BUFFER_OUT_OF_BOUNDS:new we.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${o}`,l)}const ma=/[^+/0-9A-Za-z-_]/g;function ba(l){if(l=l.split("=")[0],l=l.trim().replace(ma,""),l.length<2)return"";for(;l.length%4!==0;)l=l+"=";return l}function ds(l,o){o=o||1/0;let c;const d=l.length;let y=null;const b=[];for(let E=0;E<d;++E){if(c=l.charCodeAt(E),c>55295&&c<57344){if(!y){if(c>56319){(o-=3)>-1&&b.push(239,191,189);continue}else if(E+1===d){(o-=3)>-1&&b.push(239,191,189);continue}y=c;continue}if(c<56320){(o-=3)>-1&&b.push(239,191,189),y=c;continue}c=(y-55296<<10|c-56320)+65536}else y&&(o-=3)>-1&&b.push(239,191,189);if(y=null,c<128){if((o-=1)<0)break;b.push(c)}else if(c<2048){if((o-=2)<0)break;b.push(c>>6|192,c&63|128)}else if(c<65536){if((o-=3)<0)break;b.push(c>>12|224,c>>6&63|128,c&63|128)}else if(c<1114112){if((o-=4)<0)break;b.push(c>>18|240,c>>12&63|128,c>>6&63|128,c&63|128)}else throw new Error("Invalid code point")}return b}function Ea(l){const o=[];for(let c=0;c<l.length;++c)o.push(l.charCodeAt(c)&255);return o}function ka(l,o){let c,d,y;const b=[];for(let E=0;E<l.length&&!((o-=2)<0);++E)c=l.charCodeAt(E),d=c>>8,y=c%256,b.push(y),b.push(d);return b}function Ri(l){return e.toByteArray(ba(l))}function hr(l,o,c,d){let y;for(y=0;y<d&&!(y+c>=o.length||y>=l.length);++y)o[y+c]=l[y];return y}function Pe(l,o){return l instanceof o||l!=null&&l.constructor!=null&&l.constructor.name!=null&&l.constructor.name===o.name}function ps(l){return l!==l}const Sa=(function(){const l="0123456789abcdef",o=new Array(256);for(let c=0;c<16;++c){const d=c*16;for(let y=0;y<16;++y)o[d+y]=l[c]+l[y]}return o})();function ht(l){return typeof BigInt>"u"?Aa:l}function Aa(){throw new Error("BigInt not supported")}})(Ua);const Ee=()=>new Map,Bs=t=>{const e=Ee();return t.forEach((n,r)=>{e.set(r,n)}),e},ct=(t,e,n)=>{let r=t.get(e);return r===void 0&&t.set(e,r=n()),r},qa=(t,e)=>{const n=[];for(const[r,s]of t)n.push(e(s,r));return n},Ha=(t,e)=>{for(const[n,r]of t)if(e(r,n))return!0;return!1},Tt=()=>new Set,ms=t=>t[t.length-1],Ga=(t,e)=>{for(let n=0;n<e.length;n++)t.push(e[n])},gt=Array.from,Zs=(t,e)=>{for(let n=0;n<t.length;n++)if(!e(t[n],n,t))return!1;return!0},Lo=(t,e)=>{for(let n=0;n<t.length;n++)if(e(t[n],n,t))return!0;return!1},Ja=(t,e)=>{const n=new Array(t);for(let r=0;r<t;r++)n[r]=e(r,n);return n},Wr=Array.isArray;class Wa{constructor(){this._observers=Ee()}on(e,n){return ct(this._observers,e,Tt).add(n),n}once(e,n){const r=(...s)=>{this.off(e,r),n(...s)};this.on(e,r)}off(e,n){const r=this._observers.get(e);r!==void 0&&(r.delete(n),r.size===0&&this._observers.delete(e))}emit(e,n){return gt((this._observers.get(e)||Ee()).values()).forEach(r=>r(...n))}destroy(){this._observers=Ee()}}class za{constructor(){this._observers=Ee()}on(e,n){ct(this._observers,e,Tt).add(n)}once(e,n){const r=(...s)=>{this.off(e,r),n(...s)};this.on(e,r)}off(e,n){const r=this._observers.get(e);r!==void 0&&(r.delete(n),r.size===0&&this._observers.delete(e))}emit(e,n){return gt((this._observers.get(e)||Ee()).values()).forEach(r=>r(...n))}destroy(){this._observers=Ee()}}const Ye=Math.floor,Sr=Math.abs,No=(t,e)=>t<e?t:e,Bt=(t,e)=>t>e?t:e,Fo=t=>t!==0?t<0:1/t<0,Li=1,Ni=2,bs=4,Es=8,Ln=32,rt=64,_e=128,zr=31,Ls=63,It=127,Ya=2147483647,Or=Number.MAX_SAFE_INTEGER,Fi=Number.MIN_SAFE_INTEGER,Ka=Number.isInteger||(t=>typeof t=="number"&&isFinite(t)&&Ye(t)===t),Xa=String.fromCharCode,Za=t=>t.toLowerCase(),Qa=/^\s*/g,el=t=>t.replace(Qa,""),tl=/([A-Z])/g,$i=(t,e)=>el(t.replace(tl,n=>`${e}${Za(n)}`)),nl=t=>{const e=unescape(encodeURIComponent(t)),n=e.length,r=new Uint8Array(n);for(let s=0;s<n;s++)r[s]=e.codePointAt(s);return r},Nn=typeof TextEncoder<"u"?new TextEncoder:null,rl=t=>Nn.encode(t),sl=Nn?rl:nl;let Un=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});Un&&Un.decode(new Uint8Array).length===1&&(Un=null);const il=(t,e)=>Ja(e,()=>t).join("");class nr{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const Yr=()=>new nr,ol=t=>{let e=t.cpos;for(let n=0;n<t.bufs.length;n++)e+=t.bufs[n].length;return e},We=t=>{const e=new Uint8Array(ol(t));let n=0;for(let r=0;r<t.bufs.length;r++){const s=t.bufs[r];e.set(s,n),n+=s.length}return e.set(new Uint8Array(t.cbuf.buffer,0,t.cpos),n),e},cl=(t,e)=>{const n=t.cbuf.length;n-t.cpos<e&&(t.bufs.push(new Uint8Array(t.cbuf.buffer,0,t.cpos)),t.cbuf=new Uint8Array(Bt(n,e)*2),t.cpos=0)},ue=(t,e)=>{const n=t.cbuf.length;t.cpos===n&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(n*2),t.cpos=0),t.cbuf[t.cpos++]=e},Ns=ue,N=(t,e)=>{for(;e>It;)ue(t,_e|It&e),e=Ye(e/128);ue(t,It&e)},Qs=(t,e)=>{const n=Fo(e);for(n&&(e=-e),ue(t,(e>Ls?_e:0)|(n?rt:0)|Ls&e),e=Ye(e/64);e>0;)ue(t,(e>It?_e:0)|It&e),e=Ye(e/128)},Fs=new Uint8Array(3e4),al=Fs.length/3,ll=(t,e)=>{if(e.length<al){const n=Nn.encodeInto(e,Fs).written||0;N(t,n);for(let r=0;r<n;r++)ue(t,Fs[r])}else Ae(t,sl(e))},ul=(t,e)=>{const n=unescape(encodeURIComponent(e)),r=n.length;N(t,r);for(let s=0;s<r;s++)ue(t,n.codePointAt(s))},Xt=Nn&&Nn.encodeInto?ll:ul,Kr=(t,e)=>{const n=t.cbuf.length,r=t.cpos,s=No(n-r,e.length),i=e.length-s;t.cbuf.set(e.subarray(0,s),r),t.cpos+=s,i>0&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(Bt(n*2,i)),t.cbuf.set(e.subarray(s)),t.cpos=i)},Ae=(t,e)=>{N(t,e.byteLength),Kr(t,e)},ei=(t,e)=>{cl(t,e);const n=new DataView(t.cbuf.buffer,t.cpos,e);return t.cpos+=e,n},hl=(t,e)=>ei(t,4).setFloat32(0,e,!1),fl=(t,e)=>ei(t,8).setFloat64(0,e,!1),dl=(t,e)=>ei(t,8).setBigInt64(0,e,!1),Pi=new DataView(new ArrayBuffer(4)),pl=t=>(Pi.setFloat32(0,t),Pi.getFloat32(0)===t),Fn=(t,e)=>{switch(typeof e){case"string":ue(t,119),Xt(t,e);break;case"number":Ka(e)&&Sr(e)<=Ya?(ue(t,125),Qs(t,e)):pl(e)?(ue(t,124),hl(t,e)):(ue(t,123),fl(t,e));break;case"bigint":ue(t,122),dl(t,e);break;case"object":if(e===null)ue(t,126);else if(Wr(e)){ue(t,117),N(t,e.length);for(let n=0;n<e.length;n++)Fn(t,e[n])}else if(e instanceof Uint8Array)ue(t,116),Ae(t,e);else{ue(t,118);const n=Object.keys(e);N(t,n.length);for(let r=0;r<n.length;r++){const s=n[r];Xt(t,s),Fn(t,e[s])}}break;case"boolean":ue(t,e?120:121);break;default:ue(t,127)}};class Vi extends nr{constructor(e){super(),this.w=e,this.s=null,this.count=0}write(e){this.s===e?this.count++:(this.count>0&&N(this,this.count-1),this.count=1,this.w(this,e),this.s=e)}}const ji=t=>{t.count>0&&(Qs(t.encoder,t.count===1?t.s:-t.s),t.count>1&&N(t.encoder,t.count-2))};class Ar{constructor(){this.encoder=new nr,this.s=0,this.count=0}write(e){this.s===e?this.count++:(ji(this),this.count=1,this.s=e)}toUint8Array(){return ji(this),We(this.encoder)}}const qi=t=>{if(t.count>0){const e=t.diff*2+(t.count===1?0:1);Qs(t.encoder,e),t.count>1&&N(t.encoder,t.count-2)}};class ks{constructor(){this.encoder=new nr,this.s=0,this.count=0,this.diff=0}write(e){this.diff===e-this.s?(this.s=e,this.count++):(qi(this),this.count=1,this.diff=e-this.s,this.s=e)}toUint8Array(){return qi(this),We(this.encoder)}}class gl{constructor(){this.sarr=[],this.s="",this.lensE=new Ar}write(e){this.s+=e,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(e.length)}toUint8Array(){const e=new nr;return this.sarr.push(this.s),this.s="",Xt(e,this.sarr.join("")),Kr(e,this.lensE.toUint8Array()),We(e)}}const Fe=t=>new Error(t),Le=()=>{throw Fe("Method unimplemented")},Oe=()=>{throw Fe("Unexpected case")},$o=Fe("Unexpected end of array"),Po=Fe("Integer out of Range");class Xr{constructor(e){this.arr=e,this.pos=0}}const gn=t=>new Xr(t),wl=t=>t.pos!==t.arr.length,yl=(t,e)=>{const n=new Uint8Array(t.arr.buffer,t.pos+t.arr.byteOffset,e);return t.pos+=e,n},xe=t=>yl(t,O(t)),sn=t=>t.arr[t.pos++],O=t=>{let e=0,n=1;const r=t.arr.length;for(;t.pos<r;){const s=t.arr[t.pos++];if(e=e+(s&It)*n,n*=128,s<_e)return e;if(e>Or)throw Po}throw $o},ti=t=>{let e=t.arr[t.pos++],n=e&Ls,r=64;const s=(e&rt)>0?-1:1;if((e&_e)===0)return s*n;const i=t.arr.length;for(;t.pos<i;){if(e=t.arr[t.pos++],n=n+(e&It)*r,r*=128,e<_e)return s*n;if(n>Or)throw Po}throw $o},ml=t=>{let e=O(t);if(e===0)return"";{let n=String.fromCodePoint(sn(t));if(--e<100)for(;e--;)n+=String.fromCodePoint(sn(t));else for(;e>0;){const r=e<1e4?e:1e4,s=t.arr.subarray(t.pos,t.pos+r);t.pos+=r,n+=String.fromCodePoint.apply(null,s),e-=r}return decodeURIComponent(escape(n))}},bl=t=>Un.decode(xe(t)),Zt=Un?bl:ml,ni=(t,e)=>{const n=new DataView(t.arr.buffer,t.arr.byteOffset+t.pos,e);return t.pos+=e,n},El=t=>ni(t,4).getFloat32(0,!1),kl=t=>ni(t,8).getFloat64(0,!1),Sl=t=>ni(t,8).getBigInt64(0,!1),Al=[t=>{},t=>null,ti,El,kl,Sl,t=>!1,t=>!0,Zt,t=>{const e=O(t),n={};for(let r=0;r<e;r++){const s=Zt(t);n[s]=$n(t)}return n},t=>{const e=O(t),n=[];for(let r=0;r<e;r++)n.push($n(t));return n},xe],$n=t=>Al[127-sn(t)](t);class Hi extends Xr{constructor(e,n){super(e),this.reader=n,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),wl(this)?this.count=O(this)+1:this.count=-1),this.count--,this.s}}class xr extends Xr{constructor(e){super(e),this.s=0,this.count=0}read(){if(this.count===0){this.s=ti(this);const e=Fo(this.s);this.count=1,e&&(this.s=-this.s,this.count=O(this)+2)}return this.count--,this.s}}class Ss extends Xr{constructor(e){super(e),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const e=ti(this),n=e&1;this.diff=Ye(e/2),this.count=1,n&&(this.count=O(this)+2)}return this.s+=this.diff,this.count--,this.s}}class xl{constructor(e){this.decoder=new xr(e),this.str=Zt(this.decoder),this.spos=0}read(){const e=this.spos+this.decoder.read(),n=this.str.slice(this.spos,e);return this.spos=e,n}}const _l=crypto.getRandomValues.bind(crypto),Vo=()=>_l(new Uint32Array(1))[0],vl="10000000-1000-4000-8000"+-1e11,Il=()=>vl.replace(/[018]/g,t=>(t^Vo()&15>>t/4).toString(16)),on=t=>new Promise(t);Promise.all.bind(Promise);const Gi=t=>t===void 0?null:t;class Cl{constructor(){this.map=new Map}setItem(e,n){this.map.set(e,n)}getItem(e){return this.map.get(e)}}let jo=new Cl,Tl=!0;try{typeof localStorage<"u"&&localStorage&&(jo=localStorage,Tl=!1)}catch{}const Ml=jo,Pn=Symbol("Equality"),qo=(t,e)=>t===e||!!t?.[Pn]?.(e)||!1,Dl=t=>typeof t=="object",Ol=Object.assign,Rl=Object.keys,Ul=(t,e)=>{for(const n in t)e(t[n],n)},Rr=t=>Rl(t).length,Bl=t=>{for(const e in t)return!1;return!0},rr=(t,e)=>{for(const n in t)if(!e(t[n],n))return!1;return!0},ri=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),Ll=(t,e)=>t===e||Rr(t)===Rr(e)&&rr(t,(n,r)=>(n!==void 0||ri(e,r))&&qo(e[r],n)),Nl=Object.freeze,Ho=t=>{for(const e in t){const n=t[e];(typeof n=="object"||typeof n=="function")&&Ho(t[e])}return Nl(t)},si=(t,e,n=0)=>{try{for(;n<t.length;n++)t[n](...e)}finally{n<t.length&&si(t,e,n+1)}},Fl=t=>t,_r=(t,e)=>{if(t===e)return!0;if(t==null||e==null||t.constructor!==e.constructor&&(t.constructor||Object)!==(e.constructor||Object))return!1;if(t[Pn]!=null)return t[Pn](e);switch(t.constructor){case ArrayBuffer:t=new Uint8Array(t),e=new Uint8Array(e);case Uint8Array:{if(t.byteLength!==e.byteLength)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;break}case Set:{if(t.size!==e.size)return!1;for(const n of t)if(!e.has(n))return!1;break}case Map:{if(t.size!==e.size)return!1;for(const n of t.keys())if(!e.has(n)||!_r(t.get(n),e.get(n)))return!1;break}case void 0:case Object:if(Rr(t)!==Rr(e))return!1;for(const n in t)if(!ri(t,n)||!_r(t[n],e[n]))return!1;break;case Array:if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(!_r(t[n],e[n]))return!1;break;default:return!1}return!0},$l=(t,e)=>e.includes(t);var Go={};const Vn=typeof kt<"u"&&kt.release&&/node|io\.js/.test(kt.release.name)&&Object.prototype.toString.call(typeof kt<"u"?kt:0)==="[object process]";let Ve;const Pl=()=>{if(Ve===void 0)if(Vn){Ve=Ee();const t=kt.argv;let e=null;for(let n=0;n<t.length;n++){const r=t[n];r[0]==="-"?(e!==null&&Ve.set(e,""),e=r):e!==null&&(Ve.set(e,r),e=null)}e!==null&&Ve.set(e,"")}else typeof location=="object"?(Ve=Ee(),(location.search||"?").slice(1).split("&").forEach(t=>{if(t.length!==0){const[e,n]=t.split("=");Ve.set(`--${$i(e,"-")}`,n),Ve.set(`-${$i(e,"-")}`,n)}})):Ve=Ee();return Ve},$s=t=>Pl().has(t),Ur=t=>Gi(Vn?Go[t.toUpperCase().replaceAll("-","_")]:Ml.getItem(t)),Jo=t=>$s("--"+t)||Ur(t)!==null,Vl=Jo("production"),jl=Vn&&$l(Go.FORCE_COLOR,["true","1","2"]),ql=jl||!$s("--no-colors")&&!Jo("no-color")&&(!Vn||kt.stdout.isTTY)&&(!Vn||$s("--color")||Ur("COLORTERM")!==null||(Ur("TERM")||"").includes("color")),Hl=t=>new Uint8Array(t),Gl=t=>{const e=Hl(t.byteLength);return e.set(t),e};class Jl{constructor(e,n){this.left=e,this.right=n}}const Ze=(t,e)=>new Jl(t,e),Ji=t=>t.next()>=.5,As=(t,e,n)=>Ye(t.next()*(n+1-e)+e),Wo=(t,e,n)=>Ye(t.next()*(n+1-e)+e),ii=(t,e,n)=>Wo(t,e,n),Wl=t=>Xa(ii(t,97,122)),zl=(t,e=0,n=20)=>{const r=ii(t,e,n);let s="";for(let i=0;i<r;i++)s+=Wl(t);return s},xs=(t,e)=>e[ii(t,0,e.length-1)],Yl=Symbol("0schema");class Kl{constructor(){this._rerrs=[]}extend(e,n,r,s=null){this._rerrs.push({path:e,expected:n,has:r,message:s})}toString(){const e=[];for(let n=this._rerrs.length-1;n>0;n--){const r=this._rerrs[n];e.push(il(" ",(this._rerrs.length-n)*2)+`${r.path!=null?`[${r.path}] `:""}${r.has} doesn't match ${r.expected}. ${r.message}`)}return e.join(`
`)}}const Ps=(t,e)=>t===e?!0:t==null||e==null||t.constructor!==e.constructor?!1:t[Pn]?qo(t,e):Wr(t)?Zs(t,n=>Lo(e,r=>Ps(n,r))):Dl(t)?rr(t,(n,r)=>Ps(n,e[r])):!1;class me{static _dilutes=!1;extends(e){let[n,r]=[this.shape,e.shape];return this.constructor._dilutes&&([r,n]=[n,r]),Ps(n,r)}equals(e){return this.constructor===e.constructor&&_r(this.shape,e.shape)}[Yl](){return!0}[Pn](e){return this.equals(e)}validate(e){return this.check(e)}check(e,n){Le()}get nullable(){return wn(this,ns)}get optional(){return new Ko(this)}cast(e){return Wi(e,this),e}expect(e){return Wi(e,this),e}}class oi extends me{constructor(e,n){super(),this.shape=e,this._c=n}check(e,n=void 0){const r=e?.constructor===this.shape&&(this._c==null||this._c(e));return!r&&n?.extend(null,this.shape.name,e?.constructor.name,e?.constructor!==this.shape?"Constructor match failed":"Check failed"),r}}const te=(t,e=null)=>new oi(t,e);te(oi);class ci extends me{constructor(e){super(),this.shape=e}check(e,n){const r=this.shape(e);return!r&&n?.extend(null,"custom prop",e?.constructor.name,"failed to check custom prop"),r}}const fe=t=>new ci(t);te(ci);class Zr extends me{constructor(e){super(),this.shape=e}check(e,n){const r=this.shape.some(s=>s===e);return!r&&n?.extend(null,this.shape.join(" | "),e.toString()),r}}const Qr=(...t)=>new Zr(t),zo=te(Zr),Xl=RegExp.escape||(t=>t.replace(/[().|&,$^[\]]/g,e=>"\\"+e)),Yo=t=>{if(cn.check(t))return[Xl(t)];if(zo.check(t))return t.shape.map(e=>e+"");if(ic.check(t))return["[+-]?\\d+.?\\d*"];if(oc.check(t))return[".*"];if(Br.check(t))return t.shape.map(Yo).flat(1);Oe()};class Zl extends me{constructor(e){super(),this.shape=e,this._r=new RegExp("^"+e.map(Yo).map(n=>`(${n.join("|")})`).join("")+"$")}check(e,n){const r=this._r.exec(e)!=null;return!r&&n?.extend(null,this._r.toString(),e.toString(),"String doesn't match string template."),r}}te(Zl);const Ql=Symbol("optional");class Ko extends me{constructor(e){super(),this.shape=e}check(e,n){const r=e===void 0||this.shape.check(e);return!r&&n?.extend(null,"undefined (optional)","()"),r}get[Ql](){return!0}}const eu=te(Ko);class tu extends me{check(e,n){return n?.extend(null,"never",typeof e),!1}}te(tu);class es extends me{constructor(e,n=!1){super(),this.shape=e,this._isPartial=n}static _dilutes=!0;get partial(){return new es(this.shape,!0)}check(e,n){return e==null?(n?.extend(null,"object","null"),!1):rr(this.shape,(r,s)=>{const i=this._isPartial&&!ri(e,s)||r.check(e[s],n);return!i&&n?.extend(s.toString(),r.toString(),typeof e[s],"Object property does not match"),i})}}const nu=t=>new es(t),ru=te(es),su=fe(t=>t!=null&&(t.constructor===Object||t.constructor==null));class Xo extends me{constructor(e,n){super(),this.shape={keys:e,values:n}}check(e,n){return e!=null&&rr(e,(r,s)=>{const i=this.shape.keys.check(s,n);return!i&&n?.extend(s+"","Record",typeof e,i?"Key doesn't match schema":"Value doesn't match value"),i&&this.shape.values.check(r,n)})}}const Zo=(t,e)=>new Xo(t,e),iu=te(Xo);class Qo extends me{constructor(e){super(),this.shape=e}check(e,n){return e!=null&&rr(this.shape,(r,s)=>{const i=r.check(e[s],n);return!i&&n?.extend(s.toString(),"Tuple",typeof r),i})}}const ou=(...t)=>new Qo(t);te(Qo);class ec extends me{constructor(e){super(),this.shape=e.length===1?e[0]:new ai(e)}check(e,n){const r=Wr(e)&&Zs(e,s=>this.shape.check(s));return!r&&n?.extend(null,"Array",""),r}}const tc=(...t)=>new ec(t),cu=te(ec),au=fe(t=>Wr(t));class nc extends me{constructor(e,n){super(),this.shape=e,this._c=n}check(e,n){const r=e instanceof this.shape&&(this._c==null||this._c(e));return!r&&n?.extend(null,this.shape.name,e?.constructor.name),r}}const lu=(t,e=null)=>new nc(t,e);te(nc);const uu=lu(me);class hu extends me{constructor(e){super(),this.len=e.length-1,this.args=ou(...e.slice(-1)),this.res=e[this.len]}check(e,n){const r=e.constructor===Function&&e.length<=this.len;return!r&&n?.extend(null,"function",typeof e),r}}const fu=te(hu),du=fe(t=>typeof t=="function");class pu extends me{constructor(e){super(),this.shape=e}check(e,n){const r=Zs(this.shape,s=>s.check(e,n));return!r&&n?.extend(null,"Intersectinon",typeof e),r}}te(pu,t=>t.shape.length>0);class ai extends me{static _dilutes=!0;constructor(e){super(),this.shape=e}check(e,n){const r=Lo(this.shape,s=>s.check(e,n));return n?.extend(null,"Union",typeof e),r}}const wn=(...t)=>t.findIndex(e=>Br.check(e))>=0?wn(...t.map(e=>jn(e)).map(e=>Br.check(e)?e.shape:[e]).flat(1)):t.length===1?t[0]:new ai(t),Br=te(ai),rc=()=>!0,Lr=fe(rc),gu=te(ci,t=>t.shape===rc),li=fe(t=>typeof t=="bigint"),wu=fe(t=>t===li),sc=fe(t=>typeof t=="symbol");fe(t=>t===sc);const Qt=fe(t=>typeof t=="number"),ic=fe(t=>t===Qt),cn=fe(t=>typeof t=="string"),oc=fe(t=>t===cn),ts=fe(t=>typeof t=="boolean"),yu=fe(t=>t===ts),cc=Qr(void 0);te(Zr,t=>t.shape.length===1&&t.shape[0]===void 0);Qr(void 0);const ns=Qr(null),mu=te(Zr,t=>t.shape.length===1&&t.shape[0]===null);te(Uint8Array);te(oi,t=>t.shape===Uint8Array);const bu=wn(Qt,cn,ns,cc,li,ts,sc);(()=>{const t=tc(Lr),e=Zo(cn,Lr),n=wn(Qt,cn,ns,ts,t,e);return t.shape=n,e.shape.values=n,n})();const jn=t=>{if(uu.check(t))return t;if(su.check(t)){const e={};for(const n in t)e[n]=jn(t[n]);return nu(e)}else{if(au.check(t))return wn(...t.map(jn));if(bu.check(t))return Qr(t);if(du.check(t))return te(t)}Oe()},Wi=Vl?()=>{}:(t,e)=>{const n=new Kl;if(!e.check(t,n))throw Fe(`Expected value to be of type ${e.constructor.name}.
${n.toString()}`)};class Eu{constructor(e){this.patterns=[],this.$state=e}if(e,n){return this.patterns.push({if:jn(e),h:n}),this}else(e){return this.if(Lr,e)}done(){return(e,n)=>{for(let r=0;r<this.patterns.length;r++){const s=this.patterns[r];if(s.if.check(e))return s.h(e,n)}throw Fe("Unhandled pattern")}}}const ku=t=>new Eu(t),ac=ku(Lr).if(ic,(t,e)=>As(e,Fi,Or)).if(oc,(t,e)=>zl(e)).if(yu,(t,e)=>Ji(e)).if(wu,(t,e)=>BigInt(As(e,Fi,Or))).if(Br,(t,e)=>Ht(e,xs(e,t.shape))).if(ru,(t,e)=>{const n={};for(const r in t.shape){let s=t.shape[r];if(eu.check(s)){if(Ji(e))continue;s=s.shape}n[r]=ac(s,e)}return n}).if(cu,(t,e)=>{const n=[],r=Wo(e,0,42);for(let s=0;s<r;s++)n.push(Ht(e,t.shape));return n}).if(zo,(t,e)=>xs(e,t.shape)).if(mu,(t,e)=>null).if(fu,(t,e)=>{const n=Ht(e,t.res);return()=>n}).if(gu,(t,e)=>Ht(e,xs(e,[Qt,cn,ns,cc,li,ts,tc(Qt),Zo(wn("a","b","c"),Qt)]))).if(iu,(t,e)=>{const n={},r=As(e,0,3);for(let s=0;s<r;s++){const i=Ht(e,t.shape.keys),a=Ht(e,t.shape.values);n[i]=a}return n}).done(),Ht=(t,e)=>ac(jn(e),t),rs=typeof document<"u"?document:{};fe(t=>t.nodeType===vu);typeof DOMParser<"u"&&new DOMParser;fe(t=>t.nodeType===Au);fe(t=>t.nodeType===xu);const Su=t=>qa(t,(e,n)=>`${n}:${e};`).join(""),Au=rs.ELEMENT_NODE,xu=rs.TEXT_NODE,_u=rs.DOCUMENT_NODE,vu=rs.DOCUMENT_FRAGMENT_NODE;fe(t=>t.nodeType===_u);const at=Symbol,lc=at(),uc=at(),Iu=at(),Cu=at(),Tu=at(),hc=at(),Mu=at(),ui=at(),Du=at(),Ou=t=>{t.length===1&&t[0]?.constructor===Function&&(t=t[0]());const e=[],n=[];let r=0;for(;r<t.length;r++){const s=t[r];if(s===void 0)break;if(s.constructor===String||s.constructor===Number)e.push(s);else if(s.constructor===Object)break}for(r>0&&n.push(e.join(""));r<t.length;r++){const s=t[r];s instanceof Symbol||n.push(s)}return n},Ru={[lc]:Ze("font-weight","bold"),[uc]:Ze("font-weight","normal"),[Iu]:Ze("color","blue"),[Tu]:Ze("color","green"),[Cu]:Ze("color","grey"),[hc]:Ze("color","red"),[Mu]:Ze("color","purple"),[ui]:Ze("color","orange"),[Du]:Ze("color","black")},Uu=t=>{t.length===1&&t[0]?.constructor===Function&&(t=t[0]());const e=[],n=[],r=Ee();let s=[],i=0;for(;i<t.length;i++){const a=t[i],h=Ru[a];if(h!==void 0)r.set(h.left,h.right);else{if(a===void 0)break;if(a.constructor===String||a.constructor===Number){const f=Su(r);i>0||f.length>0?(e.push("%c"+a),n.push(f)):e.push(a)}else break}}for(i>0&&(s=n,s.unshift(e.join("")));i<t.length;i++){const a=t[i];a instanceof Symbol||s.push(a)}return s},fc=ql?Uu:Ou,Bu=(...t)=>{console.log(...fc(t)),dc.forEach(e=>e.print(t))},Lu=(...t)=>{console.warn(...fc(t)),t.unshift(ui),dc.forEach(e=>e.print(t))},dc=Tt(),pc=t=>({[Symbol.iterator](){return this},next:t}),Nu=(t,e)=>pc(()=>{let n;do n=t.next();while(!n.done&&!e(n.value));return n}),_s=(t,e)=>pc(()=>{const{done:n,value:r}=t.next();return{done:n,value:n?void 0:e(r)}});class hi{constructor(e,n){this.clock=e,this.len=n}}class sr{constructor(){this.clients=new Map}}const gc=(t,e,n)=>e.clients.forEach((r,s)=>{const i=t.doc.store.clients.get(s);if(i!=null){const a=i[i.length-1],h=a.id.clock+a.length;for(let f=0,g=r[f];f<r.length&&g.clock<h;g=r[++f])vc(t,i,g.clock,g.len,n)}}),Fu=(t,e)=>{let n=0,r=t.length-1;for(;n<=r;){const s=Ye((n+r)/2),i=t[s],a=i.clock;if(a<=e){if(e<a+i.len)return s;n=s+1}else r=s-1}return null},wc=(t,e)=>{const n=t.clients.get(e.client);return n!==void 0&&Fu(n,e.clock)!==null},fi=t=>{t.clients.forEach(e=>{e.sort((s,i)=>s.clock-i.clock);let n,r;for(n=1,r=1;n<e.length;n++){const s=e[r-1],i=e[n];s.clock+s.len>=i.clock?s.len=Bt(s.len,i.clock+i.len-s.clock):(r<n&&(e[r]=i),r++)}e.length=r})},$u=t=>{const e=new sr;for(let n=0;n<t.length;n++)t[n].clients.forEach((r,s)=>{if(!e.clients.has(s)){const i=r.slice();for(let a=n+1;a<t.length;a++)Ga(i,t[a].clients.get(s)||[]);e.clients.set(s,i)}});return fi(e),e},Nr=(t,e,n,r)=>{ct(t.clients,e,()=>[]).push(new hi(n,r))},Pu=()=>new sr,Vu=t=>{const e=Pu();return t.clients.forEach((n,r)=>{const s=[];for(let i=0;i<n.length;i++){const a=n[i];if(a.deleted){const h=a.id.clock;let f=a.length;if(i+1<n.length)for(let g=n[i+1];i+1<n.length&&g.deleted;g=n[++i+1])f+=g.length;s.push(new hi(h,f))}}s.length>0&&e.clients.set(r,s)}),e},yn=(t,e)=>{N(t.restEncoder,e.clients.size),gt(e.clients.entries()).sort((n,r)=>r[0]-n[0]).forEach(([n,r])=>{t.resetDsCurVal(),N(t.restEncoder,n);const s=r.length;N(t.restEncoder,s);for(let i=0;i<s;i++){const a=r[i];t.writeDsClock(a.clock),t.writeDsLen(a.len)}})},di=t=>{const e=new sr,n=O(t.restDecoder);for(let r=0;r<n;r++){t.resetDsCurVal();const s=O(t.restDecoder),i=O(t.restDecoder);if(i>0){const a=ct(e.clients,s,()=>[]);for(let h=0;h<i;h++)a.push(new hi(t.readDsClock(),t.readDsLen()))}}return e},zi=(t,e,n)=>{const r=new sr,s=O(t.restDecoder);for(let i=0;i<s;i++){t.resetDsCurVal();const a=O(t.restDecoder),h=O(t.restDecoder),f=n.clients.get(a)||[],g=he(n,a);for(let u=0;u<h;u++){const w=t.readDsClock(),p=w+t.readDsLen();if(w<g){g<p&&Nr(r,a,g,p-g);let m=Ke(f,w),k=f[m];for(!k.deleted&&k.id.clock<w&&(f.splice(m+1,0,Hr(e,k,w-k.id.clock)),m++);m<f.length&&(k=f[m++],k.id.clock<p);)k.deleted||(p<k.id.clock+k.length&&f.splice(m,0,Hr(e,k,p-k.id.clock)),k.delete(e))}else Nr(r,a,w,p-w)}}if(r.clients.size>0){const i=new Mt;return N(i.restEncoder,0),yn(i,r),i.toUint8Array()}return null},yc=Vo;class mn extends Wa{constructor({guid:e=Il(),collectionid:n=null,gc:r=!0,gcFilter:s=()=>!0,meta:i=null,autoLoad:a=!1,shouldLoad:h=!0}={}){super(),this.gc=r,this.gcFilter=s,this.clientID=yc(),this.guid=e,this.collectionid=n,this.share=new Map,this.store=new xc,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=h,this.autoLoad=a,this.meta=i,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=on(g=>{this.on("load",()=>{this.isLoaded=!0,g(this)})});const f=()=>on(g=>{const u=w=>{(w===void 0||w===!0)&&(this.off("sync",u),g())};this.on("sync",u)});this.on("sync",g=>{g===!1&&this.isSynced&&(this.whenSynced=f()),this.isSynced=g===void 0||g===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=f()}load(){const e=this._item;e!==null&&!this.shouldLoad&&j(e.parent.doc,n=>{n.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(gt(this.subdocs).map(e=>e.guid))}transact(e,n=null){return j(this,e,n)}get(e,n=de){const r=ct(this.share,e,()=>{const i=new n;return i._integrate(this,null),i}),s=r.constructor;if(n!==de&&s!==n)if(s===de){const i=new n;i._map=r._map,r._map.forEach(a=>{for(;a!==null;a=a.left)a.parent=i}),i._start=r._start;for(let a=i._start;a!==null;a=a.right)a.parent=i;return i._length=r._length,this.share.set(e,i),i._integrate(this,null),i}else throw new Error(`Type with the name ${e} has already been defined with a different constructor`);return r}getArray(e=""){return this.get(e,tn)}getText(e=""){return this.get(e,un)}getMap(e=""){return this.get(e,ln)}getXmlElement(e=""){return this.get(e,hn)}getXmlFragment(e=""){return this.get(e,Dt)}toJSON(){const e={};return this.share.forEach((n,r)=>{e[r]=n.toJSON()}),e}destroy(){this.isDestroyed=!0,gt(this.subdocs).forEach(n=>n.destroy());const e=this._item;if(e!==null){this._item=null;const n=e.content;n.doc=new mn({guid:this.guid,...n.opts,shouldLoad:!1}),n.doc._item=e,j(e.parent.doc,r=>{const s=n.doc;e.deleted||r.subdocsAdded.add(s),r.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}}class mc{constructor(e){this.restDecoder=e}resetDsCurVal(){}readDsClock(){return O(this.restDecoder)}readDsLen(){return O(this.restDecoder)}}class bc extends mc{readLeftID(){return U(O(this.restDecoder),O(this.restDecoder))}readRightID(){return U(O(this.restDecoder),O(this.restDecoder))}readClient(){return O(this.restDecoder)}readInfo(){return sn(this.restDecoder)}readString(){return Zt(this.restDecoder)}readParentInfo(){return O(this.restDecoder)===1}readTypeRef(){return O(this.restDecoder)}readLen(){return O(this.restDecoder)}readAny(){return $n(this.restDecoder)}readBuf(){return Gl(xe(this.restDecoder))}readJSON(){return JSON.parse(Zt(this.restDecoder))}readKey(){return Zt(this.restDecoder)}}class ju{constructor(e){this.dsCurrVal=0,this.restDecoder=e}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=O(this.restDecoder),this.dsCurrVal}readDsLen(){const e=O(this.restDecoder)+1;return this.dsCurrVal+=e,e}}class an extends ju{constructor(e){super(e),this.keys=[],O(e),this.keyClockDecoder=new Ss(xe(e)),this.clientDecoder=new xr(xe(e)),this.leftClockDecoder=new Ss(xe(e)),this.rightClockDecoder=new Ss(xe(e)),this.infoDecoder=new Hi(xe(e),sn),this.stringDecoder=new xl(xe(e)),this.parentInfoDecoder=new Hi(xe(e),sn),this.typeRefDecoder=new xr(xe(e)),this.lenDecoder=new xr(xe(e))}readLeftID(){return new en(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new en(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return $n(this.restDecoder)}readBuf(){return xe(this.restDecoder)}readJSON(){return $n(this.restDecoder)}readKey(){const e=this.keyClockDecoder.read();if(e<this.keys.length)return this.keys[e];{const n=this.stringDecoder.read();return this.keys.push(n),n}}}class qu{constructor(){this.restEncoder=Yr()}toUint8Array(){return We(this.restEncoder)}resetDsCurVal(){}writeDsClock(e){N(this.restEncoder,e)}writeDsLen(e){N(this.restEncoder,e)}}class ir extends qu{writeLeftID(e){N(this.restEncoder,e.client),N(this.restEncoder,e.clock)}writeRightID(e){N(this.restEncoder,e.client),N(this.restEncoder,e.clock)}writeClient(e){N(this.restEncoder,e)}writeInfo(e){Ns(this.restEncoder,e)}writeString(e){Xt(this.restEncoder,e)}writeParentInfo(e){N(this.restEncoder,e?1:0)}writeTypeRef(e){N(this.restEncoder,e)}writeLen(e){N(this.restEncoder,e)}writeAny(e){Fn(this.restEncoder,e)}writeBuf(e){Ae(this.restEncoder,e)}writeJSON(e){Xt(this.restEncoder,JSON.stringify(e))}writeKey(e){Xt(this.restEncoder,e)}}class Hu{constructor(){this.restEncoder=Yr(),this.dsCurrVal=0}toUint8Array(){return We(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(e){const n=e-this.dsCurrVal;this.dsCurrVal=e,N(this.restEncoder,n)}writeDsLen(e){e===0&&Oe(),N(this.restEncoder,e-1),this.dsCurrVal+=e}}class Mt extends Hu{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new ks,this.clientEncoder=new Ar,this.leftClockEncoder=new ks,this.rightClockEncoder=new ks,this.infoEncoder=new Vi(Ns),this.stringEncoder=new gl,this.parentInfoEncoder=new Vi(Ns),this.typeRefEncoder=new Ar,this.lenEncoder=new Ar}toUint8Array(){const e=Yr();return N(e,0),Ae(e,this.keyClockEncoder.toUint8Array()),Ae(e,this.clientEncoder.toUint8Array()),Ae(e,this.leftClockEncoder.toUint8Array()),Ae(e,this.rightClockEncoder.toUint8Array()),Ae(e,We(this.infoEncoder)),Ae(e,this.stringEncoder.toUint8Array()),Ae(e,We(this.parentInfoEncoder)),Ae(e,this.typeRefEncoder.toUint8Array()),Ae(e,this.lenEncoder.toUint8Array()),Kr(e,We(this.restEncoder)),We(e)}writeLeftID(e){this.clientEncoder.write(e.client),this.leftClockEncoder.write(e.clock)}writeRightID(e){this.clientEncoder.write(e.client),this.rightClockEncoder.write(e.clock)}writeClient(e){this.clientEncoder.write(e)}writeInfo(e){this.infoEncoder.write(e)}writeString(e){this.stringEncoder.write(e)}writeParentInfo(e){this.parentInfoEncoder.write(e?1:0)}writeTypeRef(e){this.typeRefEncoder.write(e)}writeLen(e){this.lenEncoder.write(e)}writeAny(e){Fn(this.restEncoder,e)}writeBuf(e){Ae(this.restEncoder,e)}writeJSON(e){Fn(this.restEncoder,e)}writeKey(e){const n=this.keyMap.get(e);n===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(e)):this.keyClockEncoder.write(n)}}const Gu=(t,e,n,r)=>{r=Bt(r,e[0].id.clock);const s=Ke(e,r);N(t.restEncoder,e.length-s),t.writeClient(n),N(t.restEncoder,r);const i=e[s];i.write(t,r-i.id.clock);for(let a=s+1;a<e.length;a++)e[a].write(t,0)},pi=(t,e,n)=>{const r=new Map;n.forEach((s,i)=>{he(e,i)>s&&r.set(i,s)}),gi(e).forEach((s,i)=>{n.has(i)||r.set(i,0)}),N(t.restEncoder,r.size),gt(r.entries()).sort((s,i)=>i[0]-s[0]).forEach(([s,i])=>{Gu(t,e.clients.get(s),s,i)})},Ju=(t,e)=>{const n=Ee(),r=O(t.restDecoder);for(let s=0;s<r;s++){const i=O(t.restDecoder),a=new Array(i),h=t.readClient();let f=O(t.restDecoder);n.set(h,{i:0,refs:a});for(let g=0;g<i;g++){const u=t.readInfo();switch(zr&u){case 0:{const w=t.readLen();a[g]=new Me(U(h,f),w),f+=w;break}case 10:{const w=O(t.restDecoder);a[g]=new De(U(h,f),w),f+=w;break}default:{const w=(u&(rt|_e))===0,p=new se(U(h,f),null,(u&_e)===_e?t.readLeftID():null,null,(u&rt)===rt?t.readRightID():null,w?t.readParentInfo()?e.get(t.readString()):t.readLeftID():null,w&&(u&Ln)===Ln?t.readString():null,Gc(t,u));a[g]=p,f+=p.length}}}}return n},Wu=(t,e,n)=>{const r=[];let s=gt(n.keys()).sort((m,k)=>m-k);if(s.length===0)return null;const i=()=>{if(s.length===0)return null;let m=n.get(s[s.length-1]);for(;m.refs.length===m.i;)if(s.pop(),s.length>0)m=n.get(s[s.length-1]);else return null;return m};let a=i();if(a===null)return null;const h=new xc,f=new Map,g=(m,k)=>{const A=f.get(m);(A==null||A>k)&&f.set(m,k)};let u=a.refs[a.i++];const w=new Map,p=()=>{for(const m of r){const k=m.id.client,A=n.get(k);A?(A.i--,h.clients.set(k,A.refs.slice(A.i)),n.delete(k),A.i=0,A.refs=[]):h.clients.set(k,[m]),s=s.filter(T=>T!==k)}r.length=0};for(;;){if(u.constructor!==De){const k=ct(w,u.id.client,()=>he(e,u.id.client))-u.id.clock;if(k<0)r.push(u),g(u.id.client,u.id.clock-1),p();else{const A=u.getMissing(t,e);if(A!==null){r.push(u);const T=n.get(A)||{refs:[],i:0};if(T.refs.length===T.i)g(A,he(e,A)),p();else{u=T.refs[T.i++];continue}}else(k===0||k<u.length)&&(u.integrate(t,k),w.set(u.id.client,u.id.clock+u.length))}}if(r.length>0)u=r.pop();else if(a!==null&&a.i<a.refs.length)u=a.refs[a.i++];else{if(a=i(),a===null)break;u=a.refs[a.i++]}}if(h.clients.size>0){const m=new Mt;return pi(m,h,new Map),N(m.restEncoder,0),{missing:f,update:m.toUint8Array()}}return null},zu=(t,e)=>pi(t,e.doc.store,e.beforeState),Yu=(t,e,n,r=new an(t))=>j(e,s=>{s.local=!1;let i=!1;const a=s.doc,h=a.store,f=Ju(r,a),g=Wu(s,h,f),u=h.pendingStructs;if(u){for(const[p,m]of u.missing)if(m<he(h,p)){i=!0;break}if(g){for(const[p,m]of g.missing){const k=u.missing.get(p);(k==null||k>m)&&u.missing.set(p,m)}u.update=Fr([u.update,g.update])}}else h.pendingStructs=g;const w=zi(r,s,h);if(h.pendingDs){const p=new an(gn(h.pendingDs));O(p.restDecoder);const m=zi(p,s,h);w&&m?h.pendingDs=Fr([w,m]):h.pendingDs=w||m}else h.pendingDs=w;if(i){const p=h.pendingStructs.update;h.pendingStructs=null,Ec(s.doc,p)}},n,!1),Ec=(t,e,n,r=an)=>{const s=gn(e);Yu(s,t,n,new r(s))},Ku=(t,e,n)=>Ec(t,e,n,bc),Xu=(t,e,n=new Map)=>{pi(t,e.store,n),yn(t,Vu(e.store))},Zu=(t,e=new Uint8Array([0]),n=new Mt)=>{const r=Sc(e);Xu(n,t,r);const s=[n.toUint8Array()];if(t.store.pendingDs&&s.push(t.store.pendingDs),t.store.pendingStructs&&s.push(uh(t.store.pendingStructs.update,e)),s.length>1){if(n.constructor===ir)return ah(s.map((i,a)=>a===0?i:fh(i)));if(n.constructor===Mt)return Fr(s)}return s[0]},kc=(t,e)=>Zu(t,e,new ir),Qu=t=>{const e=new Map,n=O(t.restDecoder);for(let r=0;r<n;r++){const s=O(t.restDecoder),i=O(t.restDecoder);e.set(s,i)}return e},Sc=t=>Qu(new mc(gn(t)));class eh{constructor(){this.l=[]}}const Yi=()=>new eh,Ki=(t,e)=>t.l.push(e),Xi=(t,e)=>{const n=t.l,r=n.length;t.l=n.filter(s=>e!==s),r===t.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},Ac=(t,e,n)=>si(t.l,[e,n]);class en{constructor(e,n){this.client=e,this.clock=n}}const fr=(t,e)=>t===e||t!==null&&e!==null&&t.client===e.client&&t.clock===e.clock,U=(t,e)=>new en(t,e),th=t=>{for(const[e,n]of t.doc.share.entries())if(n===t)return e;throw Oe()},Jt=(t,e)=>e===void 0?!t.deleted:e.sv.has(t.id.client)&&(e.sv.get(t.id.client)||0)>t.id.clock&&!wc(e.ds,t.id),Vs=(t,e)=>{const n=ct(t.meta,Vs,Tt),r=t.doc.store;n.has(e)||(e.sv.forEach((s,i)=>{s<he(r,i)&&wt(t,U(i,s))}),gc(t,e.ds,s=>{}),n.add(e))};class xc{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const gi=t=>{const e=new Map;return t.clients.forEach((n,r)=>{const s=n[n.length-1];e.set(r,s.id.clock+s.length)}),e},he=(t,e)=>{const n=t.clients.get(e);if(n===void 0)return 0;const r=n[n.length-1];return r.id.clock+r.length},_c=(t,e)=>{let n=t.clients.get(e.id.client);if(n===void 0)n=[],t.clients.set(e.id.client,n);else{const r=n[n.length-1];if(r.id.clock+r.length!==e.id.clock)throw Oe()}n.push(e)},Ke=(t,e)=>{let n=0,r=t.length-1,s=t[r],i=s.id.clock;if(i===e)return r;let a=Ye(e/(i+s.length-1)*r);for(;n<=r;){if(s=t[a],i=s.id.clock,i<=e){if(e<i+s.length)return a;n=a+1}else r=a-1;a=Ye((n+r)/2)}throw Oe()},nh=(t,e)=>{const n=t.clients.get(e.client);return n[Ke(n,e.clock)]},vs=nh,js=(t,e,n)=>{const r=Ke(e,n),s=e[r];return s.id.clock<n&&s instanceof se?(e.splice(r+1,0,Hr(t,s,n-s.id.clock)),r+1):r},wt=(t,e)=>{const n=t.doc.store.clients.get(e.client);return n[js(t,n,e.clock)]},Zi=(t,e,n)=>{const r=e.clients.get(n.client),s=Ke(r,n.clock),i=r[s];return n.clock!==i.id.clock+i.length-1&&i.constructor!==Me&&r.splice(s+1,0,Hr(t,i,n.clock-i.id.clock+1)),i},rh=(t,e,n)=>{const r=t.clients.get(e.id.client);r[Ke(r,e.id.clock)]=n},vc=(t,e,n,r,s)=>{if(r===0)return;const i=n+r;let a=js(t,e,n),h;do h=e[a++],i<h.id.clock+h.length&&js(t,e,i),s(h);while(a<e.length&&e[a].id.clock<i)};class sh{constructor(e,n,r){this.doc=e,this.deleteSet=new sr,this.beforeState=gi(e.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=n,this.meta=new Map,this.local=r,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}}const Qi=(t,e)=>e.deleteSet.clients.size===0&&!Ha(e.afterState,(n,r)=>e.beforeState.get(r)!==n)?!1:(fi(e.deleteSet),zu(t,e),yn(t,e.deleteSet),!0),eo=(t,e,n)=>{const r=e._item;(r===null||r.id.clock<(t.beforeState.get(r.id.client)||0)&&!r.deleted)&&ct(t.changed,e,Tt).add(n)},vr=(t,e)=>{let n=t[e],r=t[e-1],s=e;for(;s>0;n=r,r=t[--s-1]){if(r.deleted===n.deleted&&r.constructor===n.constructor&&r.mergeWith(n)){n instanceof se&&n.parentSub!==null&&n.parent._map.get(n.parentSub)===n&&n.parent._map.set(n.parentSub,r);continue}break}const i=e-s;return i&&t.splice(e+1-i,i),i},ih=(t,e,n)=>{for(const[r,s]of t.clients.entries()){const i=e.clients.get(r);for(let a=s.length-1;a>=0;a--){const h=s[a],f=h.clock+h.len;for(let g=Ke(i,h.clock),u=i[g];g<i.length&&u.id.clock<f;u=i[++g]){const w=i[g];if(h.clock+h.len<=w.id.clock)break;w instanceof se&&w.deleted&&!w.keep&&n(w)&&w.gc(e,!1)}}}},oh=(t,e)=>{t.clients.forEach((n,r)=>{const s=e.clients.get(r);for(let i=n.length-1;i>=0;i--){const a=n[i],h=No(s.length-1,1+Ke(s,a.clock+a.len-1));for(let f=h,g=s[f];f>0&&g.id.clock>=a.clock;g=s[f])f-=1+vr(s,f)}})},Ic=(t,e)=>{if(e<t.length){const n=t[e],r=n.doc,s=r.store,i=n.deleteSet,a=n._mergeStructs;try{fi(i),n.afterState=gi(n.doc.store),r.emit("beforeObserverCalls",[n,r]);const h=[];n.changed.forEach((f,g)=>h.push(()=>{(g._item===null||!g._item.deleted)&&g._callObserver(n,f)})),h.push(()=>{n.changedParentTypes.forEach((f,g)=>{g._dEH.l.length>0&&(g._item===null||!g._item.deleted)&&(f=f.filter(u=>u.target._item===null||!u.target._item.deleted),f.forEach(u=>{u.currentTarget=g,u._path=null}),f.sort((u,w)=>u.path.length-w.path.length),Ac(g._dEH,f,n))})}),h.push(()=>r.emit("afterTransaction",[n,r])),si(h,[]),n._needFormattingCleanup&&vh(n)}finally{r.gc&&ih(i,s,r.gcFilter),oh(i,s),n.afterState.forEach((u,w)=>{const p=n.beforeState.get(w)||0;if(p!==u){const m=s.clients.get(w),k=Bt(Ke(m,p),1);for(let A=m.length-1;A>=k;)A-=1+vr(m,A)}});for(let u=a.length-1;u>=0;u--){const{client:w,clock:p}=a[u].id,m=s.clients.get(w),k=Ke(m,p);k+1<m.length&&vr(m,k+1)>1||k>0&&vr(m,k)}if(!n.local&&n.afterState.get(r.clientID)!==n.beforeState.get(r.clientID)&&(Bu(ui,lc,"[yjs] ",uc,hc,"Changed the client-id because another client seems to be using it."),r.clientID=yc()),r.emit("afterTransactionCleanup",[n,r]),r._observers.has("update")){const u=new ir;Qi(u,n)&&r.emit("update",[u.toUint8Array(),n.origin,r,n])}if(r._observers.has("updateV2")){const u=new Mt;Qi(u,n)&&r.emit("updateV2",[u.toUint8Array(),n.origin,r,n])}const{subdocsAdded:h,subdocsLoaded:f,subdocsRemoved:g}=n;(h.size>0||g.size>0||f.size>0)&&(h.forEach(u=>{u.clientID=r.clientID,u.collectionid==null&&(u.collectionid=r.collectionid),r.subdocs.add(u)}),g.forEach(u=>r.subdocs.delete(u)),r.emit("subdocs",[{loaded:f,added:h,removed:g},r,n]),g.forEach(u=>u.destroy())),t.length<=e+1?(r._transactionCleanups=[],r.emit("afterAllTransactions",[r,t])):Ic(t,e+1)}}},j=(t,e,n=null,r=!0)=>{const s=t._transactionCleanups;let i=!1,a=null;t._transaction===null&&(i=!0,t._transaction=new sh(t,n,r),s.push(t._transaction),s.length===1&&t.emit("beforeAllTransactions",[t]),t.emit("beforeTransaction",[t._transaction,t]));try{a=e(t._transaction)}finally{if(i){const h=t._transaction===s[0];t._transaction=null,h&&Ic(s,0)}}return a};function*ch(t){const e=O(t.restDecoder);for(let n=0;n<e;n++){const r=O(t.restDecoder),s=t.readClient();let i=O(t.restDecoder);for(let a=0;a<r;a++){const h=t.readInfo();if(h===10){const f=O(t.restDecoder);yield new De(U(s,i),f),i+=f}else if((zr&h)!==0){const f=(h&(rt|_e))===0,g=new se(U(s,i),null,(h&_e)===_e?t.readLeftID():null,null,(h&rt)===rt?t.readRightID():null,f?t.readParentInfo()?t.readString():t.readLeftID():null,f&&(h&Ln)===Ln?t.readString():null,Gc(t,h));yield g,i+=g.length}else{const f=t.readLen();yield new Me(U(s,i),f),i+=f}}}}class wi{constructor(e,n){this.gen=ch(e),this.curr=null,this.done=!1,this.filterSkips=n,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===De);return this.curr}}class yi{constructor(e){this.currClient=0,this.startClock=0,this.written=0,this.encoder=e,this.clientStructs=[]}}const ah=t=>Fr(t,bc,ir),lh=(t,e)=>{if(t.constructor===Me){const{client:n,clock:r}=t.id;return new Me(U(n,r+e),t.length-e)}else if(t.constructor===De){const{client:n,clock:r}=t.id;return new De(U(n,r+e),t.length-e)}else{const n=t,{client:r,clock:s}=n.id;return new se(U(r,s+e),null,U(r,s+e-1),null,n.rightOrigin,n.parent,n.parentSub,n.content.splice(e))}},Fr=(t,e=an,n=Mt)=>{if(t.length===1)return t[0];const r=t.map(u=>new e(gn(u)));let s=r.map(u=>new wi(u,!0)),i=null;const a=new n,h=new yi(a);for(;s=s.filter(p=>p.curr!==null),s.sort((p,m)=>{if(p.curr.id.client===m.curr.id.client){const k=p.curr.id.clock-m.curr.id.clock;return k===0?p.curr.constructor===m.curr.constructor?0:p.curr.constructor===De?1:-1:k}else return m.curr.id.client-p.curr.id.client}),s.length!==0;){const u=s[0],w=u.curr.id.client;if(i!==null){let p=u.curr,m=!1;for(;p!==null&&p.id.clock+p.length<=i.struct.id.clock+i.struct.length&&p.id.client>=i.struct.id.client;)p=u.next(),m=!0;if(p===null||p.id.client!==w||m&&p.id.clock>i.struct.id.clock+i.struct.length)continue;if(w!==i.struct.id.client)ft(h,i.struct,i.offset),i={struct:p,offset:0},u.next();else if(i.struct.id.clock+i.struct.length<p.id.clock)if(i.struct.constructor===De)i.struct.length=p.id.clock+p.length-i.struct.id.clock;else{ft(h,i.struct,i.offset);const k=p.id.clock-i.struct.id.clock-i.struct.length;i={struct:new De(U(w,i.struct.id.clock+i.struct.length),k),offset:0}}else{const k=i.struct.id.clock+i.struct.length-p.id.clock;k>0&&(i.struct.constructor===De?i.struct.length-=k:p=lh(p,k)),i.struct.mergeWith(p)||(ft(h,i.struct,i.offset),i={struct:p,offset:0},u.next())}}else i={struct:u.curr,offset:0},u.next();for(let p=u.curr;p!==null&&p.id.client===w&&p.id.clock===i.struct.id.clock+i.struct.length&&p.constructor!==De;p=u.next())ft(h,i.struct,i.offset),i={struct:p,offset:0}}i!==null&&(ft(h,i.struct,i.offset),i=null),mi(h);const f=r.map(u=>di(u)),g=$u(f);return yn(a,g),a.toUint8Array()},uh=(t,e,n=an,r=Mt)=>{const s=Sc(e),i=new r,a=new yi(i),h=new n(gn(t)),f=new wi(h,!1);for(;f.curr;){const u=f.curr,w=u.id.client,p=s.get(w)||0;if(f.curr.constructor===De){f.next();continue}if(u.id.clock+u.length>p)for(ft(a,u,Bt(p-u.id.clock,0)),f.next();f.curr&&f.curr.id.client===w;)ft(a,f.curr,0),f.next();else for(;f.curr&&f.curr.id.client===w&&f.curr.id.clock+f.curr.length<=p;)f.next()}mi(a);const g=di(h);return yn(i,g),i.toUint8Array()},Cc=t=>{t.written>0&&(t.clientStructs.push({written:t.written,restEncoder:We(t.encoder.restEncoder)}),t.encoder.restEncoder=Yr(),t.written=0)},ft=(t,e,n)=>{t.written>0&&t.currClient!==e.id.client&&Cc(t),t.written===0&&(t.currClient=e.id.client,t.encoder.writeClient(e.id.client),N(t.encoder.restEncoder,e.id.clock+n)),e.write(t.encoder,n),t.written++},mi=t=>{Cc(t);const e=t.encoder.restEncoder;N(e,t.clientStructs.length);for(let n=0;n<t.clientStructs.length;n++){const r=t.clientStructs[n];N(e,r.written),Kr(e,r.restEncoder)}},hh=(t,e,n,r)=>{const s=new n(gn(t)),i=new wi(s,!1),a=new r,h=new yi(a);for(let g=i.curr;g!==null;g=i.next())ft(h,e(g),0);mi(h);const f=di(s);return yn(a,f),a.toUint8Array()},fh=t=>hh(t,Fl,an,ir),to="You must not compute changes after the event-handler fired.";class ss{constructor(e,n){this.target=e,this.currentTarget=e,this.transaction=n,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=dh(this.currentTarget,this.target))}deletes(e){return wc(this.transaction.deleteSet,e.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw Fe(to);const e=new Map,n=this.target;this.transaction.changed.get(n).forEach(s=>{if(s!==null){const i=n._map.get(s);let a,h;if(this.adds(i)){let f=i.left;for(;f!==null&&this.adds(f);)f=f.left;if(this.deletes(i))if(f!==null&&this.deletes(f))a="delete",h=ms(f.content.getContent());else return;else f!==null&&this.deletes(f)?(a="update",h=ms(f.content.getContent())):(a="add",h=void 0)}else if(this.deletes(i))a="delete",h=ms(i.content.getContent());else return;e.set(s,{action:a,oldValue:h})}}),this._keys=e}return this._keys}get delta(){return this.changes.delta}adds(e){return e.id.clock>=(this.transaction.beforeState.get(e.id.client)||0)}get changes(){let e=this._changes;if(e===null){if(this.transaction.doc._transactionCleanups.length===0)throw Fe(to);const n=this.target,r=Tt(),s=Tt(),i=[];if(e={added:r,deleted:s,delta:i,keys:this.keys},this.transaction.changed.get(n).has(null)){let h=null;const f=()=>{h&&i.push(h)};for(let g=n._start;g!==null;g=g.right)g.deleted?this.deletes(g)&&!this.adds(g)&&((h===null||h.delete===void 0)&&(f(),h={delete:0}),h.delete+=g.length,s.add(g)):this.adds(g)?((h===null||h.insert===void 0)&&(f(),h={insert:[]}),h.insert=h.insert.concat(g.content.getContent()),r.add(g)):((h===null||h.retain===void 0)&&(f(),h={retain:0}),h.retain+=g.length);h!==null&&h.retain===void 0&&f()}this._changes=e}return e}}const dh=(t,e)=>{const n=[];for(;e._item!==null&&e!==t;){if(e._item.parentSub!==null)n.unshift(e._item.parentSub);else{let r=0,s=e._item.parent._start;for(;s!==e._item&&s!==null;)!s.deleted&&s.countable&&(r+=s.length),s=s.right;n.unshift(r)}e=e._item.parent}return n},ye=()=>{Lu("Invalid access: Add Yjs type to a document before reading data.")},Tc=80;let bi=0;class ph{constructor(e,n){e.marker=!0,this.p=e,this.index=n,this.timestamp=bi++}}const gh=t=>{t.timestamp=bi++},Mc=(t,e,n)=>{t.p.marker=!1,t.p=e,e.marker=!0,t.index=n,t.timestamp=bi++},wh=(t,e,n)=>{if(t.length>=Tc){const r=t.reduce((s,i)=>s.timestamp<i.timestamp?s:i);return Mc(r,e,n),r}else{const r=new ph(e,n);return t.push(r),r}},is=(t,e)=>{if(t._start===null||e===0||t._searchMarker===null)return null;const n=t._searchMarker.length===0?null:t._searchMarker.reduce((i,a)=>Sr(e-i.index)<Sr(e-a.index)?i:a);let r=t._start,s=0;for(n!==null&&(r=n.p,s=n.index,gh(n));r.right!==null&&s<e;){if(!r.deleted&&r.countable){if(e<s+r.length)break;s+=r.length}r=r.right}for(;r.left!==null&&s>e;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);for(;r.left!==null&&r.left.id.client===r.id.client&&r.left.id.clock+r.left.length===r.id.clock;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);return n!==null&&Sr(n.index-s)<r.parent.length/Tc?(Mc(n,r,s),n):wh(t._searchMarker,r,s)},qn=(t,e,n)=>{for(let r=t.length-1;r>=0;r--){const s=t[r];if(n>0){let i=s.p;for(i.marker=!1;i&&(i.deleted||!i.countable);)i=i.left,i&&!i.deleted&&i.countable&&(s.index-=i.length);if(i===null||i.marker===!0){t.splice(r,1);continue}s.p=i,i.marker=!0}(e<s.index||n>0&&e===s.index)&&(s.index=Bt(e,s.index+n))}},os=(t,e,n)=>{const r=t,s=e.changedParentTypes;for(;ct(s,t,()=>[]).push(n),t._item!==null;)t=t._item.parent;Ac(r._eH,n,e)};class de{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=Yi(),this._dEH=Yi(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(e,n){this.doc=e,this._item=n}_copy(){throw Le()}clone(){throw Le()}_write(e){}get _first(){let e=this._start;for(;e!==null&&e.deleted;)e=e.right;return e}_callObserver(e,n){!e.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(e){Ki(this._eH,e)}observeDeep(e){Ki(this._dEH,e)}unobserve(e){Xi(this._eH,e)}unobserveDeep(e){Xi(this._dEH,e)}toJSON(){}}const Dc=(t,e,n)=>{t.doc??ye(),e<0&&(e=t._length+e),n<0&&(n=t._length+n);let r=n-e;const s=[];let i=t._start;for(;i!==null&&r>0;){if(i.countable&&!i.deleted){const a=i.content.getContent();if(a.length<=e)e-=a.length;else{for(let h=e;h<a.length&&r>0;h++)s.push(a[h]),r--;e=0}}i=i.right}return s},Oc=t=>{t.doc??ye();const e=[];let n=t._start;for(;n!==null;){if(n.countable&&!n.deleted){const r=n.content.getContent();for(let s=0;s<r.length;s++)e.push(r[s])}n=n.right}return e},Hn=(t,e)=>{let n=0,r=t._start;for(t.doc??ye();r!==null;){if(r.countable&&!r.deleted){const s=r.content.getContent();for(let i=0;i<s.length;i++)e(s[i],n++,t)}r=r.right}},Rc=(t,e)=>{const n=[];return Hn(t,(r,s)=>{n.push(e(r,s,t))}),n},yh=t=>{let e=t._start,n=null,r=0;return{[Symbol.iterator](){return this},next:()=>{if(n===null){for(;e!==null&&e.deleted;)e=e.right;if(e===null)return{done:!0,value:void 0};n=e.content.getContent(),r=0,e=e.right}const s=n[r++];return n.length<=r&&(n=null),{done:!1,value:s}}}},Uc=(t,e)=>{t.doc??ye();const n=is(t,e);let r=t._start;for(n!==null&&(r=n.p,e-=n.index);r!==null;r=r.right)if(!r.deleted&&r.countable){if(e<r.length)return r.content.getContent()[e];e-=r.length}},$r=(t,e,n,r)=>{let s=n;const i=t.doc,a=i.clientID,h=i.store,f=n===null?e._start:n.right;let g=[];const u=()=>{g.length>0&&(s=new se(U(a,he(h,a)),s,s&&s.lastId,f,f&&f.id,e,null,new Ot(g)),s.integrate(t,0),g=[])};r.forEach(w=>{if(w===null)g.push(w);else switch(w.constructor){case Number:case Object:case Boolean:case Array:case String:g.push(w);break;default:switch(u(),w.constructor){case Uint8Array:case ArrayBuffer:s=new se(U(a,he(h,a)),s,s&&s.lastId,f,f&&f.id,e,null,new or(new Uint8Array(w))),s.integrate(t,0);break;case mn:s=new se(U(a,he(h,a)),s,s&&s.lastId,f,f&&f.id,e,null,new cr(w)),s.integrate(t,0);break;default:if(w instanceof de)s=new se(U(a,he(h,a)),s,s&&s.lastId,f,f&&f.id,e,null,new lt(w)),s.integrate(t,0);else throw new Error("Unexpected content type in insert operation")}}}),u()},Bc=()=>Fe("Length exceeded!"),Lc=(t,e,n,r)=>{if(n>e._length)throw Bc();if(n===0)return e._searchMarker&&qn(e._searchMarker,n,r.length),$r(t,e,null,r);const s=n,i=is(e,n);let a=e._start;for(i!==null&&(a=i.p,n-=i.index,n===0&&(a=a.prev,n+=a&&a.countable&&!a.deleted?a.length:0));a!==null;a=a.right)if(!a.deleted&&a.countable){if(n<=a.length){n<a.length&&wt(t,U(a.id.client,a.id.clock+n));break}n-=a.length}return e._searchMarker&&qn(e._searchMarker,s,r.length),$r(t,e,a,r)},mh=(t,e,n)=>{let s=(e._searchMarker||[]).reduce((i,a)=>a.index>i.index?a:i,{index:0,p:e._start}).p;if(s)for(;s.right;)s=s.right;return $r(t,e,s,n)},Nc=(t,e,n,r)=>{if(r===0)return;const s=n,i=r,a=is(e,n);let h=e._start;for(a!==null&&(h=a.p,n-=a.index);h!==null&&n>0;h=h.right)!h.deleted&&h.countable&&(n<h.length&&wt(t,U(h.id.client,h.id.clock+n)),n-=h.length);for(;r>0&&h!==null;)h.deleted||(r<h.length&&wt(t,U(h.id.client,h.id.clock+r)),h.delete(t),r-=h.length),h=h.right;if(r>0)throw Bc();e._searchMarker&&qn(e._searchMarker,s,-i+r)},Pr=(t,e,n)=>{const r=e._map.get(n);r!==void 0&&r.delete(t)},Ei=(t,e,n,r)=>{const s=e._map.get(n)||null,i=t.doc,a=i.clientID;let h;if(r==null)h=new Ot([r]);else switch(r.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:h=new Ot([r]);break;case Uint8Array:h=new or(r);break;case mn:h=new cr(r);break;default:if(r instanceof de)h=new lt(r);else throw new Error("Unexpected content type")}new se(U(a,he(i.store,a)),s,s&&s.lastId,null,null,e,n,h).integrate(t,0)},ki=(t,e)=>{t.doc??ye();const n=t._map.get(e);return n!==void 0&&!n.deleted?n.content.getContent()[n.length-1]:void 0},Fc=t=>{const e={};return t.doc??ye(),t._map.forEach((n,r)=>{n.deleted||(e[r]=n.content.getContent()[n.length-1])}),e},$c=(t,e)=>{t.doc??ye();const n=t._map.get(e);return n!==void 0&&!n.deleted},bh=(t,e)=>{const n={};return t._map.forEach((r,s)=>{let i=r;for(;i!==null&&(!e.sv.has(i.id.client)||i.id.clock>=(e.sv.get(i.id.client)||0));)i=i.left;i!==null&&Jt(i,e)&&(n[s]=i.content.getContent()[i.length-1])}),n},dr=t=>(t.doc??ye(),Nu(t._map.entries(),e=>!e[1].deleted));class Eh extends ss{}class tn extends de{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(e){const n=new tn;return n.push(e),n}_integrate(e,n){super._integrate(e,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new tn}clone(){const e=new tn;return e.insert(0,this.toArray().map(n=>n instanceof de?n.clone():n)),e}get length(){return this.doc??ye(),this._length}_callObserver(e,n){super._callObserver(e,n),os(this,e,new Eh(this,e))}insert(e,n){this.doc!==null?j(this.doc,r=>{Lc(r,this,e,n)}):this._prelimContent.splice(e,0,...n)}push(e){this.doc!==null?j(this.doc,n=>{mh(n,this,e)}):this._prelimContent.push(...e)}unshift(e){this.insert(0,e)}delete(e,n=1){this.doc!==null?j(this.doc,r=>{Nc(r,this,e,n)}):this._prelimContent.splice(e,n)}get(e){return Uc(this,e)}toArray(){return Oc(this)}slice(e=0,n=this.length){return Dc(this,e,n)}toJSON(){return this.map(e=>e instanceof de?e.toJSON():e)}map(e){return Rc(this,e)}forEach(e){Hn(this,e)}[Symbol.iterator](){return yh(this)}_write(e){e.writeTypeRef(Gh)}}const kh=t=>new tn;class Sh extends ss{constructor(e,n,r){super(e,n),this.keysChanged=r}}class ln extends de{constructor(e){super(),this._prelimContent=null,e===void 0?this._prelimContent=new Map:this._prelimContent=new Map(e)}_integrate(e,n){super._integrate(e,n),this._prelimContent.forEach((r,s)=>{this.set(s,r)}),this._prelimContent=null}_copy(){return new ln}clone(){const e=new ln;return this.forEach((n,r)=>{e.set(r,n instanceof de?n.clone():n)}),e}_callObserver(e,n){os(this,e,new Sh(this,e,n))}toJSON(){this.doc??ye();const e={};return this._map.forEach((n,r)=>{if(!n.deleted){const s=n.content.getContent()[n.length-1];e[r]=s instanceof de?s.toJSON():s}}),e}get size(){return[...dr(this)].length}keys(){return _s(dr(this),e=>e[0])}values(){return _s(dr(this),e=>e[1].content.getContent()[e[1].length-1])}entries(){return _s(dr(this),e=>[e[0],e[1].content.getContent()[e[1].length-1]])}forEach(e){this.doc??ye(),this._map.forEach((n,r)=>{n.deleted||e(n.content.getContent()[n.length-1],r,this)})}[Symbol.iterator](){return this.entries()}delete(e){this.doc!==null?j(this.doc,n=>{Pr(n,this,e)}):this._prelimContent.delete(e)}set(e,n){return this.doc!==null?j(this.doc,r=>{Ei(r,this,e,n)}):this._prelimContent.set(e,n),n}get(e){return ki(this,e)}has(e){return $c(this,e)}clear(){this.doc!==null?j(this.doc,e=>{this.forEach(function(n,r,s){Pr(e,s,r)})}):this._prelimContent.clear()}_write(e){e.writeTypeRef(Jh)}}const Ah=t=>new ln,pt=(t,e)=>t===e||typeof t=="object"&&typeof e=="object"&&t&&e&&Ll(t,e);class qs{constructor(e,n,r,s){this.left=e,this.right=n,this.index=r,this.currentAttributes=s}forward(){switch(this.right===null&&Oe(),this.right.content.constructor){case ie:this.right.deleted||bn(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}}const no=(t,e,n)=>{for(;e.right!==null&&n>0;){switch(e.right.content.constructor){case ie:e.right.deleted||bn(e.currentAttributes,e.right.content);break;default:e.right.deleted||(n<e.right.length&&wt(t,U(e.right.id.client,e.right.id.clock+n)),e.index+=e.right.length,n-=e.right.length);break}e.left=e.right,e.right=e.right.right}return e},pr=(t,e,n,r)=>{const s=new Map,i=r?is(e,n):null;if(i){const a=new qs(i.p.left,i.p,i.index,s);return no(t,a,n-i.index)}else{const a=new qs(null,e._start,0,s);return no(t,a,n)}},Pc=(t,e,n,r)=>{for(;n.right!==null&&(n.right.deleted===!0||n.right.content.constructor===ie&&pt(r.get(n.right.content.key),n.right.content.value));)n.right.deleted||r.delete(n.right.content.key),n.forward();const s=t.doc,i=s.clientID;r.forEach((a,h)=>{const f=n.left,g=n.right,u=new se(U(i,he(s.store,i)),f,f&&f.lastId,g,g&&g.id,e,null,new ie(h,a));u.integrate(t,0),n.right=u,n.forward()})},bn=(t,e)=>{const{key:n,value:r}=e;r===null?t.delete(n):t.set(n,r)},Vc=(t,e)=>{for(;t.right!==null;){if(!(t.right.deleted||t.right.content.constructor===ie&&pt(e[t.right.content.key]??null,t.right.content.value)))break;t.forward()}},jc=(t,e,n,r)=>{const s=t.doc,i=s.clientID,a=new Map;for(const h in r){const f=r[h],g=n.currentAttributes.get(h)??null;if(!pt(g,f)){a.set(h,g);const{left:u,right:w}=n;n.right=new se(U(i,he(s.store,i)),u,u&&u.lastId,w,w&&w.id,e,null,new ie(h,f)),n.right.integrate(t,0),n.forward()}}return a},Is=(t,e,n,r,s)=>{n.currentAttributes.forEach((p,m)=>{s[m]===void 0&&(s[m]=null)});const i=t.doc,a=i.clientID;Vc(n,s);const h=jc(t,e,n,s),f=r.constructor===String?new Xe(r):r instanceof de?new lt(r):new Lt(r);let{left:g,right:u,index:w}=n;e._searchMarker&&qn(e._searchMarker,n.index,f.getLength()),u=new se(U(a,he(i.store,a)),g,g&&g.lastId,u,u&&u.id,e,null,f),u.integrate(t,0),n.right=u,n.index=w,n.forward(),Pc(t,e,n,h)},ro=(t,e,n,r,s)=>{const i=t.doc,a=i.clientID;Vc(n,s);const h=jc(t,e,n,s);e:for(;n.right!==null&&(r>0||h.size>0&&(n.right.deleted||n.right.content.constructor===ie));){if(!n.right.deleted)switch(n.right.content.constructor){case ie:{const{key:f,value:g}=n.right.content,u=s[f];if(u!==void 0){if(pt(u,g))h.delete(f);else{if(r===0)break e;h.set(f,g)}n.right.delete(t)}else n.currentAttributes.set(f,g);break}default:r<n.right.length&&wt(t,U(n.right.id.client,n.right.id.clock+r)),r-=n.right.length;break}n.forward()}if(r>0){let f="";for(;r>0;r--)f+=`
`;n.right=new se(U(a,he(i.store,a)),n.left,n.left&&n.left.lastId,n.right,n.right&&n.right.id,e,null,new Xe(f)),n.right.integrate(t,0),n.forward()}Pc(t,e,n,h)},qc=(t,e,n,r,s)=>{let i=e;const a=Ee();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===ie){const g=i.content;a.set(g.key,g)}i=i.right}let h=0,f=!1;for(;e!==i;){if(n===e&&(f=!0),!e.deleted){const g=e.content;switch(g.constructor){case ie:{const{key:u,value:w}=g,p=r.get(u)??null;(a.get(u)!==g||p===w)&&(e.delete(t),h++,!f&&(s.get(u)??null)===w&&p!==w&&(p===null?s.delete(u):s.set(u,p))),!f&&!e.deleted&&bn(s,g);break}}}e=e.right}return h},xh=(t,e)=>{for(;e&&e.right&&(e.right.deleted||!e.right.countable);)e=e.right;const n=new Set;for(;e&&(e.deleted||!e.countable);){if(!e.deleted&&e.content.constructor===ie){const r=e.content.key;n.has(r)?e.delete(t):n.add(r)}e=e.left}},_h=t=>{let e=0;return j(t.doc,n=>{let r=t._start,s=t._start,i=Ee();const a=Bs(i);for(;s;){if(s.deleted===!1)switch(s.content.constructor){case ie:bn(a,s.content);break;default:e+=qc(n,r,s,i,a),i=Bs(a),r=s;break}s=s.right}}),e},vh=t=>{const e=new Set,n=t.doc;for(const[r,s]of t.afterState.entries()){const i=t.beforeState.get(r)||0;s!==i&&vc(t,n.store.clients.get(r),i,s,a=>{!a.deleted&&a.content.constructor===ie&&a.constructor!==Me&&e.add(a.parent)})}j(n,r=>{gc(t,t.deleteSet,s=>{if(s instanceof Me||!s.parent._hasFormatting||e.has(s.parent))return;const i=s.parent;s.content.constructor===ie?e.add(i):xh(r,s)});for(const s of e)_h(s)})},so=(t,e,n)=>{const r=n,s=Bs(e.currentAttributes),i=e.right;for(;n>0&&e.right!==null;){if(e.right.deleted===!1)switch(e.right.content.constructor){case lt:case Lt:case Xe:n<e.right.length&&wt(t,U(e.right.id.client,e.right.id.clock+n)),n-=e.right.length,e.right.delete(t);break}e.forward()}i&&qc(t,i,e.right,s,e.currentAttributes);const a=(e.left||e.right).parent;return a._searchMarker&&qn(a._searchMarker,e.index,-r+n),e};class Ih extends ss{constructor(e,n,r){super(e,n),this.childListChanged=!1,this.keysChanged=new Set,r.forEach(s=>{s===null?this.childListChanged=!0:this.keysChanged.add(s)})}get changes(){if(this._changes===null){const e={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=e}return this._changes}get delta(){if(this._delta===null){const e=this.target.doc,n=[];j(e,r=>{const s=new Map,i=new Map;let a=this.target._start,h=null;const f={};let g="",u=0,w=0;const p=()=>{if(h!==null){let m=null;switch(h){case"delete":w>0&&(m={delete:w}),w=0;break;case"insert":(typeof g=="object"||g.length>0)&&(m={insert:g},s.size>0&&(m.attributes={},s.forEach((k,A)=>{k!==null&&(m.attributes[A]=k)}))),g="";break;case"retain":u>0&&(m={retain:u},Bl(f)||(m.attributes=Ol({},f))),u=0;break}m&&n.push(m),h=null}};for(;a!==null;){switch(a.content.constructor){case lt:case Lt:this.adds(a)?this.deletes(a)||(p(),h="insert",g=a.content.getContent()[0],p()):this.deletes(a)?(h!=="delete"&&(p(),h="delete"),w+=1):a.deleted||(h!=="retain"&&(p(),h="retain"),u+=1);break;case Xe:this.adds(a)?this.deletes(a)||(h!=="insert"&&(p(),h="insert"),g+=a.content.str):this.deletes(a)?(h!=="delete"&&(p(),h="delete"),w+=a.length):a.deleted||(h!=="retain"&&(p(),h="retain"),u+=a.length);break;case ie:{const{key:m,value:k}=a.content;if(this.adds(a)){if(!this.deletes(a)){const A=s.get(m)??null;pt(A,k)?k!==null&&a.delete(r):(h==="retain"&&p(),pt(k,i.get(m)??null)?delete f[m]:f[m]=k)}}else if(this.deletes(a)){i.set(m,k);const A=s.get(m)??null;pt(A,k)||(h==="retain"&&p(),f[m]=A)}else if(!a.deleted){i.set(m,k);const A=f[m];A!==void 0&&(pt(A,k)?A!==null&&a.delete(r):(h==="retain"&&p(),k===null?delete f[m]:f[m]=k))}a.deleted||(h==="insert"&&p(),bn(s,a.content));break}}a=a.right}for(p();n.length>0;){const m=n[n.length-1];if(m.retain!==void 0&&m.attributes===void 0)n.pop();else break}}),this._delta=n}return this._delta}}class un extends de{constructor(e){super(),this._pending=e!==void 0?[()=>this.insert(0,e)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??ye(),this._length}_integrate(e,n){super._integrate(e,n);try{this._pending.forEach(r=>r())}catch(r){console.error(r)}this._pending=null}_copy(){return new un}clone(){const e=new un;return e.applyDelta(this.toDelta()),e}_callObserver(e,n){super._callObserver(e,n);const r=new Ih(this,e,n);os(this,e,r),!e.local&&this._hasFormatting&&(e._needFormattingCleanup=!0)}toString(){this.doc??ye();let e="",n=this._start;for(;n!==null;)!n.deleted&&n.countable&&n.content.constructor===Xe&&(e+=n.content.str),n=n.right;return e}toJSON(){return this.toString()}applyDelta(e,{sanitize:n=!0}={}){this.doc!==null?j(this.doc,r=>{const s=new qs(null,this._start,0,new Map);for(let i=0;i<e.length;i++){const a=e[i];if(a.insert!==void 0){const h=!n&&typeof a.insert=="string"&&i===e.length-1&&s.right===null&&a.insert.slice(-1)===`
`?a.insert.slice(0,-1):a.insert;(typeof h!="string"||h.length>0)&&Is(r,this,s,h,a.attributes||{})}else a.retain!==void 0?ro(r,this,s,a.retain,a.attributes||{}):a.delete!==void 0&&so(r,s,a.delete)}}):this._pending.push(()=>this.applyDelta(e))}toDelta(e,n,r){this.doc??ye();const s=[],i=new Map,a=this.doc;let h="",f=this._start;function g(){if(h.length>0){const w={};let p=!1;i.forEach((k,A)=>{p=!0,w[A]=k});const m={insert:h};p&&(m.attributes=w),s.push(m),h=""}}const u=()=>{for(;f!==null;){if(Jt(f,e)||n!==void 0&&Jt(f,n))switch(f.content.constructor){case Xe:{const w=i.get("ychange");e!==void 0&&!Jt(f,e)?(w===void 0||w.user!==f.id.client||w.type!=="removed")&&(g(),i.set("ychange",r?r("removed",f.id):{type:"removed"})):n!==void 0&&!Jt(f,n)?(w===void 0||w.user!==f.id.client||w.type!=="added")&&(g(),i.set("ychange",r?r("added",f.id):{type:"added"})):w!==void 0&&(g(),i.delete("ychange")),h+=f.content.str;break}case lt:case Lt:{g();const w={insert:f.content.getContent()[0]};if(i.size>0){const p={};w.attributes=p,i.forEach((m,k)=>{p[k]=m})}s.push(w);break}case ie:Jt(f,e)&&(g(),bn(i,f.content));break}f=f.right}g()};return e||n?j(a,w=>{e&&Vs(w,e),n&&Vs(w,n),u()},"cleanup"):u(),s}insert(e,n,r){if(n.length<=0)return;const s=this.doc;s!==null?j(s,i=>{const a=pr(i,this,e,!r);r||(r={},a.currentAttributes.forEach((h,f)=>{r[f]=h})),Is(i,this,a,n,r)}):this._pending.push(()=>this.insert(e,n,r))}insertEmbed(e,n,r){const s=this.doc;s!==null?j(s,i=>{const a=pr(i,this,e,!r);Is(i,this,a,n,r||{})}):this._pending.push(()=>this.insertEmbed(e,n,r||{}))}delete(e,n){if(n===0)return;const r=this.doc;r!==null?j(r,s=>{so(s,pr(s,this,e,!0),n)}):this._pending.push(()=>this.delete(e,n))}format(e,n,r){if(n===0)return;const s=this.doc;s!==null?j(s,i=>{const a=pr(i,this,e,!1);a.right!==null&&ro(i,this,a,n,r)}):this._pending.push(()=>this.format(e,n,r))}removeAttribute(e){this.doc!==null?j(this.doc,n=>{Pr(n,this,e)}):this._pending.push(()=>this.removeAttribute(e))}setAttribute(e,n){this.doc!==null?j(this.doc,r=>{Ei(r,this,e,n)}):this._pending.push(()=>this.setAttribute(e,n))}getAttribute(e){return ki(this,e)}getAttributes(){return Fc(this)}_write(e){e.writeTypeRef(Wh)}}const Ch=t=>new un;class Cs{constructor(e,n=()=>!0){this._filter=n,this._root=e,this._currentNode=e._start,this._firstCall=!0,e.doc??ye()}[Symbol.iterator](){return this}next(){let e=this._currentNode,n=e&&e.content&&e.content.type;if(e!==null&&(!this._firstCall||e.deleted||!this._filter(n)))do if(n=e.content.type,!e.deleted&&(n.constructor===hn||n.constructor===Dt)&&n._start!==null)e=n._start;else for(;e!==null;){const r=e.next;if(r!==null){e=r;break}else e.parent===this._root?e=null:e=e.parent._item}while(e!==null&&(e.deleted||!this._filter(e.content.type)));return this._firstCall=!1,e===null?{value:void 0,done:!0}:(this._currentNode=e,{value:e.content.type,done:!1})}}class Dt extends de{constructor(){super(),this._prelimContent=[]}get firstChild(){const e=this._first;return e?e.content.getContent()[0]:null}_integrate(e,n){super._integrate(e,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Dt}clone(){const e=new Dt;return e.insert(0,this.toArray().map(n=>n instanceof de?n.clone():n)),e}get length(){return this.doc??ye(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(e){return new Cs(this,e)}querySelector(e){e=e.toUpperCase();const r=new Cs(this,s=>s.nodeName&&s.nodeName.toUpperCase()===e).next();return r.done?null:r.value}querySelectorAll(e){return e=e.toUpperCase(),gt(new Cs(this,n=>n.nodeName&&n.nodeName.toUpperCase()===e))}_callObserver(e,n){os(this,e,new Dh(this,n,e))}toString(){return Rc(this,e=>e.toString()).join("")}toJSON(){return this.toString()}toDOM(e=document,n={},r){const s=e.createDocumentFragment();return r!==void 0&&r._createAssociation(s,this),Hn(this,i=>{s.insertBefore(i.toDOM(e,n,r),null)}),s}insert(e,n){this.doc!==null?j(this.doc,r=>{Lc(r,this,e,n)}):this._prelimContent.splice(e,0,...n)}insertAfter(e,n){if(this.doc!==null)j(this.doc,r=>{const s=e&&e instanceof de?e._item:e;$r(r,this,s,n)});else{const r=this._prelimContent,s=e===null?0:r.findIndex(i=>i===e)+1;if(s===0&&e!==null)throw Fe("Reference item not found");r.splice(s,0,...n)}}delete(e,n=1){this.doc!==null?j(this.doc,r=>{Nc(r,this,e,n)}):this._prelimContent.splice(e,n)}toArray(){return Oc(this)}push(e){this.insert(this.length,e)}unshift(e){this.insert(0,e)}get(e){return Uc(this,e)}slice(e=0,n=this.length){return Dc(this,e,n)}forEach(e){Hn(this,e)}_write(e){e.writeTypeRef(Yh)}}const Th=t=>new Dt;class hn extends Dt{constructor(e="UNDEFINED"){super(),this.nodeName=e,this._prelimAttrs=new Map}get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_integrate(e,n){super._integrate(e,n),this._prelimAttrs.forEach((r,s)=>{this.setAttribute(s,r)}),this._prelimAttrs=null}_copy(){return new hn(this.nodeName)}clone(){const e=new hn(this.nodeName),n=this.getAttributes();return Ul(n,(r,s)=>{e.setAttribute(s,r)}),e.insert(0,this.toArray().map(r=>r instanceof de?r.clone():r)),e}toString(){const e=this.getAttributes(),n=[],r=[];for(const h in e)r.push(h);r.sort();const s=r.length;for(let h=0;h<s;h++){const f=r[h];n.push(f+'="'+e[f]+'"')}const i=this.nodeName.toLocaleLowerCase(),a=n.length>0?" "+n.join(" "):"";return`<${i}${a}>${super.toString()}</${i}>`}removeAttribute(e){this.doc!==null?j(this.doc,n=>{Pr(n,this,e)}):this._prelimAttrs.delete(e)}setAttribute(e,n){this.doc!==null?j(this.doc,r=>{Ei(r,this,e,n)}):this._prelimAttrs.set(e,n)}getAttribute(e){return ki(this,e)}hasAttribute(e){return $c(this,e)}getAttributes(e){return e?bh(this,e):Fc(this)}toDOM(e=document,n={},r){const s=e.createElement(this.nodeName),i=this.getAttributes();for(const a in i){const h=i[a];typeof h=="string"&&s.setAttribute(a,h)}return Hn(this,a=>{s.appendChild(a.toDOM(e,n,r))}),r!==void 0&&r._createAssociation(s,this),s}_write(e){e.writeTypeRef(zh),e.writeKey(this.nodeName)}}const Mh=t=>new hn(t.readKey());class Dh extends ss{constructor(e,n,r){super(e,r),this.childListChanged=!1,this.attributesChanged=new Set,n.forEach(s=>{s===null?this.childListChanged=!0:this.attributesChanged.add(s)})}}class Vr extends ln{constructor(e){super(),this.hookName=e}_copy(){return new Vr(this.hookName)}clone(){const e=new Vr(this.hookName);return this.forEach((n,r)=>{e.set(r,n)}),e}toDOM(e=document,n={},r){const s=n[this.hookName];let i;return s!==void 0?i=s.createDom(this):i=document.createElement(this.hookName),i.setAttribute("data-yjs-hook",this.hookName),r!==void 0&&r._createAssociation(i,this),i}_write(e){e.writeTypeRef(Kh),e.writeKey(this.hookName)}}const Oh=t=>new Vr(t.readKey());class jr extends un{get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_copy(){return new jr}clone(){const e=new jr;return e.applyDelta(this.toDelta()),e}toDOM(e=document,n,r){const s=e.createTextNode(this.toString());return r!==void 0&&r._createAssociation(s,this),s}toString(){return this.toDelta().map(e=>{const n=[];for(const s in e.attributes){const i=[];for(const a in e.attributes[s])i.push({key:a,value:e.attributes[s][a]});i.sort((a,h)=>a.key<h.key?-1:1),n.push({nodeName:s,attrs:i})}n.sort((s,i)=>s.nodeName<i.nodeName?-1:1);let r="";for(let s=0;s<n.length;s++){const i=n[s];r+=`<${i.nodeName}`;for(let a=0;a<i.attrs.length;a++){const h=i.attrs[a];r+=` ${h.key}="${h.value}"`}r+=">"}r+=e.insert;for(let s=n.length-1;s>=0;s--)r+=`</${n[s].nodeName}>`;return r}).join("")}toJSON(){return this.toString()}_write(e){e.writeTypeRef(Xh)}}const Rh=t=>new jr;class Si{constructor(e,n){this.id=e,this.length=n}get deleted(){throw Le()}mergeWith(e){return!1}write(e,n,r){throw Le()}integrate(e,n){throw Le()}}const Uh=0;class Me extends Si{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,n){n>0&&(this.id.clock+=n,this.length-=n),_c(e.doc.store,this)}write(e,n){e.writeInfo(Uh),e.writeLen(this.length-n)}getMissing(e,n){return null}}class or{constructor(e){this.content=e}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new or(this.content)}splice(e){throw Le()}mergeWith(e){return!1}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeBuf(this.content)}getRef(){return 3}}const Bh=t=>new or(t.readBuf());class Gn{constructor(e){this.len=e}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new Gn(this.len)}splice(e){const n=new Gn(this.len-e);return this.len=e,n}mergeWith(e){return this.len+=e.len,!0}integrate(e,n){Nr(e.deleteSet,n.id.client,n.id.clock,this.len),n.markDeleted()}delete(e){}gc(e){}write(e,n){e.writeLen(this.len-n)}getRef(){return 1}}const Lh=t=>new Gn(t.readLen()),Hc=(t,e)=>new mn({guid:t,...e,shouldLoad:e.shouldLoad||e.autoLoad||!1});class cr{constructor(e){e._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=e;const n={};this.opts=n,e.gc||(n.gc=!1),e.autoLoad&&(n.autoLoad=!0),e.meta!==null&&(n.meta=e.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new cr(Hc(this.doc.guid,this.opts))}splice(e){throw Le()}mergeWith(e){return!1}integrate(e,n){this.doc._item=n,e.subdocsAdded.add(this.doc),this.doc.shouldLoad&&e.subdocsLoaded.add(this.doc)}delete(e){e.subdocsAdded.has(this.doc)?e.subdocsAdded.delete(this.doc):e.subdocsRemoved.add(this.doc)}gc(e){}write(e,n){e.writeString(this.doc.guid),e.writeAny(this.opts)}getRef(){return 9}}const Nh=t=>new cr(Hc(t.readString(),t.readAny()));class Lt{constructor(e){this.embed=e}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new Lt(this.embed)}splice(e){throw Le()}mergeWith(e){return!1}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeJSON(this.embed)}getRef(){return 5}}const Fh=t=>new Lt(t.readJSON());class ie{constructor(e,n){this.key=e,this.value=n}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new ie(this.key,this.value)}splice(e){throw Le()}mergeWith(e){return!1}integrate(e,n){const r=n.parent;r._searchMarker=null,r._hasFormatting=!0}delete(e){}gc(e){}write(e,n){e.writeKey(this.key),e.writeJSON(this.value)}getRef(){return 6}}const $h=t=>new ie(t.readKey(),t.readJSON());class qr{constructor(e){this.arr=e}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new qr(this.arr)}splice(e){const n=new qr(this.arr.slice(e));return this.arr=this.arr.slice(0,e),n}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){const r=this.arr.length;e.writeLen(r-n);for(let s=n;s<r;s++){const i=this.arr[s];e.writeString(i===void 0?"undefined":JSON.stringify(i))}}getRef(){return 2}}const Ph=t=>{const e=t.readLen(),n=[];for(let r=0;r<e;r++){const s=t.readString();s==="undefined"?n.push(void 0):n.push(JSON.parse(s))}return new qr(n)},Vh=Ur("node_env")==="development";class Ot{constructor(e){this.arr=e,Vh&&Ho(e)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Ot(this.arr)}splice(e){const n=new Ot(this.arr.slice(e));return this.arr=this.arr.slice(0,e),n}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){const r=this.arr.length;e.writeLen(r-n);for(let s=n;s<r;s++){const i=this.arr[s];e.writeAny(i)}}getRef(){return 8}}const jh=t=>{const e=t.readLen(),n=[];for(let r=0;r<e;r++)n.push(t.readAny());return new Ot(n)};class Xe{constructor(e){this.str=e}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new Xe(this.str)}splice(e){const n=new Xe(this.str.slice(e));this.str=this.str.slice(0,e);const r=this.str.charCodeAt(e-1);return r>=55296&&r<=56319&&(this.str=this.str.slice(0,e-1)+"",n.str=""+n.str.slice(1)),n}mergeWith(e){return this.str+=e.str,!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeString(n===0?this.str:this.str.slice(n))}getRef(){return 4}}const qh=t=>new Xe(t.readString()),Hh=[kh,Ah,Ch,Mh,Th,Oh,Rh],Gh=0,Jh=1,Wh=2,zh=3,Yh=4,Kh=5,Xh=6;class lt{constructor(e){this.type=e}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new lt(this.type._copy())}splice(e){throw Le()}mergeWith(e){return!1}integrate(e,n){this.type._integrate(e.doc,n)}delete(e){let n=this.type._start;for(;n!==null;)n.deleted?n.id.clock<(e.beforeState.get(n.id.client)||0)&&e._mergeStructs.push(n):n.delete(e),n=n.right;this.type._map.forEach(r=>{r.deleted?r.id.clock<(e.beforeState.get(r.id.client)||0)&&e._mergeStructs.push(r):r.delete(e)}),e.changed.delete(this.type)}gc(e){let n=this.type._start;for(;n!==null;)n.gc(e,!0),n=n.right;this.type._start=null,this.type._map.forEach(r=>{for(;r!==null;)r.gc(e,!0),r=r.left}),this.type._map=new Map}write(e,n){this.type._write(e)}getRef(){return 7}}const Zh=t=>new lt(Hh[t.readTypeRef()](t)),Hr=(t,e,n)=>{const{client:r,clock:s}=e.id,i=new se(U(r,s+n),e,U(r,s+n-1),e.right,e.rightOrigin,e.parent,e.parentSub,e.content.splice(n));return e.deleted&&i.markDeleted(),e.keep&&(i.keep=!0),e.redone!==null&&(i.redone=U(e.redone.client,e.redone.clock+n)),e.right=i,i.right!==null&&(i.right.left=i),t._mergeStructs.push(i),i.parentSub!==null&&i.right===null&&i.parent._map.set(i.parentSub,i),e.length=n,i};class se extends Si{constructor(e,n,r,s,i,a,h,f){super(e,f.getLength()),this.origin=r,this.left=n,this.right=s,this.rightOrigin=i,this.parent=a,this.parentSub=h,this.redone=null,this.content=f,this.info=this.content.isCountable()?Ni:0}set marker(e){(this.info&Es)>0!==e&&(this.info^=Es)}get marker(){return(this.info&Es)>0}get keep(){return(this.info&Li)>0}set keep(e){this.keep!==e&&(this.info^=Li)}get countable(){return(this.info&Ni)>0}get deleted(){return(this.info&bs)>0}set deleted(e){this.deleted!==e&&(this.info^=bs)}markDeleted(){this.info|=bs}getMissing(e,n){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=he(n,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=he(n,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===en&&this.id.client!==this.parent.client&&this.parent.clock>=he(n,this.parent.client))return this.parent.client;if(this.origin&&(this.left=Zi(e,n,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=wt(e,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===Me||this.right&&this.right.constructor===Me)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===se?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===se&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===en){const r=vs(n,this.parent);r.constructor===Me?this.parent=null:this.parent=r.content.type}return null}integrate(e,n){if(n>0&&(this.id.clock+=n,this.left=Zi(e,e.doc.store,U(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(n),this.length-=n),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let r=this.left,s;if(r!==null)s=r.right;else if(this.parentSub!==null)for(s=this.parent._map.get(this.parentSub)||null;s!==null&&s.left!==null;)s=s.left;else s=this.parent._start;const i=new Set,a=new Set;for(;s!==null&&s!==this.right;){if(a.add(s),i.add(s),fr(this.origin,s.origin)){if(s.id.client<this.id.client)r=s,i.clear();else if(fr(this.rightOrigin,s.rightOrigin))break}else if(s.origin!==null&&a.has(vs(e.doc.store,s.origin)))i.has(vs(e.doc.store,s.origin))||(r=s,i.clear());else break;s=s.right}this.left=r}if(this.left!==null){const r=this.left.right;this.right=r,this.left.right=this}else{let r;if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start,this.parent._start=this;this.right=r}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(e)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),_c(e.doc.store,this),this.content.integrate(e,this),eo(e,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(e)}else new Me(this.id,this.length).integrate(e,0)}get next(){let e=this.right;for(;e!==null&&e.deleted;)e=e.right;return e}get prev(){let e=this.left;for(;e!==null&&e.deleted;)e=e.left;return e}get lastId(){return this.length===1?this.id:U(this.id.client,this.id.clock+this.length-1)}mergeWith(e){if(this.constructor===e.constructor&&fr(e.origin,this.lastId)&&this.right===e&&fr(this.rightOrigin,e.rightOrigin)&&this.id.client===e.id.client&&this.id.clock+this.length===e.id.clock&&this.deleted===e.deleted&&this.redone===null&&e.redone===null&&this.content.constructor===e.content.constructor&&this.content.mergeWith(e.content)){const n=this.parent._searchMarker;return n&&n.forEach(r=>{r.p===e&&(r.p=this,!this.deleted&&this.countable&&(r.index-=this.length))}),e.keep&&(this.keep=!0),this.right=e.right,this.right!==null&&(this.right.left=this),this.length+=e.length,!0}return!1}delete(e){if(!this.deleted){const n=this.parent;this.countable&&this.parentSub===null&&(n._length-=this.length),this.markDeleted(),Nr(e.deleteSet,this.id.client,this.id.clock,this.length),eo(e,n,this.parentSub),this.content.delete(e)}}gc(e,n){if(!this.deleted)throw Oe();this.content.gc(e),n?rh(e,this,new Me(this.id,this.length)):this.content=new Gn(this.length)}write(e,n){const r=n>0?U(this.id.client,this.id.clock+n-1):this.origin,s=this.rightOrigin,i=this.parentSub,a=this.content.getRef()&zr|(r===null?0:_e)|(s===null?0:rt)|(i===null?0:Ln);if(e.writeInfo(a),r!==null&&e.writeLeftID(r),s!==null&&e.writeRightID(s),r===null&&s===null){const h=this.parent;if(h._item!==void 0){const f=h._item;if(f===null){const g=th(h);e.writeParentInfo(!0),e.writeString(g)}else e.writeParentInfo(!1),e.writeLeftID(f.id)}else h.constructor===String?(e.writeParentInfo(!0),e.writeString(h)):h.constructor===en?(e.writeParentInfo(!1),e.writeLeftID(h)):Oe();i!==null&&e.writeString(i)}this.content.write(e,n)}}const Gc=(t,e)=>Qh[e&zr](t),Qh=[()=>{Oe()},Lh,Ph,Bh,qh,Fh,$h,Zh,jh,Nh,()=>{Oe()}],ef=10;class De extends Si{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,n){Oe()}write(e,n){e.writeInfo(ef),N(e.restEncoder,this.length-n)}getMissing(e,n){return null}}const Jc=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof Bi<"u"?Bi:{},Wc="__ $YJS$ __";Jc[Wc]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");Jc[Wc]=!0;const Nt=t=>on((e,n)=>{t.onerror=r=>n(new Error(r.target.error)),t.onsuccess=r=>e(r.target.result)}),tf=(t,e)=>on((n,r)=>{const s=indexedDB.open(t);s.onupgradeneeded=i=>e(i.target.result),s.onerror=i=>r(Fe(i.target.error)),s.onsuccess=i=>{const a=i.target.result;a.onversionchange=()=>{a.close()},n(a)}}),nf=t=>Nt(indexedDB.deleteDatabase(t)),rf=(t,e)=>e.forEach(n=>t.createObjectStore.apply(t,n)),Tn=(t,e,n="readwrite")=>{const r=t.transaction(e,n);return e.map(s=>ff(r,s))},zc=(t,e)=>Nt(t.count(e)),sf=(t,e)=>Nt(t.get(e)),Yc=(t,e)=>Nt(t.delete(e)),of=(t,e,n)=>Nt(t.put(e,n)),Hs=(t,e)=>Nt(t.add(e)),cf=(t,e,n)=>Nt(t.getAll(e,n)),af=(t,e,n)=>{let r=null;return hf(t,e,s=>(r=s,!1),n).then(()=>r)},lf=(t,e=null)=>af(t,e,"prev"),uf=(t,e)=>on((n,r)=>{t.onerror=r,t.onsuccess=async s=>{const i=s.target.result;if(i===null||await e(i)===!1)return n();i.continue()}}),hf=(t,e,n,r="next")=>uf(t.openKeyCursor(e,r),s=>n(s.key)),ff=(t,e)=>t.objectStore(e),df=(t,e)=>IDBKeyRange.upperBound(t,e),pf=(t,e)=>IDBKeyRange.lowerBound(t,e),Ts="custom",Kc="updates",Xc=500,Zc=(t,e=()=>{},n=()=>{})=>{const[r]=Tn(t.db,[Kc]);return cf(r,pf(t._dbref,!1)).then(s=>{t._destroyed||(e(r),j(t.doc,()=>{s.forEach(i=>Ku(t.doc,i))},t,!1),n(r))}).then(()=>lf(r).then(s=>{t._dbref=s+1})).then(()=>zc(r).then(s=>{t._dbsize=s})).then(()=>r)},gf=(t,e=!0)=>Zc(t).then(n=>{(e||t._dbsize>=Xc)&&Hs(n,kc(t.doc)).then(()=>Yc(n,df(t._dbref,!0))).then(()=>zc(n).then(r=>{t._dbsize=r}))});class wf extends za{constructor(e,n){super(),this.doc=n,this.name=e,this._dbref=0,this._dbsize=0,this._destroyed=!1,this.db=null,this.synced=!1,this._db=tf(e,r=>rf(r,[["updates",{autoIncrement:!0}],["custom"]])),this.whenSynced=on(r=>this.on("synced",()=>r(this))),this._db.then(r=>{this.db=r,Zc(this,a=>Hs(a,kc(n)),()=>{if(this._destroyed)return this;this.synced=!0,this.emit("synced",[this])})}),this._storeTimeout=1e3,this._storeTimeoutId=null,this._storeUpdate=(r,s)=>{if(this.db&&s!==this){const[i]=Tn(this.db,[Kc]);Hs(i,r),++this._dbsize>=Xc&&(this._storeTimeoutId!==null&&clearTimeout(this._storeTimeoutId),this._storeTimeoutId=setTimeout(()=>{gf(this,!1),this._storeTimeoutId=null},this._storeTimeout))}},n.on("update",this._storeUpdate),this.destroy=this.destroy.bind(this),n.on("destroy",this.destroy)}destroy(){return this._storeTimeoutId&&clearTimeout(this._storeTimeoutId),this.doc.off("update",this._storeUpdate),this.doc.off("destroy",this.destroy),this._destroyed=!0,this._db.then(e=>{e.close()})}clearData(){return this.destroy().then(()=>{nf(this.name)})}get(e){return this._db.then(n=>{const[r]=Tn(n,[Ts],"readonly");return sf(r,e)})}set(e,n){return this._db.then(r=>{const[s]=Tn(r,[Ts]);return of(s,n,e)})}del(e){return this._db.then(n=>{const[r]=Tn(n,[Ts]);return Yc(r,e)})}}const Qc="schwalbvault",yt=new mn,yf=typeof window<"u",Ir=yf?new wf(Qc,yt):null,mf=yt.getMap("characters"),Mn=yt.getMap("campaigns"),bf=yt.getMap("enemies"),Ef=yt.getMap("encounters"),kf=yt.getMap("images"),Sf=yt.getMap("deletedIds"),Af=()=>new Promise(t=>{if(!Ir){t();return}Ir.synced?t():Ir.on("synced",()=>{t()})}),Ap=Object.freeze(Object.defineProperty({__proto__:null,campaignsMap:Mn,charactersMap:mf,deletedIdsMap:Sf,doc:yt,encountersMap:Ef,enemiesMap:bf,imagesMap:kf,provider:Ir,waitForSync:Af},Symbol.toStringTag,{value:"Module"}));const gr="0123456789abcdef";class _t{constructor(e){this.bytes=e}static ofInner(e){if(e.length!==16)throw new TypeError("not 128-bit length");return new _t(e)}static fromFieldsV7(e,n,r,s){if(!Number.isInteger(e)||!Number.isInteger(n)||!Number.isInteger(r)||!Number.isInteger(s)||e<0||n<0||r<0||s<0||e>0xffffffffffff||n>4095||r>1073741823||s>4294967295)throw new RangeError("invalid field value");const i=new Uint8Array(16);return i[0]=e/2**40,i[1]=e/2**32,i[2]=e/2**24,i[3]=e/2**16,i[4]=e/2**8,i[5]=e,i[6]=112|n>>>8,i[7]=n,i[8]=128|r>>>24,i[9]=r>>>16,i[10]=r>>>8,i[11]=r,i[12]=s>>>24,i[13]=s>>>16,i[14]=s>>>8,i[15]=s,new _t(i)}static parse(e){var n,r,s,i;let a;switch(e.length){case 32:a=(n=/^[0-9a-f]{32}$/i.exec(e))===null||n===void 0?void 0:n[0];break;case 36:a=(r=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||r===void 0?void 0:r.slice(1,6).join("");break;case 38:a=(s=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(e))===null||s===void 0?void 0:s.slice(1,6).join("");break;case 45:a=(i=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||i===void 0?void 0:i.slice(1,6).join("");break}if(a){const h=new Uint8Array(16);for(let f=0;f<16;f+=4){const g=parseInt(a.substring(2*f,2*f+8),16);h[f+0]=g>>>24,h[f+1]=g>>>16,h[f+2]=g>>>8,h[f+3]=g}return new _t(h)}else throw new SyntaxError("could not parse UUID string")}toString(){let e="";for(let n=0;n<this.bytes.length;n++)e+=gr.charAt(this.bytes[n]>>>4),e+=gr.charAt(this.bytes[n]&15),(n===3||n===5||n===7||n===9)&&(e+="-");return e}toHex(){let e="";for(let n=0;n<this.bytes.length;n++)e+=gr.charAt(this.bytes[n]>>>4),e+=gr.charAt(this.bytes[n]&15);return e}toJSON(){return this.toString()}getVariant(){const e=this.bytes[8]>>>4;if(e<0)throw new Error("unreachable");if(e<=7)return this.bytes.every(n=>n===0)?"NIL":"VAR_0";if(e<=11)return"VAR_10";if(e<=13)return"VAR_110";if(e<=15)return this.bytes.every(n=>n===255)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return this.getVariant()==="VAR_10"?this.bytes[6]>>>4:void 0}clone(){return new _t(this.bytes.slice(0))}equals(e){return this.compareTo(e)===0}compareTo(e){for(let n=0;n<16;n++){const r=this.bytes[n]-e.bytes[n];if(r!==0)return Math.sign(r)}return 0}}class xf{constructor(e){this.timestamp_biased=0,this.counter=0,this.random=e??_f()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(e,n){let r=this.generateOrAbortCore(e,n);return r===void 0&&(this.timestamp_biased=0,r=this.generateOrAbortCore(e,n)),r}generateOrAbortCore(e,n){if(!Number.isInteger(e)||e<0||e>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit unsigned integer");if(n<0||n>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(e++,e>this.timestamp_biased)this.timestamp_biased=e,this.resetCounter();else if(e+n>=this.timestamp_biased)this.counter++,this.counter>4398046511103&&(this.timestamp_biased++,this.resetCounter());else return;return _t.fromFieldsV7(this.timestamp_biased-1,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=this.random.nextUint32()*1024+(this.random.nextUint32()&1023)}generateV4(){const e=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return e[6]=64|e[6]>>>4,e[8]=128|e[8]>>>2,_t.ofInner(e)}}const _f=()=>{if(typeof crypto<"u"&&typeof crypto.getRandomValues<"u")return new vf;if(typeof UUIDV7_DENY_WEAK_RNG<"u"&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>Math.trunc(Math.random()*65536)*65536+Math.trunc(Math.random()*65536)}};class vf{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}let io;const oo=()=>If().toString(),If=()=>(io||(io=new xf)).generate(),{floor:Cf,random:Tf}=Math,Jn="Trystero",Wn=(t,e)=>Array(t).fill().map(e),co="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",ea=t=>Wn(t,()=>co[Cf(Tf()*co.length)]).join(""),Wt=ea(20),St=Promise.all.bind(Promise),ta=typeof window<"u",{entries:Gs,fromEntries:na,keys:Mf}=Object,et=()=>{},tt=t=>new Error(`${Jn}: ${t}`),Df=new TextEncoder,Of=new TextDecoder,nn=t=>Df.encode(t),Cr=t=>Of.decode(t),wr=(...t)=>t.join("@"),Rf=(t,e,n,r)=>(t.relayUrls||e).slice(0,t.relayUrls?t.relayUrls.length:t.relayRedundancy||n),zn=JSON.stringify,Yn=JSON.parse,ao=3333,yr={};let Bn=null,Js=null;const Uf=()=>{Bn||(Bn=new Promise(t=>{Js=t}).finally(()=>{Js=null,Bn=null}))},Bf=()=>Js?.(),Lf=(t,e)=>{const n={},r=()=>{const s=new WebSocket(t);s.onclose=()=>{if(Bn){Bn.then(r);return}yr[t]??=ao,setTimeout(r,yr[t]),yr[t]*=2},s.onmessage=i=>e(i.data),n.socket=s,n.url=s.url,n.ready=new Promise(i=>s.onopen=()=>{i(n),yr[t]=ao}),n.send=i=>{s.readyState===1&&s.send(i)}};return r(),n},Nf=()=>{if(ta){const t=new AbortController;return addEventListener("online",Bf,{signal:t.signal}),addEventListener("offline",Uf,{signal:t.signal}),()=>t.abort()}return et},Ai="AES-GCM",Ff={},$f=t=>btoa(String.fromCharCode.apply(null,new Uint8Array(t))),Pf=t=>{const e=atob(t);return new Uint8Array(e.length).map((n,r)=>e.charCodeAt(r)).buffer},Vf=async(t,e)=>new Uint8Array(await crypto.subtle.digest(t,nn(e))),Dn=async t=>Ff[t]||=Array.from(await Vf("SHA-1",t)).map(e=>e.toString(36)).join(""),jf=async(t,e,n)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},nn(`${t}:${e}:${n}`)),{name:Ai},!1,["encrypt","decrypt"]),ra="$",sa=",",qf=async(t,e)=>{const n=crypto.getRandomValues(new Uint8Array(16));return n.join(sa)+ra+$f(await crypto.subtle.encrypt({name:Ai,iv:n},await t,nn(e)))},Hf=async(t,e)=>{const[n,r]=e.split(ra);return Cr(await crypto.subtle.decrypt({name:Ai,iv:new Uint8Array(n.split(sa))},await t,Pf(r)))},Gf=5e3,lo="icegatheringstatechange",uo="offer",Jf="answer",ho=(t,{rtcConfig:e,rtcPolyfill:n,turnConfig:r})=>{const s=new(n||RTCPeerConnection)({iceServers:Wf.concat(r||[]),...e}),i={};let a=!1,h=!1,f=null;const g=w=>{w.binaryType="arraybuffer",w.bufferedAmountLowThreshold=65535,w.onmessage=p=>i.data?.(p.data),w.onopen=()=>i.connect?.(),w.onclose=()=>i.close?.(),w.onerror=p=>i.error?.(p)},u=w=>Promise.race([new Promise(p=>{const m=()=>{w.iceGatheringState==="complete"&&(w.removeEventListener(lo,m),p())};w.addEventListener(lo,m),m()}),new Promise(p=>setTimeout(p,Gf))]).then(()=>({type:w.localDescription.type,sdp:w.localDescription.sdp.replace(/a=ice-options:trickle\s\n/g,"")}));return t?(f=s.createDataChannel("data"),g(f)):s.ondatachannel=({channel:w})=>{f=w,g(w)},s.onnegotiationneeded=async()=>{try{a=!0,await s.setLocalDescription();const w=await u(s);i.signal?.(w)}catch(w){i.error?.(w)}finally{a=!1}},s.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(s.connectionState)&&i.close?.()},s.ontrack=w=>{i.track?.(w.track,w.streams[0]),i.stream?.(w.streams[0])},s.onremovestream=w=>i.stream?.(w.stream),t&&(s.canTrickleIceCandidates||s.onnegotiationneeded()),{created:Date.now(),connection:s,get channel(){return f},get isDead(){return s.connectionState==="closed"},async signal(w){if(!(f?.readyState==="open"&&!w.sdp?.includes("a=rtpmap")))try{if(w.type===uo){if(a||s.signalingState!=="stable"&&!h){if(t)return;await St([s.setLocalDescription({type:"rollback"}),s.setRemoteDescription(w)])}else await s.setRemoteDescription(w);await s.setLocalDescription();const p=await u(s);return i.signal?.(p),p}else if(w.type===Jf){h=!0;try{await s.setRemoteDescription(w)}finally{h=!1}}}catch(p){i.error?.(p)}},sendData:w=>f.send(w),destroy:()=>{f?.close(),s.close(),a=!1,h=!1},setHandlers:w=>Object.assign(i,w),offerPromise:t?new Promise(w=>i.signal=p=>{p.type===uo&&w(p)}):Promise.resolve(),addStream:w=>w.getTracks().forEach(p=>s.addTrack(p,w)),removeStream:w=>s.getSenders().filter(p=>w.getTracks().includes(p.track)).forEach(p=>s.removeTrack(p)),addTrack:(w,p)=>s.addTrack(w,p),removeTrack:w=>{const p=s.getSenders().find(m=>m.track===w);p&&s.removeTrack(p)},replaceTrack:(w,p)=>{const m=s.getSenders().find(k=>k.track===w);if(m)return m.replaceTrack(p)}}},Wf=[...Wn(3,(t,e)=>`stun:stun${e||""}.l.google.com:19302`),"stun:stun.cloudflare.com:3478"].map(t=>({urls:t})),zf=Object.getPrototypeOf(Uint8Array),Tr=12,ia=0,Mr=ia+Tr,Dr=Mr+1,On=Dr+1,Rn=On+1,Et=16*2**10-Rn,mr=255,fo="bufferedamountlow",Gt=t=>"@_"+t,Yf=(t,e,n)=>{const r={},s={},i={},a={},h={},f={},g={},u={onPeerJoin:et,onPeerLeave:et,onPeerStream:et,onPeerTrack:et},w=(S,x)=>(S?Array.isArray(S)?S:[S]:Mf(r)).flatMap(D=>{const B=r[D];return B?x(D,B):(console.warn(`${Jn}: no peer with id ${D} found`),[])}),p=S=>{r[S]&&(r[S].destroy(),delete r[S],delete a[S],delete h[S],u.onPeerLeave(S),e(S))},m=S=>{if(s[S])return i[S];if(!S)throw tt("action type argument is required");const x=nn(S);if(x.byteLength>Tr)throw tt(`action type string "${S}" (${x.byteLength}b) exceeds byte limit (${Tr}). Hint: choose a shorter name.`);const D=new Uint8Array(Tr);D.set(x);let B=0;return s[S]={onComplete:et,onProgress:et,setOnComplete:q=>s[S]={...s[S],onComplete:q},setOnProgress:q=>s[S]={...s[S],onProgress:q},send:async(q,_,M,z)=>{if(M&&typeof M!="object")throw tt("action meta argument must be an object");const ge=typeof q;if(ge==="undefined")throw tt("action data cannot be undefined");const ce=ge!=="string",Ue=q instanceof Blob,P=Ue||q instanceof ArrayBuffer||q instanceof zf;if(M&&!P)throw tt("action meta argument can only be used with binary data");const L=P?new Uint8Array(Ue?await q.arrayBuffer():q):nn(ce?zn(q):q),G=M?nn(zn(M)):null,K=Math.ceil(L.byteLength/Et)+(M?1:0)||1,ne=Wn(K,(re,ae)=>{const ve=ae===K-1,we=M&&ae===0,Se=new Uint8Array(Rn+(we?G.byteLength:ve?L.byteLength-Et*(K-(M?2:1)):Et));return Se.set(D),Se.set([B],Mr),Se.set([ve|we<<1|P<<2|ce<<3],Dr),Se.set([Math.round((ae+1)/K*mr)],On),Se.set(M?we?G:L.subarray((ae-1)*Et,ae*Et):L.subarray(ae*Et,(ae+1)*Et),Rn),Se});return B=B+1&mr,St(w(_,async(re,ae)=>{const{channel:ve}=ae;let we=0;for(;we<K;){const Se=ne[we];if(ve.bufferedAmount>ve.bufferedAmountLowThreshold&&await new Promise(lr=>{const ur=()=>{ve.removeEventListener(fo,ur),lr()};ve.addEventListener(fo,ur)}),!r[re])break;ae.sendData(Se),we++,z?.(Se[On]/mr,re,M)}}))}},i[S]||=[s[S].send,s[S].setOnComplete,s[S].setOnProgress]},k=(S,x)=>{const D=new Uint8Array(x),B=Cr(D.subarray(ia,Mr)).replaceAll("\0",""),[q]=D.subarray(Mr,Dr),[_]=D.subarray(Dr,On),[M]=D.subarray(On,Rn),z=D.subarray(Rn),ge=!!(_&1),ce=!!(_&2),Ue=!!(_&4),P=!!(_&8);if(!s[B]){console.warn(`${Jn}: received message with unregistered type (${B})`);return}a[S]||={},a[S][B]||={};const L=a[S][B][q]||={chunks:[]};if(ce?L.meta=Yn(Cr(z)):L.chunks.push(z),s[B].onProgress(M/mr,S,L.meta),!ge)return;const G=new Uint8Array(L.chunks.reduce((K,ne)=>K+ne.byteLength,0));if(L.chunks.reduce((K,ne)=>(G.set(ne,K),K+ne.byteLength),0),delete a[S][B][q],Ue)s[B].onComplete(G,S,L.meta);else{const K=Cr(G);s[B].onComplete(P?Yn(K):K,S)}},A=async()=>{await bt(""),await new Promise(S=>setTimeout(S,99)),Gs(r).forEach(([S,x])=>{x.destroy(),delete r[S]}),n()},[T,oe]=m(Gt("ping")),[Y,I]=m(Gt("pong")),[v,$]=m(Gt("signal")),[pe,mt]=m(Gt("stream")),[be,Pt]=m(Gt("track")),[bt,Vt]=m(Gt("leave"));return t((S,x)=>{r[x]||(r[x]=S,S.setHandlers({data:D=>k(x,D),stream:D=>{u.onPeerStream(D,x,f[x]),delete f[x]},track:(D,B)=>{u.onPeerTrack(D,B,x,g[x]),delete g[x]},signal:D=>v(D,x),close:()=>p(x),error:D=>{console.error(D),p(x)}}),u.onPeerJoin(x))}),oe((S,x)=>Y("",x)),I((S,x)=>{h[x]?.(),delete h[x]}),$((S,x)=>r[x]?.signal(S)),mt((S,x)=>f[x]=S),Pt((S,x)=>g[x]=S),Vt((S,x)=>p(x)),ta&&addEventListener("beforeunload",A),{makeAction:m,leave:A,ping:async S=>{if(!S)throw tt("ping() must be called with target peer ID");const x=Date.now();return T("",S),await new Promise(D=>h[S]=D),Date.now()-x},getPeers:()=>na(Gs(r).map(([S,x])=>[S,x.connection])),addStream:(S,x,D)=>w(x,async(B,q)=>{D&&await pe(D,B),q.addStream(S)}),removeStream:(S,x)=>w(x,(D,B)=>B.removeStream(S)),addTrack:(S,x,D,B)=>w(D,async(q,_)=>{B&&await be(B,q),_.addTrack(S,x)}),removeTrack:(S,x)=>w(x,(D,B)=>B.removeTrack(S)),replaceTrack:(S,x,D,B)=>w(D,async(q,_)=>{B&&await be(B,q),_.replaceTrack(S,x)}),onPeerJoin:S=>u.onPeerJoin=S,onPeerLeave:S=>u.onPeerLeave=S,onPeerStream:S=>u.onPeerStream=S,onPeerTrack:S=>u.onPeerTrack=S}},Kf=20,Xf=5333,po=57333,Zf=({init:t,subscribe:e,announce:n})=>{const r={};let s=!1,i,a,h,f;return(g,u,w)=>{const{appId:p}=g;if(r[p]?.[u])return r[p][u];const m={},k={},A=wr(Jn,p,u),T=Dn(A),oe=Dn(wr(A,Wt)),Y=jf(g.password||"",p,u),I=_=>async M=>({type:M.type,sdp:await _(Y,M.sdp)}),v=I(Hf),$=I(qf),pe=()=>ho(!0,g),mt=(_,M,z)=>{if(k[M]){k[M]!==_&&_.destroy();return}k[M]=_,q(_,M),m[M]?.forEach((ge,ce)=>{ce!==z&&ge.destroy()}),delete m[M]},be=(_,M)=>{k[M]===_&&delete k[M]},Pt=(_,M)=>{if(k[_])return;const z=m[_]?.[M];z&&(delete m[_][M],z.destroy())},bt=_=>(a.push(...Wn(_,pe)),St(a.splice(0,_).map(M=>M.offerPromise.then($).then(z=>({peer:M,offer:z}))))),Vt=(_,M)=>w?.({error:`incorrect password (${g.password}) when decrypting ${M}`,appId:p,peerId:_,roomId:u}),S=_=>async(M,z,ge)=>{const[ce,Ue]=await St([T,oe]);if(M!==ce&&M!==Ue)return;const{peerId:P,offer:L,answer:G,peer:K}=typeof z=="string"?Yn(z):z;if(!(P===Wt||k[P])){if(P&&!L&&!G){if(m[P]?.[_])return;const[[{peer:ne,offer:re}],ae]=await St([bt(1),Dn(wr(A,P))]);m[P]||=[],m[P][_]=ne,setTimeout(()=>Pt(P,_),x[_]*.9),ne.setHandlers({connect:()=>mt(ne,P,_),close:()=>be(ne,P)}),ge(ae,zn({peerId:Wt,offer:re}))}else if(L){if(m[P]?.[_]&&Wt>P)return;const re=ho(!1,g);re.setHandlers({connect:()=>mt(re,P,_),close:()=>be(re,P)});let ae;try{ae=await v(L)}catch{Vt(P,"offer");return}if(re.isDead)return;const[ve,we]=await St([Dn(wr(A,P)),re.signal(ae)]);ge(ve,zn({peerId:Wt,answer:await $(we)}))}else if(G){let ne;try{ne=await v(G)}catch{Vt(P,"answer");return}if(K)K.setHandlers({connect:()=>mt(K,P,_),close:()=>be(K,P)}),K.signal(ne);else{const re=m[P]?.[_];re&&!re.isDead&&re.signal(ne)}}}};if(!g)throw tt("requires a config map as the first argument");if(!p&&!g.firebaseApp)throw tt("config map is missing appId field");if(!u)throw tt("roomId argument required");if(!s){const _=t(g);a=Wn(Kf,pe),i=Array.isArray(_)?_:[_],s=!0,h=setInterval(()=>a=a.filter(M=>{const z=Date.now()-M.created<po;return z||M.destroy(),z}),po*1.03),f=g.manualRelayReconnection?et:Nf()}const x=i.map(()=>Xf),D=[],B=i.map(async(_,M)=>e(await _,await T,await oe,S(M),bt));St([T,oe]).then(([_,M])=>{const z=async(ge,ce)=>{const Ue=await n(ge,_,M);typeof Ue=="number"&&(x[ce]=Ue),D[ce]=setTimeout(()=>z(ge,ce),x[ce])};B.forEach(async(ge,ce)=>{await ge,z(await i[ce],ce)})});let q=et;return r[p]||={},r[p][u]=Yf(_=>q=_,_=>delete k[_],()=>{delete r[p][u],D.forEach(clearTimeout),B.forEach(async _=>(await _)()),clearInterval(h),f(),s=!1})}},Ms={},oa={},vn={},In={},Cn={},go={},br={},Qf="announce",ca=20,wo=10,ed=33333,td=120333,nd=3,rd=async t=>{if(Ms[t])return Ms[t];const e=(await Dn(t)).slice(0,ca);return Ms[t]=e,oa[e]=t,e},yo=async(t,e,n)=>t.send(zn({action:Qf,info_hash:await rd(e),peer_id:Wt,...n})),mo=(t,e,n)=>console.warn(`${Jn}: torrent tracker ${n?"failure":"warning"} from ${t} - ${e}`),aa=Zf({init:t=>Rf(t,sd,nd).map(e=>{const n=Lf(e,s=>{const i=Yn(s),a=i["failure reason"],h=i["warning message"],{interval:f}=i,g=oa[i.info_hash];if(a){mo(r,a,!0);return}if(h&&mo(r,h),f&&f*1e3>Cn[r]&&In[r][g]){const u=Math.min(f*1e3,td);clearInterval(vn[r][g]),Cn[r]=u,vn[r][g]=setInterval(In[r][g],u)}go[i.offer_id]||(i.offer||i.answer)&&(go[i.offer_id]=!0,br[r][g]?.(i))}),{url:r}=n;return br[r]={},n.ready}),subscribe:(t,e,n,r,s)=>{const{url:i}=t,a=async()=>{const h=na((await s(wo)).map(f=>[ea(ca),f]));br[t.url][e]=f=>{if(f.offer)r(e,{offer:f.offer,peerId:f.peer_id},(g,u)=>yo(t,e,{answer:Yn(u).answer,offer_id:f.offer_id,to_peer_id:f.peer_id}));else if(f.answer){const g=h[f.offer_id];g&&r(e,{answer:f.answer,peerId:f.peer_id,peer:g.peer})}},yo(t,e,{numwant:wo,offers:Gs(h).map(([f,{offer:g}])=>({offer_id:f,offer:g}))})};return Cn[i]=ed,In[i]||={},In[i][e]=a,vn[i]||={},vn[i][e]=setInterval(a,Cn[i]),a(),()=>{clearInterval(vn[i][e]),delete br[i][e],delete In[i][e]}},announce:t=>Cn[t.url]}),sd=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.btorrent.xyz","tracker.files.fm:7073/announce"].map(t=>"wss://"+t),xp=["Aeromancy","Alchemy","Alteration","Animism","Astromancy","Chaos","Chronomancy","Conjuration","Cryomancy","Dark Arts","Destruction","Divination","Eldritch","Enchantment","Evocation","Geomancy","Hydromancy","Illusion","Invocation","Necromancy","Oneiromancy","Order","Primal","Protection","Psychomancy","Pyromancy","Shadowmancy","Skullduggery","Spiritualism","Symbolism","Technomancy","Teleportation","War"],_p={NEXT_ROLL:"Prxima Rolagem",ROUNDS:"Rodadas",MINUTES:"Minutos",HOURS:"Horas",DAYS:"Dias",LUCK_ENDS:"Sorte Encerra",PERMANENT:"Indeterminado"},Te={WEAPON:"Weapon",ARMOR:"Armor",SHIELD:"Shield",CONSUMABLE:"Consumable",EXPLOSIVE:"Explosive",OTHER:"Other"},Ct={ADD:"ADD",SET:"SET",MULT:"MULT"},vp={str:"Fora",agi:"Agilidade",int:"Intelecto",wil:"Vontade",defense:"Defesa",speed:"Deslocamento",health:"Vida",damage:"Dano (Dados)",boons:"Boons/Banes"},Ip={Blinded:{effect:"Make rolls with 3 banes. No sight reactions. Speed halved.",speedMult:.5,rollMod:-3},Confused:{effect:"No reactions. Intellect and Will rolls with 1 bane.",rollMod:-1,attributes:["int","wil"]},Controlled:{effect:"Controller decides your turn. Regard source as ally."},Cursed:{effect:"Luck rolls with 1 bane."},Deafened:{effect:"No hearing reactions. Immune to hearing effects."},Frightened:{effect:"Attribute rolls with 1 bane (while in LOS). Grant 1 boon on rolls against you.",rollMod:-1},Held:{effect:"Speed 0. Cannot increase Speed. Auto-fail Agility defense rolls.",speedFixed:0},Impaired:{effect:"Roll with 1 bane for specified attribute. Grant 1 boon against that attribute.",rollMod:-1},Incapacitated:{effect:"Damage equals or exceeds Health. You cannot use actions or reactions. Speed 0.",speedFixed:0},"On Fire":{effect:"Take 1d6 damage at end of round. Action/Luck roll to extinguish."},Poisoned:{effect:"Attribute rolls with 1 bane. Grant 1 boon against you. Lose 1d6 Health end of round.",rollMod:-1},Prone:{effect:"No reactions. Grant 1 boon to melee vs you, impose 1 bane to ranged vs you."},Slowed:{effect:"Speed drops to 2 (if higher). Cannot benefit from Speed increases.",speedCap:2},Stunned:{effect:"No actions/reactions. Speed 0. Grant 2 boons against you. Attribute rolls with 2 banes.",speedFixed:0,rollMod:-2},Unconscious:{effect:"No actions/reactions. Speed 0. Grant 3 boons against you. Auto-fail attribute rolls.",speedFixed:0,autoFail:!0},Vulnerable:{effect:"Grant 1 boon on attacks/rolls against you."},Weakened:{effect:"Strength/Agility rolls with 1 bane. Grant 1 boon vs Str/Agi. Speed halved.",speedMult:.5,attributes:["str","agi"],rollMod:-1}},id={OFF:"Off",ONE:"One",TWO:"Two"},Cp=["NIMBLE","FIREARM","THROWN","BRUTAL","BLUDGEONING","SLASHING","DISARMING","RANGE","SPECIAL","MISFIRE","LARGE","SLOW","LIGHT","LONG","AMMUNITION","PIERCING","RELOAD","VERSATILE"],Tp={ANCESTRY:"Ancestry",NOVICE:"Novice",EXPERT:"Expert",MASTER:"Master"};var Ce="INUMBER",En="IOP1",kn="IOP2",Sn="IOP3",st="IVAR",Rt="IVARNAME",fn="IFUNCALL",cs="IFUNDEF",ke="IEXPR",xi="IEXPREVAL",Ft="IMEMBER",as="IENDSTATEMENT",dn="IARRAY";function F(t,e){this.type=t,this.value=e??0}F.prototype.toString=function(){switch(this.type){case Ce:case En:case kn:case Sn:case st:case Rt:case as:return this.value;case fn:return"CALL "+this.value;case cs:return"DEF "+this.value;case dn:return"ARRAY "+this.value;case Ft:return"."+this.value;default:return"Invalid Instruction"}};function ls(t){return new F(En,t)}function ut(t){return new F(kn,t)}function la(t){return new F(Sn,t)}function Ws(t,e,n,r,s){for(var i=[],a=[],h,f,g,u,w=0;w<t.length;w++){var p=t[w],m=p.type;if(m===Ce||m===Rt)Array.isArray(p.value)?i.push.apply(i,Ws(p.value.map(function(k){return new F(Ce,k)}).concat(new F(dn,p.value.length)),e,n,r,s)):i.push(p);else if(m===st&&s.hasOwnProperty(p.value))p=new F(Ce,s[p.value]),i.push(p);else if(m===kn&&i.length>1)f=i.pop(),h=i.pop(),u=n[p.value],p=new F(Ce,u(h.value,f.value)),i.push(p);else if(m===Sn&&i.length>2)g=i.pop(),f=i.pop(),h=i.pop(),p.value==="?"?i.push(h.value?f.value:g.value):(u=r[p.value],p=new F(Ce,u(h.value,f.value,g.value)),i.push(p));else if(m===En&&i.length>0)h=i.pop(),u=e[p.value],p=new F(Ce,u(h.value)),i.push(p);else if(m===ke){for(;i.length>0;)a.push(i.shift());a.push(new F(ke,Ws(p.value,e,n,r,s)))}else if(m===Ft&&i.length>0)h=i.pop(),i.push(new F(Ce,h.value[p.value]));else{for(;i.length>0;)a.push(i.shift());a.push(p)}}for(;i.length>0;)a.push(i.shift());return a}function ua(t,e,n){for(var r=[],s=0;s<t.length;s++){var i=t[s],a=i.type;if(a===st&&i.value===e)for(var h=0;h<n.tokens.length;h++){var f=n.tokens[h],g;f.type===En?g=ls(f.value):f.type===kn?g=ut(f.value):f.type===Sn?g=la(f.value):g=new F(f.type,f.value),r.push(g)}else a===ke?r.push(new F(ke,ua(i.value,e,n))):r.push(i)}return r}function At(t,e,n){var r=[],s,i,a,h,f,g;if(_i(t))return Qe(t,n);for(var u=t.length,w=0;w<u;w++){var p=t[w],m=p.type;if(m===Ce||m===Rt)r.push(p.value);else if(m===kn)i=r.pop(),s=r.pop(),p.value==="and"?r.push(s?!!At(i,e,n):!1):p.value==="or"?r.push(s?!0:!!At(i,e,n)):p.value==="="?(h=e.binaryOps[p.value],r.push(h(s,At(i,e,n),n))):(h=e.binaryOps[p.value],r.push(h(Qe(s,n),Qe(i,n))));else if(m===Sn)a=r.pop(),i=r.pop(),s=r.pop(),p.value==="?"?r.push(At(s?i:a,e,n)):(h=e.ternaryOps[p.value],r.push(h(Qe(s,n),Qe(i,n),Qe(a,n))));else if(m===st)if(p.value in e.functions)r.push(e.functions[p.value]);else if(p.value in e.unaryOps&&e.parser.isOperatorEnabled(p.value))r.push(e.unaryOps[p.value]);else{var k=n[p.value];if(k!==void 0)r.push(k);else throw new Error("undefined variable: "+p.value)}else if(m===En)s=r.pop(),h=e.unaryOps[p.value],r.push(h(Qe(s,n)));else if(m===fn){for(g=p.value,f=[];g-- >0;)f.unshift(Qe(r.pop(),n));if(h=r.pop(),h.apply&&h.call)r.push(h.apply(void 0,f));else throw new Error(h+" is not a function")}else if(m===cs)r.push((function(){for(var A=r.pop(),T=[],oe=p.value;oe-- >0;)T.unshift(r.pop());var Y=r.pop(),I=function(){for(var v=Object.assign({},n),$=0,pe=T.length;$<pe;$++)v[T[$]]=arguments[$];return At(A,e,v)};return Object.defineProperty(I,"name",{value:Y,writable:!1}),n[Y]=I,I})());else if(m===ke)r.push(od(p,e));else if(m===xi)r.push(p);else if(m===Ft)s=r.pop(),r.push(s[p.value]);else if(m===as)r.pop();else if(m===dn){for(g=p.value,f=[];g-- >0;)f.unshift(r.pop());r.push(f)}else throw new Error("invalid Expression")}if(r.length>1)throw new Error("invalid Expression (parity)");return r[0]===0?0:Qe(r[0],n)}function od(t,e,n){return _i(t)?t:{type:xi,value:function(r){return At(t.value,e,r)}}}function _i(t){return t&&t.type===xi}function Qe(t,e){return _i(t)?t.value(e):t}function vi(t,e){for(var n=[],r,s,i,a,h,f,g=0;g<t.length;g++){var u=t[g],w=u.type;if(w===Ce)typeof u.value=="number"&&u.value<0?n.push("("+u.value+")"):Array.isArray(u.value)?n.push("["+u.value.map(bo).join(", ")+"]"):n.push(bo(u.value));else if(w===kn)s=n.pop(),r=n.pop(),a=u.value,e?a==="^"?n.push("Math.pow("+r+", "+s+")"):a==="and"?n.push("(!!"+r+" && !!"+s+")"):a==="or"?n.push("(!!"+r+" || !!"+s+")"):a==="||"?n.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+r+"),("+s+")))"):a==="=="?n.push("("+r+" === "+s+")"):a==="!="?n.push("("+r+" !== "+s+")"):a==="["?n.push(r+"[("+s+") | 0]"):n.push("("+r+" "+a+" "+s+")"):a==="["?n.push(r+"["+s+"]"):n.push("("+r+" "+a+" "+s+")");else if(w===Sn)if(i=n.pop(),s=n.pop(),r=n.pop(),a=u.value,a==="?")n.push("("+r+" ? "+s+" : "+i+")");else throw new Error("invalid Expression");else if(w===st||w===Rt)n.push(u.value);else if(w===En)r=n.pop(),a=u.value,a==="-"||a==="+"?n.push("("+a+r+")"):e?a==="not"?n.push("(!"+r+")"):a==="!"?n.push("fac("+r+")"):n.push(a+"("+r+")"):a==="!"?n.push("("+r+"!)"):n.push("("+a+" "+r+")");else if(w===fn){for(f=u.value,h=[];f-- >0;)h.unshift(n.pop());a=n.pop(),n.push(a+"("+h.join(", ")+")")}else if(w===cs){for(s=n.pop(),f=u.value,h=[];f-- >0;)h.unshift(n.pop());r=n.pop(),e?n.push("("+r+" = function("+h.join(", ")+") { return "+s+" })"):n.push("("+r+"("+h.join(", ")+") = "+s+")")}else if(w===Ft)r=n.pop(),n.push(r+"."+u.value);else if(w===dn){for(f=u.value,h=[];f-- >0;)h.unshift(n.pop());n.push("["+h.join(", ")+"]")}else if(w===ke)n.push("("+vi(u.value,e)+")");else if(w!==as)throw new Error("invalid Expression")}return n.length>1&&(e?n=[n.join(",")]:n=[n.join(";")]),String(n[0])}function bo(t){return typeof t=="string"?JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):t}function Yt(t,e){for(var n=0;n<t.length;n++)if(t[n]===e)return!0;return!1}function Ii(t,e,n){n=n||{};for(var r=!!n.withMembers,s=null,i=0;i<t.length;i++){var a=t[i];a.type===st||a.type===Rt?!r&&!Yt(e,a.value)?e.push(a.value):(s!==null&&(Yt(e,s)||e.push(s)),s=a.value):a.type===Ft&&r&&s!==null?s+="."+a.value:a.type===ke?Ii(a.value,e,n):s!==null&&(Yt(e,s)||e.push(s),s=null)}s!==null&&!Yt(e,s)&&e.push(s)}function Ne(t,e){this.tokens=t,this.parser=e,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.functions=e.functions}Ne.prototype.simplify=function(t){return t=t||{},new Ne(Ws(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,t),this.parser)};Ne.prototype.substitute=function(t,e){return e instanceof Ne||(e=this.parser.parse(String(e))),new Ne(ua(this.tokens,t,e),this.parser)};Ne.prototype.evaluate=function(t){return t=t||{},At(this.tokens,this,t)};Ne.prototype.toString=function(){return vi(this.tokens,!1)};Ne.prototype.symbols=function(t){t=t||{};var e=[];return Ii(this.tokens,e,t),e};Ne.prototype.variables=function(t){t=t||{};var e=[];Ii(this.tokens,e,t);var n=this.functions;return e.filter(function(r){return!(r in n)})};Ne.prototype.toJSFunction=function(t,e){var n=this,r=new Function(t,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+vi(this.simplify(e).tokens,!0)+"; }");return function(){return r.apply(n,arguments)}};var Kn="TEOF",H="TOP",us="TNUMBER",ha="TSTRING",it="TPAREN",pn="TBRACKET",hs="TCOMMA",Ci="TNAME",Ti="TSEMICOLON";function fa(t,e,n){this.type=t,this.value=e,this.index=n}fa.prototype.toString=function(){return this.type+": "+this.value};function Q(t,e){this.pos=0,this.current=null,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.consts=t.consts,this.expression=e,this.savedPosition=0,this.savedCurrent=null,this.options=t.options,this.parser=t}Q.prototype.newToken=function(t,e,n){return new fa(t,e,n??this.pos)};Q.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};Q.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};Q.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(Kn,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};Q.prototype.isString=function(){var t=!1,e=this.pos,n=this.expression.charAt(e);if(n==="'"||n==='"')for(var r=this.expression.indexOf(n,e+1);r>=0&&this.pos<this.expression.length;){if(this.pos=r+1,this.expression.charAt(r-1)!=="\\"){var s=this.expression.substring(e+1,r);this.current=this.newToken(ha,this.unescape(s),e),t=!0;break}r=this.expression.indexOf(n,r+1)}return t};Q.prototype.isParen=function(){var t=this.expression.charAt(this.pos);return t==="("||t===")"?(this.current=this.newToken(it,t),this.pos++,!0):!1};Q.prototype.isBracket=function(){var t=this.expression.charAt(this.pos);return(t==="["||t==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken(pn,t),this.pos++,!0):!1};Q.prototype.isComma=function(){var t=this.expression.charAt(this.pos);return t===","?(this.current=this.newToken(hs,","),this.pos++,!0):!1};Q.prototype.isSemicolon=function(){var t=this.expression.charAt(this.pos);return t===";"?(this.current=this.newToken(Ti,";"),this.pos++,!0):!1};Q.prototype.isConst=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var n=this.expression.charAt(e);if(n.toUpperCase()===n.toLowerCase()&&(e===this.pos||n!=="_"&&n!=="."&&(n<"0"||n>"9")))break}if(e>t){var r=this.expression.substring(t,e);if(r in this.consts)return this.current=this.newToken(us,this.consts[r]),this.pos+=r.length,!0}return!1};Q.prototype.isNamedOp=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var n=this.expression.charAt(e);if(n.toUpperCase()===n.toLowerCase()&&(e===this.pos||n!=="_"&&(n<"0"||n>"9")))break}if(e>t){var r=this.expression.substring(t,e);if(this.isOperatorEnabled(r)&&(r in this.binaryOps||r in this.unaryOps||r in this.ternaryOps))return this.current=this.newToken(H,r),this.pos+=r.length,!0}return!1};Q.prototype.isName=function(){for(var t=this.pos,e=t,n=!1;e<this.expression.length;e++){var r=this.expression.charAt(e);if(r.toUpperCase()===r.toLowerCase()){if(e===this.pos&&(r==="$"||r==="_")){r==="_"&&(n=!0);continue}else if(e===this.pos||!n||r!=="_"&&(r<"0"||r>"9"))break}else n=!0}if(n){var s=this.expression.substring(t,e);return this.current=this.newToken(Ci,s),this.pos+=s.length,!0}return!1};Q.prototype.isWhitespace=function(){for(var t=!1,e=this.expression.charAt(this.pos);(e===" "||e==="	"||e===`
`||e==="\r")&&(t=!0,this.pos++,!(this.pos>=this.expression.length));)e=this.expression.charAt(this.pos);return t};var cd=/^[0-9a-f]{4}$/i;Q.prototype.unescape=function(t){var e=t.indexOf("\\");if(e<0)return t;for(var n=t.substring(0,e);e>=0;){var r=t.charAt(++e);switch(r){case"'":n+="'";break;case'"':n+='"';break;case"\\":n+="\\";break;case"/":n+="/";break;case"b":n+="\b";break;case"f":n+="\f";break;case"n":n+=`
`;break;case"r":n+="\r";break;case"t":n+="	";break;case"u":var s=t.substring(e+1,e+5);cd.test(s)||this.parseError("Illegal escape sequence: \\u"+s),n+=String.fromCharCode(parseInt(s,16)),e+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+r+'"')}++e;var i=t.indexOf("\\",e);n+=t.substring(e,i<0?t.length:i),e=i}return n};Q.prototype.isComment=function(){var t=this.expression.charAt(this.pos);return t==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};Q.prototype.isRadixInteger=function(){var t=this.pos;if(t>=this.expression.length-2||this.expression.charAt(t)!=="0")return!1;++t;var e,n;if(this.expression.charAt(t)==="x")e=16,n=/^[0-9a-f]$/i,++t;else if(this.expression.charAt(t)==="b")e=2,n=/^[01]$/i,++t;else return!1;for(var r=!1,s=t;t<this.expression.length;){var i=this.expression.charAt(t);if(n.test(i))t++,r=!0;else break}return r&&(this.current=this.newToken(us,parseInt(this.expression.substring(s,t),e)),this.pos=t),r};Q.prototype.isNumber=function(){for(var t=!1,e=this.pos,n=e,r=e,s=!1,i=!1,a;e<this.expression.length&&(a=this.expression.charAt(e),a>="0"&&a<="9"||!s&&a===".");)a==="."?s=!0:i=!0,e++,t=i;if(t&&(r=e),a==="e"||a==="E"){e++;for(var h=!0,f=!1;e<this.expression.length;){if(a=this.expression.charAt(e),h&&(a==="+"||a==="-"))h=!1;else if(a>="0"&&a<="9")f=!0,h=!1;else break;e++}f||(e=r)}return t?(this.current=this.newToken(us,parseFloat(this.expression.substring(n,e))),this.pos=e):this.pos=r,t};Q.prototype.isOperator=function(){var t=this.pos,e=this.expression.charAt(this.pos);if(e==="+"||e==="-"||e==="*"||e==="/"||e==="%"||e==="^"||e==="?"||e===":"||e===".")this.current=this.newToken(H,e);else if(e===""||e==="")this.current=this.newToken(H,"*");else if(e===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(H,">="),this.pos++):this.current=this.newToken(H,">");else if(e==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(H,"<="),this.pos++):this.current=this.newToken(H,"<");else if(e==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(H,"||"),this.pos++;else return!1;else if(e==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(H,"=="),this.pos++):this.current=this.newToken(H,e);else if(e==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(H,"!="),this.pos++):this.current=this.newToken(H,e);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=t,!1)};Q.prototype.isOperatorEnabled=function(t){return this.parser.isOperatorEnabled(t)};Q.prototype.getCoordinates=function(){var t=0,e,n=-1;do t++,e=this.pos-n,n=this.expression.indexOf(`
`,n+1);while(n>=0&&n<this.pos);return{line:t,column:e}};Q.prototype.parseError=function(t){var e=this.getCoordinates();throw new Error("parse error ["+e.line+":"+e.column+"]: "+t)};function J(t,e,n){this.parser=t,this.tokens=e,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=n.allowMemberAccess!==!1}J.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};J.prototype.tokenMatches=function(t,e){return typeof e>"u"?!0:Array.isArray(e)?Yt(e,t.value):typeof e=="function"?e(t):t.value===e};J.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};J.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};J.prototype.accept=function(t,e){return this.nextToken.type===t&&this.tokenMatches(this.nextToken,e)?(this.next(),!0):!1};J.prototype.expect=function(t,e){if(!this.accept(t,e)){var n=this.tokens.getCoordinates();throw new Error("parse error ["+n.line+":"+n.column+"]: Expected "+(e||t))}};J.prototype.parseAtom=function(t){var e=this.tokens.unaryOps;function n(s){return s.value in e}if(this.accept(Ci)||this.accept(H,n))t.push(new F(st,this.current.value));else if(this.accept(us))t.push(new F(Ce,this.current.value));else if(this.accept(ha))t.push(new F(Ce,this.current.value));else if(this.accept(it,"("))this.parseExpression(t),this.expect(it,")");else if(this.accept(pn,"["))if(this.accept(pn,"]"))t.push(new F(dn,0));else{var r=this.parseArrayList(t);t.push(new F(dn,r))}else throw new Error("unexpected "+this.nextToken)};J.prototype.parseExpression=function(t){var e=[];this.parseUntilEndStatement(t,e)||(this.parseVariableAssignmentExpression(e),!this.parseUntilEndStatement(t,e)&&this.pushExpression(t,e))};J.prototype.pushExpression=function(t,e){for(var n=0,r=e.length;n<r;n++)t.push(e[n])};J.prototype.parseUntilEndStatement=function(t,e){return this.accept(Ti)?(this.nextToken&&this.nextToken.type!==Kn&&!(this.nextToken.type===it&&this.nextToken.value===")")&&e.push(new F(as)),this.nextToken.type!==Kn&&this.parseExpression(e),t.push(new F(ke,e)),!0):!1};J.prototype.parseArrayList=function(t){for(var e=0;!this.accept(pn,"]");)for(this.parseExpression(t),++e;this.accept(hs);)this.parseExpression(t),++e;return e};J.prototype.parseVariableAssignmentExpression=function(t){for(this.parseConditionalExpression(t);this.accept(H,"=");){var e=t.pop(),n=[],r=t.length-1;if(e.type===fn){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var s=0,i=e.value+1;s<i;s++){var a=r-s;t[a].type===st&&(t[a]=new F(Rt,t[a].value))}this.parseVariableAssignmentExpression(n),t.push(new F(ke,n)),t.push(new F(cs,e.value));continue}if(e.type!==st&&e.type!==Ft)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(n),t.push(new F(Rt,e.value)),t.push(new F(ke,n)),t.push(ut("="))}};J.prototype.parseConditionalExpression=function(t){for(this.parseOrExpression(t);this.accept(H,"?");){var e=[],n=[];this.parseConditionalExpression(e),this.expect(H,":"),this.parseConditionalExpression(n),t.push(new F(ke,e)),t.push(new F(ke,n)),t.push(la("?"))}};J.prototype.parseOrExpression=function(t){for(this.parseAndExpression(t);this.accept(H,"or");){var e=[];this.parseAndExpression(e),t.push(new F(ke,e)),t.push(ut("or"))}};J.prototype.parseAndExpression=function(t){for(this.parseComparison(t);this.accept(H,"and");){var e=[];this.parseComparison(e),t.push(new F(ke,e)),t.push(ut("and"))}};var ad=["==","!=","<","<=",">=",">","in"];J.prototype.parseComparison=function(t){for(this.parseAddSub(t);this.accept(H,ad);){var e=this.current;this.parseAddSub(t),t.push(ut(e.value))}};var ld=["+","-","||"];J.prototype.parseAddSub=function(t){for(this.parseTerm(t);this.accept(H,ld);){var e=this.current;this.parseTerm(t),t.push(ut(e.value))}};var ud=["*","/","%"];J.prototype.parseTerm=function(t){for(this.parseFactor(t);this.accept(H,ud);){var e=this.current;this.parseFactor(t),t.push(ut(e.value))}};J.prototype.parseFactor=function(t){var e=this.tokens.unaryOps;function n(s){return s.value in e}if(this.save(),this.accept(H,n)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===it&&this.nextToken.value==="("){this.restore(),this.parseExponential(t);return}else if(this.nextToken.type===Ti||this.nextToken.type===hs||this.nextToken.type===Kn||this.nextToken.type===it&&this.nextToken.value===")"){this.restore(),this.parseAtom(t);return}}var r=this.current;this.parseFactor(t),t.push(ls(r.value))}else this.parseExponential(t)};J.prototype.parseExponential=function(t){for(this.parsePostfixExpression(t);this.accept(H,"^");)this.parseFactor(t),t.push(ut("^"))};J.prototype.parsePostfixExpression=function(t){for(this.parseFunctionCall(t);this.accept(H,"!");)t.push(ls("!"))};J.prototype.parseFunctionCall=function(t){var e=this.tokens.unaryOps;function n(i){return i.value in e}if(this.accept(H,n)){var r=this.current;this.parseAtom(t),t.push(ls(r.value))}else for(this.parseMemberExpression(t);this.accept(it,"(");)if(this.accept(it,")"))t.push(new F(fn,0));else{var s=this.parseArgumentList(t);t.push(new F(fn,s))}};J.prototype.parseArgumentList=function(t){for(var e=0;!this.accept(it,")");)for(this.parseExpression(t),++e;this.accept(hs);)this.parseExpression(t),++e;return e};J.prototype.parseMemberExpression=function(t){for(this.parseAtom(t);this.accept(H,".")||this.accept(pn,"[");){var e=this.current;if(e.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(Ci),t.push(new F(Ft,this.current.value))}else if(e.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(t),this.expect(pn,"]"),t.push(ut("["))}else throw new Error("unexpected symbol: "+e.value)}};function hd(t,e){return Number(t)+Number(e)}function fd(t,e){return t-e}function dd(t,e){return t*e}function pd(t,e){return t/e}function gd(t,e){return t%e}function wd(t,e){return Array.isArray(t)&&Array.isArray(e)?t.concat(e):""+t+e}function yd(t,e){return t===e}function md(t,e){return t!==e}function bd(t,e){return t>e}function Ed(t,e){return t<e}function kd(t,e){return t>=e}function Sd(t,e){return t<=e}function Ad(t,e){return!!(t&&e)}function xd(t,e){return!!(t||e)}function _d(t,e){return Yt(e,t)}function vd(t){return(Math.exp(t)-Math.exp(-t))/2}function Id(t){return(Math.exp(t)+Math.exp(-t))/2}function Cd(t){return t===1/0?1:t===-1/0?-1:(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t))}function Td(t){return t===-1/0?t:Math.log(t+Math.sqrt(t*t+1))}function Md(t){return Math.log(t+Math.sqrt(t*t-1))}function Dd(t){return Math.log((1+t)/(1-t))/2}function Eo(t){return Math.log(t)*Math.LOG10E}function Od(t){return-t}function Rd(t){return!t}function Ud(t){return t<0?Math.ceil(t):Math.floor(t)}function Bd(t){return Math.random()*(t||1)}function ko(t){return Mi(t+1)}function Ld(t){return isFinite(t)&&t===Math.round(t)}var Nd=4.7421875,Ds=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function Mi(t){var e,n;if(Ld(t)){if(t<=0)return isFinite(t)?1/0:NaN;if(t>171)return 1/0;for(var r=t-2,s=t-1;r>1;)s*=r,r--;return s===0&&(s=1),s}if(t<.5)return Math.PI/(Math.sin(Math.PI*t)*Mi(1-t));if(t>=171.35)return 1/0;if(t>85){var i=t*t,a=i*t,h=a*t,f=h*t;return Math.sqrt(2*Math.PI/t)*Math.pow(t/Math.E,t)*(1+1/(12*t)+1/(288*i)-139/(51840*a)-571/(2488320*h)+163879/(209018880*f)+5246819/(75246796800*f*t))}--t,n=Ds[0];for(var g=1;g<Ds.length;++g)n+=Ds[g]/(t+g);return e=t+Nd+.5,Math.sqrt(2*Math.PI)*Math.pow(e,t+.5)*Math.exp(-e)*n}function Fd(t){return Array.isArray(t)?t.length:String(t).length}function So(){for(var t=0,e=0,n=0;n<arguments.length;n++){var r=Math.abs(arguments[n]),s;e<r?(s=e/r,t=t*s*s+1,e=r):r>0?(s=r/e,t+=s*s):t+=r}return e===1/0?1/0:e*Math.sqrt(t)}function Ao(t,e,n){return t?e:n}function $d(t,e){return typeof e>"u"||+e==0?Math.round(t):(t=+t,e=-+e,isNaN(t)||!(typeof e=="number"&&e%1===0)?NaN:(t=t.toString().split("e"),t=Math.round(+(t[0]+"e"+(t[1]?+t[1]-e:-e))),t=t.toString().split("e"),+(t[0]+"e"+(t[1]?+t[1]+e:e))))}function Pd(t,e,n){return n&&(n[t]=e),e}function Vd(t,e){return t[e|0]}function jd(t){return arguments.length===1&&Array.isArray(t)?Math.max.apply(Math,t):Math.max.apply(Math,arguments)}function qd(t){return arguments.length===1&&Array.isArray(t)?Math.min.apply(Math,t):Math.min.apply(Math,arguments)}function Hd(t,e){if(typeof t!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(e))throw new Error("Second argument to map is not an array");return e.map(function(n,r){return t(n,r)})}function Gd(t,e,n){if(typeof t!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(n))throw new Error("Second argument to fold is not an array");return n.reduce(function(r,s,i){return t(r,s,i)},e)}function Jd(t,e){if(typeof t!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(e))throw new Error("Second argument to filter is not an array");return e.filter(function(n,r){return t(n,r)})}function Wd(t,e){if(!(Array.isArray(e)||typeof e=="string"))throw new Error("Second argument to indexOf is not a string or array");return e.indexOf(t)}function zd(t,e){if(!Array.isArray(e))throw new Error("Second argument to join is not an array");return e.join(t)}function Yd(t){return(t>0)-(t<0)||+t}var xo=1/3;function Kd(t){return t<0?-Math.pow(-t,xo):Math.pow(t,xo)}function Xd(t){return Math.exp(t)-1}function Zd(t){return Math.log(1+t)}function Qd(t){return Math.log(t)/Math.LN2}function $t(t){this.options=t||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||vd,cosh:Math.cosh||Id,tanh:Math.tanh||Cd,asinh:Math.asinh||Td,acosh:Math.acosh||Md,atanh:Math.atanh||Dd,sqrt:Math.sqrt,cbrt:Math.cbrt||Kd,log:Math.log,log2:Math.log2||Qd,ln:Math.log,lg:Math.log10||Eo,log10:Math.log10||Eo,expm1:Math.expm1||Xd,log1p:Math.log1p||Zd,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||Ud,"-":Od,"+":Number,exp:Math.exp,not:Rd,length:Fd,"!":ko,sign:Math.sign||Yd},this.binaryOps={"+":hd,"-":fd,"*":dd,"/":pd,"%":gd,"^":Math.pow,"||":wd,"==":yd,"!=":md,">":bd,"<":Ed,">=":kd,"<=":Sd,and:Ad,or:xd,in:_d,"=":Pd,"[":Vd},this.ternaryOps={"?":Ao},this.functions={random:Bd,fac:ko,min:qd,max:jd,hypot:Math.hypot||So,pyt:Math.hypot||So,pow:Math.pow,atan2:Math.atan2,if:Ao,gamma:Mi,roundTo:$d,map:Hd,fold:Gd,filter:Jd,indexOf:Wd,join:zd},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}$t.prototype.parse=function(t){var e=[],n=new J(this,new Q(this,t),{allowMemberAccess:this.options.allowMemberAccess});return n.parseExpression(e),n.expect(Kn,"EOF"),new Ne(e,this)};$t.prototype.evaluate=function(t,e){return this.parse(t).evaluate(e)};var da=new $t;$t.parse=function(t){return da.parse(t)};$t.evaluate=function(t,e){return da.parse(t).evaluate(e)};var _o={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function ep(t){return _o.hasOwnProperty(t)?_o[t]:t}$t.prototype.isOperatorEnabled=function(t){var e=ep(t),n=this.options.operators||{};return!(e in n)||!!n[e]};const tp=new $t,np={name:"Alaric, o Errante",level:3,ancestry:"Humano",paths:{novice:"Mago",expert:"Alquimista",master:"-"},attributes:[{name:"Fora",value:10,key:"str"},{name:"Agilidade",value:12,key:"agi"},{name:"Intelecto",value:15,key:"int"},{name:"Vontade",value:11,key:"wil"}],currency:{gp:0,sp:0,cp:0},naturalDefense:10,bonusDamage:0,speed:10,currentRound:1,languages:["Comum","lfico"],senses:[],afflictions:[],effects:[],notes:"",campaignId:null,campaignName:null,gmName:null,combatActive:!1,initiative:!1,acted:!1,spells:[{id:1,name:"Seta de Energia",tier:"Novice",type:"Ataque",tradition:"Destruction",description:"Causa 1d6 de dano a um alvo em alcance curto.",castings:3,maxCastings:3,effect:null},{id:2,name:"Escudo Mgico",tier:"Novice",type:"Utilidade",tradition:"Protection",description:"+2 em Defesa por 1 minuto.",castings:2,maxCastings:2,effect:{id:999,name:"Escudo Mgico",duration:"MINUTES",roundsLeft:10,initialRounds:10,description:"+2 Defesa",isActive:!0,modifiers:[{target:"defense",type:Ct.ADD,value:2}]}}],talents:[{id:1,name:"Sentido Arcano",description:"Voc detecta magia a curto alcance.",uses:0,maxUses:0,isPassive:!0,effect:null},{id:2,name:"Sorte do Principiante",description:"Pode refazer um teste falho.",uses:1,maxUses:1,isPassive:!1,effect:null}],equipment:[{id:1,name:"Cajado",type:Te.WEAPON,quantity:1,price:5,availability:"Common",quality:"Standard",grip:id.TWO,range:"Melee",damageDice:1,boonsBanes:0,traits:"Finesse, Versatile",equippedState:null,equipped:!1},{id:2,name:"Poo de Cura",type:Te.CONSUMABLE,quantity:3,price:10,availability:"Common",quality:"Standard",notes:"Recupera Healing Rate",equippedState:null,equipped:!1},{id:3,name:"Granada Alqumica",type:Te.EXPLOSIVE,quantity:2,price:15,availability:"Uncommon",quality:"Standard",damageDice:2,range:"Short",traits:"Blast",description:"Explode em rea curta causando 2d6 de dano.",equippedState:null,equipped:!1},{id:4,name:"Couro Batido",type:Te.ARMOR,quantity:1,price:20,availability:"Common",quality:"Standard",defenseType:"fixed",defenseFixed:12,armorWeight:"Light",equipped:!1,equippedState:null}]},C=Re(np),Os=Re([]),Er=Re({type:null,isOpen:!1,data:null}),Mp=Re("acoes"),Di=Re(24),An=Re(24),Ut=Re(0),zs=Re(!1),pa=Re(!1),vo={autoOpenHistory:!1,stickyHistory:!1,theme:"dark"};function rp(){const t=typeof localStorage<"u"?localStorage.getItem("wwv_app_settings"):null,{subscribe:e,set:n,update:r}=Re(t?{...vo,...JSON.parse(t)}:vo);return{subscribe:e,set:s=>{typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(s)),n(s)},update:s=>{r(i=>{const a=s(i);return typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(a)),a})}}}const sp=rp();zs.subscribe(t=>{t&&pa.set(!1)});const ar=$e(C,t=>{const e=t.effects.filter(r=>r.isActive),n=t.talents.filter(r=>(r.isPassive||r.activityType==="Passive")&&r.effect).map(r=>({...r.effect,id:`talent-effect-${r.id}`,name:r.name,sourceType:"talent",sourceId:r.id}));return[...e,...n]});function rn(t,e){if(typeof t=="number")return t;if(!t)return 0;const n=String(t).trim();if(!isNaN(Number(n)))return Number(n);try{const r={};Array.isArray(e.attributes)&&e.attributes.forEach(i=>{r[i.key]=i.value}),r.level=e.level||0;const s=n.replace(/@(\w+)/g,"$1");return tp.evaluate(s,r)}catch{return 0}}function fs(t,e,n,r){let s=e||0;const i=n.flatMap(g=>Array.isArray(g.modifiers)?g.modifiers:[]),a=i.filter(g=>g.target===t&&g.type===Ct.SET);return a.length>0&&(s=rn(a[a.length-1].value,r)),i.filter(g=>g.target===t&&g.type===Ct.ADD).forEach(g=>{s+=rn(g.value,r)}),i.filter(g=>g.target===t&&g.type===Ct.MULT).forEach(g=>{s*=rn(g.value,r)}),Math.floor(s)}const ga=$e([C,ar],([t,e])=>{const n={};return Array.isArray(t.attributes)&&t.attributes.forEach(r=>{n[r.key]=fs(r.key,r.value,e,t)}),n}),ip=$e([C,An,ar],([t,e,n])=>fs("health",e,n,t)),Dp=$e([ip,Di],([t,e])=>Math.max(0,t-e)),Op=$e([Ut,An],([t,e])=>e>0?Math.min(100,t/e*100):100),op=$e([Ut,An],([t,e])=>t>=e),Rp=$e([Ut,An,op],([t,e,n])=>t>=e/2&&!n),Up=$e([C,ga,ar],([t,e,n])=>{let r=fs("speed",t.speed,n,t);const s=t.afflictions;return s.includes("Held")||s.includes("Stunned")||s.includes("Unconscious")||s.includes("Incapacitated")?0:((s.includes("Blinded")||s.includes("Weakened"))&&(r=Math.floor(r/2)),s.includes("Slowed")&&(r=Math.min(r,2)),Math.max(0,r))}),Bp=$e([C,ar],([t,e])=>{let n=t.naturalDefense,r=0;const s=t.equipment.find(i=>i.type===Te.ARMOR&&i.equipped);if(s){const i=s.defenseFixed||0,a=t.naturalDefense+(s.defenseMod||0);s.defenseFixed&&s.defenseMod?n=Math.max(i,a):s.defenseFixed?n=i:s.defenseMod&&(n=t.naturalDefense+s.defenseMod)}return t.equipment.filter(i=>i.type===Te.SHIELD&&i.equippedState).forEach(i=>{r+=i.defenseMod||0}),fs("defense",n+r,e,t)});$e([C,ar],([t,e])=>{const r=e.flatMap(s=>Array.isArray(s.modifiers)?s.modifiers:[]).filter(s=>s.target==="damage"&&s.type===Ct.ADD).reduce((s,i)=>s+rn(i.value,t),0);return(t.bonusDamage||0)+r});const Be={updateCurrency:(t,e)=>{C.update(n=>{let r=n.currency.gp*100+n.currency.sp*10+n.currency.cp,s=0;return t==="gp"&&(s=e*100),t==="sp"&&(s=e*10),t==="cp"&&(s=e),r+=s,r<0&&(r=0),{...n,currency:{gp:Math.floor(r/100),sp:Math.floor(r%100/10),cp:r%100%10}}})},advanceRound:t=>{C.update(e=>{const n=e.currentRound||1;if(t==="next"){const r=(e.effects||[]).map(s=>{if(s.isActive&&s.duration==="ROUNDS"&&s.roundsLeft>0){const i=s.roundsLeft-1;return i<=0?{...s,roundsLeft:0,isActive:!1}:{...s,roundsLeft:i}}return s});return{...e,currentRound:n+1,effects:r}}else return{...e,currentRound:Math.max(1,n-1)}})},addToHistory:(t,e=!0)=>{const n=je(C),r=je(Os);if(t.id&&r.find(a=>a.id===t.id))return;const s={id:t.id||oo(),timestamp:t.timestamp||new Date,charName:n.name,...t};Os.update(a=>[s,...a]),je(sp).autoOpenHistory?zs.set(!0):je(zs)||pa.set(!0),e&&n.campaignId&&Ui(async()=>{const{syncRoll:a}=await Promise.resolve().then(()=>Mo);return{syncRoll:a}},void 0,import.meta.url).then(({syncRoll:a})=>{a(s)})},clearHistory:()=>Os.set([]),addItem:t=>C.update(e=>({...e,equipment:[...e.equipment,t]})),updateItem:t=>C.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?t:n)})),deleteItem:t=>C.update(e=>({...e,equipment:e.equipment.filter(n=>n.id!==t)})),useConsumable:t=>{t.quantity>0&&(Be.updateItem({...t,quantity:t.quantity-1}),Be.addToHistory({source:"Consumvel",name:t.name,description:`Usou ${t.name} `}))},equipItem:(t,e=null)=>{C.update(n=>{let r=[...n.equipment];return t.type===Te.ARMOR?r=r.map(s=>s.id===t.id?{...s,equipped:!s.equipped}:s.type===Te.ARMOR&&t.type===Te.ARMOR&&!t.equipped?{...s,equipped:!1}:s):(t.type===Te.WEAPON||t.type===Te.SHIELD)&&(r=r.map(s=>s.id===t.id?{...s,equippedState:e}:s)),{...n,equipment:r}})},toggleAffliction:t=>{C.update(e=>e.afflictions.includes(t)?{...e,afflictions:e.afflictions.filter(n=>n!==t)}:{...e,afflictions:[...e.afflictions,t]})},addLanguage:t=>C.update(e=>({...e,languages:[...e.languages,t]})),removeLanguage:t=>C.update(e=>({...e,languages:e.languages.filter((n,r)=>r!==t)})),addSense:t=>C.update(e=>({...e,senses:[...e.senses||[],t]})),removeSense:t=>C.update(e=>({...e,senses:(e.senses||[]).filter((n,r)=>r!==t)})),confirmRest:()=>{C.update(e=>{const n=e.spells.map(s=>({...s,castings:s.maxCastings})),r=e.talents.map(s=>({...s,uses:s.maxUses}));return{...e,spells:n,talents:r}}),Ut.set(0);const t=je(Di);An.set(t),Er.set({type:null,isOpen:!1,data:null})},finalizeRoll:(t,e,n=[])=>{const r=je(C),s=je(ga),i=t.type==="weapon_attack",a=t.type==="luck",h=t.type==="weapon_damage",f=t.source,g=f.name||"Ao",u=(w,p)=>w.traits&&w.traits.toLowerCase().includes(p.toLowerCase());if(h){let w=parseInt(f.damageDice)||0;const p=f.grip&&f.grip.toLowerCase()==="two"||f.equippedState&&f.equippedState.toLowerCase()==="two";u(f,"Versatile")&&p&&(w+=1);let m=r.bonusDamage||0;u(f,"Light")&&m>1&&(m-=1);const k=n.flatMap(v=>Array.isArray(v.modifiers)?v.modifiers:[]).filter(v=>v.target==="damage"&&v.type===Ct.ADD).reduce((v,$)=>v+rn($.value,r),0),A=m+k,T=Math.max(0,w+A+e);let oe=[],Y=0,I=[];for(let v=0;v<T;v++){let $=Math.floor(Math.random()*6)+1;if($===1&&u(f,"Brutal")){const pe=Math.floor(Math.random()*6)+1;I.push(`1->${pe}`),$=pe}else I.push(`${$}`);oe.push($),Y+=$}Ut.set(Y),Be.addToHistory({source:"Dano",name:f.name,description:`Dano: ${T}d6 ${u(f,"Brutal")?"(Brutal)":""}`,formula:`${T}d6 [${oe.join(", ")}] ${I.some(v=>v.includes("->"))?`(Rolagens: ${I.join(", ")})`:""}`,total:Y,effectsApplied:n.map(v=>v.name)}),f.type===Te.EXPLOSIVE&&Be.useConsumable(f)}else{const w=Math.floor(Math.random()*20)+1;let p=0,m="Sorte";if(t.type==="attribute")p=(s[t.source.key]||t.source.value)-10,m=t.source.name;else if(i){let I="str",v="Fora";f.range==="Ranged"&&(I="agi",v="Agilidade",u(f,"Thrown")&&(I="str",v="Fora")),u(f,"Nimble")&&(I="agi",v="Agilidade"),p=(s[I]||10)-10,m=v}const k=n.flatMap(I=>Array.isArray(I.modifiers)?I.modifiers:[]).filter(I=>I.target==="boons"&&I.type===Ct.ADD).reduce((I,v)=>I+rn(v.value,r),0);e+=k;let A=0,T="";if(e!==0){const I=Math.abs(e);let v=[];for(let pe=0;pe<I;pe++)v.push(Math.floor(Math.random()*6)+1);const $=Math.max(...v);e>0?(A=$,T=` + ${$} [Boon]`):(A=-$,T=` - ${$} [Bane]`)}const oe=w+p+A;let Y=i?`Ataque (${m})`:a?"Teste de Sorte":`Teste de ${g}`;if(e!==0&&(Y+=` com ${e} boons/banes`),i&&w===20){let I=[];u(f,"Bludgeoning")&&I.push("Vuln"),u(f,"Piercing")&&I.push("Weakened"),u(f,"Slashing")&&I.push("+1d6 Dmg"),I.length>0&&(Y+=`
CRTICO! ${I.join(" ")} `)}Be.addToHistory({source:i?"Ataque":a?"Sorte":"Atributo",name:g,description:Y,formula:`d20(${w})${p!==0?(p>=0?"+":"")+p:""}${T} `,total:oe,crit:w===20,effectsApplied:n.map(I=>I.name)}),C.update(I=>({...I,effects:I.effects.map(v=>v.isActive&&v.duration==="NEXT_ROLL"?{...v,isActive:!1}:v)})),i&&u(f,"Reload")&&C.update(I=>({...I,equipment:I.equipment.map(v=>v.id===f.id?{...v,isLoaded:!1}:v)}))}Er.set({type:null,isOpen:!1,data:null})},reloadWeapon:t=>{C.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?{...n,isLoaded:!0}:n)})),Be.addToHistory({source:"Ao",name:"Recarregar",description:`Recarregou ${t.name}`})},addSpell:t=>C.update(e=>({...e,spells:[...e.spells,t]})),updateSpell:t=>C.update(e=>({...e,spells:e.spells.map(n=>n.id===t.id?t:n)})),deleteSpell:t=>C.update(e=>({...e,spells:e.spells.filter(n=>n.id!==t)})),commitSpellCast:t=>{t.castings>0&&(C.update(e=>({...e,spells:e.spells.map(n=>n.id===t.id?{...n,castings:n.castings-1}:n)})),Be.addToHistory({source:"Magia",name:t.name,description:t.description}),Er.set({type:null,isOpen:!1,data:null}))},addTalent:t=>C.update(e=>({...e,talents:[...e.talents,t]})),updateTalent:t=>C.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?t:n)})),deleteTalent:t=>C.update(e=>({...e,talents:e.talents.filter(n=>n.id!==t)})),commitTalentUse:t=>{t.activityType==="Duration"&&t.duration==="LUCK_ENDS"?C.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?{...n,uses:0}:n)})):t.maxUses&&C.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?{...n,uses:n.uses-1}:n)})),Be.addToHistory({source:"Talento",name:t.name,description:t.description}),Er.set({type:null,isOpen:!1,data:null})},recoverTalent:t=>{C.update(e=>({...e,talents:e.talents.map(n=>n.id===t&&n.uses<n.maxUses?{...n,uses:n.uses+1}:n)}))},rollLuckTalent:t=>{const e=Math.floor(Math.random()*20)+1,n=e>=10,s=je(C).talents.find(i=>i.id===t);Be.addToHistory({source:"Sorte",name:`Teste de Sorte - ${s?.name||"Talento"}`,formula:`d20(${e})`,total:e,description:`Rolou ${e}. ${n?"Sucesso! Talento recuperado.":"Falha. O talento continua indisponvel."}`}),n&&C.update(i=>({...i,talents:i.talents.map(a=>a.id===t?{...a,uses:1}:a)}))},addEffect:t=>C.update(e=>({...e,effects:[...e.effects,t]})),updateEffect:t=>C.update(e=>({...e,effects:e.effects.map(n=>n.id===t.id?t:n)})),deleteEffect:t=>C.update(e=>({...e,effects:e.effects.filter(n=>n.id!==t)})),toggleEffect:t=>C.update(e=>({...e,effects:e.effects.map(n=>{if(n.id===t){const r=!n.isActive;return{...n,isActive:r,roundsLeft:r&&n.duration==="ROUNDS"&&n.initialRounds||n.roundsLeft}}return n})})),cleanInactiveEffects:()=>C.update(t=>({...t,effects:t.effects.filter(e=>e.isActive)})),applyEffectToCharacter:(t,e)=>{const n=t.name||(e?e.name:"Efeito sem nome"),r=t.description||(e?e.description:""),s={...t,id:oo(),isActive:!0,name:n,description:r};s.duration==="ROUNDS"&&!s.initialRounds&&(s.initialRounds=s.roundsLeft),C.update(i=>({...i,effects:[...i.effects,s]}))},checkLuckEnds:t=>{const e=Math.floor(Math.random()*20)+1,n=e>=10;Be.addToHistory({source:"Sorte",name:"Check Fim Efeito",description:`Rolou ${e}. ${n?"Sucesso (Encerra)":"Falha"} `}),n&&C.update(r=>({...r,effects:r.effects.map(s=>s.id===t?{...s,isActive:!1}:s)}))},joinCampaign:t=>{C.update(e=>({...e,campaignId:t.id,campaignName:t.name,gmName:t.gmName||"Mestre"})),Ui(async()=>{const{joinCampaignRoom:e}=await Promise.resolve().then(()=>Mo);return{joinCampaignRoom:e}},void 0,import.meta.url).then(({joinCampaignRoom:e})=>{e(t.id,!1)})},leaveCampaign:()=>{C.update(t=>({...t,campaignId:null,campaignName:null,gmName:null,combatActive:!1}))}};Ut.subscribe(t=>{});const wa={appId:Qc,trackerUrls:["wss://tracker.openwebtorrent.com","wss://tracker.files.fm:7073/announce","wss://tracker.webtorrent.dev","wss://toad.vibe.community:443/announce","wss://tracker.btorrent.xyz"]},Ge=Re({roomId:null,peers:[],currentCharacterId:null,lastGmUpdate:0,isGM:!1,isConnected:!1}),cp=$e(Ge,t=>t.lastGmUpdate?Date.now()-t.lastGmUpdate<6e4:!1);let le=null,dt=null,Xn=null,Zn=null,Qn=null,er=null,vt=null,ze=null,Io=0,Co=0;const ap=2e3,lp={appId:"weird-wizard-vault-lobby"},Ys=Re([]);function tr(t,e){if(!t)return!0;try{return t.leave(),!0}catch(n){return console.warn(`Failed to leave ${e}:`,n),!1}}function ya(t){return Date.now()-t>=ap}function Ks(){if(!ya(Io))return console.warn("Lobby join rate limited. Skipping duplicate join attempt."),null;Io=Date.now(),vt&&(clearInterval(vt),vt=null),tr(dt,"existing lobby"),dt=null;try{dt=aa(lp,"public-discovery");const[t,e]=dt.makeAction("discovery");return e(n=>{Ys.update(r=>{const s=r.findIndex(i=>i.id===n.id);if(s!==-1){const i=[...r];return i[s]={...n,lastSeen:Date.now()},i}return[...r,{...n,lastSeen:Date.now()}]})}),vt=setInterval(()=>{const n=Date.now();Ys.update(r=>r.filter(s=>n-s.lastSeen<12e4))},6e4),t}catch(t){return console.error("Failed to join lobby:",t),dt=null,null}}let Gr;function up(){typeof window<"u"&&(sessionStorage.getItem("lobby-initialized")?dt||(Gr=Ks()):(sessionStorage.setItem("lobby-initialized","true"),Gr=Ks()))}typeof window<"u"&&(up(),window.addEventListener("beforeunload",()=>{To()}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&To()}));function To(){vt&&(clearInterval(vt),vt=null),ze&&(clearInterval(ze),ze=null),tr(dt,"lobby"),tr(le,"room"),dt=null,le=null}let zt=null;function hp(t,e=!1,n=null){const r=`campaign-${t}`;if(zt===r&&le)return Ge.update(s=>({...s,isGM:e,currentCharacterId:n})),le;if(!ya(Co))return console.warn("Campaign join rate limited. Skipping duplicate join attempt."),le;Co=Date.now(),ze&&(clearInterval(ze),ze=null),tr(le,"existing campaign room"),le=null,zt=null,Xn=null,Zn=null,Qn=null,er=null;try{zt=r,le=aa(wa,zt),Ge.set({isConnected:!0,isGM:e,currentCharacterId:n,peers:[],roomId:t,lastGmUpdate:0});const[s,i]=le.makeAction("combat"),[a,h]=le.makeAction("history"),[f,g]=le.makeAction("charUpdate"),[u,w]=le.makeAction("campaign");return Xn=s,Zn=a,Qn=f,er=u,i(p=>{e||C.update(m=>({...m,currentRound:p.round,combatActive:p.active}))}),w(p=>{Ge.update(m=>({...m,lastGmUpdate:Date.now()})),e||C.update(m=>({...m,campaignName:p.name,gmName:p.gmName,passwordHash:p.passwordHash}))}),e&&Gr&&(ze=setInterval(()=>{const p=Mn.get(t);p&&p.isPublished&&Gr({id:t,name:p.name,gmName:p.gmName||"Mestre",description:p.description})},3e4)),h(p=>{Be.addToHistory(p,!1)}),g(p=>{if(e){const m=Mn.get(t);if(m){const k=m.members||[],A=k.findIndex(v=>v.id===p.id);let T;if(A!==-1){T=[...k];const v=T[A],$={...p};v.campaignApproval==="approved"&&p.campaignApproval==="pending"&&delete $.campaignApproval,T[A]={...v,...$,lastUpdate:Date.now()}}else T=[...k,{...p,lastUpdate:Date.now()}];const oe=m.activeEnemies||[],Y=oe.findIndex(v=>v.id===p.id&&v.type==="player");let I=oe;Y!==-1&&(I=[...oe],I[Y]={...I[Y],...p}),Mn.set(t,{...m,members:T,activeEnemies:I})}}else{const m=je(Ge),k=je(C),A=m.currentCharacterId||k?.id;if(A&&A===p.id){if(p.campaignApproval==="rejected"||p.campaignId===null){C.update(T=>({...T,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}));return}C.update(T=>({...T,name:p.name||T.name,afflictions:p.afflictions||T.afflictions,senses:p.senses||T.senses,initiative:p.initiative!==void 0?p.initiative:T.initiative??!1,acted:p.acted!==void 0?p.acted:T.acted??!1,campaignApproval:p.campaignApproval||T.campaignApproval,imageUrl:p.imageUrl||T.imageUrl,notes:p.notes!==void 0?p.notes:T.notes})),p.damage!==void 0&&Ut.set(p.damage),p.currentHealth!==void 0&&An.set(p.currentHealth),p.normalHealth!==void 0&&Di.set(p.normalHealth)}}}),le.onPeerJoin(p=>{if(Ge.update(m=>({...m,peers:[...m.peers,p]})),e){const m=Mn.get(t);m&&(m.combat&&s(m.combat),u({name:m.name,gmName:m.gmName||"Mestre",passwordHash:m.passwordHash}))}}),le.onPeerLeave(p=>{Ge.update(m=>({...m,peers:m.peers.filter(k=>k!==p)}))}),le}catch(s){return console.error("Failed to join campaign room:",s),le=null,zt=null,Ge.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0}),null}}function fp(t,e){Xn&&Xn(e)}function dp(t,e){er&&er({name:e.name,gmName:e.gmName||"Mestre",passwordHash:e.passwordHash})}function pp(t){Zn&&Zn(t)}function gp(t){Qn&&Qn(t)}function wp(){ze&&(clearInterval(ze),ze=null),tr(le,"campaign room"),le=null,zt=null,Xn=null,Zn=null,Qn=null,er=null,Ge.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0})}const Mo=Object.freeze(Object.defineProperty({__proto__:null,isGmOnline:cp,joinCampaignRoom:hp,joinLobby:Ks,leaveCampaignRoom:wp,publicCampaigns:Ys,roomConfig:wa,syncCampaign:dp,syncCharacter:gp,syncCombat:fp,syncRoll:pp,syncState:Ge},Symbol.toStringTag,{value:"Module"}));export{Ip as A,op as B,Rp as C,Ut as D,ip as E,Op as F,Dp as G,Er as H,id as I,Te as J,_p as K,vp as L,xp as M,Ct as N,Di as O,An as P,ar as Q,ga as R,Bp as S,Tp as T,Up as U,Mp as V,Cp as W,np as X,Ap as Y,hp as a,kp as b,C as c,mf as d,Mn as e,bf as f,Ef as g,Sf as h,cp as i,aa as j,kf as k,sp as l,gp as m,dp as n,wp as o,Ys as p,zs as q,wa as r,Wt as s,fp as t,oo as u,Ge as v,Af as w,pa as x,Be as y,Os as z};
