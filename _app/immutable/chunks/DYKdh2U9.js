import{bh as Ml,as as Dl,I as Rl,G as Ol,h as Ul,aS as Mn,bk as Bl}from"./CeF9Pysg.js";import{w as Me,q as ue,g as j}from"./s5ZUjNrT.js";import{_ as Ps}from"./BuEkqW-1.js";import{k as Hi,$ as rt}from"./CzlvztmG.js";function Mp(t,e,n=e){var r=new WeakSet;Ml(t,"input",async s=>{var i=s?t.defaultValue:t.value;if(i=_s(t)?xs(i):i,n(i),Mn!==null&&r.add(Mn),await Dl(),i!==(i=e())){var l=t.selectionStart,h=t.selectionEnd,f=t.value.length;if(t.value=i??"",h!==null){var g=t.value.length;l===h&&h===f&&g>f?(t.selectionStart=g,t.selectionEnd=g):(t.selectionStart=l,t.selectionEnd=Math.min(h,g))}}}),(Ul&&t.defaultValue!==t.value||Rl(e)==null&&t.value)&&(n(_s(t)?xs(t.value):t.value),Mn!==null&&r.add(Mn)),Ol(()=>{var s=e();if(t===document.activeElement){var i=Bl??Mn;if(r.has(i))return}_s(t)&&s===xs(t.value)||t.type==="date"&&!s&&!t.value||s!==t.value&&(t.value=s??"")})}function _s(t){var e=t.type;return e==="number"||e==="range"}function xs(t){return t===""?null:+t}function Ll(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var No={exports:{}},se=No.exports={},qe,Ge;function Vs(){throw new Error("setTimeout has not been defined")}function js(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?qe=setTimeout:qe=Vs}catch{qe=Vs}try{typeof clearTimeout=="function"?Ge=clearTimeout:Ge=js}catch{Ge=js}})();function Fo(t){if(qe===setTimeout)return setTimeout(t,0);if((qe===Vs||!qe)&&setTimeout)return qe=setTimeout,setTimeout(t,0);try{return qe(t,0)}catch{try{return qe.call(null,t,0)}catch{return qe.call(this,t,0)}}}function Nl(t){if(Ge===clearTimeout)return clearTimeout(t);if((Ge===js||!Ge)&&clearTimeout)return Ge=clearTimeout,clearTimeout(t);try{return Ge(t)}catch{try{return Ge.call(null,t)}catch{return Ge.call(this,t)}}}var st=[],Qt=!1,It,Ir=-1;function Fl(){!Qt||!It||(Qt=!1,It.length?st=It.concat(st):Ir=-1,st.length&&$o())}function $o(){if(!Qt){var t=Fo(Fl);Qt=!0;for(var e=st.length;e;){for(It=st,st=[];++Ir<e;)It&&It[Ir].run();Ir=-1,e=st.length}It=null,Qt=!1,Nl(t)}}se.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];st.push(new Po(t,e)),st.length===1&&!Qt&&Fo($o)};function Po(t,e){this.fun=t,this.array=e}Po.prototype.run=function(){this.fun.apply(null,this.array)};se.title="browser";se.browser=!0;se.env={};se.argv=[];se.version="";se.versions={};function lt(){}se.on=lt;se.addListener=lt;se.once=lt;se.off=lt;se.removeListener=lt;se.removeAllListeners=lt;se.emit=lt;se.prependListener=lt;se.prependOnceListener=lt;se.listeners=function(t){return[]};se.binding=function(t){throw new Error("process.binding is not supported")};se.cwd=function(){return"/"};se.chdir=function(t){throw new Error("process.chdir is not supported")};se.umask=function(){return 0};var $l=No.exports;const St=Ll($l);var Pl={},Qr={};Qr.byteLength=Hl;Qr.toByteArray=Gl;Qr.fromByteArray=Yl;var ze=[],Re=[],Vl=typeof Uint8Array<"u"?Uint8Array:Array,Ss="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var qt=0,jl=Ss.length;qt<jl;++qt)ze[qt]=Ss[qt],Re[Ss.charCodeAt(qt)]=qt;Re[45]=62;Re[95]=63;function Vo(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=t.indexOf("=");n===-1&&(n=e);var r=n===e?0:4-n%4;return[n,r]}function Hl(t){var e=Vo(t),n=e[0],r=e[1];return(n+r)*3/4-r}function ql(t,e,n){return(e+n)*3/4-n}function Gl(t){var e,n=Vo(t),r=n[0],s=n[1],i=new Vl(ql(t,r,s)),l=0,h=s>0?r-4:r,f;for(f=0;f<h;f+=4)e=Re[t.charCodeAt(f)]<<18|Re[t.charCodeAt(f+1)]<<12|Re[t.charCodeAt(f+2)]<<6|Re[t.charCodeAt(f+3)],i[l++]=e>>16&255,i[l++]=e>>8&255,i[l++]=e&255;return s===2&&(e=Re[t.charCodeAt(f)]<<2|Re[t.charCodeAt(f+1)]>>4,i[l++]=e&255),s===1&&(e=Re[t.charCodeAt(f)]<<10|Re[t.charCodeAt(f+1)]<<4|Re[t.charCodeAt(f+2)]>>2,i[l++]=e>>8&255,i[l++]=e&255),i}function Jl(t){return ze[t>>18&63]+ze[t>>12&63]+ze[t>>6&63]+ze[t&63]}function zl(t,e,n){for(var r,s=[],i=e;i<n;i+=3)r=(t[i]<<16&16711680)+(t[i+1]<<8&65280)+(t[i+2]&255),s.push(Jl(r));return s.join("")}function Yl(t){for(var e,n=t.length,r=n%3,s=[],i=16383,l=0,h=n-r;l<h;l+=i)s.push(zl(t,l,l+i>h?h:l+i));return r===1?(e=t[n-1],s.push(ze[e>>2]+ze[e<<4&63]+"==")):r===2&&(e=(t[n-2]<<8)+t[n-1],s.push(ze[e>>10]+ze[e>>4&63]+ze[e<<2&63]+"=")),s.join("")}var ii={};ii.read=function(t,e,n,r,s){var i,l,h=s*8-r-1,f=(1<<h)-1,g=f>>1,c=-7,m=n?s-1:0,d=n?-1:1,w=t[e+m];for(m+=d,i=w&(1<<-c)-1,w>>=-c,c+=h;c>0;i=i*256+t[e+m],m+=d,c-=8);for(l=i&(1<<-c)-1,i>>=-c,c+=r;c>0;l=l*256+t[e+m],m+=d,c-=8);if(i===0)i=1-g;else{if(i===f)return l?NaN:(w?-1:1)*(1/0);l=l+Math.pow(2,r),i=i-g}return(w?-1:1)*l*Math.pow(2,i-r)};ii.write=function(t,e,n,r,s,i){var l,h,f,g=i*8-s-1,c=(1<<g)-1,m=c>>1,d=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,w=r?0:i-1,E=r?1:-1,x=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(h=isNaN(e)?1:0,l=c):(l=Math.floor(Math.log(e)/Math.LN2),e*(f=Math.pow(2,-l))<1&&(l--,f*=2),l+m>=1?e+=d/f:e+=d*Math.pow(2,1-m),e*f>=2&&(l++,f/=2),l+m>=c?(h=0,l=c):l+m>=1?(h=(e*f-1)*Math.pow(2,s),l=l+m):(h=e*Math.pow(2,m-1)*Math.pow(2,s),l=0));s>=8;t[n+w]=h&255,w+=E,h/=256,s-=8);for(l=l<<s|h,g+=s;g>0;t[n+w]=l&255,w+=E,l/=256,g-=8);t[n+w-E]|=x*128};(function(t){const e=Qr,n=ii,r=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=c,t.SlowBuffer=I,t.INSPECT_MAX_BYTES=50;const s=2147483647;t.kMaxLength=s;const{Uint8Array:i,ArrayBuffer:l,SharedArrayBuffer:h}=globalThis;c.TYPED_ARRAY_SUPPORT=f(),!c.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function f(){try{const u=new i(1),o={foo:function(){return 42}};return Object.setPrototypeOf(o,i.prototype),Object.setPrototypeOf(u,o),u.foo()===42}catch{return!1}}Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}});function g(u){if(u>s)throw new RangeError('The value "'+u+'" is invalid for option "size"');const o=new i(u);return Object.setPrototypeOf(o,c.prototype),o}function c(u,o,a){if(typeof u=="number"){if(typeof o=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return E(u)}return m(u,o,a)}c.poolSize=8192;function m(u,o,a){if(typeof u=="string")return x(u,o);if(l.isView(u))return D(u);if(u==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof u);if(je(u,l)||u&&je(u.buffer,l)||typeof h<"u"&&(je(u,h)||u&&je(u.buffer,h)))return J(u,o,a);if(typeof u=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const p=u.valueOf&&u.valueOf();if(p!=null&&p!==u)return c.from(p,o,a);const y=V(u);if(y)return y;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof u[Symbol.toPrimitive]=="function")return c.from(u[Symbol.toPrimitive]("string"),o,a);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof u)}c.from=function(u,o,a){return m(u,o,a)},Object.setPrototypeOf(c.prototype,i.prototype),Object.setPrototypeOf(c,i);function d(u){if(typeof u!="number")throw new TypeError('"size" argument must be of type number');if(u<0)throw new RangeError('The value "'+u+'" is invalid for option "size"')}function w(u,o,a){return d(u),u<=0?g(u):o!==void 0?typeof a=="string"?g(u).fill(o,a):g(u).fill(o):g(u)}c.alloc=function(u,o,a){return w(u,o,a)};function E(u){return d(u),g(u<0?0:S(u)|0)}c.allocUnsafe=function(u){return E(u)},c.allocUnsafeSlow=function(u){return E(u)};function x(u,o){if((typeof o!="string"||o==="")&&(o="utf8"),!c.isEncoding(o))throw new TypeError("Unknown encoding: "+o);const a=Z(u,o)|0;let p=g(a);const y=p.write(u,o);return y!==a&&(p=p.slice(0,y)),p}function R(u){const o=u.length<0?0:S(u.length)|0,a=g(o);for(let p=0;p<o;p+=1)a[p]=u[p]&255;return a}function D(u){if(je(u,i)){const o=new i(u);return J(o.buffer,o.byteOffset,o.byteLength)}return R(u)}function J(u,o,a){if(o<0||u.byteLength<o)throw new RangeError('"offset" is outside of buffer bounds');if(u.byteLength<o+(a||0))throw new RangeError('"length" is outside of buffer bounds');let p;return o===void 0&&a===void 0?p=new i(u):a===void 0?p=new i(u,o):p=new i(u,o,a),Object.setPrototypeOf(p,c.prototype),p}function V(u){if(c.isBuffer(u)){const o=S(u.length)|0,a=g(o);return a.length===0||u.copy(a,0,0,o),a}if(u.length!==void 0)return typeof u.length!="number"||ks(u.length)?g(0):R(u);if(u.type==="Buffer"&&Array.isArray(u.data))return R(u.data)}function S(u){if(u>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return u|0}function I(u){return+u!=u&&(u=0),c.alloc(+u)}c.isBuffer=function(o){return o!=null&&o._isBuffer===!0&&o!==c.prototype},c.compare=function(o,a){if(je(o,i)&&(o=c.from(o,o.offset,o.byteLength)),je(a,i)&&(a=c.from(a,a.offset,a.byteLength)),!c.isBuffer(o)||!c.isBuffer(a))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(o===a)return 0;let p=o.length,y=a.length;for(let b=0,k=Math.min(p,y);b<k;++b)if(o[b]!==a[b]){p=o[b],y=a[b];break}return p<y?-1:y<p?1:0},c.isEncoding=function(o){switch(String(o).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(o,a){if(!Array.isArray(o))throw new TypeError('"list" argument must be an Array of Buffers');if(o.length===0)return c.alloc(0);let p;if(a===void 0)for(a=0,p=0;p<o.length;++p)a+=o[p].length;const y=c.allocUnsafe(a);let b=0;for(p=0;p<o.length;++p){let k=o[p];if(je(k,i))b+k.length>y.length?(c.isBuffer(k)||(k=c.from(k)),k.copy(y,b)):i.prototype.set.call(y,k,b);else if(c.isBuffer(k))k.copy(y,b);else throw new TypeError('"list" argument must be an Array of Buffers');b+=k.length}return y};function Z(u,o){if(c.isBuffer(u))return u.length;if(l.isView(u)||je(u,l))return u.byteLength;if(typeof u!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof u);const a=u.length,p=arguments.length>2&&arguments[2]===!0;if(!p&&a===0)return 0;let y=!1;for(;;)switch(o){case"ascii":case"latin1":case"binary":return a;case"utf8":case"utf-8":return Es(u).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return a*2;case"hex":return a>>>1;case"base64":return ji(u).length;default:if(y)return p?-1:Es(u).length;o=(""+o).toLowerCase(),y=!0}}c.byteLength=Z;function _e(u,o,a){let p=!1;if((o===void 0||o<0)&&(o=0),o>this.length||((a===void 0||a>this.length)&&(a=this.length),a<=0)||(a>>>=0,o>>>=0,a<=o))return"";for(u||(u="utf8");;)switch(u){case"hex":return Ne(this,o,a);case"utf8":case"utf-8":return v(this,o,a);case"ascii":return ye(this,o,a);case"latin1":case"binary":return he(this,o,a);case"base64":return z(this,o,a);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return H(this,o,a);default:if(p)throw new TypeError("Unknown encoding: "+u);u=(u+"").toLowerCase(),p=!0}}c.prototype._isBuffer=!0;function xe(u,o,a){const p=u[o];u[o]=u[a],u[a]=p}c.prototype.swap16=function(){const o=this.length;if(o%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let a=0;a<o;a+=2)xe(this,a,a+1);return this},c.prototype.swap32=function(){const o=this.length;if(o%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let a=0;a<o;a+=4)xe(this,a,a+3),xe(this,a+1,a+2);return this},c.prototype.swap64=function(){const o=this.length;if(o%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let a=0;a<o;a+=8)xe(this,a,a+7),xe(this,a+1,a+6),xe(this,a+2,a+5),xe(this,a+3,a+4);return this},c.prototype.toString=function(){const o=this.length;return o===0?"":arguments.length===0?v(this,0,o):_e.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(o){if(!c.isBuffer(o))throw new TypeError("Argument must be a Buffer");return this===o?!0:c.compare(this,o)===0},c.prototype.inspect=function(){let o="";const a=t.INSPECT_MAX_BYTES;return o=this.toString("hex",0,a).replace(/(.{2})/g,"$1 ").trim(),this.length>a&&(o+=" ... "),"<Buffer "+o+">"},r&&(c.prototype[r]=c.prototype.inspect),c.prototype.compare=function(o,a,p,y,b){if(je(o,i)&&(o=c.from(o,o.offset,o.byteLength)),!c.isBuffer(o))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof o);if(a===void 0&&(a=0),p===void 0&&(p=o?o.length:0),y===void 0&&(y=0),b===void 0&&(b=this.length),a<0||p>o.length||y<0||b>this.length)throw new RangeError("out of range index");if(y>=b&&a>=p)return 0;if(y>=b)return-1;if(a>=p)return 1;if(a>>>=0,p>>>=0,y>>>=0,b>>>=0,this===o)return 0;let k=b-y,B=p-a;const te=Math.min(k,B),X=this.slice(y,b),ne=o.slice(a,p);for(let q=0;q<te;++q)if(X[q]!==ne[q]){k=X[q],B=ne[q];break}return k<B?-1:B<k?1:0};function Vt(u,o,a,p,y){if(u.length===0)return-1;if(typeof a=="string"?(p=a,a=0):a>2147483647?a=2147483647:a<-2147483648&&(a=-2147483648),a=+a,ks(a)&&(a=y?0:u.length-1),a<0&&(a=u.length+a),a>=u.length){if(y)return-1;a=u.length-1}else if(a<0)if(y)a=0;else return-1;if(typeof o=="string"&&(o=c.from(o,p)),c.isBuffer(o))return o.length===0?-1:_t(u,o,a,p,y);if(typeof o=="number")return o=o&255,typeof i.prototype.indexOf=="function"?y?i.prototype.indexOf.call(u,o,a):i.prototype.lastIndexOf.call(u,o,a):_t(u,[o],a,p,y);throw new TypeError("val must be string, number or Buffer")}function _t(u,o,a,p,y){let b=1,k=u.length,B=o.length;if(p!==void 0&&(p=String(p).toLowerCase(),p==="ucs2"||p==="ucs-2"||p==="utf16le"||p==="utf-16le")){if(u.length<2||o.length<2)return-1;b=2,k/=2,B/=2,a/=2}function te(ne,q){return b===1?ne[q]:ne.readUInt16BE(q*b)}let X;if(y){let ne=-1;for(X=a;X<k;X++)if(te(u,X)===te(o,ne===-1?0:X-ne)){if(ne===-1&&(ne=X),X-ne+1===B)return ne*b}else ne!==-1&&(X-=X-ne),ne=-1}else for(a+B>k&&(a=k-B),X=a;X>=0;X--){let ne=!0;for(let q=0;q<B;q++)if(te(u,X+q)!==te(o,q)){ne=!1;break}if(ne)return X}return-1}c.prototype.includes=function(o,a,p){return this.indexOf(o,a,p)!==-1},c.prototype.indexOf=function(o,a,p){return Vt(this,o,a,p,!0)},c.prototype.lastIndexOf=function(o,a,p){return Vt(this,o,a,p,!1)};function jt(u,o,a,p){a=Number(a)||0;const y=u.length-a;p?(p=Number(p),p>y&&(p=y)):p=y;const b=o.length;p>b/2&&(p=b/2);let k;for(k=0;k<p;++k){const B=parseInt(o.substr(k*2,2),16);if(ks(B))return k;u[a+k]=B}return k}function _(u,o,a,p){return yr(Es(o,u.length-a),u,a,p)}function A(u,o,a,p){return yr(vl(o),u,a,p)}function O(u,o,a,p){return yr(ji(o),u,a,p)}function N(u,o,a,p){return yr(Il(o,u.length-a),u,a,p)}c.prototype.write=function(o,a,p,y){if(a===void 0)y="utf8",p=this.length,a=0;else if(p===void 0&&typeof a=="string")y=a,p=this.length,a=0;else if(isFinite(a))a=a>>>0,isFinite(p)?(p=p>>>0,y===void 0&&(y="utf8")):(y=p,p=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const b=this.length-a;if((p===void 0||p>b)&&(p=b),o.length>0&&(p<0||a<0)||a>this.length)throw new RangeError("Attempt to write outside buffer bounds");y||(y="utf8");let k=!1;for(;;)switch(y){case"hex":return jt(this,o,a,p);case"utf8":case"utf-8":return _(this,o,a,p);case"ascii":case"latin1":case"binary":return A(this,o,a,p);case"base64":return O(this,o,a,p);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return N(this,o,a,p);default:if(k)throw new TypeError("Unknown encoding: "+y);y=(""+y).toLowerCase(),k=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function z(u,o,a){return o===0&&a===u.length?e.fromByteArray(u):e.fromByteArray(u.slice(o,a))}function v(u,o,a){a=Math.min(u.length,a);const p=[];let y=o;for(;y<a;){const b=u[y];let k=null,B=b>239?4:b>223?3:b>191?2:1;if(y+B<=a){let te,X,ne,q;switch(B){case 1:b<128&&(k=b);break;case 2:te=u[y+1],(te&192)===128&&(q=(b&31)<<6|te&63,q>127&&(k=q));break;case 3:te=u[y+1],X=u[y+2],(te&192)===128&&(X&192)===128&&(q=(b&15)<<12|(te&63)<<6|X&63,q>2047&&(q<55296||q>57343)&&(k=q));break;case 4:te=u[y+1],X=u[y+2],ne=u[y+3],(te&192)===128&&(X&192)===128&&(ne&192)===128&&(q=(b&15)<<18|(te&63)<<12|(X&63)<<6|ne&63,q>65535&&q<1114112&&(k=q))}}k===null?(k=65533,B=1):k>65535&&(k-=65536,p.push(k>>>10&1023|55296),k=56320|k&1023),p.push(k),y+=B}return Q(p)}const T=4096;function Q(u){const o=u.length;if(o<=T)return String.fromCharCode.apply(String,u);let a="",p=0;for(;p<o;)a+=String.fromCharCode.apply(String,u.slice(p,p+=T));return a}function ye(u,o,a){let p="";a=Math.min(u.length,a);for(let y=o;y<a;++y)p+=String.fromCharCode(u[y]&127);return p}function he(u,o,a){let p="";a=Math.min(u.length,a);for(let y=o;y<a;++y)p+=String.fromCharCode(u[y]);return p}function Ne(u,o,a){const p=u.length;(!o||o<0)&&(o=0),(!a||a<0||a>p)&&(a=p);let y="";for(let b=o;b<a;++b)y+=Cl[u[b]];return y}function H(u,o,a){const p=u.slice(o,a);let y="";for(let b=0;b<p.length-1;b+=2)y+=String.fromCharCode(p[b]+p[b+1]*256);return y}c.prototype.slice=function(o,a){const p=this.length;o=~~o,a=a===void 0?p:~~a,o<0?(o+=p,o<0&&(o=0)):o>p&&(o=p),a<0?(a+=p,a<0&&(a=0)):a>p&&(a=p),a<o&&(a=o);const y=this.subarray(o,a);return Object.setPrototypeOf(y,c.prototype),y};function F(u,o,a){if(u%1!==0||u<0)throw new RangeError("offset is not uint");if(u+o>a)throw new RangeError("Trying to access beyond buffer length")}c.prototype.readUintLE=c.prototype.readUIntLE=function(o,a,p){o=o>>>0,a=a>>>0,p||F(o,a,this.length);let y=this[o],b=1,k=0;for(;++k<a&&(b*=256);)y+=this[o+k]*b;return y},c.prototype.readUintBE=c.prototype.readUIntBE=function(o,a,p){o=o>>>0,a=a>>>0,p||F(o,a,this.length);let y=this[o+--a],b=1;for(;a>0&&(b*=256);)y+=this[o+--a]*b;return y},c.prototype.readUint8=c.prototype.readUInt8=function(o,a){return o=o>>>0,a||F(o,1,this.length),this[o]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(o,a){return o=o>>>0,a||F(o,2,this.length),this[o]|this[o+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(o,a){return o=o>>>0,a||F(o,2,this.length),this[o]<<8|this[o+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(o,a){return o=o>>>0,a||F(o,4,this.length),(this[o]|this[o+1]<<8|this[o+2]<<16)+this[o+3]*16777216},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(o,a){return o=o>>>0,a||F(o,4,this.length),this[o]*16777216+(this[o+1]<<16|this[o+2]<<8|this[o+3])},c.prototype.readBigUInt64LE=dt(function(o){o=o>>>0,Ht(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&Tn(o,this.length-8);const y=a+this[++o]*2**8+this[++o]*2**16+this[++o]*2**24,b=this[++o]+this[++o]*2**8+this[++o]*2**16+p*2**24;return BigInt(y)+(BigInt(b)<<BigInt(32))}),c.prototype.readBigUInt64BE=dt(function(o){o=o>>>0,Ht(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&Tn(o,this.length-8);const y=a*2**24+this[++o]*2**16+this[++o]*2**8+this[++o],b=this[++o]*2**24+this[++o]*2**16+this[++o]*2**8+p;return(BigInt(y)<<BigInt(32))+BigInt(b)}),c.prototype.readIntLE=function(o,a,p){o=o>>>0,a=a>>>0,p||F(o,a,this.length);let y=this[o],b=1,k=0;for(;++k<a&&(b*=256);)y+=this[o+k]*b;return b*=128,y>=b&&(y-=Math.pow(2,8*a)),y},c.prototype.readIntBE=function(o,a,p){o=o>>>0,a=a>>>0,p||F(o,a,this.length);let y=a,b=1,k=this[o+--y];for(;y>0&&(b*=256);)k+=this[o+--y]*b;return b*=128,k>=b&&(k-=Math.pow(2,8*a)),k},c.prototype.readInt8=function(o,a){return o=o>>>0,a||F(o,1,this.length),this[o]&128?(255-this[o]+1)*-1:this[o]},c.prototype.readInt16LE=function(o,a){o=o>>>0,a||F(o,2,this.length);const p=this[o]|this[o+1]<<8;return p&32768?p|4294901760:p},c.prototype.readInt16BE=function(o,a){o=o>>>0,a||F(o,2,this.length);const p=this[o+1]|this[o]<<8;return p&32768?p|4294901760:p},c.prototype.readInt32LE=function(o,a){return o=o>>>0,a||F(o,4,this.length),this[o]|this[o+1]<<8|this[o+2]<<16|this[o+3]<<24},c.prototype.readInt32BE=function(o,a){return o=o>>>0,a||F(o,4,this.length),this[o]<<24|this[o+1]<<16|this[o+2]<<8|this[o+3]},c.prototype.readBigInt64LE=dt(function(o){o=o>>>0,Ht(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&Tn(o,this.length-8);const y=this[o+4]+this[o+5]*2**8+this[o+6]*2**16+(p<<24);return(BigInt(y)<<BigInt(32))+BigInt(a+this[++o]*2**8+this[++o]*2**16+this[++o]*2**24)}),c.prototype.readBigInt64BE=dt(function(o){o=o>>>0,Ht(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&Tn(o,this.length-8);const y=(a<<24)+this[++o]*2**16+this[++o]*2**8+this[++o];return(BigInt(y)<<BigInt(32))+BigInt(this[++o]*2**24+this[++o]*2**16+this[++o]*2**8+p)}),c.prototype.readFloatLE=function(o,a){return o=o>>>0,a||F(o,4,this.length),n.read(this,o,!0,23,4)},c.prototype.readFloatBE=function(o,a){return o=o>>>0,a||F(o,4,this.length),n.read(this,o,!1,23,4)},c.prototype.readDoubleLE=function(o,a){return o=o>>>0,a||F(o,8,this.length),n.read(this,o,!0,52,8)},c.prototype.readDoubleBE=function(o,a){return o=o>>>0,a||F(o,8,this.length),n.read(this,o,!1,52,8)};function W(u,o,a,p,y,b){if(!c.isBuffer(u))throw new TypeError('"buffer" argument must be a Buffer instance');if(o>y||o<b)throw new RangeError('"value" argument is out of bounds');if(a+p>u.length)throw new RangeError("Index out of range")}c.prototype.writeUintLE=c.prototype.writeUIntLE=function(o,a,p,y){if(o=+o,a=a>>>0,p=p>>>0,!y){const B=Math.pow(2,8*p)-1;W(this,o,a,p,B,0)}let b=1,k=0;for(this[a]=o&255;++k<p&&(b*=256);)this[a+k]=o/b&255;return a+p},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(o,a,p,y){if(o=+o,a=a>>>0,p=p>>>0,!y){const B=Math.pow(2,8*p)-1;W(this,o,a,p,B,0)}let b=p-1,k=1;for(this[a+b]=o&255;--b>=0&&(k*=256);)this[a+b]=o/k&255;return a+p},c.prototype.writeUint8=c.prototype.writeUInt8=function(o,a,p){return o=+o,a=a>>>0,p||W(this,o,a,1,255,0),this[a]=o&255,a+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(o,a,p){return o=+o,a=a>>>0,p||W(this,o,a,2,65535,0),this[a]=o&255,this[a+1]=o>>>8,a+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(o,a,p){return o=+o,a=a>>>0,p||W(this,o,a,2,65535,0),this[a]=o>>>8,this[a+1]=o&255,a+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(o,a,p){return o=+o,a=a>>>0,p||W(this,o,a,4,4294967295,0),this[a+3]=o>>>24,this[a+2]=o>>>16,this[a+1]=o>>>8,this[a]=o&255,a+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(o,a,p){return o=+o,a=a>>>0,p||W(this,o,a,4,4294967295,0),this[a]=o>>>24,this[a+1]=o>>>16,this[a+2]=o>>>8,this[a+3]=o&255,a+4};function ee(u,o,a,p,y){Vi(o,p,y,u,a,7);let b=Number(o&BigInt(4294967295));u[a++]=b,b=b>>8,u[a++]=b,b=b>>8,u[a++]=b,b=b>>8,u[a++]=b;let k=Number(o>>BigInt(32)&BigInt(4294967295));return u[a++]=k,k=k>>8,u[a++]=k,k=k>>8,u[a++]=k,k=k>>8,u[a++]=k,a}function oe(u,o,a,p,y){Vi(o,p,y,u,a,7);let b=Number(o&BigInt(4294967295));u[a+7]=b,b=b>>8,u[a+6]=b,b=b>>8,u[a+5]=b,b=b>>8,u[a+4]=b;let k=Number(o>>BigInt(32)&BigInt(4294967295));return u[a+3]=k,k=k>>8,u[a+2]=k,k=k>>8,u[a+1]=k,k=k>>8,u[a]=k,a+8}c.prototype.writeBigUInt64LE=dt(function(o,a=0){return ee(this,o,a,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeBigUInt64BE=dt(function(o,a=0){return oe(this,o,a,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeIntLE=function(o,a,p,y){if(o=+o,a=a>>>0,!y){const te=Math.pow(2,8*p-1);W(this,o,a,p,te-1,-te)}let b=0,k=1,B=0;for(this[a]=o&255;++b<p&&(k*=256);)o<0&&B===0&&this[a+b-1]!==0&&(B=1),this[a+b]=(o/k>>0)-B&255;return a+p},c.prototype.writeIntBE=function(o,a,p,y){if(o=+o,a=a>>>0,!y){const te=Math.pow(2,8*p-1);W(this,o,a,p,te-1,-te)}let b=p-1,k=1,B=0;for(this[a+b]=o&255;--b>=0&&(k*=256);)o<0&&B===0&&this[a+b+1]!==0&&(B=1),this[a+b]=(o/k>>0)-B&255;return a+p},c.prototype.writeInt8=function(o,a,p){return o=+o,a=a>>>0,p||W(this,o,a,1,127,-128),o<0&&(o=255+o+1),this[a]=o&255,a+1},c.prototype.writeInt16LE=function(o,a,p){return o=+o,a=a>>>0,p||W(this,o,a,2,32767,-32768),this[a]=o&255,this[a+1]=o>>>8,a+2},c.prototype.writeInt16BE=function(o,a,p){return o=+o,a=a>>>0,p||W(this,o,a,2,32767,-32768),this[a]=o>>>8,this[a+1]=o&255,a+2},c.prototype.writeInt32LE=function(o,a,p){return o=+o,a=a>>>0,p||W(this,o,a,4,2147483647,-2147483648),this[a]=o&255,this[a+1]=o>>>8,this[a+2]=o>>>16,this[a+3]=o>>>24,a+4},c.prototype.writeInt32BE=function(o,a,p){return o=+o,a=a>>>0,p||W(this,o,a,4,2147483647,-2147483648),o<0&&(o=4294967295+o+1),this[a]=o>>>24,this[a+1]=o>>>16,this[a+2]=o>>>8,this[a+3]=o&255,a+4},c.prototype.writeBigInt64LE=dt(function(o,a=0){return ee(this,o,a,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),c.prototype.writeBigInt64BE=dt(function(o,a=0){return oe(this,o,a,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function ae(u,o,a,p,y,b){if(a+p>u.length)throw new RangeError("Index out of range");if(a<0)throw new RangeError("Index out of range")}function fe(u,o,a,p,y){return o=+o,a=a>>>0,y||ae(u,o,a,4),n.write(u,o,a,p,23,4),a+4}c.prototype.writeFloatLE=function(o,a,p){return fe(this,o,a,!0,p)},c.prototype.writeFloatBE=function(o,a,p){return fe(this,o,a,!1,p)};function De(u,o,a,p,y){return o=+o,a=a>>>0,y||ae(u,o,a,8),n.write(u,o,a,p,52,8),a+8}c.prototype.writeDoubleLE=function(o,a,p){return De(this,o,a,!0,p)},c.prototype.writeDoubleBE=function(o,a,p){return De(this,o,a,!1,p)},c.prototype.copy=function(o,a,p,y){if(!c.isBuffer(o))throw new TypeError("argument should be a Buffer");if(p||(p=0),!y&&y!==0&&(y=this.length),a>=o.length&&(a=o.length),a||(a=0),y>0&&y<p&&(y=p),y===p||o.length===0||this.length===0)return 0;if(a<0)throw new RangeError("targetStart out of bounds");if(p<0||p>=this.length)throw new RangeError("Index out of range");if(y<0)throw new RangeError("sourceEnd out of bounds");y>this.length&&(y=this.length),o.length-a<y-p&&(y=o.length-a+p);const b=y-p;return this===o&&typeof i.prototype.copyWithin=="function"?this.copyWithin(a,p,y):i.prototype.set.call(o,this.subarray(p,y),a),b},c.prototype.fill=function(o,a,p,y){if(typeof o=="string"){if(typeof a=="string"?(y=a,a=0,p=this.length):typeof p=="string"&&(y=p,p=this.length),y!==void 0&&typeof y!="string")throw new TypeError("encoding must be a string");if(typeof y=="string"&&!c.isEncoding(y))throw new TypeError("Unknown encoding: "+y);if(o.length===1){const k=o.charCodeAt(0);(y==="utf8"&&k<128||y==="latin1")&&(o=k)}}else typeof o=="number"?o=o&255:typeof o=="boolean"&&(o=Number(o));if(a<0||this.length<a||this.length<p)throw new RangeError("Out of range index");if(p<=a)return this;a=a>>>0,p=p===void 0?this.length:p>>>0,o||(o=0);let b;if(typeof o=="number")for(b=a;b<p;++b)this[b]=o;else{const k=c.isBuffer(o)?o:c.from(o,y),B=k.length;if(B===0)throw new TypeError('The value "'+o+'" is invalid for argument "value"');for(b=0;b<p-a;++b)this[b+a]=k[b%B]}return this};const be={};function ve(u,o,a){be[u]=class extends a{constructor(){super(),Object.defineProperty(this,"message",{value:o.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${u}]`,this.stack,delete this.name}get code(){return u}set code(y){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:y,writable:!0})}toString(){return`${this.name} [${u}]: ${this.message}`}}}ve("ERR_BUFFER_OUT_OF_BOUNDS",function(u){return u?`${u} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),ve("ERR_INVALID_ARG_TYPE",function(u,o){return`The "${u}" argument must be of type number. Received type ${typeof o}`},TypeError),ve("ERR_OUT_OF_RANGE",function(u,o,a){let p=`The value of "${u}" is out of range.`,y=a;return Number.isInteger(a)&&Math.abs(a)>2**32?y=mr(String(a)):typeof a=="bigint"&&(y=String(a),(a>BigInt(2)**BigInt(32)||a<-(BigInt(2)**BigInt(32)))&&(y=mr(y)),y+="n"),p+=` It must be ${o}. Received ${y}`,p},RangeError);function mr(u){let o="",a=u.length;const p=u[0]==="-"?1:0;for(;a>=p+4;a-=3)o=`_${u.slice(a-3,a)}${o}`;return`${u.slice(0,a)}${o}`}function wr(u,o,a){Ht(o,"offset"),(u[o]===void 0||u[o+a]===void 0)&&Tn(o,u.length-(a+1))}function Vi(u,o,a,p,y,b){if(u>a||u<o){const k=typeof o=="bigint"?"n":"";let B;throw o===0||o===BigInt(0)?B=`>= 0${k} and < 2${k} ** ${(b+1)*8}${k}`:B=`>= -(2${k} ** ${(b+1)*8-1}${k}) and < 2 ** ${(b+1)*8-1}${k}`,new be.ERR_OUT_OF_RANGE("value",B,u)}wr(p,y,b)}function Ht(u,o){if(typeof u!="number")throw new be.ERR_INVALID_ARG_TYPE(o,"number",u)}function Tn(u,o,a){throw Math.floor(u)!==u?(Ht(u,a),new be.ERR_OUT_OF_RANGE("offset","an integer",u)):o<0?new be.ERR_BUFFER_OUT_OF_BOUNDS:new be.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${o}`,u)}const Sl=/[^+/0-9A-Za-z-_]/g;function Al(u){if(u=u.split("=")[0],u=u.trim().replace(Sl,""),u.length<2)return"";for(;u.length%4!==0;)u=u+"=";return u}function Es(u,o){o=o||1/0;let a;const p=u.length;let y=null;const b=[];for(let k=0;k<p;++k){if(a=u.charCodeAt(k),a>55295&&a<57344){if(!y){if(a>56319){(o-=3)>-1&&b.push(239,191,189);continue}else if(k+1===p){(o-=3)>-1&&b.push(239,191,189);continue}y=a;continue}if(a<56320){(o-=3)>-1&&b.push(239,191,189),y=a;continue}a=(y-55296<<10|a-56320)+65536}else y&&(o-=3)>-1&&b.push(239,191,189);if(y=null,a<128){if((o-=1)<0)break;b.push(a)}else if(a<2048){if((o-=2)<0)break;b.push(a>>6|192,a&63|128)}else if(a<65536){if((o-=3)<0)break;b.push(a>>12|224,a>>6&63|128,a&63|128)}else if(a<1114112){if((o-=4)<0)break;b.push(a>>18|240,a>>12&63|128,a>>6&63|128,a&63|128)}else throw new Error("Invalid code point")}return b}function vl(u){const o=[];for(let a=0;a<u.length;++a)o.push(u.charCodeAt(a)&255);return o}function Il(u,o){let a,p,y;const b=[];for(let k=0;k<u.length&&!((o-=2)<0);++k)a=u.charCodeAt(k),p=a>>8,y=a%256,b.push(y),b.push(p);return b}function ji(u){return e.toByteArray(Al(u))}function yr(u,o,a,p){let y;for(y=0;y<p&&!(y+a>=o.length||y>=u.length);++y)o[y+a]=u[y];return y}function je(u,o){return u instanceof o||u!=null&&u.constructor!=null&&u.constructor.name!=null&&u.constructor.name===o.name}function ks(u){return u!==u}const Cl=(function(){const u="0123456789abcdef",o=new Array(256);for(let a=0;a<16;++a){const p=a*16;for(let y=0;y<16;++y)o[p+y]=u[a]+u[y]}return o})();function dt(u){return typeof BigInt>"u"?Tl:u}function Tl(){throw new Error("BigInt not supported")}})(Pl);const Se=()=>new Map,Hs=t=>{const e=Se();return t.forEach((n,r)=>{e.set(r,n)}),e},ct=(t,e,n)=>{let r=t.get(e);return r===void 0&&t.set(e,r=n()),r},Wl=(t,e)=>{const n=[];for(const[r,s]of t)n.push(e(s,r));return n},Kl=(t,e)=>{for(const[n,r]of t)if(e(r,n))return!0;return!1},Dt=()=>new Set,As=t=>t[t.length-1],Xl=(t,e)=>{for(let n=0;n<e.length;n++)t.push(e[n])},yt=Array.from,oi=(t,e)=>{for(let n=0;n<t.length;n++)if(!e(t[n],n,t))return!1;return!0},jo=(t,e)=>{for(let n=0;n<t.length;n++)if(e(t[n],n,t))return!0;return!1},Zl=(t,e)=>{const n=new Array(t);for(let r=0;r<t;r++)n[r]=e(r,n);return n},es=Array.isArray;class Ql{constructor(){this._observers=Se()}on(e,n){return ct(this._observers,e,Dt).add(n),n}once(e,n){const r=(...s)=>{this.off(e,r),n(...s)};this.on(e,r)}off(e,n){const r=this._observers.get(e);r!==void 0&&(r.delete(n),r.size===0&&this._observers.delete(e))}emit(e,n){return yt((this._observers.get(e)||Se()).values()).forEach(r=>r(...n))}destroy(){this._observers=Se()}}class ec{constructor(){this._observers=Se()}on(e,n){ct(this._observers,e,Dt).add(n)}once(e,n){const r=(...s)=>{this.off(e,r),n(...s)};this.on(e,r)}off(e,n){const r=this._observers.get(e);r!==void 0&&(r.delete(n),r.size===0&&this._observers.delete(e))}emit(e,n){return yt((this._observers.get(e)||Se()).values()).forEach(r=>r(...n))}destroy(){this._observers=Se()}}const Ke=Math.floor,Cr=Math.abs,Ho=(t,e)=>t<e?t:e,Lt=(t,e)=>t>e?t:e,qo=t=>t!==0?t<0:1/t<0,qi=1,Gi=2,vs=4,Is=8,jn=32,it=64,Te=128,ts=31,qs=63,Mt=127,tc=2147483647,$r=Number.MAX_SAFE_INTEGER,Ji=Number.MIN_SAFE_INTEGER,nc=Number.isInteger||(t=>typeof t=="number"&&isFinite(t)&&Ke(t)===t),rc=String.fromCharCode,sc=t=>t.toLowerCase(),ic=/^\s*/g,oc=t=>t.replace(ic,""),ac=/([A-Z])/g,zi=(t,e)=>oc(t.replace(ac,n=>`${e}${sc(n)}`)),lc=t=>{const e=unescape(encodeURIComponent(t)),n=e.length,r=new Uint8Array(n);for(let s=0;s<n;s++)r[s]=e.codePointAt(s);return r},Hn=typeof TextEncoder<"u"?new TextEncoder:null,cc=t=>Hn.encode(t),uc=Hn?cc:lc;let $n=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});$n&&$n.decode(new Uint8Array).length===1&&($n=null);const hc=(t,e)=>Zl(e,()=>t).join("");class cr{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const ns=()=>new cr,fc=t=>{let e=t.cpos;for(let n=0;n<t.bufs.length;n++)e+=t.bufs[n].length;return e},Ye=t=>{const e=new Uint8Array(fc(t));let n=0;for(let r=0;r<t.bufs.length;r++){const s=t.bufs[r];e.set(s,n),n+=s.length}return e.set(new Uint8Array(t.cbuf.buffer,0,t.cpos),n),e},dc=(t,e)=>{const n=t.cbuf.length;n-t.cpos<e&&(t.bufs.push(new Uint8Array(t.cbuf.buffer,0,t.cpos)),t.cbuf=new Uint8Array(Lt(n,e)*2),t.cpos=0)},pe=(t,e)=>{const n=t.cbuf.length;t.cpos===n&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(n*2),t.cpos=0),t.cbuf[t.cpos++]=e},Gs=pe,$=(t,e)=>{for(;e>Mt;)pe(t,Te|Mt&e),e=Ke(e/128);pe(t,Mt&e)},ai=(t,e)=>{const n=qo(e);for(n&&(e=-e),pe(t,(e>qs?Te:0)|(n?it:0)|qs&e),e=Ke(e/64);e>0;)pe(t,(e>Mt?Te:0)|Mt&e),e=Ke(e/128)},Js=new Uint8Array(3e4),pc=Js.length/3,gc=(t,e)=>{if(e.length<pc){const n=Hn.encodeInto(e,Js).written||0;$(t,n);for(let r=0;r<n;r++)pe(t,Js[r])}else Ie(t,uc(e))},mc=(t,e)=>{const n=unescape(encodeURIComponent(e)),r=n.length;$(t,r);for(let s=0;s<r;s++)pe(t,n.codePointAt(s))},en=Hn&&Hn.encodeInto?gc:mc,rs=(t,e)=>{const n=t.cbuf.length,r=t.cpos,s=Ho(n-r,e.length),i=e.length-s;t.cbuf.set(e.subarray(0,s),r),t.cpos+=s,i>0&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(Lt(n*2,i)),t.cbuf.set(e.subarray(s)),t.cpos=i)},Ie=(t,e)=>{$(t,e.byteLength),rs(t,e)},li=(t,e)=>{dc(t,e);const n=new DataView(t.cbuf.buffer,t.cpos,e);return t.cpos+=e,n},wc=(t,e)=>li(t,4).setFloat32(0,e,!1),yc=(t,e)=>li(t,8).setFloat64(0,e,!1),bc=(t,e)=>li(t,8).setBigInt64(0,e,!1),Yi=new DataView(new ArrayBuffer(4)),Ec=t=>(Yi.setFloat32(0,t),Yi.getFloat32(0)===t),qn=(t,e)=>{switch(typeof e){case"string":pe(t,119),en(t,e);break;case"number":nc(e)&&Cr(e)<=tc?(pe(t,125),ai(t,e)):Ec(e)?(pe(t,124),wc(t,e)):(pe(t,123),yc(t,e));break;case"bigint":pe(t,122),bc(t,e);break;case"object":if(e===null)pe(t,126);else if(es(e)){pe(t,117),$(t,e.length);for(let n=0;n<e.length;n++)qn(t,e[n])}else if(e instanceof Uint8Array)pe(t,116),Ie(t,e);else{pe(t,118);const n=Object.keys(e);$(t,n.length);for(let r=0;r<n.length;r++){const s=n[r];en(t,s),qn(t,e[s])}}break;case"boolean":pe(t,e?120:121);break;default:pe(t,127)}};class Wi extends cr{constructor(e){super(),this.w=e,this.s=null,this.count=0}write(e){this.s===e?this.count++:(this.count>0&&$(this,this.count-1),this.count=1,this.w(this,e),this.s=e)}}const Ki=t=>{t.count>0&&(ai(t.encoder,t.count===1?t.s:-t.s),t.count>1&&$(t.encoder,t.count-2))};class Tr{constructor(){this.encoder=new cr,this.s=0,this.count=0}write(e){this.s===e?this.count++:(Ki(this),this.count=1,this.s=e)}toUint8Array(){return Ki(this),Ye(this.encoder)}}const Xi=t=>{if(t.count>0){const e=t.diff*2+(t.count===1?0:1);ai(t.encoder,e),t.count>1&&$(t.encoder,t.count-2)}};class Cs{constructor(){this.encoder=new cr,this.s=0,this.count=0,this.diff=0}write(e){this.diff===e-this.s?(this.s=e,this.count++):(Xi(this),this.count=1,this.diff=e-this.s,this.s=e)}toUint8Array(){return Xi(this),Ye(this.encoder)}}class kc{constructor(){this.sarr=[],this.s="",this.lensE=new Tr}write(e){this.s+=e,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(e.length)}toUint8Array(){const e=new cr;return this.sarr.push(this.s),this.s="",en(e,this.sarr.join("")),rs(e,this.lensE.toUint8Array()),Ye(e)}}const Ve=t=>new Error(t),$e=()=>{throw Ve("Method unimplemented")},Le=()=>{throw Ve("Unexpected case")},Go=Ve("Unexpected end of array"),Jo=Ve("Integer out of Range");class ss{constructor(e){this.arr=e,this.pos=0}}const En=t=>new ss(t),_c=t=>t.pos!==t.arr.length,xc=(t,e)=>{const n=new Uint8Array(t.arr.buffer,t.pos+t.arr.byteOffset,e);return t.pos+=e,n},Ce=t=>xc(t,U(t)),cn=t=>t.arr[t.pos++],U=t=>{let e=0,n=1;const r=t.arr.length;for(;t.pos<r;){const s=t.arr[t.pos++];if(e=e+(s&Mt)*n,n*=128,s<Te)return e;if(e>$r)throw Jo}throw Go},ci=t=>{let e=t.arr[t.pos++],n=e&qs,r=64;const s=(e&it)>0?-1:1;if((e&Te)===0)return s*n;const i=t.arr.length;for(;t.pos<i;){if(e=t.arr[t.pos++],n=n+(e&Mt)*r,r*=128,e<Te)return s*n;if(n>$r)throw Jo}throw Go},Sc=t=>{let e=U(t);if(e===0)return"";{let n=String.fromCodePoint(cn(t));if(--e<100)for(;e--;)n+=String.fromCodePoint(cn(t));else for(;e>0;){const r=e<1e4?e:1e4,s=t.arr.subarray(t.pos,t.pos+r);t.pos+=r,n+=String.fromCodePoint.apply(null,s),e-=r}return decodeURIComponent(escape(n))}},Ac=t=>$n.decode(Ce(t)),tn=$n?Ac:Sc,ui=(t,e)=>{const n=new DataView(t.arr.buffer,t.arr.byteOffset+t.pos,e);return t.pos+=e,n},vc=t=>ui(t,4).getFloat32(0,!1),Ic=t=>ui(t,8).getFloat64(0,!1),Cc=t=>ui(t,8).getBigInt64(0,!1),Tc=[t=>{},t=>null,ci,vc,Ic,Cc,t=>!1,t=>!0,tn,t=>{const e=U(t),n={};for(let r=0;r<e;r++){const s=tn(t);n[s]=Gn(t)}return n},t=>{const e=U(t),n=[];for(let r=0;r<e;r++)n.push(Gn(t));return n},Ce],Gn=t=>Tc[127-cn(t)](t);class Zi extends ss{constructor(e,n){super(e),this.reader=n,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),_c(this)?this.count=U(this)+1:this.count=-1),this.count--,this.s}}class Mr extends ss{constructor(e){super(e),this.s=0,this.count=0}read(){if(this.count===0){this.s=ci(this);const e=qo(this.s);this.count=1,e&&(this.s=-this.s,this.count=U(this)+2)}return this.count--,this.s}}class Ts extends ss{constructor(e){super(e),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const e=ci(this),n=e&1;this.diff=Ke(e/2),this.count=1,n&&(this.count=U(this)+2)}return this.s+=this.diff,this.count--,this.s}}class Mc{constructor(e){this.decoder=new Mr(e),this.str=tn(this.decoder),this.spos=0}read(){const e=this.spos+this.decoder.read(),n=this.str.slice(this.spos,e);return this.spos=e,n}}const Dc=crypto.getRandomValues.bind(crypto),zo=()=>Dc(new Uint32Array(1))[0],Rc="10000000-1000-4000-8000"+-1e11,Oc=()=>Rc.replace(/[018]/g,t=>(t^zo()&15>>t/4).toString(16)),un=t=>new Promise(t);Promise.all.bind(Promise);const Qi=t=>t===void 0?null:t;class Uc{constructor(){this.map=new Map}setItem(e,n){this.map.set(e,n)}getItem(e){return this.map.get(e)}}let Yo=new Uc,Bc=!0;try{typeof localStorage<"u"&&localStorage&&(Yo=localStorage,Bc=!1)}catch{}const Lc=Yo,Jn=Symbol("Equality"),Wo=(t,e)=>t===e||!!t?.[Jn]?.(e)||!1,Nc=t=>typeof t=="object",Fc=Object.assign,$c=Object.keys,Pc=(t,e)=>{for(const n in t)e(t[n],n)},Pr=t=>$c(t).length,Vc=t=>{for(const e in t)return!1;return!0},ur=(t,e)=>{for(const n in t)if(!e(t[n],n))return!1;return!0},hi=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),jc=(t,e)=>t===e||Pr(t)===Pr(e)&&ur(t,(n,r)=>(n!==void 0||hi(e,r))&&Wo(e[r],n)),Hc=Object.freeze,Ko=t=>{for(const e in t){const n=t[e];(typeof n=="object"||typeof n=="function")&&Ko(t[e])}return Hc(t)},fi=(t,e,n=0)=>{try{for(;n<t.length;n++)t[n](...e)}finally{n<t.length&&fi(t,e,n+1)}},qc=t=>t,Dr=(t,e)=>{if(t===e)return!0;if(t==null||e==null||t.constructor!==e.constructor&&(t.constructor||Object)!==(e.constructor||Object))return!1;if(t[Jn]!=null)return t[Jn](e);switch(t.constructor){case ArrayBuffer:t=new Uint8Array(t),e=new Uint8Array(e);case Uint8Array:{if(t.byteLength!==e.byteLength)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;break}case Set:{if(t.size!==e.size)return!1;for(const n of t)if(!e.has(n))return!1;break}case Map:{if(t.size!==e.size)return!1;for(const n of t.keys())if(!e.has(n)||!Dr(t.get(n),e.get(n)))return!1;break}case void 0:case Object:if(Pr(t)!==Pr(e))return!1;for(const n in t)if(!hi(t,n)||!Dr(t[n],e[n]))return!1;break;case Array:if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(!Dr(t[n],e[n]))return!1;break;default:return!1}return!0},Gc=(t,e)=>e.includes(t);var Xo={};const zn=typeof St<"u"&&St.release&&/node|io\.js/.test(St.release.name)&&Object.prototype.toString.call(typeof St<"u"?St:0)==="[object process]";let He;const Jc=()=>{if(He===void 0)if(zn){He=Se();const t=St.argv;let e=null;for(let n=0;n<t.length;n++){const r=t[n];r[0]==="-"?(e!==null&&He.set(e,""),e=r):e!==null&&(He.set(e,r),e=null)}e!==null&&He.set(e,"")}else typeof location=="object"?(He=Se(),(location.search||"?").slice(1).split("&").forEach(t=>{if(t.length!==0){const[e,n]=t.split("=");He.set(`--${zi(e,"-")}`,n),He.set(`-${zi(e,"-")}`,n)}})):He=Se();return He},zs=t=>Jc().has(t),Vr=t=>Qi(zn?Xo[t.toUpperCase().replaceAll("-","_")]:Lc.getItem(t)),Zo=t=>zs("--"+t)||Vr(t)!==null,zc=Zo("production"),Yc=zn&&Gc(Xo.FORCE_COLOR,["true","1","2"]),Wc=Yc||!zs("--no-colors")&&!Zo("no-color")&&(!zn||St.stdout.isTTY)&&(!zn||zs("--color")||Vr("COLORTERM")!==null||(Vr("TERM")||"").includes("color")),Kc=t=>new Uint8Array(t),Xc=t=>{const e=Kc(t.byteLength);return e.set(t),e};class Zc{constructor(e,n){this.left=e,this.right=n}}const Qe=(t,e)=>new Zc(t,e),eo=t=>t.next()>=.5,Ms=(t,e,n)=>Ke(t.next()*(n+1-e)+e),Qo=(t,e,n)=>Ke(t.next()*(n+1-e)+e),di=(t,e,n)=>Qo(t,e,n),Qc=t=>rc(di(t,97,122)),eu=(t,e=0,n=20)=>{const r=di(t,e,n);let s="";for(let i=0;i<r;i++)s+=Qc(t);return s},Ds=(t,e)=>e[di(t,0,e.length-1)],tu=Symbol("0schema");class nu{constructor(){this._rerrs=[]}extend(e,n,r,s=null){this._rerrs.push({path:e,expected:n,has:r,message:s})}toString(){const e=[];for(let n=this._rerrs.length-1;n>0;n--){const r=this._rerrs[n];e.push(hc(" ",(this._rerrs.length-n)*2)+`${r.path!=null?`[${r.path}] `:""}${r.has} doesn't match ${r.expected}. ${r.message}`)}return e.join(`
`)}}const Ys=(t,e)=>t===e?!0:t==null||e==null||t.constructor!==e.constructor?!1:t[Jn]?Wo(t,e):es(t)?oi(t,n=>jo(e,r=>Ys(n,r))):Nc(t)?ur(t,(n,r)=>Ys(n,e[r])):!1;class ke{static _dilutes=!1;extends(e){let[n,r]=[this.shape,e.shape];return this.constructor._dilutes&&([r,n]=[n,r]),Ys(n,r)}equals(e){return this.constructor===e.constructor&&Dr(this.shape,e.shape)}[tu](){return!0}[Jn](e){return this.equals(e)}validate(e){return this.check(e)}check(e,n){$e()}get nullable(){return kn(this,cs)}get optional(){return new na(this)}cast(e){return to(e,this),e}expect(e){return to(e,this),e}}class pi extends ke{constructor(e,n){super(),this.shape=e,this._c=n}check(e,n=void 0){const r=e?.constructor===this.shape&&(this._c==null||this._c(e));return!r&&n?.extend(null,this.shape.name,e?.constructor.name,e?.constructor!==this.shape?"Constructor match failed":"Check failed"),r}}const ie=(t,e=null)=>new pi(t,e);ie(pi);class gi extends ke{constructor(e){super(),this.shape=e}check(e,n){const r=this.shape(e);return!r&&n?.extend(null,"custom prop",e?.constructor.name,"failed to check custom prop"),r}}const me=t=>new gi(t);ie(gi);class is extends ke{constructor(e){super(),this.shape=e}check(e,n){const r=this.shape.some(s=>s===e);return!r&&n?.extend(null,this.shape.join(" | "),e.toString()),r}}const os=(...t)=>new is(t),ea=ie(is),ru=RegExp.escape||(t=>t.replace(/[().|&,$^[\]]/g,e=>"\\"+e)),ta=t=>{if(hn.check(t))return[ru(t)];if(ea.check(t))return t.shape.map(e=>e+"");if(ha.check(t))return["[+-]?\\d+.?\\d*"];if(fa.check(t))return[".*"];if(jr.check(t))return t.shape.map(ta).flat(1);Le()};class su extends ke{constructor(e){super(),this.shape=e,this._r=new RegExp("^"+e.map(ta).map(n=>`(${n.join("|")})`).join("")+"$")}check(e,n){const r=this._r.exec(e)!=null;return!r&&n?.extend(null,this._r.toString(),e.toString(),"String doesn't match string template."),r}}ie(su);const iu=Symbol("optional");class na extends ke{constructor(e){super(),this.shape=e}check(e,n){const r=e===void 0||this.shape.check(e);return!r&&n?.extend(null,"undefined (optional)","()"),r}get[iu](){return!0}}const ou=ie(na);class au extends ke{check(e,n){return n?.extend(null,"never",typeof e),!1}}ie(au);class as extends ke{constructor(e,n=!1){super(),this.shape=e,this._isPartial=n}static _dilutes=!0;get partial(){return new as(this.shape,!0)}check(e,n){return e==null?(n?.extend(null,"object","null"),!1):ur(this.shape,(r,s)=>{const i=this._isPartial&&!hi(e,s)||r.check(e[s],n);return!i&&n?.extend(s.toString(),r.toString(),typeof e[s],"Object property does not match"),i})}}const lu=t=>new as(t),cu=ie(as),uu=me(t=>t!=null&&(t.constructor===Object||t.constructor==null));class ra extends ke{constructor(e,n){super(),this.shape={keys:e,values:n}}check(e,n){return e!=null&&ur(e,(r,s)=>{const i=this.shape.keys.check(s,n);return!i&&n?.extend(s+"","Record",typeof e,i?"Key doesn't match schema":"Value doesn't match value"),i&&this.shape.values.check(r,n)})}}const sa=(t,e)=>new ra(t,e),hu=ie(ra);class ia extends ke{constructor(e){super(),this.shape=e}check(e,n){return e!=null&&ur(this.shape,(r,s)=>{const i=r.check(e[s],n);return!i&&n?.extend(s.toString(),"Tuple",typeof r),i})}}const fu=(...t)=>new ia(t);ie(ia);class oa extends ke{constructor(e){super(),this.shape=e.length===1?e[0]:new mi(e)}check(e,n){const r=es(e)&&oi(e,s=>this.shape.check(s));return!r&&n?.extend(null,"Array",""),r}}const aa=(...t)=>new oa(t),du=ie(oa),pu=me(t=>es(t));class la extends ke{constructor(e,n){super(),this.shape=e,this._c=n}check(e,n){const r=e instanceof this.shape&&(this._c==null||this._c(e));return!r&&n?.extend(null,this.shape.name,e?.constructor.name),r}}const gu=(t,e=null)=>new la(t,e);ie(la);const mu=gu(ke);class wu extends ke{constructor(e){super(),this.len=e.length-1,this.args=fu(...e.slice(-1)),this.res=e[this.len]}check(e,n){const r=e.constructor===Function&&e.length<=this.len;return!r&&n?.extend(null,"function",typeof e),r}}const yu=ie(wu),bu=me(t=>typeof t=="function");class Eu extends ke{constructor(e){super(),this.shape=e}check(e,n){const r=oi(this.shape,s=>s.check(e,n));return!r&&n?.extend(null,"Intersectinon",typeof e),r}}ie(Eu,t=>t.shape.length>0);class mi extends ke{static _dilutes=!0;constructor(e){super(),this.shape=e}check(e,n){const r=jo(this.shape,s=>s.check(e,n));return n?.extend(null,"Union",typeof e),r}}const kn=(...t)=>t.findIndex(e=>jr.check(e))>=0?kn(...t.map(e=>Yn(e)).map(e=>jr.check(e)?e.shape:[e]).flat(1)):t.length===1?t[0]:new mi(t),jr=ie(mi),ca=()=>!0,Hr=me(ca),ku=ie(gi,t=>t.shape===ca),wi=me(t=>typeof t=="bigint"),_u=me(t=>t===wi),ua=me(t=>typeof t=="symbol");me(t=>t===ua);const nn=me(t=>typeof t=="number"),ha=me(t=>t===nn),hn=me(t=>typeof t=="string"),fa=me(t=>t===hn),ls=me(t=>typeof t=="boolean"),xu=me(t=>t===ls),da=os(void 0);ie(is,t=>t.shape.length===1&&t.shape[0]===void 0);os(void 0);const cs=os(null),Su=ie(is,t=>t.shape.length===1&&t.shape[0]===null);ie(Uint8Array);ie(pi,t=>t.shape===Uint8Array);const Au=kn(nn,hn,cs,da,wi,ls,ua);(()=>{const t=aa(Hr),e=sa(hn,Hr),n=kn(nn,hn,cs,ls,t,e);return t.shape=n,e.shape.values=n,n})();const Yn=t=>{if(mu.check(t))return t;if(uu.check(t)){const e={};for(const n in t)e[n]=Yn(t[n]);return lu(e)}else{if(pu.check(t))return kn(...t.map(Yn));if(Au.check(t))return os(t);if(bu.check(t))return ie(t)}Le()},to=zc?()=>{}:(t,e)=>{const n=new nu;if(!e.check(t,n))throw Ve(`Expected value to be of type ${e.constructor.name}.
${n.toString()}`)};class vu{constructor(e){this.patterns=[],this.$state=e}if(e,n){return this.patterns.push({if:Yn(e),h:n}),this}else(e){return this.if(Hr,e)}done(){return(e,n)=>{for(let r=0;r<this.patterns.length;r++){const s=this.patterns[r];if(s.if.check(e))return s.h(e,n)}throw Ve("Unhandled pattern")}}}const Iu=t=>new vu(t),pa=Iu(Hr).if(ha,(t,e)=>Ms(e,Ji,$r)).if(fa,(t,e)=>eu(e)).if(xu,(t,e)=>eo(e)).if(_u,(t,e)=>BigInt(Ms(e,Ji,$r))).if(jr,(t,e)=>Gt(e,Ds(e,t.shape))).if(cu,(t,e)=>{const n={};for(const r in t.shape){let s=t.shape[r];if(ou.check(s)){if(eo(e))continue;s=s.shape}n[r]=pa(s,e)}return n}).if(du,(t,e)=>{const n=[],r=Qo(e,0,42);for(let s=0;s<r;s++)n.push(Gt(e,t.shape));return n}).if(ea,(t,e)=>Ds(e,t.shape)).if(Su,(t,e)=>null).if(yu,(t,e)=>{const n=Gt(e,t.res);return()=>n}).if(ku,(t,e)=>Gt(e,Ds(e,[nn,hn,cs,da,wi,ls,aa(nn),sa(kn("a","b","c"),nn)]))).if(hu,(t,e)=>{const n={},r=Ms(e,0,3);for(let s=0;s<r;s++){const i=Gt(e,t.shape.keys),l=Gt(e,t.shape.values);n[i]=l}return n}).done(),Gt=(t,e)=>pa(Yn(e),t),us=typeof document<"u"?document:{};me(t=>t.nodeType===Ru);typeof DOMParser<"u"&&new DOMParser;me(t=>t.nodeType===Tu);me(t=>t.nodeType===Mu);const Cu=t=>Wl(t,(e,n)=>`${n}:${e};`).join(""),Tu=us.ELEMENT_NODE,Mu=us.TEXT_NODE,Du=us.DOCUMENT_NODE,Ru=us.DOCUMENT_FRAGMENT_NODE;me(t=>t.nodeType===Du);const ut=Symbol,ga=ut(),ma=ut(),Ou=ut(),Uu=ut(),Bu=ut(),wa=ut(),Lu=ut(),yi=ut(),Nu=ut(),Fu=t=>{t.length===1&&t[0]?.constructor===Function&&(t=t[0]());const e=[],n=[];let r=0;for(;r<t.length;r++){const s=t[r];if(s===void 0)break;if(s.constructor===String||s.constructor===Number)e.push(s);else if(s.constructor===Object)break}for(r>0&&n.push(e.join(""));r<t.length;r++){const s=t[r];s instanceof Symbol||n.push(s)}return n},$u={[ga]:Qe("font-weight","bold"),[ma]:Qe("font-weight","normal"),[Ou]:Qe("color","blue"),[Bu]:Qe("color","green"),[Uu]:Qe("color","grey"),[wa]:Qe("color","red"),[Lu]:Qe("color","purple"),[yi]:Qe("color","orange"),[Nu]:Qe("color","black")},Pu=t=>{t.length===1&&t[0]?.constructor===Function&&(t=t[0]());const e=[],n=[],r=Se();let s=[],i=0;for(;i<t.length;i++){const l=t[i],h=$u[l];if(h!==void 0)r.set(h.left,h.right);else{if(l===void 0)break;if(l.constructor===String||l.constructor===Number){const f=Cu(r);i>0||f.length>0?(e.push("%c"+l),n.push(f)):e.push(l)}else break}}for(i>0&&(s=n,s.unshift(e.join("")));i<t.length;i++){const l=t[i];l instanceof Symbol||s.push(l)}return s},ya=Wc?Pu:Fu,Vu=(...t)=>{console.log(...ya(t)),ba.forEach(e=>e.print(t))},ju=(...t)=>{console.warn(...ya(t)),t.unshift(yi),ba.forEach(e=>e.print(t))},ba=Dt(),Ea=t=>({[Symbol.iterator](){return this},next:t}),Hu=(t,e)=>Ea(()=>{let n;do n=t.next();while(!n.done&&!e(n.value));return n}),Rs=(t,e)=>Ea(()=>{const{done:n,value:r}=t.next();return{done:n,value:n?void 0:e(r)}});class bi{constructor(e,n){this.clock=e,this.len=n}}class hr{constructor(){this.clients=new Map}}const ka=(t,e,n)=>e.clients.forEach((r,s)=>{const i=t.doc.store.clients.get(s);if(i!=null){const l=i[i.length-1],h=l.id.clock+l.length;for(let f=0,g=r[f];f<r.length&&g.clock<h;g=r[++f])Ra(t,i,g.clock,g.len,n)}}),qu=(t,e)=>{let n=0,r=t.length-1;for(;n<=r;){const s=Ke((n+r)/2),i=t[s],l=i.clock;if(l<=e){if(e<l+i.len)return s;n=s+1}else r=s-1}return null},_a=(t,e)=>{const n=t.clients.get(e.client);return n!==void 0&&qu(n,e.clock)!==null},Ei=t=>{t.clients.forEach(e=>{e.sort((s,i)=>s.clock-i.clock);let n,r;for(n=1,r=1;n<e.length;n++){const s=e[r-1],i=e[n];s.clock+s.len>=i.clock?s.len=Lt(s.len,i.clock+i.len-s.clock):(r<n&&(e[r]=i),r++)}e.length=r})},Gu=t=>{const e=new hr;for(let n=0;n<t.length;n++)t[n].clients.forEach((r,s)=>{if(!e.clients.has(s)){const i=r.slice();for(let l=n+1;l<t.length;l++)Xl(i,t[l].clients.get(s)||[]);e.clients.set(s,i)}});return Ei(e),e},qr=(t,e,n,r)=>{ct(t.clients,e,()=>[]).push(new bi(n,r))},Ju=()=>new hr,zu=t=>{const e=Ju();return t.clients.forEach((n,r)=>{const s=[];for(let i=0;i<n.length;i++){const l=n[i];if(l.deleted){const h=l.id.clock;let f=l.length;if(i+1<n.length)for(let g=n[i+1];i+1<n.length&&g.deleted;g=n[++i+1])f+=g.length;s.push(new bi(h,f))}}s.length>0&&e.clients.set(r,s)}),e},_n=(t,e)=>{$(t.restEncoder,e.clients.size),yt(e.clients.entries()).sort((n,r)=>r[0]-n[0]).forEach(([n,r])=>{t.resetDsCurVal(),$(t.restEncoder,n);const s=r.length;$(t.restEncoder,s);for(let i=0;i<s;i++){const l=r[i];t.writeDsClock(l.clock),t.writeDsLen(l.len)}})},ki=t=>{const e=new hr,n=U(t.restDecoder);for(let r=0;r<n;r++){t.resetDsCurVal();const s=U(t.restDecoder),i=U(t.restDecoder);if(i>0){const l=ct(e.clients,s,()=>[]);for(let h=0;h<i;h++)l.push(new bi(t.readDsClock(),t.readDsLen()))}}return e},no=(t,e,n)=>{const r=new hr,s=U(t.restDecoder);for(let i=0;i<s;i++){t.resetDsCurVal();const l=U(t.restDecoder),h=U(t.restDecoder),f=n.clients.get(l)||[],g=ge(n,l);for(let c=0;c<h;c++){const m=t.readDsClock(),d=m+t.readDsLen();if(m<g){g<d&&qr(r,l,g,d-g);let w=Xe(f,m),E=f[w];for(!E.deleted&&E.id.clock<m&&(f.splice(w+1,0,Xr(e,E,m-E.id.clock)),w++);w<f.length&&(E=f[w++],E.id.clock<d);)E.deleted||(d<E.id.clock+E.length&&f.splice(w,0,Xr(e,E,d-E.id.clock)),E.delete(e))}else qr(r,l,m,d-m)}}if(r.clients.size>0){const i=new Rt;return $(i.restEncoder,0),_n(i,r),i.toUint8Array()}return null},xa=zo;class xn extends Ql{constructor({guid:e=Oc(),collectionid:n=null,gc:r=!0,gcFilter:s=()=>!0,meta:i=null,autoLoad:l=!1,shouldLoad:h=!0}={}){super(),this.gc=r,this.gcFilter=s,this.clientID=xa(),this.guid=e,this.collectionid=n,this.share=new Map,this.store=new Ma,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=h,this.autoLoad=l,this.meta=i,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=un(g=>{this.on("load",()=>{this.isLoaded=!0,g(this)})});const f=()=>un(g=>{const c=m=>{(m===void 0||m===!0)&&(this.off("sync",c),g())};this.on("sync",c)});this.on("sync",g=>{g===!1&&this.isSynced&&(this.whenSynced=f()),this.isSynced=g===void 0||g===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=f()}load(){const e=this._item;e!==null&&!this.shouldLoad&&G(e.parent.doc,n=>{n.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(yt(this.subdocs).map(e=>e.guid))}transact(e,n=null){return G(this,e,n)}get(e,n=we){const r=ct(this.share,e,()=>{const i=new n;return i._integrate(this,null),i}),s=r.constructor;if(n!==we&&s!==n)if(s===we){const i=new n;i._map=r._map,r._map.forEach(l=>{for(;l!==null;l=l.left)l.parent=i}),i._start=r._start;for(let l=i._start;l!==null;l=l.right)l.parent=i;return i._length=r._length,this.share.set(e,i),i._integrate(this,null),i}else throw new Error(`Type with the name ${e} has already been defined with a different constructor`);return r}getArray(e=""){return this.get(e,sn)}getText(e=""){return this.get(e,pn)}getMap(e=""){return this.get(e,dn)}getXmlElement(e=""){return this.get(e,gn)}getXmlFragment(e=""){return this.get(e,Ot)}toJSON(){const e={};return this.share.forEach((n,r)=>{e[r]=n.toJSON()}),e}destroy(){this.isDestroyed=!0,yt(this.subdocs).forEach(n=>n.destroy());const e=this._item;if(e!==null){this._item=null;const n=e.content;n.doc=new xn({guid:this.guid,...n.opts,shouldLoad:!1}),n.doc._item=e,G(e.parent.doc,r=>{const s=n.doc;e.deleted||r.subdocsAdded.add(s),r.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}}class Sa{constructor(e){this.restDecoder=e}resetDsCurVal(){}readDsClock(){return U(this.restDecoder)}readDsLen(){return U(this.restDecoder)}}class Aa extends Sa{readLeftID(){return L(U(this.restDecoder),U(this.restDecoder))}readRightID(){return L(U(this.restDecoder),U(this.restDecoder))}readClient(){return U(this.restDecoder)}readInfo(){return cn(this.restDecoder)}readString(){return tn(this.restDecoder)}readParentInfo(){return U(this.restDecoder)===1}readTypeRef(){return U(this.restDecoder)}readLen(){return U(this.restDecoder)}readAny(){return Gn(this.restDecoder)}readBuf(){return Xc(Ce(this.restDecoder))}readJSON(){return JSON.parse(tn(this.restDecoder))}readKey(){return tn(this.restDecoder)}}class Yu{constructor(e){this.dsCurrVal=0,this.restDecoder=e}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=U(this.restDecoder),this.dsCurrVal}readDsLen(){const e=U(this.restDecoder)+1;return this.dsCurrVal+=e,e}}class fn extends Yu{constructor(e){super(e),this.keys=[],U(e),this.keyClockDecoder=new Ts(Ce(e)),this.clientDecoder=new Mr(Ce(e)),this.leftClockDecoder=new Ts(Ce(e)),this.rightClockDecoder=new Ts(Ce(e)),this.infoDecoder=new Zi(Ce(e),cn),this.stringDecoder=new Mc(Ce(e)),this.parentInfoDecoder=new Zi(Ce(e),cn),this.typeRefDecoder=new Mr(Ce(e)),this.lenDecoder=new Mr(Ce(e))}readLeftID(){return new rn(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new rn(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return Gn(this.restDecoder)}readBuf(){return Ce(this.restDecoder)}readJSON(){return Gn(this.restDecoder)}readKey(){const e=this.keyClockDecoder.read();if(e<this.keys.length)return this.keys[e];{const n=this.stringDecoder.read();return this.keys.push(n),n}}}class Wu{constructor(){this.restEncoder=ns()}toUint8Array(){return Ye(this.restEncoder)}resetDsCurVal(){}writeDsClock(e){$(this.restEncoder,e)}writeDsLen(e){$(this.restEncoder,e)}}class fr extends Wu{writeLeftID(e){$(this.restEncoder,e.client),$(this.restEncoder,e.clock)}writeRightID(e){$(this.restEncoder,e.client),$(this.restEncoder,e.clock)}writeClient(e){$(this.restEncoder,e)}writeInfo(e){Gs(this.restEncoder,e)}writeString(e){en(this.restEncoder,e)}writeParentInfo(e){$(this.restEncoder,e?1:0)}writeTypeRef(e){$(this.restEncoder,e)}writeLen(e){$(this.restEncoder,e)}writeAny(e){qn(this.restEncoder,e)}writeBuf(e){Ie(this.restEncoder,e)}writeJSON(e){en(this.restEncoder,JSON.stringify(e))}writeKey(e){en(this.restEncoder,e)}}class Ku{constructor(){this.restEncoder=ns(),this.dsCurrVal=0}toUint8Array(){return Ye(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(e){const n=e-this.dsCurrVal;this.dsCurrVal=e,$(this.restEncoder,n)}writeDsLen(e){e===0&&Le(),$(this.restEncoder,e-1),this.dsCurrVal+=e}}class Rt extends Ku{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new Cs,this.clientEncoder=new Tr,this.leftClockEncoder=new Cs,this.rightClockEncoder=new Cs,this.infoEncoder=new Wi(Gs),this.stringEncoder=new kc,this.parentInfoEncoder=new Wi(Gs),this.typeRefEncoder=new Tr,this.lenEncoder=new Tr}toUint8Array(){const e=ns();return $(e,0),Ie(e,this.keyClockEncoder.toUint8Array()),Ie(e,this.clientEncoder.toUint8Array()),Ie(e,this.leftClockEncoder.toUint8Array()),Ie(e,this.rightClockEncoder.toUint8Array()),Ie(e,Ye(this.infoEncoder)),Ie(e,this.stringEncoder.toUint8Array()),Ie(e,Ye(this.parentInfoEncoder)),Ie(e,this.typeRefEncoder.toUint8Array()),Ie(e,this.lenEncoder.toUint8Array()),rs(e,Ye(this.restEncoder)),Ye(e)}writeLeftID(e){this.clientEncoder.write(e.client),this.leftClockEncoder.write(e.clock)}writeRightID(e){this.clientEncoder.write(e.client),this.rightClockEncoder.write(e.clock)}writeClient(e){this.clientEncoder.write(e)}writeInfo(e){this.infoEncoder.write(e)}writeString(e){this.stringEncoder.write(e)}writeParentInfo(e){this.parentInfoEncoder.write(e?1:0)}writeTypeRef(e){this.typeRefEncoder.write(e)}writeLen(e){this.lenEncoder.write(e)}writeAny(e){qn(this.restEncoder,e)}writeBuf(e){Ie(this.restEncoder,e)}writeJSON(e){qn(this.restEncoder,e)}writeKey(e){const n=this.keyMap.get(e);n===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(e)):this.keyClockEncoder.write(n)}}const Xu=(t,e,n,r)=>{r=Lt(r,e[0].id.clock);const s=Xe(e,r);$(t.restEncoder,e.length-s),t.writeClient(n),$(t.restEncoder,r);const i=e[s];i.write(t,r-i.id.clock);for(let l=s+1;l<e.length;l++)e[l].write(t,0)},_i=(t,e,n)=>{const r=new Map;n.forEach((s,i)=>{ge(e,i)>s&&r.set(i,s)}),xi(e).forEach((s,i)=>{n.has(i)||r.set(i,0)}),$(t.restEncoder,r.size),yt(r.entries()).sort((s,i)=>i[0]-s[0]).forEach(([s,i])=>{Xu(t,e.clients.get(s),s,i)})},Zu=(t,e)=>{const n=Se(),r=U(t.restDecoder);for(let s=0;s<r;s++){const i=U(t.restDecoder),l=new Array(i),h=t.readClient();let f=U(t.restDecoder);n.set(h,{i:0,refs:l});for(let g=0;g<i;g++){const c=t.readInfo();switch(ts&c){case 0:{const m=t.readLen();l[g]=new Ue(L(h,f),m),f+=m;break}case 10:{const m=U(t.restDecoder);l[g]=new Be(L(h,f),m),f+=m;break}default:{const m=(c&(it|Te))===0,d=new le(L(h,f),null,(c&Te)===Te?t.readLeftID():null,null,(c&it)===it?t.readRightID():null,m?t.readParentInfo()?e.get(t.readString()):t.readLeftID():null,m&&(c&jn)===jn?t.readString():null,Xa(t,c));l[g]=d,f+=d.length}}}}return n},Qu=(t,e,n)=>{const r=[];let s=yt(n.keys()).sort((w,E)=>w-E);if(s.length===0)return null;const i=()=>{if(s.length===0)return null;let w=n.get(s[s.length-1]);for(;w.refs.length===w.i;)if(s.pop(),s.length>0)w=n.get(s[s.length-1]);else return null;return w};let l=i();if(l===null)return null;const h=new Ma,f=new Map,g=(w,E)=>{const x=f.get(w);(x==null||x>E)&&f.set(w,E)};let c=l.refs[l.i++];const m=new Map,d=()=>{for(const w of r){const E=w.id.client,x=n.get(E);x?(x.i--,h.clients.set(E,x.refs.slice(x.i)),n.delete(E),x.i=0,x.refs=[]):h.clients.set(E,[w]),s=s.filter(R=>R!==E)}r.length=0};for(;;){if(c.constructor!==Be){const E=ct(m,c.id.client,()=>ge(e,c.id.client))-c.id.clock;if(E<0)r.push(c),g(c.id.client,c.id.clock-1),d();else{const x=c.getMissing(t,e);if(x!==null){r.push(c);const R=n.get(x)||{refs:[],i:0};if(R.refs.length===R.i)g(x,ge(e,x)),d();else{c=R.refs[R.i++];continue}}else(E===0||E<c.length)&&(c.integrate(t,E),m.set(c.id.client,c.id.clock+c.length))}}if(r.length>0)c=r.pop();else if(l!==null&&l.i<l.refs.length)c=l.refs[l.i++];else{if(l=i(),l===null)break;c=l.refs[l.i++]}}if(h.clients.size>0){const w=new Rt;return _i(w,h,new Map),$(w.restEncoder,0),{missing:f,update:w.toUint8Array()}}return null},eh=(t,e)=>_i(t,e.doc.store,e.beforeState),th=(t,e,n,r=new fn(t))=>G(e,s=>{s.local=!1;let i=!1;const l=s.doc,h=l.store,f=Zu(r,l),g=Qu(s,h,f),c=h.pendingStructs;if(c){for(const[d,w]of c.missing)if(w<ge(h,d)){i=!0;break}if(g){for(const[d,w]of g.missing){const E=c.missing.get(d);(E==null||E>w)&&c.missing.set(d,w)}c.update=Gr([c.update,g.update])}}else h.pendingStructs=g;const m=no(r,s,h);if(h.pendingDs){const d=new fn(En(h.pendingDs));U(d.restDecoder);const w=no(d,s,h);m&&w?h.pendingDs=Gr([m,w]):h.pendingDs=m||w}else h.pendingDs=m;if(i){const d=h.pendingStructs.update;h.pendingStructs=null,va(s.doc,d)}},n,!1),va=(t,e,n,r=fn)=>{const s=En(e);th(s,t,n,new r(s))},nh=(t,e,n)=>va(t,e,n,Aa),rh=(t,e,n=new Map)=>{_i(t,e.store,n),_n(t,zu(e.store))},sh=(t,e=new Uint8Array([0]),n=new Rt)=>{const r=Ca(e);rh(n,t,r);const s=[n.toUint8Array()];if(t.store.pendingDs&&s.push(t.store.pendingDs),t.store.pendingStructs&&s.push(mh(t.store.pendingStructs.update,e)),s.length>1){if(n.constructor===fr)return ph(s.map((i,l)=>l===0?i:yh(i)));if(n.constructor===Rt)return Gr(s)}return s[0]},Ia=(t,e)=>sh(t,e,new fr),ih=t=>{const e=new Map,n=U(t.restDecoder);for(let r=0;r<n;r++){const s=U(t.restDecoder),i=U(t.restDecoder);e.set(s,i)}return e},Ca=t=>ih(new Sa(En(t)));class oh{constructor(){this.l=[]}}const ro=()=>new oh,so=(t,e)=>t.l.push(e),io=(t,e)=>{const n=t.l,r=n.length;t.l=n.filter(s=>e!==s),r===t.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},Ta=(t,e,n)=>fi(t.l,[e,n]);class rn{constructor(e,n){this.client=e,this.clock=n}}const br=(t,e)=>t===e||t!==null&&e!==null&&t.client===e.client&&t.clock===e.clock,L=(t,e)=>new rn(t,e),ah=t=>{for(const[e,n]of t.doc.share.entries())if(n===t)return e;throw Le()},zt=(t,e)=>e===void 0?!t.deleted:e.sv.has(t.id.client)&&(e.sv.get(t.id.client)||0)>t.id.clock&&!_a(e.ds,t.id),Ws=(t,e)=>{const n=ct(t.meta,Ws,Dt),r=t.doc.store;n.has(e)||(e.sv.forEach((s,i)=>{s<ge(r,i)&&bt(t,L(i,s))}),ka(t,e.ds,s=>{}),n.add(e))};class Ma{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const xi=t=>{const e=new Map;return t.clients.forEach((n,r)=>{const s=n[n.length-1];e.set(r,s.id.clock+s.length)}),e},ge=(t,e)=>{const n=t.clients.get(e);if(n===void 0)return 0;const r=n[n.length-1];return r.id.clock+r.length},Da=(t,e)=>{let n=t.clients.get(e.id.client);if(n===void 0)n=[],t.clients.set(e.id.client,n);else{const r=n[n.length-1];if(r.id.clock+r.length!==e.id.clock)throw Le()}n.push(e)},Xe=(t,e)=>{let n=0,r=t.length-1,s=t[r],i=s.id.clock;if(i===e)return r;let l=Ke(e/(i+s.length-1)*r);for(;n<=r;){if(s=t[l],i=s.id.clock,i<=e){if(e<i+s.length)return l;n=l+1}else r=l-1;l=Ke((n+r)/2)}throw Le()},lh=(t,e)=>{const n=t.clients.get(e.client);return n[Xe(n,e.clock)]},Os=lh,Ks=(t,e,n)=>{const r=Xe(e,n),s=e[r];return s.id.clock<n&&s instanceof le?(e.splice(r+1,0,Xr(t,s,n-s.id.clock)),r+1):r},bt=(t,e)=>{const n=t.doc.store.clients.get(e.client);return n[Ks(t,n,e.clock)]},oo=(t,e,n)=>{const r=e.clients.get(n.client),s=Xe(r,n.clock),i=r[s];return n.clock!==i.id.clock+i.length-1&&i.constructor!==Ue&&r.splice(s+1,0,Xr(t,i,n.clock-i.id.clock+1)),i},ch=(t,e,n)=>{const r=t.clients.get(e.id.client);r[Xe(r,e.id.clock)]=n},Ra=(t,e,n,r,s)=>{if(r===0)return;const i=n+r;let l=Ks(t,e,n),h;do h=e[l++],i<h.id.clock+h.length&&Ks(t,e,i),s(h);while(l<e.length&&e[l].id.clock<i)};class uh{constructor(e,n,r){this.doc=e,this.deleteSet=new hr,this.beforeState=xi(e.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=n,this.meta=new Map,this.local=r,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}}const ao=(t,e)=>e.deleteSet.clients.size===0&&!Kl(e.afterState,(n,r)=>e.beforeState.get(r)!==n)?!1:(Ei(e.deleteSet),eh(t,e),_n(t,e.deleteSet),!0),lo=(t,e,n)=>{const r=e._item;(r===null||r.id.clock<(t.beforeState.get(r.id.client)||0)&&!r.deleted)&&ct(t.changed,e,Dt).add(n)},Rr=(t,e)=>{let n=t[e],r=t[e-1],s=e;for(;s>0;n=r,r=t[--s-1]){if(r.deleted===n.deleted&&r.constructor===n.constructor&&r.mergeWith(n)){n instanceof le&&n.parentSub!==null&&n.parent._map.get(n.parentSub)===n&&n.parent._map.set(n.parentSub,r);continue}break}const i=e-s;return i&&t.splice(e+1-i,i),i},hh=(t,e,n)=>{for(const[r,s]of t.clients.entries()){const i=e.clients.get(r);for(let l=s.length-1;l>=0;l--){const h=s[l],f=h.clock+h.len;for(let g=Xe(i,h.clock),c=i[g];g<i.length&&c.id.clock<f;c=i[++g]){const m=i[g];if(h.clock+h.len<=m.id.clock)break;m instanceof le&&m.deleted&&!m.keep&&n(m)&&m.gc(e,!1)}}}},fh=(t,e)=>{t.clients.forEach((n,r)=>{const s=e.clients.get(r);for(let i=n.length-1;i>=0;i--){const l=n[i],h=Ho(s.length-1,1+Xe(s,l.clock+l.len-1));for(let f=h,g=s[f];f>0&&g.id.clock>=l.clock;g=s[f])f-=1+Rr(s,f)}})},Oa=(t,e)=>{if(e<t.length){const n=t[e],r=n.doc,s=r.store,i=n.deleteSet,l=n._mergeStructs;try{Ei(i),n.afterState=xi(n.doc.store),r.emit("beforeObserverCalls",[n,r]);const h=[];n.changed.forEach((f,g)=>h.push(()=>{(g._item===null||!g._item.deleted)&&g._callObserver(n,f)})),h.push(()=>{n.changedParentTypes.forEach((f,g)=>{g._dEH.l.length>0&&(g._item===null||!g._item.deleted)&&(f=f.filter(c=>c.target._item===null||!c.target._item.deleted),f.forEach(c=>{c.currentTarget=g,c._path=null}),f.sort((c,m)=>c.path.length-m.path.length),Ta(g._dEH,f,n))})}),h.push(()=>r.emit("afterTransaction",[n,r])),fi(h,[]),n._needFormattingCleanup&&Rh(n)}finally{r.gc&&hh(i,s,r.gcFilter),fh(i,s),n.afterState.forEach((c,m)=>{const d=n.beforeState.get(m)||0;if(d!==c){const w=s.clients.get(m),E=Lt(Xe(w,d),1);for(let x=w.length-1;x>=E;)x-=1+Rr(w,x)}});for(let c=l.length-1;c>=0;c--){const{client:m,clock:d}=l[c].id,w=s.clients.get(m),E=Xe(w,d);E+1<w.length&&Rr(w,E+1)>1||E>0&&Rr(w,E)}if(!n.local&&n.afterState.get(r.clientID)!==n.beforeState.get(r.clientID)&&(Vu(yi,ga,"[yjs] ",ma,wa,"Changed the client-id because another client seems to be using it."),r.clientID=xa()),r.emit("afterTransactionCleanup",[n,r]),r._observers.has("update")){const c=new fr;ao(c,n)&&r.emit("update",[c.toUint8Array(),n.origin,r,n])}if(r._observers.has("updateV2")){const c=new Rt;ao(c,n)&&r.emit("updateV2",[c.toUint8Array(),n.origin,r,n])}const{subdocsAdded:h,subdocsLoaded:f,subdocsRemoved:g}=n;(h.size>0||g.size>0||f.size>0)&&(h.forEach(c=>{c.clientID=r.clientID,c.collectionid==null&&(c.collectionid=r.collectionid),r.subdocs.add(c)}),g.forEach(c=>r.subdocs.delete(c)),r.emit("subdocs",[{loaded:f,added:h,removed:g},r,n]),g.forEach(c=>c.destroy())),t.length<=e+1?(r._transactionCleanups=[],r.emit("afterAllTransactions",[r,t])):Oa(t,e+1)}}},G=(t,e,n=null,r=!0)=>{const s=t._transactionCleanups;let i=!1,l=null;t._transaction===null&&(i=!0,t._transaction=new uh(t,n,r),s.push(t._transaction),s.length===1&&t.emit("beforeAllTransactions",[t]),t.emit("beforeTransaction",[t._transaction,t]));try{l=e(t._transaction)}finally{if(i){const h=t._transaction===s[0];t._transaction=null,h&&Oa(s,0)}}return l};function*dh(t){const e=U(t.restDecoder);for(let n=0;n<e;n++){const r=U(t.restDecoder),s=t.readClient();let i=U(t.restDecoder);for(let l=0;l<r;l++){const h=t.readInfo();if(h===10){const f=U(t.restDecoder);yield new Be(L(s,i),f),i+=f}else if((ts&h)!==0){const f=(h&(it|Te))===0,g=new le(L(s,i),null,(h&Te)===Te?t.readLeftID():null,null,(h&it)===it?t.readRightID():null,f?t.readParentInfo()?t.readString():t.readLeftID():null,f&&(h&jn)===jn?t.readString():null,Xa(t,h));yield g,i+=g.length}else{const f=t.readLen();yield new Ue(L(s,i),f),i+=f}}}}class Si{constructor(e,n){this.gen=dh(e),this.curr=null,this.done=!1,this.filterSkips=n,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===Be);return this.curr}}class Ai{constructor(e){this.currClient=0,this.startClock=0,this.written=0,this.encoder=e,this.clientStructs=[]}}const ph=t=>Gr(t,Aa,fr),gh=(t,e)=>{if(t.constructor===Ue){const{client:n,clock:r}=t.id;return new Ue(L(n,r+e),t.length-e)}else if(t.constructor===Be){const{client:n,clock:r}=t.id;return new Be(L(n,r+e),t.length-e)}else{const n=t,{client:r,clock:s}=n.id;return new le(L(r,s+e),null,L(r,s+e-1),null,n.rightOrigin,n.parent,n.parentSub,n.content.splice(e))}},Gr=(t,e=fn,n=Rt)=>{if(t.length===1)return t[0];const r=t.map(c=>new e(En(c)));let s=r.map(c=>new Si(c,!0)),i=null;const l=new n,h=new Ai(l);for(;s=s.filter(d=>d.curr!==null),s.sort((d,w)=>{if(d.curr.id.client===w.curr.id.client){const E=d.curr.id.clock-w.curr.id.clock;return E===0?d.curr.constructor===w.curr.constructor?0:d.curr.constructor===Be?1:-1:E}else return w.curr.id.client-d.curr.id.client}),s.length!==0;){const c=s[0],m=c.curr.id.client;if(i!==null){let d=c.curr,w=!1;for(;d!==null&&d.id.clock+d.length<=i.struct.id.clock+i.struct.length&&d.id.client>=i.struct.id.client;)d=c.next(),w=!0;if(d===null||d.id.client!==m||w&&d.id.clock>i.struct.id.clock+i.struct.length)continue;if(m!==i.struct.id.client)gt(h,i.struct,i.offset),i={struct:d,offset:0},c.next();else if(i.struct.id.clock+i.struct.length<d.id.clock)if(i.struct.constructor===Be)i.struct.length=d.id.clock+d.length-i.struct.id.clock;else{gt(h,i.struct,i.offset);const E=d.id.clock-i.struct.id.clock-i.struct.length;i={struct:new Be(L(m,i.struct.id.clock+i.struct.length),E),offset:0}}else{const E=i.struct.id.clock+i.struct.length-d.id.clock;E>0&&(i.struct.constructor===Be?i.struct.length-=E:d=gh(d,E)),i.struct.mergeWith(d)||(gt(h,i.struct,i.offset),i={struct:d,offset:0},c.next())}}else i={struct:c.curr,offset:0},c.next();for(let d=c.curr;d!==null&&d.id.client===m&&d.id.clock===i.struct.id.clock+i.struct.length&&d.constructor!==Be;d=c.next())gt(h,i.struct,i.offset),i={struct:d,offset:0}}i!==null&&(gt(h,i.struct,i.offset),i=null),vi(h);const f=r.map(c=>ki(c)),g=Gu(f);return _n(l,g),l.toUint8Array()},mh=(t,e,n=fn,r=Rt)=>{const s=Ca(e),i=new r,l=new Ai(i),h=new n(En(t)),f=new Si(h,!1);for(;f.curr;){const c=f.curr,m=c.id.client,d=s.get(m)||0;if(f.curr.constructor===Be){f.next();continue}if(c.id.clock+c.length>d)for(gt(l,c,Lt(d-c.id.clock,0)),f.next();f.curr&&f.curr.id.client===m;)gt(l,f.curr,0),f.next();else for(;f.curr&&f.curr.id.client===m&&f.curr.id.clock+f.curr.length<=d;)f.next()}vi(l);const g=ki(h);return _n(i,g),i.toUint8Array()},Ua=t=>{t.written>0&&(t.clientStructs.push({written:t.written,restEncoder:Ye(t.encoder.restEncoder)}),t.encoder.restEncoder=ns(),t.written=0)},gt=(t,e,n)=>{t.written>0&&t.currClient!==e.id.client&&Ua(t),t.written===0&&(t.currClient=e.id.client,t.encoder.writeClient(e.id.client),$(t.encoder.restEncoder,e.id.clock+n)),e.write(t.encoder,n),t.written++},vi=t=>{Ua(t);const e=t.encoder.restEncoder;$(e,t.clientStructs.length);for(let n=0;n<t.clientStructs.length;n++){const r=t.clientStructs[n];$(e,r.written),rs(e,r.restEncoder)}},wh=(t,e,n,r)=>{const s=new n(En(t)),i=new Si(s,!1),l=new r,h=new Ai(l);for(let g=i.curr;g!==null;g=i.next())gt(h,e(g),0);vi(h);const f=ki(s);return _n(l,f),l.toUint8Array()},yh=t=>wh(t,qc,fn,fr),co="You must not compute changes after the event-handler fired.";class hs{constructor(e,n){this.target=e,this.currentTarget=e,this.transaction=n,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=bh(this.currentTarget,this.target))}deletes(e){return _a(this.transaction.deleteSet,e.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw Ve(co);const e=new Map,n=this.target;this.transaction.changed.get(n).forEach(s=>{if(s!==null){const i=n._map.get(s);let l,h;if(this.adds(i)){let f=i.left;for(;f!==null&&this.adds(f);)f=f.left;if(this.deletes(i))if(f!==null&&this.deletes(f))l="delete",h=As(f.content.getContent());else return;else f!==null&&this.deletes(f)?(l="update",h=As(f.content.getContent())):(l="add",h=void 0)}else if(this.deletes(i))l="delete",h=As(i.content.getContent());else return;e.set(s,{action:l,oldValue:h})}}),this._keys=e}return this._keys}get delta(){return this.changes.delta}adds(e){return e.id.clock>=(this.transaction.beforeState.get(e.id.client)||0)}get changes(){let e=this._changes;if(e===null){if(this.transaction.doc._transactionCleanups.length===0)throw Ve(co);const n=this.target,r=Dt(),s=Dt(),i=[];if(e={added:r,deleted:s,delta:i,keys:this.keys},this.transaction.changed.get(n).has(null)){let h=null;const f=()=>{h&&i.push(h)};for(let g=n._start;g!==null;g=g.right)g.deleted?this.deletes(g)&&!this.adds(g)&&((h===null||h.delete===void 0)&&(f(),h={delete:0}),h.delete+=g.length,s.add(g)):this.adds(g)?((h===null||h.insert===void 0)&&(f(),h={insert:[]}),h.insert=h.insert.concat(g.content.getContent()),r.add(g)):((h===null||h.retain===void 0)&&(f(),h={retain:0}),h.retain+=g.length);h!==null&&h.retain===void 0&&f()}this._changes=e}return e}}const bh=(t,e)=>{const n=[];for(;e._item!==null&&e!==t;){if(e._item.parentSub!==null)n.unshift(e._item.parentSub);else{let r=0,s=e._item.parent._start;for(;s!==e._item&&s!==null;)!s.deleted&&s.countable&&(r+=s.length),s=s.right;n.unshift(r)}e=e._item.parent}return n},Ee=()=>{ju("Invalid access: Add Yjs type to a document before reading data.")},Ba=80;let Ii=0;class Eh{constructor(e,n){e.marker=!0,this.p=e,this.index=n,this.timestamp=Ii++}}const kh=t=>{t.timestamp=Ii++},La=(t,e,n)=>{t.p.marker=!1,t.p=e,e.marker=!0,t.index=n,t.timestamp=Ii++},_h=(t,e,n)=>{if(t.length>=Ba){const r=t.reduce((s,i)=>s.timestamp<i.timestamp?s:i);return La(r,e,n),r}else{const r=new Eh(e,n);return t.push(r),r}},fs=(t,e)=>{if(t._start===null||e===0||t._searchMarker===null)return null;const n=t._searchMarker.length===0?null:t._searchMarker.reduce((i,l)=>Cr(e-i.index)<Cr(e-l.index)?i:l);let r=t._start,s=0;for(n!==null&&(r=n.p,s=n.index,kh(n));r.right!==null&&s<e;){if(!r.deleted&&r.countable){if(e<s+r.length)break;s+=r.length}r=r.right}for(;r.left!==null&&s>e;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);for(;r.left!==null&&r.left.id.client===r.id.client&&r.left.id.clock+r.left.length===r.id.clock;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);return n!==null&&Cr(n.index-s)<r.parent.length/Ba?(La(n,r,s),n):_h(t._searchMarker,r,s)},Wn=(t,e,n)=>{for(let r=t.length-1;r>=0;r--){const s=t[r];if(n>0){let i=s.p;for(i.marker=!1;i&&(i.deleted||!i.countable);)i=i.left,i&&!i.deleted&&i.countable&&(s.index-=i.length);if(i===null||i.marker===!0){t.splice(r,1);continue}s.p=i,i.marker=!0}(e<s.index||n>0&&e===s.index)&&(s.index=Lt(e,s.index+n))}},ds=(t,e,n)=>{const r=t,s=e.changedParentTypes;for(;ct(s,t,()=>[]).push(n),t._item!==null;)t=t._item.parent;Ta(r._eH,n,e)};class we{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=ro(),this._dEH=ro(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(e,n){this.doc=e,this._item=n}_copy(){throw $e()}clone(){throw $e()}_write(e){}get _first(){let e=this._start;for(;e!==null&&e.deleted;)e=e.right;return e}_callObserver(e,n){!e.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(e){so(this._eH,e)}observeDeep(e){so(this._dEH,e)}unobserve(e){io(this._eH,e)}unobserveDeep(e){io(this._dEH,e)}toJSON(){}}const Na=(t,e,n)=>{t.doc??Ee(),e<0&&(e=t._length+e),n<0&&(n=t._length+n);let r=n-e;const s=[];let i=t._start;for(;i!==null&&r>0;){if(i.countable&&!i.deleted){const l=i.content.getContent();if(l.length<=e)e-=l.length;else{for(let h=e;h<l.length&&r>0;h++)s.push(l[h]),r--;e=0}}i=i.right}return s},Fa=t=>{t.doc??Ee();const e=[];let n=t._start;for(;n!==null;){if(n.countable&&!n.deleted){const r=n.content.getContent();for(let s=0;s<r.length;s++)e.push(r[s])}n=n.right}return e},Kn=(t,e)=>{let n=0,r=t._start;for(t.doc??Ee();r!==null;){if(r.countable&&!r.deleted){const s=r.content.getContent();for(let i=0;i<s.length;i++)e(s[i],n++,t)}r=r.right}},$a=(t,e)=>{const n=[];return Kn(t,(r,s)=>{n.push(e(r,s,t))}),n},xh=t=>{let e=t._start,n=null,r=0;return{[Symbol.iterator](){return this},next:()=>{if(n===null){for(;e!==null&&e.deleted;)e=e.right;if(e===null)return{done:!0,value:void 0};n=e.content.getContent(),r=0,e=e.right}const s=n[r++];return n.length<=r&&(n=null),{done:!1,value:s}}}},Pa=(t,e)=>{t.doc??Ee();const n=fs(t,e);let r=t._start;for(n!==null&&(r=n.p,e-=n.index);r!==null;r=r.right)if(!r.deleted&&r.countable){if(e<r.length)return r.content.getContent()[e];e-=r.length}},Jr=(t,e,n,r)=>{let s=n;const i=t.doc,l=i.clientID,h=i.store,f=n===null?e._start:n.right;let g=[];const c=()=>{g.length>0&&(s=new le(L(l,ge(h,l)),s,s&&s.lastId,f,f&&f.id,e,null,new Ut(g)),s.integrate(t,0),g=[])};r.forEach(m=>{if(m===null)g.push(m);else switch(m.constructor){case Number:case Object:case Boolean:case Array:case String:g.push(m);break;default:switch(c(),m.constructor){case Uint8Array:case ArrayBuffer:s=new le(L(l,ge(h,l)),s,s&&s.lastId,f,f&&f.id,e,null,new dr(new Uint8Array(m))),s.integrate(t,0);break;case xn:s=new le(L(l,ge(h,l)),s,s&&s.lastId,f,f&&f.id,e,null,new pr(m)),s.integrate(t,0);break;default:if(m instanceof we)s=new le(L(l,ge(h,l)),s,s&&s.lastId,f,f&&f.id,e,null,new ht(m)),s.integrate(t,0);else throw new Error("Unexpected content type in insert operation")}}}),c()},Va=()=>Ve("Length exceeded!"),ja=(t,e,n,r)=>{if(n>e._length)throw Va();if(n===0)return e._searchMarker&&Wn(e._searchMarker,n,r.length),Jr(t,e,null,r);const s=n,i=fs(e,n);let l=e._start;for(i!==null&&(l=i.p,n-=i.index,n===0&&(l=l.prev,n+=l&&l.countable&&!l.deleted?l.length:0));l!==null;l=l.right)if(!l.deleted&&l.countable){if(n<=l.length){n<l.length&&bt(t,L(l.id.client,l.id.clock+n));break}n-=l.length}return e._searchMarker&&Wn(e._searchMarker,s,r.length),Jr(t,e,l,r)},Sh=(t,e,n)=>{let s=(e._searchMarker||[]).reduce((i,l)=>l.index>i.index?l:i,{index:0,p:e._start}).p;if(s)for(;s.right;)s=s.right;return Jr(t,e,s,n)},Ha=(t,e,n,r)=>{if(r===0)return;const s=n,i=r,l=fs(e,n);let h=e._start;for(l!==null&&(h=l.p,n-=l.index);h!==null&&n>0;h=h.right)!h.deleted&&h.countable&&(n<h.length&&bt(t,L(h.id.client,h.id.clock+n)),n-=h.length);for(;r>0&&h!==null;)h.deleted||(r<h.length&&bt(t,L(h.id.client,h.id.clock+r)),h.delete(t),r-=h.length),h=h.right;if(r>0)throw Va();e._searchMarker&&Wn(e._searchMarker,s,-i+r)},zr=(t,e,n)=>{const r=e._map.get(n);r!==void 0&&r.delete(t)},Ci=(t,e,n,r)=>{const s=e._map.get(n)||null,i=t.doc,l=i.clientID;let h;if(r==null)h=new Ut([r]);else switch(r.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:h=new Ut([r]);break;case Uint8Array:h=new dr(r);break;case xn:h=new pr(r);break;default:if(r instanceof we)h=new ht(r);else throw new Error("Unexpected content type")}new le(L(l,ge(i.store,l)),s,s&&s.lastId,null,null,e,n,h).integrate(t,0)},Ti=(t,e)=>{t.doc??Ee();const n=t._map.get(e);return n!==void 0&&!n.deleted?n.content.getContent()[n.length-1]:void 0},qa=t=>{const e={};return t.doc??Ee(),t._map.forEach((n,r)=>{n.deleted||(e[r]=n.content.getContent()[n.length-1])}),e},Ga=(t,e)=>{t.doc??Ee();const n=t._map.get(e);return n!==void 0&&!n.deleted},Ah=(t,e)=>{const n={};return t._map.forEach((r,s)=>{let i=r;for(;i!==null&&(!e.sv.has(i.id.client)||i.id.clock>=(e.sv.get(i.id.client)||0));)i=i.left;i!==null&&zt(i,e)&&(n[s]=i.content.getContent()[i.length-1])}),n},Er=t=>(t.doc??Ee(),Hu(t._map.entries(),e=>!e[1].deleted));class vh extends hs{}class sn extends we{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(e){const n=new sn;return n.push(e),n}_integrate(e,n){super._integrate(e,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new sn}clone(){const e=new sn;return e.insert(0,this.toArray().map(n=>n instanceof we?n.clone():n)),e}get length(){return this.doc??Ee(),this._length}_callObserver(e,n){super._callObserver(e,n),ds(this,e,new vh(this,e))}insert(e,n){this.doc!==null?G(this.doc,r=>{ja(r,this,e,n)}):this._prelimContent.splice(e,0,...n)}push(e){this.doc!==null?G(this.doc,n=>{Sh(n,this,e)}):this._prelimContent.push(...e)}unshift(e){this.insert(0,e)}delete(e,n=1){this.doc!==null?G(this.doc,r=>{Ha(r,this,e,n)}):this._prelimContent.splice(e,n)}get(e){return Pa(this,e)}toArray(){return Fa(this)}slice(e=0,n=this.length){return Na(this,e,n)}toJSON(){return this.map(e=>e instanceof we?e.toJSON():e)}map(e){return $a(this,e)}forEach(e){Kn(this,e)}[Symbol.iterator](){return xh(this)}_write(e){e.writeTypeRef(Xh)}}const Ih=t=>new sn;class Ch extends hs{constructor(e,n,r){super(e,n),this.keysChanged=r}}class dn extends we{constructor(e){super(),this._prelimContent=null,e===void 0?this._prelimContent=new Map:this._prelimContent=new Map(e)}_integrate(e,n){super._integrate(e,n),this._prelimContent.forEach((r,s)=>{this.set(s,r)}),this._prelimContent=null}_copy(){return new dn}clone(){const e=new dn;return this.forEach((n,r)=>{e.set(r,n instanceof we?n.clone():n)}),e}_callObserver(e,n){ds(this,e,new Ch(this,e,n))}toJSON(){this.doc??Ee();const e={};return this._map.forEach((n,r)=>{if(!n.deleted){const s=n.content.getContent()[n.length-1];e[r]=s instanceof we?s.toJSON():s}}),e}get size(){return[...Er(this)].length}keys(){return Rs(Er(this),e=>e[0])}values(){return Rs(Er(this),e=>e[1].content.getContent()[e[1].length-1])}entries(){return Rs(Er(this),e=>[e[0],e[1].content.getContent()[e[1].length-1]])}forEach(e){this.doc??Ee(),this._map.forEach((n,r)=>{n.deleted||e(n.content.getContent()[n.length-1],r,this)})}[Symbol.iterator](){return this.entries()}delete(e){this.doc!==null?G(this.doc,n=>{zr(n,this,e)}):this._prelimContent.delete(e)}set(e,n){return this.doc!==null?G(this.doc,r=>{Ci(r,this,e,n)}):this._prelimContent.set(e,n),n}get(e){return Ti(this,e)}has(e){return Ga(this,e)}clear(){this.doc!==null?G(this.doc,e=>{this.forEach(function(n,r,s){zr(e,s,r)})}):this._prelimContent.clear()}_write(e){e.writeTypeRef(Zh)}}const Th=t=>new dn,wt=(t,e)=>t===e||typeof t=="object"&&typeof e=="object"&&t&&e&&jc(t,e);class Xs{constructor(e,n,r,s){this.left=e,this.right=n,this.index=r,this.currentAttributes=s}forward(){switch(this.right===null&&Le(),this.right.content.constructor){case ce:this.right.deleted||Sn(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}}const uo=(t,e,n)=>{for(;e.right!==null&&n>0;){switch(e.right.content.constructor){case ce:e.right.deleted||Sn(e.currentAttributes,e.right.content);break;default:e.right.deleted||(n<e.right.length&&bt(t,L(e.right.id.client,e.right.id.clock+n)),e.index+=e.right.length,n-=e.right.length);break}e.left=e.right,e.right=e.right.right}return e},kr=(t,e,n,r)=>{const s=new Map,i=r?fs(e,n):null;if(i){const l=new Xs(i.p.left,i.p,i.index,s);return uo(t,l,n-i.index)}else{const l=new Xs(null,e._start,0,s);return uo(t,l,n)}},Ja=(t,e,n,r)=>{for(;n.right!==null&&(n.right.deleted===!0||n.right.content.constructor===ce&&wt(r.get(n.right.content.key),n.right.content.value));)n.right.deleted||r.delete(n.right.content.key),n.forward();const s=t.doc,i=s.clientID;r.forEach((l,h)=>{const f=n.left,g=n.right,c=new le(L(i,ge(s.store,i)),f,f&&f.lastId,g,g&&g.id,e,null,new ce(h,l));c.integrate(t,0),n.right=c,n.forward()})},Sn=(t,e)=>{const{key:n,value:r}=e;r===null?t.delete(n):t.set(n,r)},za=(t,e)=>{for(;t.right!==null;){if(!(t.right.deleted||t.right.content.constructor===ce&&wt(e[t.right.content.key]??null,t.right.content.value)))break;t.forward()}},Ya=(t,e,n,r)=>{const s=t.doc,i=s.clientID,l=new Map;for(const h in r){const f=r[h],g=n.currentAttributes.get(h)??null;if(!wt(g,f)){l.set(h,g);const{left:c,right:m}=n;n.right=new le(L(i,ge(s.store,i)),c,c&&c.lastId,m,m&&m.id,e,null,new ce(h,f)),n.right.integrate(t,0),n.forward()}}return l},Us=(t,e,n,r,s)=>{n.currentAttributes.forEach((d,w)=>{s[w]===void 0&&(s[w]=null)});const i=t.doc,l=i.clientID;za(n,s);const h=Ya(t,e,n,s),f=r.constructor===String?new Ze(r):r instanceof we?new ht(r):new Nt(r);let{left:g,right:c,index:m}=n;e._searchMarker&&Wn(e._searchMarker,n.index,f.getLength()),c=new le(L(l,ge(i.store,l)),g,g&&g.lastId,c,c&&c.id,e,null,f),c.integrate(t,0),n.right=c,n.index=m,n.forward(),Ja(t,e,n,h)},ho=(t,e,n,r,s)=>{const i=t.doc,l=i.clientID;za(n,s);const h=Ya(t,e,n,s);e:for(;n.right!==null&&(r>0||h.size>0&&(n.right.deleted||n.right.content.constructor===ce));){if(!n.right.deleted)switch(n.right.content.constructor){case ce:{const{key:f,value:g}=n.right.content,c=s[f];if(c!==void 0){if(wt(c,g))h.delete(f);else{if(r===0)break e;h.set(f,g)}n.right.delete(t)}else n.currentAttributes.set(f,g);break}default:r<n.right.length&&bt(t,L(n.right.id.client,n.right.id.clock+r)),r-=n.right.length;break}n.forward()}if(r>0){let f="";for(;r>0;r--)f+=`
`;n.right=new le(L(l,ge(i.store,l)),n.left,n.left&&n.left.lastId,n.right,n.right&&n.right.id,e,null,new Ze(f)),n.right.integrate(t,0),n.forward()}Ja(t,e,n,h)},Wa=(t,e,n,r,s)=>{let i=e;const l=Se();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===ce){const g=i.content;l.set(g.key,g)}i=i.right}let h=0,f=!1;for(;e!==i;){if(n===e&&(f=!0),!e.deleted){const g=e.content;switch(g.constructor){case ce:{const{key:c,value:m}=g,d=r.get(c)??null;(l.get(c)!==g||d===m)&&(e.delete(t),h++,!f&&(s.get(c)??null)===m&&d!==m&&(d===null?s.delete(c):s.set(c,d))),!f&&!e.deleted&&Sn(s,g);break}}}e=e.right}return h},Mh=(t,e)=>{for(;e&&e.right&&(e.right.deleted||!e.right.countable);)e=e.right;const n=new Set;for(;e&&(e.deleted||!e.countable);){if(!e.deleted&&e.content.constructor===ce){const r=e.content.key;n.has(r)?e.delete(t):n.add(r)}e=e.left}},Dh=t=>{let e=0;return G(t.doc,n=>{let r=t._start,s=t._start,i=Se();const l=Hs(i);for(;s;){if(s.deleted===!1)switch(s.content.constructor){case ce:Sn(l,s.content);break;default:e+=Wa(n,r,s,i,l),i=Hs(l),r=s;break}s=s.right}}),e},Rh=t=>{const e=new Set,n=t.doc;for(const[r,s]of t.afterState.entries()){const i=t.beforeState.get(r)||0;s!==i&&Ra(t,n.store.clients.get(r),i,s,l=>{!l.deleted&&l.content.constructor===ce&&l.constructor!==Ue&&e.add(l.parent)})}G(n,r=>{ka(t,t.deleteSet,s=>{if(s instanceof Ue||!s.parent._hasFormatting||e.has(s.parent))return;const i=s.parent;s.content.constructor===ce?e.add(i):Mh(r,s)});for(const s of e)Dh(s)})},fo=(t,e,n)=>{const r=n,s=Hs(e.currentAttributes),i=e.right;for(;n>0&&e.right!==null;){if(e.right.deleted===!1)switch(e.right.content.constructor){case ht:case Nt:case Ze:n<e.right.length&&bt(t,L(e.right.id.client,e.right.id.clock+n)),n-=e.right.length,e.right.delete(t);break}e.forward()}i&&Wa(t,i,e.right,s,e.currentAttributes);const l=(e.left||e.right).parent;return l._searchMarker&&Wn(l._searchMarker,e.index,-r+n),e};class Oh extends hs{constructor(e,n,r){super(e,n),this.childListChanged=!1,this.keysChanged=new Set,r.forEach(s=>{s===null?this.childListChanged=!0:this.keysChanged.add(s)})}get changes(){if(this._changes===null){const e={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=e}return this._changes}get delta(){if(this._delta===null){const e=this.target.doc,n=[];G(e,r=>{const s=new Map,i=new Map;let l=this.target._start,h=null;const f={};let g="",c=0,m=0;const d=()=>{if(h!==null){let w=null;switch(h){case"delete":m>0&&(w={delete:m}),m=0;break;case"insert":(typeof g=="object"||g.length>0)&&(w={insert:g},s.size>0&&(w.attributes={},s.forEach((E,x)=>{E!==null&&(w.attributes[x]=E)}))),g="";break;case"retain":c>0&&(w={retain:c},Vc(f)||(w.attributes=Fc({},f))),c=0;break}w&&n.push(w),h=null}};for(;l!==null;){switch(l.content.constructor){case ht:case Nt:this.adds(l)?this.deletes(l)||(d(),h="insert",g=l.content.getContent()[0],d()):this.deletes(l)?(h!=="delete"&&(d(),h="delete"),m+=1):l.deleted||(h!=="retain"&&(d(),h="retain"),c+=1);break;case Ze:this.adds(l)?this.deletes(l)||(h!=="insert"&&(d(),h="insert"),g+=l.content.str):this.deletes(l)?(h!=="delete"&&(d(),h="delete"),m+=l.length):l.deleted||(h!=="retain"&&(d(),h="retain"),c+=l.length);break;case ce:{const{key:w,value:E}=l.content;if(this.adds(l)){if(!this.deletes(l)){const x=s.get(w)??null;wt(x,E)?E!==null&&l.delete(r):(h==="retain"&&d(),wt(E,i.get(w)??null)?delete f[w]:f[w]=E)}}else if(this.deletes(l)){i.set(w,E);const x=s.get(w)??null;wt(x,E)||(h==="retain"&&d(),f[w]=x)}else if(!l.deleted){i.set(w,E);const x=f[w];x!==void 0&&(wt(x,E)?x!==null&&l.delete(r):(h==="retain"&&d(),E===null?delete f[w]:f[w]=E))}l.deleted||(h==="insert"&&d(),Sn(s,l.content));break}}l=l.right}for(d();n.length>0;){const w=n[n.length-1];if(w.retain!==void 0&&w.attributes===void 0)n.pop();else break}}),this._delta=n}return this._delta}}class pn extends we{constructor(e){super(),this._pending=e!==void 0?[()=>this.insert(0,e)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??Ee(),this._length}_integrate(e,n){super._integrate(e,n);try{this._pending.forEach(r=>r())}catch(r){console.error(r)}this._pending=null}_copy(){return new pn}clone(){const e=new pn;return e.applyDelta(this.toDelta()),e}_callObserver(e,n){super._callObserver(e,n);const r=new Oh(this,e,n);ds(this,e,r),!e.local&&this._hasFormatting&&(e._needFormattingCleanup=!0)}toString(){this.doc??Ee();let e="",n=this._start;for(;n!==null;)!n.deleted&&n.countable&&n.content.constructor===Ze&&(e+=n.content.str),n=n.right;return e}toJSON(){return this.toString()}applyDelta(e,{sanitize:n=!0}={}){this.doc!==null?G(this.doc,r=>{const s=new Xs(null,this._start,0,new Map);for(let i=0;i<e.length;i++){const l=e[i];if(l.insert!==void 0){const h=!n&&typeof l.insert=="string"&&i===e.length-1&&s.right===null&&l.insert.slice(-1)===`
`?l.insert.slice(0,-1):l.insert;(typeof h!="string"||h.length>0)&&Us(r,this,s,h,l.attributes||{})}else l.retain!==void 0?ho(r,this,s,l.retain,l.attributes||{}):l.delete!==void 0&&fo(r,s,l.delete)}}):this._pending.push(()=>this.applyDelta(e))}toDelta(e,n,r){this.doc??Ee();const s=[],i=new Map,l=this.doc;let h="",f=this._start;function g(){if(h.length>0){const m={};let d=!1;i.forEach((E,x)=>{d=!0,m[x]=E});const w={insert:h};d&&(w.attributes=m),s.push(w),h=""}}const c=()=>{for(;f!==null;){if(zt(f,e)||n!==void 0&&zt(f,n))switch(f.content.constructor){case Ze:{const m=i.get("ychange");e!==void 0&&!zt(f,e)?(m===void 0||m.user!==f.id.client||m.type!=="removed")&&(g(),i.set("ychange",r?r("removed",f.id):{type:"removed"})):n!==void 0&&!zt(f,n)?(m===void 0||m.user!==f.id.client||m.type!=="added")&&(g(),i.set("ychange",r?r("added",f.id):{type:"added"})):m!==void 0&&(g(),i.delete("ychange")),h+=f.content.str;break}case ht:case Nt:{g();const m={insert:f.content.getContent()[0]};if(i.size>0){const d={};m.attributes=d,i.forEach((w,E)=>{d[E]=w})}s.push(m);break}case ce:zt(f,e)&&(g(),Sn(i,f.content));break}f=f.right}g()};return e||n?G(l,m=>{e&&Ws(m,e),n&&Ws(m,n),c()},"cleanup"):c(),s}insert(e,n,r){if(n.length<=0)return;const s=this.doc;s!==null?G(s,i=>{const l=kr(i,this,e,!r);r||(r={},l.currentAttributes.forEach((h,f)=>{r[f]=h})),Us(i,this,l,n,r)}):this._pending.push(()=>this.insert(e,n,r))}insertEmbed(e,n,r){const s=this.doc;s!==null?G(s,i=>{const l=kr(i,this,e,!r);Us(i,this,l,n,r||{})}):this._pending.push(()=>this.insertEmbed(e,n,r||{}))}delete(e,n){if(n===0)return;const r=this.doc;r!==null?G(r,s=>{fo(s,kr(s,this,e,!0),n)}):this._pending.push(()=>this.delete(e,n))}format(e,n,r){if(n===0)return;const s=this.doc;s!==null?G(s,i=>{const l=kr(i,this,e,!1);l.right!==null&&ho(i,this,l,n,r)}):this._pending.push(()=>this.format(e,n,r))}removeAttribute(e){this.doc!==null?G(this.doc,n=>{zr(n,this,e)}):this._pending.push(()=>this.removeAttribute(e))}setAttribute(e,n){this.doc!==null?G(this.doc,r=>{Ci(r,this,e,n)}):this._pending.push(()=>this.setAttribute(e,n))}getAttribute(e){return Ti(this,e)}getAttributes(){return qa(this)}_write(e){e.writeTypeRef(Qh)}}const Uh=t=>new pn;class Bs{constructor(e,n=()=>!0){this._filter=n,this._root=e,this._currentNode=e._start,this._firstCall=!0,e.doc??Ee()}[Symbol.iterator](){return this}next(){let e=this._currentNode,n=e&&e.content&&e.content.type;if(e!==null&&(!this._firstCall||e.deleted||!this._filter(n)))do if(n=e.content.type,!e.deleted&&(n.constructor===gn||n.constructor===Ot)&&n._start!==null)e=n._start;else for(;e!==null;){const r=e.next;if(r!==null){e=r;break}else e.parent===this._root?e=null:e=e.parent._item}while(e!==null&&(e.deleted||!this._filter(e.content.type)));return this._firstCall=!1,e===null?{value:void 0,done:!0}:(this._currentNode=e,{value:e.content.type,done:!1})}}class Ot extends we{constructor(){super(),this._prelimContent=[]}get firstChild(){const e=this._first;return e?e.content.getContent()[0]:null}_integrate(e,n){super._integrate(e,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Ot}clone(){const e=new Ot;return e.insert(0,this.toArray().map(n=>n instanceof we?n.clone():n)),e}get length(){return this.doc??Ee(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(e){return new Bs(this,e)}querySelector(e){e=e.toUpperCase();const r=new Bs(this,s=>s.nodeName&&s.nodeName.toUpperCase()===e).next();return r.done?null:r.value}querySelectorAll(e){return e=e.toUpperCase(),yt(new Bs(this,n=>n.nodeName&&n.nodeName.toUpperCase()===e))}_callObserver(e,n){ds(this,e,new Nh(this,n,e))}toString(){return $a(this,e=>e.toString()).join("")}toJSON(){return this.toString()}toDOM(e=document,n={},r){const s=e.createDocumentFragment();return r!==void 0&&r._createAssociation(s,this),Kn(this,i=>{s.insertBefore(i.toDOM(e,n,r),null)}),s}insert(e,n){this.doc!==null?G(this.doc,r=>{ja(r,this,e,n)}):this._prelimContent.splice(e,0,...n)}insertAfter(e,n){if(this.doc!==null)G(this.doc,r=>{const s=e&&e instanceof we?e._item:e;Jr(r,this,s,n)});else{const r=this._prelimContent,s=e===null?0:r.findIndex(i=>i===e)+1;if(s===0&&e!==null)throw Ve("Reference item not found");r.splice(s,0,...n)}}delete(e,n=1){this.doc!==null?G(this.doc,r=>{Ha(r,this,e,n)}):this._prelimContent.splice(e,n)}toArray(){return Fa(this)}push(e){this.insert(this.length,e)}unshift(e){this.insert(0,e)}get(e){return Pa(this,e)}slice(e=0,n=this.length){return Na(this,e,n)}forEach(e){Kn(this,e)}_write(e){e.writeTypeRef(tf)}}const Bh=t=>new Ot;class gn extends Ot{constructor(e="UNDEFINED"){super(),this.nodeName=e,this._prelimAttrs=new Map}get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_integrate(e,n){super._integrate(e,n),this._prelimAttrs.forEach((r,s)=>{this.setAttribute(s,r)}),this._prelimAttrs=null}_copy(){return new gn(this.nodeName)}clone(){const e=new gn(this.nodeName),n=this.getAttributes();return Pc(n,(r,s)=>{e.setAttribute(s,r)}),e.insert(0,this.toArray().map(r=>r instanceof we?r.clone():r)),e}toString(){const e=this.getAttributes(),n=[],r=[];for(const h in e)r.push(h);r.sort();const s=r.length;for(let h=0;h<s;h++){const f=r[h];n.push(f+'="'+e[f]+'"')}const i=this.nodeName.toLocaleLowerCase(),l=n.length>0?" "+n.join(" "):"";return`<${i}${l}>${super.toString()}</${i}>`}removeAttribute(e){this.doc!==null?G(this.doc,n=>{zr(n,this,e)}):this._prelimAttrs.delete(e)}setAttribute(e,n){this.doc!==null?G(this.doc,r=>{Ci(r,this,e,n)}):this._prelimAttrs.set(e,n)}getAttribute(e){return Ti(this,e)}hasAttribute(e){return Ga(this,e)}getAttributes(e){return e?Ah(this,e):qa(this)}toDOM(e=document,n={},r){const s=e.createElement(this.nodeName),i=this.getAttributes();for(const l in i){const h=i[l];typeof h=="string"&&s.setAttribute(l,h)}return Kn(this,l=>{s.appendChild(l.toDOM(e,n,r))}),r!==void 0&&r._createAssociation(s,this),s}_write(e){e.writeTypeRef(ef),e.writeKey(this.nodeName)}}const Lh=t=>new gn(t.readKey());class Nh extends hs{constructor(e,n,r){super(e,r),this.childListChanged=!1,this.attributesChanged=new Set,n.forEach(s=>{s===null?this.childListChanged=!0:this.attributesChanged.add(s)})}}class Yr extends dn{constructor(e){super(),this.hookName=e}_copy(){return new Yr(this.hookName)}clone(){const e=new Yr(this.hookName);return this.forEach((n,r)=>{e.set(r,n)}),e}toDOM(e=document,n={},r){const s=n[this.hookName];let i;return s!==void 0?i=s.createDom(this):i=document.createElement(this.hookName),i.setAttribute("data-yjs-hook",this.hookName),r!==void 0&&r._createAssociation(i,this),i}_write(e){e.writeTypeRef(nf),e.writeKey(this.hookName)}}const Fh=t=>new Yr(t.readKey());class Wr extends pn{get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_copy(){return new Wr}clone(){const e=new Wr;return e.applyDelta(this.toDelta()),e}toDOM(e=document,n,r){const s=e.createTextNode(this.toString());return r!==void 0&&r._createAssociation(s,this),s}toString(){return this.toDelta().map(e=>{const n=[];for(const s in e.attributes){const i=[];for(const l in e.attributes[s])i.push({key:l,value:e.attributes[s][l]});i.sort((l,h)=>l.key<h.key?-1:1),n.push({nodeName:s,attrs:i})}n.sort((s,i)=>s.nodeName<i.nodeName?-1:1);let r="";for(let s=0;s<n.length;s++){const i=n[s];r+=`<${i.nodeName}`;for(let l=0;l<i.attrs.length;l++){const h=i.attrs[l];r+=` ${h.key}="${h.value}"`}r+=">"}r+=e.insert;for(let s=n.length-1;s>=0;s--)r+=`</${n[s].nodeName}>`;return r}).join("")}toJSON(){return this.toString()}_write(e){e.writeTypeRef(rf)}}const $h=t=>new Wr;class Mi{constructor(e,n){this.id=e,this.length=n}get deleted(){throw $e()}mergeWith(e){return!1}write(e,n,r){throw $e()}integrate(e,n){throw $e()}}const Ph=0;class Ue extends Mi{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,n){n>0&&(this.id.clock+=n,this.length-=n),Da(e.doc.store,this)}write(e,n){e.writeInfo(Ph),e.writeLen(this.length-n)}getMissing(e,n){return null}}class dr{constructor(e){this.content=e}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new dr(this.content)}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeBuf(this.content)}getRef(){return 3}}const Vh=t=>new dr(t.readBuf());class Xn{constructor(e){this.len=e}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new Xn(this.len)}splice(e){const n=new Xn(this.len-e);return this.len=e,n}mergeWith(e){return this.len+=e.len,!0}integrate(e,n){qr(e.deleteSet,n.id.client,n.id.clock,this.len),n.markDeleted()}delete(e){}gc(e){}write(e,n){e.writeLen(this.len-n)}getRef(){return 1}}const jh=t=>new Xn(t.readLen()),Ka=(t,e)=>new xn({guid:t,...e,shouldLoad:e.shouldLoad||e.autoLoad||!1});class pr{constructor(e){e._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=e;const n={};this.opts=n,e.gc||(n.gc=!1),e.autoLoad&&(n.autoLoad=!0),e.meta!==null&&(n.meta=e.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new pr(Ka(this.doc.guid,this.opts))}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){this.doc._item=n,e.subdocsAdded.add(this.doc),this.doc.shouldLoad&&e.subdocsLoaded.add(this.doc)}delete(e){e.subdocsAdded.has(this.doc)?e.subdocsAdded.delete(this.doc):e.subdocsRemoved.add(this.doc)}gc(e){}write(e,n){e.writeString(this.doc.guid),e.writeAny(this.opts)}getRef(){return 9}}const Hh=t=>new pr(Ka(t.readString(),t.readAny()));class Nt{constructor(e){this.embed=e}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new Nt(this.embed)}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeJSON(this.embed)}getRef(){return 5}}const qh=t=>new Nt(t.readJSON());class ce{constructor(e,n){this.key=e,this.value=n}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new ce(this.key,this.value)}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){const r=n.parent;r._searchMarker=null,r._hasFormatting=!0}delete(e){}gc(e){}write(e,n){e.writeKey(this.key),e.writeJSON(this.value)}getRef(){return 6}}const Gh=t=>new ce(t.readKey(),t.readJSON());class Kr{constructor(e){this.arr=e}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Kr(this.arr)}splice(e){const n=new Kr(this.arr.slice(e));return this.arr=this.arr.slice(0,e),n}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){const r=this.arr.length;e.writeLen(r-n);for(let s=n;s<r;s++){const i=this.arr[s];e.writeString(i===void 0?"undefined":JSON.stringify(i))}}getRef(){return 2}}const Jh=t=>{const e=t.readLen(),n=[];for(let r=0;r<e;r++){const s=t.readString();s==="undefined"?n.push(void 0):n.push(JSON.parse(s))}return new Kr(n)},zh=Vr("node_env")==="development";class Ut{constructor(e){this.arr=e,zh&&Ko(e)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Ut(this.arr)}splice(e){const n=new Ut(this.arr.slice(e));return this.arr=this.arr.slice(0,e),n}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){const r=this.arr.length;e.writeLen(r-n);for(let s=n;s<r;s++){const i=this.arr[s];e.writeAny(i)}}getRef(){return 8}}const Yh=t=>{const e=t.readLen(),n=[];for(let r=0;r<e;r++)n.push(t.readAny());return new Ut(n)};class Ze{constructor(e){this.str=e}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new Ze(this.str)}splice(e){const n=new Ze(this.str.slice(e));this.str=this.str.slice(0,e);const r=this.str.charCodeAt(e-1);return r>=55296&&r<=56319&&(this.str=this.str.slice(0,e-1)+"",n.str=""+n.str.slice(1)),n}mergeWith(e){return this.str+=e.str,!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeString(n===0?this.str:this.str.slice(n))}getRef(){return 4}}const Wh=t=>new Ze(t.readString()),Kh=[Ih,Th,Uh,Lh,Bh,Fh,$h],Xh=0,Zh=1,Qh=2,ef=3,tf=4,nf=5,rf=6;class ht{constructor(e){this.type=e}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new ht(this.type._copy())}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){this.type._integrate(e.doc,n)}delete(e){let n=this.type._start;for(;n!==null;)n.deleted?n.id.clock<(e.beforeState.get(n.id.client)||0)&&e._mergeStructs.push(n):n.delete(e),n=n.right;this.type._map.forEach(r=>{r.deleted?r.id.clock<(e.beforeState.get(r.id.client)||0)&&e._mergeStructs.push(r):r.delete(e)}),e.changed.delete(this.type)}gc(e){let n=this.type._start;for(;n!==null;)n.gc(e,!0),n=n.right;this.type._start=null,this.type._map.forEach(r=>{for(;r!==null;)r.gc(e,!0),r=r.left}),this.type._map=new Map}write(e,n){this.type._write(e)}getRef(){return 7}}const sf=t=>new ht(Kh[t.readTypeRef()](t)),Xr=(t,e,n)=>{const{client:r,clock:s}=e.id,i=new le(L(r,s+n),e,L(r,s+n-1),e.right,e.rightOrigin,e.parent,e.parentSub,e.content.splice(n));return e.deleted&&i.markDeleted(),e.keep&&(i.keep=!0),e.redone!==null&&(i.redone=L(e.redone.client,e.redone.clock+n)),e.right=i,i.right!==null&&(i.right.left=i),t._mergeStructs.push(i),i.parentSub!==null&&i.right===null&&i.parent._map.set(i.parentSub,i),e.length=n,i};class le extends Mi{constructor(e,n,r,s,i,l,h,f){super(e,f.getLength()),this.origin=r,this.left=n,this.right=s,this.rightOrigin=i,this.parent=l,this.parentSub=h,this.redone=null,this.content=f,this.info=this.content.isCountable()?Gi:0}set marker(e){(this.info&Is)>0!==e&&(this.info^=Is)}get marker(){return(this.info&Is)>0}get keep(){return(this.info&qi)>0}set keep(e){this.keep!==e&&(this.info^=qi)}get countable(){return(this.info&Gi)>0}get deleted(){return(this.info&vs)>0}set deleted(e){this.deleted!==e&&(this.info^=vs)}markDeleted(){this.info|=vs}getMissing(e,n){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=ge(n,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=ge(n,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===rn&&this.id.client!==this.parent.client&&this.parent.clock>=ge(n,this.parent.client))return this.parent.client;if(this.origin&&(this.left=oo(e,n,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=bt(e,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===Ue||this.right&&this.right.constructor===Ue)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===le?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===le&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===rn){const r=Os(n,this.parent);r.constructor===Ue?this.parent=null:this.parent=r.content.type}return null}integrate(e,n){if(n>0&&(this.id.clock+=n,this.left=oo(e,e.doc.store,L(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(n),this.length-=n),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let r=this.left,s;if(r!==null)s=r.right;else if(this.parentSub!==null)for(s=this.parent._map.get(this.parentSub)||null;s!==null&&s.left!==null;)s=s.left;else s=this.parent._start;const i=new Set,l=new Set;for(;s!==null&&s!==this.right;){if(l.add(s),i.add(s),br(this.origin,s.origin)){if(s.id.client<this.id.client)r=s,i.clear();else if(br(this.rightOrigin,s.rightOrigin))break}else if(s.origin!==null&&l.has(Os(e.doc.store,s.origin)))i.has(Os(e.doc.store,s.origin))||(r=s,i.clear());else break;s=s.right}this.left=r}if(this.left!==null){const r=this.left.right;this.right=r,this.left.right=this}else{let r;if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start,this.parent._start=this;this.right=r}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(e)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),Da(e.doc.store,this),this.content.integrate(e,this),lo(e,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(e)}else new Ue(this.id,this.length).integrate(e,0)}get next(){let e=this.right;for(;e!==null&&e.deleted;)e=e.right;return e}get prev(){let e=this.left;for(;e!==null&&e.deleted;)e=e.left;return e}get lastId(){return this.length===1?this.id:L(this.id.client,this.id.clock+this.length-1)}mergeWith(e){if(this.constructor===e.constructor&&br(e.origin,this.lastId)&&this.right===e&&br(this.rightOrigin,e.rightOrigin)&&this.id.client===e.id.client&&this.id.clock+this.length===e.id.clock&&this.deleted===e.deleted&&this.redone===null&&e.redone===null&&this.content.constructor===e.content.constructor&&this.content.mergeWith(e.content)){const n=this.parent._searchMarker;return n&&n.forEach(r=>{r.p===e&&(r.p=this,!this.deleted&&this.countable&&(r.index-=this.length))}),e.keep&&(this.keep=!0),this.right=e.right,this.right!==null&&(this.right.left=this),this.length+=e.length,!0}return!1}delete(e){if(!this.deleted){const n=this.parent;this.countable&&this.parentSub===null&&(n._length-=this.length),this.markDeleted(),qr(e.deleteSet,this.id.client,this.id.clock,this.length),lo(e,n,this.parentSub),this.content.delete(e)}}gc(e,n){if(!this.deleted)throw Le();this.content.gc(e),n?ch(e,this,new Ue(this.id,this.length)):this.content=new Xn(this.length)}write(e,n){const r=n>0?L(this.id.client,this.id.clock+n-1):this.origin,s=this.rightOrigin,i=this.parentSub,l=this.content.getRef()&ts|(r===null?0:Te)|(s===null?0:it)|(i===null?0:jn);if(e.writeInfo(l),r!==null&&e.writeLeftID(r),s!==null&&e.writeRightID(s),r===null&&s===null){const h=this.parent;if(h._item!==void 0){const f=h._item;if(f===null){const g=ah(h);e.writeParentInfo(!0),e.writeString(g)}else e.writeParentInfo(!1),e.writeLeftID(f.id)}else h.constructor===String?(e.writeParentInfo(!0),e.writeString(h)):h.constructor===rn?(e.writeParentInfo(!1),e.writeLeftID(h)):Le();i!==null&&e.writeString(i)}this.content.write(e,n)}}const Xa=(t,e)=>of[e&ts](t),of=[()=>{Le()},jh,Jh,Vh,Wh,qh,Gh,sf,Yh,Hh,()=>{Le()}],af=10;class Be extends Mi{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,n){Le()}write(e,n){e.writeInfo(af),$(e.restEncoder,this.length-n)}getMissing(e,n){return null}}const Za=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof Hi<"u"?Hi:{},Qa="__ $YJS$ __";Za[Qa]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");Za[Qa]=!0;const Ft=t=>un((e,n)=>{t.onerror=r=>n(new Error(r.target.error)),t.onsuccess=r=>e(r.target.result)}),lf=(t,e)=>un((n,r)=>{const s=indexedDB.open(t);s.onupgradeneeded=i=>e(i.target.result),s.onerror=i=>r(Ve(i.target.error)),s.onsuccess=i=>{const l=i.target.result;l.onversionchange=()=>{l.close()},n(l)}}),cf=t=>Ft(indexedDB.deleteDatabase(t)),uf=(t,e)=>e.forEach(n=>t.createObjectStore.apply(t,n)),Un=(t,e,n="readwrite")=>{const r=t.transaction(e,n);return e.map(s=>yf(r,s))},el=(t,e)=>Ft(t.count(e)),hf=(t,e)=>Ft(t.get(e)),tl=(t,e)=>Ft(t.delete(e)),ff=(t,e,n)=>Ft(t.put(e,n)),Zs=(t,e)=>Ft(t.add(e)),df=(t,e,n)=>Ft(t.getAll(e,n)),pf=(t,e,n)=>{let r=null;return wf(t,e,s=>(r=s,!1),n).then(()=>r)},gf=(t,e=null)=>pf(t,e,"prev"),mf=(t,e)=>un((n,r)=>{t.onerror=r,t.onsuccess=async s=>{const i=s.target.result;if(i===null||await e(i)===!1)return n();i.continue()}}),wf=(t,e,n,r="next")=>mf(t.openKeyCursor(e,r),s=>n(s.key)),yf=(t,e)=>t.objectStore(e),bf=(t,e)=>IDBKeyRange.upperBound(t,e),Ef=(t,e)=>IDBKeyRange.lowerBound(t,e),Ls="custom",nl="updates",rl=500,sl=(t,e=()=>{},n=()=>{})=>{const[r]=Un(t.db,[nl]);return df(r,Ef(t._dbref,!1)).then(s=>{t._destroyed||(e(r),G(t.doc,()=>{s.forEach(i=>nh(t.doc,i))},t,!1),n(r))}).then(()=>gf(r).then(s=>{t._dbref=s+1})).then(()=>el(r).then(s=>{t._dbsize=s})).then(()=>r)},kf=(t,e=!0)=>sl(t).then(n=>{(e||t._dbsize>=rl)&&Zs(n,Ia(t.doc)).then(()=>tl(n,bf(t._dbref,!0))).then(()=>el(n).then(r=>{t._dbsize=r}))});class _f extends ec{constructor(e,n){super(),this.doc=n,this.name=e,this._dbref=0,this._dbsize=0,this._destroyed=!1,this.db=null,this.synced=!1,this._db=lf(e,r=>uf(r,[["updates",{autoIncrement:!0}],["custom"]])),this.whenSynced=un(r=>this.on("synced",()=>r(this))),this._db.then(r=>{this.db=r,sl(this,l=>Zs(l,Ia(n)),()=>{if(this._destroyed)return this;this.synced=!0,this.emit("synced",[this])})}),this._storeTimeout=1e3,this._storeTimeoutId=null,this._storeUpdate=(r,s)=>{if(this.db&&s!==this){const[i]=Un(this.db,[nl]);Zs(i,r),++this._dbsize>=rl&&(this._storeTimeoutId!==null&&clearTimeout(this._storeTimeoutId),this._storeTimeoutId=setTimeout(()=>{kf(this,!1),this._storeTimeoutId=null},this._storeTimeout))}},n.on("update",this._storeUpdate),this.destroy=this.destroy.bind(this),n.on("destroy",this.destroy)}destroy(){return this._storeTimeoutId&&clearTimeout(this._storeTimeoutId),this.doc.off("update",this._storeUpdate),this.doc.off("destroy",this.destroy),this._destroyed=!0,this._db.then(e=>{e.close()})}clearData(){return this.destroy().then(()=>{cf(this.name)})}get(e){return this._db.then(n=>{const[r]=Un(n,[Ls],"readonly");return hf(r,e)})}set(e,n){return this._db.then(r=>{const[s]=Un(r,[Ls]);return ff(s,n,e)})}del(e){return this._db.then(n=>{const[r]=Un(n,[Ls]);return tl(r,e)})}}const il="schwalbvault",Et=new xn,xf=typeof window<"u",Or=xf?new _f(il,Et):null,Sf=Et.getMap("characters"),Bn=Et.getMap("campaigns"),Af=Et.getMap("enemies"),vf=Et.getMap("encounters"),If=Et.getMap("images"),Cf=Et.getMap("deletedIds"),Tf=()=>new Promise(t=>{if(!Or){t();return}Or.synced?t():Or.on("synced",()=>{t()})}),Rp=Object.freeze(Object.defineProperty({__proto__:null,campaignsMap:Bn,charactersMap:Sf,deletedIdsMap:Cf,doc:Et,encountersMap:vf,enemiesMap:Af,imagesMap:If,provider:Or,waitForSync:Tf},Symbol.toStringTag,{value:"Module"}));const _r="0123456789abcdef";class Ct{constructor(e){this.bytes=e}static ofInner(e){if(e.length!==16)throw new TypeError("not 128-bit length");return new Ct(e)}static fromFieldsV7(e,n,r,s){if(!Number.isInteger(e)||!Number.isInteger(n)||!Number.isInteger(r)||!Number.isInteger(s)||e<0||n<0||r<0||s<0||e>0xffffffffffff||n>4095||r>1073741823||s>4294967295)throw new RangeError("invalid field value");const i=new Uint8Array(16);return i[0]=e/2**40,i[1]=e/2**32,i[2]=e/2**24,i[3]=e/2**16,i[4]=e/2**8,i[5]=e,i[6]=112|n>>>8,i[7]=n,i[8]=128|r>>>24,i[9]=r>>>16,i[10]=r>>>8,i[11]=r,i[12]=s>>>24,i[13]=s>>>16,i[14]=s>>>8,i[15]=s,new Ct(i)}static parse(e){var n,r,s,i;let l;switch(e.length){case 32:l=(n=/^[0-9a-f]{32}$/i.exec(e))===null||n===void 0?void 0:n[0];break;case 36:l=(r=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||r===void 0?void 0:r.slice(1,6).join("");break;case 38:l=(s=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(e))===null||s===void 0?void 0:s.slice(1,6).join("");break;case 45:l=(i=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||i===void 0?void 0:i.slice(1,6).join("");break}if(l){const h=new Uint8Array(16);for(let f=0;f<16;f+=4){const g=parseInt(l.substring(2*f,2*f+8),16);h[f+0]=g>>>24,h[f+1]=g>>>16,h[f+2]=g>>>8,h[f+3]=g}return new Ct(h)}else throw new SyntaxError("could not parse UUID string")}toString(){let e="";for(let n=0;n<this.bytes.length;n++)e+=_r.charAt(this.bytes[n]>>>4),e+=_r.charAt(this.bytes[n]&15),(n===3||n===5||n===7||n===9)&&(e+="-");return e}toHex(){let e="";for(let n=0;n<this.bytes.length;n++)e+=_r.charAt(this.bytes[n]>>>4),e+=_r.charAt(this.bytes[n]&15);return e}toJSON(){return this.toString()}getVariant(){const e=this.bytes[8]>>>4;if(e<0)throw new Error("unreachable");if(e<=7)return this.bytes.every(n=>n===0)?"NIL":"VAR_0";if(e<=11)return"VAR_10";if(e<=13)return"VAR_110";if(e<=15)return this.bytes.every(n=>n===255)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return this.getVariant()==="VAR_10"?this.bytes[6]>>>4:void 0}clone(){return new Ct(this.bytes.slice(0))}equals(e){return this.compareTo(e)===0}compareTo(e){for(let n=0;n<16;n++){const r=this.bytes[n]-e.bytes[n];if(r!==0)return Math.sign(r)}return 0}}class Mf{constructor(e){this.timestamp_biased=0,this.counter=0,this.random=e??Df()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(e,n){let r=this.generateOrAbortCore(e,n);return r===void 0&&(this.timestamp_biased=0,r=this.generateOrAbortCore(e,n)),r}generateOrAbortCore(e,n){if(!Number.isInteger(e)||e<0||e>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit unsigned integer");if(n<0||n>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(e++,e>this.timestamp_biased)this.timestamp_biased=e,this.resetCounter();else if(e+n>=this.timestamp_biased)this.counter++,this.counter>4398046511103&&(this.timestamp_biased++,this.resetCounter());else return;return Ct.fromFieldsV7(this.timestamp_biased-1,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=this.random.nextUint32()*1024+(this.random.nextUint32()&1023)}generateV4(){const e=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return e[6]=64|e[6]>>>4,e[8]=128|e[8]>>>2,Ct.ofInner(e)}}const Df=()=>{if(typeof crypto<"u"&&typeof crypto.getRandomValues<"u")return new Rf;if(typeof UUIDV7_DENY_WEAK_RNG<"u"&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>Math.trunc(Math.random()*65536)*65536+Math.trunc(Math.random()*65536)}};class Rf{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}let po;const Pn=()=>Of().toString(),Of=()=>(po||(po=new Mf)).generate(),{floor:Uf,random:Bf}=Math,Zn="Trystero",Qn=(t,e)=>Array(t).fill().map(e),go="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",ol=t=>Qn(t,()=>go[Uf(Bf()*go.length)]).join(""),Yt=ol(20),At=Promise.all.bind(Promise),al=typeof window<"u",{entries:Qs,fromEntries:ll,keys:Lf}=Object,tt=()=>{},nt=t=>new Error(`${Zn}: ${t}`),Nf=new TextEncoder,Ff=new TextDecoder,on=t=>Nf.encode(t),Ur=t=>Ff.decode(t),xr=(...t)=>t.join("@"),$f=(t,e,n,r)=>(t.relayUrls||e).slice(0,t.relayUrls?t.relayUrls.length:t.relayRedundancy||n),er=JSON.stringify,tr=JSON.parse,mo=3333,Sr={};let Vn=null,ei=null;const Pf=()=>{Vn||(Vn=new Promise(t=>{ei=t}).finally(()=>{ei=null,Vn=null}))},Vf=()=>ei?.(),jf=(t,e)=>{const n={},r=()=>{const s=new WebSocket(t);s.onclose=()=>{if(Vn){Vn.then(r);return}Sr[t]??=mo,setTimeout(r,Sr[t]),Sr[t]*=2},s.onmessage=i=>e(i.data),n.socket=s,n.url=s.url,n.ready=new Promise(i=>s.onopen=()=>{i(n),Sr[t]=mo}),n.send=i=>{s.readyState===1&&s.send(i)}};return r(),n},Hf=()=>{if(al){const t=new AbortController;return addEventListener("online",Vf,{signal:t.signal}),addEventListener("offline",Pf,{signal:t.signal}),()=>t.abort()}return tt},Di="AES-GCM",qf={},Gf=t=>btoa(String.fromCharCode.apply(null,new Uint8Array(t))),Jf=t=>{const e=atob(t);return new Uint8Array(e.length).map((n,r)=>e.charCodeAt(r)).buffer},zf=async(t,e)=>new Uint8Array(await crypto.subtle.digest(t,on(e))),Ln=async t=>qf[t]||=Array.from(await zf("SHA-1",t)).map(e=>e.toString(36)).join(""),Yf=async(t,e,n)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},on(`${t}:${e}:${n}`)),{name:Di},!1,["encrypt","decrypt"]),cl="$",ul=",",Wf=async(t,e)=>{const n=crypto.getRandomValues(new Uint8Array(16));return n.join(ul)+cl+Gf(await crypto.subtle.encrypt({name:Di,iv:n},await t,on(e)))},Kf=async(t,e)=>{const[n,r]=e.split(cl);return Ur(await crypto.subtle.decrypt({name:Di,iv:new Uint8Array(n.split(ul))},await t,Jf(r)))},Xf=5e3,wo="icegatheringstatechange",yo="offer",Zf="answer",bo=(t,{rtcConfig:e,rtcPolyfill:n,turnConfig:r})=>{const s=new(n||RTCPeerConnection)({iceServers:Qf.concat(r||[]),...e}),i={};let l=!1,h=!1,f=null;const g=m=>{m.binaryType="arraybuffer",m.bufferedAmountLowThreshold=65535,m.onmessage=d=>i.data?.(d.data),m.onopen=()=>i.connect?.(),m.onclose=()=>i.close?.(),m.onerror=d=>i.error?.(d)},c=m=>Promise.race([new Promise(d=>{const w=()=>{m.iceGatheringState==="complete"&&(m.removeEventListener(wo,w),d())};m.addEventListener(wo,w),w()}),new Promise(d=>setTimeout(d,Xf))]).then(()=>({type:m.localDescription.type,sdp:m.localDescription.sdp.replace(/a=ice-options:trickle\s\n/g,"")}));return t?(f=s.createDataChannel("data"),g(f)):s.ondatachannel=({channel:m})=>{f=m,g(m)},s.onnegotiationneeded=async()=>{try{l=!0,await s.setLocalDescription();const m=await c(s);i.signal?.(m)}catch(m){i.error?.(m)}finally{l=!1}},s.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(s.connectionState)&&i.close?.()},s.ontrack=m=>{i.track?.(m.track,m.streams[0]),i.stream?.(m.streams[0])},s.onremovestream=m=>i.stream?.(m.stream),t&&(s.canTrickleIceCandidates||s.onnegotiationneeded()),{created:Date.now(),connection:s,get channel(){return f},get isDead(){return s.connectionState==="closed"},async signal(m){if(!(f?.readyState==="open"&&!m.sdp?.includes("a=rtpmap")))try{if(m.type===yo){if(l||s.signalingState!=="stable"&&!h){if(t)return;await At([s.setLocalDescription({type:"rollback"}),s.setRemoteDescription(m)])}else await s.setRemoteDescription(m);await s.setLocalDescription();const d=await c(s);return i.signal?.(d),d}else if(m.type===Zf){h=!0;try{await s.setRemoteDescription(m)}finally{h=!1}}}catch(d){i.error?.(d)}},sendData:m=>f.send(m),destroy:()=>{f?.close(),s.close(),l=!1,h=!1},setHandlers:m=>Object.assign(i,m),offerPromise:t?new Promise(m=>i.signal=d=>{d.type===yo&&m(d)}):Promise.resolve(),addStream:m=>m.getTracks().forEach(d=>s.addTrack(d,m)),removeStream:m=>s.getSenders().filter(d=>m.getTracks().includes(d.track)).forEach(d=>s.removeTrack(d)),addTrack:(m,d)=>s.addTrack(m,d),removeTrack:m=>{const d=s.getSenders().find(w=>w.track===m);d&&s.removeTrack(d)},replaceTrack:(m,d)=>{const w=s.getSenders().find(E=>E.track===m);if(w)return w.replaceTrack(d)}}},Qf=[...Qn(3,(t,e)=>`stun:stun${e||""}.l.google.com:19302`),"stun:stun.cloudflare.com:3478"].map(t=>({urls:t})),ed=Object.getPrototypeOf(Uint8Array),Br=12,hl=0,Lr=hl+Br,Nr=Lr+1,Nn=Nr+1,Fn=Nn+1,xt=16*2**10-Fn,Ar=255,Eo="bufferedamountlow",Jt=t=>"@_"+t,td=(t,e,n)=>{const r={},s={},i={},l={},h={},f={},g={},c={onPeerJoin:tt,onPeerLeave:tt,onPeerStream:tt,onPeerTrack:tt},m=(_,A)=>(_?Array.isArray(_)?_:[_]:Lf(r)).flatMap(O=>{const N=r[O];return N?A(O,N):(console.warn(`${Zn}: no peer with id ${O} found`),[])}),d=_=>{r[_]&&(r[_].destroy(),delete r[_],delete l[_],delete h[_],c.onPeerLeave(_),e(_))},w=_=>{if(s[_])return i[_];if(!_)throw nt("action type argument is required");const A=on(_);if(A.byteLength>Br)throw nt(`action type string "${_}" (${A.byteLength}b) exceeds byte limit (${Br}). Hint: choose a shorter name.`);const O=new Uint8Array(Br);O.set(A);let N=0;return s[_]={onComplete:tt,onProgress:tt,setOnComplete:z=>s[_]={...s[_],onComplete:z},setOnProgress:z=>s[_]={...s[_],onProgress:z},send:async(z,v,T,Q)=>{if(T&&typeof T!="object")throw nt("action meta argument must be an object");const ye=typeof z;if(ye==="undefined")throw nt("action data cannot be undefined");const he=ye!=="string",Ne=z instanceof Blob,H=Ne||z instanceof ArrayBuffer||z instanceof ed;if(T&&!H)throw nt("action meta argument can only be used with binary data");const F=H?new Uint8Array(Ne?await z.arrayBuffer():z):on(he?er(z):z),W=T?on(er(T)):null,ee=Math.ceil(F.byteLength/xt)+(T?1:0)||1,oe=Qn(ee,(ae,fe)=>{const De=fe===ee-1,be=T&&fe===0,ve=new Uint8Array(Fn+(be?W.byteLength:De?F.byteLength-xt*(ee-(T?2:1)):xt));return ve.set(O),ve.set([N],Lr),ve.set([De|be<<1|H<<2|he<<3],Nr),ve.set([Math.round((fe+1)/ee*Ar)],Nn),ve.set(T?be?W:F.subarray((fe-1)*xt,fe*xt):F.subarray(fe*xt,(fe+1)*xt),Fn),ve});return N=N+1&Ar,At(m(v,async(ae,fe)=>{const{channel:De}=fe;let be=0;for(;be<ee;){const ve=oe[be];if(De.bufferedAmount>De.bufferedAmountLowThreshold&&await new Promise(mr=>{const wr=()=>{De.removeEventListener(Eo,wr),mr()};De.addEventListener(Eo,wr)}),!r[ae])break;fe.sendData(ve),be++,Q?.(ve[Nn]/Ar,ae,T)}}))}},i[_]||=[s[_].send,s[_].setOnComplete,s[_].setOnProgress]},E=(_,A)=>{const O=new Uint8Array(A),N=Ur(O.subarray(hl,Lr)).replaceAll("\0",""),[z]=O.subarray(Lr,Nr),[v]=O.subarray(Nr,Nn),[T]=O.subarray(Nn,Fn),Q=O.subarray(Fn),ye=!!(v&1),he=!!(v&2),Ne=!!(v&4),H=!!(v&8);if(!s[N]){console.warn(`${Zn}: received message with unregistered type (${N})`);return}l[_]||={},l[_][N]||={};const F=l[_][N][z]||={chunks:[]};if(he?F.meta=tr(Ur(Q)):F.chunks.push(Q),s[N].onProgress(T/Ar,_,F.meta),!ye)return;const W=new Uint8Array(F.chunks.reduce((ee,oe)=>ee+oe.byteLength,0));if(F.chunks.reduce((ee,oe)=>(W.set(oe,ee),ee+oe.byteLength),0),delete l[_][N][z],Ne)s[N].onComplete(W,_,F.meta);else{const ee=Ur(W);s[N].onComplete(H?tr(ee):ee,_)}},x=async()=>{await _t(""),await new Promise(_=>setTimeout(_,99)),Qs(r).forEach(([_,A])=>{A.destroy(),delete r[_]}),n()},[R,D]=w(Jt("ping")),[J,V]=w(Jt("pong")),[S,I]=w(Jt("signal")),[Z,_e]=w(Jt("stream")),[xe,Vt]=w(Jt("track")),[_t,jt]=w(Jt("leave"));return t((_,A)=>{r[A]||(r[A]=_,_.setHandlers({data:O=>E(A,O),stream:O=>{c.onPeerStream(O,A,f[A]),delete f[A]},track:(O,N)=>{c.onPeerTrack(O,N,A,g[A]),delete g[A]},signal:O=>S(O,A),close:()=>d(A),error:O=>{console.error(O),d(A)}}),c.onPeerJoin(A))}),D((_,A)=>J("",A)),V((_,A)=>{h[A]?.(),delete h[A]}),I((_,A)=>r[A]?.signal(_)),_e((_,A)=>f[A]=_),Vt((_,A)=>g[A]=_),jt((_,A)=>d(A)),al&&addEventListener("beforeunload",x),{makeAction:w,leave:x,ping:async _=>{if(!_)throw nt("ping() must be called with target peer ID");const A=Date.now();return R("",_),await new Promise(O=>h[_]=O),Date.now()-A},getPeers:()=>ll(Qs(r).map(([_,A])=>[_,A.connection])),addStream:(_,A,O)=>m(A,async(N,z)=>{O&&await Z(O,N),z.addStream(_)}),removeStream:(_,A)=>m(A,(O,N)=>N.removeStream(_)),addTrack:(_,A,O,N)=>m(O,async(z,v)=>{N&&await xe(N,z),v.addTrack(_,A)}),removeTrack:(_,A)=>m(A,(O,N)=>N.removeTrack(_)),replaceTrack:(_,A,O,N)=>m(O,async(z,v)=>{N&&await xe(N,z),v.replaceTrack(_,A)}),onPeerJoin:_=>c.onPeerJoin=_,onPeerLeave:_=>c.onPeerLeave=_,onPeerStream:_=>c.onPeerStream=_,onPeerTrack:_=>c.onPeerTrack=_}},nd=20,rd=5333,ko=57333,sd=({init:t,subscribe:e,announce:n})=>{const r={};let s=!1,i,l,h,f;return(g,c,m)=>{const{appId:d}=g;if(r[d]?.[c])return r[d][c];const w={},E={},x=xr(Zn,d,c),R=Ln(x),D=Ln(xr(x,Yt)),J=Yf(g.password||"",d,c),V=v=>async T=>({type:T.type,sdp:await v(J,T.sdp)}),S=V(Kf),I=V(Wf),Z=()=>bo(!0,g),_e=(v,T,Q)=>{if(E[T]){E[T]!==v&&v.destroy();return}E[T]=v,z(v,T),w[T]?.forEach((ye,he)=>{he!==Q&&ye.destroy()}),delete w[T]},xe=(v,T)=>{E[T]===v&&delete E[T]},Vt=(v,T)=>{if(E[v])return;const Q=w[v]?.[T];Q&&(delete w[v][T],Q.destroy())},_t=v=>(l.push(...Qn(v,Z)),At(l.splice(0,v).map(T=>T.offerPromise.then(I).then(Q=>({peer:T,offer:Q}))))),jt=(v,T)=>m?.({error:`incorrect password (${g.password}) when decrypting ${T}`,appId:d,peerId:v,roomId:c}),_=v=>async(T,Q,ye)=>{const[he,Ne]=await At([R,D]);if(T!==he&&T!==Ne)return;const{peerId:H,offer:F,answer:W,peer:ee}=typeof Q=="string"?tr(Q):Q;if(!(H===Yt||E[H])){if(H&&!F&&!W){if(w[H]?.[v])return;const[[{peer:oe,offer:ae}],fe]=await At([_t(1),Ln(xr(x,H))]);w[H]||=[],w[H][v]=oe,setTimeout(()=>Vt(H,v),A[v]*.9),oe.setHandlers({connect:()=>_e(oe,H,v),close:()=>xe(oe,H)}),ye(fe,er({peerId:Yt,offer:ae}))}else if(F){if(w[H]?.[v]&&Yt>H)return;const ae=bo(!1,g);ae.setHandlers({connect:()=>_e(ae,H,v),close:()=>xe(ae,H)});let fe;try{fe=await S(F)}catch{jt(H,"offer");return}if(ae.isDead)return;const[De,be]=await At([Ln(xr(x,H)),ae.signal(fe)]);ye(De,er({peerId:Yt,answer:await I(be)}))}else if(W){let oe;try{oe=await S(W)}catch{jt(H,"answer");return}if(ee)ee.setHandlers({connect:()=>_e(ee,H,v),close:()=>xe(ee,H)}),ee.signal(oe);else{const ae=w[H]?.[v];ae&&!ae.isDead&&ae.signal(oe)}}}};if(!g)throw nt("requires a config map as the first argument");if(!d&&!g.firebaseApp)throw nt("config map is missing appId field");if(!c)throw nt("roomId argument required");if(!s){const v=t(g);l=Qn(nd,Z),i=Array.isArray(v)?v:[v],s=!0,h=setInterval(()=>l=l.filter(T=>{const Q=Date.now()-T.created<ko;return Q||T.destroy(),Q}),ko*1.03),f=g.manualRelayReconnection?tt:Hf()}const A=i.map(()=>rd),O=[],N=i.map(async(v,T)=>e(await v,await R,await D,_(T),_t));At([R,D]).then(([v,T])=>{const Q=async(ye,he)=>{const Ne=await n(ye,v,T);typeof Ne=="number"&&(A[he]=Ne),O[he]=setTimeout(()=>Q(ye,he),A[he])};N.forEach(async(ye,he)=>{await ye,Q(await i[he],he)})});let z=tt;return r[d]||={},r[d][c]=td(v=>z=v,v=>delete E[v],()=>{delete r[d][c],O.forEach(clearTimeout),N.forEach(async v=>(await v)()),clearInterval(h),f(),s=!1})}},Ns={},fl={},Dn={},Rn={},On={},_o={},vr={},id="announce",dl=20,xo=10,od=33333,ad=120333,ld=3,cd=async t=>{if(Ns[t])return Ns[t];const e=(await Ln(t)).slice(0,dl);return Ns[t]=e,fl[e]=t,e},So=async(t,e,n)=>t.send(er({action:id,info_hash:await cd(e),peer_id:Yt,...n})),Ao=(t,e,n)=>console.warn(`${Zn}: torrent tracker ${n?"failure":"warning"} from ${t} - ${e}`),pl=sd({init:t=>$f(t,ud,ld).map(e=>{const n=jf(e,s=>{const i=tr(s),l=i["failure reason"],h=i["warning message"],{interval:f}=i,g=fl[i.info_hash];if(l){Ao(r,l,!0);return}if(h&&Ao(r,h),f&&f*1e3>On[r]&&Rn[r][g]){const c=Math.min(f*1e3,ad);clearInterval(Dn[r][g]),On[r]=c,Dn[r][g]=setInterval(Rn[r][g],c)}_o[i.offer_id]||(i.offer||i.answer)&&(_o[i.offer_id]=!0,vr[r][g]?.(i))}),{url:r}=n;return vr[r]={},n.ready}),subscribe:(t,e,n,r,s)=>{const{url:i}=t,l=async()=>{const h=ll((await s(xo)).map(f=>[ol(dl),f]));vr[t.url][e]=f=>{if(f.offer)r(e,{offer:f.offer,peerId:f.peer_id},(g,c)=>So(t,e,{answer:tr(c).answer,offer_id:f.offer_id,to_peer_id:f.peer_id}));else if(f.answer){const g=h[f.offer_id];g&&r(e,{answer:f.answer,peerId:f.peer_id,peer:g.peer})}},So(t,e,{numwant:xo,offers:Qs(h).map(([f,{offer:g}])=>({offer_id:f,offer:g}))})};return On[i]=od,Rn[i]||={},Rn[i][e]=l,Dn[i]||={},Dn[i][e]=setInterval(l,On[i]),l(),()=>{clearInterval(Dn[i][e]),delete vr[i][e],delete Rn[i][e]}},announce:t=>On[t.url]}),ud=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.btorrent.xyz","tracker.files.fm:7073/announce"].map(t=>"wss://"+t);var Oe="INUMBER",An="IOP1",vn="IOP2",In="IOP3",ot="IVAR",Bt="IVARNAME",mn="IFUNCALL",ps="IFUNDEF",Ae="IEXPR",Ri="IEXPREVAL",$t="IMEMBER",gs="IENDSTATEMENT",wn="IARRAY";function P(t,e){this.type=t,this.value=e??0}P.prototype.toString=function(){switch(this.type){case Oe:case An:case vn:case In:case ot:case Bt:case gs:return this.value;case mn:return"CALL "+this.value;case ps:return"DEF "+this.value;case wn:return"ARRAY "+this.value;case $t:return"."+this.value;default:return"Invalid Instruction"}};function ms(t){return new P(An,t)}function ft(t){return new P(vn,t)}function gl(t){return new P(In,t)}function ti(t,e,n,r,s){for(var i=[],l=[],h,f,g,c,m=0;m<t.length;m++){var d=t[m],w=d.type;if(w===Oe||w===Bt)Array.isArray(d.value)?i.push.apply(i,ti(d.value.map(function(E){return new P(Oe,E)}).concat(new P(wn,d.value.length)),e,n,r,s)):i.push(d);else if(w===ot&&s.hasOwnProperty(d.value))d=new P(Oe,s[d.value]),i.push(d);else if(w===vn&&i.length>1)f=i.pop(),h=i.pop(),c=n[d.value],d=new P(Oe,c(h.value,f.value)),i.push(d);else if(w===In&&i.length>2)g=i.pop(),f=i.pop(),h=i.pop(),d.value==="?"?i.push(h.value?f.value:g.value):(c=r[d.value],d=new P(Oe,c(h.value,f.value,g.value)),i.push(d));else if(w===An&&i.length>0)h=i.pop(),c=e[d.value],d=new P(Oe,c(h.value)),i.push(d);else if(w===Ae){for(;i.length>0;)l.push(i.shift());l.push(new P(Ae,ti(d.value,e,n,r,s)))}else if(w===$t&&i.length>0)h=i.pop(),i.push(new P(Oe,h.value[d.value]));else{for(;i.length>0;)l.push(i.shift());l.push(d)}}for(;i.length>0;)l.push(i.shift());return l}function ml(t,e,n){for(var r=[],s=0;s<t.length;s++){var i=t[s],l=i.type;if(l===ot&&i.value===e)for(var h=0;h<n.tokens.length;h++){var f=n.tokens[h],g;f.type===An?g=ms(f.value):f.type===vn?g=ft(f.value):f.type===In?g=gl(f.value):g=new P(f.type,f.value),r.push(g)}else l===Ae?r.push(new P(Ae,ml(i.value,e,n))):r.push(i)}return r}function vt(t,e,n){var r=[],s,i,l,h,f,g;if(Oi(t))return et(t,n);for(var c=t.length,m=0;m<c;m++){var d=t[m],w=d.type;if(w===Oe||w===Bt)r.push(d.value);else if(w===vn)i=r.pop(),s=r.pop(),d.value==="and"?r.push(s?!!vt(i,e,n):!1):d.value==="or"?r.push(s?!0:!!vt(i,e,n)):d.value==="="?(h=e.binaryOps[d.value],r.push(h(s,vt(i,e,n),n))):(h=e.binaryOps[d.value],r.push(h(et(s,n),et(i,n))));else if(w===In)l=r.pop(),i=r.pop(),s=r.pop(),d.value==="?"?r.push(vt(s?i:l,e,n)):(h=e.ternaryOps[d.value],r.push(h(et(s,n),et(i,n),et(l,n))));else if(w===ot)if(d.value in e.functions)r.push(e.functions[d.value]);else if(d.value in e.unaryOps&&e.parser.isOperatorEnabled(d.value))r.push(e.unaryOps[d.value]);else{var E=n[d.value];if(E!==void 0)r.push(E);else throw new Error("undefined variable: "+d.value)}else if(w===An)s=r.pop(),h=e.unaryOps[d.value],r.push(h(et(s,n)));else if(w===mn){for(g=d.value,f=[];g-- >0;)f.unshift(et(r.pop(),n));if(h=r.pop(),h.apply&&h.call)r.push(h.apply(void 0,f));else throw new Error(h+" is not a function")}else if(w===ps)r.push((function(){for(var x=r.pop(),R=[],D=d.value;D-- >0;)R.unshift(r.pop());var J=r.pop(),V=function(){for(var S=Object.assign({},n),I=0,Z=R.length;I<Z;I++)S[R[I]]=arguments[I];return vt(x,e,S)};return Object.defineProperty(V,"name",{value:J,writable:!1}),n[J]=V,V})());else if(w===Ae)r.push(hd(d,e));else if(w===Ri)r.push(d);else if(w===$t)s=r.pop(),r.push(s[d.value]);else if(w===gs)r.pop();else if(w===wn){for(g=d.value,f=[];g-- >0;)f.unshift(r.pop());r.push(f)}else throw new Error("invalid Expression")}if(r.length>1)throw new Error("invalid Expression (parity)");return r[0]===0?0:et(r[0],n)}function hd(t,e,n){return Oi(t)?t:{type:Ri,value:function(r){return vt(t.value,e,r)}}}function Oi(t){return t&&t.type===Ri}function et(t,e){return Oi(t)?t.value(e):t}function Ui(t,e){for(var n=[],r,s,i,l,h,f,g=0;g<t.length;g++){var c=t[g],m=c.type;if(m===Oe)typeof c.value=="number"&&c.value<0?n.push("("+c.value+")"):Array.isArray(c.value)?n.push("["+c.value.map(vo).join(", ")+"]"):n.push(vo(c.value));else if(m===vn)s=n.pop(),r=n.pop(),l=c.value,e?l==="^"?n.push("Math.pow("+r+", "+s+")"):l==="and"?n.push("(!!"+r+" && !!"+s+")"):l==="or"?n.push("(!!"+r+" || !!"+s+")"):l==="||"?n.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+r+"),("+s+")))"):l==="=="?n.push("("+r+" === "+s+")"):l==="!="?n.push("("+r+" !== "+s+")"):l==="["?n.push(r+"[("+s+") | 0]"):n.push("("+r+" "+l+" "+s+")"):l==="["?n.push(r+"["+s+"]"):n.push("("+r+" "+l+" "+s+")");else if(m===In)if(i=n.pop(),s=n.pop(),r=n.pop(),l=c.value,l==="?")n.push("("+r+" ? "+s+" : "+i+")");else throw new Error("invalid Expression");else if(m===ot||m===Bt)n.push(c.value);else if(m===An)r=n.pop(),l=c.value,l==="-"||l==="+"?n.push("("+l+r+")"):e?l==="not"?n.push("(!"+r+")"):l==="!"?n.push("fac("+r+")"):n.push(l+"("+r+")"):l==="!"?n.push("("+r+"!)"):n.push("("+l+" "+r+")");else if(m===mn){for(f=c.value,h=[];f-- >0;)h.unshift(n.pop());l=n.pop(),n.push(l+"("+h.join(", ")+")")}else if(m===ps){for(s=n.pop(),f=c.value,h=[];f-- >0;)h.unshift(n.pop());r=n.pop(),e?n.push("("+r+" = function("+h.join(", ")+") { return "+s+" })"):n.push("("+r+"("+h.join(", ")+") = "+s+")")}else if(m===$t)r=n.pop(),n.push(r+"."+c.value);else if(m===wn){for(f=c.value,h=[];f-- >0;)h.unshift(n.pop());n.push("["+h.join(", ")+"]")}else if(m===Ae)n.push("("+Ui(c.value,e)+")");else if(m!==gs)throw new Error("invalid Expression")}return n.length>1&&(e?n=[n.join(",")]:n=[n.join(";")]),String(n[0])}function vo(t){return typeof t=="string"?JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):t}function Kt(t,e){for(var n=0;n<t.length;n++)if(t[n]===e)return!0;return!1}function Bi(t,e,n){n=n||{};for(var r=!!n.withMembers,s=null,i=0;i<t.length;i++){var l=t[i];l.type===ot||l.type===Bt?!r&&!Kt(e,l.value)?e.push(l.value):(s!==null&&(Kt(e,s)||e.push(s)),s=l.value):l.type===$t&&r&&s!==null?s+="."+l.value:l.type===Ae?Bi(l.value,e,n):s!==null&&(Kt(e,s)||e.push(s),s=null)}s!==null&&!Kt(e,s)&&e.push(s)}function Pe(t,e){this.tokens=t,this.parser=e,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.functions=e.functions}Pe.prototype.simplify=function(t){return t=t||{},new Pe(ti(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,t),this.parser)};Pe.prototype.substitute=function(t,e){return e instanceof Pe||(e=this.parser.parse(String(e))),new Pe(ml(this.tokens,t,e),this.parser)};Pe.prototype.evaluate=function(t){return t=t||{},vt(this.tokens,this,t)};Pe.prototype.toString=function(){return Ui(this.tokens,!1)};Pe.prototype.symbols=function(t){t=t||{};var e=[];return Bi(this.tokens,e,t),e};Pe.prototype.variables=function(t){t=t||{};var e=[];Bi(this.tokens,e,t);var n=this.functions;return e.filter(function(r){return!(r in n)})};Pe.prototype.toJSFunction=function(t,e){var n=this,r=new Function(t,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+Ui(this.simplify(e).tokens,!0)+"; }");return function(){return r.apply(n,arguments)}};var nr="TEOF",Y="TOP",ws="TNUMBER",wl="TSTRING",at="TPAREN",yn="TBRACKET",ys="TCOMMA",Li="TNAME",Ni="TSEMICOLON";function yl(t,e,n){this.type=t,this.value=e,this.index=n}yl.prototype.toString=function(){return this.type+": "+this.value};function re(t,e){this.pos=0,this.current=null,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.consts=t.consts,this.expression=e,this.savedPosition=0,this.savedCurrent=null,this.options=t.options,this.parser=t}re.prototype.newToken=function(t,e,n){return new yl(t,e,n??this.pos)};re.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};re.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};re.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(nr,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};re.prototype.isString=function(){var t=!1,e=this.pos,n=this.expression.charAt(e);if(n==="'"||n==='"')for(var r=this.expression.indexOf(n,e+1);r>=0&&this.pos<this.expression.length;){if(this.pos=r+1,this.expression.charAt(r-1)!=="\\"){var s=this.expression.substring(e+1,r);this.current=this.newToken(wl,this.unescape(s),e),t=!0;break}r=this.expression.indexOf(n,r+1)}return t};re.prototype.isParen=function(){var t=this.expression.charAt(this.pos);return t==="("||t===")"?(this.current=this.newToken(at,t),this.pos++,!0):!1};re.prototype.isBracket=function(){var t=this.expression.charAt(this.pos);return(t==="["||t==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken(yn,t),this.pos++,!0):!1};re.prototype.isComma=function(){var t=this.expression.charAt(this.pos);return t===","?(this.current=this.newToken(ys,","),this.pos++,!0):!1};re.prototype.isSemicolon=function(){var t=this.expression.charAt(this.pos);return t===";"?(this.current=this.newToken(Ni,";"),this.pos++,!0):!1};re.prototype.isConst=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var n=this.expression.charAt(e);if(n.toUpperCase()===n.toLowerCase()&&(e===this.pos||n!=="_"&&n!=="."&&(n<"0"||n>"9")))break}if(e>t){var r=this.expression.substring(t,e);if(r in this.consts)return this.current=this.newToken(ws,this.consts[r]),this.pos+=r.length,!0}return!1};re.prototype.isNamedOp=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var n=this.expression.charAt(e);if(n.toUpperCase()===n.toLowerCase()&&(e===this.pos||n!=="_"&&(n<"0"||n>"9")))break}if(e>t){var r=this.expression.substring(t,e);if(this.isOperatorEnabled(r)&&(r in this.binaryOps||r in this.unaryOps||r in this.ternaryOps))return this.current=this.newToken(Y,r),this.pos+=r.length,!0}return!1};re.prototype.isName=function(){for(var t=this.pos,e=t,n=!1;e<this.expression.length;e++){var r=this.expression.charAt(e);if(r.toUpperCase()===r.toLowerCase()){if(e===this.pos&&(r==="$"||r==="_")){r==="_"&&(n=!0);continue}else if(e===this.pos||!n||r!=="_"&&(r<"0"||r>"9"))break}else n=!0}if(n){var s=this.expression.substring(t,e);return this.current=this.newToken(Li,s),this.pos+=s.length,!0}return!1};re.prototype.isWhitespace=function(){for(var t=!1,e=this.expression.charAt(this.pos);(e===" "||e==="	"||e===`
`||e==="\r")&&(t=!0,this.pos++,!(this.pos>=this.expression.length));)e=this.expression.charAt(this.pos);return t};var fd=/^[0-9a-f]{4}$/i;re.prototype.unescape=function(t){var e=t.indexOf("\\");if(e<0)return t;for(var n=t.substring(0,e);e>=0;){var r=t.charAt(++e);switch(r){case"'":n+="'";break;case'"':n+='"';break;case"\\":n+="\\";break;case"/":n+="/";break;case"b":n+="\b";break;case"f":n+="\f";break;case"n":n+=`
`;break;case"r":n+="\r";break;case"t":n+="	";break;case"u":var s=t.substring(e+1,e+5);fd.test(s)||this.parseError("Illegal escape sequence: \\u"+s),n+=String.fromCharCode(parseInt(s,16)),e+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+r+'"')}++e;var i=t.indexOf("\\",e);n+=t.substring(e,i<0?t.length:i),e=i}return n};re.prototype.isComment=function(){var t=this.expression.charAt(this.pos);return t==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};re.prototype.isRadixInteger=function(){var t=this.pos;if(t>=this.expression.length-2||this.expression.charAt(t)!=="0")return!1;++t;var e,n;if(this.expression.charAt(t)==="x")e=16,n=/^[0-9a-f]$/i,++t;else if(this.expression.charAt(t)==="b")e=2,n=/^[01]$/i,++t;else return!1;for(var r=!1,s=t;t<this.expression.length;){var i=this.expression.charAt(t);if(n.test(i))t++,r=!0;else break}return r&&(this.current=this.newToken(ws,parseInt(this.expression.substring(s,t),e)),this.pos=t),r};re.prototype.isNumber=function(){for(var t=!1,e=this.pos,n=e,r=e,s=!1,i=!1,l;e<this.expression.length&&(l=this.expression.charAt(e),l>="0"&&l<="9"||!s&&l===".");)l==="."?s=!0:i=!0,e++,t=i;if(t&&(r=e),l==="e"||l==="E"){e++;for(var h=!0,f=!1;e<this.expression.length;){if(l=this.expression.charAt(e),h&&(l==="+"||l==="-"))h=!1;else if(l>="0"&&l<="9")f=!0,h=!1;else break;e++}f||(e=r)}return t?(this.current=this.newToken(ws,parseFloat(this.expression.substring(n,e))),this.pos=e):this.pos=r,t};re.prototype.isOperator=function(){var t=this.pos,e=this.expression.charAt(this.pos);if(e==="+"||e==="-"||e==="*"||e==="/"||e==="%"||e==="^"||e==="?"||e===":"||e===".")this.current=this.newToken(Y,e);else if(e===""||e==="")this.current=this.newToken(Y,"*");else if(e===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(Y,">="),this.pos++):this.current=this.newToken(Y,">");else if(e==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(Y,"<="),this.pos++):this.current=this.newToken(Y,"<");else if(e==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(Y,"||"),this.pos++;else return!1;else if(e==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(Y,"=="),this.pos++):this.current=this.newToken(Y,e);else if(e==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(Y,"!="),this.pos++):this.current=this.newToken(Y,e);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=t,!1)};re.prototype.isOperatorEnabled=function(t){return this.parser.isOperatorEnabled(t)};re.prototype.getCoordinates=function(){var t=0,e,n=-1;do t++,e=this.pos-n,n=this.expression.indexOf(`
`,n+1);while(n>=0&&n<this.pos);return{line:t,column:e}};re.prototype.parseError=function(t){var e=this.getCoordinates();throw new Error("parse error ["+e.line+":"+e.column+"]: "+t)};function K(t,e,n){this.parser=t,this.tokens=e,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=n.allowMemberAccess!==!1}K.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};K.prototype.tokenMatches=function(t,e){return typeof e>"u"?!0:Array.isArray(e)?Kt(e,t.value):typeof e=="function"?e(t):t.value===e};K.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};K.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};K.prototype.accept=function(t,e){return this.nextToken.type===t&&this.tokenMatches(this.nextToken,e)?(this.next(),!0):!1};K.prototype.expect=function(t,e){if(!this.accept(t,e)){var n=this.tokens.getCoordinates();throw new Error("parse error ["+n.line+":"+n.column+"]: Expected "+(e||t))}};K.prototype.parseAtom=function(t){var e=this.tokens.unaryOps;function n(s){return s.value in e}if(this.accept(Li)||this.accept(Y,n))t.push(new P(ot,this.current.value));else if(this.accept(ws))t.push(new P(Oe,this.current.value));else if(this.accept(wl))t.push(new P(Oe,this.current.value));else if(this.accept(at,"("))this.parseExpression(t),this.expect(at,")");else if(this.accept(yn,"["))if(this.accept(yn,"]"))t.push(new P(wn,0));else{var r=this.parseArrayList(t);t.push(new P(wn,r))}else throw new Error("unexpected "+this.nextToken)};K.prototype.parseExpression=function(t){var e=[];this.parseUntilEndStatement(t,e)||(this.parseVariableAssignmentExpression(e),!this.parseUntilEndStatement(t,e)&&this.pushExpression(t,e))};K.prototype.pushExpression=function(t,e){for(var n=0,r=e.length;n<r;n++)t.push(e[n])};K.prototype.parseUntilEndStatement=function(t,e){return this.accept(Ni)?(this.nextToken&&this.nextToken.type!==nr&&!(this.nextToken.type===at&&this.nextToken.value===")")&&e.push(new P(gs)),this.nextToken.type!==nr&&this.parseExpression(e),t.push(new P(Ae,e)),!0):!1};K.prototype.parseArrayList=function(t){for(var e=0;!this.accept(yn,"]");)for(this.parseExpression(t),++e;this.accept(ys);)this.parseExpression(t),++e;return e};K.prototype.parseVariableAssignmentExpression=function(t){for(this.parseConditionalExpression(t);this.accept(Y,"=");){var e=t.pop(),n=[],r=t.length-1;if(e.type===mn){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var s=0,i=e.value+1;s<i;s++){var l=r-s;t[l].type===ot&&(t[l]=new P(Bt,t[l].value))}this.parseVariableAssignmentExpression(n),t.push(new P(Ae,n)),t.push(new P(ps,e.value));continue}if(e.type!==ot&&e.type!==$t)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(n),t.push(new P(Bt,e.value)),t.push(new P(Ae,n)),t.push(ft("="))}};K.prototype.parseConditionalExpression=function(t){for(this.parseOrExpression(t);this.accept(Y,"?");){var e=[],n=[];this.parseConditionalExpression(e),this.expect(Y,":"),this.parseConditionalExpression(n),t.push(new P(Ae,e)),t.push(new P(Ae,n)),t.push(gl("?"))}};K.prototype.parseOrExpression=function(t){for(this.parseAndExpression(t);this.accept(Y,"or");){var e=[];this.parseAndExpression(e),t.push(new P(Ae,e)),t.push(ft("or"))}};K.prototype.parseAndExpression=function(t){for(this.parseComparison(t);this.accept(Y,"and");){var e=[];this.parseComparison(e),t.push(new P(Ae,e)),t.push(ft("and"))}};var dd=["==","!=","<","<=",">=",">","in"];K.prototype.parseComparison=function(t){for(this.parseAddSub(t);this.accept(Y,dd);){var e=this.current;this.parseAddSub(t),t.push(ft(e.value))}};var pd=["+","-","||"];K.prototype.parseAddSub=function(t){for(this.parseTerm(t);this.accept(Y,pd);){var e=this.current;this.parseTerm(t),t.push(ft(e.value))}};var gd=["*","/","%"];K.prototype.parseTerm=function(t){for(this.parseFactor(t);this.accept(Y,gd);){var e=this.current;this.parseFactor(t),t.push(ft(e.value))}};K.prototype.parseFactor=function(t){var e=this.tokens.unaryOps;function n(s){return s.value in e}if(this.save(),this.accept(Y,n)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===at&&this.nextToken.value==="("){this.restore(),this.parseExponential(t);return}else if(this.nextToken.type===Ni||this.nextToken.type===ys||this.nextToken.type===nr||this.nextToken.type===at&&this.nextToken.value===")"){this.restore(),this.parseAtom(t);return}}var r=this.current;this.parseFactor(t),t.push(ms(r.value))}else this.parseExponential(t)};K.prototype.parseExponential=function(t){for(this.parsePostfixExpression(t);this.accept(Y,"^");)this.parseFactor(t),t.push(ft("^"))};K.prototype.parsePostfixExpression=function(t){for(this.parseFunctionCall(t);this.accept(Y,"!");)t.push(ms("!"))};K.prototype.parseFunctionCall=function(t){var e=this.tokens.unaryOps;function n(i){return i.value in e}if(this.accept(Y,n)){var r=this.current;this.parseAtom(t),t.push(ms(r.value))}else for(this.parseMemberExpression(t);this.accept(at,"(");)if(this.accept(at,")"))t.push(new P(mn,0));else{var s=this.parseArgumentList(t);t.push(new P(mn,s))}};K.prototype.parseArgumentList=function(t){for(var e=0;!this.accept(at,")");)for(this.parseExpression(t),++e;this.accept(ys);)this.parseExpression(t),++e;return e};K.prototype.parseMemberExpression=function(t){for(this.parseAtom(t);this.accept(Y,".")||this.accept(yn,"[");){var e=this.current;if(e.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(Li),t.push(new P($t,this.current.value))}else if(e.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(t),this.expect(yn,"]"),t.push(ft("["))}else throw new Error("unexpected symbol: "+e.value)}};function md(t,e){return Number(t)+Number(e)}function wd(t,e){return t-e}function yd(t,e){return t*e}function bd(t,e){return t/e}function Ed(t,e){return t%e}function kd(t,e){return Array.isArray(t)&&Array.isArray(e)?t.concat(e):""+t+e}function _d(t,e){return t===e}function xd(t,e){return t!==e}function Sd(t,e){return t>e}function Ad(t,e){return t<e}function vd(t,e){return t>=e}function Id(t,e){return t<=e}function Cd(t,e){return!!(t&&e)}function Td(t,e){return!!(t||e)}function Md(t,e){return Kt(e,t)}function Dd(t){return(Math.exp(t)-Math.exp(-t))/2}function Rd(t){return(Math.exp(t)+Math.exp(-t))/2}function Od(t){return t===1/0?1:t===-1/0?-1:(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t))}function Ud(t){return t===-1/0?t:Math.log(t+Math.sqrt(t*t+1))}function Bd(t){return Math.log(t+Math.sqrt(t*t-1))}function Ld(t){return Math.log((1+t)/(1-t))/2}function Io(t){return Math.log(t)*Math.LOG10E}function Nd(t){return-t}function Fd(t){return!t}function $d(t){return t<0?Math.ceil(t):Math.floor(t)}function Pd(t){return Math.random()*(t||1)}function Co(t){return Fi(t+1)}function Vd(t){return isFinite(t)&&t===Math.round(t)}var jd=4.7421875,Fs=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function Fi(t){var e,n;if(Vd(t)){if(t<=0)return isFinite(t)?1/0:NaN;if(t>171)return 1/0;for(var r=t-2,s=t-1;r>1;)s*=r,r--;return s===0&&(s=1),s}if(t<.5)return Math.PI/(Math.sin(Math.PI*t)*Fi(1-t));if(t>=171.35)return 1/0;if(t>85){var i=t*t,l=i*t,h=l*t,f=h*t;return Math.sqrt(2*Math.PI/t)*Math.pow(t/Math.E,t)*(1+1/(12*t)+1/(288*i)-139/(51840*l)-571/(2488320*h)+163879/(209018880*f)+5246819/(75246796800*f*t))}--t,n=Fs[0];for(var g=1;g<Fs.length;++g)n+=Fs[g]/(t+g);return e=t+jd+.5,Math.sqrt(2*Math.PI)*Math.pow(e,t+.5)*Math.exp(-e)*n}function Hd(t){return Array.isArray(t)?t.length:String(t).length}function To(){for(var t=0,e=0,n=0;n<arguments.length;n++){var r=Math.abs(arguments[n]),s;e<r?(s=e/r,t=t*s*s+1,e=r):r>0?(s=r/e,t+=s*s):t+=r}return e===1/0?1/0:e*Math.sqrt(t)}function Mo(t,e,n){return t?e:n}function qd(t,e){return typeof e>"u"||+e==0?Math.round(t):(t=+t,e=-+e,isNaN(t)||!(typeof e=="number"&&e%1===0)?NaN:(t=t.toString().split("e"),t=Math.round(+(t[0]+"e"+(t[1]?+t[1]-e:-e))),t=t.toString().split("e"),+(t[0]+"e"+(t[1]?+t[1]+e:e))))}function Gd(t,e,n){return n&&(n[t]=e),e}function Jd(t,e){return t[e|0]}function zd(t){return arguments.length===1&&Array.isArray(t)?Math.max.apply(Math,t):Math.max.apply(Math,arguments)}function Yd(t){return arguments.length===1&&Array.isArray(t)?Math.min.apply(Math,t):Math.min.apply(Math,arguments)}function Wd(t,e){if(typeof t!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(e))throw new Error("Second argument to map is not an array");return e.map(function(n,r){return t(n,r)})}function Kd(t,e,n){if(typeof t!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(n))throw new Error("Second argument to fold is not an array");return n.reduce(function(r,s,i){return t(r,s,i)},e)}function Xd(t,e){if(typeof t!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(e))throw new Error("Second argument to filter is not an array");return e.filter(function(n,r){return t(n,r)})}function Zd(t,e){if(!(Array.isArray(e)||typeof e=="string"))throw new Error("Second argument to indexOf is not a string or array");return e.indexOf(t)}function Qd(t,e){if(!Array.isArray(e))throw new Error("Second argument to join is not an array");return e.join(t)}function ep(t){return(t>0)-(t<0)||+t}var Do=1/3;function tp(t){return t<0?-Math.pow(-t,Do):Math.pow(t,Do)}function np(t){return Math.exp(t)-1}function rp(t){return Math.log(1+t)}function sp(t){return Math.log(t)/Math.LN2}function kt(t){this.options=t||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||Dd,cosh:Math.cosh||Rd,tanh:Math.tanh||Od,asinh:Math.asinh||Ud,acosh:Math.acosh||Bd,atanh:Math.atanh||Ld,sqrt:Math.sqrt,cbrt:Math.cbrt||tp,log:Math.log,log2:Math.log2||sp,ln:Math.log,lg:Math.log10||Io,log10:Math.log10||Io,expm1:Math.expm1||np,log1p:Math.log1p||rp,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||$d,"-":Nd,"+":Number,exp:Math.exp,not:Fd,length:Hd,"!":Co,sign:Math.sign||ep},this.binaryOps={"+":md,"-":wd,"*":yd,"/":bd,"%":Ed,"^":Math.pow,"||":kd,"==":_d,"!=":xd,">":Sd,"<":Ad,">=":vd,"<=":Id,and:Cd,or:Td,in:Md,"=":Gd,"[":Jd},this.ternaryOps={"?":Mo},this.functions={random:Pd,fac:Co,min:Yd,max:zd,hypot:Math.hypot||To,pyt:Math.hypot||To,pow:Math.pow,atan2:Math.atan2,if:Mo,gamma:Fi,roundTo:qd,map:Wd,fold:Kd,filter:Xd,indexOf:Zd,join:Qd},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}kt.prototype.parse=function(t){var e=[],n=new K(this,new re(this,t),{allowMemberAccess:this.options.allowMemberAccess});return n.parseExpression(e),n.expect(nr,"EOF"),new Pe(e,this)};kt.prototype.evaluate=function(t,e){return this.parse(t).evaluate(e)};var bl=new kt;kt.parse=function(t){return bl.parse(t)};kt.evaluate=function(t,e){return bl.parse(t).evaluate(e)};var Ro={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function ip(t){return Ro.hasOwnProperty(t)?Ro[t]:t}kt.prototype.isOperatorEnabled=function(t){var e=ip(t),n=this.options.operators||{};return!(e in n)||!!n[e]};const Op={NEXT_ROLL:"Prxima Rolagem",ROUNDS:"Rodadas",MINUTES:"Minutos",HOURS:"Horas",DAYS:"Dias",LUCK_ENDS:"Sorte Encerra",PERMANENT:"Indeterminado",END_OF_ROUND:"Fim da Rodada",CONCENTRATION:"Concentrao"},an={ADD:"ADD",SET:"SET",MULT:"MULT"},Up={str:"Fora",agi:"Agilidade",int:"Intelecto",wil:"Vontade",defense:"Defesa",speed:"Deslocamento",health:"Vida",damage:"Dano (Dados)",boons:"Boons/Banes",healing_rate:"Taxa de Cura"},pt={WEAPON:"Weapon",ARMOR:"Armor",SHIELD:"Shield",CONSUMABLE:"Consumable",EXPLOSIVE:"Explosive",OTHER:"Other"},Bp=["Aeromancy","Alchemy","Alteration","Animism","Astromancy","Chaos","Chronomancy","Conjuration","Cryomancy","Dark Arts","Destruction","Divination","Eldritch","Enchantment","Evocation","Geomancy","Hydromancy","Illusion","Invocation","Necromancy","Oneiromancy","Order","Primal","Protection","Psychomancy","Pyromancy","Shadowmancy","Skullduggery","Spiritualism","Symbolism","Technomancy","Teleportation","War"],op=[[1,0,0,0,0,0,0,0,0,0,0],[2,1,0,0,0,0,0,0,0,0,0],[3,2,1,0,0,0,0,0,0,0,0],[4,2,1,1,0,0,0,0,0,0,0],[5,2,2,1,1,0,0,0,0,0,0],[6,3,2,2,1,1,0,0,0,0,0],[7,3,2,2,2,1,1,0,0,0,0],[8,3,2,2,2,1,1,1,0,0,0],[9,3,3,2,2,2,1,1,1,0,0],[10,3,3,3,2,2,1,1,1,1,0],[11,3,3,3,3,2,1,1,1,1,1]],Lp=["Air","Alteration","Arcana","Battle","Celestial","Chaos","Conjuration","Curse","Death","Demonology","Destruction","Divination","Enchantment","Ether","Fey","Fire","Forbidden","Illusion","Life","Metal","Nature","Necromancy","Order","Primal","Protection","Rune","Shadow","Song","Soul","Spiritualism","Storm","Technomancy","Telekinesis","Telepathy","Teleportation","Theurgy","Time","Transformation","Water"];function Np(t,e){return t<0||t>10||e<0||e>10?0:op[t]?.[e]??0}const ap=new kt,lp={name:"",level:1,ancestry:"",paths:{novice:"",expert:"",master:""},attributes:[{name:"Strength",value:10,key:"str"},{name:"Agility",value:10,key:"agi"},{name:"Intellect",value:10,key:"int"},{name:"Will",value:10,key:"wil"}],currency:{gp:0,sp:0,cp:0},naturalDefense:10,bonusDamage:0,speed:10,currentRound:1,languages:[],senses:[],afflictions:[],effects:[],notes:"",campaignId:null,campaignName:null,gmName:null,combatActive:!1,initiative:!1,acted:!1,spells:[],talents:[],equipment:[]},C=Me(JSON.parse(JSON.stringify(lp))),Fr=Me([]),Xt=Me({type:null,isOpen:!1,data:null}),Fp=Me("acoes"),$i=Me(24),Cn=Me(24),bn=Me(0),rr=Me(!1),Pi=Me(!1),Oo={autoOpenHistory:!1,stickyHistory:!1,theme:"dark"};function cp(){const t=typeof localStorage<"u"?localStorage.getItem("wwv_app_settings"):null,{subscribe:e,set:n,update:r}=Me(t?{...Oo,...JSON.parse(t)}:Oo);return{subscribe:e,set:s=>{typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(s)),n(s)},update:s=>{r(i=>{const l=s(i);return typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(l)),l})}}}const El=cp();rr.subscribe(t=>{t&&Pi.set(!1)});const gr=ue(C,t=>{const e=t.effects.filter(r=>r.isActive),n=t.talents.filter(r=>(r.isPassive||r.activityType==="Passive")&&r.effect).map(r=>({...r.effect,id:`talent-effect-${r.id}`,name:r.name,sourceType:"talent",sourceId:r.id}));return[...e,...n]});function ln(t,e){if(typeof t=="number")return t;if(!t)return 0;const n=String(t).trim();if(!isNaN(Number(n)))return Number(n);try{const r={};Array.isArray(e.attributes)&&e.attributes.forEach(i=>{r[i.key]=i.value}),r.level=e.level||0,r.defense=e.naturalDefense||0,r.speed=e.speed||0,r.bonusDamage=e.bonusDamage||0,r.currentRound=e.currentRound||0;const s=n.replace(/@(\w+)/g,"$1");return ap.evaluate(s,r)}catch{return 0}}function bs(t,e,n,r){let s=e||0;const i=n.flatMap(g=>Array.isArray(g.modifiers)?g.modifiers:[]),l=i.filter(g=>g.target===t&&g.type===an.SET);return l.length>0&&(s=ln(l[l.length-1].value,r)),i.filter(g=>g.target===t&&g.type===an.ADD).forEach(g=>{s+=ln(g.value,r)}),i.filter(g=>g.target===t&&g.type===an.MULT).forEach(g=>{s*=ln(g.value,r)}),Math.floor(s)}const kl=ue([C,gr],([t,e])=>{const n={};return Array.isArray(t.attributes)&&t.attributes.forEach(r=>{n[r.key]=bs(r.key,r.value,e,t)}),n}),up=ue([C,Cn,gr],([t,e,n])=>bs("health",e,n,t)),$p=ue([up,$i],([t,e])=>Math.max(0,t-e)),Pp=ue([bn,Cn],([t,e])=>e>0?Math.min(100,t/e*100):100),hp=ue([bn,Cn],([t,e])=>t>=e),Vp=ue([bn,Cn,hp],([t,e,n])=>t>=e/2&&!n),jp=ue([C,kl,gr],([t,e,n])=>{let r=bs("speed",t.speed,n,t);const s=t.afflictions;return s.includes("Held")||s.includes("Stunned")||s.includes("Unconscious")||s.includes("Incapacitated")?0:((s.includes("Blinded")||s.includes("Weakened"))&&(r=Math.floor(r/2)),s.includes("Slowed")&&(r=Math.min(r,2)),Math.max(0,r))}),Hp=ue([C,gr],([t,e])=>{let n=t.naturalDefense,r=0;const s=t.equipment.find(i=>i.type===pt.ARMOR&&i.equipped);if(s){const i=s.defenseFixed||0,l=t.naturalDefense+(s.defenseMod||0);s.defenseFixed&&s.defenseMod?n=Math.max(i,l):s.defenseFixed?n=i:s.defenseMod&&(n=t.naturalDefense+s.defenseMod)}return t.equipment.filter(i=>i.type===pt.SHIELD&&i.equippedState).forEach(i=>{r+=i.defenseMod||0}),bs("defense",n+r,e,t)});ue([C,gr],([t,e])=>{const r=e.flatMap(s=>Array.isArray(s.modifiers)?s.modifiers:[]).filter(s=>s.target==="damage"&&s.type===an.ADD).reduce((s,i)=>s+ln(i.value,t),0);return(t.bonusDamage||0)+r});const Fe={updateCurrency:(t,e)=>{C.update(n=>{let r=n.currency.gp*100+n.currency.sp*10+n.currency.cp,s=0;return t==="gp"&&(s=e*100),t==="sp"&&(s=e*10),t==="cp"&&(s=e),r+=s,r<0&&(r=0),{...n,currency:{gp:Math.floor(r/100),sp:Math.floor(r%100/10),cp:r%100%10}}})},advanceRound:t=>{C.update(e=>{const n=e.currentRound||1;if(t==="next"){const r=(e.effects||[]).map(s=>{if(s.isActive&&s.duration==="ROUNDS"&&s.roundsLeft>0){const i=s.roundsLeft-1;return i<=0?{...s,roundsLeft:0,isActive:!1}:{...s,roundsLeft:i}}return s});return{...e,currentRound:n+1,effects:r}}else return{...e,currentRound:Math.max(1,n-1)}})},addToHistory:(t,e=!0)=>{const n=j(C),r=j(Fr);if(t.id&&r.find(l=>l.id===t.id))return;const s={id:t.id||Pn(),timestamp:t.timestamp||new Date,charName:n.name,source:t.source||"gm",name:t.name||"Action",...t};Fr.update(l=>[s,...l]),j(El).autoOpenHistory?rr.set(!0):j(rr)||Pi.set(!0),e&&n.campaignId&&Ps(async()=>{const{syncRoll:l}=await Promise.resolve().then(()=>si);return{syncRoll:l}},void 0,import.meta.url).then(({syncRoll:l})=>{l(s)})},clearHistory:()=>Fr.set([]),addItem:t=>C.update(e=>({...e,equipment:[...e.equipment,t]})),updateItem:t=>C.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?t:n)})),deleteItem:t=>C.update(e=>({...e,equipment:e.equipment.filter(n=>n.id!==t)})),useConsumable:t=>{if(t.quantity>0){const e=j(rt);Fe.updateItem({...t,quantity:t.quantity-1}),Fe.addToHistory({source:"item",name:t.name,description:e("sofww.item_types.consumable")+`: ${t.name}`})}},equipItem:(t,e=null)=>{C.update(n=>{let r=[...n.equipment];return t.type===pt.ARMOR?r=r.map(s=>s.id===t.id?{...s,equipped:!s.equipped}:s.type===pt.ARMOR&&t.type===pt.ARMOR&&!t.equipped?{...s,equipped:!1}:s):(t.type===pt.WEAPON||t.type===pt.SHIELD)&&(r=r.map(s=>s.id===t.id?{...s,equippedState:e}:s)),{...n,equipment:r}})},toggleAffliction:t=>{C.update(e=>e.afflictions.includes(t)?{...e,afflictions:e.afflictions.filter(n=>n!==t)}:{...e,afflictions:[...e.afflictions,t]})},addLanguage:t=>C.update(e=>({...e,languages:[...e.languages,t]})),removeLanguage:t=>C.update(e=>({...e,languages:e.languages.filter((n,r)=>r!==t)})),addSense:t=>C.update(e=>({...e,senses:[...e.senses||[],t]})),removeSense:t=>C.update(e=>({...e,senses:(e.senses||[]).filter((n,r)=>r!==t)})),confirmRest:()=>{C.update(e=>{const n=e.spells.map(s=>({...s,castings:s.maxCastings})),r=e.talents.map(s=>({...s,uses:s.maxUses}));return{...e,spells:n,talents:r}}),bn.set(0);const t=j($i);Cn.set(t),Xt.set({type:null,isOpen:!1,data:null})},finalizeRoll:(t,e,n=[])=>{const r=j(C),s=j(kl),i=j(rt),l=t.type==="weapon_attack",h=t.type==="luck",f=t.type==="weapon_damage",g=t?.source,c=g?.name||i("common.labels.action"),m=(d,w)=>d.traits&&d.traits.toLowerCase().includes(w.toLowerCase());if(f){let d=parseInt(g.damageDice)||0;const w=g.grip&&g.grip.toLowerCase()==="two"||g.equippedState&&g.equippedState.toLowerCase()==="two";m(g,"Versatile")&&w&&(d+=1);let E=r.bonusDamage||0;m(g,"Light")&&E>1&&(E-=1);const x=n.flatMap(I=>Array.isArray(I.modifiers)?I.modifiers:[]).filter(I=>I.target==="damage"&&I.type===an.ADD).reduce((I,Z)=>I+ln(Z.value,r),0),R=E+x,D=Math.max(0,d+R+e);let J=[],V=0,S=[];for(let I=0;I<D;I++){let Z=Math.floor(Math.random()*6)+1;if(Z===1&&m(g,"Brutal")){const _e=Math.floor(Math.random()*6)+1;S.push(`1->${_e}`),Z=_e}else S.push(`${Z}`);J.push(Z),V+=Z}bn.set(V),Fe.addToHistory({source:"damage",name:g.name,description:`${i("history.source.damage")}: ${D}d6 ${m(g,"Brutal")?"(Brutal)":""}`,formula:`${D}d6 [${J.join(", ")}] ${S.some(I=>I.includes("->"))?`(Rolagens: ${S.join(", ")})`:""}`,total:V,effectsApplied:n.map(I=>I.name)}),g.type===pt.EXPLOSIVE&&Fe.useConsumable(g)}else{const d=Math.floor(Math.random()*20)+1;let w=0,E=i("history.source.luck");if(t.type==="attribute")w=(s[t.source.key]||t.source.value)-10,E=i(`sofww.attributes.${t.source.key}`);else if(l){let S="str",I=i("sofww.attributes.str");g.range==="Ranged"&&(S="agi",I=i("sofww.attributes.agi"),m(g,"Thrown")&&(S="str",I=i("sofww.attributes.str"))),m(g,"Nimble")&&(S="agi",I=i("sofww.attributes.agi")),w=(s[S]||10)-10,E=I}const x=Math.floor(n.flatMap(S=>Array.isArray(S.modifiers)?S.modifiers:[]).filter(S=>S.target==="boons"&&S.type===an.ADD).reduce((S,I)=>S+ln(I.value,r),0));e+=x;let R=0,D="";if(e!==0){const S=Math.abs(e);let I=[];for(let _e=0;_e<S;_e++)I.push(Math.floor(Math.random()*6)+1);const Z=Math.max(...I);e>0?(R=Z,D=` + ${Z} [${i("sofdl.rolls.boon")}]`):(R=-Z,D=` - ${Z} [${i("sofdl.rolls.bane")}]`)}const J=d+w+R;let V="";if(l?V=`${i("history.source.attack")} (${E})`:h?V=i("history.source.luck"):V=`${i("history.source.attribute")}: ${c}`,e!==0&&(V+=` ${i("sofdl.rolls.attribute_test",{values:{attr:"",modifier:e}}).replace(/^[^ ]+ /,"")}`),l&&d===20){let S=[];m(g,"Bludgeoning")&&S.push(i("sofww.afflictions.vulnerable.name")),m(g,"Piercing")&&S.push(i("sofww.afflictions.weakened.name")),m(g,"Slashing")&&S.push("+1d6 Dmg"),S.length>0&&(V+=`
CRTICO! ${S.join(" ")} `)}Fe.addToHistory({source:l?"attack":h?"luck":"attribute",name:c,description:V,formula:`d20(${d})${w!==0?(w>=0?"+":"")+w:""}${D} `,total:J,crit:d===20,effectsApplied:n.map(S=>S.name)}),C.update(S=>({...S,effects:S.effects.map(I=>I.isActive&&I.duration==="NEXT_ROLL"?{...I,isActive:!1}:I)})),l&&m(g,"Reload")&&C.update(S=>({...S,equipment:S.equipment.map(I=>I.id===g.id?{...I,isLoaded:!1}:I)}))}Xt.set({type:null,isOpen:!1,data:null})},reloadWeapon:t=>{const e=j(rt);C.update(n=>({...n,equipment:n.equipment.map(r=>r.id===t.id?{...r,isLoaded:!0}:r)})),Fe.addToHistory({source:"attribute",name:e("actions.reload"),description:`${e("actions.reload")}: ${t.name}`})},addSpell:t=>C.update(e=>({...e,spells:[...e.spells,t]})),updateSpell:t=>C.update(e=>({...e,spells:e.spells.map(n=>n.id===t.id?t:n)})),deleteSpell:t=>C.update(e=>({...e,spells:e.spells.filter(n=>n.id!==t)})),commitSpellCast:t=>{t.castings>0&&(C.update(e=>({...e,spells:e.spells.map(n=>n.id===t.id?{...n,castings:n.castings-1}:n)})),Fe.addToHistory({source:"spell",name:t.name,description:t.description}),Xt.set({type:null,isOpen:!1,data:null}))},addTalent:t=>C.update(e=>({...e,talents:[...e.talents,t]})),updateTalent:t=>C.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?t:n)})),deleteTalent:t=>C.update(e=>({...e,talents:e.talents.filter(n=>n.id!==t)})),commitTalentUse:t=>{t.activityType==="Duration"&&t.duration==="LUCK_ENDS"?C.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?{...n,uses:0}:n)})):t.maxUses&&C.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?{...n,uses:n.uses-1}:n)})),Fe.addToHistory({source:"talent",name:t.name,description:t.description}),Xt.set({type:null,isOpen:!1,data:null})},recoverTalent:t=>{C.update(e=>({...e,talents:e.talents.map(n=>n.id===t&&n.uses<n.maxUses?{...n,uses:(n.uses||0)+1}:n)}))},rollLuckTalent:t=>{const e=j(rt),n=Math.floor(Math.random()*20)+1,r=n>=10,i=j(C).talents.find(l=>l.id===t);Fe.addToHistory({source:"luck",name:`${e("character.history.source.luck")} - ${i?.name||e("character.talents.title")}`,formula:`d20(${n})`,total:n,description:r?e("character.dice_roll.luck_success",{values:{total:n}}):e("character.dice_roll.luck_failure",{values:{total:n}})}),r&&C.update(l=>({...l,talents:l.talents.map(h=>h.id===t?{...h,uses:1}:h)}))},addEffect:t=>C.update(e=>({...e,effects:[...e.effects,t]})),updateEffect:t=>C.update(e=>({...e,effects:e.effects.map(n=>n.id===t.id?t:n)})),deleteEffect:t=>C.update(e=>({...e,effects:e.effects.filter(n=>n.id!==t)})),toggleEffect:t=>C.update(e=>({...e,effects:e.effects.map(n=>{if(n.id===t){const r=!n.isActive;return{...n,isActive:r,roundsLeft:r&&n.duration==="ROUNDS"&&n.initialRounds||n.roundsLeft}}return n})})),cleanInactiveEffects:()=>C.update(t=>({...t,effects:t.effects.filter(e=>e.isActive)})),applyEffectToCharacter:(t,e)=>{const n=t.name||(e?e.name:"Effect"),r=t.description||(e?e.description:""),s={id:Pn(),isActive:!0,name:n,description:r,roundsLeft:0,duration:"PERMANENT",modifiers:[],...t};s.duration==="ROUNDS"&&!s.initialRounds&&(s.initialRounds=s.roundsLeft),C.update(i=>({...i,effects:[...i.effects,s]}))},checkLuckEnds:t=>{const e=j(rt),n=Math.floor(Math.random()*20)+1,r=n>=10;Fe.addToHistory({source:"luck",name:e("sofww.duration.luck_ends"),description:r?e("character.dice_roll.luck_success",{values:{total:n}}):e("character.dice_roll.luck_failure",{values:{total:n}})}),r&&C.update(s=>({...s,effects:s.effects.map(i=>i.id===t?{...i,isActive:!1}:i)}))},joinCampaign:t=>{C.update(e=>({...e,campaignId:t.id,campaignName:t.name,gmName:t.gmName||"Game Master"})),Ps(async()=>{const{joinCampaignRoom:e}=await Promise.resolve().then(()=>si);return{joinCampaignRoom:e}},void 0,import.meta.url).then(({joinCampaignRoom:e})=>{e(t.id,!1)})},leaveCampaign:()=>{C.update(t=>({...t,campaignId:null,campaignName:null,gmName:null,combatActive:!1}))}},fp=new kt,dp={id:"",system:"sofdl",name:"",ancestry:"",level:0,paths:{novice:"",expert:"",master:""},imageUrl:"",attributes:{strength:10,agility:10,intellect:10,will:10},perception:10,defense:10,health:10,healingRate:2,size:1,speed:10,power:0,damage:0,insanity:0,corruption:0,description:"",notes:"",professions:[],languages:["Comum"],senses:[],afflictions:[],talents:[],spells:[],equipment:[],currency:{gc:0,ss:0,cp:0,bits:0},effects:[],campaignId:null,campaignName:null,gmName:null,campaignApproval:null,combatActive:!1,currentRound:1,initiative:!1,acted:!1,magicSystem:"standard"},M=Me(JSON.parse(JSON.stringify(dp))),pp=ue(M,t=>t.effects.filter(e=>e.isActive)),Pt=ue([M,pp],([t,e])=>{const n={strength:t.attributes.strength,agility:t.attributes.agility,intellect:t.attributes.intellect,will:t.attributes.will,perception:t.perception,defense:t.defense,health:t.health,speed:t.speed,healingRate:t.healingRate,power:t.power,boons:0},r=[];e.forEach(l=>{l.modifiers&&l.modifiers.forEach(h=>{r.push(h)})});const s=l=>l==="healing_rate"?"healingRate":l;return Object.keys(n).forEach(l=>{const h=r.filter(c=>s(c.target)===l);if(h.length===0)return;const f=h.filter(c=>c.type==="SET");if(f.length>0){const c=f[f.length-1];n[l]=$s(c.value,t)}f.length===0&&h.filter(m=>m.type==="ADD").forEach(m=>{n[l]+=$s(m.value,t)}),h.filter(c=>c.type==="MULT").forEach(c=>{n[l]*=$s(c.value,t)}),n[l]=Math.floor(n[l])}),{strength:n.strength,agility:n.agility,intellect:n.intellect,will:n.will,perception:n.perception,defense:n.defense,health:n.health,speed:n.speed,healingRate:n.healingRate,power:n.power,boons:n.boons}}),qp=ue(Pt,t=>({strength:t.strength,agility:t.agility,intellect:t.intellect,will:t.will})),gp=ue(Pt,t=>({strength:t.strength-10,agility:t.agility-10,intellect:t.intellect-10,will:t.will-10}));ue([M,Pt],([t,e])=>e.health-t.damage);ue([M,Pt],([t,e])=>t.damage>=e.health/2);ue([M,Pt],([t,e])=>t.damage>=e.health);function $s(t,e){if(typeof t=="number")return t;if(!t)return 0;const n=String(t).trim();if(!isNaN(Number(n)))return Number(n);try{const r={};e.attributes&&Object.entries(e.attributes).forEach(([i,l])=>{r[i]=l}),r.level=e.level||0,r.perception=e.perception||0,r.defense=e.defense||0,r.health=e.health||0,r.healingRate=e.healingRate||0,r.size=e.size||0,r.speed=e.speed||0,r.power=e.power||0,r.damage=e.damage||0,r.insanity=e.insanity||0,r.corruption=e.corruption||0;const s=n.replace(/@(\w+)/g,"$1");return fp.evaluate(s,r)}catch{return 0}}const Gp=ue(Pt,t=>Math.max(0,t.healingRate)),Zt={set:t=>{M.update(e=>{const n={...e,...t};return t.health!==void 0&&t.healingRate===void 0&&(n.healingRate=Math.floor(n.health/4)),n})},updateAttribute:(t,e)=>{M.update(n=>({...n,attributes:{...n.attributes,[t]:e}}))},takeDamage:t=>{M.update(e=>{const n=Math.max(0,Math.min(e.health,e.damage+t));return{...e,damage:n}})},heal:t=>{M.update(e=>{const n=Math.max(0,e.damage-t);return{...e,damage:n}})},updateStat:(t,e)=>{M.update(n=>({...n,[t]:Math.max(0,e)}))},toggleEffect:t=>{M.update(e=>({...e,effects:e.effects.map(n=>n.id===t?{...n,isActive:!n.isActive}:n)}))},deleteEffect:t=>{M.update(e=>({...e,effects:e.effects.filter(n=>n.id!==t)}))},cleanInactiveEffects:()=>{M.update(t=>({...t,effects:t.effects.filter(e=>e.isActive)}))},advanceRound:t=>{M.update(e=>{if(t==="next"){const n=e.effects.map(r=>r.isActive&&r.duration==="END_OF_ROUND"?{...r,isActive:!1}:r);return{...e,currentRound:e.currentRound+1,effects:n}}return{...e,currentRound:Math.max(1,e.currentRound-1)}})},checkLuckEnds:t=>{const n=j(M).effects.find(s=>s.id===t),r=j(rt);Xt.set({type:"pre_roll",isOpen:!0,data:{type:"luck_ends",system:"sofdl",effectId:t,source:{name:n?.name||r("sofdl.rolls.effect")}}})},checkConcentration:t=>{const n=j(M).effects.find(s=>s.id===t),r=j(rt);Xt.set({type:"pre_roll",isOpen:!0,data:{type:"concentration",system:"sofdl",effectId:t,key:"will",source:{name:n?.name||r("sofdl.rolls.concentration")}}})},addSpell:t=>{M.update(e=>({...e,spells:[...e.spells,{...t,id:t.id||Pn()}]}))},updateSpell:t=>{M.update(e=>({...e,spells:e.spells.map(n=>n.id===t.id?t:n)}))},deleteSpell:t=>{M.update(e=>({...e,spells:e.spells.filter(n=>n.id!==t)}))},castSpell:t=>{const n=j(M).spells.find(r=>r.id===t);n&&(M.update(r=>({...r,spells:r.spells.map(s=>s.id===t?{...s,castingsUsed:(s.castingsUsed||0)+1}:s)})),Zt.addToHistory({source:"spell",name:n.name,description:n.description,type:"spell"}))},resetSpellCastings:()=>{M.update(t=>({...t,spells:t.spells.map(e=>({...e,castingsUsed:0}))}))},addTalent:t=>{M.update(e=>({...e,talents:[...e.talents,{...t,id:t.id||Pn()}]}))},updateTalent:t=>{M.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?t:n)}))},deleteTalent:t=>{M.update(e=>({...e,talents:e.talents.filter(n=>n.id!==t)}))},useTalent:t=>{const n=j(M).talents.find(r=>r.id===t);n&&(M.update(r=>({...r,talents:r.talents.map(s=>s.id===t&&s.uses>0?{...s,uses:s.uses-1}:s)})),Zt.addToHistory({source:"talent",name:n.name,description:n.description,type:"talent"}))},resetTalentUses:()=>{M.update(t=>({...t,talents:t.talents.map(e=>({...e,uses:e.maxUses}))}))},addSense:t=>{M.update(e=>({...e,senses:e.senses.includes(t)?e.senses:[...e.senses,t]}))},removeSense:t=>{M.update(e=>({...e,senses:e.senses.filter((n,r)=>r!==t)}))},toggleAffliction:t=>{M.update(e=>({...e,afflictions:e.afflictions.includes(t)?e.afflictions.filter(n=>n!==t):[...e.afflictions,t]}))},leaveCampaign:()=>{M.update(t=>({...t,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}))},addToHistory:(t,e=!0)=>{const n=j(M),r={id:t.id||Pn(),timestamp:t.timestamp||new Date,charName:n.name,...t};Fr.update(i=>[r,...i]),j(El).autoOpenHistory?rr.set(!0):j(rr)||Pi.set(!0),e&&n.campaignId&&Ps(async()=>{const{syncRoll:i}=await Promise.resolve().then(()=>si);return{syncRoll:i}},void 0,import.meta.url).then(({syncRoll:i})=>{i(r)})},addLanguage:t=>M.update(e=>({...e,languages:[...e.languages,t]})),removeLanguage:t=>M.update(e=>({...e,languages:e.languages.filter((n,r)=>r!==t)})),addProfession:t=>M.update(e=>({...e,professions:[...e.professions,t]})),removeProfession:t=>M.update(e=>({...e,professions:e.professions.filter((n,r)=>r!==t)})),updateCurrency:(t,e)=>{M.update(n=>{const r=Math.max(0,(n.currency[t]||0)+e);return{...n,currency:{...n.currency,[t]:r}}})},addItem:t=>M.update(e=>({...e,equipment:[...e.equipment,t]})),updateItem:t=>M.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?t:n)})),deleteItem:t=>M.update(e=>({...e,equipment:e.equipment.filter(n=>n.id!==t)})),useConsumable:t=>{M.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?{...n,quantity:Math.max(0,n.quantity-1)}:n)}))},reloadWeapon:t=>M.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?{...n,isLoaded:!0}:n)})),finalizeRoll:(t,e,n=[])=>{j(M);const r=j(gp),s=j(Pt),i=t?.type==="weapon_damage"||t?.type==="spell_damage",l=j(rt),h=t?.source?.name||t?.key||l("character.modals.attribute");if(i){const f=t.source?.damage??t.source?.damageDice??"1d6",g=String(f),c=Number(t.source?.damageMod)||0;let m=0,d=[],w="";if(g==="0")m=0,w="0";else if(!g.includes("d"))m=parseInt(g)||0,w=`${m}`,d=[m];else{const D=g.match(/(\d+)d(\d+)/);if(D){const J=parseInt(D[1])||1,V=parseInt(D[2])||6;for(let S=0;S<J;S++){const I=Math.floor(Math.random()*V)+1;m+=I,d.push(I)}w=`${g} [${d.join(", ")}]`}else m=1,w="1"}const E=m+e+c,x=e+c!==0?`${e+c>0?"+":""}${e+c}`:"",R=j(rt);Zt.addToHistory({source:"damage",name:h,description:R("sofdl.rolls.damage_description",{values:{source:h}}),formula:`${w}${x}`,total:E,effectsApplied:n})}else{const f=Math.floor(Math.random()*20)+1;let g=0,c=h;t.type==="attribute"?(g=r[t.key]||0,c=l(`sofdl.attributes.${t.key}`)):t.type==="luck"&&(g=0,c=l("character.luck_test"));let m=e+(s.boons||0),d=0,w="";if(m!==0){const R=Math.abs(m);let D=[];for(let V=0;V<R;V++)D.push(Math.floor(Math.random()*6)+1);const J=Math.max(...D);m>0?(d=J,w=` + ${J} [${l("sofdl.rolls.boon")}]`):(d=-J,w=` - ${J} [${l("sofdl.rolls.bane")}]`)}let E="attribute";t.type==="weapon_attack"?E="attack":(t.type==="luck"||t.type==="luck_ends")&&(E="luck");const x=f+g+d;Zt.addToHistory({source:E,name:c,description:t.type==="luck_ends"?l("sofdl.rolls.luck_ends",{values:{effect:h}}):l("sofdl.rolls.attribute_test",{values:{attr:c,modifier:e}}),formula:`d20(${f})${g!==0?(g>=0?"+":"")+g:""}${w}`,total:x,crit:f===20,effectsApplied:n}),t.type==="luck_ends"&&x>=10&&M.update(R=>({...R,effects:R.effects.map(D=>D.id===t.effectId?{...D,isActive:!1}:D)}))}},rest:()=>{M.update(t=>{const e=t.spells.map(s=>({...s,castingsUsed:0})),n=t.talents.map(s=>({...s,uses:s.isPassive?0:s.maxUses})),r=Math.max(0,t.damage-t.healingRate);return{...t,spells:e,talents:n,damage:r}})}},_l={appId:il,trackerUrls:["wss://tracker.openwebtorrent.com","wss://tracker.files.fm:7073/announce","wss://tracker.webtorrent.dev","wss://toad.vibe.community:443/announce","wss://tracker.btorrent.xyz"]},Je=Me({roomId:null,peers:[],currentCharacterId:null,lastGmUpdate:0,isGM:!1,isConnected:!1}),mp=ue(Je,t=>t.lastGmUpdate?Date.now()-t.lastGmUpdate<6e4:!1);let de=null,mt=null,sr=null,ir=null,or=null,ar=null,Tt=null,We=null,Uo=0,Bo=0;const wp=2e3,yp={appId:"weird-wizard-vault-lobby"},ni=Me([]);function lr(t,e){if(!t)return!0;try{return t.leave(),!0}catch(n){return console.warn(`Failed to leave ${e}:`,n),!1}}function xl(t){return Date.now()-t>=wp}function ri(){if(!xl(Uo))return console.warn("Lobby join rate limited. Skipping duplicate join attempt."),null;Uo=Date.now(),Tt&&(clearInterval(Tt),Tt=null),lr(mt,"existing lobby"),mt=null;try{mt=pl(yp,"public-discovery");const[t,e]=mt.makeAction("discovery");return e(n=>{ni.update(r=>{const s=r.findIndex(i=>i.id===n.id);if(s!==-1){const i=[...r];return i[s]={...n,lastSeen:Date.now()},i}return[...r,{...n,lastSeen:Date.now()}]})}),Tt=setInterval(()=>{const n=Date.now();ni.update(r=>r.filter(s=>n-s.lastSeen<12e4))},6e4),t}catch(t){return console.error("Failed to join lobby:",t),mt=null,null}}let Zr;function bp(){typeof window<"u"&&(sessionStorage.getItem("lobby-initialized")?mt||(Zr=ri()):(sessionStorage.setItem("lobby-initialized","true"),Zr=ri()))}typeof window<"u"&&(bp(),window.addEventListener("beforeunload",()=>{Lo()}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Lo()}));function Lo(){Tt&&(clearInterval(Tt),Tt=null),We&&(clearInterval(We),We=null),lr(mt,"lobby"),lr(de,"room"),mt=null,de=null}let Wt=null;function Ep(t,e=!1,n=null){const r=`campaign-${t}`;if(Wt===r&&de)return Je.update(s=>({...s,isGM:e,currentCharacterId:n})),de;if(!xl(Bo))return console.warn("Campaign join rate limited. Skipping duplicate join attempt."),de;Bo=Date.now(),We&&(clearInterval(We),We=null),lr(de,"existing campaign room"),de=null,Wt=null,sr=null,ir=null,or=null,ar=null;try{Wt=r,de=pl(_l,Wt),Je.set({isConnected:!0,isGM:e,currentCharacterId:n,peers:[],roomId:t,lastGmUpdate:0});const[s,i]=de.makeAction("combat"),[l,h]=de.makeAction("history"),[f,g]=de.makeAction("charUpdate"),[c,m]=de.makeAction("campaign");return sr=s,ir=l,or=f,ar=c,i(d=>{e||C.update(w=>({...w,currentRound:d.round,combatActive:d.active}))}),m(d=>{Je.update(w=>({...w,lastGmUpdate:Date.now()})),e||C.update(w=>({...w,campaignName:d.name,gmName:d.gmName,passwordHash:d.passwordHash,system:d.system}))}),e&&Zr&&(We=setInterval(()=>{const d=Bn.get(t);d&&d.isPublished&&Zr({id:t,name:d.name,gmName:d.gmName||"Mestre",description:d.description})},3e4)),h(d=>{Fe.addToHistory(d,!1)}),g(d=>{if(e){const w=Bn.get(t);if(w){const E=w.members||[],x=E.findIndex(S=>S.id===d.id);let R;if(x!==-1){R=[...E];const S=R[x],I={...d};S.campaignApproval==="approved"&&d.campaignApproval==="pending"&&delete I.campaignApproval,R[x]={...S,...I,lastUpdate:Date.now()}}else R=[...E,{...d,lastUpdate:Date.now()}];const D=w.activeEnemies||[],J=D.findIndex(S=>S.id===d.id&&S.type==="player");let V=D;J!==-1&&(V=[...D],V[J]={...V[J],...d}),Bn.set(t,{...w,members:R,activeEnemies:V})}}else{const w=j(Je),E=j(C),x=w.currentCharacterId||E?.id;if(x&&x===d.id){const R=d.system==="sofdl";if(d.campaignApproval==="rejected"||d.campaignId===null){R?Zt.leaveCampaign():C.update(D=>({...D,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}));return}R?Zt.set({name:d.name,afflictions:d.afflictions,senses:d.senses,initiative:d.initiative,acted:d.acted,campaignApproval:d.campaignApproval,imageUrl:d.imageUrl,notes:d.notes,damage:d.damage,health:d.health,healingRate:d.healingRate,insanity:d.insanity,corruption:d.corruption,defense:d.defense,speed:d.speed,power:d.power,attributes:d.attributes}):(C.update(D=>({...D,name:d.name||D.name,afflictions:d.afflictions||D.afflictions,senses:d.senses||D.senses,initiative:d.initiative!==void 0?d.initiative:D.initiative??!1,acted:d.acted!==void 0?d.acted:D.acted??!1,campaignApproval:d.campaignApproval||D.campaignApproval,imageUrl:d.imageUrl||D.imageUrl,notes:d.notes!==void 0?d.notes:D.notes})),d.damage!==void 0&&bn.set(d.damage),d.currentHealth!==void 0&&Cn.set(d.currentHealth),d.normalHealth!==void 0&&$i.set(d.normalHealth))}}}),de.onPeerJoin(d=>{if(Je.update(w=>({...w,peers:[...w.peers,d]})),e){const w=Bn.get(t);w&&(w.combat&&s(w.combat),c({name:w.name,gmName:w.gmName||"Mestre",passwordHash:w.passwordHash,system:w.system}))}}),de.onPeerLeave(d=>{Je.update(w=>({...w,peers:w.peers.filter(E=>E!==d)}))}),de}catch(s){return console.error("Failed to join campaign room:",s),de=null,Wt=null,Je.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0}),null}}function kp(t,e){sr&&sr(e)}function _p(t,e){ar&&ar({name:e.name,gmName:e.gmName||"Mestre",passwordHash:e.passwordHash,system:e.system})}function xp(t){ir&&ir(t)}function Sp(t){or&&or(t)}function Ap(){We&&(clearInterval(We),We=null),lr(de,"campaign room"),de=null,Wt=null,sr=null,ir=null,or=null,ar=null,Je.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0})}const si=Object.freeze(Object.defineProperty({__proto__:null,isGmOnline:mp,joinCampaignRoom:Ep,joinLobby:ri,leaveCampaignRoom:Ap,publicCampaigns:ni,roomConfig:_l,syncCampaign:_p,syncCharacter:Sp,syncCombat:kp,syncRoll:xp,syncState:Je},Symbol.toStringTag,{value:"Module"}));export{Gp as $,up as A,bn as B,$p as C,Vp as D,hp as E,Pp as F,Xt as G,Op as H,pt as I,an as J,Zt as K,$s as L,Bp as M,ln as N,qp as O,kl as P,pp as Q,gr as R,M as S,Pt as T,$i as U,Cn as V,Hp as W,jp as X,Fp as Y,Up as Z,gp as _,pl as a,Np as a0,Lp as a1,dp as a2,lp as a3,Rp as a4,Mp as b,C as c,Sf as d,Bn as e,Af as f,vf as g,Sp as h,mp as i,Ep as j,_p as k,Ap as l,rr as m,kp as n,Je as o,Pi as p,Fe as q,_l as r,Yt as s,Cf as t,Pn as u,If as v,Tf as w,El as x,ni as y,Fr as z};
