import{bg as $o,as as Nl,I as Po,G as Vo,h as jo,aS as Rn,bj as Fl}from"./CcABsDcH.js";import{w as Oe,p as pe,g as H}from"./Bmlnf0CH.js";import{_ as js}from"./BwRHsyw7.js";import{l as Gi,$ as ot}from"./DDsCrrC-.js";function Lp(t,e,n=e){var r=new WeakSet;$o(t,"input",async s=>{var i=s?t.defaultValue:t.value;if(i=xs(t)?As(i):i,n(i),Rn!==null&&r.add(Rn),await Nl(),i!==(i=e())){var l=t.selectionStart,h=t.selectionEnd,f=t.value.length;if(t.value=i??"",h!==null){var g=t.value.length;l===h&&h===f&&g>f?(t.selectionStart=g,t.selectionEnd=g):(t.selectionStart=l,t.selectionEnd=Math.min(h,g))}}}),(jo&&t.defaultValue!==t.value||Po(e)==null&&t.value)&&(n(xs(t)?As(t.value):t.value),Rn!==null&&r.add(Rn)),Vo(()=>{var s=e();if(t===document.activeElement){var i=Fl??Rn;if(r.has(i))return}xs(t)&&s===As(t.value)||t.type==="date"&&!s&&!t.value||s!==t.value&&(t.value=s??"")})}function Np(t,e,n=e){$o(t,"change",r=>{var s=r?t.defaultChecked:t.checked;n(s)}),(jo&&t.defaultChecked!==t.checked||Po(e)==null)&&n(t.checked),Vo(()=>{var r=e();t.checked=!!r})}function xs(t){var e=t.type;return e==="number"||e==="range"}function As(t){return t===""?null:+t}function $l(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Ho={exports:{}},le=Ho.exports={},ze,Ye;function Hs(){throw new Error("setTimeout has not been defined")}function qs(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?ze=setTimeout:ze=Hs}catch{ze=Hs}try{typeof clearTimeout=="function"?Ye=clearTimeout:Ye=qs}catch{Ye=qs}})();function qo(t){if(ze===setTimeout)return setTimeout(t,0);if((ze===Hs||!ze)&&setTimeout)return ze=setTimeout,setTimeout(t,0);try{return ze(t,0)}catch{try{return ze.call(null,t,0)}catch{return ze.call(this,t,0)}}}function Pl(t){if(Ye===clearTimeout)return clearTimeout(t);if((Ye===qs||!Ye)&&clearTimeout)return Ye=clearTimeout,clearTimeout(t);try{return Ye(t)}catch{try{return Ye.call(null,t)}catch{return Ye.call(this,t)}}}var at=[],en=!1,Tt,Cr=-1;function Vl(){!en||!Tt||(en=!1,Tt.length?at=Tt.concat(at):Cr=-1,at.length&&Go())}function Go(){if(!en){var t=qo(Vl);en=!0;for(var e=at.length;e;){for(Tt=at,at=[];++Cr<e;)Tt&&Tt[Cr].run();Cr=-1,e=at.length}Tt=null,en=!1,Pl(t)}}le.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];at.push(new Jo(t,e)),at.length===1&&!en&&qo(Go)};function Jo(t,e){this.fun=t,this.array=e}Jo.prototype.run=function(){this.fun.apply(null,this.array)};le.title="browser";le.browser=!0;le.env={};le.argv=[];le.version="";le.versions={};function ht(){}le.on=ht;le.addListener=ht;le.once=ht;le.off=ht;le.removeListener=ht;le.removeAllListeners=ht;le.emit=ht;le.prependListener=ht;le.prependOnceListener=ht;le.listeners=function(t){return[]};le.binding=function(t){throw new Error("process.binding is not supported")};le.cwd=function(){return"/"};le.chdir=function(t){throw new Error("process.chdir is not supported")};le.umask=function(){return 0};var jl=Ho.exports;const vt=$l(jl);var Hl={},Qr={};Qr.byteLength=Jl;Qr.toByteArray=Yl;Qr.fromByteArray=Xl;var Ke=[],Le=[],ql=typeof Uint8Array<"u"?Uint8Array:Array,vs="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Jt=0,Gl=vs.length;Jt<Gl;++Jt)Ke[Jt]=vs[Jt],Le[vs.charCodeAt(Jt)]=Jt;Le[45]=62;Le[95]=63;function zo(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=t.indexOf("=");n===-1&&(n=e);var r=n===e?0:4-n%4;return[n,r]}function Jl(t){var e=zo(t),n=e[0],r=e[1];return(n+r)*3/4-r}function zl(t,e,n){return(e+n)*3/4-n}function Yl(t){var e,n=zo(t),r=n[0],s=n[1],i=new ql(zl(t,r,s)),l=0,h=s>0?r-4:r,f;for(f=0;f<h;f+=4)e=Le[t.charCodeAt(f)]<<18|Le[t.charCodeAt(f+1)]<<12|Le[t.charCodeAt(f+2)]<<6|Le[t.charCodeAt(f+3)],i[l++]=e>>16&255,i[l++]=e>>8&255,i[l++]=e&255;return s===2&&(e=Le[t.charCodeAt(f)]<<2|Le[t.charCodeAt(f+1)]>>4,i[l++]=e&255),s===1&&(e=Le[t.charCodeAt(f)]<<10|Le[t.charCodeAt(f+1)]<<4|Le[t.charCodeAt(f+2)]>>2,i[l++]=e>>8&255,i[l++]=e&255),i}function Wl(t){return Ke[t>>18&63]+Ke[t>>12&63]+Ke[t>>6&63]+Ke[t&63]}function Kl(t,e,n){for(var r,s=[],i=e;i<n;i+=3)r=(t[i]<<16&16711680)+(t[i+1]<<8&65280)+(t[i+2]&255),s.push(Wl(r));return s.join("")}function Xl(t){for(var e,n=t.length,r=n%3,s=[],i=16383,l=0,h=n-r;l<h;l+=i)s.push(Kl(t,l,l+i>h?h:l+i));return r===1?(e=t[n-1],s.push(Ke[e>>2]+Ke[e<<4&63]+"==")):r===2&&(e=(t[n-2]<<8)+t[n-1],s.push(Ke[e>>10]+Ke[e>>4&63]+Ke[e<<2&63]+"=")),s.join("")}var ai={};ai.read=function(t,e,n,r,s){var i,l,h=s*8-r-1,f=(1<<h)-1,g=f>>1,c=-7,m=n?s-1:0,d=n?-1:1,w=t[e+m];for(m+=d,i=w&(1<<-c)-1,w>>=-c,c+=h;c>0;i=i*256+t[e+m],m+=d,c-=8);for(l=i&(1<<-c)-1,i>>=-c,c+=r;c>0;l=l*256+t[e+m],m+=d,c-=8);if(i===0)i=1-g;else{if(i===f)return l?NaN:(w?-1:1)*(1/0);l=l+Math.pow(2,r),i=i-g}return(w?-1:1)*l*Math.pow(2,i-r)};ai.write=function(t,e,n,r,s,i){var l,h,f,g=i*8-s-1,c=(1<<g)-1,m=c>>1,d=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,w=r?0:i-1,E=r?1:-1,S=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(h=isNaN(e)?1:0,l=c):(l=Math.floor(Math.log(e)/Math.LN2),e*(f=Math.pow(2,-l))<1&&(l--,f*=2),l+m>=1?e+=d/f:e+=d*Math.pow(2,1-m),e*f>=2&&(l++,f/=2),l+m>=c?(h=0,l=c):l+m>=1?(h=(e*f-1)*Math.pow(2,s),l=l+m):(h=e*Math.pow(2,m-1)*Math.pow(2,s),l=0));s>=8;t[n+w]=h&255,w+=E,h/=256,s-=8);for(l=l<<s|h,g+=s;g>0;t[n+w]=l&255,w+=E,l/=256,g-=8);t[n+w-E]|=S*128};(function(t){const e=Qr,n=ai,r=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=c,t.SlowBuffer=j,t.INSPECT_MAX_BYTES=50;const s=2147483647;t.kMaxLength=s;const{Uint8Array:i,ArrayBuffer:l,SharedArrayBuffer:h}=globalThis;c.TYPED_ARRAY_SUPPORT=f(),!c.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function f(){try{const u=new i(1),o={foo:function(){return 42}};return Object.setPrototypeOf(o,i.prototype),Object.setPrototypeOf(u,o),u.foo()===42}catch{return!1}}Object.defineProperty(c.prototype,"parent",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.buffer}}),Object.defineProperty(c.prototype,"offset",{enumerable:!0,get:function(){if(c.isBuffer(this))return this.byteOffset}});function g(u){if(u>s)throw new RangeError('The value "'+u+'" is invalid for option "size"');const o=new i(u);return Object.setPrototypeOf(o,c.prototype),o}function c(u,o,a){if(typeof u=="number"){if(typeof o=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return E(u)}return m(u,o,a)}c.poolSize=8192;function m(u,o,a){if(typeof u=="string")return S(u,o);if(l.isView(u))return D(u);if(u==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof u);if(Ge(u,l)||u&&Ge(u.buffer,l)||typeof h<"u"&&(Ge(u,h)||u&&Ge(u.buffer,h)))return ee(u,o,a);if(typeof u=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const p=u.valueOf&&u.valueOf();if(p!=null&&p!==u)return c.from(p,o,a);const y=q(u);if(y)return y;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof u[Symbol.toPrimitive]=="function")return c.from(u[Symbol.toPrimitive]("string"),o,a);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof u)}c.from=function(u,o,a){return m(u,o,a)},Object.setPrototypeOf(c.prototype,i.prototype),Object.setPrototypeOf(c,i);function d(u){if(typeof u!="number")throw new TypeError('"size" argument must be of type number');if(u<0)throw new RangeError('The value "'+u+'" is invalid for option "size"')}function w(u,o,a){return d(u),u<=0?g(u):o!==void 0?typeof a=="string"?g(u).fill(o,a):g(u).fill(o):g(u)}c.alloc=function(u,o,a){return w(u,o,a)};function E(u){return d(u),g(u<0?0:B(u)|0)}c.allocUnsafe=function(u){return E(u)},c.allocUnsafeSlow=function(u){return E(u)};function S(u,o){if((typeof o!="string"||o==="")&&(o="utf8"),!c.isEncoding(o))throw new TypeError("Unknown encoding: "+o);const a=J(u,o)|0;let p=g(a);const y=p.write(u,o);return y!==a&&(p=p.slice(0,y)),p}function I(u){const o=u.length<0?0:B(u.length)|0,a=g(o);for(let p=0;p<o;p+=1)a[p]=u[p]&255;return a}function D(u){if(Ge(u,i)){const o=new i(u);return ee(o.buffer,o.byteOffset,o.byteLength)}return I(u)}function ee(u,o,a){if(o<0||u.byteLength<o)throw new RangeError('"offset" is outside of buffer bounds');if(u.byteLength<o+(a||0))throw new RangeError('"length" is outside of buffer bounds');let p;return o===void 0&&a===void 0?p=new i(u):a===void 0?p=new i(u,o):p=new i(u,o,a),Object.setPrototypeOf(p,c.prototype),p}function q(u){if(c.isBuffer(u)){const o=B(u.length)|0,a=g(o);return a.length===0||u.copy(a,0,0,o),a}if(u.length!==void 0)return typeof u.length!="number"||Ss(u.length)?g(0):I(u);if(u.type==="Buffer"&&Array.isArray(u.data))return I(u.data)}function B(u){if(u>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return u|0}function j(u){return+u!=u&&(u=0),c.alloc(+u)}c.isBuffer=function(o){return o!=null&&o._isBuffer===!0&&o!==c.prototype},c.compare=function(o,a){if(Ge(o,i)&&(o=c.from(o,o.offset,o.byteLength)),Ge(a,i)&&(a=c.from(a,a.offset,a.byteLength)),!c.isBuffer(o)||!c.isBuffer(a))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(o===a)return 0;let p=o.length,y=a.length;for(let b=0,k=Math.min(p,y);b<k;++b)if(o[b]!==a[b]){p=o[b],y=a[b];break}return p<y?-1:y<p?1:0},c.isEncoding=function(o){switch(String(o).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},c.concat=function(o,a){if(!Array.isArray(o))throw new TypeError('"list" argument must be an Array of Buffers');if(o.length===0)return c.alloc(0);let p;if(a===void 0)for(a=0,p=0;p<o.length;++p)a+=o[p].length;const y=c.allocUnsafe(a);let b=0;for(p=0;p<o.length;++p){let k=o[p];if(Ge(k,i))b+k.length>y.length?(c.isBuffer(k)||(k=c.from(k)),k.copy(y,b)):i.prototype.set.call(y,k,b);else if(c.isBuffer(k))k.copy(y,b);else throw new TypeError('"list" argument must be an Array of Buffers');b+=k.length}return y};function J(u,o){if(c.isBuffer(u))return u.length;if(l.isView(u)||Ge(u,l))return u.byteLength;if(typeof u!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof u);const a=u.length,p=arguments.length>2&&arguments[2]===!0;if(!p&&a===0)return 0;let y=!1;for(;;)switch(o){case"ascii":case"latin1":case"binary":return a;case"utf8":case"utf-8":return _s(u).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return a*2;case"hex":return a>>>1;case"base64":return qi(u).length;default:if(y)return p?-1:_s(u).length;o=(""+o).toLowerCase(),y=!0}}c.byteLength=J;function X(u,o,a){let p=!1;if((o===void 0||o<0)&&(o=0),o>this.length||((a===void 0||a>this.length)&&(a=this.length),a<=0)||(a>>>=0,o>>>=0,a<=o))return"";for(u||(u="utf8");;)switch(u){case"hex":return Ve(this,o,a);case"utf8":case"utf-8":return A(this,o,a);case"ascii":return _e(this,o,a);case"latin1":case"binary":return ge(this,o,a);case"base64":return W(this,o,a);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return G(this,o,a);default:if(p)throw new TypeError("Unknown encoding: "+u);u=(u+"").toLowerCase(),p=!0}}c.prototype._isBuffer=!0;function ne(u,o,a){const p=u[o];u[o]=u[a],u[a]=p}c.prototype.swap16=function(){const o=this.length;if(o%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let a=0;a<o;a+=2)ne(this,a,a+1);return this},c.prototype.swap32=function(){const o=this.length;if(o%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let a=0;a<o;a+=4)ne(this,a,a+3),ne(this,a+1,a+2);return this},c.prototype.swap64=function(){const o=this.length;if(o%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let a=0;a<o;a+=8)ne(this,a,a+7),ne(this,a+1,a+6),ne(this,a+2,a+5),ne(this,a+3,a+4);return this},c.prototype.toString=function(){const o=this.length;return o===0?"":arguments.length===0?A(this,0,o):X.apply(this,arguments)},c.prototype.toLocaleString=c.prototype.toString,c.prototype.equals=function(o){if(!c.isBuffer(o))throw new TypeError("Argument must be a Buffer");return this===o?!0:c.compare(this,o)===0},c.prototype.inspect=function(){let o="";const a=t.INSPECT_MAX_BYTES;return o=this.toString("hex",0,a).replace(/(.{2})/g,"$1 ").trim(),this.length>a&&(o+=" ... "),"<Buffer "+o+">"},r&&(c.prototype[r]=c.prototype.inspect),c.prototype.compare=function(o,a,p,y,b){if(Ge(o,i)&&(o=c.from(o,o.offset,o.byteLength)),!c.isBuffer(o))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof o);if(a===void 0&&(a=0),p===void 0&&(p=o?o.length:0),y===void 0&&(y=0),b===void 0&&(b=this.length),a<0||p>o.length||y<0||b>this.length)throw new RangeError("out of range index");if(y>=b&&a>=p)return 0;if(y>=b)return-1;if(a>=p)return 1;if(a>>>=0,p>>>=0,y>>>=0,b>>>=0,this===o)return 0;let k=b-y,U=p-a;const ie=Math.min(k,U),te=this.slice(y,b),oe=o.slice(a,p);for(let z=0;z<ie;++z)if(te[z]!==oe[z]){k=te[z],U=oe[z];break}return k<U?-1:U<k?1:0};function v(u,o,a,p,y){if(u.length===0)return-1;if(typeof a=="string"?(p=a,a=0):a>2147483647?a=2147483647:a<-2147483648&&(a=-2147483648),a=+a,Ss(a)&&(a=y?0:u.length-1),a<0&&(a=u.length+a),a>=u.length){if(y)return-1;a=u.length-1}else if(a<0)if(y)a=0;else return-1;if(typeof o=="string"&&(o=c.from(o,p)),c.isBuffer(o))return o.length===0?-1:L(u,o,a,p,y);if(typeof o=="number")return o=o&255,typeof i.prototype.indexOf=="function"?y?i.prototype.indexOf.call(u,o,a):i.prototype.lastIndexOf.call(u,o,a):L(u,[o],a,p,y);throw new TypeError("val must be string, number or Buffer")}function L(u,o,a,p,y){let b=1,k=u.length,U=o.length;if(p!==void 0&&(p=String(p).toLowerCase(),p==="ucs2"||p==="ucs-2"||p==="utf16le"||p==="utf-16le")){if(u.length<2||o.length<2)return-1;b=2,k/=2,U/=2,a/=2}function ie(oe,z){return b===1?oe[z]:oe.readUInt16BE(z*b)}let te;if(y){let oe=-1;for(te=a;te<k;te++)if(ie(u,te)===ie(o,oe===-1?0:te-oe)){if(oe===-1&&(oe=te),te-oe+1===U)return oe*b}else oe!==-1&&(te-=te-oe),oe=-1}else for(a+U>k&&(a=k-U),te=a;te>=0;te--){let oe=!0;for(let z=0;z<U;z++)if(ie(u,te+z)!==ie(o,z)){oe=!1;break}if(oe)return te}return-1}c.prototype.includes=function(o,a,p){return this.indexOf(o,a,p)!==-1},c.prototype.indexOf=function(o,a,p){return v(this,o,a,p,!0)},c.prototype.lastIndexOf=function(o,a,p){return v(this,o,a,p,!1)};function Ce(u,o,a,p){a=Number(a)||0;const y=u.length-a;p?(p=Number(p),p>y&&(p=y)):p=y;const b=o.length;p>b/2&&(p=b/2);let k;for(k=0;k<p;++k){const U=parseInt(o.substr(k*2,2),16);if(Ss(U))return k;u[a+k]=U}return k}function _(u,o,a,p){return br(_s(o,u.length-a),u,a,p)}function x(u,o,a,p){return br(Ol(o),u,a,p)}function R(u,o,a,p){return br(qi(o),u,a,p)}function F(u,o,a,p){return br(Ul(o,u.length-a),u,a,p)}c.prototype.write=function(o,a,p,y){if(a===void 0)y="utf8",p=this.length,a=0;else if(p===void 0&&typeof a=="string")y=a,p=this.length,a=0;else if(isFinite(a))a=a>>>0,isFinite(p)?(p=p>>>0,y===void 0&&(y="utf8")):(y=p,p=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const b=this.length-a;if((p===void 0||p>b)&&(p=b),o.length>0&&(p<0||a<0)||a>this.length)throw new RangeError("Attempt to write outside buffer bounds");y||(y="utf8");let k=!1;for(;;)switch(y){case"hex":return Ce(this,o,a,p);case"utf8":case"utf-8":return _(this,o,a,p);case"ascii":case"latin1":case"binary":return x(this,o,a,p);case"base64":return R(this,o,a,p);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return F(this,o,a,p);default:if(k)throw new TypeError("Unknown encoding: "+y);y=(""+y).toLowerCase(),k=!0}},c.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function W(u,o,a){return o===0&&a===u.length?e.fromByteArray(u):e.fromByteArray(u.slice(o,a))}function A(u,o,a){a=Math.min(u.length,a);const p=[];let y=o;for(;y<a;){const b=u[y];let k=null,U=b>239?4:b>223?3:b>191?2:1;if(y+U<=a){let ie,te,oe,z;switch(U){case 1:b<128&&(k=b);break;case 2:ie=u[y+1],(ie&192)===128&&(z=(b&31)<<6|ie&63,z>127&&(k=z));break;case 3:ie=u[y+1],te=u[y+2],(ie&192)===128&&(te&192)===128&&(z=(b&15)<<12|(ie&63)<<6|te&63,z>2047&&(z<55296||z>57343)&&(k=z));break;case 4:ie=u[y+1],te=u[y+2],oe=u[y+3],(ie&192)===128&&(te&192)===128&&(oe&192)===128&&(z=(b&15)<<18|(ie&63)<<12|(te&63)<<6|oe&63,z>65535&&z<1114112&&(k=z))}}k===null?(k=65533,U=1):k>65535&&(k-=65536,p.push(k>>>10&1023|55296),k=56320|k&1023),p.push(k),y+=U}return re(p)}const T=4096;function re(u){const o=u.length;if(o<=T)return String.fromCharCode.apply(String,u);let a="",p=0;for(;p<o;)a+=String.fromCharCode.apply(String,u.slice(p,p+=T));return a}function _e(u,o,a){let p="";a=Math.min(u.length,a);for(let y=o;y<a;++y)p+=String.fromCharCode(u[y]&127);return p}function ge(u,o,a){let p="";a=Math.min(u.length,a);for(let y=o;y<a;++y)p+=String.fromCharCode(u[y]);return p}function Ve(u,o,a){const p=u.length;(!o||o<0)&&(o=0),(!a||a<0||a>p)&&(a=p);let y="";for(let b=o;b<a;++b)y+=Bl[u[b]];return y}function G(u,o,a){const p=u.slice(o,a);let y="";for(let b=0;b<p.length-1;b+=2)y+=String.fromCharCode(p[b]+p[b+1]*256);return y}c.prototype.slice=function(o,a){const p=this.length;o=~~o,a=a===void 0?p:~~a,o<0?(o+=p,o<0&&(o=0)):o>p&&(o=p),a<0?(a+=p,a<0&&(a=0)):a>p&&(a=p),a<o&&(a=o);const y=this.subarray(o,a);return Object.setPrototypeOf(y,c.prototype),y};function $(u,o,a){if(u%1!==0||u<0)throw new RangeError("offset is not uint");if(u+o>a)throw new RangeError("Trying to access beyond buffer length")}c.prototype.readUintLE=c.prototype.readUIntLE=function(o,a,p){o=o>>>0,a=a>>>0,p||$(o,a,this.length);let y=this[o],b=1,k=0;for(;++k<a&&(b*=256);)y+=this[o+k]*b;return y},c.prototype.readUintBE=c.prototype.readUIntBE=function(o,a,p){o=o>>>0,a=a>>>0,p||$(o,a,this.length);let y=this[o+--a],b=1;for(;a>0&&(b*=256);)y+=this[o+--a]*b;return y},c.prototype.readUint8=c.prototype.readUInt8=function(o,a){return o=o>>>0,a||$(o,1,this.length),this[o]},c.prototype.readUint16LE=c.prototype.readUInt16LE=function(o,a){return o=o>>>0,a||$(o,2,this.length),this[o]|this[o+1]<<8},c.prototype.readUint16BE=c.prototype.readUInt16BE=function(o,a){return o=o>>>0,a||$(o,2,this.length),this[o]<<8|this[o+1]},c.prototype.readUint32LE=c.prototype.readUInt32LE=function(o,a){return o=o>>>0,a||$(o,4,this.length),(this[o]|this[o+1]<<8|this[o+2]<<16)+this[o+3]*16777216},c.prototype.readUint32BE=c.prototype.readUInt32BE=function(o,a){return o=o>>>0,a||$(o,4,this.length),this[o]*16777216+(this[o+1]<<16|this[o+2]<<8|this[o+3])},c.prototype.readBigUInt64LE=mt(function(o){o=o>>>0,Gt(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&Dn(o,this.length-8);const y=a+this[++o]*2**8+this[++o]*2**16+this[++o]*2**24,b=this[++o]+this[++o]*2**8+this[++o]*2**16+p*2**24;return BigInt(y)+(BigInt(b)<<BigInt(32))}),c.prototype.readBigUInt64BE=mt(function(o){o=o>>>0,Gt(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&Dn(o,this.length-8);const y=a*2**24+this[++o]*2**16+this[++o]*2**8+this[++o],b=this[++o]*2**24+this[++o]*2**16+this[++o]*2**8+p;return(BigInt(y)<<BigInt(32))+BigInt(b)}),c.prototype.readIntLE=function(o,a,p){o=o>>>0,a=a>>>0,p||$(o,a,this.length);let y=this[o],b=1,k=0;for(;++k<a&&(b*=256);)y+=this[o+k]*b;return b*=128,y>=b&&(y-=Math.pow(2,8*a)),y},c.prototype.readIntBE=function(o,a,p){o=o>>>0,a=a>>>0,p||$(o,a,this.length);let y=a,b=1,k=this[o+--y];for(;y>0&&(b*=256);)k+=this[o+--y]*b;return b*=128,k>=b&&(k-=Math.pow(2,8*a)),k},c.prototype.readInt8=function(o,a){return o=o>>>0,a||$(o,1,this.length),this[o]&128?(255-this[o]+1)*-1:this[o]},c.prototype.readInt16LE=function(o,a){o=o>>>0,a||$(o,2,this.length);const p=this[o]|this[o+1]<<8;return p&32768?p|4294901760:p},c.prototype.readInt16BE=function(o,a){o=o>>>0,a||$(o,2,this.length);const p=this[o+1]|this[o]<<8;return p&32768?p|4294901760:p},c.prototype.readInt32LE=function(o,a){return o=o>>>0,a||$(o,4,this.length),this[o]|this[o+1]<<8|this[o+2]<<16|this[o+3]<<24},c.prototype.readInt32BE=function(o,a){return o=o>>>0,a||$(o,4,this.length),this[o]<<24|this[o+1]<<16|this[o+2]<<8|this[o+3]},c.prototype.readBigInt64LE=mt(function(o){o=o>>>0,Gt(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&Dn(o,this.length-8);const y=this[o+4]+this[o+5]*2**8+this[o+6]*2**16+(p<<24);return(BigInt(y)<<BigInt(32))+BigInt(a+this[++o]*2**8+this[++o]*2**16+this[++o]*2**24)}),c.prototype.readBigInt64BE=mt(function(o){o=o>>>0,Gt(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&Dn(o,this.length-8);const y=(a<<24)+this[++o]*2**16+this[++o]*2**8+this[++o];return(BigInt(y)<<BigInt(32))+BigInt(this[++o]*2**24+this[++o]*2**16+this[++o]*2**8+p)}),c.prototype.readFloatLE=function(o,a){return o=o>>>0,a||$(o,4,this.length),n.read(this,o,!0,23,4)},c.prototype.readFloatBE=function(o,a){return o=o>>>0,a||$(o,4,this.length),n.read(this,o,!1,23,4)},c.prototype.readDoubleLE=function(o,a){return o=o>>>0,a||$(o,8,this.length),n.read(this,o,!0,52,8)},c.prototype.readDoubleBE=function(o,a){return o=o>>>0,a||$(o,8,this.length),n.read(this,o,!1,52,8)};function Z(u,o,a,p,y,b){if(!c.isBuffer(u))throw new TypeError('"buffer" argument must be a Buffer instance');if(o>y||o<b)throw new RangeError('"value" argument is out of bounds');if(a+p>u.length)throw new RangeError("Index out of range")}c.prototype.writeUintLE=c.prototype.writeUIntLE=function(o,a,p,y){if(o=+o,a=a>>>0,p=p>>>0,!y){const U=Math.pow(2,8*p)-1;Z(this,o,a,p,U,0)}let b=1,k=0;for(this[a]=o&255;++k<p&&(b*=256);)this[a+k]=o/b&255;return a+p},c.prototype.writeUintBE=c.prototype.writeUIntBE=function(o,a,p,y){if(o=+o,a=a>>>0,p=p>>>0,!y){const U=Math.pow(2,8*p)-1;Z(this,o,a,p,U,0)}let b=p-1,k=1;for(this[a+b]=o&255;--b>=0&&(k*=256);)this[a+b]=o/k&255;return a+p},c.prototype.writeUint8=c.prototype.writeUInt8=function(o,a,p){return o=+o,a=a>>>0,p||Z(this,o,a,1,255,0),this[a]=o&255,a+1},c.prototype.writeUint16LE=c.prototype.writeUInt16LE=function(o,a,p){return o=+o,a=a>>>0,p||Z(this,o,a,2,65535,0),this[a]=o&255,this[a+1]=o>>>8,a+2},c.prototype.writeUint16BE=c.prototype.writeUInt16BE=function(o,a,p){return o=+o,a=a>>>0,p||Z(this,o,a,2,65535,0),this[a]=o>>>8,this[a+1]=o&255,a+2},c.prototype.writeUint32LE=c.prototype.writeUInt32LE=function(o,a,p){return o=+o,a=a>>>0,p||Z(this,o,a,4,4294967295,0),this[a+3]=o>>>24,this[a+2]=o>>>16,this[a+1]=o>>>8,this[a]=o&255,a+4},c.prototype.writeUint32BE=c.prototype.writeUInt32BE=function(o,a,p){return o=+o,a=a>>>0,p||Z(this,o,a,4,4294967295,0),this[a]=o>>>24,this[a+1]=o>>>16,this[a+2]=o>>>8,this[a+3]=o&255,a+4};function se(u,o,a,p,y){Hi(o,p,y,u,a,7);let b=Number(o&BigInt(4294967295));u[a++]=b,b=b>>8,u[a++]=b,b=b>>8,u[a++]=b,b=b>>8,u[a++]=b;let k=Number(o>>BigInt(32)&BigInt(4294967295));return u[a++]=k,k=k>>8,u[a++]=k,k=k>>8,u[a++]=k,k=k>>8,u[a++]=k,a}function ue(u,o,a,p,y){Hi(o,p,y,u,a,7);let b=Number(o&BigInt(4294967295));u[a+7]=b,b=b>>8,u[a+6]=b,b=b>>8,u[a+5]=b,b=b>>8,u[a+4]=b;let k=Number(o>>BigInt(32)&BigInt(4294967295));return u[a+3]=k,k=k>>8,u[a+2]=k,k=k>>8,u[a+1]=k,k=k>>8,u[a]=k,a+8}c.prototype.writeBigUInt64LE=mt(function(o,a=0){return se(this,o,a,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeBigUInt64BE=mt(function(o,a=0){return ue(this,o,a,BigInt(0),BigInt("0xffffffffffffffff"))}),c.prototype.writeIntLE=function(o,a,p,y){if(o=+o,a=a>>>0,!y){const ie=Math.pow(2,8*p-1);Z(this,o,a,p,ie-1,-ie)}let b=0,k=1,U=0;for(this[a]=o&255;++b<p&&(k*=256);)o<0&&U===0&&this[a+b-1]!==0&&(U=1),this[a+b]=(o/k>>0)-U&255;return a+p},c.prototype.writeIntBE=function(o,a,p,y){if(o=+o,a=a>>>0,!y){const ie=Math.pow(2,8*p-1);Z(this,o,a,p,ie-1,-ie)}let b=p-1,k=1,U=0;for(this[a+b]=o&255;--b>=0&&(k*=256);)o<0&&U===0&&this[a+b+1]!==0&&(U=1),this[a+b]=(o/k>>0)-U&255;return a+p},c.prototype.writeInt8=function(o,a,p){return o=+o,a=a>>>0,p||Z(this,o,a,1,127,-128),o<0&&(o=255+o+1),this[a]=o&255,a+1},c.prototype.writeInt16LE=function(o,a,p){return o=+o,a=a>>>0,p||Z(this,o,a,2,32767,-32768),this[a]=o&255,this[a+1]=o>>>8,a+2},c.prototype.writeInt16BE=function(o,a,p){return o=+o,a=a>>>0,p||Z(this,o,a,2,32767,-32768),this[a]=o>>>8,this[a+1]=o&255,a+2},c.prototype.writeInt32LE=function(o,a,p){return o=+o,a=a>>>0,p||Z(this,o,a,4,2147483647,-2147483648),this[a]=o&255,this[a+1]=o>>>8,this[a+2]=o>>>16,this[a+3]=o>>>24,a+4},c.prototype.writeInt32BE=function(o,a,p){return o=+o,a=a>>>0,p||Z(this,o,a,4,2147483647,-2147483648),o<0&&(o=4294967295+o+1),this[a]=o>>>24,this[a+1]=o>>>16,this[a+2]=o>>>8,this[a+3]=o&255,a+4},c.prototype.writeBigInt64LE=mt(function(o,a=0){return se(this,o,a,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),c.prototype.writeBigInt64BE=mt(function(o,a=0){return ue(this,o,a,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function he(u,o,a,p,y,b){if(a+p>u.length)throw new RangeError("Index out of range");if(a<0)throw new RangeError("Index out of range")}function me(u,o,a,p,y){return o=+o,a=a>>>0,y||he(u,o,a,4),n.write(u,o,a,p,23,4),a+4}c.prototype.writeFloatLE=function(o,a,p){return me(this,o,a,!0,p)},c.prototype.writeFloatBE=function(o,a,p){return me(this,o,a,!1,p)};function Ue(u,o,a,p,y){return o=+o,a=a>>>0,y||he(u,o,a,8),n.write(u,o,a,p,52,8),a+8}c.prototype.writeDoubleLE=function(o,a,p){return Ue(this,o,a,!0,p)},c.prototype.writeDoubleBE=function(o,a,p){return Ue(this,o,a,!1,p)},c.prototype.copy=function(o,a,p,y){if(!c.isBuffer(o))throw new TypeError("argument should be a Buffer");if(p||(p=0),!y&&y!==0&&(y=this.length),a>=o.length&&(a=o.length),a||(a=0),y>0&&y<p&&(y=p),y===p||o.length===0||this.length===0)return 0;if(a<0)throw new RangeError("targetStart out of bounds");if(p<0||p>=this.length)throw new RangeError("Index out of range");if(y<0)throw new RangeError("sourceEnd out of bounds");y>this.length&&(y=this.length),o.length-a<y-p&&(y=o.length-a+p);const b=y-p;return this===o&&typeof i.prototype.copyWithin=="function"?this.copyWithin(a,p,y):i.prototype.set.call(o,this.subarray(p,y),a),b},c.prototype.fill=function(o,a,p,y){if(typeof o=="string"){if(typeof a=="string"?(y=a,a=0,p=this.length):typeof p=="string"&&(y=p,p=this.length),y!==void 0&&typeof y!="string")throw new TypeError("encoding must be a string");if(typeof y=="string"&&!c.isEncoding(y))throw new TypeError("Unknown encoding: "+y);if(o.length===1){const k=o.charCodeAt(0);(y==="utf8"&&k<128||y==="latin1")&&(o=k)}}else typeof o=="number"?o=o&255:typeof o=="boolean"&&(o=Number(o));if(a<0||this.length<a||this.length<p)throw new RangeError("Out of range index");if(p<=a)return this;a=a>>>0,p=p===void 0?this.length:p>>>0,o||(o=0);let b;if(typeof o=="number")for(b=a;b<p;++b)this[b]=o;else{const k=c.isBuffer(o)?o:c.from(o,y),U=k.length;if(U===0)throw new TypeError('The value "'+o+'" is invalid for argument "value"');for(b=0;b<p-a;++b)this[b+a]=k[b%U]}return this};const Se={};function Te(u,o,a){Se[u]=class extends a{constructor(){super(),Object.defineProperty(this,"message",{value:o.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${u}]`,this.stack,delete this.name}get code(){return u}set code(y){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:y,writable:!0})}toString(){return`${this.name} [${u}]: ${this.message}`}}}Te("ERR_BUFFER_OUT_OF_BOUNDS",function(u){return u?`${u} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),Te("ERR_INVALID_ARG_TYPE",function(u,o){return`The "${u}" argument must be of type number. Received type ${typeof o}`},TypeError),Te("ERR_OUT_OF_RANGE",function(u,o,a){let p=`The value of "${u}" is out of range.`,y=a;return Number.isInteger(a)&&Math.abs(a)>2**32?y=wr(String(a)):typeof a=="bigint"&&(y=String(a),(a>BigInt(2)**BigInt(32)||a<-(BigInt(2)**BigInt(32)))&&(y=wr(y)),y+="n"),p+=` It must be ${o}. Received ${y}`,p},RangeError);function wr(u){let o="",a=u.length;const p=u[0]==="-"?1:0;for(;a>=p+4;a-=3)o=`_${u.slice(a-3,a)}${o}`;return`${u.slice(0,a)}${o}`}function yr(u,o,a){Gt(o,"offset"),(u[o]===void 0||u[o+a]===void 0)&&Dn(o,u.length-(a+1))}function Hi(u,o,a,p,y,b){if(u>a||u<o){const k=typeof o=="bigint"?"n":"";let U;throw o===0||o===BigInt(0)?U=`>= 0${k} and < 2${k} ** ${(b+1)*8}${k}`:U=`>= -(2${k} ** ${(b+1)*8-1}${k}) and < 2 ** ${(b+1)*8-1}${k}`,new Se.ERR_OUT_OF_RANGE("value",U,u)}yr(p,y,b)}function Gt(u,o){if(typeof u!="number")throw new Se.ERR_INVALID_ARG_TYPE(o,"number",u)}function Dn(u,o,a){throw Math.floor(u)!==u?(Gt(u,a),new Se.ERR_OUT_OF_RANGE("offset","an integer",u)):o<0?new Se.ERR_BUFFER_OUT_OF_BOUNDS:new Se.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${o}`,u)}const Dl=/[^+/0-9A-Za-z-_]/g;function Rl(u){if(u=u.split("=")[0],u=u.trim().replace(Dl,""),u.length<2)return"";for(;u.length%4!==0;)u=u+"=";return u}function _s(u,o){o=o||1/0;let a;const p=u.length;let y=null;const b=[];for(let k=0;k<p;++k){if(a=u.charCodeAt(k),a>55295&&a<57344){if(!y){if(a>56319){(o-=3)>-1&&b.push(239,191,189);continue}else if(k+1===p){(o-=3)>-1&&b.push(239,191,189);continue}y=a;continue}if(a<56320){(o-=3)>-1&&b.push(239,191,189),y=a;continue}a=(y-55296<<10|a-56320)+65536}else y&&(o-=3)>-1&&b.push(239,191,189);if(y=null,a<128){if((o-=1)<0)break;b.push(a)}else if(a<2048){if((o-=2)<0)break;b.push(a>>6|192,a&63|128)}else if(a<65536){if((o-=3)<0)break;b.push(a>>12|224,a>>6&63|128,a&63|128)}else if(a<1114112){if((o-=4)<0)break;b.push(a>>18|240,a>>12&63|128,a>>6&63|128,a&63|128)}else throw new Error("Invalid code point")}return b}function Ol(u){const o=[];for(let a=0;a<u.length;++a)o.push(u.charCodeAt(a)&255);return o}function Ul(u,o){let a,p,y;const b=[];for(let k=0;k<u.length&&!((o-=2)<0);++k)a=u.charCodeAt(k),p=a>>8,y=a%256,b.push(y),b.push(p);return b}function qi(u){return e.toByteArray(Rl(u))}function br(u,o,a,p){let y;for(y=0;y<p&&!(y+a>=o.length||y>=u.length);++y)o[y+a]=u[y];return y}function Ge(u,o){return u instanceof o||u!=null&&u.constructor!=null&&u.constructor.name!=null&&u.constructor.name===o.name}function Ss(u){return u!==u}const Bl=(function(){const u="0123456789abcdef",o=new Array(256);for(let a=0;a<16;++a){const p=a*16;for(let y=0;y<16;++y)o[p+y]=u[a]+u[y]}return o})();function mt(u){return typeof BigInt>"u"?Ll:u}function Ll(){throw new Error("BigInt not supported")}})(Hl);const ve=()=>new Map,Gs=t=>{const e=ve();return t.forEach((n,r)=>{e.set(r,n)}),e},ft=(t,e,n)=>{let r=t.get(e);return r===void 0&&t.set(e,r=n()),r},Zl=(t,e)=>{const n=[];for(const[r,s]of t)n.push(e(s,r));return n},Ql=(t,e)=>{for(const[n,r]of t)if(e(r,n))return!0;return!1},Ut=()=>new Set,Is=t=>t[t.length-1],ec=(t,e)=>{for(let n=0;n<e.length;n++)t.push(e[n])},kt=Array.from,li=(t,e)=>{for(let n=0;n<t.length;n++)if(!e(t[n],n,t))return!1;return!0},Yo=(t,e)=>{for(let n=0;n<t.length;n++)if(e(t[n],n,t))return!0;return!1},tc=(t,e)=>{const n=new Array(t);for(let r=0;r<t;r++)n[r]=e(r,n);return n},es=Array.isArray;class nc{constructor(){this._observers=ve()}on(e,n){return ft(this._observers,e,Ut).add(n),n}once(e,n){const r=(...s)=>{this.off(e,r),n(...s)};this.on(e,r)}off(e,n){const r=this._observers.get(e);r!==void 0&&(r.delete(n),r.size===0&&this._observers.delete(e))}emit(e,n){return kt((this._observers.get(e)||ve()).values()).forEach(r=>r(...n))}destroy(){this._observers=ve()}}class rc{constructor(){this._observers=ve()}on(e,n){ft(this._observers,e,Ut).add(n)}once(e,n){const r=(...s)=>{this.off(e,r),n(...s)};this.on(e,r)}off(e,n){const r=this._observers.get(e);r!==void 0&&(r.delete(n),r.size===0&&this._observers.delete(e))}emit(e,n){return kt((this._observers.get(e)||ve()).values()).forEach(r=>r(...n))}destroy(){this._observers=ve()}}const Qe=Math.floor,Tr=Math.abs,Wo=(t,e)=>t<e?t:e,$t=(t,e)=>t>e?t:e,Ko=t=>t!==0?t<0:1/t<0,Ji=1,zi=2,Cs=4,Ts=8,Gn=32,lt=64,Re=128,ts=31,Js=63,Rt=127,sc=2147483647,$r=Number.MAX_SAFE_INTEGER,Yi=Number.MIN_SAFE_INTEGER,ic=Number.isInteger||(t=>typeof t=="number"&&isFinite(t)&&Qe(t)===t),oc=String.fromCharCode,ac=t=>t.toLowerCase(),lc=/^\s*/g,cc=t=>t.replace(lc,""),uc=/([A-Z])/g,Wi=(t,e)=>cc(t.replace(uc,n=>`${e}${ac(n)}`)),hc=t=>{const e=unescape(encodeURIComponent(t)),n=e.length,r=new Uint8Array(n);for(let s=0;s<n;s++)r[s]=e.codePointAt(s);return r},Jn=typeof TextEncoder<"u"?new TextEncoder:null,fc=t=>Jn.encode(t),dc=Jn?fc:hc;let Vn=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});Vn&&Vn.decode(new Uint8Array).length===1&&(Vn=null);const pc=(t,e)=>tc(e,()=>t).join("");class hr{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const ns=()=>new hr,gc=t=>{let e=t.cpos;for(let n=0;n<t.bufs.length;n++)e+=t.bufs[n].length;return e},Xe=t=>{const e=new Uint8Array(gc(t));let n=0;for(let r=0;r<t.bufs.length;r++){const s=t.bufs[r];e.set(s,n),n+=s.length}return e.set(new Uint8Array(t.cbuf.buffer,0,t.cpos),n),e},mc=(t,e)=>{const n=t.cbuf.length;n-t.cpos<e&&(t.bufs.push(new Uint8Array(t.cbuf.buffer,0,t.cpos)),t.cbuf=new Uint8Array($t(n,e)*2),t.cpos=0)},ye=(t,e)=>{const n=t.cbuf.length;t.cpos===n&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(n*2),t.cpos=0),t.cbuf[t.cpos++]=e},zs=ye,P=(t,e)=>{for(;e>Rt;)ye(t,Re|Rt&e),e=Qe(e/128);ye(t,Rt&e)},ci=(t,e)=>{const n=Ko(e);for(n&&(e=-e),ye(t,(e>Js?Re:0)|(n?lt:0)|Js&e),e=Qe(e/64);e>0;)ye(t,(e>Rt?Re:0)|Rt&e),e=Qe(e/128)},Ys=new Uint8Array(3e4),wc=Ys.length/3,yc=(t,e)=>{if(e.length<wc){const n=Jn.encodeInto(e,Ys).written||0;P(t,n);for(let r=0;r<n;r++)ye(t,Ys[r])}else Me(t,dc(e))},bc=(t,e)=>{const n=unescape(encodeURIComponent(e)),r=n.length;P(t,r);for(let s=0;s<r;s++)ye(t,n.codePointAt(s))},tn=Jn&&Jn.encodeInto?yc:bc,rs=(t,e)=>{const n=t.cbuf.length,r=t.cpos,s=Wo(n-r,e.length),i=e.length-s;t.cbuf.set(e.subarray(0,s),r),t.cpos+=s,i>0&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array($t(n*2,i)),t.cbuf.set(e.subarray(s)),t.cpos=i)},Me=(t,e)=>{P(t,e.byteLength),rs(t,e)},ui=(t,e)=>{mc(t,e);const n=new DataView(t.cbuf.buffer,t.cpos,e);return t.cpos+=e,n},Ec=(t,e)=>ui(t,4).setFloat32(0,e,!1),kc=(t,e)=>ui(t,8).setFloat64(0,e,!1),_c=(t,e)=>ui(t,8).setBigInt64(0,e,!1),Ki=new DataView(new ArrayBuffer(4)),Sc=t=>(Ki.setFloat32(0,t),Ki.getFloat32(0)===t),zn=(t,e)=>{switch(typeof e){case"string":ye(t,119),tn(t,e);break;case"number":ic(e)&&Tr(e)<=sc?(ye(t,125),ci(t,e)):Sc(e)?(ye(t,124),Ec(t,e)):(ye(t,123),kc(t,e));break;case"bigint":ye(t,122),_c(t,e);break;case"object":if(e===null)ye(t,126);else if(es(e)){ye(t,117),P(t,e.length);for(let n=0;n<e.length;n++)zn(t,e[n])}else if(e instanceof Uint8Array)ye(t,116),Me(t,e);else{ye(t,118);const n=Object.keys(e);P(t,n.length);for(let r=0;r<n.length;r++){const s=n[r];tn(t,s),zn(t,e[s])}}break;case"boolean":ye(t,e?120:121);break;default:ye(t,127)}};class Xi extends hr{constructor(e){super(),this.w=e,this.s=null,this.count=0}write(e){this.s===e?this.count++:(this.count>0&&P(this,this.count-1),this.count=1,this.w(this,e),this.s=e)}}const Zi=t=>{t.count>0&&(ci(t.encoder,t.count===1?t.s:-t.s),t.count>1&&P(t.encoder,t.count-2))};class Mr{constructor(){this.encoder=new hr,this.s=0,this.count=0}write(e){this.s===e?this.count++:(Zi(this),this.count=1,this.s=e)}toUint8Array(){return Zi(this),Xe(this.encoder)}}const Qi=t=>{if(t.count>0){const e=t.diff*2+(t.count===1?0:1);ci(t.encoder,e),t.count>1&&P(t.encoder,t.count-2)}};class Ms{constructor(){this.encoder=new hr,this.s=0,this.count=0,this.diff=0}write(e){this.diff===e-this.s?(this.s=e,this.count++):(Qi(this),this.count=1,this.diff=e-this.s,this.s=e)}toUint8Array(){return Qi(this),Xe(this.encoder)}}class xc{constructor(){this.sarr=[],this.s="",this.lensE=new Mr}write(e){this.s+=e,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(e.length)}toUint8Array(){const e=new hr;return this.sarr.push(this.s),this.s="",tn(e,this.sarr.join("")),rs(e,this.lensE.toUint8Array()),Xe(e)}}const qe=t=>new Error(t),je=()=>{throw qe("Method unimplemented")},Pe=()=>{throw qe("Unexpected case")},Xo=qe("Unexpected end of array"),Zo=qe("Integer out of Range");class ss{constructor(e){this.arr=e,this.pos=0}}const kn=t=>new ss(t),Ac=t=>t.pos!==t.arr.length,vc=(t,e)=>{const n=new Uint8Array(t.arr.buffer,t.pos+t.arr.byteOffset,e);return t.pos+=e,n},De=t=>vc(t,O(t)),un=t=>t.arr[t.pos++],O=t=>{let e=0,n=1;const r=t.arr.length;for(;t.pos<r;){const s=t.arr[t.pos++];if(e=e+(s&Rt)*n,n*=128,s<Re)return e;if(e>$r)throw Zo}throw Xo},hi=t=>{let e=t.arr[t.pos++],n=e&Js,r=64;const s=(e&lt)>0?-1:1;if((e&Re)===0)return s*n;const i=t.arr.length;for(;t.pos<i;){if(e=t.arr[t.pos++],n=n+(e&Rt)*r,r*=128,e<Re)return s*n;if(n>$r)throw Zo}throw Xo},Ic=t=>{let e=O(t);if(e===0)return"";{let n=String.fromCodePoint(un(t));if(--e<100)for(;e--;)n+=String.fromCodePoint(un(t));else for(;e>0;){const r=e<1e4?e:1e4,s=t.arr.subarray(t.pos,t.pos+r);t.pos+=r,n+=String.fromCodePoint.apply(null,s),e-=r}return decodeURIComponent(escape(n))}},Cc=t=>Vn.decode(De(t)),nn=Vn?Cc:Ic,fi=(t,e)=>{const n=new DataView(t.arr.buffer,t.arr.byteOffset+t.pos,e);return t.pos+=e,n},Tc=t=>fi(t,4).getFloat32(0,!1),Mc=t=>fi(t,8).getFloat64(0,!1),Dc=t=>fi(t,8).getBigInt64(0,!1),Rc=[t=>{},t=>null,hi,Tc,Mc,Dc,t=>!1,t=>!0,nn,t=>{const e=O(t),n={};for(let r=0;r<e;r++){const s=nn(t);n[s]=Yn(t)}return n},t=>{const e=O(t),n=[];for(let r=0;r<e;r++)n.push(Yn(t));return n},De],Yn=t=>Rc[127-un(t)](t);class eo extends ss{constructor(e,n){super(e),this.reader=n,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),Ac(this)?this.count=O(this)+1:this.count=-1),this.count--,this.s}}class Dr extends ss{constructor(e){super(e),this.s=0,this.count=0}read(){if(this.count===0){this.s=hi(this);const e=Ko(this.s);this.count=1,e&&(this.s=-this.s,this.count=O(this)+2)}return this.count--,this.s}}class Ds extends ss{constructor(e){super(e),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const e=hi(this),n=e&1;this.diff=Qe(e/2),this.count=1,n&&(this.count=O(this)+2)}return this.s+=this.diff,this.count--,this.s}}class Oc{constructor(e){this.decoder=new Dr(e),this.str=nn(this.decoder),this.spos=0}read(){const e=this.spos+this.decoder.read(),n=this.str.slice(this.spos,e);return this.spos=e,n}}const Uc=crypto.getRandomValues.bind(crypto),Qo=()=>Uc(new Uint32Array(1))[0],Bc="10000000-1000-4000-8000"+-1e11,Lc=()=>Bc.replace(/[018]/g,t=>(t^Qo()&15>>t/4).toString(16)),hn=t=>new Promise(t);Promise.all.bind(Promise);const to=t=>t===void 0?null:t;class Nc{constructor(){this.map=new Map}setItem(e,n){this.map.set(e,n)}getItem(e){return this.map.get(e)}}let ea=new Nc,Fc=!0;try{typeof localStorage<"u"&&localStorage&&(ea=localStorage,Fc=!1)}catch{}const $c=ea,Wn=Symbol("Equality"),ta=(t,e)=>t===e||!!t?.[Wn]?.(e)||!1,Pc=t=>typeof t=="object",Vc=Object.assign,jc=Object.keys,Hc=(t,e)=>{for(const n in t)e(t[n],n)},Pr=t=>jc(t).length,qc=t=>{for(const e in t)return!1;return!0},fr=(t,e)=>{for(const n in t)if(!e(t[n],n))return!1;return!0},di=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),Gc=(t,e)=>t===e||Pr(t)===Pr(e)&&fr(t,(n,r)=>(n!==void 0||di(e,r))&&ta(e[r],n)),Jc=Object.freeze,na=t=>{for(const e in t){const n=t[e];(typeof n=="object"||typeof n=="function")&&na(t[e])}return Jc(t)},pi=(t,e,n=0)=>{try{for(;n<t.length;n++)t[n](...e)}finally{n<t.length&&pi(t,e,n+1)}},zc=t=>t,Rr=(t,e)=>{if(t===e)return!0;if(t==null||e==null||t.constructor!==e.constructor&&(t.constructor||Object)!==(e.constructor||Object))return!1;if(t[Wn]!=null)return t[Wn](e);switch(t.constructor){case ArrayBuffer:t=new Uint8Array(t),e=new Uint8Array(e);case Uint8Array:{if(t.byteLength!==e.byteLength)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;break}case Set:{if(t.size!==e.size)return!1;for(const n of t)if(!e.has(n))return!1;break}case Map:{if(t.size!==e.size)return!1;for(const n of t.keys())if(!e.has(n)||!Rr(t.get(n),e.get(n)))return!1;break}case void 0:case Object:if(Pr(t)!==Pr(e))return!1;for(const n in t)if(!di(t,n)||!Rr(t[n],e[n]))return!1;break;case Array:if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(!Rr(t[n],e[n]))return!1;break;default:return!1}return!0},Yc=(t,e)=>e.includes(t);var ra={};const Kn=typeof vt<"u"&&vt.release&&/node|io\.js/.test(vt.release.name)&&Object.prototype.toString.call(typeof vt<"u"?vt:0)==="[object process]";let Je;const Wc=()=>{if(Je===void 0)if(Kn){Je=ve();const t=vt.argv;let e=null;for(let n=0;n<t.length;n++){const r=t[n];r[0]==="-"?(e!==null&&Je.set(e,""),e=r):e!==null&&(Je.set(e,r),e=null)}e!==null&&Je.set(e,"")}else typeof location=="object"?(Je=ve(),(location.search||"?").slice(1).split("&").forEach(t=>{if(t.length!==0){const[e,n]=t.split("=");Je.set(`--${Wi(e,"-")}`,n),Je.set(`-${Wi(e,"-")}`,n)}})):Je=ve();return Je},Ws=t=>Wc().has(t),Vr=t=>to(Kn?ra[t.toUpperCase().replaceAll("-","_")]:$c.getItem(t)),sa=t=>Ws("--"+t)||Vr(t)!==null,Kc=sa("production"),Xc=Kn&&Yc(ra.FORCE_COLOR,["true","1","2"]),Zc=Xc||!Ws("--no-colors")&&!sa("no-color")&&(!Kn||vt.stdout.isTTY)&&(!Kn||Ws("--color")||Vr("COLORTERM")!==null||(Vr("TERM")||"").includes("color")),Qc=t=>new Uint8Array(t),eu=t=>{const e=Qc(t.byteLength);return e.set(t),e};class tu{constructor(e,n){this.left=e,this.right=n}}const nt=(t,e)=>new tu(t,e),no=t=>t.next()>=.5,Rs=(t,e,n)=>Qe(t.next()*(n+1-e)+e),ia=(t,e,n)=>Qe(t.next()*(n+1-e)+e),gi=(t,e,n)=>ia(t,e,n),nu=t=>oc(gi(t,97,122)),ru=(t,e=0,n=20)=>{const r=gi(t,e,n);let s="";for(let i=0;i<r;i++)s+=nu(t);return s},Os=(t,e)=>e[gi(t,0,e.length-1)],su=Symbol("0schema");class iu{constructor(){this._rerrs=[]}extend(e,n,r,s=null){this._rerrs.push({path:e,expected:n,has:r,message:s})}toString(){const e=[];for(let n=this._rerrs.length-1;n>0;n--){const r=this._rerrs[n];e.push(pc(" ",(this._rerrs.length-n)*2)+`${r.path!=null?`[${r.path}] `:""}${r.has} doesn't match ${r.expected}. ${r.message}`)}return e.join(`
`)}}const Ks=(t,e)=>t===e?!0:t==null||e==null||t.constructor!==e.constructor?!1:t[Wn]?ta(t,e):es(t)?li(t,n=>Yo(e,r=>Ks(n,r))):Pc(t)?fr(t,(n,r)=>Ks(n,e[r])):!1;class Ae{static _dilutes=!1;extends(e){let[n,r]=[this.shape,e.shape];return this.constructor._dilutes&&([r,n]=[n,r]),Ks(n,r)}equals(e){return this.constructor===e.constructor&&Rr(this.shape,e.shape)}[su](){return!0}[Wn](e){return this.equals(e)}validate(e){return this.check(e)}check(e,n){je()}get nullable(){return _n(this,cs)}get optional(){return new la(this)}cast(e){return ro(e,this),e}expect(e){return ro(e,this),e}}class mi extends Ae{constructor(e,n){super(),this.shape=e,this._c=n}check(e,n=void 0){const r=e?.constructor===this.shape&&(this._c==null||this._c(e));return!r&&n?.extend(null,this.shape.name,e?.constructor.name,e?.constructor!==this.shape?"Constructor match failed":"Check failed"),r}}const ce=(t,e=null)=>new mi(t,e);ce(mi);class wi extends Ae{constructor(e){super(),this.shape=e}check(e,n){const r=this.shape(e);return!r&&n?.extend(null,"custom prop",e?.constructor.name,"failed to check custom prop"),r}}const Ee=t=>new wi(t);ce(wi);class is extends Ae{constructor(e){super(),this.shape=e}check(e,n){const r=this.shape.some(s=>s===e);return!r&&n?.extend(null,this.shape.join(" | "),e.toString()),r}}const os=(...t)=>new is(t),oa=ce(is),ou=RegExp.escape||(t=>t.replace(/[().|&,$^[\]]/g,e=>"\\"+e)),aa=t=>{if(fn.check(t))return[ou(t)];if(oa.check(t))return t.shape.map(e=>e+"");if(wa.check(t))return["[+-]?\\d+.?\\d*"];if(ya.check(t))return[".*"];if(jr.check(t))return t.shape.map(aa).flat(1);Pe()};class au extends Ae{constructor(e){super(),this.shape=e,this._r=new RegExp("^"+e.map(aa).map(n=>`(${n.join("|")})`).join("")+"$")}check(e,n){const r=this._r.exec(e)!=null;return!r&&n?.extend(null,this._r.toString(),e.toString(),"String doesn't match string template."),r}}ce(au);const lu=Symbol("optional");class la extends Ae{constructor(e){super(),this.shape=e}check(e,n){const r=e===void 0||this.shape.check(e);return!r&&n?.extend(null,"undefined (optional)","()"),r}get[lu](){return!0}}const cu=ce(la);class uu extends Ae{check(e,n){return n?.extend(null,"never",typeof e),!1}}ce(uu);class as extends Ae{constructor(e,n=!1){super(),this.shape=e,this._isPartial=n}static _dilutes=!0;get partial(){return new as(this.shape,!0)}check(e,n){return e==null?(n?.extend(null,"object","null"),!1):fr(this.shape,(r,s)=>{const i=this._isPartial&&!di(e,s)||r.check(e[s],n);return!i&&n?.extend(s.toString(),r.toString(),typeof e[s],"Object property does not match"),i})}}const hu=t=>new as(t),fu=ce(as),du=Ee(t=>t!=null&&(t.constructor===Object||t.constructor==null));class ca extends Ae{constructor(e,n){super(),this.shape={keys:e,values:n}}check(e,n){return e!=null&&fr(e,(r,s)=>{const i=this.shape.keys.check(s,n);return!i&&n?.extend(s+"","Record",typeof e,i?"Key doesn't match schema":"Value doesn't match value"),i&&this.shape.values.check(r,n)})}}const ua=(t,e)=>new ca(t,e),pu=ce(ca);class ha extends Ae{constructor(e){super(),this.shape=e}check(e,n){return e!=null&&fr(this.shape,(r,s)=>{const i=r.check(e[s],n);return!i&&n?.extend(s.toString(),"Tuple",typeof r),i})}}const gu=(...t)=>new ha(t);ce(ha);class fa extends Ae{constructor(e){super(),this.shape=e.length===1?e[0]:new yi(e)}check(e,n){const r=es(e)&&li(e,s=>this.shape.check(s));return!r&&n?.extend(null,"Array",""),r}}const da=(...t)=>new fa(t),mu=ce(fa),wu=Ee(t=>es(t));class pa extends Ae{constructor(e,n){super(),this.shape=e,this._c=n}check(e,n){const r=e instanceof this.shape&&(this._c==null||this._c(e));return!r&&n?.extend(null,this.shape.name,e?.constructor.name),r}}const yu=(t,e=null)=>new pa(t,e);ce(pa);const bu=yu(Ae);class Eu extends Ae{constructor(e){super(),this.len=e.length-1,this.args=gu(...e.slice(-1)),this.res=e[this.len]}check(e,n){const r=e.constructor===Function&&e.length<=this.len;return!r&&n?.extend(null,"function",typeof e),r}}const ku=ce(Eu),_u=Ee(t=>typeof t=="function");class Su extends Ae{constructor(e){super(),this.shape=e}check(e,n){const r=li(this.shape,s=>s.check(e,n));return!r&&n?.extend(null,"Intersectinon",typeof e),r}}ce(Su,t=>t.shape.length>0);class yi extends Ae{static _dilutes=!0;constructor(e){super(),this.shape=e}check(e,n){const r=Yo(this.shape,s=>s.check(e,n));return n?.extend(null,"Union",typeof e),r}}const _n=(...t)=>t.findIndex(e=>jr.check(e))>=0?_n(...t.map(e=>Xn(e)).map(e=>jr.check(e)?e.shape:[e]).flat(1)):t.length===1?t[0]:new yi(t),jr=ce(yi),ga=()=>!0,Hr=Ee(ga),xu=ce(wi,t=>t.shape===ga),bi=Ee(t=>typeof t=="bigint"),Au=Ee(t=>t===bi),ma=Ee(t=>typeof t=="symbol");Ee(t=>t===ma);const rn=Ee(t=>typeof t=="number"),wa=Ee(t=>t===rn),fn=Ee(t=>typeof t=="string"),ya=Ee(t=>t===fn),ls=Ee(t=>typeof t=="boolean"),vu=Ee(t=>t===ls),ba=os(void 0);ce(is,t=>t.shape.length===1&&t.shape[0]===void 0);os(void 0);const cs=os(null),Iu=ce(is,t=>t.shape.length===1&&t.shape[0]===null);ce(Uint8Array);ce(mi,t=>t.shape===Uint8Array);const Cu=_n(rn,fn,cs,ba,bi,ls,ma);(()=>{const t=da(Hr),e=ua(fn,Hr),n=_n(rn,fn,cs,ls,t,e);return t.shape=n,e.shape.values=n,n})();const Xn=t=>{if(bu.check(t))return t;if(du.check(t)){const e={};for(const n in t)e[n]=Xn(t[n]);return hu(e)}else{if(wu.check(t))return _n(...t.map(Xn));if(Cu.check(t))return os(t);if(_u.check(t))return ce(t)}Pe()},ro=Kc?()=>{}:(t,e)=>{const n=new iu;if(!e.check(t,n))throw qe(`Expected value to be of type ${e.constructor.name}.
${n.toString()}`)};class Tu{constructor(e){this.patterns=[],this.$state=e}if(e,n){return this.patterns.push({if:Xn(e),h:n}),this}else(e){return this.if(Hr,e)}done(){return(e,n)=>{for(let r=0;r<this.patterns.length;r++){const s=this.patterns[r];if(s.if.check(e))return s.h(e,n)}throw qe("Unhandled pattern")}}}const Mu=t=>new Tu(t),Ea=Mu(Hr).if(wa,(t,e)=>Rs(e,Yi,$r)).if(ya,(t,e)=>ru(e)).if(vu,(t,e)=>no(e)).if(Au,(t,e)=>BigInt(Rs(e,Yi,$r))).if(jr,(t,e)=>zt(e,Os(e,t.shape))).if(fu,(t,e)=>{const n={};for(const r in t.shape){let s=t.shape[r];if(cu.check(s)){if(no(e))continue;s=s.shape}n[r]=Ea(s,e)}return n}).if(mu,(t,e)=>{const n=[],r=ia(e,0,42);for(let s=0;s<r;s++)n.push(zt(e,t.shape));return n}).if(oa,(t,e)=>Os(e,t.shape)).if(Iu,(t,e)=>null).if(ku,(t,e)=>{const n=zt(e,t.res);return()=>n}).if(xu,(t,e)=>zt(e,Os(e,[rn,fn,cs,ba,bi,ls,da(rn),ua(_n("a","b","c"),rn)]))).if(pu,(t,e)=>{const n={},r=Rs(e,0,3);for(let s=0;s<r;s++){const i=zt(e,t.shape.keys),l=zt(e,t.shape.values);n[i]=l}return n}).done(),zt=(t,e)=>Ea(Xn(e),t),us=typeof document<"u"?document:{};Ee(t=>t.nodeType===Bu);typeof DOMParser<"u"&&new DOMParser;Ee(t=>t.nodeType===Ru);Ee(t=>t.nodeType===Ou);const Du=t=>Zl(t,(e,n)=>`${n}:${e};`).join(""),Ru=us.ELEMENT_NODE,Ou=us.TEXT_NODE,Uu=us.DOCUMENT_NODE,Bu=us.DOCUMENT_FRAGMENT_NODE;Ee(t=>t.nodeType===Uu);const dt=Symbol,ka=dt(),_a=dt(),Lu=dt(),Nu=dt(),Fu=dt(),Sa=dt(),$u=dt(),Ei=dt(),Pu=dt(),Vu=t=>{t.length===1&&t[0]?.constructor===Function&&(t=t[0]());const e=[],n=[];let r=0;for(;r<t.length;r++){const s=t[r];if(s===void 0)break;if(s.constructor===String||s.constructor===Number)e.push(s);else if(s.constructor===Object)break}for(r>0&&n.push(e.join(""));r<t.length;r++){const s=t[r];s instanceof Symbol||n.push(s)}return n},ju={[ka]:nt("font-weight","bold"),[_a]:nt("font-weight","normal"),[Lu]:nt("color","blue"),[Fu]:nt("color","green"),[Nu]:nt("color","grey"),[Sa]:nt("color","red"),[$u]:nt("color","purple"),[Ei]:nt("color","orange"),[Pu]:nt("color","black")},Hu=t=>{t.length===1&&t[0]?.constructor===Function&&(t=t[0]());const e=[],n=[],r=ve();let s=[],i=0;for(;i<t.length;i++){const l=t[i],h=ju[l];if(h!==void 0)r.set(h.left,h.right);else{if(l===void 0)break;if(l.constructor===String||l.constructor===Number){const f=Du(r);i>0||f.length>0?(e.push("%c"+l),n.push(f)):e.push(l)}else break}}for(i>0&&(s=n,s.unshift(e.join("")));i<t.length;i++){const l=t[i];l instanceof Symbol||s.push(l)}return s},xa=Zc?Hu:Vu,qu=(...t)=>{console.log(...xa(t)),Aa.forEach(e=>e.print(t))},Gu=(...t)=>{console.warn(...xa(t)),t.unshift(Ei),Aa.forEach(e=>e.print(t))},Aa=Ut(),va=t=>({[Symbol.iterator](){return this},next:t}),Ju=(t,e)=>va(()=>{let n;do n=t.next();while(!n.done&&!e(n.value));return n}),Us=(t,e)=>va(()=>{const{done:n,value:r}=t.next();return{done:n,value:n?void 0:e(r)}});class ki{constructor(e,n){this.clock=e,this.len=n}}class dr{constructor(){this.clients=new Map}}const Ia=(t,e,n)=>e.clients.forEach((r,s)=>{const i=t.doc.store.clients.get(s);if(i!=null){const l=i[i.length-1],h=l.id.clock+l.length;for(let f=0,g=r[f];f<r.length&&g.clock<h;g=r[++f])Fa(t,i,g.clock,g.len,n)}}),zu=(t,e)=>{let n=0,r=t.length-1;for(;n<=r;){const s=Qe((n+r)/2),i=t[s],l=i.clock;if(l<=e){if(e<l+i.len)return s;n=s+1}else r=s-1}return null},Ca=(t,e)=>{const n=t.clients.get(e.client);return n!==void 0&&zu(n,e.clock)!==null},_i=t=>{t.clients.forEach(e=>{e.sort((s,i)=>s.clock-i.clock);let n,r;for(n=1,r=1;n<e.length;n++){const s=e[r-1],i=e[n];s.clock+s.len>=i.clock?s.len=$t(s.len,i.clock+i.len-s.clock):(r<n&&(e[r]=i),r++)}e.length=r})},Yu=t=>{const e=new dr;for(let n=0;n<t.length;n++)t[n].clients.forEach((r,s)=>{if(!e.clients.has(s)){const i=r.slice();for(let l=n+1;l<t.length;l++)ec(i,t[l].clients.get(s)||[]);e.clients.set(s,i)}});return _i(e),e},qr=(t,e,n,r)=>{ft(t.clients,e,()=>[]).push(new ki(n,r))},Wu=()=>new dr,Ku=t=>{const e=Wu();return t.clients.forEach((n,r)=>{const s=[];for(let i=0;i<n.length;i++){const l=n[i];if(l.deleted){const h=l.id.clock;let f=l.length;if(i+1<n.length)for(let g=n[i+1];i+1<n.length&&g.deleted;g=n[++i+1])f+=g.length;s.push(new ki(h,f))}}s.length>0&&e.clients.set(r,s)}),e},Sn=(t,e)=>{P(t.restEncoder,e.clients.size),kt(e.clients.entries()).sort((n,r)=>r[0]-n[0]).forEach(([n,r])=>{t.resetDsCurVal(),P(t.restEncoder,n);const s=r.length;P(t.restEncoder,s);for(let i=0;i<s;i++){const l=r[i];t.writeDsClock(l.clock),t.writeDsLen(l.len)}})},Si=t=>{const e=new dr,n=O(t.restDecoder);for(let r=0;r<n;r++){t.resetDsCurVal();const s=O(t.restDecoder),i=O(t.restDecoder);if(i>0){const l=ft(e.clients,s,()=>[]);for(let h=0;h<i;h++)l.push(new ki(t.readDsClock(),t.readDsLen()))}}return e},so=(t,e,n)=>{const r=new dr,s=O(t.restDecoder);for(let i=0;i<s;i++){t.resetDsCurVal();const l=O(t.restDecoder),h=O(t.restDecoder),f=n.clients.get(l)||[],g=be(n,l);for(let c=0;c<h;c++){const m=t.readDsClock(),d=m+t.readDsLen();if(m<g){g<d&&qr(r,l,g,d-g);let w=et(f,m),E=f[w];for(!E.deleted&&E.id.clock<m&&(f.splice(w+1,0,Xr(e,E,m-E.id.clock)),w++);w<f.length&&(E=f[w++],E.id.clock<d);)E.deleted||(d<E.id.clock+E.length&&f.splice(w,0,Xr(e,E,d-E.id.clock)),E.delete(e))}else qr(r,l,m,d-m)}}if(r.clients.size>0){const i=new Bt;return P(i.restEncoder,0),Sn(i,r),i.toUint8Array()}return null},Ta=Qo;class xn extends nc{constructor({guid:e=Lc(),collectionid:n=null,gc:r=!0,gcFilter:s=()=>!0,meta:i=null,autoLoad:l=!1,shouldLoad:h=!0}={}){super(),this.gc=r,this.gcFilter=s,this.clientID=Ta(),this.guid=e,this.collectionid=n,this.share=new Map,this.store=new La,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=h,this.autoLoad=l,this.meta=i,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=hn(g=>{this.on("load",()=>{this.isLoaded=!0,g(this)})});const f=()=>hn(g=>{const c=m=>{(m===void 0||m===!0)&&(this.off("sync",c),g())};this.on("sync",c)});this.on("sync",g=>{g===!1&&this.isSynced&&(this.whenSynced=f()),this.isSynced=g===void 0||g===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=f()}load(){const e=this._item;e!==null&&!this.shouldLoad&&Y(e.parent.doc,n=>{n.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(kt(this.subdocs).map(e=>e.guid))}transact(e,n=null){return Y(this,e,n)}get(e,n=ke){const r=ft(this.share,e,()=>{const i=new n;return i._integrate(this,null),i}),s=r.constructor;if(n!==ke&&s!==n)if(s===ke){const i=new n;i._map=r._map,r._map.forEach(l=>{for(;l!==null;l=l.left)l.parent=i}),i._start=r._start;for(let l=i._start;l!==null;l=l.right)l.parent=i;return i._length=r._length,this.share.set(e,i),i._integrate(this,null),i}else throw new Error(`Type with the name ${e} has already been defined with a different constructor`);return r}getArray(e=""){return this.get(e,on)}getText(e=""){return this.get(e,gn)}getMap(e=""){return this.get(e,pn)}getXmlElement(e=""){return this.get(e,mn)}getXmlFragment(e=""){return this.get(e,Lt)}toJSON(){const e={};return this.share.forEach((n,r)=>{e[r]=n.toJSON()}),e}destroy(){this.isDestroyed=!0,kt(this.subdocs).forEach(n=>n.destroy());const e=this._item;if(e!==null){this._item=null;const n=e.content;n.doc=new xn({guid:this.guid,...n.opts,shouldLoad:!1}),n.doc._item=e,Y(e.parent.doc,r=>{const s=n.doc;e.deleted||r.subdocsAdded.add(s),r.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}}class Ma{constructor(e){this.restDecoder=e}resetDsCurVal(){}readDsClock(){return O(this.restDecoder)}readDsLen(){return O(this.restDecoder)}}class Da extends Ma{readLeftID(){return N(O(this.restDecoder),O(this.restDecoder))}readRightID(){return N(O(this.restDecoder),O(this.restDecoder))}readClient(){return O(this.restDecoder)}readInfo(){return un(this.restDecoder)}readString(){return nn(this.restDecoder)}readParentInfo(){return O(this.restDecoder)===1}readTypeRef(){return O(this.restDecoder)}readLen(){return O(this.restDecoder)}readAny(){return Yn(this.restDecoder)}readBuf(){return eu(De(this.restDecoder))}readJSON(){return JSON.parse(nn(this.restDecoder))}readKey(){return nn(this.restDecoder)}}class Xu{constructor(e){this.dsCurrVal=0,this.restDecoder=e}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=O(this.restDecoder),this.dsCurrVal}readDsLen(){const e=O(this.restDecoder)+1;return this.dsCurrVal+=e,e}}class dn extends Xu{constructor(e){super(e),this.keys=[],O(e),this.keyClockDecoder=new Ds(De(e)),this.clientDecoder=new Dr(De(e)),this.leftClockDecoder=new Ds(De(e)),this.rightClockDecoder=new Ds(De(e)),this.infoDecoder=new eo(De(e),un),this.stringDecoder=new Oc(De(e)),this.parentInfoDecoder=new eo(De(e),un),this.typeRefDecoder=new Dr(De(e)),this.lenDecoder=new Dr(De(e))}readLeftID(){return new sn(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new sn(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return Yn(this.restDecoder)}readBuf(){return De(this.restDecoder)}readJSON(){return Yn(this.restDecoder)}readKey(){const e=this.keyClockDecoder.read();if(e<this.keys.length)return this.keys[e];{const n=this.stringDecoder.read();return this.keys.push(n),n}}}class Zu{constructor(){this.restEncoder=ns()}toUint8Array(){return Xe(this.restEncoder)}resetDsCurVal(){}writeDsClock(e){P(this.restEncoder,e)}writeDsLen(e){P(this.restEncoder,e)}}class pr extends Zu{writeLeftID(e){P(this.restEncoder,e.client),P(this.restEncoder,e.clock)}writeRightID(e){P(this.restEncoder,e.client),P(this.restEncoder,e.clock)}writeClient(e){P(this.restEncoder,e)}writeInfo(e){zs(this.restEncoder,e)}writeString(e){tn(this.restEncoder,e)}writeParentInfo(e){P(this.restEncoder,e?1:0)}writeTypeRef(e){P(this.restEncoder,e)}writeLen(e){P(this.restEncoder,e)}writeAny(e){zn(this.restEncoder,e)}writeBuf(e){Me(this.restEncoder,e)}writeJSON(e){tn(this.restEncoder,JSON.stringify(e))}writeKey(e){tn(this.restEncoder,e)}}class Qu{constructor(){this.restEncoder=ns(),this.dsCurrVal=0}toUint8Array(){return Xe(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(e){const n=e-this.dsCurrVal;this.dsCurrVal=e,P(this.restEncoder,n)}writeDsLen(e){e===0&&Pe(),P(this.restEncoder,e-1),this.dsCurrVal+=e}}class Bt extends Qu{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new Ms,this.clientEncoder=new Mr,this.leftClockEncoder=new Ms,this.rightClockEncoder=new Ms,this.infoEncoder=new Xi(zs),this.stringEncoder=new xc,this.parentInfoEncoder=new Xi(zs),this.typeRefEncoder=new Mr,this.lenEncoder=new Mr}toUint8Array(){const e=ns();return P(e,0),Me(e,this.keyClockEncoder.toUint8Array()),Me(e,this.clientEncoder.toUint8Array()),Me(e,this.leftClockEncoder.toUint8Array()),Me(e,this.rightClockEncoder.toUint8Array()),Me(e,Xe(this.infoEncoder)),Me(e,this.stringEncoder.toUint8Array()),Me(e,Xe(this.parentInfoEncoder)),Me(e,this.typeRefEncoder.toUint8Array()),Me(e,this.lenEncoder.toUint8Array()),rs(e,Xe(this.restEncoder)),Xe(e)}writeLeftID(e){this.clientEncoder.write(e.client),this.leftClockEncoder.write(e.clock)}writeRightID(e){this.clientEncoder.write(e.client),this.rightClockEncoder.write(e.clock)}writeClient(e){this.clientEncoder.write(e)}writeInfo(e){this.infoEncoder.write(e)}writeString(e){this.stringEncoder.write(e)}writeParentInfo(e){this.parentInfoEncoder.write(e?1:0)}writeTypeRef(e){this.typeRefEncoder.write(e)}writeLen(e){this.lenEncoder.write(e)}writeAny(e){zn(this.restEncoder,e)}writeBuf(e){Me(this.restEncoder,e)}writeJSON(e){zn(this.restEncoder,e)}writeKey(e){const n=this.keyMap.get(e);n===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(e)):this.keyClockEncoder.write(n)}}const eh=(t,e,n,r)=>{r=$t(r,e[0].id.clock);const s=et(e,r);P(t.restEncoder,e.length-s),t.writeClient(n),P(t.restEncoder,r);const i=e[s];i.write(t,r-i.id.clock);for(let l=s+1;l<e.length;l++)e[l].write(t,0)},xi=(t,e,n)=>{const r=new Map;n.forEach((s,i)=>{be(e,i)>s&&r.set(i,s)}),Ai(e).forEach((s,i)=>{n.has(i)||r.set(i,0)}),P(t.restEncoder,r.size),kt(r.entries()).sort((s,i)=>i[0]-s[0]).forEach(([s,i])=>{eh(t,e.clients.get(s),s,i)})},th=(t,e)=>{const n=ve(),r=O(t.restDecoder);for(let s=0;s<r;s++){const i=O(t.restDecoder),l=new Array(i),h=t.readClient();let f=O(t.restDecoder);n.set(h,{i:0,refs:l});for(let g=0;g<i;g++){const c=t.readInfo();switch(ts&c){case 0:{const m=t.readLen();l[g]=new Fe(N(h,f),m),f+=m;break}case 10:{const m=O(t.restDecoder);l[g]=new $e(N(h,f),m),f+=m;break}default:{const m=(c&(lt|Re))===0,d=new fe(N(h,f),null,(c&Re)===Re?t.readLeftID():null,null,(c&lt)===lt?t.readRightID():null,m?t.readParentInfo()?e.get(t.readString()):t.readLeftID():null,m&&(c&Gn)===Gn?t.readString():null,rl(t,c));l[g]=d,f+=d.length}}}}return n},nh=(t,e,n)=>{const r=[];let s=kt(n.keys()).sort((w,E)=>w-E);if(s.length===0)return null;const i=()=>{if(s.length===0)return null;let w=n.get(s[s.length-1]);for(;w.refs.length===w.i;)if(s.pop(),s.length>0)w=n.get(s[s.length-1]);else return null;return w};let l=i();if(l===null)return null;const h=new La,f=new Map,g=(w,E)=>{const S=f.get(w);(S==null||S>E)&&f.set(w,E)};let c=l.refs[l.i++];const m=new Map,d=()=>{for(const w of r){const E=w.id.client,S=n.get(E);S?(S.i--,h.clients.set(E,S.refs.slice(S.i)),n.delete(E),S.i=0,S.refs=[]):h.clients.set(E,[w]),s=s.filter(I=>I!==E)}r.length=0};for(;;){if(c.constructor!==$e){const E=ft(m,c.id.client,()=>be(e,c.id.client))-c.id.clock;if(E<0)r.push(c),g(c.id.client,c.id.clock-1),d();else{const S=c.getMissing(t,e);if(S!==null){r.push(c);const I=n.get(S)||{refs:[],i:0};if(I.refs.length===I.i)g(S,be(e,S)),d();else{c=I.refs[I.i++];continue}}else(E===0||E<c.length)&&(c.integrate(t,E),m.set(c.id.client,c.id.clock+c.length))}}if(r.length>0)c=r.pop();else if(l!==null&&l.i<l.refs.length)c=l.refs[l.i++];else{if(l=i(),l===null)break;c=l.refs[l.i++]}}if(h.clients.size>0){const w=new Bt;return xi(w,h,new Map),P(w.restEncoder,0),{missing:f,update:w.toUint8Array()}}return null},rh=(t,e)=>xi(t,e.doc.store,e.beforeState),sh=(t,e,n,r=new dn(t))=>Y(e,s=>{s.local=!1;let i=!1;const l=s.doc,h=l.store,f=th(r,l),g=nh(s,h,f),c=h.pendingStructs;if(c){for(const[d,w]of c.missing)if(w<be(h,d)){i=!0;break}if(g){for(const[d,w]of g.missing){const E=c.missing.get(d);(E==null||E>w)&&c.missing.set(d,w)}c.update=Gr([c.update,g.update])}}else h.pendingStructs=g;const m=so(r,s,h);if(h.pendingDs){const d=new dn(kn(h.pendingDs));O(d.restDecoder);const w=so(d,s,h);m&&w?h.pendingDs=Gr([m,w]):h.pendingDs=m||w}else h.pendingDs=m;if(i){const d=h.pendingStructs.update;h.pendingStructs=null,Ra(s.doc,d)}},n,!1),Ra=(t,e,n,r=dn)=>{const s=kn(e);sh(s,t,n,new r(s))},ih=(t,e,n)=>Ra(t,e,n,Da),oh=(t,e,n=new Map)=>{xi(t,e.store,n),Sn(t,Ku(e.store))},ah=(t,e=new Uint8Array([0]),n=new Bt)=>{const r=Ua(e);oh(n,t,r);const s=[n.toUint8Array()];if(t.store.pendingDs&&s.push(t.store.pendingDs),t.store.pendingStructs&&s.push(bh(t.store.pendingStructs.update,e)),s.length>1){if(n.constructor===pr)return wh(s.map((i,l)=>l===0?i:kh(i)));if(n.constructor===Bt)return Gr(s)}return s[0]},Oa=(t,e)=>ah(t,e,new pr),lh=t=>{const e=new Map,n=O(t.restDecoder);for(let r=0;r<n;r++){const s=O(t.restDecoder),i=O(t.restDecoder);e.set(s,i)}return e},Ua=t=>lh(new Ma(kn(t)));class ch{constructor(){this.l=[]}}const io=()=>new ch,oo=(t,e)=>t.l.push(e),ao=(t,e)=>{const n=t.l,r=n.length;t.l=n.filter(s=>e!==s),r===t.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},Ba=(t,e,n)=>pi(t.l,[e,n]);class sn{constructor(e,n){this.client=e,this.clock=n}}const Er=(t,e)=>t===e||t!==null&&e!==null&&t.client===e.client&&t.clock===e.clock,N=(t,e)=>new sn(t,e),uh=t=>{for(const[e,n]of t.doc.share.entries())if(n===t)return e;throw Pe()},Wt=(t,e)=>e===void 0?!t.deleted:e.sv.has(t.id.client)&&(e.sv.get(t.id.client)||0)>t.id.clock&&!Ca(e.ds,t.id),Xs=(t,e)=>{const n=ft(t.meta,Xs,Ut),r=t.doc.store;n.has(e)||(e.sv.forEach((s,i)=>{s<be(r,i)&&_t(t,N(i,s))}),Ia(t,e.ds,s=>{}),n.add(e))};class La{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const Ai=t=>{const e=new Map;return t.clients.forEach((n,r)=>{const s=n[n.length-1];e.set(r,s.id.clock+s.length)}),e},be=(t,e)=>{const n=t.clients.get(e);if(n===void 0)return 0;const r=n[n.length-1];return r.id.clock+r.length},Na=(t,e)=>{let n=t.clients.get(e.id.client);if(n===void 0)n=[],t.clients.set(e.id.client,n);else{const r=n[n.length-1];if(r.id.clock+r.length!==e.id.clock)throw Pe()}n.push(e)},et=(t,e)=>{let n=0,r=t.length-1,s=t[r],i=s.id.clock;if(i===e)return r;let l=Qe(e/(i+s.length-1)*r);for(;n<=r;){if(s=t[l],i=s.id.clock,i<=e){if(e<i+s.length)return l;n=l+1}else r=l-1;l=Qe((n+r)/2)}throw Pe()},hh=(t,e)=>{const n=t.clients.get(e.client);return n[et(n,e.clock)]},Bs=hh,Zs=(t,e,n)=>{const r=et(e,n),s=e[r];return s.id.clock<n&&s instanceof fe?(e.splice(r+1,0,Xr(t,s,n-s.id.clock)),r+1):r},_t=(t,e)=>{const n=t.doc.store.clients.get(e.client);return n[Zs(t,n,e.clock)]},lo=(t,e,n)=>{const r=e.clients.get(n.client),s=et(r,n.clock),i=r[s];return n.clock!==i.id.clock+i.length-1&&i.constructor!==Fe&&r.splice(s+1,0,Xr(t,i,n.clock-i.id.clock+1)),i},fh=(t,e,n)=>{const r=t.clients.get(e.id.client);r[et(r,e.id.clock)]=n},Fa=(t,e,n,r,s)=>{if(r===0)return;const i=n+r;let l=Zs(t,e,n),h;do h=e[l++],i<h.id.clock+h.length&&Zs(t,e,i),s(h);while(l<e.length&&e[l].id.clock<i)};class dh{constructor(e,n,r){this.doc=e,this.deleteSet=new dr,this.beforeState=Ai(e.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=n,this.meta=new Map,this.local=r,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}}const co=(t,e)=>e.deleteSet.clients.size===0&&!Ql(e.afterState,(n,r)=>e.beforeState.get(r)!==n)?!1:(_i(e.deleteSet),rh(t,e),Sn(t,e.deleteSet),!0),uo=(t,e,n)=>{const r=e._item;(r===null||r.id.clock<(t.beforeState.get(r.id.client)||0)&&!r.deleted)&&ft(t.changed,e,Ut).add(n)},Or=(t,e)=>{let n=t[e],r=t[e-1],s=e;for(;s>0;n=r,r=t[--s-1]){if(r.deleted===n.deleted&&r.constructor===n.constructor&&r.mergeWith(n)){n instanceof fe&&n.parentSub!==null&&n.parent._map.get(n.parentSub)===n&&n.parent._map.set(n.parentSub,r);continue}break}const i=e-s;return i&&t.splice(e+1-i,i),i},ph=(t,e,n)=>{for(const[r,s]of t.clients.entries()){const i=e.clients.get(r);for(let l=s.length-1;l>=0;l--){const h=s[l],f=h.clock+h.len;for(let g=et(i,h.clock),c=i[g];g<i.length&&c.id.clock<f;c=i[++g]){const m=i[g];if(h.clock+h.len<=m.id.clock)break;m instanceof fe&&m.deleted&&!m.keep&&n(m)&&m.gc(e,!1)}}}},gh=(t,e)=>{t.clients.forEach((n,r)=>{const s=e.clients.get(r);for(let i=n.length-1;i>=0;i--){const l=n[i],h=Wo(s.length-1,1+et(s,l.clock+l.len-1));for(let f=h,g=s[f];f>0&&g.id.clock>=l.clock;g=s[f])f-=1+Or(s,f)}})},$a=(t,e)=>{if(e<t.length){const n=t[e],r=n.doc,s=r.store,i=n.deleteSet,l=n._mergeStructs;try{_i(i),n.afterState=Ai(n.doc.store),r.emit("beforeObserverCalls",[n,r]);const h=[];n.changed.forEach((f,g)=>h.push(()=>{(g._item===null||!g._item.deleted)&&g._callObserver(n,f)})),h.push(()=>{n.changedParentTypes.forEach((f,g)=>{g._dEH.l.length>0&&(g._item===null||!g._item.deleted)&&(f=f.filter(c=>c.target._item===null||!c.target._item.deleted),f.forEach(c=>{c.currentTarget=g,c._path=null}),f.sort((c,m)=>c.path.length-m.path.length),Ba(g._dEH,f,n))})}),h.push(()=>r.emit("afterTransaction",[n,r])),pi(h,[]),n._needFormattingCleanup&&Bh(n)}finally{r.gc&&ph(i,s,r.gcFilter),gh(i,s),n.afterState.forEach((c,m)=>{const d=n.beforeState.get(m)||0;if(d!==c){const w=s.clients.get(m),E=$t(et(w,d),1);for(let S=w.length-1;S>=E;)S-=1+Or(w,S)}});for(let c=l.length-1;c>=0;c--){const{client:m,clock:d}=l[c].id,w=s.clients.get(m),E=et(w,d);E+1<w.length&&Or(w,E+1)>1||E>0&&Or(w,E)}if(!n.local&&n.afterState.get(r.clientID)!==n.beforeState.get(r.clientID)&&(qu(Ei,ka,"[yjs] ",_a,Sa,"Changed the client-id because another client seems to be using it."),r.clientID=Ta()),r.emit("afterTransactionCleanup",[n,r]),r._observers.has("update")){const c=new pr;co(c,n)&&r.emit("update",[c.toUint8Array(),n.origin,r,n])}if(r._observers.has("updateV2")){const c=new Bt;co(c,n)&&r.emit("updateV2",[c.toUint8Array(),n.origin,r,n])}const{subdocsAdded:h,subdocsLoaded:f,subdocsRemoved:g}=n;(h.size>0||g.size>0||f.size>0)&&(h.forEach(c=>{c.clientID=r.clientID,c.collectionid==null&&(c.collectionid=r.collectionid),r.subdocs.add(c)}),g.forEach(c=>r.subdocs.delete(c)),r.emit("subdocs",[{loaded:f,added:h,removed:g},r,n]),g.forEach(c=>c.destroy())),t.length<=e+1?(r._transactionCleanups=[],r.emit("afterAllTransactions",[r,t])):$a(t,e+1)}}},Y=(t,e,n=null,r=!0)=>{const s=t._transactionCleanups;let i=!1,l=null;t._transaction===null&&(i=!0,t._transaction=new dh(t,n,r),s.push(t._transaction),s.length===1&&t.emit("beforeAllTransactions",[t]),t.emit("beforeTransaction",[t._transaction,t]));try{l=e(t._transaction)}finally{if(i){const h=t._transaction===s[0];t._transaction=null,h&&$a(s,0)}}return l};function*mh(t){const e=O(t.restDecoder);for(let n=0;n<e;n++){const r=O(t.restDecoder),s=t.readClient();let i=O(t.restDecoder);for(let l=0;l<r;l++){const h=t.readInfo();if(h===10){const f=O(t.restDecoder);yield new $e(N(s,i),f),i+=f}else if((ts&h)!==0){const f=(h&(lt|Re))===0,g=new fe(N(s,i),null,(h&Re)===Re?t.readLeftID():null,null,(h&lt)===lt?t.readRightID():null,f?t.readParentInfo()?t.readString():t.readLeftID():null,f&&(h&Gn)===Gn?t.readString():null,rl(t,h));yield g,i+=g.length}else{const f=t.readLen();yield new Fe(N(s,i),f),i+=f}}}}class vi{constructor(e,n){this.gen=mh(e),this.curr=null,this.done=!1,this.filterSkips=n,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===$e);return this.curr}}class Ii{constructor(e){this.currClient=0,this.startClock=0,this.written=0,this.encoder=e,this.clientStructs=[]}}const wh=t=>Gr(t,Da,pr),yh=(t,e)=>{if(t.constructor===Fe){const{client:n,clock:r}=t.id;return new Fe(N(n,r+e),t.length-e)}else if(t.constructor===$e){const{client:n,clock:r}=t.id;return new $e(N(n,r+e),t.length-e)}else{const n=t,{client:r,clock:s}=n.id;return new fe(N(r,s+e),null,N(r,s+e-1),null,n.rightOrigin,n.parent,n.parentSub,n.content.splice(e))}},Gr=(t,e=dn,n=Bt)=>{if(t.length===1)return t[0];const r=t.map(c=>new e(kn(c)));let s=r.map(c=>new vi(c,!0)),i=null;const l=new n,h=new Ii(l);for(;s=s.filter(d=>d.curr!==null),s.sort((d,w)=>{if(d.curr.id.client===w.curr.id.client){const E=d.curr.id.clock-w.curr.id.clock;return E===0?d.curr.constructor===w.curr.constructor?0:d.curr.constructor===$e?1:-1:E}else return w.curr.id.client-d.curr.id.client}),s.length!==0;){const c=s[0],m=c.curr.id.client;if(i!==null){let d=c.curr,w=!1;for(;d!==null&&d.id.clock+d.length<=i.struct.id.clock+i.struct.length&&d.id.client>=i.struct.id.client;)d=c.next(),w=!0;if(d===null||d.id.client!==m||w&&d.id.clock>i.struct.id.clock+i.struct.length)continue;if(m!==i.struct.id.client)yt(h,i.struct,i.offset),i={struct:d,offset:0},c.next();else if(i.struct.id.clock+i.struct.length<d.id.clock)if(i.struct.constructor===$e)i.struct.length=d.id.clock+d.length-i.struct.id.clock;else{yt(h,i.struct,i.offset);const E=d.id.clock-i.struct.id.clock-i.struct.length;i={struct:new $e(N(m,i.struct.id.clock+i.struct.length),E),offset:0}}else{const E=i.struct.id.clock+i.struct.length-d.id.clock;E>0&&(i.struct.constructor===$e?i.struct.length-=E:d=yh(d,E)),i.struct.mergeWith(d)||(yt(h,i.struct,i.offset),i={struct:d,offset:0},c.next())}}else i={struct:c.curr,offset:0},c.next();for(let d=c.curr;d!==null&&d.id.client===m&&d.id.clock===i.struct.id.clock+i.struct.length&&d.constructor!==$e;d=c.next())yt(h,i.struct,i.offset),i={struct:d,offset:0}}i!==null&&(yt(h,i.struct,i.offset),i=null),Ci(h);const f=r.map(c=>Si(c)),g=Yu(f);return Sn(l,g),l.toUint8Array()},bh=(t,e,n=dn,r=Bt)=>{const s=Ua(e),i=new r,l=new Ii(i),h=new n(kn(t)),f=new vi(h,!1);for(;f.curr;){const c=f.curr,m=c.id.client,d=s.get(m)||0;if(f.curr.constructor===$e){f.next();continue}if(c.id.clock+c.length>d)for(yt(l,c,$t(d-c.id.clock,0)),f.next();f.curr&&f.curr.id.client===m;)yt(l,f.curr,0),f.next();else for(;f.curr&&f.curr.id.client===m&&f.curr.id.clock+f.curr.length<=d;)f.next()}Ci(l);const g=Si(h);return Sn(i,g),i.toUint8Array()},Pa=t=>{t.written>0&&(t.clientStructs.push({written:t.written,restEncoder:Xe(t.encoder.restEncoder)}),t.encoder.restEncoder=ns(),t.written=0)},yt=(t,e,n)=>{t.written>0&&t.currClient!==e.id.client&&Pa(t),t.written===0&&(t.currClient=e.id.client,t.encoder.writeClient(e.id.client),P(t.encoder.restEncoder,e.id.clock+n)),e.write(t.encoder,n),t.written++},Ci=t=>{Pa(t);const e=t.encoder.restEncoder;P(e,t.clientStructs.length);for(let n=0;n<t.clientStructs.length;n++){const r=t.clientStructs[n];P(e,r.written),rs(e,r.restEncoder)}},Eh=(t,e,n,r)=>{const s=new n(kn(t)),i=new vi(s,!1),l=new r,h=new Ii(l);for(let g=i.curr;g!==null;g=i.next())yt(h,e(g),0);Ci(h);const f=Si(s);return Sn(l,f),l.toUint8Array()},kh=t=>Eh(t,zc,dn,pr),ho="You must not compute changes after the event-handler fired.";class hs{constructor(e,n){this.target=e,this.currentTarget=e,this.transaction=n,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=_h(this.currentTarget,this.target))}deletes(e){return Ca(this.transaction.deleteSet,e.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw qe(ho);const e=new Map,n=this.target;this.transaction.changed.get(n).forEach(s=>{if(s!==null){const i=n._map.get(s);let l,h;if(this.adds(i)){let f=i.left;for(;f!==null&&this.adds(f);)f=f.left;if(this.deletes(i))if(f!==null&&this.deletes(f))l="delete",h=Is(f.content.getContent());else return;else f!==null&&this.deletes(f)?(l="update",h=Is(f.content.getContent())):(l="add",h=void 0)}else if(this.deletes(i))l="delete",h=Is(i.content.getContent());else return;e.set(s,{action:l,oldValue:h})}}),this._keys=e}return this._keys}get delta(){return this.changes.delta}adds(e){return e.id.clock>=(this.transaction.beforeState.get(e.id.client)||0)}get changes(){let e=this._changes;if(e===null){if(this.transaction.doc._transactionCleanups.length===0)throw qe(ho);const n=this.target,r=Ut(),s=Ut(),i=[];if(e={added:r,deleted:s,delta:i,keys:this.keys},this.transaction.changed.get(n).has(null)){let h=null;const f=()=>{h&&i.push(h)};for(let g=n._start;g!==null;g=g.right)g.deleted?this.deletes(g)&&!this.adds(g)&&((h===null||h.delete===void 0)&&(f(),h={delete:0}),h.delete+=g.length,s.add(g)):this.adds(g)?((h===null||h.insert===void 0)&&(f(),h={insert:[]}),h.insert=h.insert.concat(g.content.getContent()),r.add(g)):((h===null||h.retain===void 0)&&(f(),h={retain:0}),h.retain+=g.length);h!==null&&h.retain===void 0&&f()}this._changes=e}return e}}const _h=(t,e)=>{const n=[];for(;e._item!==null&&e!==t;){if(e._item.parentSub!==null)n.unshift(e._item.parentSub);else{let r=0,s=e._item.parent._start;for(;s!==e._item&&s!==null;)!s.deleted&&s.countable&&(r+=s.length),s=s.right;n.unshift(r)}e=e._item.parent}return n},xe=()=>{Gu("Invalid access: Add Yjs type to a document before reading data.")},Va=80;let Ti=0;class Sh{constructor(e,n){e.marker=!0,this.p=e,this.index=n,this.timestamp=Ti++}}const xh=t=>{t.timestamp=Ti++},ja=(t,e,n)=>{t.p.marker=!1,t.p=e,e.marker=!0,t.index=n,t.timestamp=Ti++},Ah=(t,e,n)=>{if(t.length>=Va){const r=t.reduce((s,i)=>s.timestamp<i.timestamp?s:i);return ja(r,e,n),r}else{const r=new Sh(e,n);return t.push(r),r}},fs=(t,e)=>{if(t._start===null||e===0||t._searchMarker===null)return null;const n=t._searchMarker.length===0?null:t._searchMarker.reduce((i,l)=>Tr(e-i.index)<Tr(e-l.index)?i:l);let r=t._start,s=0;for(n!==null&&(r=n.p,s=n.index,xh(n));r.right!==null&&s<e;){if(!r.deleted&&r.countable){if(e<s+r.length)break;s+=r.length}r=r.right}for(;r.left!==null&&s>e;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);for(;r.left!==null&&r.left.id.client===r.id.client&&r.left.id.clock+r.left.length===r.id.clock;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);return n!==null&&Tr(n.index-s)<r.parent.length/Va?(ja(n,r,s),n):Ah(t._searchMarker,r,s)},Zn=(t,e,n)=>{for(let r=t.length-1;r>=0;r--){const s=t[r];if(n>0){let i=s.p;for(i.marker=!1;i&&(i.deleted||!i.countable);)i=i.left,i&&!i.deleted&&i.countable&&(s.index-=i.length);if(i===null||i.marker===!0){t.splice(r,1);continue}s.p=i,i.marker=!0}(e<s.index||n>0&&e===s.index)&&(s.index=$t(e,s.index+n))}},ds=(t,e,n)=>{const r=t,s=e.changedParentTypes;for(;ft(s,t,()=>[]).push(n),t._item!==null;)t=t._item.parent;Ba(r._eH,n,e)};class ke{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=io(),this._dEH=io(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(e,n){this.doc=e,this._item=n}_copy(){throw je()}clone(){throw je()}_write(e){}get _first(){let e=this._start;for(;e!==null&&e.deleted;)e=e.right;return e}_callObserver(e,n){!e.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(e){oo(this._eH,e)}observeDeep(e){oo(this._dEH,e)}unobserve(e){ao(this._eH,e)}unobserveDeep(e){ao(this._dEH,e)}toJSON(){}}const Ha=(t,e,n)=>{t.doc??xe(),e<0&&(e=t._length+e),n<0&&(n=t._length+n);let r=n-e;const s=[];let i=t._start;for(;i!==null&&r>0;){if(i.countable&&!i.deleted){const l=i.content.getContent();if(l.length<=e)e-=l.length;else{for(let h=e;h<l.length&&r>0;h++)s.push(l[h]),r--;e=0}}i=i.right}return s},qa=t=>{t.doc??xe();const e=[];let n=t._start;for(;n!==null;){if(n.countable&&!n.deleted){const r=n.content.getContent();for(let s=0;s<r.length;s++)e.push(r[s])}n=n.right}return e},Qn=(t,e)=>{let n=0,r=t._start;for(t.doc??xe();r!==null;){if(r.countable&&!r.deleted){const s=r.content.getContent();for(let i=0;i<s.length;i++)e(s[i],n++,t)}r=r.right}},Ga=(t,e)=>{const n=[];return Qn(t,(r,s)=>{n.push(e(r,s,t))}),n},vh=t=>{let e=t._start,n=null,r=0;return{[Symbol.iterator](){return this},next:()=>{if(n===null){for(;e!==null&&e.deleted;)e=e.right;if(e===null)return{done:!0,value:void 0};n=e.content.getContent(),r=0,e=e.right}const s=n[r++];return n.length<=r&&(n=null),{done:!1,value:s}}}},Ja=(t,e)=>{t.doc??xe();const n=fs(t,e);let r=t._start;for(n!==null&&(r=n.p,e-=n.index);r!==null;r=r.right)if(!r.deleted&&r.countable){if(e<r.length)return r.content.getContent()[e];e-=r.length}},Jr=(t,e,n,r)=>{let s=n;const i=t.doc,l=i.clientID,h=i.store,f=n===null?e._start:n.right;let g=[];const c=()=>{g.length>0&&(s=new fe(N(l,be(h,l)),s,s&&s.lastId,f,f&&f.id,e,null,new Nt(g)),s.integrate(t,0),g=[])};r.forEach(m=>{if(m===null)g.push(m);else switch(m.constructor){case Number:case Object:case Boolean:case Array:case String:g.push(m);break;default:switch(c(),m.constructor){case Uint8Array:case ArrayBuffer:s=new fe(N(l,be(h,l)),s,s&&s.lastId,f,f&&f.id,e,null,new gr(new Uint8Array(m))),s.integrate(t,0);break;case xn:s=new fe(N(l,be(h,l)),s,s&&s.lastId,f,f&&f.id,e,null,new mr(m)),s.integrate(t,0);break;default:if(m instanceof ke)s=new fe(N(l,be(h,l)),s,s&&s.lastId,f,f&&f.id,e,null,new pt(m)),s.integrate(t,0);else throw new Error("Unexpected content type in insert operation")}}}),c()},za=()=>qe("Length exceeded!"),Ya=(t,e,n,r)=>{if(n>e._length)throw za();if(n===0)return e._searchMarker&&Zn(e._searchMarker,n,r.length),Jr(t,e,null,r);const s=n,i=fs(e,n);let l=e._start;for(i!==null&&(l=i.p,n-=i.index,n===0&&(l=l.prev,n+=l&&l.countable&&!l.deleted?l.length:0));l!==null;l=l.right)if(!l.deleted&&l.countable){if(n<=l.length){n<l.length&&_t(t,N(l.id.client,l.id.clock+n));break}n-=l.length}return e._searchMarker&&Zn(e._searchMarker,s,r.length),Jr(t,e,l,r)},Ih=(t,e,n)=>{let s=(e._searchMarker||[]).reduce((i,l)=>l.index>i.index?l:i,{index:0,p:e._start}).p;if(s)for(;s.right;)s=s.right;return Jr(t,e,s,n)},Wa=(t,e,n,r)=>{if(r===0)return;const s=n,i=r,l=fs(e,n);let h=e._start;for(l!==null&&(h=l.p,n-=l.index);h!==null&&n>0;h=h.right)!h.deleted&&h.countable&&(n<h.length&&_t(t,N(h.id.client,h.id.clock+n)),n-=h.length);for(;r>0&&h!==null;)h.deleted||(r<h.length&&_t(t,N(h.id.client,h.id.clock+r)),h.delete(t),r-=h.length),h=h.right;if(r>0)throw za();e._searchMarker&&Zn(e._searchMarker,s,-i+r)},zr=(t,e,n)=>{const r=e._map.get(n);r!==void 0&&r.delete(t)},Mi=(t,e,n,r)=>{const s=e._map.get(n)||null,i=t.doc,l=i.clientID;let h;if(r==null)h=new Nt([r]);else switch(r.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:h=new Nt([r]);break;case Uint8Array:h=new gr(r);break;case xn:h=new mr(r);break;default:if(r instanceof ke)h=new pt(r);else throw new Error("Unexpected content type")}new fe(N(l,be(i.store,l)),s,s&&s.lastId,null,null,e,n,h).integrate(t,0)},Di=(t,e)=>{t.doc??xe();const n=t._map.get(e);return n!==void 0&&!n.deleted?n.content.getContent()[n.length-1]:void 0},Ka=t=>{const e={};return t.doc??xe(),t._map.forEach((n,r)=>{n.deleted||(e[r]=n.content.getContent()[n.length-1])}),e},Xa=(t,e)=>{t.doc??xe();const n=t._map.get(e);return n!==void 0&&!n.deleted},Ch=(t,e)=>{const n={};return t._map.forEach((r,s)=>{let i=r;for(;i!==null&&(!e.sv.has(i.id.client)||i.id.clock>=(e.sv.get(i.id.client)||0));)i=i.left;i!==null&&Wt(i,e)&&(n[s]=i.content.getContent()[i.length-1])}),n},kr=t=>(t.doc??xe(),Ju(t._map.entries(),e=>!e[1].deleted));class Th extends hs{}class on extends ke{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(e){const n=new on;return n.push(e),n}_integrate(e,n){super._integrate(e,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new on}clone(){const e=new on;return e.insert(0,this.toArray().map(n=>n instanceof ke?n.clone():n)),e}get length(){return this.doc??xe(),this._length}_callObserver(e,n){super._callObserver(e,n),ds(this,e,new Th(this,e))}insert(e,n){this.doc!==null?Y(this.doc,r=>{Ya(r,this,e,n)}):this._prelimContent.splice(e,0,...n)}push(e){this.doc!==null?Y(this.doc,n=>{Ih(n,this,e)}):this._prelimContent.push(...e)}unshift(e){this.insert(0,e)}delete(e,n=1){this.doc!==null?Y(this.doc,r=>{Wa(r,this,e,n)}):this._prelimContent.splice(e,n)}get(e){return Ja(this,e)}toArray(){return qa(this)}slice(e=0,n=this.length){return Ha(this,e,n)}toJSON(){return this.map(e=>e instanceof ke?e.toJSON():e)}map(e){return Ga(this,e)}forEach(e){Qn(this,e)}[Symbol.iterator](){return vh(this)}_write(e){e.writeTypeRef(ef)}}const Mh=t=>new on;class Dh extends hs{constructor(e,n,r){super(e,n),this.keysChanged=r}}class pn extends ke{constructor(e){super(),this._prelimContent=null,e===void 0?this._prelimContent=new Map:this._prelimContent=new Map(e)}_integrate(e,n){super._integrate(e,n),this._prelimContent.forEach((r,s)=>{this.set(s,r)}),this._prelimContent=null}_copy(){return new pn}clone(){const e=new pn;return this.forEach((n,r)=>{e.set(r,n instanceof ke?n.clone():n)}),e}_callObserver(e,n){ds(this,e,new Dh(this,e,n))}toJSON(){this.doc??xe();const e={};return this._map.forEach((n,r)=>{if(!n.deleted){const s=n.content.getContent()[n.length-1];e[r]=s instanceof ke?s.toJSON():s}}),e}get size(){return[...kr(this)].length}keys(){return Us(kr(this),e=>e[0])}values(){return Us(kr(this),e=>e[1].content.getContent()[e[1].length-1])}entries(){return Us(kr(this),e=>[e[0],e[1].content.getContent()[e[1].length-1]])}forEach(e){this.doc??xe(),this._map.forEach((n,r)=>{n.deleted||e(n.content.getContent()[n.length-1],r,this)})}[Symbol.iterator](){return this.entries()}delete(e){this.doc!==null?Y(this.doc,n=>{zr(n,this,e)}):this._prelimContent.delete(e)}set(e,n){return this.doc!==null?Y(this.doc,r=>{Mi(r,this,e,n)}):this._prelimContent.set(e,n),n}get(e){return Di(this,e)}has(e){return Xa(this,e)}clear(){this.doc!==null?Y(this.doc,e=>{this.forEach(function(n,r,s){zr(e,s,r)})}):this._prelimContent.clear()}_write(e){e.writeTypeRef(tf)}}const Rh=t=>new pn,Et=(t,e)=>t===e||typeof t=="object"&&typeof e=="object"&&t&&e&&Gc(t,e);class Qs{constructor(e,n,r,s){this.left=e,this.right=n,this.index=r,this.currentAttributes=s}forward(){switch(this.right===null&&Pe(),this.right.content.constructor){case de:this.right.deleted||An(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}}const fo=(t,e,n)=>{for(;e.right!==null&&n>0;){switch(e.right.content.constructor){case de:e.right.deleted||An(e.currentAttributes,e.right.content);break;default:e.right.deleted||(n<e.right.length&&_t(t,N(e.right.id.client,e.right.id.clock+n)),e.index+=e.right.length,n-=e.right.length);break}e.left=e.right,e.right=e.right.right}return e},_r=(t,e,n,r)=>{const s=new Map,i=r?fs(e,n):null;if(i){const l=new Qs(i.p.left,i.p,i.index,s);return fo(t,l,n-i.index)}else{const l=new Qs(null,e._start,0,s);return fo(t,l,n)}},Za=(t,e,n,r)=>{for(;n.right!==null&&(n.right.deleted===!0||n.right.content.constructor===de&&Et(r.get(n.right.content.key),n.right.content.value));)n.right.deleted||r.delete(n.right.content.key),n.forward();const s=t.doc,i=s.clientID;r.forEach((l,h)=>{const f=n.left,g=n.right,c=new fe(N(i,be(s.store,i)),f,f&&f.lastId,g,g&&g.id,e,null,new de(h,l));c.integrate(t,0),n.right=c,n.forward()})},An=(t,e)=>{const{key:n,value:r}=e;r===null?t.delete(n):t.set(n,r)},Qa=(t,e)=>{for(;t.right!==null;){if(!(t.right.deleted||t.right.content.constructor===de&&Et(e[t.right.content.key]??null,t.right.content.value)))break;t.forward()}},el=(t,e,n,r)=>{const s=t.doc,i=s.clientID,l=new Map;for(const h in r){const f=r[h],g=n.currentAttributes.get(h)??null;if(!Et(g,f)){l.set(h,g);const{left:c,right:m}=n;n.right=new fe(N(i,be(s.store,i)),c,c&&c.lastId,m,m&&m.id,e,null,new de(h,f)),n.right.integrate(t,0),n.forward()}}return l},Ls=(t,e,n,r,s)=>{n.currentAttributes.forEach((d,w)=>{s[w]===void 0&&(s[w]=null)});const i=t.doc,l=i.clientID;Qa(n,s);const h=el(t,e,n,s),f=r.constructor===String?new tt(r):r instanceof ke?new pt(r):new Pt(r);let{left:g,right:c,index:m}=n;e._searchMarker&&Zn(e._searchMarker,n.index,f.getLength()),c=new fe(N(l,be(i.store,l)),g,g&&g.lastId,c,c&&c.id,e,null,f),c.integrate(t,0),n.right=c,n.index=m,n.forward(),Za(t,e,n,h)},po=(t,e,n,r,s)=>{const i=t.doc,l=i.clientID;Qa(n,s);const h=el(t,e,n,s);e:for(;n.right!==null&&(r>0||h.size>0&&(n.right.deleted||n.right.content.constructor===de));){if(!n.right.deleted)switch(n.right.content.constructor){case de:{const{key:f,value:g}=n.right.content,c=s[f];if(c!==void 0){if(Et(c,g))h.delete(f);else{if(r===0)break e;h.set(f,g)}n.right.delete(t)}else n.currentAttributes.set(f,g);break}default:r<n.right.length&&_t(t,N(n.right.id.client,n.right.id.clock+r)),r-=n.right.length;break}n.forward()}if(r>0){let f="";for(;r>0;r--)f+=`
`;n.right=new fe(N(l,be(i.store,l)),n.left,n.left&&n.left.lastId,n.right,n.right&&n.right.id,e,null,new tt(f)),n.right.integrate(t,0),n.forward()}Za(t,e,n,h)},tl=(t,e,n,r,s)=>{let i=e;const l=ve();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===de){const g=i.content;l.set(g.key,g)}i=i.right}let h=0,f=!1;for(;e!==i;){if(n===e&&(f=!0),!e.deleted){const g=e.content;switch(g.constructor){case de:{const{key:c,value:m}=g,d=r.get(c)??null;(l.get(c)!==g||d===m)&&(e.delete(t),h++,!f&&(s.get(c)??null)===m&&d!==m&&(d===null?s.delete(c):s.set(c,d))),!f&&!e.deleted&&An(s,g);break}}}e=e.right}return h},Oh=(t,e)=>{for(;e&&e.right&&(e.right.deleted||!e.right.countable);)e=e.right;const n=new Set;for(;e&&(e.deleted||!e.countable);){if(!e.deleted&&e.content.constructor===de){const r=e.content.key;n.has(r)?e.delete(t):n.add(r)}e=e.left}},Uh=t=>{let e=0;return Y(t.doc,n=>{let r=t._start,s=t._start,i=ve();const l=Gs(i);for(;s;){if(s.deleted===!1)switch(s.content.constructor){case de:An(l,s.content);break;default:e+=tl(n,r,s,i,l),i=Gs(l),r=s;break}s=s.right}}),e},Bh=t=>{const e=new Set,n=t.doc;for(const[r,s]of t.afterState.entries()){const i=t.beforeState.get(r)||0;s!==i&&Fa(t,n.store.clients.get(r),i,s,l=>{!l.deleted&&l.content.constructor===de&&l.constructor!==Fe&&e.add(l.parent)})}Y(n,r=>{Ia(t,t.deleteSet,s=>{if(s instanceof Fe||!s.parent._hasFormatting||e.has(s.parent))return;const i=s.parent;s.content.constructor===de?e.add(i):Oh(r,s)});for(const s of e)Uh(s)})},go=(t,e,n)=>{const r=n,s=Gs(e.currentAttributes),i=e.right;for(;n>0&&e.right!==null;){if(e.right.deleted===!1)switch(e.right.content.constructor){case pt:case Pt:case tt:n<e.right.length&&_t(t,N(e.right.id.client,e.right.id.clock+n)),n-=e.right.length,e.right.delete(t);break}e.forward()}i&&tl(t,i,e.right,s,e.currentAttributes);const l=(e.left||e.right).parent;return l._searchMarker&&Zn(l._searchMarker,e.index,-r+n),e};class Lh extends hs{constructor(e,n,r){super(e,n),this.childListChanged=!1,this.keysChanged=new Set,r.forEach(s=>{s===null?this.childListChanged=!0:this.keysChanged.add(s)})}get changes(){if(this._changes===null){const e={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=e}return this._changes}get delta(){if(this._delta===null){const e=this.target.doc,n=[];Y(e,r=>{const s=new Map,i=new Map;let l=this.target._start,h=null;const f={};let g="",c=0,m=0;const d=()=>{if(h!==null){let w=null;switch(h){case"delete":m>0&&(w={delete:m}),m=0;break;case"insert":(typeof g=="object"||g.length>0)&&(w={insert:g},s.size>0&&(w.attributes={},s.forEach((E,S)=>{E!==null&&(w.attributes[S]=E)}))),g="";break;case"retain":c>0&&(w={retain:c},qc(f)||(w.attributes=Vc({},f))),c=0;break}w&&n.push(w),h=null}};for(;l!==null;){switch(l.content.constructor){case pt:case Pt:this.adds(l)?this.deletes(l)||(d(),h="insert",g=l.content.getContent()[0],d()):this.deletes(l)?(h!=="delete"&&(d(),h="delete"),m+=1):l.deleted||(h!=="retain"&&(d(),h="retain"),c+=1);break;case tt:this.adds(l)?this.deletes(l)||(h!=="insert"&&(d(),h="insert"),g+=l.content.str):this.deletes(l)?(h!=="delete"&&(d(),h="delete"),m+=l.length):l.deleted||(h!=="retain"&&(d(),h="retain"),c+=l.length);break;case de:{const{key:w,value:E}=l.content;if(this.adds(l)){if(!this.deletes(l)){const S=s.get(w)??null;Et(S,E)?E!==null&&l.delete(r):(h==="retain"&&d(),Et(E,i.get(w)??null)?delete f[w]:f[w]=E)}}else if(this.deletes(l)){i.set(w,E);const S=s.get(w)??null;Et(S,E)||(h==="retain"&&d(),f[w]=S)}else if(!l.deleted){i.set(w,E);const S=f[w];S!==void 0&&(Et(S,E)?S!==null&&l.delete(r):(h==="retain"&&d(),E===null?delete f[w]:f[w]=E))}l.deleted||(h==="insert"&&d(),An(s,l.content));break}}l=l.right}for(d();n.length>0;){const w=n[n.length-1];if(w.retain!==void 0&&w.attributes===void 0)n.pop();else break}}),this._delta=n}return this._delta}}class gn extends ke{constructor(e){super(),this._pending=e!==void 0?[()=>this.insert(0,e)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??xe(),this._length}_integrate(e,n){super._integrate(e,n);try{this._pending.forEach(r=>r())}catch(r){console.error(r)}this._pending=null}_copy(){return new gn}clone(){const e=new gn;return e.applyDelta(this.toDelta()),e}_callObserver(e,n){super._callObserver(e,n);const r=new Lh(this,e,n);ds(this,e,r),!e.local&&this._hasFormatting&&(e._needFormattingCleanup=!0)}toString(){this.doc??xe();let e="",n=this._start;for(;n!==null;)!n.deleted&&n.countable&&n.content.constructor===tt&&(e+=n.content.str),n=n.right;return e}toJSON(){return this.toString()}applyDelta(e,{sanitize:n=!0}={}){this.doc!==null?Y(this.doc,r=>{const s=new Qs(null,this._start,0,new Map);for(let i=0;i<e.length;i++){const l=e[i];if(l.insert!==void 0){const h=!n&&typeof l.insert=="string"&&i===e.length-1&&s.right===null&&l.insert.slice(-1)===`
`?l.insert.slice(0,-1):l.insert;(typeof h!="string"||h.length>0)&&Ls(r,this,s,h,l.attributes||{})}else l.retain!==void 0?po(r,this,s,l.retain,l.attributes||{}):l.delete!==void 0&&go(r,s,l.delete)}}):this._pending.push(()=>this.applyDelta(e))}toDelta(e,n,r){this.doc??xe();const s=[],i=new Map,l=this.doc;let h="",f=this._start;function g(){if(h.length>0){const m={};let d=!1;i.forEach((E,S)=>{d=!0,m[S]=E});const w={insert:h};d&&(w.attributes=m),s.push(w),h=""}}const c=()=>{for(;f!==null;){if(Wt(f,e)||n!==void 0&&Wt(f,n))switch(f.content.constructor){case tt:{const m=i.get("ychange");e!==void 0&&!Wt(f,e)?(m===void 0||m.user!==f.id.client||m.type!=="removed")&&(g(),i.set("ychange",r?r("removed",f.id):{type:"removed"})):n!==void 0&&!Wt(f,n)?(m===void 0||m.user!==f.id.client||m.type!=="added")&&(g(),i.set("ychange",r?r("added",f.id):{type:"added"})):m!==void 0&&(g(),i.delete("ychange")),h+=f.content.str;break}case pt:case Pt:{g();const m={insert:f.content.getContent()[0]};if(i.size>0){const d={};m.attributes=d,i.forEach((w,E)=>{d[E]=w})}s.push(m);break}case de:Wt(f,e)&&(g(),An(i,f.content));break}f=f.right}g()};return e||n?Y(l,m=>{e&&Xs(m,e),n&&Xs(m,n),c()},"cleanup"):c(),s}insert(e,n,r){if(n.length<=0)return;const s=this.doc;s!==null?Y(s,i=>{const l=_r(i,this,e,!r);r||(r={},l.currentAttributes.forEach((h,f)=>{r[f]=h})),Ls(i,this,l,n,r)}):this._pending.push(()=>this.insert(e,n,r))}insertEmbed(e,n,r){const s=this.doc;s!==null?Y(s,i=>{const l=_r(i,this,e,!r);Ls(i,this,l,n,r||{})}):this._pending.push(()=>this.insertEmbed(e,n,r||{}))}delete(e,n){if(n===0)return;const r=this.doc;r!==null?Y(r,s=>{go(s,_r(s,this,e,!0),n)}):this._pending.push(()=>this.delete(e,n))}format(e,n,r){if(n===0)return;const s=this.doc;s!==null?Y(s,i=>{const l=_r(i,this,e,!1);l.right!==null&&po(i,this,l,n,r)}):this._pending.push(()=>this.format(e,n,r))}removeAttribute(e){this.doc!==null?Y(this.doc,n=>{zr(n,this,e)}):this._pending.push(()=>this.removeAttribute(e))}setAttribute(e,n){this.doc!==null?Y(this.doc,r=>{Mi(r,this,e,n)}):this._pending.push(()=>this.setAttribute(e,n))}getAttribute(e){return Di(this,e)}getAttributes(){return Ka(this)}_write(e){e.writeTypeRef(nf)}}const Nh=t=>new gn;class Ns{constructor(e,n=()=>!0){this._filter=n,this._root=e,this._currentNode=e._start,this._firstCall=!0,e.doc??xe()}[Symbol.iterator](){return this}next(){let e=this._currentNode,n=e&&e.content&&e.content.type;if(e!==null&&(!this._firstCall||e.deleted||!this._filter(n)))do if(n=e.content.type,!e.deleted&&(n.constructor===mn||n.constructor===Lt)&&n._start!==null)e=n._start;else for(;e!==null;){const r=e.next;if(r!==null){e=r;break}else e.parent===this._root?e=null:e=e.parent._item}while(e!==null&&(e.deleted||!this._filter(e.content.type)));return this._firstCall=!1,e===null?{value:void 0,done:!0}:(this._currentNode=e,{value:e.content.type,done:!1})}}class Lt extends ke{constructor(){super(),this._prelimContent=[]}get firstChild(){const e=this._first;return e?e.content.getContent()[0]:null}_integrate(e,n){super._integrate(e,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Lt}clone(){const e=new Lt;return e.insert(0,this.toArray().map(n=>n instanceof ke?n.clone():n)),e}get length(){return this.doc??xe(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(e){return new Ns(this,e)}querySelector(e){e=e.toUpperCase();const r=new Ns(this,s=>s.nodeName&&s.nodeName.toUpperCase()===e).next();return r.done?null:r.value}querySelectorAll(e){return e=e.toUpperCase(),kt(new Ns(this,n=>n.nodeName&&n.nodeName.toUpperCase()===e))}_callObserver(e,n){ds(this,e,new Ph(this,n,e))}toString(){return Ga(this,e=>e.toString()).join("")}toJSON(){return this.toString()}toDOM(e=document,n={},r){const s=e.createDocumentFragment();return r!==void 0&&r._createAssociation(s,this),Qn(this,i=>{s.insertBefore(i.toDOM(e,n,r),null)}),s}insert(e,n){this.doc!==null?Y(this.doc,r=>{Ya(r,this,e,n)}):this._prelimContent.splice(e,0,...n)}insertAfter(e,n){if(this.doc!==null)Y(this.doc,r=>{const s=e&&e instanceof ke?e._item:e;Jr(r,this,s,n)});else{const r=this._prelimContent,s=e===null?0:r.findIndex(i=>i===e)+1;if(s===0&&e!==null)throw qe("Reference item not found");r.splice(s,0,...n)}}delete(e,n=1){this.doc!==null?Y(this.doc,r=>{Wa(r,this,e,n)}):this._prelimContent.splice(e,n)}toArray(){return qa(this)}push(e){this.insert(this.length,e)}unshift(e){this.insert(0,e)}get(e){return Ja(this,e)}slice(e=0,n=this.length){return Ha(this,e,n)}forEach(e){Qn(this,e)}_write(e){e.writeTypeRef(sf)}}const Fh=t=>new Lt;class mn extends Lt{constructor(e="UNDEFINED"){super(),this.nodeName=e,this._prelimAttrs=new Map}get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_integrate(e,n){super._integrate(e,n),this._prelimAttrs.forEach((r,s)=>{this.setAttribute(s,r)}),this._prelimAttrs=null}_copy(){return new mn(this.nodeName)}clone(){const e=new mn(this.nodeName),n=this.getAttributes();return Hc(n,(r,s)=>{e.setAttribute(s,r)}),e.insert(0,this.toArray().map(r=>r instanceof ke?r.clone():r)),e}toString(){const e=this.getAttributes(),n=[],r=[];for(const h in e)r.push(h);r.sort();const s=r.length;for(let h=0;h<s;h++){const f=r[h];n.push(f+'="'+e[f]+'"')}const i=this.nodeName.toLocaleLowerCase(),l=n.length>0?" "+n.join(" "):"";return`<${i}${l}>${super.toString()}</${i}>`}removeAttribute(e){this.doc!==null?Y(this.doc,n=>{zr(n,this,e)}):this._prelimAttrs.delete(e)}setAttribute(e,n){this.doc!==null?Y(this.doc,r=>{Mi(r,this,e,n)}):this._prelimAttrs.set(e,n)}getAttribute(e){return Di(this,e)}hasAttribute(e){return Xa(this,e)}getAttributes(e){return e?Ch(this,e):Ka(this)}toDOM(e=document,n={},r){const s=e.createElement(this.nodeName),i=this.getAttributes();for(const l in i){const h=i[l];typeof h=="string"&&s.setAttribute(l,h)}return Qn(this,l=>{s.appendChild(l.toDOM(e,n,r))}),r!==void 0&&r._createAssociation(s,this),s}_write(e){e.writeTypeRef(rf),e.writeKey(this.nodeName)}}const $h=t=>new mn(t.readKey());class Ph extends hs{constructor(e,n,r){super(e,r),this.childListChanged=!1,this.attributesChanged=new Set,n.forEach(s=>{s===null?this.childListChanged=!0:this.attributesChanged.add(s)})}}class Yr extends pn{constructor(e){super(),this.hookName=e}_copy(){return new Yr(this.hookName)}clone(){const e=new Yr(this.hookName);return this.forEach((n,r)=>{e.set(r,n)}),e}toDOM(e=document,n={},r){const s=n[this.hookName];let i;return s!==void 0?i=s.createDom(this):i=document.createElement(this.hookName),i.setAttribute("data-yjs-hook",this.hookName),r!==void 0&&r._createAssociation(i,this),i}_write(e){e.writeTypeRef(of),e.writeKey(this.hookName)}}const Vh=t=>new Yr(t.readKey());class Wr extends gn{get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_copy(){return new Wr}clone(){const e=new Wr;return e.applyDelta(this.toDelta()),e}toDOM(e=document,n,r){const s=e.createTextNode(this.toString());return r!==void 0&&r._createAssociation(s,this),s}toString(){return this.toDelta().map(e=>{const n=[];for(const s in e.attributes){const i=[];for(const l in e.attributes[s])i.push({key:l,value:e.attributes[s][l]});i.sort((l,h)=>l.key<h.key?-1:1),n.push({nodeName:s,attrs:i})}n.sort((s,i)=>s.nodeName<i.nodeName?-1:1);let r="";for(let s=0;s<n.length;s++){const i=n[s];r+=`<${i.nodeName}`;for(let l=0;l<i.attrs.length;l++){const h=i.attrs[l];r+=` ${h.key}="${h.value}"`}r+=">"}r+=e.insert;for(let s=n.length-1;s>=0;s--)r+=`</${n[s].nodeName}>`;return r}).join("")}toJSON(){return this.toString()}_write(e){e.writeTypeRef(af)}}const jh=t=>new Wr;class Ri{constructor(e,n){this.id=e,this.length=n}get deleted(){throw je()}mergeWith(e){return!1}write(e,n,r){throw je()}integrate(e,n){throw je()}}const Hh=0;class Fe extends Ri{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,n){n>0&&(this.id.clock+=n,this.length-=n),Na(e.doc.store,this)}write(e,n){e.writeInfo(Hh),e.writeLen(this.length-n)}getMissing(e,n){return null}}class gr{constructor(e){this.content=e}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new gr(this.content)}splice(e){throw je()}mergeWith(e){return!1}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeBuf(this.content)}getRef(){return 3}}const qh=t=>new gr(t.readBuf());class er{constructor(e){this.len=e}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new er(this.len)}splice(e){const n=new er(this.len-e);return this.len=e,n}mergeWith(e){return this.len+=e.len,!0}integrate(e,n){qr(e.deleteSet,n.id.client,n.id.clock,this.len),n.markDeleted()}delete(e){}gc(e){}write(e,n){e.writeLen(this.len-n)}getRef(){return 1}}const Gh=t=>new er(t.readLen()),nl=(t,e)=>new xn({guid:t,...e,shouldLoad:e.shouldLoad||e.autoLoad||!1});class mr{constructor(e){e._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=e;const n={};this.opts=n,e.gc||(n.gc=!1),e.autoLoad&&(n.autoLoad=!0),e.meta!==null&&(n.meta=e.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new mr(nl(this.doc.guid,this.opts))}splice(e){throw je()}mergeWith(e){return!1}integrate(e,n){this.doc._item=n,e.subdocsAdded.add(this.doc),this.doc.shouldLoad&&e.subdocsLoaded.add(this.doc)}delete(e){e.subdocsAdded.has(this.doc)?e.subdocsAdded.delete(this.doc):e.subdocsRemoved.add(this.doc)}gc(e){}write(e,n){e.writeString(this.doc.guid),e.writeAny(this.opts)}getRef(){return 9}}const Jh=t=>new mr(nl(t.readString(),t.readAny()));class Pt{constructor(e){this.embed=e}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new Pt(this.embed)}splice(e){throw je()}mergeWith(e){return!1}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeJSON(this.embed)}getRef(){return 5}}const zh=t=>new Pt(t.readJSON());class de{constructor(e,n){this.key=e,this.value=n}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new de(this.key,this.value)}splice(e){throw je()}mergeWith(e){return!1}integrate(e,n){const r=n.parent;r._searchMarker=null,r._hasFormatting=!0}delete(e){}gc(e){}write(e,n){e.writeKey(this.key),e.writeJSON(this.value)}getRef(){return 6}}const Yh=t=>new de(t.readKey(),t.readJSON());class Kr{constructor(e){this.arr=e}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Kr(this.arr)}splice(e){const n=new Kr(this.arr.slice(e));return this.arr=this.arr.slice(0,e),n}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){const r=this.arr.length;e.writeLen(r-n);for(let s=n;s<r;s++){const i=this.arr[s];e.writeString(i===void 0?"undefined":JSON.stringify(i))}}getRef(){return 2}}const Wh=t=>{const e=t.readLen(),n=[];for(let r=0;r<e;r++){const s=t.readString();s==="undefined"?n.push(void 0):n.push(JSON.parse(s))}return new Kr(n)},Kh=Vr("node_env")==="development";class Nt{constructor(e){this.arr=e,Kh&&na(e)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Nt(this.arr)}splice(e){const n=new Nt(this.arr.slice(e));return this.arr=this.arr.slice(0,e),n}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){const r=this.arr.length;e.writeLen(r-n);for(let s=n;s<r;s++){const i=this.arr[s];e.writeAny(i)}}getRef(){return 8}}const Xh=t=>{const e=t.readLen(),n=[];for(let r=0;r<e;r++)n.push(t.readAny());return new Nt(n)};class tt{constructor(e){this.str=e}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new tt(this.str)}splice(e){const n=new tt(this.str.slice(e));this.str=this.str.slice(0,e);const r=this.str.charCodeAt(e-1);return r>=55296&&r<=56319&&(this.str=this.str.slice(0,e-1)+"",n.str=""+n.str.slice(1)),n}mergeWith(e){return this.str+=e.str,!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeString(n===0?this.str:this.str.slice(n))}getRef(){return 4}}const Zh=t=>new tt(t.readString()),Qh=[Mh,Rh,Nh,$h,Fh,Vh,jh],ef=0,tf=1,nf=2,rf=3,sf=4,of=5,af=6;class pt{constructor(e){this.type=e}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new pt(this.type._copy())}splice(e){throw je()}mergeWith(e){return!1}integrate(e,n){this.type._integrate(e.doc,n)}delete(e){let n=this.type._start;for(;n!==null;)n.deleted?n.id.clock<(e.beforeState.get(n.id.client)||0)&&e._mergeStructs.push(n):n.delete(e),n=n.right;this.type._map.forEach(r=>{r.deleted?r.id.clock<(e.beforeState.get(r.id.client)||0)&&e._mergeStructs.push(r):r.delete(e)}),e.changed.delete(this.type)}gc(e){let n=this.type._start;for(;n!==null;)n.gc(e,!0),n=n.right;this.type._start=null,this.type._map.forEach(r=>{for(;r!==null;)r.gc(e,!0),r=r.left}),this.type._map=new Map}write(e,n){this.type._write(e)}getRef(){return 7}}const lf=t=>new pt(Qh[t.readTypeRef()](t)),Xr=(t,e,n)=>{const{client:r,clock:s}=e.id,i=new fe(N(r,s+n),e,N(r,s+n-1),e.right,e.rightOrigin,e.parent,e.parentSub,e.content.splice(n));return e.deleted&&i.markDeleted(),e.keep&&(i.keep=!0),e.redone!==null&&(i.redone=N(e.redone.client,e.redone.clock+n)),e.right=i,i.right!==null&&(i.right.left=i),t._mergeStructs.push(i),i.parentSub!==null&&i.right===null&&i.parent._map.set(i.parentSub,i),e.length=n,i};class fe extends Ri{constructor(e,n,r,s,i,l,h,f){super(e,f.getLength()),this.origin=r,this.left=n,this.right=s,this.rightOrigin=i,this.parent=l,this.parentSub=h,this.redone=null,this.content=f,this.info=this.content.isCountable()?zi:0}set marker(e){(this.info&Ts)>0!==e&&(this.info^=Ts)}get marker(){return(this.info&Ts)>0}get keep(){return(this.info&Ji)>0}set keep(e){this.keep!==e&&(this.info^=Ji)}get countable(){return(this.info&zi)>0}get deleted(){return(this.info&Cs)>0}set deleted(e){this.deleted!==e&&(this.info^=Cs)}markDeleted(){this.info|=Cs}getMissing(e,n){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=be(n,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=be(n,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===sn&&this.id.client!==this.parent.client&&this.parent.clock>=be(n,this.parent.client))return this.parent.client;if(this.origin&&(this.left=lo(e,n,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=_t(e,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===Fe||this.right&&this.right.constructor===Fe)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===fe?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===fe&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===sn){const r=Bs(n,this.parent);r.constructor===Fe?this.parent=null:this.parent=r.content.type}return null}integrate(e,n){if(n>0&&(this.id.clock+=n,this.left=lo(e,e.doc.store,N(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(n),this.length-=n),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let r=this.left,s;if(r!==null)s=r.right;else if(this.parentSub!==null)for(s=this.parent._map.get(this.parentSub)||null;s!==null&&s.left!==null;)s=s.left;else s=this.parent._start;const i=new Set,l=new Set;for(;s!==null&&s!==this.right;){if(l.add(s),i.add(s),Er(this.origin,s.origin)){if(s.id.client<this.id.client)r=s,i.clear();else if(Er(this.rightOrigin,s.rightOrigin))break}else if(s.origin!==null&&l.has(Bs(e.doc.store,s.origin)))i.has(Bs(e.doc.store,s.origin))||(r=s,i.clear());else break;s=s.right}this.left=r}if(this.left!==null){const r=this.left.right;this.right=r,this.left.right=this}else{let r;if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start,this.parent._start=this;this.right=r}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(e)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),Na(e.doc.store,this),this.content.integrate(e,this),uo(e,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(e)}else new Fe(this.id,this.length).integrate(e,0)}get next(){let e=this.right;for(;e!==null&&e.deleted;)e=e.right;return e}get prev(){let e=this.left;for(;e!==null&&e.deleted;)e=e.left;return e}get lastId(){return this.length===1?this.id:N(this.id.client,this.id.clock+this.length-1)}mergeWith(e){if(this.constructor===e.constructor&&Er(e.origin,this.lastId)&&this.right===e&&Er(this.rightOrigin,e.rightOrigin)&&this.id.client===e.id.client&&this.id.clock+this.length===e.id.clock&&this.deleted===e.deleted&&this.redone===null&&e.redone===null&&this.content.constructor===e.content.constructor&&this.content.mergeWith(e.content)){const n=this.parent._searchMarker;return n&&n.forEach(r=>{r.p===e&&(r.p=this,!this.deleted&&this.countable&&(r.index-=this.length))}),e.keep&&(this.keep=!0),this.right=e.right,this.right!==null&&(this.right.left=this),this.length+=e.length,!0}return!1}delete(e){if(!this.deleted){const n=this.parent;this.countable&&this.parentSub===null&&(n._length-=this.length),this.markDeleted(),qr(e.deleteSet,this.id.client,this.id.clock,this.length),uo(e,n,this.parentSub),this.content.delete(e)}}gc(e,n){if(!this.deleted)throw Pe();this.content.gc(e),n?fh(e,this,new Fe(this.id,this.length)):this.content=new er(this.length)}write(e,n){const r=n>0?N(this.id.client,this.id.clock+n-1):this.origin,s=this.rightOrigin,i=this.parentSub,l=this.content.getRef()&ts|(r===null?0:Re)|(s===null?0:lt)|(i===null?0:Gn);if(e.writeInfo(l),r!==null&&e.writeLeftID(r),s!==null&&e.writeRightID(s),r===null&&s===null){const h=this.parent;if(h._item!==void 0){const f=h._item;if(f===null){const g=uh(h);e.writeParentInfo(!0),e.writeString(g)}else e.writeParentInfo(!1),e.writeLeftID(f.id)}else h.constructor===String?(e.writeParentInfo(!0),e.writeString(h)):h.constructor===sn?(e.writeParentInfo(!1),e.writeLeftID(h)):Pe();i!==null&&e.writeString(i)}this.content.write(e,n)}}const rl=(t,e)=>cf[e&ts](t),cf=[()=>{Pe()},Gh,Wh,qh,Zh,zh,Yh,lf,Xh,Jh,()=>{Pe()}],uf=10;class $e extends Ri{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,n){Pe()}write(e,n){e.writeInfo(uf),P(e.restEncoder,this.length-n)}getMissing(e,n){return null}}const sl=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof Gi<"u"?Gi:{},il="__ $YJS$ __";sl[il]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");sl[il]=!0;const Vt=t=>hn((e,n)=>{t.onerror=r=>n(new Error(r.target.error)),t.onsuccess=r=>e(r.target.result)}),hf=(t,e)=>hn((n,r)=>{const s=indexedDB.open(t);s.onupgradeneeded=i=>e(i.target.result),s.onerror=i=>r(qe(i.target.error)),s.onsuccess=i=>{const l=i.target.result;l.onversionchange=()=>{l.close()},n(l)}}),ff=t=>Vt(indexedDB.deleteDatabase(t)),df=(t,e)=>e.forEach(n=>t.createObjectStore.apply(t,n)),Ln=(t,e,n="readwrite")=>{const r=t.transaction(e,n);return e.map(s=>kf(r,s))},ol=(t,e)=>Vt(t.count(e)),pf=(t,e)=>Vt(t.get(e)),al=(t,e)=>Vt(t.delete(e)),gf=(t,e,n)=>Vt(t.put(e,n)),ei=(t,e)=>Vt(t.add(e)),mf=(t,e,n)=>Vt(t.getAll(e,n)),wf=(t,e,n)=>{let r=null;return Ef(t,e,s=>(r=s,!1),n).then(()=>r)},yf=(t,e=null)=>wf(t,e,"prev"),bf=(t,e)=>hn((n,r)=>{t.onerror=r,t.onsuccess=async s=>{const i=s.target.result;if(i===null||await e(i)===!1)return n();i.continue()}}),Ef=(t,e,n,r="next")=>bf(t.openKeyCursor(e,r),s=>n(s.key)),kf=(t,e)=>t.objectStore(e),_f=(t,e)=>IDBKeyRange.upperBound(t,e),Sf=(t,e)=>IDBKeyRange.lowerBound(t,e),Fs="custom",ll="updates",cl=500,ul=(t,e=()=>{},n=()=>{})=>{const[r]=Ln(t.db,[ll]);return mf(r,Sf(t._dbref,!1)).then(s=>{t._destroyed||(e(r),Y(t.doc,()=>{s.forEach(i=>ih(t.doc,i))},t,!1),n(r))}).then(()=>yf(r).then(s=>{t._dbref=s+1})).then(()=>ol(r).then(s=>{t._dbsize=s})).then(()=>r)},xf=(t,e=!0)=>ul(t).then(n=>{(e||t._dbsize>=cl)&&ei(n,Oa(t.doc)).then(()=>al(n,_f(t._dbref,!0))).then(()=>ol(n).then(r=>{t._dbsize=r}))});class Af extends rc{constructor(e,n){super(),this.doc=n,this.name=e,this._dbref=0,this._dbsize=0,this._destroyed=!1,this.db=null,this.synced=!1,this._db=hf(e,r=>df(r,[["updates",{autoIncrement:!0}],["custom"]])),this.whenSynced=hn(r=>this.on("synced",()=>r(this))),this._db.then(r=>{this.db=r,ul(this,l=>ei(l,Oa(n)),()=>{if(this._destroyed)return this;this.synced=!0,this.emit("synced",[this])})}),this._storeTimeout=1e3,this._storeTimeoutId=null,this._storeUpdate=(r,s)=>{if(this.db&&s!==this){const[i]=Ln(this.db,[ll]);ei(i,r),++this._dbsize>=cl&&(this._storeTimeoutId!==null&&clearTimeout(this._storeTimeoutId),this._storeTimeoutId=setTimeout(()=>{xf(this,!1),this._storeTimeoutId=null},this._storeTimeout))}},n.on("update",this._storeUpdate),this.destroy=this.destroy.bind(this),n.on("destroy",this.destroy)}destroy(){return this._storeTimeoutId&&clearTimeout(this._storeTimeoutId),this.doc.off("update",this._storeUpdate),this.doc.off("destroy",this.destroy),this._destroyed=!0,this._db.then(e=>{e.close()})}clearData(){return this.destroy().then(()=>{ff(this.name)})}get(e){return this._db.then(n=>{const[r]=Ln(n,[Fs],"readonly");return pf(r,e)})}set(e,n){return this._db.then(r=>{const[s]=Ln(r,[Fs]);return gf(s,n,e)})}del(e){return this._db.then(n=>{const[r]=Ln(n,[Fs]);return al(r,e)})}}const hl="schwalbvault",St=new xn,vf=typeof window<"u",Ur=vf?new Af(hl,St):null,If=St.getMap("characters"),Nn=St.getMap("campaigns"),Cf=St.getMap("enemies"),Tf=St.getMap("encounters"),Mf=St.getMap("images"),Df=St.getMap("deletedIds"),Rf=()=>new Promise(t=>{if(!Ur){t();return}Ur.synced?t():Ur.on("synced",()=>{t()})}),$p=Object.freeze(Object.defineProperty({__proto__:null,campaignsMap:Nn,charactersMap:If,deletedIdsMap:Df,doc:St,encountersMap:Tf,enemiesMap:Cf,imagesMap:Mf,provider:Ur,waitForSync:Rf},Symbol.toStringTag,{value:"Module"}));const Sr="0123456789abcdef";class Mt{constructor(e){this.bytes=e}static ofInner(e){if(e.length!==16)throw new TypeError("not 128-bit length");return new Mt(e)}static fromFieldsV7(e,n,r,s){if(!Number.isInteger(e)||!Number.isInteger(n)||!Number.isInteger(r)||!Number.isInteger(s)||e<0||n<0||r<0||s<0||e>0xffffffffffff||n>4095||r>1073741823||s>4294967295)throw new RangeError("invalid field value");const i=new Uint8Array(16);return i[0]=e/2**40,i[1]=e/2**32,i[2]=e/2**24,i[3]=e/2**16,i[4]=e/2**8,i[5]=e,i[6]=112|n>>>8,i[7]=n,i[8]=128|r>>>24,i[9]=r>>>16,i[10]=r>>>8,i[11]=r,i[12]=s>>>24,i[13]=s>>>16,i[14]=s>>>8,i[15]=s,new Mt(i)}static parse(e){var n,r,s,i;let l;switch(e.length){case 32:l=(n=/^[0-9a-f]{32}$/i.exec(e))===null||n===void 0?void 0:n[0];break;case 36:l=(r=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||r===void 0?void 0:r.slice(1,6).join("");break;case 38:l=(s=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(e))===null||s===void 0?void 0:s.slice(1,6).join("");break;case 45:l=(i=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||i===void 0?void 0:i.slice(1,6).join("");break}if(l){const h=new Uint8Array(16);for(let f=0;f<16;f+=4){const g=parseInt(l.substring(2*f,2*f+8),16);h[f+0]=g>>>24,h[f+1]=g>>>16,h[f+2]=g>>>8,h[f+3]=g}return new Mt(h)}else throw new SyntaxError("could not parse UUID string")}toString(){let e="";for(let n=0;n<this.bytes.length;n++)e+=Sr.charAt(this.bytes[n]>>>4),e+=Sr.charAt(this.bytes[n]&15),(n===3||n===5||n===7||n===9)&&(e+="-");return e}toHex(){let e="";for(let n=0;n<this.bytes.length;n++)e+=Sr.charAt(this.bytes[n]>>>4),e+=Sr.charAt(this.bytes[n]&15);return e}toJSON(){return this.toString()}getVariant(){const e=this.bytes[8]>>>4;if(e<0)throw new Error("unreachable");if(e<=7)return this.bytes.every(n=>n===0)?"NIL":"VAR_0";if(e<=11)return"VAR_10";if(e<=13)return"VAR_110";if(e<=15)return this.bytes.every(n=>n===255)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return this.getVariant()==="VAR_10"?this.bytes[6]>>>4:void 0}clone(){return new Mt(this.bytes.slice(0))}equals(e){return this.compareTo(e)===0}compareTo(e){for(let n=0;n<16;n++){const r=this.bytes[n]-e.bytes[n];if(r!==0)return Math.sign(r)}return 0}}class Of{constructor(e){this.timestamp_biased=0,this.counter=0,this.random=e??Uf()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(e,n){let r=this.generateOrAbortCore(e,n);return r===void 0&&(this.timestamp_biased=0,r=this.generateOrAbortCore(e,n)),r}generateOrAbortCore(e,n){if(!Number.isInteger(e)||e<0||e>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit unsigned integer");if(n<0||n>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(e++,e>this.timestamp_biased)this.timestamp_biased=e,this.resetCounter();else if(e+n>=this.timestamp_biased)this.counter++,this.counter>4398046511103&&(this.timestamp_biased++,this.resetCounter());else return;return Mt.fromFieldsV7(this.timestamp_biased-1,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=this.random.nextUint32()*1024+(this.random.nextUint32()&1023)}generateV4(){const e=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return e[6]=64|e[6]>>>4,e[8]=128|e[8]>>>2,Mt.ofInner(e)}}const Uf=()=>{if(typeof crypto<"u"&&typeof crypto.getRandomValues<"u")return new Bf;if(typeof UUIDV7_DENY_WEAK_RNG<"u"&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>Math.trunc(Math.random()*65536)*65536+Math.trunc(Math.random()*65536)}};class Bf{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}let mo;const jn=()=>Lf().toString(),Lf=()=>(mo||(mo=new Of)).generate(),{floor:Nf,random:Ff}=Math,tr="Trystero",nr=(t,e)=>Array(t).fill().map(e),wo="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",fl=t=>nr(t,()=>wo[Nf(Ff()*wo.length)]).join(""),Kt=fl(20),It=Promise.all.bind(Promise),dl=typeof window<"u",{entries:ti,fromEntries:pl,keys:$f}=Object,st=()=>{},it=t=>new Error(`${tr}: ${t}`),Pf=new TextEncoder,Vf=new TextDecoder,an=t=>Pf.encode(t),Br=t=>Vf.decode(t),xr=(...t)=>t.join("@"),jf=(t,e,n,r)=>(t.relayUrls||e).slice(0,t.relayUrls?t.relayUrls.length:t.relayRedundancy||n),rr=JSON.stringify,sr=JSON.parse,yo=3333,Ar={};let Hn=null,ni=null;const Hf=()=>{Hn||(Hn=new Promise(t=>{ni=t}).finally(()=>{ni=null,Hn=null}))},qf=()=>ni?.(),Gf=(t,e)=>{const n={},r=()=>{const s=new WebSocket(t);s.onclose=()=>{if(Hn){Hn.then(r);return}Ar[t]??=yo,setTimeout(r,Ar[t]),Ar[t]*=2},s.onmessage=i=>e(i.data),n.socket=s,n.url=s.url,n.ready=new Promise(i=>s.onopen=()=>{i(n),Ar[t]=yo}),n.send=i=>{s.readyState===1&&s.send(i)}};return r(),n},Jf=()=>{if(dl){const t=new AbortController;return addEventListener("online",qf,{signal:t.signal}),addEventListener("offline",Hf,{signal:t.signal}),()=>t.abort()}return st},Oi="AES-GCM",zf={},Yf=t=>btoa(String.fromCharCode.apply(null,new Uint8Array(t))),Wf=t=>{const e=atob(t);return new Uint8Array(e.length).map((n,r)=>e.charCodeAt(r)).buffer},Kf=async(t,e)=>new Uint8Array(await crypto.subtle.digest(t,an(e))),Fn=async t=>zf[t]||=Array.from(await Kf("SHA-1",t)).map(e=>e.toString(36)).join(""),Xf=async(t,e,n)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},an(`${t}:${e}:${n}`)),{name:Oi},!1,["encrypt","decrypt"]),gl="$",ml=",",Zf=async(t,e)=>{const n=crypto.getRandomValues(new Uint8Array(16));return n.join(ml)+gl+Yf(await crypto.subtle.encrypt({name:Oi,iv:n},await t,an(e)))},Qf=async(t,e)=>{const[n,r]=e.split(gl);return Br(await crypto.subtle.decrypt({name:Oi,iv:new Uint8Array(n.split(ml))},await t,Wf(r)))},ed=5e3,bo="icegatheringstatechange",Eo="offer",td="answer",ko=(t,{rtcConfig:e,rtcPolyfill:n,turnConfig:r})=>{const s=new(n||RTCPeerConnection)({iceServers:nd.concat(r||[]),...e}),i={};let l=!1,h=!1,f=null;const g=m=>{m.binaryType="arraybuffer",m.bufferedAmountLowThreshold=65535,m.onmessage=d=>i.data?.(d.data),m.onopen=()=>i.connect?.(),m.onclose=()=>i.close?.(),m.onerror=d=>i.error?.(d)},c=m=>Promise.race([new Promise(d=>{const w=()=>{m.iceGatheringState==="complete"&&(m.removeEventListener(bo,w),d())};m.addEventListener(bo,w),w()}),new Promise(d=>setTimeout(d,ed))]).then(()=>({type:m.localDescription.type,sdp:m.localDescription.sdp.replace(/a=ice-options:trickle\s\n/g,"")}));return t?(f=s.createDataChannel("data"),g(f)):s.ondatachannel=({channel:m})=>{f=m,g(m)},s.onnegotiationneeded=async()=>{try{l=!0,await s.setLocalDescription();const m=await c(s);i.signal?.(m)}catch(m){i.error?.(m)}finally{l=!1}},s.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(s.connectionState)&&i.close?.()},s.ontrack=m=>{i.track?.(m.track,m.streams[0]),i.stream?.(m.streams[0])},s.onremovestream=m=>i.stream?.(m.stream),t&&(s.canTrickleIceCandidates||s.onnegotiationneeded()),{created:Date.now(),connection:s,get channel(){return f},get isDead(){return s.connectionState==="closed"},async signal(m){if(!(f?.readyState==="open"&&!m.sdp?.includes("a=rtpmap")))try{if(m.type===Eo){if(l||s.signalingState!=="stable"&&!h){if(t)return;await It([s.setLocalDescription({type:"rollback"}),s.setRemoteDescription(m)])}else await s.setRemoteDescription(m);await s.setLocalDescription();const d=await c(s);return i.signal?.(d),d}else if(m.type===td){h=!0;try{await s.setRemoteDescription(m)}finally{h=!1}}}catch(d){i.error?.(d)}},sendData:m=>f.send(m),destroy:()=>{f?.close(),s.close(),l=!1,h=!1},setHandlers:m=>Object.assign(i,m),offerPromise:t?new Promise(m=>i.signal=d=>{d.type===Eo&&m(d)}):Promise.resolve(),addStream:m=>m.getTracks().forEach(d=>s.addTrack(d,m)),removeStream:m=>s.getSenders().filter(d=>m.getTracks().includes(d.track)).forEach(d=>s.removeTrack(d)),addTrack:(m,d)=>s.addTrack(m,d),removeTrack:m=>{const d=s.getSenders().find(w=>w.track===m);d&&s.removeTrack(d)},replaceTrack:(m,d)=>{const w=s.getSenders().find(E=>E.track===m);if(w)return w.replaceTrack(d)}}},nd=[...nr(3,(t,e)=>`stun:stun${e||""}.l.google.com:19302`),"stun:stun.cloudflare.com:3478"].map(t=>({urls:t})),rd=Object.getPrototypeOf(Uint8Array),Lr=12,wl=0,Nr=wl+Lr,Fr=Nr+1,$n=Fr+1,Pn=$n+1,At=16*2**10-Pn,vr=255,_o="bufferedamountlow",Yt=t=>"@_"+t,sd=(t,e,n)=>{const r={},s={},i={},l={},h={},f={},g={},c={onPeerJoin:st,onPeerLeave:st,onPeerStream:st,onPeerTrack:st},m=(_,x)=>(_?Array.isArray(_)?_:[_]:$f(r)).flatMap(R=>{const F=r[R];return F?x(R,F):(console.warn(`${tr}: no peer with id ${R} found`),[])}),d=_=>{r[_]&&(r[_].destroy(),delete r[_],delete l[_],delete h[_],c.onPeerLeave(_),e(_))},w=_=>{if(s[_])return i[_];if(!_)throw it("action type argument is required");const x=an(_);if(x.byteLength>Lr)throw it(`action type string "${_}" (${x.byteLength}b) exceeds byte limit (${Lr}). Hint: choose a shorter name.`);const R=new Uint8Array(Lr);R.set(x);let F=0;return s[_]={onComplete:st,onProgress:st,setOnComplete:W=>s[_]={...s[_],onComplete:W},setOnProgress:W=>s[_]={...s[_],onProgress:W},send:async(W,A,T,re)=>{if(T&&typeof T!="object")throw it("action meta argument must be an object");const _e=typeof W;if(_e==="undefined")throw it("action data cannot be undefined");const ge=_e!=="string",Ve=W instanceof Blob,G=Ve||W instanceof ArrayBuffer||W instanceof rd;if(T&&!G)throw it("action meta argument can only be used with binary data");const $=G?new Uint8Array(Ve?await W.arrayBuffer():W):an(ge?rr(W):W),Z=T?an(rr(T)):null,se=Math.ceil($.byteLength/At)+(T?1:0)||1,ue=nr(se,(he,me)=>{const Ue=me===se-1,Se=T&&me===0,Te=new Uint8Array(Pn+(Se?Z.byteLength:Ue?$.byteLength-At*(se-(T?2:1)):At));return Te.set(R),Te.set([F],Nr),Te.set([Ue|Se<<1|G<<2|ge<<3],Fr),Te.set([Math.round((me+1)/se*vr)],$n),Te.set(T?Se?Z:$.subarray((me-1)*At,me*At):$.subarray(me*At,(me+1)*At),Pn),Te});return F=F+1&vr,It(m(A,async(he,me)=>{const{channel:Ue}=me;let Se=0;for(;Se<se;){const Te=ue[Se];if(Ue.bufferedAmount>Ue.bufferedAmountLowThreshold&&await new Promise(wr=>{const yr=()=>{Ue.removeEventListener(_o,yr),wr()};Ue.addEventListener(_o,yr)}),!r[he])break;me.sendData(Te),Se++,re?.(Te[$n]/vr,he,T)}}))}},i[_]||=[s[_].send,s[_].setOnComplete,s[_].setOnProgress]},E=(_,x)=>{const R=new Uint8Array(x),F=Br(R.subarray(wl,Nr)).replaceAll("\0",""),[W]=R.subarray(Nr,Fr),[A]=R.subarray(Fr,$n),[T]=R.subarray($n,Pn),re=R.subarray(Pn),_e=!!(A&1),ge=!!(A&2),Ve=!!(A&4),G=!!(A&8);if(!s[F]){console.warn(`${tr}: received message with unregistered type (${F})`);return}l[_]||={},l[_][F]||={};const $=l[_][F][W]||={chunks:[]};if(ge?$.meta=sr(Br(re)):$.chunks.push(re),s[F].onProgress(T/vr,_,$.meta),!_e)return;const Z=new Uint8Array($.chunks.reduce((se,ue)=>se+ue.byteLength,0));if($.chunks.reduce((se,ue)=>(Z.set(ue,se),se+ue.byteLength),0),delete l[_][F][W],Ve)s[F].onComplete(Z,_,$.meta);else{const se=Br(Z);s[F].onComplete(G?sr(se):se,_)}},S=async()=>{await L(""),await new Promise(_=>setTimeout(_,99)),ti(r).forEach(([_,x])=>{x.destroy(),delete r[_]}),n()},[I,D]=w(Yt("ping")),[ee,q]=w(Yt("pong")),[B,j]=w(Yt("signal")),[J,X]=w(Yt("stream")),[ne,v]=w(Yt("track")),[L,Ce]=w(Yt("leave"));return t((_,x)=>{r[x]||(r[x]=_,_.setHandlers({data:R=>E(x,R),stream:R=>{c.onPeerStream(R,x,f[x]),delete f[x]},track:(R,F)=>{c.onPeerTrack(R,F,x,g[x]),delete g[x]},signal:R=>B(R,x),close:()=>d(x),error:R=>{console.error(R),d(x)}}),c.onPeerJoin(x))}),D((_,x)=>ee("",x)),q((_,x)=>{h[x]?.(),delete h[x]}),j((_,x)=>r[x]?.signal(_)),X((_,x)=>f[x]=_),v((_,x)=>g[x]=_),Ce((_,x)=>d(x)),dl&&addEventListener("beforeunload",S),{makeAction:w,leave:S,ping:async _=>{if(!_)throw it("ping() must be called with target peer ID");const x=Date.now();return I("",_),await new Promise(R=>h[_]=R),Date.now()-x},getPeers:()=>pl(ti(r).map(([_,x])=>[_,x.connection])),addStream:(_,x,R)=>m(x,async(F,W)=>{R&&await J(R,F),W.addStream(_)}),removeStream:(_,x)=>m(x,(R,F)=>F.removeStream(_)),addTrack:(_,x,R,F)=>m(R,async(W,A)=>{F&&await ne(F,W),A.addTrack(_,x)}),removeTrack:(_,x)=>m(x,(R,F)=>F.removeTrack(_)),replaceTrack:(_,x,R,F)=>m(R,async(W,A)=>{F&&await ne(F,W),A.replaceTrack(_,x)}),onPeerJoin:_=>c.onPeerJoin=_,onPeerLeave:_=>c.onPeerLeave=_,onPeerStream:_=>c.onPeerStream=_,onPeerTrack:_=>c.onPeerTrack=_}},id=20,od=5333,So=57333,ad=({init:t,subscribe:e,announce:n})=>{const r={};let s=!1,i,l,h,f;return(g,c,m)=>{const{appId:d}=g;if(r[d]?.[c])return r[d][c];const w={},E={},S=xr(tr,d,c),I=Fn(S),D=Fn(xr(S,Kt)),ee=Xf(g.password||"",d,c),q=A=>async T=>({type:T.type,sdp:await A(ee,T.sdp)}),B=q(Qf),j=q(Zf),J=()=>ko(!0,g),X=(A,T,re)=>{if(E[T]){E[T]!==A&&A.destroy();return}E[T]=A,W(A,T),w[T]?.forEach((_e,ge)=>{ge!==re&&_e.destroy()}),delete w[T]},ne=(A,T)=>{E[T]===A&&delete E[T]},v=(A,T)=>{if(E[A])return;const re=w[A]?.[T];re&&(delete w[A][T],re.destroy())},L=A=>(l.push(...nr(A,J)),It(l.splice(0,A).map(T=>T.offerPromise.then(j).then(re=>({peer:T,offer:re}))))),Ce=(A,T)=>m?.({error:`incorrect password (${g.password}) when decrypting ${T}`,appId:d,peerId:A,roomId:c}),_=A=>async(T,re,_e)=>{const[ge,Ve]=await It([I,D]);if(T!==ge&&T!==Ve)return;const{peerId:G,offer:$,answer:Z,peer:se}=typeof re=="string"?sr(re):re;if(!(G===Kt||E[G])){if(G&&!$&&!Z){if(w[G]?.[A])return;const[[{peer:ue,offer:he}],me]=await It([L(1),Fn(xr(S,G))]);w[G]||=[],w[G][A]=ue,setTimeout(()=>v(G,A),x[A]*.9),ue.setHandlers({connect:()=>X(ue,G,A),close:()=>ne(ue,G)}),_e(me,rr({peerId:Kt,offer:he}))}else if($){if(w[G]?.[A]&&Kt>G)return;const he=ko(!1,g);he.setHandlers({connect:()=>X(he,G,A),close:()=>ne(he,G)});let me;try{me=await B($)}catch{Ce(G,"offer");return}if(he.isDead)return;const[Ue,Se]=await It([Fn(xr(S,G)),he.signal(me)]);_e(Ue,rr({peerId:Kt,answer:await j(Se)}))}else if(Z){let ue;try{ue=await B(Z)}catch{Ce(G,"answer");return}if(se)se.setHandlers({connect:()=>X(se,G,A),close:()=>ne(se,G)}),se.signal(ue);else{const he=w[G]?.[A];he&&!he.isDead&&he.signal(ue)}}}};if(!g)throw it("requires a config map as the first argument");if(!d&&!g.firebaseApp)throw it("config map is missing appId field");if(!c)throw it("roomId argument required");if(!s){const A=t(g);l=nr(id,J),i=Array.isArray(A)?A:[A],s=!0,h=setInterval(()=>l=l.filter(T=>{const re=Date.now()-T.created<So;return re||T.destroy(),re}),So*1.03),f=g.manualRelayReconnection?st:Jf()}const x=i.map(()=>od),R=[],F=i.map(async(A,T)=>e(await A,await I,await D,_(T),L));It([I,D]).then(([A,T])=>{const re=async(_e,ge)=>{const Ve=await n(_e,A,T);typeof Ve=="number"&&(x[ge]=Ve),R[ge]=setTimeout(()=>re(_e,ge),x[ge])};F.forEach(async(_e,ge)=>{await _e,re(await i[ge],ge)})});let W=st;return r[d]||={},r[d][c]=sd(A=>W=A,A=>delete E[A],()=>{delete r[d][c],R.forEach(clearTimeout),F.forEach(async A=>(await A)()),clearInterval(h),f(),s=!1})}},$s={},yl={},On={},Un={},Bn={},xo={},Ir={},ld="announce",bl=20,Ao=10,cd=33333,ud=120333,hd=3,fd=async t=>{if($s[t])return $s[t];const e=(await Fn(t)).slice(0,bl);return $s[t]=e,yl[e]=t,e},vo=async(t,e,n)=>t.send(rr({action:ld,info_hash:await fd(e),peer_id:Kt,...n})),Io=(t,e,n)=>console.warn(`${tr}: torrent tracker ${n?"failure":"warning"} from ${t} - ${e}`),El=ad({init:t=>jf(t,dd,hd).map(e=>{const n=Gf(e,s=>{const i=sr(s),l=i["failure reason"],h=i["warning message"],{interval:f}=i,g=yl[i.info_hash];if(l){Io(r,l,!0);return}if(h&&Io(r,h),f&&f*1e3>Bn[r]&&Un[r][g]){const c=Math.min(f*1e3,ud);clearInterval(On[r][g]),Bn[r]=c,On[r][g]=setInterval(Un[r][g],c)}xo[i.offer_id]||(i.offer||i.answer)&&(xo[i.offer_id]=!0,Ir[r][g]?.(i))}),{url:r}=n;return Ir[r]={},n.ready}),subscribe:(t,e,n,r,s)=>{const{url:i}=t,l=async()=>{const h=pl((await s(Ao)).map(f=>[fl(bl),f]));Ir[t.url][e]=f=>{if(f.offer)r(e,{offer:f.offer,peerId:f.peer_id},(g,c)=>vo(t,e,{answer:sr(c).answer,offer_id:f.offer_id,to_peer_id:f.peer_id}));else if(f.answer){const g=h[f.offer_id];g&&r(e,{answer:f.answer,peerId:f.peer_id,peer:g.peer})}},vo(t,e,{numwant:Ao,offers:ti(h).map(([f,{offer:g}])=>({offer_id:f,offer:g}))})};return Bn[i]=cd,Un[i]||={},Un[i][e]=l,On[i]||={},On[i][e]=setInterval(l,Bn[i]),l(),()=>{clearInterval(On[i][e]),delete Ir[i][e],delete Un[i][e]}},announce:t=>Bn[t.url]}),dd=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.btorrent.xyz","tracker.files.fm:7073/announce"].map(t=>"wss://"+t);var Ne="INUMBER",vn="IOP1",In="IOP2",Cn="IOP3",ct="IVAR",Ft="IVARNAME",wn="IFUNCALL",ps="IFUNDEF",Ie="IEXPR",Ui="IEXPREVAL",jt="IMEMBER",gs="IENDSTATEMENT",yn="IARRAY";function V(t,e){this.type=t,this.value=e??0}V.prototype.toString=function(){switch(this.type){case Ne:case vn:case In:case Cn:case ct:case Ft:case gs:return this.value;case wn:return"CALL "+this.value;case ps:return"DEF "+this.value;case yn:return"ARRAY "+this.value;case jt:return"."+this.value;default:return"Invalid Instruction"}};function ms(t){return new V(vn,t)}function gt(t){return new V(In,t)}function kl(t){return new V(Cn,t)}function ri(t,e,n,r,s){for(var i=[],l=[],h,f,g,c,m=0;m<t.length;m++){var d=t[m],w=d.type;if(w===Ne||w===Ft)Array.isArray(d.value)?i.push.apply(i,ri(d.value.map(function(E){return new V(Ne,E)}).concat(new V(yn,d.value.length)),e,n,r,s)):i.push(d);else if(w===ct&&s.hasOwnProperty(d.value))d=new V(Ne,s[d.value]),i.push(d);else if(w===In&&i.length>1)f=i.pop(),h=i.pop(),c=n[d.value],d=new V(Ne,c(h.value,f.value)),i.push(d);else if(w===Cn&&i.length>2)g=i.pop(),f=i.pop(),h=i.pop(),d.value==="?"?i.push(h.value?f.value:g.value):(c=r[d.value],d=new V(Ne,c(h.value,f.value,g.value)),i.push(d));else if(w===vn&&i.length>0)h=i.pop(),c=e[d.value],d=new V(Ne,c(h.value)),i.push(d);else if(w===Ie){for(;i.length>0;)l.push(i.shift());l.push(new V(Ie,ri(d.value,e,n,r,s)))}else if(w===jt&&i.length>0)h=i.pop(),i.push(new V(Ne,h.value[d.value]));else{for(;i.length>0;)l.push(i.shift());l.push(d)}}for(;i.length>0;)l.push(i.shift());return l}function _l(t,e,n){for(var r=[],s=0;s<t.length;s++){var i=t[s],l=i.type;if(l===ct&&i.value===e)for(var h=0;h<n.tokens.length;h++){var f=n.tokens[h],g;f.type===vn?g=ms(f.value):f.type===In?g=gt(f.value):f.type===Cn?g=kl(f.value):g=new V(f.type,f.value),r.push(g)}else l===Ie?r.push(new V(Ie,_l(i.value,e,n))):r.push(i)}return r}function Ct(t,e,n){var r=[],s,i,l,h,f,g;if(Bi(t))return rt(t,n);for(var c=t.length,m=0;m<c;m++){var d=t[m],w=d.type;if(w===Ne||w===Ft)r.push(d.value);else if(w===In)i=r.pop(),s=r.pop(),d.value==="and"?r.push(s?!!Ct(i,e,n):!1):d.value==="or"?r.push(s?!0:!!Ct(i,e,n)):d.value==="="?(h=e.binaryOps[d.value],r.push(h(s,Ct(i,e,n),n))):(h=e.binaryOps[d.value],r.push(h(rt(s,n),rt(i,n))));else if(w===Cn)l=r.pop(),i=r.pop(),s=r.pop(),d.value==="?"?r.push(Ct(s?i:l,e,n)):(h=e.ternaryOps[d.value],r.push(h(rt(s,n),rt(i,n),rt(l,n))));else if(w===ct)if(d.value in e.functions)r.push(e.functions[d.value]);else if(d.value in e.unaryOps&&e.parser.isOperatorEnabled(d.value))r.push(e.unaryOps[d.value]);else{var E=n[d.value];if(E!==void 0)r.push(E);else throw new Error("undefined variable: "+d.value)}else if(w===vn)s=r.pop(),h=e.unaryOps[d.value],r.push(h(rt(s,n)));else if(w===wn){for(g=d.value,f=[];g-- >0;)f.unshift(rt(r.pop(),n));if(h=r.pop(),h.apply&&h.call)r.push(h.apply(void 0,f));else throw new Error(h+" is not a function")}else if(w===ps)r.push((function(){for(var S=r.pop(),I=[],D=d.value;D-- >0;)I.unshift(r.pop());var ee=r.pop(),q=function(){for(var B=Object.assign({},n),j=0,J=I.length;j<J;j++)B[I[j]]=arguments[j];return Ct(S,e,B)};return Object.defineProperty(q,"name",{value:ee,writable:!1}),n[ee]=q,q})());else if(w===Ie)r.push(pd(d,e));else if(w===Ui)r.push(d);else if(w===jt)s=r.pop(),r.push(s[d.value]);else if(w===gs)r.pop();else if(w===yn){for(g=d.value,f=[];g-- >0;)f.unshift(r.pop());r.push(f)}else throw new Error("invalid Expression")}if(r.length>1)throw new Error("invalid Expression (parity)");return r[0]===0?0:rt(r[0],n)}function pd(t,e,n){return Bi(t)?t:{type:Ui,value:function(r){return Ct(t.value,e,r)}}}function Bi(t){return t&&t.type===Ui}function rt(t,e){return Bi(t)?t.value(e):t}function Li(t,e){for(var n=[],r,s,i,l,h,f,g=0;g<t.length;g++){var c=t[g],m=c.type;if(m===Ne)typeof c.value=="number"&&c.value<0?n.push("("+c.value+")"):Array.isArray(c.value)?n.push("["+c.value.map(Co).join(", ")+"]"):n.push(Co(c.value));else if(m===In)s=n.pop(),r=n.pop(),l=c.value,e?l==="^"?n.push("Math.pow("+r+", "+s+")"):l==="and"?n.push("(!!"+r+" && !!"+s+")"):l==="or"?n.push("(!!"+r+" || !!"+s+")"):l==="||"?n.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+r+"),("+s+")))"):l==="=="?n.push("("+r+" === "+s+")"):l==="!="?n.push("("+r+" !== "+s+")"):l==="["?n.push(r+"[("+s+") | 0]"):n.push("("+r+" "+l+" "+s+")"):l==="["?n.push(r+"["+s+"]"):n.push("("+r+" "+l+" "+s+")");else if(m===Cn)if(i=n.pop(),s=n.pop(),r=n.pop(),l=c.value,l==="?")n.push("("+r+" ? "+s+" : "+i+")");else throw new Error("invalid Expression");else if(m===ct||m===Ft)n.push(c.value);else if(m===vn)r=n.pop(),l=c.value,l==="-"||l==="+"?n.push("("+l+r+")"):e?l==="not"?n.push("(!"+r+")"):l==="!"?n.push("fac("+r+")"):n.push(l+"("+r+")"):l==="!"?n.push("("+r+"!)"):n.push("("+l+" "+r+")");else if(m===wn){for(f=c.value,h=[];f-- >0;)h.unshift(n.pop());l=n.pop(),n.push(l+"("+h.join(", ")+")")}else if(m===ps){for(s=n.pop(),f=c.value,h=[];f-- >0;)h.unshift(n.pop());r=n.pop(),e?n.push("("+r+" = function("+h.join(", ")+") { return "+s+" })"):n.push("("+r+"("+h.join(", ")+") = "+s+")")}else if(m===jt)r=n.pop(),n.push(r+"."+c.value);else if(m===yn){for(f=c.value,h=[];f-- >0;)h.unshift(n.pop());n.push("["+h.join(", ")+"]")}else if(m===Ie)n.push("("+Li(c.value,e)+")");else if(m!==gs)throw new Error("invalid Expression")}return n.length>1&&(e?n=[n.join(",")]:n=[n.join(";")]),String(n[0])}function Co(t){return typeof t=="string"?JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):t}function Zt(t,e){for(var n=0;n<t.length;n++)if(t[n]===e)return!0;return!1}function Ni(t,e,n){n=n||{};for(var r=!!n.withMembers,s=null,i=0;i<t.length;i++){var l=t[i];l.type===ct||l.type===Ft?!r&&!Zt(e,l.value)?e.push(l.value):(s!==null&&(Zt(e,s)||e.push(s)),s=l.value):l.type===jt&&r&&s!==null?s+="."+l.value:l.type===Ie?Ni(l.value,e,n):s!==null&&(Zt(e,s)||e.push(s),s=null)}s!==null&&!Zt(e,s)&&e.push(s)}function He(t,e){this.tokens=t,this.parser=e,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.functions=e.functions}He.prototype.simplify=function(t){return t=t||{},new He(ri(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,t),this.parser)};He.prototype.substitute=function(t,e){return e instanceof He||(e=this.parser.parse(String(e))),new He(_l(this.tokens,t,e),this.parser)};He.prototype.evaluate=function(t){return t=t||{},Ct(this.tokens,this,t)};He.prototype.toString=function(){return Li(this.tokens,!1)};He.prototype.symbols=function(t){t=t||{};var e=[];return Ni(this.tokens,e,t),e};He.prototype.variables=function(t){t=t||{};var e=[];Ni(this.tokens,e,t);var n=this.functions;return e.filter(function(r){return!(r in n)})};He.prototype.toJSFunction=function(t,e){var n=this,r=new Function(t,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+Li(this.simplify(e).tokens,!0)+"; }");return function(){return r.apply(n,arguments)}};var ir="TEOF",K="TOP",ws="TNUMBER",Sl="TSTRING",ut="TPAREN",bn="TBRACKET",ys="TCOMMA",Fi="TNAME",$i="TSEMICOLON";function xl(t,e,n){this.type=t,this.value=e,this.index=n}xl.prototype.toString=function(){return this.type+": "+this.value};function ae(t,e){this.pos=0,this.current=null,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.consts=t.consts,this.expression=e,this.savedPosition=0,this.savedCurrent=null,this.options=t.options,this.parser=t}ae.prototype.newToken=function(t,e,n){return new xl(t,e,n??this.pos)};ae.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};ae.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};ae.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(ir,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};ae.prototype.isString=function(){var t=!1,e=this.pos,n=this.expression.charAt(e);if(n==="'"||n==='"')for(var r=this.expression.indexOf(n,e+1);r>=0&&this.pos<this.expression.length;){if(this.pos=r+1,this.expression.charAt(r-1)!=="\\"){var s=this.expression.substring(e+1,r);this.current=this.newToken(Sl,this.unescape(s),e),t=!0;break}r=this.expression.indexOf(n,r+1)}return t};ae.prototype.isParen=function(){var t=this.expression.charAt(this.pos);return t==="("||t===")"?(this.current=this.newToken(ut,t),this.pos++,!0):!1};ae.prototype.isBracket=function(){var t=this.expression.charAt(this.pos);return(t==="["||t==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken(bn,t),this.pos++,!0):!1};ae.prototype.isComma=function(){var t=this.expression.charAt(this.pos);return t===","?(this.current=this.newToken(ys,","),this.pos++,!0):!1};ae.prototype.isSemicolon=function(){var t=this.expression.charAt(this.pos);return t===";"?(this.current=this.newToken($i,";"),this.pos++,!0):!1};ae.prototype.isConst=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var n=this.expression.charAt(e);if(n.toUpperCase()===n.toLowerCase()&&(e===this.pos||n!=="_"&&n!=="."&&(n<"0"||n>"9")))break}if(e>t){var r=this.expression.substring(t,e);if(r in this.consts)return this.current=this.newToken(ws,this.consts[r]),this.pos+=r.length,!0}return!1};ae.prototype.isNamedOp=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var n=this.expression.charAt(e);if(n.toUpperCase()===n.toLowerCase()&&(e===this.pos||n!=="_"&&(n<"0"||n>"9")))break}if(e>t){var r=this.expression.substring(t,e);if(this.isOperatorEnabled(r)&&(r in this.binaryOps||r in this.unaryOps||r in this.ternaryOps))return this.current=this.newToken(K,r),this.pos+=r.length,!0}return!1};ae.prototype.isName=function(){for(var t=this.pos,e=t,n=!1;e<this.expression.length;e++){var r=this.expression.charAt(e);if(r.toUpperCase()===r.toLowerCase()){if(e===this.pos&&(r==="$"||r==="_")){r==="_"&&(n=!0);continue}else if(e===this.pos||!n||r!=="_"&&(r<"0"||r>"9"))break}else n=!0}if(n){var s=this.expression.substring(t,e);return this.current=this.newToken(Fi,s),this.pos+=s.length,!0}return!1};ae.prototype.isWhitespace=function(){for(var t=!1,e=this.expression.charAt(this.pos);(e===" "||e==="	"||e===`
`||e==="\r")&&(t=!0,this.pos++,!(this.pos>=this.expression.length));)e=this.expression.charAt(this.pos);return t};var gd=/^[0-9a-f]{4}$/i;ae.prototype.unescape=function(t){var e=t.indexOf("\\");if(e<0)return t;for(var n=t.substring(0,e);e>=0;){var r=t.charAt(++e);switch(r){case"'":n+="'";break;case'"':n+='"';break;case"\\":n+="\\";break;case"/":n+="/";break;case"b":n+="\b";break;case"f":n+="\f";break;case"n":n+=`
`;break;case"r":n+="\r";break;case"t":n+="	";break;case"u":var s=t.substring(e+1,e+5);gd.test(s)||this.parseError("Illegal escape sequence: \\u"+s),n+=String.fromCharCode(parseInt(s,16)),e+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+r+'"')}++e;var i=t.indexOf("\\",e);n+=t.substring(e,i<0?t.length:i),e=i}return n};ae.prototype.isComment=function(){var t=this.expression.charAt(this.pos);return t==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};ae.prototype.isRadixInteger=function(){var t=this.pos;if(t>=this.expression.length-2||this.expression.charAt(t)!=="0")return!1;++t;var e,n;if(this.expression.charAt(t)==="x")e=16,n=/^[0-9a-f]$/i,++t;else if(this.expression.charAt(t)==="b")e=2,n=/^[01]$/i,++t;else return!1;for(var r=!1,s=t;t<this.expression.length;){var i=this.expression.charAt(t);if(n.test(i))t++,r=!0;else break}return r&&(this.current=this.newToken(ws,parseInt(this.expression.substring(s,t),e)),this.pos=t),r};ae.prototype.isNumber=function(){for(var t=!1,e=this.pos,n=e,r=e,s=!1,i=!1,l;e<this.expression.length&&(l=this.expression.charAt(e),l>="0"&&l<="9"||!s&&l===".");)l==="."?s=!0:i=!0,e++,t=i;if(t&&(r=e),l==="e"||l==="E"){e++;for(var h=!0,f=!1;e<this.expression.length;){if(l=this.expression.charAt(e),h&&(l==="+"||l==="-"))h=!1;else if(l>="0"&&l<="9")f=!0,h=!1;else break;e++}f||(e=r)}return t?(this.current=this.newToken(ws,parseFloat(this.expression.substring(n,e))),this.pos=e):this.pos=r,t};ae.prototype.isOperator=function(){var t=this.pos,e=this.expression.charAt(this.pos);if(e==="+"||e==="-"||e==="*"||e==="/"||e==="%"||e==="^"||e==="?"||e===":"||e===".")this.current=this.newToken(K,e);else if(e===""||e==="")this.current=this.newToken(K,"*");else if(e===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(K,">="),this.pos++):this.current=this.newToken(K,">");else if(e==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(K,"<="),this.pos++):this.current=this.newToken(K,"<");else if(e==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(K,"||"),this.pos++;else return!1;else if(e==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(K,"=="),this.pos++):this.current=this.newToken(K,e);else if(e==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(K,"!="),this.pos++):this.current=this.newToken(K,e);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=t,!1)};ae.prototype.isOperatorEnabled=function(t){return this.parser.isOperatorEnabled(t)};ae.prototype.getCoordinates=function(){var t=0,e,n=-1;do t++,e=this.pos-n,n=this.expression.indexOf(`
`,n+1);while(n>=0&&n<this.pos);return{line:t,column:e}};ae.prototype.parseError=function(t){var e=this.getCoordinates();throw new Error("parse error ["+e.line+":"+e.column+"]: "+t)};function Q(t,e,n){this.parser=t,this.tokens=e,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=n.allowMemberAccess!==!1}Q.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};Q.prototype.tokenMatches=function(t,e){return typeof e>"u"?!0:Array.isArray(e)?Zt(e,t.value):typeof e=="function"?e(t):t.value===e};Q.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};Q.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};Q.prototype.accept=function(t,e){return this.nextToken.type===t&&this.tokenMatches(this.nextToken,e)?(this.next(),!0):!1};Q.prototype.expect=function(t,e){if(!this.accept(t,e)){var n=this.tokens.getCoordinates();throw new Error("parse error ["+n.line+":"+n.column+"]: Expected "+(e||t))}};Q.prototype.parseAtom=function(t){var e=this.tokens.unaryOps;function n(s){return s.value in e}if(this.accept(Fi)||this.accept(K,n))t.push(new V(ct,this.current.value));else if(this.accept(ws))t.push(new V(Ne,this.current.value));else if(this.accept(Sl))t.push(new V(Ne,this.current.value));else if(this.accept(ut,"("))this.parseExpression(t),this.expect(ut,")");else if(this.accept(bn,"["))if(this.accept(bn,"]"))t.push(new V(yn,0));else{var r=this.parseArrayList(t);t.push(new V(yn,r))}else throw new Error("unexpected "+this.nextToken)};Q.prototype.parseExpression=function(t){var e=[];this.parseUntilEndStatement(t,e)||(this.parseVariableAssignmentExpression(e),!this.parseUntilEndStatement(t,e)&&this.pushExpression(t,e))};Q.prototype.pushExpression=function(t,e){for(var n=0,r=e.length;n<r;n++)t.push(e[n])};Q.prototype.parseUntilEndStatement=function(t,e){return this.accept($i)?(this.nextToken&&this.nextToken.type!==ir&&!(this.nextToken.type===ut&&this.nextToken.value===")")&&e.push(new V(gs)),this.nextToken.type!==ir&&this.parseExpression(e),t.push(new V(Ie,e)),!0):!1};Q.prototype.parseArrayList=function(t){for(var e=0;!this.accept(bn,"]");)for(this.parseExpression(t),++e;this.accept(ys);)this.parseExpression(t),++e;return e};Q.prototype.parseVariableAssignmentExpression=function(t){for(this.parseConditionalExpression(t);this.accept(K,"=");){var e=t.pop(),n=[],r=t.length-1;if(e.type===wn){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var s=0,i=e.value+1;s<i;s++){var l=r-s;t[l].type===ct&&(t[l]=new V(Ft,t[l].value))}this.parseVariableAssignmentExpression(n),t.push(new V(Ie,n)),t.push(new V(ps,e.value));continue}if(e.type!==ct&&e.type!==jt)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(n),t.push(new V(Ft,e.value)),t.push(new V(Ie,n)),t.push(gt("="))}};Q.prototype.parseConditionalExpression=function(t){for(this.parseOrExpression(t);this.accept(K,"?");){var e=[],n=[];this.parseConditionalExpression(e),this.expect(K,":"),this.parseConditionalExpression(n),t.push(new V(Ie,e)),t.push(new V(Ie,n)),t.push(kl("?"))}};Q.prototype.parseOrExpression=function(t){for(this.parseAndExpression(t);this.accept(K,"or");){var e=[];this.parseAndExpression(e),t.push(new V(Ie,e)),t.push(gt("or"))}};Q.prototype.parseAndExpression=function(t){for(this.parseComparison(t);this.accept(K,"and");){var e=[];this.parseComparison(e),t.push(new V(Ie,e)),t.push(gt("and"))}};var md=["==","!=","<","<=",">=",">","in"];Q.prototype.parseComparison=function(t){for(this.parseAddSub(t);this.accept(K,md);){var e=this.current;this.parseAddSub(t),t.push(gt(e.value))}};var wd=["+","-","||"];Q.prototype.parseAddSub=function(t){for(this.parseTerm(t);this.accept(K,wd);){var e=this.current;this.parseTerm(t),t.push(gt(e.value))}};var yd=["*","/","%"];Q.prototype.parseTerm=function(t){for(this.parseFactor(t);this.accept(K,yd);){var e=this.current;this.parseFactor(t),t.push(gt(e.value))}};Q.prototype.parseFactor=function(t){var e=this.tokens.unaryOps;function n(s){return s.value in e}if(this.save(),this.accept(K,n)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===ut&&this.nextToken.value==="("){this.restore(),this.parseExponential(t);return}else if(this.nextToken.type===$i||this.nextToken.type===ys||this.nextToken.type===ir||this.nextToken.type===ut&&this.nextToken.value===")"){this.restore(),this.parseAtom(t);return}}var r=this.current;this.parseFactor(t),t.push(ms(r.value))}else this.parseExponential(t)};Q.prototype.parseExponential=function(t){for(this.parsePostfixExpression(t);this.accept(K,"^");)this.parseFactor(t),t.push(gt("^"))};Q.prototype.parsePostfixExpression=function(t){for(this.parseFunctionCall(t);this.accept(K,"!");)t.push(ms("!"))};Q.prototype.parseFunctionCall=function(t){var e=this.tokens.unaryOps;function n(i){return i.value in e}if(this.accept(K,n)){var r=this.current;this.parseAtom(t),t.push(ms(r.value))}else for(this.parseMemberExpression(t);this.accept(ut,"(");)if(this.accept(ut,")"))t.push(new V(wn,0));else{var s=this.parseArgumentList(t);t.push(new V(wn,s))}};Q.prototype.parseArgumentList=function(t){for(var e=0;!this.accept(ut,")");)for(this.parseExpression(t),++e;this.accept(ys);)this.parseExpression(t),++e;return e};Q.prototype.parseMemberExpression=function(t){for(this.parseAtom(t);this.accept(K,".")||this.accept(bn,"[");){var e=this.current;if(e.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(Fi),t.push(new V(jt,this.current.value))}else if(e.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(t),this.expect(bn,"]"),t.push(gt("["))}else throw new Error("unexpected symbol: "+e.value)}};function bd(t,e){return Number(t)+Number(e)}function Ed(t,e){return t-e}function kd(t,e){return t*e}function _d(t,e){return t/e}function Sd(t,e){return t%e}function xd(t,e){return Array.isArray(t)&&Array.isArray(e)?t.concat(e):""+t+e}function Ad(t,e){return t===e}function vd(t,e){return t!==e}function Id(t,e){return t>e}function Cd(t,e){return t<e}function Td(t,e){return t>=e}function Md(t,e){return t<=e}function Dd(t,e){return!!(t&&e)}function Rd(t,e){return!!(t||e)}function Od(t,e){return Zt(e,t)}function Ud(t){return(Math.exp(t)-Math.exp(-t))/2}function Bd(t){return(Math.exp(t)+Math.exp(-t))/2}function Ld(t){return t===1/0?1:t===-1/0?-1:(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t))}function Nd(t){return t===-1/0?t:Math.log(t+Math.sqrt(t*t+1))}function Fd(t){return Math.log(t+Math.sqrt(t*t-1))}function $d(t){return Math.log((1+t)/(1-t))/2}function To(t){return Math.log(t)*Math.LOG10E}function Pd(t){return-t}function Vd(t){return!t}function jd(t){return t<0?Math.ceil(t):Math.floor(t)}function Hd(t){return Math.random()*(t||1)}function Mo(t){return Pi(t+1)}function qd(t){return isFinite(t)&&t===Math.round(t)}var Gd=4.7421875,Ps=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function Pi(t){var e,n;if(qd(t)){if(t<=0)return isFinite(t)?1/0:NaN;if(t>171)return 1/0;for(var r=t-2,s=t-1;r>1;)s*=r,r--;return s===0&&(s=1),s}if(t<.5)return Math.PI/(Math.sin(Math.PI*t)*Pi(1-t));if(t>=171.35)return 1/0;if(t>85){var i=t*t,l=i*t,h=l*t,f=h*t;return Math.sqrt(2*Math.PI/t)*Math.pow(t/Math.E,t)*(1+1/(12*t)+1/(288*i)-139/(51840*l)-571/(2488320*h)+163879/(209018880*f)+5246819/(75246796800*f*t))}--t,n=Ps[0];for(var g=1;g<Ps.length;++g)n+=Ps[g]/(t+g);return e=t+Gd+.5,Math.sqrt(2*Math.PI)*Math.pow(e,t+.5)*Math.exp(-e)*n}function Jd(t){return Array.isArray(t)?t.length:String(t).length}function Do(){for(var t=0,e=0,n=0;n<arguments.length;n++){var r=Math.abs(arguments[n]),s;e<r?(s=e/r,t=t*s*s+1,e=r):r>0?(s=r/e,t+=s*s):t+=r}return e===1/0?1/0:e*Math.sqrt(t)}function Ro(t,e,n){return t?e:n}function zd(t,e){return typeof e>"u"||+e==0?Math.round(t):(t=+t,e=-+e,isNaN(t)||!(typeof e=="number"&&e%1===0)?NaN:(t=t.toString().split("e"),t=Math.round(+(t[0]+"e"+(t[1]?+t[1]-e:-e))),t=t.toString().split("e"),+(t[0]+"e"+(t[1]?+t[1]+e:e))))}function Yd(t,e,n){return n&&(n[t]=e),e}function Wd(t,e){return t[e|0]}function Kd(t){return arguments.length===1&&Array.isArray(t)?Math.max.apply(Math,t):Math.max.apply(Math,arguments)}function Xd(t){return arguments.length===1&&Array.isArray(t)?Math.min.apply(Math,t):Math.min.apply(Math,arguments)}function Zd(t,e){if(typeof t!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(e))throw new Error("Second argument to map is not an array");return e.map(function(n,r){return t(n,r)})}function Qd(t,e,n){if(typeof t!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(n))throw new Error("Second argument to fold is not an array");return n.reduce(function(r,s,i){return t(r,s,i)},e)}function ep(t,e){if(typeof t!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(e))throw new Error("Second argument to filter is not an array");return e.filter(function(n,r){return t(n,r)})}function tp(t,e){if(!(Array.isArray(e)||typeof e=="string"))throw new Error("Second argument to indexOf is not a string or array");return e.indexOf(t)}function np(t,e){if(!Array.isArray(e))throw new Error("Second argument to join is not an array");return e.join(t)}function rp(t){return(t>0)-(t<0)||+t}var Oo=1/3;function sp(t){return t<0?-Math.pow(-t,Oo):Math.pow(t,Oo)}function ip(t){return Math.exp(t)-1}function op(t){return Math.log(1+t)}function ap(t){return Math.log(t)/Math.LN2}function xt(t){this.options=t||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||Ud,cosh:Math.cosh||Bd,tanh:Math.tanh||Ld,asinh:Math.asinh||Nd,acosh:Math.acosh||Fd,atanh:Math.atanh||$d,sqrt:Math.sqrt,cbrt:Math.cbrt||sp,log:Math.log,log2:Math.log2||ap,ln:Math.log,lg:Math.log10||To,log10:Math.log10||To,expm1:Math.expm1||ip,log1p:Math.log1p||op,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||jd,"-":Pd,"+":Number,exp:Math.exp,not:Vd,length:Jd,"!":Mo,sign:Math.sign||rp},this.binaryOps={"+":bd,"-":Ed,"*":kd,"/":_d,"%":Sd,"^":Math.pow,"||":xd,"==":Ad,"!=":vd,">":Id,"<":Cd,">=":Td,"<=":Md,and:Dd,or:Rd,in:Od,"=":Yd,"[":Wd},this.ternaryOps={"?":Ro},this.functions={random:Hd,fac:Mo,min:Xd,max:Kd,hypot:Math.hypot||Do,pyt:Math.hypot||Do,pow:Math.pow,atan2:Math.atan2,if:Ro,gamma:Pi,roundTo:zd,map:Zd,fold:Qd,filter:ep,indexOf:tp,join:np},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}xt.prototype.parse=function(t){var e=[],n=new Q(this,new ae(this,t),{allowMemberAccess:this.options.allowMemberAccess});return n.parseExpression(e),n.expect(ir,"EOF"),new He(e,this)};xt.prototype.evaluate=function(t,e){return this.parse(t).evaluate(e)};var Al=new xt;xt.parse=function(t){return Al.parse(t)};xt.evaluate=function(t,e){return Al.parse(t).evaluate(e)};var Uo={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function lp(t){return Uo.hasOwnProperty(t)?Uo[t]:t}xt.prototype.isOperatorEnabled=function(t){var e=lp(t),n=this.options.operators||{};return!(e in n)||!!n[e]};const Pp={NEXT_ROLL:"Prxima Rolagem",ROUNDS:"Rodadas",MINUTES:"Minutos",HOURS:"Horas",DAYS:"Dias",LUCK_ENDS:"Sorte Encerra",PERMANENT:"Indeterminado",END_OF_ROUND:"Fim da Rodada",CONCENTRATION:"Concentrao"},ln={ADD:"ADD",SET:"SET",MULT:"MULT"},Vp={str:"Fora",agi:"Agilidade",int:"Intelecto",wil:"Vontade",defense:"Defesa",speed:"Deslocamento",health:"Vida",damage:"Dano (Dados)",boons:"Boons/Banes",healing_rate:"Taxa de Cura"},wt={WEAPON:"Weapon",ARMOR:"Armor",SHIELD:"Shield",CONSUMABLE:"Consumable",EXPLOSIVE:"Explosive",OTHER:"Other"},jp=["Aeromancy","Alchemy","Alteration","Animism","Astromancy","Chaos","Chronomancy","Conjuration","Cryomancy","Dark Arts","Destruction","Divination","Eldritch","Enchantment","Evocation","Geomancy","Hydromancy","Illusion","Invocation","Necromancy","Oneiromancy","Order","Primal","Protection","Psychomancy","Pyromancy","Shadowmancy","Skullduggery","Spiritualism","Symbolism","Technomancy","Teleportation","War"],cp=[[1,0,0,0,0,0,0,0,0,0,0],[2,1,0,0,0,0,0,0,0,0,0],[3,2,1,0,0,0,0,0,0,0,0],[4,2,1,1,0,0,0,0,0,0,0],[5,2,2,1,1,0,0,0,0,0,0],[6,3,2,2,1,1,0,0,0,0,0],[7,3,2,2,2,1,1,0,0,0,0],[8,3,2,2,2,1,1,1,0,0,0],[9,3,3,2,2,2,1,1,1,0,0],[10,3,3,3,2,2,1,1,1,1,0],[11,3,3,3,3,2,1,1,1,1,1]],Hp=["Air","Alteration","Arcana","Battle","Celestial","Chaos","Conjuration","Curse","Death","Demonology","Destruction","Divination","Enchantment","Ether","Fey","Fire","Forbidden","Illusion","Life","Metal","Nature","Necromancy","Order","Primal","Protection","Rune","Shadow","Song","Soul","Spiritualism","Storm","Technomancy","Telekinesis","Telepathy","Teleportation","Theurgy","Time","Transformation","Water"];function qp(t,e){return t<0||t>10||e<0||e>10?0:cp[t]?.[e]??0}const up=new xt,vl={name:"",level:1,ancestry:"",paths:{novice:"",expert:"",master:""},attributes:[{name:"Strength",value:10,key:"str"},{name:"Agility",value:10,key:"agi"},{name:"Intellect",value:10,key:"int"},{name:"Will",value:10,key:"wil"}],currency:{gp:0,sp:0,cp:0},naturalDefense:10,bonusDamage:0,size:1,speed:10,currentRound:1,languages:[],professions:[],senses:[],afflictions:[],effects:[],notes:"",campaignId:null,campaignName:null,gmName:null,combatActive:!1,initiative:!1,acted:!1,spells:[],talents:[],equipment:[]},C=Oe(JSON.parse(JSON.stringify(vl))),qn=Oe([]),cn=Oe({type:null,isOpen:!1,data:null}),hp=Oe("acoes"),bs=Oe(24),Ht=Oe(24),Tn=Oe(0),En=Oe(!1),Es=Oe(!1),Bo={autoOpenHistory:!1,stickyHistory:!1,theme:"dark",userName:"",enable3DDice:!1};function fp(){const t=typeof localStorage<"u"?localStorage.getItem("wwv_app_settings"):null,{subscribe:e,set:n,update:r}=Oe(t?{...Bo,...JSON.parse(t)}:Bo);return{subscribe:e,set:s=>{typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(s)),n(s)},update:s=>{r(i=>{const l=s(i);return typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(l)),l})}}}const Vi=fp();En.subscribe(t=>{t&&Es.set(!1)});const Mn=pe(C,t=>{const e=t.effects.filter(r=>r.isActive),n=t.talents.filter(r=>(r.isPassive||r.activityType==="Passive")&&r.effect).map(r=>({...r.effect,id:`talent-effect-${r.id}`,name:r.name,sourceType:"talent",sourceId:r.id}));return[...e,...n]});function Ot(t,e){if(typeof t=="number")return t;if(!t)return 0;const n=String(t).trim();if(!isNaN(Number(n)))return Number(n);try{const r={};Array.isArray(e.attributes)&&e.attributes.forEach(i=>{r[i.key]=i.value}),r.level=e.level||0,r.defense=e.naturalDefense||0,r.speed=e.speed||0,r.bonusDamage=e.bonusDamage||0,r.currentRound=e.currentRound||0;const s=n.replace(/@(\w+)/g,"$1");return up.evaluate(s,r)}catch{return 0}}function ks(t,e,n,r){let s=e||0;const i=n.flatMap(g=>Array.isArray(g.modifiers)?g.modifiers:[]),l=i.filter(g=>g.target===t&&g.type===ln.SET);return l.length>0&&(s=Ot(l[l.length-1].value,r)),i.filter(g=>g.target===t&&g.type===ln.ADD).forEach(g=>{s+=Ot(g.value,r)}),i.filter(g=>g.target===t&&g.type===ln.MULT).forEach(g=>{s*=Ot(g.value,r)}),Math.floor(s)}const ji=pe([C,Mn],([t,e])=>{const n={};return Array.isArray(t.attributes)&&t.attributes.forEach(r=>{n[r.key]=ks(r.key,r.value,e,t)}),n}),Il=pe([C,Ht,Mn],([t,e,n])=>ks("health",e,n,t)),dp=pe([Il,bs],([t,e])=>Math.max(0,t-e)),pp=pe([Tn,Ht],([t,e])=>e>0?Math.min(100,t/e*100):100),Cl=pe([Tn,Ht],([t,e])=>t>=e),gp=pe([Tn,Ht,Cl],([t,e,n])=>t>=e/2&&!n),mp=pe([C,ji,Mn],([t,e,n])=>{let r=ks("speed",t.speed,n,t);const s=t.afflictions;return s.includes("Held")||s.includes("Stunned")||s.includes("Unconscious")||s.includes("Incapacitated")?0:((s.includes("Blinded")||s.includes("Weakened"))&&(r=Math.floor(r/2)),s.includes("Slowed")&&(r=Math.min(r,2)),Math.max(0,r))}),wp=pe([C,Mn],([t,e])=>{let n=t.naturalDefense,r=0;const s=t.equipment.find(i=>i.type===wt.ARMOR&&i.equipped);if(s){const i=s.defenseFixed||0,l=t.naturalDefense+(s.defenseMod||0);s.defenseFixed&&s.defenseMod?n=Math.max(i,l):s.defenseFixed?n=i:s.defenseMod&&(n=t.naturalDefense+s.defenseMod)}return t.equipment.filter(i=>i.type===wt.SHIELD&&i.equippedState).forEach(i=>{r+=i.defenseMod||0}),ks("defense",n+r,e,t)});pe([C,Mn],([t,e])=>{const r=e.flatMap(s=>Array.isArray(s.modifiers)?s.modifiers:[]).filter(s=>s.target==="damage"&&s.type===ln.ADD).reduce((s,i)=>s+Ot(i.value,t),0);return(t.bonusDamage||0)+r});const Be={updateCurrency:(t,e)=>{C.update(n=>{let r=n.currency.gp*100+n.currency.sp*10+n.currency.cp,s=0;return t==="gp"&&(s=e*100),t==="sp"&&(s=e*10),t==="cp"&&(s=e),r+=s,r<0&&(r=0),{...n,currency:{gp:Math.floor(r/100),sp:Math.floor(r%100/10),cp:r%100%10}}})},advanceRound:t=>{C.update(e=>{const n=e.currentRound||1;if(t==="next"){const r=(e.effects||[]).map(s=>{if(s.isActive&&s.duration==="ROUNDS"&&s.roundsLeft>0){const i=s.roundsLeft-1;return i<=0?{...s,roundsLeft:0,isActive:!1}:{...s,roundsLeft:i}}return s});return{...e,currentRound:n+1,effects:r}}else return{...e,currentRound:Math.max(1,n-1)}})},addToHistory:(t,e=!0)=>{const n=H(C),r=H(qn);if(t.id&&r.find(l=>l.id===t.id))return;const s={id:t.id||jn(),timestamp:t.timestamp||new Date,charName:n.name,source:t.source||"gm",name:t.name||"Action",...t};qn.update(l=>[s,...l]),H(Vi).autoOpenHistory?En.set(!0):H(En)||Es.set(!0),e&&n.campaignId&&js(async()=>{const{syncRoll:l}=await Promise.resolve().then(()=>oi);return{syncRoll:l}},void 0,import.meta.url).then(({syncRoll:l})=>{l(s)})},clearHistory:()=>qn.set([]),addItem:t=>C.update(e=>({...e,equipment:[...e.equipment,t]})),updateItem:t=>C.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?t:n)})),deleteItem:t=>C.update(e=>({...e,equipment:e.equipment.filter(n=>n.id!==t)})),useConsumable:t=>{if(t.quantity>0){const e=H(ot);Be.updateItem({...t,quantity:t.quantity-1}),Be.addToHistory({source:"item",name:t.name,description:e("sofww.item_types.consumable")+`: ${t.name}`})}},equipItem:(t,e=null)=>{C.update(n=>{let r=[...n.equipment];return t.type===wt.ARMOR?r=r.map(s=>s.id===t.id?{...s,equipped:!s.equipped}:s.type===wt.ARMOR&&t.type===wt.ARMOR&&!t.equipped?{...s,equipped:!1}:s):(t.type===wt.WEAPON||t.type===wt.SHIELD)&&(r=r.map(s=>s.id===t.id?{...s,equippedState:e}:s)),{...n,equipment:r}})},toggleAffliction:t=>{C.update(e=>e.afflictions.includes(t)?{...e,afflictions:e.afflictions.filter(n=>n!==t)}:{...e,afflictions:[...e.afflictions,t]})},addLanguage:t=>C.update(e=>({...e,languages:[...e.languages,t]})),removeLanguage:t=>C.update(e=>({...e,languages:e.languages.filter((n,r)=>r!==t)})),addSense:t=>C.update(e=>({...e,senses:[...e.senses||[],t]})),removeSense:t=>C.update(e=>({...e,senses:(e.senses||[]).filter((n,r)=>r!==t)})),confirmRest:()=>{C.update(e=>{const n=e.spells.map(s=>({...s,castings:s.maxCastings})),r=e.talents.map(s=>({...s,uses:s.maxUses}));return{...e,spells:n,talents:r}}),Tn.set(0);const t=H(bs);Ht.set(t),cn.set({type:null,isOpen:!1,data:null})},finalizeRoll:(t,e,n=[],r={})=>{const s=H(C),i=H(ji),l=H(ot),h=t.type==="weapon_attack",f=t.type==="luck",g=t.type==="weapon_damage",c=t?.source,m=c?.name||l("common.labels.action"),d=(S,I)=>S.traits&&S.traits.toLowerCase().includes(I.toLowerCase());let w={},E=()=>{};if(g){let S=parseInt(c.damageDice)||0;const I=c.grip&&c.grip.toLowerCase()==="two"||c.equippedState&&c.equippedState.toLowerCase()==="two";d(c,"Versatile")&&I&&(S+=1);let D=s.bonusDamage||0;d(c,"Light")&&D>1&&(D-=1);const ee=n.flatMap(v=>Array.isArray(v.modifiers)?v.modifiers:[]).filter(v=>v.target==="damage"&&v.type===ln.ADD).reduce((v,L)=>v+Ot(L.value,s),0),q=D+ee,B=Math.max(0,S+q+e);let j=[],J=0,X=[];for(let v=0;v<B;v++){let L=Math.floor(Math.random()*6)+1;if(L===1&&d(c,"Brutal")){const Ce=Math.floor(Math.random()*6)+1;X.push(`1->${Ce}`),L=Ce}else X.push(`${L}`);j.push(L),J+=L}const ne=`${B}d6 [${j.join(", ")}] ${X.some(v=>v.includes("->"))?`(Rolagens: ${X.join(", ")})`:""}`;w={damageDice:j,total:J,formula:ne},E=()=>{Be.addToHistory({source:"damage",name:c.name,description:`${l("history.source.damage")}: ${B}d6 ${d(c,"Brutal")?"(Brutal)":""}`,formula:ne,total:J,effectsApplied:n.map(v=>v.name)}),c.type===wt.EXPLOSIVE&&Be.useConsumable(c)}}else{const S=Math.floor(Math.random()*20)+1;let I=0,D=l("history.source.luck");if(t.type==="attribute")I=(i[t.source.key]||t.source.value)-10,D=l(`sofww.attributes.${t.source.key}`);else if(h){let v="str",L=l("sofww.attributes.str");c.range==="Ranged"&&(v="agi",L=l("sofww.attributes.agi"),d(c,"Thrown")&&(v="str",L=l("sofww.attributes.str"))),d(c,"Nimble")&&(v="agi",L=l("sofww.attributes.agi")),I=(i[v]||10)-10,D=L}const ee=Math.floor(n.flatMap(v=>Array.isArray(v.modifiers)?v.modifiers:[]).filter(v=>v.target==="boons"&&v.type===ln.ADD).reduce((v,L)=>v+Ot(L.value,s),0));e+=ee;let q=0,B="",j=[];if(e!==0){const v=Math.abs(e);for(let Ce=0;Ce<v;Ce++)j.push(Math.floor(Math.random()*6)+1);const L=Math.max(...j);e>0?(q=L,B=` + ${L} [${l("sofdl.rolls.boon")}]`):(q=-L,B=` - ${L} [${l("sofdl.rolls.bane")}]`)}const J=S+I+q;let X="";if(h?X=`${l("history.source.attack")} (${D})`:f?X=l("history.source.luck"):X=`${l("history.source.attribute")}: ${m}`,e!==0&&(X+=` ${l("sofdl.rolls.attribute_test",{values:{attr:"",modifier:e}}).replace(/^[^ ]+ /,"")}`),h&&S===20){let v=[];d(c,"Bludgeoning")&&v.push(l("sofww.afflictions.vulnerable.name")),d(c,"Piercing")&&v.push(l("sofww.afflictions.weakened.name")),d(c,"Slashing")&&v.push("+1d6 Dmg"),v.length>0&&(X+=`
CRTICO! ${v.join(" ")} `)}const ne=`d20(${S})${I!==0?(I>=0?"+":"")+I:""}${B}`;w={d20:S,boonBaneDice:j,total:J,formula:ne},E=()=>{Be.addToHistory({source:h?"attack":f?"luck":"attribute",name:m,description:X,formula:ne,total:J,crit:S===20,effectsApplied:n.map(v=>v.name)}),C.update(v=>({...v,effects:v.effects.map(L=>L.isActive&&L.duration==="NEXT_ROLL"?{...L,isActive:!1}:L)})),h&&d(c,"Reload")&&C.update(v=>({...v,equipment:v.equipment.map(L=>L.id===c.id?{...L,isLoaded:!1}:L)}))}}return r.suppressHistory||E(),{...w,commit:E}},reloadWeapon:t=>{const e=H(ot);C.update(n=>({...n,equipment:n.equipment.map(r=>r.id===t.id?{...r,isLoaded:!0}:r)})),Be.addToHistory({source:"attribute",name:e("actions.reload"),description:`${e("actions.reload")}: ${t.name}`})},addSpell:t=>C.update(e=>({...e,spells:[...e.spells,t]})),updateSpell:t=>C.update(e=>({...e,spells:e.spells.map(n=>n.id===t.id?t:n)})),deleteSpell:t=>C.update(e=>({...e,spells:e.spells.filter(n=>n.id!==t)})),commitSpellCast:t=>{t.castings>0&&(C.update(e=>({...e,spells:e.spells.map(n=>n.id===t.id?{...n,castings:n.castings-1}:n)})),Be.addToHistory({source:"spell",name:t.name,description:t.description}),cn.set({type:null,isOpen:!1,data:null}))},addTalent:t=>C.update(e=>({...e,talents:[...e.talents,t]})),updateTalent:t=>C.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?t:n)})),deleteTalent:t=>C.update(e=>({...e,talents:e.talents.filter(n=>n.id!==t)})),commitTalentUse:t=>{t.activityType==="Duration"&&t.duration==="LUCK_ENDS"?C.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?{...n,uses:0}:n)})):t.maxUses&&C.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?{...n,uses:n.uses-1}:n)})),Be.addToHistory({source:"talent",name:t.name,description:t.description}),cn.set({type:null,isOpen:!1,data:null})},recoverTalent:t=>{C.update(e=>({...e,talents:e.talents.map(n=>n.id===t&&n.uses<n.maxUses?{...n,uses:(n.uses||0)+1}:n)}))},rollLuckTalent:t=>{const e=H(ot),n=Math.floor(Math.random()*20)+1,r=n>=10,i=H(C).talents.find(l=>l.id===t);Be.addToHistory({source:"luck",name:`${e("character.history.source.luck")} - ${i?.name||e("character.talents.title")}`,formula:`d20(${n})`,total:n,description:r?e("character.dice_roll.luck_success",{values:{total:n}}):e("character.dice_roll.luck_failure",{values:{total:n}})}),r&&C.update(l=>({...l,talents:l.talents.map(h=>h.id===t?{...h,uses:1}:h)}))},addEffect:t=>C.update(e=>({...e,effects:[...e.effects,t]})),updateEffect:t=>C.update(e=>({...e,effects:e.effects.map(n=>n.id===t.id?t:n)})),deleteEffect:t=>C.update(e=>({...e,effects:e.effects.filter(n=>n.id!==t)})),toggleEffect:t=>C.update(e=>({...e,effects:e.effects.map(n=>{if(n.id===t){const r=!n.isActive;return{...n,isActive:r,roundsLeft:r&&n.duration==="ROUNDS"&&n.initialRounds||n.roundsLeft}}return n})})),cleanInactiveEffects:()=>C.update(t=>({...t,effects:t.effects.filter(e=>e.isActive)})),applyEffectToCharacter:(t,e)=>{const n=t.name||(e?e.name:"Effect"),r=t.description||(e?e.description:""),s={id:jn(),isActive:!0,name:n,description:r,roundsLeft:0,duration:"PERMANENT",modifiers:[],...t};s.duration==="ROUNDS"&&!s.initialRounds&&(s.initialRounds=s.roundsLeft),C.update(i=>({...i,effects:[...i.effects,s]}))},checkLuckEnds:t=>{const e=H(ot),n=Math.floor(Math.random()*20)+1,r=n>=10;Be.addToHistory({source:"luck",name:e("sofww.duration.luck_ends"),description:r?e("character.dice_roll.luck_success",{values:{total:n}}):e("character.dice_roll.luck_failure",{values:{total:n}})}),r&&C.update(s=>({...s,effects:s.effects.map(i=>i.id===t?{...i,isActive:!1}:i)}))},joinCampaign:t=>{C.update(e=>({...e,campaignId:t.id,campaignName:t.name,gmName:t.gmName||"Game Master"})),js(async()=>{const{joinCampaignRoom:e}=await Promise.resolve().then(()=>oi);return{joinCampaignRoom:e}},void 0,import.meta.url).then(({joinCampaignRoom:e})=>{e(t.id,!1)})},leaveCampaign:()=>{C.update(t=>({...t,campaignId:null,campaignName:null,gmName:null,combatActive:!1}))}},Gp=Object.freeze(Object.defineProperty({__proto__:null,activeEffects:Mn,activeTab:hp,appSettings:Vi,character:C,characterActions:Be,currentHealth:Ht,damage:Tn,damagePercentage:pp,defaultCharacter:vl,derivedStats:ji,effectiveMaxHealth:Il,effectiveSpeed:mp,evaluateModifierValue:Ot,hasUnreadRolls:Es,isHistoryOpen:En,isIncapacitated:Cl,isInjured:gp,modalState:cn,normalHealth:bs,rollHistory:qn,tempHealth:dp,totalDefense:wp},Symbol.toStringTag,{value:"Module"})),yp=new xt,bp={id:"",system:"sofdl",name:"",ancestry:"",level:0,paths:{novice:"",expert:"",master:""},imageUrl:"",attributes:{strength:10,agility:10,intellect:10,will:10},perception:10,defense:10,health:10,healingRate:2,size:1,speed:10,power:0,damage:0,insanity:0,corruption:0,description:"",notes:"",professions:[],languages:["Comum"],senses:[],afflictions:[],talents:[],spells:[],equipment:[],currency:{gc:0,ss:0,cp:0,bits:0},effects:[],campaignId:null,campaignName:null,gmName:null,campaignApproval:null,combatActive:!1,currentRound:1,initiative:!1,acted:!1,magicSystem:"standard"},M=Oe(JSON.parse(JSON.stringify(bp))),Ep=pe(M,t=>t.effects.filter(e=>e.isActive)),qt=pe([M,Ep],([t,e])=>{const n={strength:t.attributes.strength,agility:t.attributes.agility,intellect:t.attributes.intellect,will:t.attributes.will,perception:t.perception,defense:t.defense,health:t.health,speed:t.speed,healingRate:t.healingRate,power:t.power,boons:0},r=[];e.forEach(l=>{l.modifiers&&l.modifiers.forEach(h=>{r.push(h)})});const s=l=>l==="healing_rate"?"healingRate":l;return Object.keys(n).forEach(l=>{const h=r.filter(c=>s(c.target)===l);if(h.length===0)return;const f=h.filter(c=>c.type==="SET");if(f.length>0){const c=f[f.length-1];n[l]=Vs(c.value,t)}f.length===0&&h.filter(m=>m.type==="ADD").forEach(m=>{n[l]+=Vs(m.value,t)}),h.filter(c=>c.type==="MULT").forEach(c=>{n[l]*=Vs(c.value,t)}),n[l]=Math.floor(n[l])}),{strength:n.strength,agility:n.agility,intellect:n.intellect,will:n.will,perception:n.perception,defense:n.defense,health:n.health,speed:n.speed,healingRate:n.healingRate,power:n.power,boons:n.boons}}),Jp=pe(qt,t=>({strength:t.strength,agility:t.agility,intellect:t.intellect,will:t.will})),kp=pe(qt,t=>({strength:t.strength-10,agility:t.agility-10,intellect:t.intellect-10,will:t.will-10}));pe([M,qt],([t,e])=>e.health-t.damage);pe([M,qt],([t,e])=>t.damage>=e.health/2);pe([M,qt],([t,e])=>t.damage>=e.health);function Vs(t,e){if(typeof t=="number")return t;if(!t)return 0;const n=String(t).trim();if(!isNaN(Number(n)))return Number(n);try{const r={};e.attributes&&Object.entries(e.attributes).forEach(([i,l])=>{r[i]=l}),r.level=e.level||0,r.perception=e.perception||0,r.defense=e.defense||0,r.health=e.health||0,r.healingRate=e.healingRate||0,r.size=e.size||0,r.speed=e.speed||0,r.power=e.power||0,r.damage=e.damage||0,r.insanity=e.insanity||0,r.corruption=e.corruption||0;const s=n.replace(/@(\w+)/g,"$1");return yp.evaluate(s,r)}catch{return 0}}const zp=pe(qt,t=>Math.max(0,t.healingRate)),Qt={set:t=>{M.update(e=>{const n={...e,...t};return t.health!==void 0&&t.healingRate===void 0&&(n.healingRate=Math.floor(n.health/4)),n})},updateAttribute:(t,e)=>{M.update(n=>({...n,attributes:{...n.attributes,[t]:e}}))},takeDamage:t=>{M.update(e=>{const n=Math.max(0,Math.min(e.health,e.damage+t));return{...e,damage:n}})},heal:t=>{M.update(e=>{const n=Math.max(0,e.damage-t);return{...e,damage:n}})},updateStat:(t,e)=>{M.update(n=>({...n,[t]:Math.max(0,e)}))},toggleEffect:t=>{M.update(e=>({...e,effects:e.effects.map(n=>n.id===t?{...n,isActive:!n.isActive}:n)}))},deleteEffect:t=>{M.update(e=>({...e,effects:e.effects.filter(n=>n.id!==t)}))},cleanInactiveEffects:()=>{M.update(t=>({...t,effects:t.effects.filter(e=>e.isActive)}))},advanceRound:t=>{M.update(e=>{if(t==="next"){const n=e.effects.map(r=>r.isActive&&r.duration==="END_OF_ROUND"?{...r,isActive:!1}:r);return{...e,currentRound:e.currentRound+1,effects:n}}return{...e,currentRound:Math.max(1,e.currentRound-1)}})},checkLuckEnds:t=>{const n=H(M).effects.find(s=>s.id===t),r=H(ot);cn.set({type:"pre_roll",isOpen:!0,data:{type:"luck_ends",system:"sofdl",effectId:t,source:{name:n?.name||r("sofdl.rolls.effect")}}})},checkConcentration:t=>{const n=H(M).effects.find(s=>s.id===t),r=H(ot);cn.set({type:"pre_roll",isOpen:!0,data:{type:"concentration",system:"sofdl",effectId:t,key:"will",source:{name:n?.name||r("sofdl.rolls.concentration")}}})},addSpell:t=>{M.update(e=>({...e,spells:[...e.spells,{...t,id:t.id||jn()}]}))},updateSpell:t=>{M.update(e=>({...e,spells:e.spells.map(n=>n.id===t.id?t:n)}))},deleteSpell:t=>{M.update(e=>({...e,spells:e.spells.filter(n=>n.id!==t)}))},castSpell:t=>{const n=H(M).spells.find(r=>r.id===t);n&&(M.update(r=>({...r,spells:r.spells.map(s=>s.id===t?{...s,castingsUsed:(s.castingsUsed||0)+1}:s)})),Qt.addToHistory({source:"spell",name:n.name,description:n.description,type:"spell"}))},resetSpellCastings:()=>{M.update(t=>({...t,spells:t.spells.map(e=>({...e,castingsUsed:0}))}))},addTalent:t=>{M.update(e=>({...e,talents:[...e.talents,{...t,id:t.id||jn()}]}))},updateTalent:t=>{M.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?t:n)}))},deleteTalent:t=>{M.update(e=>({...e,talents:e.talents.filter(n=>n.id!==t)}))},useTalent:t=>{const n=H(M).talents.find(r=>r.id===t);n&&(M.update(r=>({...r,talents:r.talents.map(s=>s.id===t&&s.uses>0?{...s,uses:s.uses-1}:s)})),Qt.addToHistory({source:"talent",name:n.name,description:n.description,type:"talent"}))},resetTalentUses:()=>{M.update(t=>({...t,talents:t.talents.map(e=>({...e,uses:e.maxUses}))}))},addSense:t=>{M.update(e=>({...e,senses:e.senses.includes(t)?e.senses:[...e.senses,t]}))},removeSense:t=>{M.update(e=>({...e,senses:e.senses.filter((n,r)=>r!==t)}))},toggleAffliction:t=>{M.update(e=>({...e,afflictions:e.afflictions.includes(t)?e.afflictions.filter(n=>n!==t):[...e.afflictions,t]}))},leaveCampaign:()=>{M.update(t=>({...t,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}))},addToHistory:(t,e=!0)=>{const n=H(M),r={id:t.id||jn(),timestamp:t.timestamp||new Date,charName:n.name,...t};qn.update(i=>[r,...i]),H(Vi).autoOpenHistory?En.set(!0):H(En)||Es.set(!0),e&&n.campaignId&&js(async()=>{const{syncRoll:i}=await Promise.resolve().then(()=>oi);return{syncRoll:i}},void 0,import.meta.url).then(({syncRoll:i})=>{i(r)})},addLanguage:t=>M.update(e=>({...e,languages:[...e.languages,t]})),removeLanguage:t=>M.update(e=>({...e,languages:e.languages.filter((n,r)=>r!==t)})),addProfession:t=>M.update(e=>({...e,professions:[...e.professions,t]})),removeProfession:t=>M.update(e=>({...e,professions:e.professions.filter((n,r)=>r!==t)})),updateCurrency:(t,e)=>{M.update(n=>{const r=Math.max(0,(n.currency[t]||0)+e);return{...n,currency:{...n.currency,[t]:r}}})},addItem:t=>M.update(e=>({...e,equipment:[...e.equipment,t]})),updateItem:t=>M.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?t:n)})),deleteItem:t=>M.update(e=>({...e,equipment:e.equipment.filter(n=>n.id!==t)})),useConsumable:t=>{M.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?{...n,quantity:Math.max(0,n.quantity-1)}:n)}))},reloadWeapon:t=>M.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?{...n,isLoaded:!0}:n)})),finalizeRoll:(t,e,n=[],r={})=>{H(M);const s=H(kp),i=H(qt),l=t?.type==="weapon_damage"||t?.type==="spell_damage",h=H(ot),f=t?.source?.name||t?.key||h("character.modals.attribute");let g={},c=()=>{};if(l){const m=t.source?.damage??t.source?.damageDice??"1d6",d=String(m),w=Number(t.source?.damageMod)||0;let E=0,S=[],I="";if(d==="0")E=0,I="0";else if(!d.includes("d"))E=parseInt(d)||0,I=`${E}`,S=[E];else{const B=d.match(/(\d+)d(\d+)/);if(B){const j=parseInt(B[1])||1,J=parseInt(B[2])||6;for(let X=0;X<j;X++){const ne=Math.floor(Math.random()*J)+1;E+=ne,S.push(ne)}I=`${d} [${S.join(", ")}]`}else E=1,I="1"}const D=E+e+w,ee=e+w!==0?`${e+w>0?"+":""}${e+w}`:"",q=`${I}${ee}`;g={damageDice:S,total:D,formula:q},c=()=>{const B=H(ot);Qt.addToHistory({source:"damage",name:f,description:B("sofdl.rolls.damage_description",{values:{source:f}}),formula:q,total:D,effectsApplied:n})}}else{const m=Math.floor(Math.random()*20)+1;let d=0,w=f;t.type==="attribute"?(d=s[t.key]||0,w=h(`sofdl.attributes.${t.key}`)):t.type==="luck"&&(d=0,w=h("character.luck_test"));let E=e+(i.boons||0),S=0,I="",D=[];if(E!==0){const j=Math.abs(E);for(let X=0;X<j;X++)D.push(Math.floor(Math.random()*6)+1);const J=Math.max(...D);E>0?(S=J,I=` + ${J} [${h("sofdl.rolls.boon")}]`):(S=-J,I=` - ${J} [${h("sofdl.rolls.bane")}]`)}let ee="attribute";t.type==="weapon_attack"?ee="attack":(t.type==="luck"||t.type==="luck_ends")&&(ee="luck");const q=m+d+S,B=`d20(${m})${d!==0?(d>=0?"+":"")+d:""}${I}`;g={d20:m,boonBaneDice:D,total:q,formula:B},c=()=>{Qt.addToHistory({source:ee,name:w,description:t.type==="luck_ends"?h("sofdl.rolls.luck_ends",{values:{effect:f}}):h("sofdl.rolls.attribute_test",{values:{attr:w,modifier:e}}),formula:B,total:q,crit:m===20,effectsApplied:n}),t.type==="luck_ends"&&q>=10&&M.update(j=>({...j,effects:j.effects.map(J=>J.id===t.effectId?{...J,isActive:!1}:J)}))}}return r.suppressHistory||c(),{...g,commit:c}},rest:()=>{M.update(t=>{const e=t.spells.map(s=>({...s,castingsUsed:0})),n=t.talents.map(s=>({...s,uses:s.isPassive?0:s.maxUses})),r=Math.max(0,t.damage-t.healingRate);return{...t,spells:e,talents:n,damage:r}})}},Tl={appId:hl,trackerUrls:["wss://tracker.openwebtorrent.com","wss://tracker.files.fm:7073/announce","wss://tracker.webtorrent.dev","wss://toad.vibe.community:443/announce","wss://tracker.btorrent.xyz"]},We=Oe({roomId:null,peers:[],currentCharacterId:null,lastGmUpdate:0,isGM:!1,isConnected:!1}),_p=pe(We,t=>t.lastGmUpdate?Date.now()-t.lastGmUpdate<6e4:!1);let we=null,bt=null,or=null,ar=null,lr=null,cr=null,Dt=null,Ze=null,Lo=0,No=0;const Sp=2e3,xp={appId:"weird-wizard-vault-lobby"},si=Oe([]);function ur(t,e){if(!t)return!0;try{return t.leave(),!0}catch(n){return console.warn(`Failed to leave ${e}:`,n),!1}}function Ml(t){return Date.now()-t>=Sp}function ii(){if(!Ml(Lo))return console.warn("Lobby join rate limited. Skipping duplicate join attempt."),null;Lo=Date.now(),Dt&&(clearInterval(Dt),Dt=null),ur(bt,"existing lobby"),bt=null;try{bt=El(xp,"public-discovery");const[t,e]=bt.makeAction("discovery");return e(n=>{si.update(r=>{const s=r.findIndex(i=>i.id===n.id);if(s!==-1){const i=[...r];return i[s]={...n,lastSeen:Date.now()},i}return[...r,{...n,lastSeen:Date.now()}]})}),Dt=setInterval(()=>{const n=Date.now();si.update(r=>r.filter(s=>n-s.lastSeen<12e4))},6e4),t}catch(t){return console.error("Failed to join lobby:",t),bt=null,null}}let Zr;function Ap(){typeof window<"u"&&(sessionStorage.getItem("lobby-initialized")?bt||(Zr=ii()):(sessionStorage.setItem("lobby-initialized","true"),Zr=ii()))}typeof window<"u"&&(Ap(),window.addEventListener("beforeunload",()=>{Fo()}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Fo()}));function Fo(){Dt&&(clearInterval(Dt),Dt=null),Ze&&(clearInterval(Ze),Ze=null),ur(bt,"lobby"),ur(we,"room"),bt=null,we=null}let Xt=null;function vp(t,e=!1,n=null){const r=`campaign-${t}`;if(Xt===r&&we)return We.update(s=>({...s,isGM:e,currentCharacterId:n})),we;if(!Ml(No))return console.warn("Campaign join rate limited. Skipping duplicate join attempt."),we;No=Date.now(),Ze&&(clearInterval(Ze),Ze=null),ur(we,"existing campaign room"),we=null,Xt=null,or=null,ar=null,lr=null,cr=null;try{Xt=r,we=El(Tl,Xt),We.set({isConnected:!0,isGM:e,currentCharacterId:n,peers:[],roomId:t,lastGmUpdate:0});const[s,i]=we.makeAction("combat"),[l,h]=we.makeAction("history"),[f,g]=we.makeAction("charUpdate"),[c,m]=we.makeAction("campaign");return or=s,ar=l,lr=f,cr=c,i(d=>{e||C.update(w=>({...w,currentRound:d.round,combatActive:d.active}))}),m(d=>{We.update(w=>({...w,lastGmUpdate:Date.now()})),e||C.update(w=>({...w,campaignName:d.name,gmName:d.gmName,passwordHash:d.passwordHash,system:d.system}))}),e&&Zr&&(Ze=setInterval(()=>{const d=Nn.get(t);d&&d.isPublished&&Zr({id:t,name:d.name,gmName:d.gmName||"Mestre",description:d.description})},3e4)),h(d=>{Be.addToHistory(d,!1)}),g(d=>{if(e){const w=Nn.get(t);if(w){const E=w.members||[],S=E.findIndex(B=>B.id===d.id);let I;if(S!==-1){I=[...E];const B=I[S],j={...d};B.campaignApproval==="approved"&&d.campaignApproval==="pending"&&delete j.campaignApproval,I[S]={...B,...j,lastUpdate:Date.now()}}else I=[...E,{...d,lastUpdate:Date.now()}];const D=w.activeEnemies||[],ee=D.findIndex(B=>B.id===d.id&&B.type==="player");let q=D;ee!==-1&&(q=[...D],q[ee]={...q[ee],...d}),Nn.set(t,{...w,members:I,activeEnemies:q})}}else{const w=H(We),E=H(C),S=w.currentCharacterId||E?.id;if(S&&S===d.id){const I=d.system==="sofdl";if(d.campaignApproval==="rejected"||d.campaignId===null){I?Qt.leaveCampaign():C.update(D=>({...D,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}));return}I?Qt.set({name:d.name,afflictions:d.afflictions,senses:d.senses,initiative:d.initiative,acted:d.acted,campaignApproval:d.campaignApproval,imageUrl:d.imageUrl,notes:d.notes,damage:d.damage,health:d.health,healingRate:d.healingRate,insanity:d.insanity,corruption:d.corruption,defense:d.defense,speed:d.speed,power:d.power,attributes:d.attributes}):(C.update(D=>({...D,name:d.name||D.name,afflictions:d.afflictions||D.afflictions,senses:d.senses||D.senses,initiative:d.initiative!==void 0?d.initiative:D.initiative??!1,acted:d.acted!==void 0?d.acted:D.acted??!1,campaignApproval:d.campaignApproval||D.campaignApproval,imageUrl:d.imageUrl||D.imageUrl,notes:d.notes!==void 0?d.notes:D.notes})),d.damage!==void 0&&Tn.set(d.damage),d.currentHealth!==void 0&&Ht.set(d.currentHealth),d.normalHealth!==void 0&&bs.set(d.normalHealth))}}}),we.onPeerJoin(d=>{if(We.update(w=>({...w,peers:[...w.peers,d]})),e){const w=Nn.get(t);w&&(w.combat&&s(w.combat),c({name:w.name,gmName:w.gmName||"Mestre",passwordHash:w.passwordHash,system:w.system}))}}),we.onPeerLeave(d=>{We.update(w=>({...w,peers:w.peers.filter(E=>E!==d)}))}),we}catch(s){return console.error("Failed to join campaign room:",s),we=null,Xt=null,We.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0}),null}}function Ip(t,e){or&&or(e)}function Cp(t,e){cr&&cr({name:e.name,gmName:e.gmName||"Mestre",passwordHash:e.passwordHash,system:e.system})}function Tp(t){ar&&ar(t)}function Mp(t){lr&&lr(t)}function Dp(){Ze&&(clearInterval(Ze),Ze=null),ur(we,"campaign room"),we=null,Xt=null,or=null,ar=null,lr=null,cr=null,We.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0})}const oi=Object.freeze(Object.defineProperty({__proto__:null,isGmOnline:_p,joinCampaignRoom:vp,joinLobby:ii,leaveCampaignRoom:Dp,publicCampaigns:si,roomConfig:Tl,syncCampaign:Cp,syncCharacter:Mp,syncCombat:Ip,syncRoll:Tp,syncState:We},Symbol.toStringTag,{value:"Module"}));export{kp as $,qn as A,Il as B,Tn as C,dp as D,gp as E,Cl as F,pp as G,cn as H,wt as I,Pp as J,ln as K,Qt as L,jp as M,Vs as N,Ot as O,Jp as P,ji as Q,Ep as R,Mn as S,M as T,qt as U,bs as V,Ht as W,wp as X,mp as Y,hp as Z,Vp as _,El as a,zp as a0,qp as a1,Hp as a2,bp as a3,vl as a4,$p as a5,Gp as a6,Lp as b,C as c,If as d,Nn as e,Cf as f,Tf as g,Mp as h,_p as i,vp as j,Cp as k,Dp as l,En as m,Ip as n,Np as o,We as p,Es as q,Tl as r,Kt as s,Be as t,jn as u,Vi as v,Rf as w,Df as x,Mf as y,si as z};
