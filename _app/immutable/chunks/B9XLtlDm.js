import{bh as Cc,as as Tc,u as Mc,p as Dc,h as Oc,aS as Tn,bk as Rc}from"./Dw_raXzk.js";import{w as Me,q as ge,g as H}from"./Dy4L3Tb7.js";import{_ as Fs}from"./CLDCoJG6.js";import{k as Vi,$ as rt}from"./DHvfXG5j.js";function Cp(t,e,n=e){var r=new WeakSet;Cc(t,"input",async s=>{var i=s?t.defaultValue:t.value;if(i=ks(t)?_s(i):i,n(i),Tn!==null&&r.add(Tn),await Tc(),i!==(i=e())){var c=t.selectionStart,h=t.selectionEnd,f=t.value.length;if(t.value=i??"",h!==null){var g=t.value.length;c===h&&h===f&&g>f?(t.selectionStart=g,t.selectionEnd=g):(t.selectionStart=c,t.selectionEnd=Math.min(h,g))}}}),(Oc&&t.defaultValue!==t.value||Mc(e)==null&&t.value)&&(n(ks(t)?_s(t.value):t.value),Tn!==null&&r.add(Tn)),Dc(()=>{var s=e();if(t===document.activeElement){var i=Rc??Tn;if(r.has(i))return}ks(t)&&s===_s(t.value)||t.type==="date"&&!s&&!t.value||s!==t.value&&(t.value=s??"")})}function ks(t){var e=t.type;return e==="number"||e==="range"}function _s(t){return t===""?null:+t}function Uc(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var Bo={exports:{}},se=Bo.exports={},qe,Ge;function $s(){throw new Error("setTimeout has not been defined")}function Ps(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?qe=setTimeout:qe=$s}catch{qe=$s}try{typeof clearTimeout=="function"?Ge=clearTimeout:Ge=Ps}catch{Ge=Ps}})();function Lo(t){if(qe===setTimeout)return setTimeout(t,0);if((qe===$s||!qe)&&setTimeout)return qe=setTimeout,setTimeout(t,0);try{return qe(t,0)}catch{try{return qe.call(null,t,0)}catch{return qe.call(this,t,0)}}}function Bc(t){if(Ge===clearTimeout)return clearTimeout(t);if((Ge===Ps||!Ge)&&clearTimeout)return Ge=clearTimeout,clearTimeout(t);try{return Ge(t)}catch{try{return Ge.call(null,t)}catch{return Ge.call(this,t)}}}var st=[],Zt=!1,vt,vr=-1;function Lc(){!Zt||!vt||(Zt=!1,vt.length?st=vt.concat(st):vr=-1,st.length&&No())}function No(){if(!Zt){var t=Lo(Lc);Zt=!0;for(var e=st.length;e;){for(vt=st,st=[];++vr<e;)vt&&vt[vr].run();vr=-1,e=st.length}vt=null,Zt=!1,Bc(t)}}se.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];st.push(new Fo(t,e)),st.length===1&&!Zt&&Lo(No)};function Fo(t,e){this.fun=t,this.array=e}Fo.prototype.run=function(){this.fun.apply(null,this.array)};se.title="browser";se.browser=!0;se.env={};se.argv=[];se.version="";se.versions={};function ct(){}se.on=ct;se.addListener=ct;se.once=ct;se.off=ct;se.removeListener=ct;se.removeAllListeners=ct;se.emit=ct;se.prependListener=ct;se.prependOnceListener=ct;se.listeners=function(t){return[]};se.binding=function(t){throw new Error("process.binding is not supported")};se.cwd=function(){return"/"};se.chdir=function(t){throw new Error("process.chdir is not supported")};se.umask=function(){return 0};var Nc=Bo.exports;const xt=Uc(Nc);var Fc={},Zr={};Zr.byteLength=Vc;Zr.toByteArray=Hc;Zr.fromByteArray=Jc;var ze=[],Oe=[],$c=typeof Uint8Array<"u"?Uint8Array:Array,xs="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var Ht=0,Pc=xs.length;Ht<Pc;++Ht)ze[Ht]=xs[Ht],Oe[xs.charCodeAt(Ht)]=Ht;Oe[45]=62;Oe[95]=63;function $o(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=t.indexOf("=");n===-1&&(n=e);var r=n===e?0:4-n%4;return[n,r]}function Vc(t){var e=$o(t),n=e[0],r=e[1];return(n+r)*3/4-r}function jc(t,e,n){return(e+n)*3/4-n}function Hc(t){var e,n=$o(t),r=n[0],s=n[1],i=new $c(jc(t,r,s)),c=0,h=s>0?r-4:r,f;for(f=0;f<h;f+=4)e=Oe[t.charCodeAt(f)]<<18|Oe[t.charCodeAt(f+1)]<<12|Oe[t.charCodeAt(f+2)]<<6|Oe[t.charCodeAt(f+3)],i[c++]=e>>16&255,i[c++]=e>>8&255,i[c++]=e&255;return s===2&&(e=Oe[t.charCodeAt(f)]<<2|Oe[t.charCodeAt(f+1)]>>4,i[c++]=e&255),s===1&&(e=Oe[t.charCodeAt(f)]<<10|Oe[t.charCodeAt(f+1)]<<4|Oe[t.charCodeAt(f+2)]>>2,i[c++]=e>>8&255,i[c++]=e&255),i}function qc(t){return ze[t>>18&63]+ze[t>>12&63]+ze[t>>6&63]+ze[t&63]}function Gc(t,e,n){for(var r,s=[],i=e;i<n;i+=3)r=(t[i]<<16&16711680)+(t[i+1]<<8&65280)+(t[i+2]&255),s.push(qc(r));return s.join("")}function Jc(t){for(var e,n=t.length,r=n%3,s=[],i=16383,c=0,h=n-r;c<h;c+=i)s.push(Gc(t,c,c+i>h?h:c+i));return r===1?(e=t[n-1],s.push(ze[e>>2]+ze[e<<4&63]+"==")):r===2&&(e=(t[n-2]<<8)+t[n-1],s.push(ze[e>>10]+ze[e>>4&63]+ze[e<<2&63]+"=")),s.join("")}var ri={};ri.read=function(t,e,n,r,s){var i,c,h=s*8-r-1,f=(1<<h)-1,g=f>>1,u=-7,m=n?s-1:0,d=n?-1:1,w=t[e+m];for(m+=d,i=w&(1<<-u)-1,w>>=-u,u+=h;u>0;i=i*256+t[e+m],m+=d,u-=8);for(c=i&(1<<-u)-1,i>>=-u,u+=r;u>0;c=c*256+t[e+m],m+=d,u-=8);if(i===0)i=1-g;else{if(i===f)return c?NaN:(w?-1:1)*(1/0);c=c+Math.pow(2,r),i=i-g}return(w?-1:1)*c*Math.pow(2,i-r)};ri.write=function(t,e,n,r,s,i){var c,h,f,g=i*8-s-1,u=(1<<g)-1,m=u>>1,d=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,w=r?0:i-1,E=r?1:-1,x=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(h=isNaN(e)?1:0,c=u):(c=Math.floor(Math.log(e)/Math.LN2),e*(f=Math.pow(2,-c))<1&&(c--,f*=2),c+m>=1?e+=d/f:e+=d*Math.pow(2,1-m),e*f>=2&&(c++,f/=2),c+m>=u?(h=0,c=u):c+m>=1?(h=(e*f-1)*Math.pow(2,s),c=c+m):(h=e*Math.pow(2,m-1)*Math.pow(2,s),c=0));s>=8;t[n+w]=h&255,w+=E,h/=256,s-=8);for(c=c<<s|h,g+=s;g>0;t[n+w]=c&255,w+=E,c/=256,g-=8);t[n+w-E]|=x*128};(function(t){const e=Zr,n=ri,r=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;t.Buffer=u,t.SlowBuffer=C,t.INSPECT_MAX_BYTES=50;const s=2147483647;t.kMaxLength=s;const{Uint8Array:i,ArrayBuffer:c,SharedArrayBuffer:h}=globalThis;u.TYPED_ARRAY_SUPPORT=f(),!u.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function f(){try{const l=new i(1),o={foo:function(){return 42}};return Object.setPrototypeOf(o,i.prototype),Object.setPrototypeOf(l,o),l.foo()===42}catch{return!1}}Object.defineProperty(u.prototype,"parent",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.buffer}}),Object.defineProperty(u.prototype,"offset",{enumerable:!0,get:function(){if(u.isBuffer(this))return this.byteOffset}});function g(l){if(l>s)throw new RangeError('The value "'+l+'" is invalid for option "size"');const o=new i(l);return Object.setPrototypeOf(o,u.prototype),o}function u(l,o,a){if(typeof l=="number"){if(typeof o=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return E(l)}return m(l,o,a)}u.poolSize=8192;function m(l,o,a){if(typeof l=="string")return x(l,o);if(c.isView(l))return O(l);if(l==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof l);if(je(l,c)||l&&je(l.buffer,c)||typeof h<"u"&&(je(l,h)||l&&je(l.buffer,h)))return re(l,o,a);if(typeof l=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');const p=l.valueOf&&l.valueOf();if(p!=null&&p!==l)return u.from(p,o,a);const y=V(l);if(y)return y;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof l[Symbol.toPrimitive]=="function")return u.from(l[Symbol.toPrimitive]("string"),o,a);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof l)}u.from=function(l,o,a){return m(l,o,a)},Object.setPrototypeOf(u.prototype,i.prototype),Object.setPrototypeOf(u,i);function d(l){if(typeof l!="number")throw new TypeError('"size" argument must be of type number');if(l<0)throw new RangeError('The value "'+l+'" is invalid for option "size"')}function w(l,o,a){return d(l),l<=0?g(l):o!==void 0?typeof a=="string"?g(l).fill(o,a):g(l).fill(o):g(l)}u.alloc=function(l,o,a){return w(l,o,a)};function E(l){return d(l),g(l<0?0:A(l)|0)}u.allocUnsafe=function(l){return E(l)},u.allocUnsafeSlow=function(l){return E(l)};function x(l,o){if((typeof o!="string"||o==="")&&(o="utf8"),!u.isEncoding(o))throw new TypeError("Unknown encoding: "+o);const a=X(l,o)|0;let p=g(a);const y=p.write(l,o);return y!==a&&(p=p.slice(0,y)),p}function D(l){const o=l.length<0?0:A(l.length)|0,a=g(o);for(let p=0;p<o;p+=1)a[p]=l[p]&255;return a}function O(l){if(je(l,i)){const o=new i(l);return re(o.buffer,o.byteOffset,o.byteLength)}return D(l)}function re(l,o,a){if(o<0||l.byteLength<o)throw new RangeError('"offset" is outside of buffer bounds');if(l.byteLength<o+(a||0))throw new RangeError('"length" is outside of buffer bounds');let p;return o===void 0&&a===void 0?p=new i(l):a===void 0?p=new i(l,o):p=new i(l,o,a),Object.setPrototypeOf(p,u.prototype),p}function V(l){if(u.isBuffer(l)){const o=A(l.length)|0,a=g(o);return a.length===0||l.copy(a,0,0,o),a}if(l.length!==void 0)return typeof l.length!="number"||Es(l.length)?g(0):D(l);if(l.type==="Buffer"&&Array.isArray(l.data))return D(l.data)}function A(l){if(l>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return l|0}function C(l){return+l!=l&&(l=0),u.alloc(+l)}u.isBuffer=function(o){return o!=null&&o._isBuffer===!0&&o!==u.prototype},u.compare=function(o,a){if(je(o,i)&&(o=u.from(o,o.offset,o.byteLength)),je(a,i)&&(a=u.from(a,a.offset,a.byteLength)),!u.isBuffer(o)||!u.isBuffer(a))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(o===a)return 0;let p=o.length,y=a.length;for(let b=0,k=Math.min(p,y);b<k;++b)if(o[b]!==a[b]){p=o[b],y=a[b];break}return p<y?-1:y<p?1:0},u.isEncoding=function(o){switch(String(o).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},u.concat=function(o,a){if(!Array.isArray(o))throw new TypeError('"list" argument must be an Array of Buffers');if(o.length===0)return u.alloc(0);let p;if(a===void 0)for(a=0,p=0;p<o.length;++p)a+=o[p].length;const y=u.allocUnsafe(a);let b=0;for(p=0;p<o.length;++p){let k=o[p];if(je(k,i))b+k.length>y.length?(u.isBuffer(k)||(k=u.from(k)),k.copy(y,b)):i.prototype.set.call(y,k,b);else if(u.isBuffer(k))k.copy(y,b);else throw new TypeError('"list" argument must be an Array of Buffers');b+=k.length}return y};function X(l,o){if(u.isBuffer(l))return l.length;if(c.isView(l)||je(l,c))return l.byteLength;if(typeof l!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof l);const a=l.length,p=arguments.length>2&&arguments[2]===!0;if(!p&&a===0)return 0;let y=!1;for(;;)switch(o){case"ascii":case"latin1":case"binary":return a;case"utf8":case"utf-8":return bs(l).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return a*2;case"hex":return a>>>1;case"base64":return Pi(l).length;default:if(y)return p?-1:bs(l).length;o=(""+o).toLowerCase(),y=!0}}u.byteLength=X;function _e(l,o,a){let p=!1;if((o===void 0||o<0)&&(o=0),o>this.length||((a===void 0||a>this.length)&&(a=this.length),a<=0)||(a>>>=0,o>>>=0,a<=o))return"";for(l||(l="utf8");;)switch(l){case"hex":return Ne(this,o,a);case"utf8":case"utf-8":return v(this,o,a);case"ascii":return ye(this,o,a);case"latin1":case"binary":return ue(this,o,a);case"base64":return J(this,o,a);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return j(this,o,a);default:if(p)throw new TypeError("Unknown encoding: "+l);l=(l+"").toLowerCase(),p=!0}}u.prototype._isBuffer=!0;function xe(l,o,a){const p=l[o];l[o]=l[a],l[a]=p}u.prototype.swap16=function(){const o=this.length;if(o%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let a=0;a<o;a+=2)xe(this,a,a+1);return this},u.prototype.swap32=function(){const o=this.length;if(o%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let a=0;a<o;a+=4)xe(this,a,a+3),xe(this,a+1,a+2);return this},u.prototype.swap64=function(){const o=this.length;if(o%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let a=0;a<o;a+=8)xe(this,a,a+7),xe(this,a+1,a+6),xe(this,a+2,a+5),xe(this,a+3,a+4);return this},u.prototype.toString=function(){const o=this.length;return o===0?"":arguments.length===0?v(this,0,o):_e.apply(this,arguments)},u.prototype.toLocaleString=u.prototype.toString,u.prototype.equals=function(o){if(!u.isBuffer(o))throw new TypeError("Argument must be a Buffer");return this===o?!0:u.compare(this,o)===0},u.prototype.inspect=function(){let o="";const a=t.INSPECT_MAX_BYTES;return o=this.toString("hex",0,a).replace(/(.{2})/g,"$1 ").trim(),this.length>a&&(o+=" ... "),"<Buffer "+o+">"},r&&(u.prototype[r]=u.prototype.inspect),u.prototype.compare=function(o,a,p,y,b){if(je(o,i)&&(o=u.from(o,o.offset,o.byteLength)),!u.isBuffer(o))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof o);if(a===void 0&&(a=0),p===void 0&&(p=o?o.length:0),y===void 0&&(y=0),b===void 0&&(b=this.length),a<0||p>o.length||y<0||b>this.length)throw new RangeError("out of range index");if(y>=b&&a>=p)return 0;if(y>=b)return-1;if(a>=p)return 1;if(a>>>=0,p>>>=0,y>>>=0,b>>>=0,this===o)return 0;let k=b-y,B=p-a;const ee=Math.min(k,B),K=this.slice(y,b),te=o.slice(a,p);for(let q=0;q<ee;++q)if(K[q]!==te[q]){k=K[q],B=te[q];break}return k<B?-1:B<k?1:0};function Pt(l,o,a,p,y){if(l.length===0)return-1;if(typeof a=="string"?(p=a,a=0):a>2147483647?a=2147483647:a<-2147483648&&(a=-2147483648),a=+a,Es(a)&&(a=y?0:l.length-1),a<0&&(a=l.length+a),a>=l.length){if(y)return-1;a=l.length-1}else if(a<0)if(y)a=0;else return-1;if(typeof o=="string"&&(o=u.from(o,p)),u.isBuffer(o))return o.length===0?-1:kt(l,o,a,p,y);if(typeof o=="number")return o=o&255,typeof i.prototype.indexOf=="function"?y?i.prototype.indexOf.call(l,o,a):i.prototype.lastIndexOf.call(l,o,a):kt(l,[o],a,p,y);throw new TypeError("val must be string, number or Buffer")}function kt(l,o,a,p,y){let b=1,k=l.length,B=o.length;if(p!==void 0&&(p=String(p).toLowerCase(),p==="ucs2"||p==="ucs-2"||p==="utf16le"||p==="utf-16le")){if(l.length<2||o.length<2)return-1;b=2,k/=2,B/=2,a/=2}function ee(te,q){return b===1?te[q]:te.readUInt16BE(q*b)}let K;if(y){let te=-1;for(K=a;K<k;K++)if(ee(l,K)===ee(o,te===-1?0:K-te)){if(te===-1&&(te=K),K-te+1===B)return te*b}else te!==-1&&(K-=K-te),te=-1}else for(a+B>k&&(a=k-B),K=a;K>=0;K--){let te=!0;for(let q=0;q<B;q++)if(ee(l,K+q)!==ee(o,q)){te=!1;break}if(te)return K}return-1}u.prototype.includes=function(o,a,p){return this.indexOf(o,a,p)!==-1},u.prototype.indexOf=function(o,a,p){return Pt(this,o,a,p,!0)},u.prototype.lastIndexOf=function(o,a,p){return Pt(this,o,a,p,!1)};function Vt(l,o,a,p){a=Number(a)||0;const y=l.length-a;p?(p=Number(p),p>y&&(p=y)):p=y;const b=o.length;p>b/2&&(p=b/2);let k;for(k=0;k<p;++k){const B=parseInt(o.substr(k*2,2),16);if(Es(B))return k;l[a+k]=B}return k}function _(l,o,a,p){return wr(bs(o,l.length-a),l,a,p)}function S(l,o,a,p){return wr(Ac(o),l,a,p)}function R(l,o,a,p){return wr(Pi(o),l,a,p)}function N(l,o,a,p){return wr(Sc(o,l.length-a),l,a,p)}u.prototype.write=function(o,a,p,y){if(a===void 0)y="utf8",p=this.length,a=0;else if(p===void 0&&typeof a=="string")y=a,p=this.length,a=0;else if(isFinite(a))a=a>>>0,isFinite(p)?(p=p>>>0,y===void 0&&(y="utf8")):(y=p,p=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");const b=this.length-a;if((p===void 0||p>b)&&(p=b),o.length>0&&(p<0||a<0)||a>this.length)throw new RangeError("Attempt to write outside buffer bounds");y||(y="utf8");let k=!1;for(;;)switch(y){case"hex":return Vt(this,o,a,p);case"utf8":case"utf-8":return _(this,o,a,p);case"ascii":case"latin1":case"binary":return S(this,o,a,p);case"base64":return R(this,o,a,p);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return N(this,o,a,p);default:if(k)throw new TypeError("Unknown encoding: "+y);y=(""+y).toLowerCase(),k=!0}},u.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function J(l,o,a){return o===0&&a===l.length?e.fromByteArray(l):e.fromByteArray(l.slice(o,a))}function v(l,o,a){a=Math.min(l.length,a);const p=[];let y=o;for(;y<a;){const b=l[y];let k=null,B=b>239?4:b>223?3:b>191?2:1;if(y+B<=a){let ee,K,te,q;switch(B){case 1:b<128&&(k=b);break;case 2:ee=l[y+1],(ee&192)===128&&(q=(b&31)<<6|ee&63,q>127&&(k=q));break;case 3:ee=l[y+1],K=l[y+2],(ee&192)===128&&(K&192)===128&&(q=(b&15)<<12|(ee&63)<<6|K&63,q>2047&&(q<55296||q>57343)&&(k=q));break;case 4:ee=l[y+1],K=l[y+2],te=l[y+3],(ee&192)===128&&(K&192)===128&&(te&192)===128&&(q=(b&15)<<18|(ee&63)<<12|(K&63)<<6|te&63,q>65535&&q<1114112&&(k=q))}}k===null?(k=65533,B=1):k>65535&&(k-=65536,p.push(k>>>10&1023|55296),k=56320|k&1023),p.push(k),y+=B}return Z(p)}const M=4096;function Z(l){const o=l.length;if(o<=M)return String.fromCharCode.apply(String,l);let a="",p=0;for(;p<o;)a+=String.fromCharCode.apply(String,l.slice(p,p+=M));return a}function ye(l,o,a){let p="";a=Math.min(l.length,a);for(let y=o;y<a;++y)p+=String.fromCharCode(l[y]&127);return p}function ue(l,o,a){let p="";a=Math.min(l.length,a);for(let y=o;y<a;++y)p+=String.fromCharCode(l[y]);return p}function Ne(l,o,a){const p=l.length;(!o||o<0)&&(o=0),(!a||a<0||a>p)&&(a=p);let y="";for(let b=o;b<a;++b)y+=vc[l[b]];return y}function j(l,o,a){const p=l.slice(o,a);let y="";for(let b=0;b<p.length-1;b+=2)y+=String.fromCharCode(p[b]+p[b+1]*256);return y}u.prototype.slice=function(o,a){const p=this.length;o=~~o,a=a===void 0?p:~~a,o<0?(o+=p,o<0&&(o=0)):o>p&&(o=p),a<0?(a+=p,a<0&&(a=0)):a>p&&(a=p),a<o&&(a=o);const y=this.subarray(o,a);return Object.setPrototypeOf(y,u.prototype),y};function F(l,o,a){if(l%1!==0||l<0)throw new RangeError("offset is not uint");if(l+o>a)throw new RangeError("Trying to access beyond buffer length")}u.prototype.readUintLE=u.prototype.readUIntLE=function(o,a,p){o=o>>>0,a=a>>>0,p||F(o,a,this.length);let y=this[o],b=1,k=0;for(;++k<a&&(b*=256);)y+=this[o+k]*b;return y},u.prototype.readUintBE=u.prototype.readUIntBE=function(o,a,p){o=o>>>0,a=a>>>0,p||F(o,a,this.length);let y=this[o+--a],b=1;for(;a>0&&(b*=256);)y+=this[o+--a]*b;return y},u.prototype.readUint8=u.prototype.readUInt8=function(o,a){return o=o>>>0,a||F(o,1,this.length),this[o]},u.prototype.readUint16LE=u.prototype.readUInt16LE=function(o,a){return o=o>>>0,a||F(o,2,this.length),this[o]|this[o+1]<<8},u.prototype.readUint16BE=u.prototype.readUInt16BE=function(o,a){return o=o>>>0,a||F(o,2,this.length),this[o]<<8|this[o+1]},u.prototype.readUint32LE=u.prototype.readUInt32LE=function(o,a){return o=o>>>0,a||F(o,4,this.length),(this[o]|this[o+1]<<8|this[o+2]<<16)+this[o+3]*16777216},u.prototype.readUint32BE=u.prototype.readUInt32BE=function(o,a){return o=o>>>0,a||F(o,4,this.length),this[o]*16777216+(this[o+1]<<16|this[o+2]<<8|this[o+3])},u.prototype.readBigUInt64LE=dt(function(o){o=o>>>0,jt(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&Cn(o,this.length-8);const y=a+this[++o]*2**8+this[++o]*2**16+this[++o]*2**24,b=this[++o]+this[++o]*2**8+this[++o]*2**16+p*2**24;return BigInt(y)+(BigInt(b)<<BigInt(32))}),u.prototype.readBigUInt64BE=dt(function(o){o=o>>>0,jt(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&Cn(o,this.length-8);const y=a*2**24+this[++o]*2**16+this[++o]*2**8+this[++o],b=this[++o]*2**24+this[++o]*2**16+this[++o]*2**8+p;return(BigInt(y)<<BigInt(32))+BigInt(b)}),u.prototype.readIntLE=function(o,a,p){o=o>>>0,a=a>>>0,p||F(o,a,this.length);let y=this[o],b=1,k=0;for(;++k<a&&(b*=256);)y+=this[o+k]*b;return b*=128,y>=b&&(y-=Math.pow(2,8*a)),y},u.prototype.readIntBE=function(o,a,p){o=o>>>0,a=a>>>0,p||F(o,a,this.length);let y=a,b=1,k=this[o+--y];for(;y>0&&(b*=256);)k+=this[o+--y]*b;return b*=128,k>=b&&(k-=Math.pow(2,8*a)),k},u.prototype.readInt8=function(o,a){return o=o>>>0,a||F(o,1,this.length),this[o]&128?(255-this[o]+1)*-1:this[o]},u.prototype.readInt16LE=function(o,a){o=o>>>0,a||F(o,2,this.length);const p=this[o]|this[o+1]<<8;return p&32768?p|4294901760:p},u.prototype.readInt16BE=function(o,a){o=o>>>0,a||F(o,2,this.length);const p=this[o+1]|this[o]<<8;return p&32768?p|4294901760:p},u.prototype.readInt32LE=function(o,a){return o=o>>>0,a||F(o,4,this.length),this[o]|this[o+1]<<8|this[o+2]<<16|this[o+3]<<24},u.prototype.readInt32BE=function(o,a){return o=o>>>0,a||F(o,4,this.length),this[o]<<24|this[o+1]<<16|this[o+2]<<8|this[o+3]},u.prototype.readBigInt64LE=dt(function(o){o=o>>>0,jt(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&Cn(o,this.length-8);const y=this[o+4]+this[o+5]*2**8+this[o+6]*2**16+(p<<24);return(BigInt(y)<<BigInt(32))+BigInt(a+this[++o]*2**8+this[++o]*2**16+this[++o]*2**24)}),u.prototype.readBigInt64BE=dt(function(o){o=o>>>0,jt(o,"offset");const a=this[o],p=this[o+7];(a===void 0||p===void 0)&&Cn(o,this.length-8);const y=(a<<24)+this[++o]*2**16+this[++o]*2**8+this[++o];return(BigInt(y)<<BigInt(32))+BigInt(this[++o]*2**24+this[++o]*2**16+this[++o]*2**8+p)}),u.prototype.readFloatLE=function(o,a){return o=o>>>0,a||F(o,4,this.length),n.read(this,o,!0,23,4)},u.prototype.readFloatBE=function(o,a){return o=o>>>0,a||F(o,4,this.length),n.read(this,o,!1,23,4)},u.prototype.readDoubleLE=function(o,a){return o=o>>>0,a||F(o,8,this.length),n.read(this,o,!0,52,8)},u.prototype.readDoubleBE=function(o,a){return o=o>>>0,a||F(o,8,this.length),n.read(this,o,!1,52,8)};function Y(l,o,a,p,y,b){if(!u.isBuffer(l))throw new TypeError('"buffer" argument must be a Buffer instance');if(o>y||o<b)throw new RangeError('"value" argument is out of bounds');if(a+p>l.length)throw new RangeError("Index out of range")}u.prototype.writeUintLE=u.prototype.writeUIntLE=function(o,a,p,y){if(o=+o,a=a>>>0,p=p>>>0,!y){const B=Math.pow(2,8*p)-1;Y(this,o,a,p,B,0)}let b=1,k=0;for(this[a]=o&255;++k<p&&(b*=256);)this[a+k]=o/b&255;return a+p},u.prototype.writeUintBE=u.prototype.writeUIntBE=function(o,a,p,y){if(o=+o,a=a>>>0,p=p>>>0,!y){const B=Math.pow(2,8*p)-1;Y(this,o,a,p,B,0)}let b=p-1,k=1;for(this[a+b]=o&255;--b>=0&&(k*=256);)this[a+b]=o/k&255;return a+p},u.prototype.writeUint8=u.prototype.writeUInt8=function(o,a,p){return o=+o,a=a>>>0,p||Y(this,o,a,1,255,0),this[a]=o&255,a+1},u.prototype.writeUint16LE=u.prototype.writeUInt16LE=function(o,a,p){return o=+o,a=a>>>0,p||Y(this,o,a,2,65535,0),this[a]=o&255,this[a+1]=o>>>8,a+2},u.prototype.writeUint16BE=u.prototype.writeUInt16BE=function(o,a,p){return o=+o,a=a>>>0,p||Y(this,o,a,2,65535,0),this[a]=o>>>8,this[a+1]=o&255,a+2},u.prototype.writeUint32LE=u.prototype.writeUInt32LE=function(o,a,p){return o=+o,a=a>>>0,p||Y(this,o,a,4,4294967295,0),this[a+3]=o>>>24,this[a+2]=o>>>16,this[a+1]=o>>>8,this[a]=o&255,a+4},u.prototype.writeUint32BE=u.prototype.writeUInt32BE=function(o,a,p){return o=+o,a=a>>>0,p||Y(this,o,a,4,4294967295,0),this[a]=o>>>24,this[a+1]=o>>>16,this[a+2]=o>>>8,this[a+3]=o&255,a+4};function Q(l,o,a,p,y){$i(o,p,y,l,a,7);let b=Number(o&BigInt(4294967295));l[a++]=b,b=b>>8,l[a++]=b,b=b>>8,l[a++]=b,b=b>>8,l[a++]=b;let k=Number(o>>BigInt(32)&BigInt(4294967295));return l[a++]=k,k=k>>8,l[a++]=k,k=k>>8,l[a++]=k,k=k>>8,l[a++]=k,a}function oe(l,o,a,p,y){$i(o,p,y,l,a,7);let b=Number(o&BigInt(4294967295));l[a+7]=b,b=b>>8,l[a+6]=b,b=b>>8,l[a+5]=b,b=b>>8,l[a+4]=b;let k=Number(o>>BigInt(32)&BigInt(4294967295));return l[a+3]=k,k=k>>8,l[a+2]=k,k=k>>8,l[a+1]=k,k=k>>8,l[a]=k,a+8}u.prototype.writeBigUInt64LE=dt(function(o,a=0){return Q(this,o,a,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeBigUInt64BE=dt(function(o,a=0){return oe(this,o,a,BigInt(0),BigInt("0xffffffffffffffff"))}),u.prototype.writeIntLE=function(o,a,p,y){if(o=+o,a=a>>>0,!y){const ee=Math.pow(2,8*p-1);Y(this,o,a,p,ee-1,-ee)}let b=0,k=1,B=0;for(this[a]=o&255;++b<p&&(k*=256);)o<0&&B===0&&this[a+b-1]!==0&&(B=1),this[a+b]=(o/k>>0)-B&255;return a+p},u.prototype.writeIntBE=function(o,a,p,y){if(o=+o,a=a>>>0,!y){const ee=Math.pow(2,8*p-1);Y(this,o,a,p,ee-1,-ee)}let b=p-1,k=1,B=0;for(this[a+b]=o&255;--b>=0&&(k*=256);)o<0&&B===0&&this[a+b+1]!==0&&(B=1),this[a+b]=(o/k>>0)-B&255;return a+p},u.prototype.writeInt8=function(o,a,p){return o=+o,a=a>>>0,p||Y(this,o,a,1,127,-128),o<0&&(o=255+o+1),this[a]=o&255,a+1},u.prototype.writeInt16LE=function(o,a,p){return o=+o,a=a>>>0,p||Y(this,o,a,2,32767,-32768),this[a]=o&255,this[a+1]=o>>>8,a+2},u.prototype.writeInt16BE=function(o,a,p){return o=+o,a=a>>>0,p||Y(this,o,a,2,32767,-32768),this[a]=o>>>8,this[a+1]=o&255,a+2},u.prototype.writeInt32LE=function(o,a,p){return o=+o,a=a>>>0,p||Y(this,o,a,4,2147483647,-2147483648),this[a]=o&255,this[a+1]=o>>>8,this[a+2]=o>>>16,this[a+3]=o>>>24,a+4},u.prototype.writeInt32BE=function(o,a,p){return o=+o,a=a>>>0,p||Y(this,o,a,4,2147483647,-2147483648),o<0&&(o=4294967295+o+1),this[a]=o>>>24,this[a+1]=o>>>16,this[a+2]=o>>>8,this[a+3]=o&255,a+4},u.prototype.writeBigInt64LE=dt(function(o,a=0){return Q(this,o,a,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))}),u.prototype.writeBigInt64BE=dt(function(o,a=0){return oe(this,o,a,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function ae(l,o,a,p,y,b){if(a+p>l.length)throw new RangeError("Index out of range");if(a<0)throw new RangeError("Index out of range")}function he(l,o,a,p,y){return o=+o,a=a>>>0,y||ae(l,o,a,4),n.write(l,o,a,p,23,4),a+4}u.prototype.writeFloatLE=function(o,a,p){return he(this,o,a,!0,p)},u.prototype.writeFloatBE=function(o,a,p){return he(this,o,a,!1,p)};function De(l,o,a,p,y){return o=+o,a=a>>>0,y||ae(l,o,a,8),n.write(l,o,a,p,52,8),a+8}u.prototype.writeDoubleLE=function(o,a,p){return De(this,o,a,!0,p)},u.prototype.writeDoubleBE=function(o,a,p){return De(this,o,a,!1,p)},u.prototype.copy=function(o,a,p,y){if(!u.isBuffer(o))throw new TypeError("argument should be a Buffer");if(p||(p=0),!y&&y!==0&&(y=this.length),a>=o.length&&(a=o.length),a||(a=0),y>0&&y<p&&(y=p),y===p||o.length===0||this.length===0)return 0;if(a<0)throw new RangeError("targetStart out of bounds");if(p<0||p>=this.length)throw new RangeError("Index out of range");if(y<0)throw new RangeError("sourceEnd out of bounds");y>this.length&&(y=this.length),o.length-a<y-p&&(y=o.length-a+p);const b=y-p;return this===o&&typeof i.prototype.copyWithin=="function"?this.copyWithin(a,p,y):i.prototype.set.call(o,this.subarray(p,y),a),b},u.prototype.fill=function(o,a,p,y){if(typeof o=="string"){if(typeof a=="string"?(y=a,a=0,p=this.length):typeof p=="string"&&(y=p,p=this.length),y!==void 0&&typeof y!="string")throw new TypeError("encoding must be a string");if(typeof y=="string"&&!u.isEncoding(y))throw new TypeError("Unknown encoding: "+y);if(o.length===1){const k=o.charCodeAt(0);(y==="utf8"&&k<128||y==="latin1")&&(o=k)}}else typeof o=="number"?o=o&255:typeof o=="boolean"&&(o=Number(o));if(a<0||this.length<a||this.length<p)throw new RangeError("Out of range index");if(p<=a)return this;a=a>>>0,p=p===void 0?this.length:p>>>0,o||(o=0);let b;if(typeof o=="number")for(b=a;b<p;++b)this[b]=o;else{const k=u.isBuffer(o)?o:u.from(o,y),B=k.length;if(B===0)throw new TypeError('The value "'+o+'" is invalid for argument "value"');for(b=0;b<p-a;++b)this[b+a]=k[b%B]}return this};const be={};function ve(l,o,a){be[l]=class extends a{constructor(){super(),Object.defineProperty(this,"message",{value:o.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${l}]`,this.stack,delete this.name}get code(){return l}set code(y){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:y,writable:!0})}toString(){return`${this.name} [${l}]: ${this.message}`}}}ve("ERR_BUFFER_OUT_OF_BOUNDS",function(l){return l?`${l} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError),ve("ERR_INVALID_ARG_TYPE",function(l,o){return`The "${l}" argument must be of type number. Received type ${typeof o}`},TypeError),ve("ERR_OUT_OF_RANGE",function(l,o,a){let p=`The value of "${l}" is out of range.`,y=a;return Number.isInteger(a)&&Math.abs(a)>2**32?y=gr(String(a)):typeof a=="bigint"&&(y=String(a),(a>BigInt(2)**BigInt(32)||a<-(BigInt(2)**BigInt(32)))&&(y=gr(y)),y+="n"),p+=` It must be ${o}. Received ${y}`,p},RangeError);function gr(l){let o="",a=l.length;const p=l[0]==="-"?1:0;for(;a>=p+4;a-=3)o=`_${l.slice(a-3,a)}${o}`;return`${l.slice(0,a)}${o}`}function mr(l,o,a){jt(o,"offset"),(l[o]===void 0||l[o+a]===void 0)&&Cn(o,l.length-(a+1))}function $i(l,o,a,p,y,b){if(l>a||l<o){const k=typeof o=="bigint"?"n":"";let B;throw o===0||o===BigInt(0)?B=`>= 0${k} and < 2${k} ** ${(b+1)*8}${k}`:B=`>= -(2${k} ** ${(b+1)*8-1}${k}) and < 2 ** ${(b+1)*8-1}${k}`,new be.ERR_OUT_OF_RANGE("value",B,l)}mr(p,y,b)}function jt(l,o){if(typeof l!="number")throw new be.ERR_INVALID_ARG_TYPE(o,"number",l)}function Cn(l,o,a){throw Math.floor(l)!==l?(jt(l,a),new be.ERR_OUT_OF_RANGE("offset","an integer",l)):o<0?new be.ERR_BUFFER_OUT_OF_BOUNDS:new be.ERR_OUT_OF_RANGE("offset",`>= 0 and <= ${o}`,l)}const _c=/[^+/0-9A-Za-z-_]/g;function xc(l){if(l=l.split("=")[0],l=l.trim().replace(_c,""),l.length<2)return"";for(;l.length%4!==0;)l=l+"=";return l}function bs(l,o){o=o||1/0;let a;const p=l.length;let y=null;const b=[];for(let k=0;k<p;++k){if(a=l.charCodeAt(k),a>55295&&a<57344){if(!y){if(a>56319){(o-=3)>-1&&b.push(239,191,189);continue}else if(k+1===p){(o-=3)>-1&&b.push(239,191,189);continue}y=a;continue}if(a<56320){(o-=3)>-1&&b.push(239,191,189),y=a;continue}a=(y-55296<<10|a-56320)+65536}else y&&(o-=3)>-1&&b.push(239,191,189);if(y=null,a<128){if((o-=1)<0)break;b.push(a)}else if(a<2048){if((o-=2)<0)break;b.push(a>>6|192,a&63|128)}else if(a<65536){if((o-=3)<0)break;b.push(a>>12|224,a>>6&63|128,a&63|128)}else if(a<1114112){if((o-=4)<0)break;b.push(a>>18|240,a>>12&63|128,a>>6&63|128,a&63|128)}else throw new Error("Invalid code point")}return b}function Ac(l){const o=[];for(let a=0;a<l.length;++a)o.push(l.charCodeAt(a)&255);return o}function Sc(l,o){let a,p,y;const b=[];for(let k=0;k<l.length&&!((o-=2)<0);++k)a=l.charCodeAt(k),p=a>>8,y=a%256,b.push(y),b.push(p);return b}function Pi(l){return e.toByteArray(xc(l))}function wr(l,o,a,p){let y;for(y=0;y<p&&!(y+a>=o.length||y>=l.length);++y)o[y+a]=l[y];return y}function je(l,o){return l instanceof o||l!=null&&l.constructor!=null&&l.constructor.name!=null&&l.constructor.name===o.name}function Es(l){return l!==l}const vc=(function(){const l="0123456789abcdef",o=new Array(256);for(let a=0;a<16;++a){const p=a*16;for(let y=0;y<16;++y)o[p+y]=l[a]+l[y]}return o})();function dt(l){return typeof BigInt>"u"?Ic:l}function Ic(){throw new Error("BigInt not supported")}})(Fc);const Ae=()=>new Map,Vs=t=>{const e=Ae();return t.forEach((n,r)=>{e.set(r,n)}),e},lt=(t,e,n)=>{let r=t.get(e);return r===void 0&&t.set(e,r=n()),r},zc=(t,e)=>{const n=[];for(const[r,s]of t)n.push(e(s,r));return n},Yc=(t,e)=>{for(const[n,r]of t)if(e(r,n))return!0;return!1},Mt=()=>new Set,As=t=>t[t.length-1],Wc=(t,e)=>{for(let n=0;n<e.length;n++)t.push(e[n])},yt=Array.from,si=(t,e)=>{for(let n=0;n<t.length;n++)if(!e(t[n],n,t))return!1;return!0},Po=(t,e)=>{for(let n=0;n<t.length;n++)if(e(t[n],n,t))return!0;return!1},Kc=(t,e)=>{const n=new Array(t);for(let r=0;r<t;r++)n[r]=e(r,n);return n},Qr=Array.isArray;class Xc{constructor(){this._observers=Ae()}on(e,n){return lt(this._observers,e,Mt).add(n),n}once(e,n){const r=(...s)=>{this.off(e,r),n(...s)};this.on(e,r)}off(e,n){const r=this._observers.get(e);r!==void 0&&(r.delete(n),r.size===0&&this._observers.delete(e))}emit(e,n){return yt((this._observers.get(e)||Ae()).values()).forEach(r=>r(...n))}destroy(){this._observers=Ae()}}class Zc{constructor(){this._observers=Ae()}on(e,n){lt(this._observers,e,Mt).add(n)}once(e,n){const r=(...s)=>{this.off(e,r),n(...s)};this.on(e,r)}off(e,n){const r=this._observers.get(e);r!==void 0&&(r.delete(n),r.size===0&&this._observers.delete(e))}emit(e,n){return yt((this._observers.get(e)||Ae()).values()).forEach(r=>r(...n))}destroy(){this._observers=Ae()}}const Ke=Math.floor,Ir=Math.abs,Vo=(t,e)=>t<e?t:e,Bt=(t,e)=>t>e?t:e,jo=t=>t!==0?t<0:1/t<0,ji=1,Hi=2,Ss=4,vs=8,Vn=32,it=64,Te=128,es=31,js=63,Tt=127,Qc=2147483647,Fr=Number.MAX_SAFE_INTEGER,qi=Number.MIN_SAFE_INTEGER,el=Number.isInteger||(t=>typeof t=="number"&&isFinite(t)&&Ke(t)===t),tl=String.fromCharCode,nl=t=>t.toLowerCase(),rl=/^\s*/g,sl=t=>t.replace(rl,""),il=/([A-Z])/g,Gi=(t,e)=>sl(t.replace(il,n=>`${e}${nl(n)}`)),ol=t=>{const e=unescape(encodeURIComponent(t)),n=e.length,r=new Uint8Array(n);for(let s=0;s<n;s++)r[s]=e.codePointAt(s);return r},jn=typeof TextEncoder<"u"?new TextEncoder:null,al=t=>jn.encode(t),cl=jn?al:ol;let Fn=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});Fn&&Fn.decode(new Uint8Array).length===1&&(Fn=null);const ll=(t,e)=>Kc(e,()=>t).join("");class cr{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const ts=()=>new cr,ul=t=>{let e=t.cpos;for(let n=0;n<t.bufs.length;n++)e+=t.bufs[n].length;return e},Ye=t=>{const e=new Uint8Array(ul(t));let n=0;for(let r=0;r<t.bufs.length;r++){const s=t.bufs[r];e.set(s,n),n+=s.length}return e.set(new Uint8Array(t.cbuf.buffer,0,t.cpos),n),e},hl=(t,e)=>{const n=t.cbuf.length;n-t.cpos<e&&(t.bufs.push(new Uint8Array(t.cbuf.buffer,0,t.cpos)),t.cbuf=new Uint8Array(Bt(n,e)*2),t.cpos=0)},de=(t,e)=>{const n=t.cbuf.length;t.cpos===n&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(n*2),t.cpos=0),t.cbuf[t.cpos++]=e},Hs=de,$=(t,e)=>{for(;e>Tt;)de(t,Te|Tt&e),e=Ke(e/128);de(t,Tt&e)},ii=(t,e)=>{const n=jo(e);for(n&&(e=-e),de(t,(e>js?Te:0)|(n?it:0)|js&e),e=Ke(e/64);e>0;)de(t,(e>Tt?Te:0)|Tt&e),e=Ke(e/128)},qs=new Uint8Array(3e4),fl=qs.length/3,dl=(t,e)=>{if(e.length<fl){const n=jn.encodeInto(e,qs).written||0;$(t,n);for(let r=0;r<n;r++)de(t,qs[r])}else Ie(t,cl(e))},pl=(t,e)=>{const n=unescape(encodeURIComponent(e)),r=n.length;$(t,r);for(let s=0;s<r;s++)de(t,n.codePointAt(s))},Qt=jn&&jn.encodeInto?dl:pl,ns=(t,e)=>{const n=t.cbuf.length,r=t.cpos,s=Vo(n-r,e.length),i=e.length-s;t.cbuf.set(e.subarray(0,s),r),t.cpos+=s,i>0&&(t.bufs.push(t.cbuf),t.cbuf=new Uint8Array(Bt(n*2,i)),t.cbuf.set(e.subarray(s)),t.cpos=i)},Ie=(t,e)=>{$(t,e.byteLength),ns(t,e)},oi=(t,e)=>{hl(t,e);const n=new DataView(t.cbuf.buffer,t.cpos,e);return t.cpos+=e,n},gl=(t,e)=>oi(t,4).setFloat32(0,e,!1),ml=(t,e)=>oi(t,8).setFloat64(0,e,!1),wl=(t,e)=>oi(t,8).setBigInt64(0,e,!1),Ji=new DataView(new ArrayBuffer(4)),yl=t=>(Ji.setFloat32(0,t),Ji.getFloat32(0)===t),Hn=(t,e)=>{switch(typeof e){case"string":de(t,119),Qt(t,e);break;case"number":el(e)&&Ir(e)<=Qc?(de(t,125),ii(t,e)):yl(e)?(de(t,124),gl(t,e)):(de(t,123),ml(t,e));break;case"bigint":de(t,122),wl(t,e);break;case"object":if(e===null)de(t,126);else if(Qr(e)){de(t,117),$(t,e.length);for(let n=0;n<e.length;n++)Hn(t,e[n])}else if(e instanceof Uint8Array)de(t,116),Ie(t,e);else{de(t,118);const n=Object.keys(e);$(t,n.length);for(let r=0;r<n.length;r++){const s=n[r];Qt(t,s),Hn(t,e[s])}}break;case"boolean":de(t,e?120:121);break;default:de(t,127)}};class zi extends cr{constructor(e){super(),this.w=e,this.s=null,this.count=0}write(e){this.s===e?this.count++:(this.count>0&&$(this,this.count-1),this.count=1,this.w(this,e),this.s=e)}}const Yi=t=>{t.count>0&&(ii(t.encoder,t.count===1?t.s:-t.s),t.count>1&&$(t.encoder,t.count-2))};class Cr{constructor(){this.encoder=new cr,this.s=0,this.count=0}write(e){this.s===e?this.count++:(Yi(this),this.count=1,this.s=e)}toUint8Array(){return Yi(this),Ye(this.encoder)}}const Wi=t=>{if(t.count>0){const e=t.diff*2+(t.count===1?0:1);ii(t.encoder,e),t.count>1&&$(t.encoder,t.count-2)}};class Is{constructor(){this.encoder=new cr,this.s=0,this.count=0,this.diff=0}write(e){this.diff===e-this.s?(this.s=e,this.count++):(Wi(this),this.count=1,this.diff=e-this.s,this.s=e)}toUint8Array(){return Wi(this),Ye(this.encoder)}}class bl{constructor(){this.sarr=[],this.s="",this.lensE=new Cr}write(e){this.s+=e,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(e.length)}toUint8Array(){const e=new cr;return this.sarr.push(this.s),this.s="",Qt(e,this.sarr.join("")),ns(e,this.lensE.toUint8Array()),Ye(e)}}const Ve=t=>new Error(t),$e=()=>{throw Ve("Method unimplemented")},Le=()=>{throw Ve("Unexpected case")},Ho=Ve("Unexpected end of array"),qo=Ve("Integer out of Range");class rs{constructor(e){this.arr=e,this.pos=0}}const bn=t=>new rs(t),El=t=>t.pos!==t.arr.length,kl=(t,e)=>{const n=new Uint8Array(t.arr.buffer,t.pos+t.arr.byteOffset,e);return t.pos+=e,n},Ce=t=>kl(t,U(t)),cn=t=>t.arr[t.pos++],U=t=>{let e=0,n=1;const r=t.arr.length;for(;t.pos<r;){const s=t.arr[t.pos++];if(e=e+(s&Tt)*n,n*=128,s<Te)return e;if(e>Fr)throw qo}throw Ho},ai=t=>{let e=t.arr[t.pos++],n=e&js,r=64;const s=(e&it)>0?-1:1;if((e&Te)===0)return s*n;const i=t.arr.length;for(;t.pos<i;){if(e=t.arr[t.pos++],n=n+(e&Tt)*r,r*=128,e<Te)return s*n;if(n>Fr)throw qo}throw Ho},_l=t=>{let e=U(t);if(e===0)return"";{let n=String.fromCodePoint(cn(t));if(--e<100)for(;e--;)n+=String.fromCodePoint(cn(t));else for(;e>0;){const r=e<1e4?e:1e4,s=t.arr.subarray(t.pos,t.pos+r);t.pos+=r,n+=String.fromCodePoint.apply(null,s),e-=r}return decodeURIComponent(escape(n))}},xl=t=>Fn.decode(Ce(t)),en=Fn?xl:_l,ci=(t,e)=>{const n=new DataView(t.arr.buffer,t.arr.byteOffset+t.pos,e);return t.pos+=e,n},Al=t=>ci(t,4).getFloat32(0,!1),Sl=t=>ci(t,8).getFloat64(0,!1),vl=t=>ci(t,8).getBigInt64(0,!1),Il=[t=>{},t=>null,ai,Al,Sl,vl,t=>!1,t=>!0,en,t=>{const e=U(t),n={};for(let r=0;r<e;r++){const s=en(t);n[s]=qn(t)}return n},t=>{const e=U(t),n=[];for(let r=0;r<e;r++)n.push(qn(t));return n},Ce],qn=t=>Il[127-cn(t)](t);class Ki extends rs{constructor(e,n){super(e),this.reader=n,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),El(this)?this.count=U(this)+1:this.count=-1),this.count--,this.s}}class Tr extends rs{constructor(e){super(e),this.s=0,this.count=0}read(){if(this.count===0){this.s=ai(this);const e=jo(this.s);this.count=1,e&&(this.s=-this.s,this.count=U(this)+2)}return this.count--,this.s}}class Cs extends rs{constructor(e){super(e),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const e=ai(this),n=e&1;this.diff=Ke(e/2),this.count=1,n&&(this.count=U(this)+2)}return this.s+=this.diff,this.count--,this.s}}class Cl{constructor(e){this.decoder=new Tr(e),this.str=en(this.decoder),this.spos=0}read(){const e=this.spos+this.decoder.read(),n=this.str.slice(this.spos,e);return this.spos=e,n}}const Tl=crypto.getRandomValues.bind(crypto),Go=()=>Tl(new Uint32Array(1))[0],Ml="10000000-1000-4000-8000"+-1e11,Dl=()=>Ml.replace(/[018]/g,t=>(t^Go()&15>>t/4).toString(16)),ln=t=>new Promise(t);Promise.all.bind(Promise);const Xi=t=>t===void 0?null:t;class Ol{constructor(){this.map=new Map}setItem(e,n){this.map.set(e,n)}getItem(e){return this.map.get(e)}}let Jo=new Ol,Rl=!0;try{typeof localStorage<"u"&&localStorage&&(Jo=localStorage,Rl=!1)}catch{}const Ul=Jo,Gn=Symbol("Equality"),zo=(t,e)=>t===e||!!t?.[Gn]?.(e)||!1,Bl=t=>typeof t=="object",Ll=Object.assign,Nl=Object.keys,Fl=(t,e)=>{for(const n in t)e(t[n],n)},$r=t=>Nl(t).length,$l=t=>{for(const e in t)return!1;return!0},lr=(t,e)=>{for(const n in t)if(!e(t[n],n))return!1;return!0},li=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),Pl=(t,e)=>t===e||$r(t)===$r(e)&&lr(t,(n,r)=>(n!==void 0||li(e,r))&&zo(e[r],n)),Vl=Object.freeze,Yo=t=>{for(const e in t){const n=t[e];(typeof n=="object"||typeof n=="function")&&Yo(t[e])}return Vl(t)},ui=(t,e,n=0)=>{try{for(;n<t.length;n++)t[n](...e)}finally{n<t.length&&ui(t,e,n+1)}},jl=t=>t,Mr=(t,e)=>{if(t===e)return!0;if(t==null||e==null||t.constructor!==e.constructor&&(t.constructor||Object)!==(e.constructor||Object))return!1;if(t[Gn]!=null)return t[Gn](e);switch(t.constructor){case ArrayBuffer:t=new Uint8Array(t),e=new Uint8Array(e);case Uint8Array:{if(t.byteLength!==e.byteLength)return!1;for(let n=0;n<t.length;n++)if(t[n]!==e[n])return!1;break}case Set:{if(t.size!==e.size)return!1;for(const n of t)if(!e.has(n))return!1;break}case Map:{if(t.size!==e.size)return!1;for(const n of t.keys())if(!e.has(n)||!Mr(t.get(n),e.get(n)))return!1;break}case void 0:case Object:if($r(t)!==$r(e))return!1;for(const n in t)if(!li(t,n)||!Mr(t[n],e[n]))return!1;break;case Array:if(t.length!==e.length)return!1;for(let n=0;n<t.length;n++)if(!Mr(t[n],e[n]))return!1;break;default:return!1}return!0},Hl=(t,e)=>e.includes(t);var Wo={};const Jn=typeof xt<"u"&&xt.release&&/node|io\.js/.test(xt.release.name)&&Object.prototype.toString.call(typeof xt<"u"?xt:0)==="[object process]";let He;const ql=()=>{if(He===void 0)if(Jn){He=Ae();const t=xt.argv;let e=null;for(let n=0;n<t.length;n++){const r=t[n];r[0]==="-"?(e!==null&&He.set(e,""),e=r):e!==null&&(He.set(e,r),e=null)}e!==null&&He.set(e,"")}else typeof location=="object"?(He=Ae(),(location.search||"?").slice(1).split("&").forEach(t=>{if(t.length!==0){const[e,n]=t.split("=");He.set(`--${Gi(e,"-")}`,n),He.set(`-${Gi(e,"-")}`,n)}})):He=Ae();return He},Gs=t=>ql().has(t),Pr=t=>Xi(Jn?Wo[t.toUpperCase().replaceAll("-","_")]:Ul.getItem(t)),Ko=t=>Gs("--"+t)||Pr(t)!==null,Gl=Ko("production"),Jl=Jn&&Hl(Wo.FORCE_COLOR,["true","1","2"]),zl=Jl||!Gs("--no-colors")&&!Ko("no-color")&&(!Jn||xt.stdout.isTTY)&&(!Jn||Gs("--color")||Pr("COLORTERM")!==null||(Pr("TERM")||"").includes("color")),Yl=t=>new Uint8Array(t),Wl=t=>{const e=Yl(t.byteLength);return e.set(t),e};class Kl{constructor(e,n){this.left=e,this.right=n}}const Qe=(t,e)=>new Kl(t,e),Zi=t=>t.next()>=.5,Ts=(t,e,n)=>Ke(t.next()*(n+1-e)+e),Xo=(t,e,n)=>Ke(t.next()*(n+1-e)+e),hi=(t,e,n)=>Xo(t,e,n),Xl=t=>tl(hi(t,97,122)),Zl=(t,e=0,n=20)=>{const r=hi(t,e,n);let s="";for(let i=0;i<r;i++)s+=Xl(t);return s},Ms=(t,e)=>e[hi(t,0,e.length-1)],Ql=Symbol("0schema");class eu{constructor(){this._rerrs=[]}extend(e,n,r,s=null){this._rerrs.push({path:e,expected:n,has:r,message:s})}toString(){const e=[];for(let n=this._rerrs.length-1;n>0;n--){const r=this._rerrs[n];e.push(ll(" ",(this._rerrs.length-n)*2)+`${r.path!=null?`[${r.path}] `:""}${r.has} doesn't match ${r.expected}. ${r.message}`)}return e.join(`
`)}}const Js=(t,e)=>t===e?!0:t==null||e==null||t.constructor!==e.constructor?!1:t[Gn]?zo(t,e):Qr(t)?si(t,n=>Po(e,r=>Js(n,r))):Bl(t)?lr(t,(n,r)=>Js(n,e[r])):!1;class ke{static _dilutes=!1;extends(e){let[n,r]=[this.shape,e.shape];return this.constructor._dilutes&&([r,n]=[n,r]),Js(n,r)}equals(e){return this.constructor===e.constructor&&Mr(this.shape,e.shape)}[Ql](){return!0}[Gn](e){return this.equals(e)}validate(e){return this.check(e)}check(e,n){$e()}get nullable(){return En(this,cs)}get optional(){return new ea(this)}cast(e){return Qi(e,this),e}expect(e){return Qi(e,this),e}}class fi extends ke{constructor(e,n){super(),this.shape=e,this._c=n}check(e,n=void 0){const r=e?.constructor===this.shape&&(this._c==null||this._c(e));return!r&&n?.extend(null,this.shape.name,e?.constructor.name,e?.constructor!==this.shape?"Constructor match failed":"Check failed"),r}}const ie=(t,e=null)=>new fi(t,e);ie(fi);class di extends ke{constructor(e){super(),this.shape=e}check(e,n){const r=this.shape(e);return!r&&n?.extend(null,"custom prop",e?.constructor.name,"failed to check custom prop"),r}}const me=t=>new di(t);ie(di);class ss extends ke{constructor(e){super(),this.shape=e}check(e,n){const r=this.shape.some(s=>s===e);return!r&&n?.extend(null,this.shape.join(" | "),e.toString()),r}}const is=(...t)=>new ss(t),Zo=ie(ss),tu=RegExp.escape||(t=>t.replace(/[().|&,$^[\]]/g,e=>"\\"+e)),Qo=t=>{if(un.check(t))return[tu(t)];if(Zo.check(t))return t.shape.map(e=>e+"");if(la.check(t))return["[+-]?\\d+.?\\d*"];if(ua.check(t))return[".*"];if(Vr.check(t))return t.shape.map(Qo).flat(1);Le()};class nu extends ke{constructor(e){super(),this.shape=e,this._r=new RegExp("^"+e.map(Qo).map(n=>`(${n.join("|")})`).join("")+"$")}check(e,n){const r=this._r.exec(e)!=null;return!r&&n?.extend(null,this._r.toString(),e.toString(),"String doesn't match string template."),r}}ie(nu);const ru=Symbol("optional");class ea extends ke{constructor(e){super(),this.shape=e}check(e,n){const r=e===void 0||this.shape.check(e);return!r&&n?.extend(null,"undefined (optional)","()"),r}get[ru](){return!0}}const su=ie(ea);class iu extends ke{check(e,n){return n?.extend(null,"never",typeof e),!1}}ie(iu);class os extends ke{constructor(e,n=!1){super(),this.shape=e,this._isPartial=n}static _dilutes=!0;get partial(){return new os(this.shape,!0)}check(e,n){return e==null?(n?.extend(null,"object","null"),!1):lr(this.shape,(r,s)=>{const i=this._isPartial&&!li(e,s)||r.check(e[s],n);return!i&&n?.extend(s.toString(),r.toString(),typeof e[s],"Object property does not match"),i})}}const ou=t=>new os(t),au=ie(os),cu=me(t=>t!=null&&(t.constructor===Object||t.constructor==null));class ta extends ke{constructor(e,n){super(),this.shape={keys:e,values:n}}check(e,n){return e!=null&&lr(e,(r,s)=>{const i=this.shape.keys.check(s,n);return!i&&n?.extend(s+"","Record",typeof e,i?"Key doesn't match schema":"Value doesn't match value"),i&&this.shape.values.check(r,n)})}}const na=(t,e)=>new ta(t,e),lu=ie(ta);class ra extends ke{constructor(e){super(),this.shape=e}check(e,n){return e!=null&&lr(this.shape,(r,s)=>{const i=r.check(e[s],n);return!i&&n?.extend(s.toString(),"Tuple",typeof r),i})}}const uu=(...t)=>new ra(t);ie(ra);class sa extends ke{constructor(e){super(),this.shape=e.length===1?e[0]:new pi(e)}check(e,n){const r=Qr(e)&&si(e,s=>this.shape.check(s));return!r&&n?.extend(null,"Array",""),r}}const ia=(...t)=>new sa(t),hu=ie(sa),fu=me(t=>Qr(t));class oa extends ke{constructor(e,n){super(),this.shape=e,this._c=n}check(e,n){const r=e instanceof this.shape&&(this._c==null||this._c(e));return!r&&n?.extend(null,this.shape.name,e?.constructor.name),r}}const du=(t,e=null)=>new oa(t,e);ie(oa);const pu=du(ke);class gu extends ke{constructor(e){super(),this.len=e.length-1,this.args=uu(...e.slice(-1)),this.res=e[this.len]}check(e,n){const r=e.constructor===Function&&e.length<=this.len;return!r&&n?.extend(null,"function",typeof e),r}}const mu=ie(gu),wu=me(t=>typeof t=="function");class yu extends ke{constructor(e){super(),this.shape=e}check(e,n){const r=si(this.shape,s=>s.check(e,n));return!r&&n?.extend(null,"Intersectinon",typeof e),r}}ie(yu,t=>t.shape.length>0);class pi extends ke{static _dilutes=!0;constructor(e){super(),this.shape=e}check(e,n){const r=Po(this.shape,s=>s.check(e,n));return n?.extend(null,"Union",typeof e),r}}const En=(...t)=>t.findIndex(e=>Vr.check(e))>=0?En(...t.map(e=>zn(e)).map(e=>Vr.check(e)?e.shape:[e]).flat(1)):t.length===1?t[0]:new pi(t),Vr=ie(pi),aa=()=>!0,jr=me(aa),bu=ie(di,t=>t.shape===aa),gi=me(t=>typeof t=="bigint"),Eu=me(t=>t===gi),ca=me(t=>typeof t=="symbol");me(t=>t===ca);const tn=me(t=>typeof t=="number"),la=me(t=>t===tn),un=me(t=>typeof t=="string"),ua=me(t=>t===un),as=me(t=>typeof t=="boolean"),ku=me(t=>t===as),ha=is(void 0);ie(ss,t=>t.shape.length===1&&t.shape[0]===void 0);is(void 0);const cs=is(null),_u=ie(ss,t=>t.shape.length===1&&t.shape[0]===null);ie(Uint8Array);ie(fi,t=>t.shape===Uint8Array);const xu=En(tn,un,cs,ha,gi,as,ca);(()=>{const t=ia(jr),e=na(un,jr),n=En(tn,un,cs,as,t,e);return t.shape=n,e.shape.values=n,n})();const zn=t=>{if(pu.check(t))return t;if(cu.check(t)){const e={};for(const n in t)e[n]=zn(t[n]);return ou(e)}else{if(fu.check(t))return En(...t.map(zn));if(xu.check(t))return is(t);if(wu.check(t))return ie(t)}Le()},Qi=Gl?()=>{}:(t,e)=>{const n=new eu;if(!e.check(t,n))throw Ve(`Expected value to be of type ${e.constructor.name}.
${n.toString()}`)};class Au{constructor(e){this.patterns=[],this.$state=e}if(e,n){return this.patterns.push({if:zn(e),h:n}),this}else(e){return this.if(jr,e)}done(){return(e,n)=>{for(let r=0;r<this.patterns.length;r++){const s=this.patterns[r];if(s.if.check(e))return s.h(e,n)}throw Ve("Unhandled pattern")}}}const Su=t=>new Au(t),fa=Su(jr).if(la,(t,e)=>Ts(e,qi,Fr)).if(ua,(t,e)=>Zl(e)).if(ku,(t,e)=>Zi(e)).if(Eu,(t,e)=>BigInt(Ts(e,qi,Fr))).if(Vr,(t,e)=>qt(e,Ms(e,t.shape))).if(au,(t,e)=>{const n={};for(const r in t.shape){let s=t.shape[r];if(su.check(s)){if(Zi(e))continue;s=s.shape}n[r]=fa(s,e)}return n}).if(hu,(t,e)=>{const n=[],r=Xo(e,0,42);for(let s=0;s<r;s++)n.push(qt(e,t.shape));return n}).if(Zo,(t,e)=>Ms(e,t.shape)).if(_u,(t,e)=>null).if(mu,(t,e)=>{const n=qt(e,t.res);return()=>n}).if(bu,(t,e)=>qt(e,Ms(e,[tn,un,cs,ha,gi,as,ia(tn),na(En("a","b","c"),tn)]))).if(lu,(t,e)=>{const n={},r=Ts(e,0,3);for(let s=0;s<r;s++){const i=qt(e,t.shape.keys),c=qt(e,t.shape.values);n[i]=c}return n}).done(),qt=(t,e)=>fa(zn(e),t),ls=typeof document<"u"?document:{};me(t=>t.nodeType===Mu);typeof DOMParser<"u"&&new DOMParser;me(t=>t.nodeType===Iu);me(t=>t.nodeType===Cu);const vu=t=>zc(t,(e,n)=>`${n}:${e};`).join(""),Iu=ls.ELEMENT_NODE,Cu=ls.TEXT_NODE,Tu=ls.DOCUMENT_NODE,Mu=ls.DOCUMENT_FRAGMENT_NODE;me(t=>t.nodeType===Tu);const ut=Symbol,da=ut(),pa=ut(),Du=ut(),Ou=ut(),Ru=ut(),ga=ut(),Uu=ut(),mi=ut(),Bu=ut(),Lu=t=>{t.length===1&&t[0]?.constructor===Function&&(t=t[0]());const e=[],n=[];let r=0;for(;r<t.length;r++){const s=t[r];if(s===void 0)break;if(s.constructor===String||s.constructor===Number)e.push(s);else if(s.constructor===Object)break}for(r>0&&n.push(e.join(""));r<t.length;r++){const s=t[r];s instanceof Symbol||n.push(s)}return n},Nu={[da]:Qe("font-weight","bold"),[pa]:Qe("font-weight","normal"),[Du]:Qe("color","blue"),[Ru]:Qe("color","green"),[Ou]:Qe("color","grey"),[ga]:Qe("color","red"),[Uu]:Qe("color","purple"),[mi]:Qe("color","orange"),[Bu]:Qe("color","black")},Fu=t=>{t.length===1&&t[0]?.constructor===Function&&(t=t[0]());const e=[],n=[],r=Ae();let s=[],i=0;for(;i<t.length;i++){const c=t[i],h=Nu[c];if(h!==void 0)r.set(h.left,h.right);else{if(c===void 0)break;if(c.constructor===String||c.constructor===Number){const f=vu(r);i>0||f.length>0?(e.push("%c"+c),n.push(f)):e.push(c)}else break}}for(i>0&&(s=n,s.unshift(e.join("")));i<t.length;i++){const c=t[i];c instanceof Symbol||s.push(c)}return s},ma=zl?Fu:Lu,$u=(...t)=>{console.log(...ma(t)),wa.forEach(e=>e.print(t))},Pu=(...t)=>{console.warn(...ma(t)),t.unshift(mi),wa.forEach(e=>e.print(t))},wa=Mt(),ya=t=>({[Symbol.iterator](){return this},next:t}),Vu=(t,e)=>ya(()=>{let n;do n=t.next();while(!n.done&&!e(n.value));return n}),Ds=(t,e)=>ya(()=>{const{done:n,value:r}=t.next();return{done:n,value:n?void 0:e(r)}});class wi{constructor(e,n){this.clock=e,this.len=n}}class ur{constructor(){this.clients=new Map}}const ba=(t,e,n)=>e.clients.forEach((r,s)=>{const i=t.doc.store.clients.get(s);if(i!=null){const c=i[i.length-1],h=c.id.clock+c.length;for(let f=0,g=r[f];f<r.length&&g.clock<h;g=r[++f])Ma(t,i,g.clock,g.len,n)}}),ju=(t,e)=>{let n=0,r=t.length-1;for(;n<=r;){const s=Ke((n+r)/2),i=t[s],c=i.clock;if(c<=e){if(e<c+i.len)return s;n=s+1}else r=s-1}return null},Ea=(t,e)=>{const n=t.clients.get(e.client);return n!==void 0&&ju(n,e.clock)!==null},yi=t=>{t.clients.forEach(e=>{e.sort((s,i)=>s.clock-i.clock);let n,r;for(n=1,r=1;n<e.length;n++){const s=e[r-1],i=e[n];s.clock+s.len>=i.clock?s.len=Bt(s.len,i.clock+i.len-s.clock):(r<n&&(e[r]=i),r++)}e.length=r})},Hu=t=>{const e=new ur;for(let n=0;n<t.length;n++)t[n].clients.forEach((r,s)=>{if(!e.clients.has(s)){const i=r.slice();for(let c=n+1;c<t.length;c++)Wc(i,t[c].clients.get(s)||[]);e.clients.set(s,i)}});return yi(e),e},Hr=(t,e,n,r)=>{lt(t.clients,e,()=>[]).push(new wi(n,r))},qu=()=>new ur,Gu=t=>{const e=qu();return t.clients.forEach((n,r)=>{const s=[];for(let i=0;i<n.length;i++){const c=n[i];if(c.deleted){const h=c.id.clock;let f=c.length;if(i+1<n.length)for(let g=n[i+1];i+1<n.length&&g.deleted;g=n[++i+1])f+=g.length;s.push(new wi(h,f))}}s.length>0&&e.clients.set(r,s)}),e},kn=(t,e)=>{$(t.restEncoder,e.clients.size),yt(e.clients.entries()).sort((n,r)=>r[0]-n[0]).forEach(([n,r])=>{t.resetDsCurVal(),$(t.restEncoder,n);const s=r.length;$(t.restEncoder,s);for(let i=0;i<s;i++){const c=r[i];t.writeDsClock(c.clock),t.writeDsLen(c.len)}})},bi=t=>{const e=new ur,n=U(t.restDecoder);for(let r=0;r<n;r++){t.resetDsCurVal();const s=U(t.restDecoder),i=U(t.restDecoder);if(i>0){const c=lt(e.clients,s,()=>[]);for(let h=0;h<i;h++)c.push(new wi(t.readDsClock(),t.readDsLen()))}}return e},eo=(t,e,n)=>{const r=new ur,s=U(t.restDecoder);for(let i=0;i<s;i++){t.resetDsCurVal();const c=U(t.restDecoder),h=U(t.restDecoder),f=n.clients.get(c)||[],g=pe(n,c);for(let u=0;u<h;u++){const m=t.readDsClock(),d=m+t.readDsLen();if(m<g){g<d&&Hr(r,c,g,d-g);let w=Xe(f,m),E=f[w];for(!E.deleted&&E.id.clock<m&&(f.splice(w+1,0,Kr(e,E,m-E.id.clock)),w++);w<f.length&&(E=f[w++],E.id.clock<d);)E.deleted||(d<E.id.clock+E.length&&f.splice(w,0,Kr(e,E,d-E.id.clock)),E.delete(e))}else Hr(r,c,m,d-m)}}if(r.clients.size>0){const i=new Dt;return $(i.restEncoder,0),kn(i,r),i.toUint8Array()}return null},ka=Go;class _n extends Xc{constructor({guid:e=Dl(),collectionid:n=null,gc:r=!0,gcFilter:s=()=>!0,meta:i=null,autoLoad:c=!1,shouldLoad:h=!0}={}){super(),this.gc=r,this.gcFilter=s,this.clientID=ka(),this.guid=e,this.collectionid=n,this.share=new Map,this.store=new Ca,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=h,this.autoLoad=c,this.meta=i,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=ln(g=>{this.on("load",()=>{this.isLoaded=!0,g(this)})});const f=()=>ln(g=>{const u=m=>{(m===void 0||m===!0)&&(this.off("sync",u),g())};this.on("sync",u)});this.on("sync",g=>{g===!1&&this.isSynced&&(this.whenSynced=f()),this.isSynced=g===void 0||g===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=f()}load(){const e=this._item;e!==null&&!this.shouldLoad&&G(e.parent.doc,n=>{n.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(yt(this.subdocs).map(e=>e.guid))}transact(e,n=null){return G(this,e,n)}get(e,n=we){const r=lt(this.share,e,()=>{const i=new n;return i._integrate(this,null),i}),s=r.constructor;if(n!==we&&s!==n)if(s===we){const i=new n;i._map=r._map,r._map.forEach(c=>{for(;c!==null;c=c.left)c.parent=i}),i._start=r._start;for(let c=i._start;c!==null;c=c.right)c.parent=i;return i._length=r._length,this.share.set(e,i),i._integrate(this,null),i}else throw new Error(`Type with the name ${e} has already been defined with a different constructor`);return r}getArray(e=""){return this.get(e,rn)}getText(e=""){return this.get(e,dn)}getMap(e=""){return this.get(e,fn)}getXmlElement(e=""){return this.get(e,pn)}getXmlFragment(e=""){return this.get(e,Ot)}toJSON(){const e={};return this.share.forEach((n,r)=>{e[r]=n.toJSON()}),e}destroy(){this.isDestroyed=!0,yt(this.subdocs).forEach(n=>n.destroy());const e=this._item;if(e!==null){this._item=null;const n=e.content;n.doc=new _n({guid:this.guid,...n.opts,shouldLoad:!1}),n.doc._item=e,G(e.parent.doc,r=>{const s=n.doc;e.deleted||r.subdocsAdded.add(s),r.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}}class _a{constructor(e){this.restDecoder=e}resetDsCurVal(){}readDsClock(){return U(this.restDecoder)}readDsLen(){return U(this.restDecoder)}}class xa extends _a{readLeftID(){return L(U(this.restDecoder),U(this.restDecoder))}readRightID(){return L(U(this.restDecoder),U(this.restDecoder))}readClient(){return U(this.restDecoder)}readInfo(){return cn(this.restDecoder)}readString(){return en(this.restDecoder)}readParentInfo(){return U(this.restDecoder)===1}readTypeRef(){return U(this.restDecoder)}readLen(){return U(this.restDecoder)}readAny(){return qn(this.restDecoder)}readBuf(){return Wl(Ce(this.restDecoder))}readJSON(){return JSON.parse(en(this.restDecoder))}readKey(){return en(this.restDecoder)}}class Ju{constructor(e){this.dsCurrVal=0,this.restDecoder=e}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=U(this.restDecoder),this.dsCurrVal}readDsLen(){const e=U(this.restDecoder)+1;return this.dsCurrVal+=e,e}}class hn extends Ju{constructor(e){super(e),this.keys=[],U(e),this.keyClockDecoder=new Cs(Ce(e)),this.clientDecoder=new Tr(Ce(e)),this.leftClockDecoder=new Cs(Ce(e)),this.rightClockDecoder=new Cs(Ce(e)),this.infoDecoder=new Ki(Ce(e),cn),this.stringDecoder=new Cl(Ce(e)),this.parentInfoDecoder=new Ki(Ce(e),cn),this.typeRefDecoder=new Tr(Ce(e)),this.lenDecoder=new Tr(Ce(e))}readLeftID(){return new nn(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new nn(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return qn(this.restDecoder)}readBuf(){return Ce(this.restDecoder)}readJSON(){return qn(this.restDecoder)}readKey(){const e=this.keyClockDecoder.read();if(e<this.keys.length)return this.keys[e];{const n=this.stringDecoder.read();return this.keys.push(n),n}}}class zu{constructor(){this.restEncoder=ts()}toUint8Array(){return Ye(this.restEncoder)}resetDsCurVal(){}writeDsClock(e){$(this.restEncoder,e)}writeDsLen(e){$(this.restEncoder,e)}}class hr extends zu{writeLeftID(e){$(this.restEncoder,e.client),$(this.restEncoder,e.clock)}writeRightID(e){$(this.restEncoder,e.client),$(this.restEncoder,e.clock)}writeClient(e){$(this.restEncoder,e)}writeInfo(e){Hs(this.restEncoder,e)}writeString(e){Qt(this.restEncoder,e)}writeParentInfo(e){$(this.restEncoder,e?1:0)}writeTypeRef(e){$(this.restEncoder,e)}writeLen(e){$(this.restEncoder,e)}writeAny(e){Hn(this.restEncoder,e)}writeBuf(e){Ie(this.restEncoder,e)}writeJSON(e){Qt(this.restEncoder,JSON.stringify(e))}writeKey(e){Qt(this.restEncoder,e)}}class Yu{constructor(){this.restEncoder=ts(),this.dsCurrVal=0}toUint8Array(){return Ye(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(e){const n=e-this.dsCurrVal;this.dsCurrVal=e,$(this.restEncoder,n)}writeDsLen(e){e===0&&Le(),$(this.restEncoder,e-1),this.dsCurrVal+=e}}class Dt extends Yu{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new Is,this.clientEncoder=new Cr,this.leftClockEncoder=new Is,this.rightClockEncoder=new Is,this.infoEncoder=new zi(Hs),this.stringEncoder=new bl,this.parentInfoEncoder=new zi(Hs),this.typeRefEncoder=new Cr,this.lenEncoder=new Cr}toUint8Array(){const e=ts();return $(e,0),Ie(e,this.keyClockEncoder.toUint8Array()),Ie(e,this.clientEncoder.toUint8Array()),Ie(e,this.leftClockEncoder.toUint8Array()),Ie(e,this.rightClockEncoder.toUint8Array()),Ie(e,Ye(this.infoEncoder)),Ie(e,this.stringEncoder.toUint8Array()),Ie(e,Ye(this.parentInfoEncoder)),Ie(e,this.typeRefEncoder.toUint8Array()),Ie(e,this.lenEncoder.toUint8Array()),ns(e,Ye(this.restEncoder)),Ye(e)}writeLeftID(e){this.clientEncoder.write(e.client),this.leftClockEncoder.write(e.clock)}writeRightID(e){this.clientEncoder.write(e.client),this.rightClockEncoder.write(e.clock)}writeClient(e){this.clientEncoder.write(e)}writeInfo(e){this.infoEncoder.write(e)}writeString(e){this.stringEncoder.write(e)}writeParentInfo(e){this.parentInfoEncoder.write(e?1:0)}writeTypeRef(e){this.typeRefEncoder.write(e)}writeLen(e){this.lenEncoder.write(e)}writeAny(e){Hn(this.restEncoder,e)}writeBuf(e){Ie(this.restEncoder,e)}writeJSON(e){Hn(this.restEncoder,e)}writeKey(e){const n=this.keyMap.get(e);n===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(e)):this.keyClockEncoder.write(n)}}const Wu=(t,e,n,r)=>{r=Bt(r,e[0].id.clock);const s=Xe(e,r);$(t.restEncoder,e.length-s),t.writeClient(n),$(t.restEncoder,r);const i=e[s];i.write(t,r-i.id.clock);for(let c=s+1;c<e.length;c++)e[c].write(t,0)},Ei=(t,e,n)=>{const r=new Map;n.forEach((s,i)=>{pe(e,i)>s&&r.set(i,s)}),ki(e).forEach((s,i)=>{n.has(i)||r.set(i,0)}),$(t.restEncoder,r.size),yt(r.entries()).sort((s,i)=>i[0]-s[0]).forEach(([s,i])=>{Wu(t,e.clients.get(s),s,i)})},Ku=(t,e)=>{const n=Ae(),r=U(t.restDecoder);for(let s=0;s<r;s++){const i=U(t.restDecoder),c=new Array(i),h=t.readClient();let f=U(t.restDecoder);n.set(h,{i:0,refs:c});for(let g=0;g<i;g++){const u=t.readInfo();switch(es&u){case 0:{const m=t.readLen();c[g]=new Ue(L(h,f),m),f+=m;break}case 10:{const m=U(t.restDecoder);c[g]=new Be(L(h,f),m),f+=m;break}default:{const m=(u&(it|Te))===0,d=new ce(L(h,f),null,(u&Te)===Te?t.readLeftID():null,null,(u&it)===it?t.readRightID():null,m?t.readParentInfo()?e.get(t.readString()):t.readLeftID():null,m&&(u&Vn)===Vn?t.readString():null,Wa(t,u));c[g]=d,f+=d.length}}}}return n},Xu=(t,e,n)=>{const r=[];let s=yt(n.keys()).sort((w,E)=>w-E);if(s.length===0)return null;const i=()=>{if(s.length===0)return null;let w=n.get(s[s.length-1]);for(;w.refs.length===w.i;)if(s.pop(),s.length>0)w=n.get(s[s.length-1]);else return null;return w};let c=i();if(c===null)return null;const h=new Ca,f=new Map,g=(w,E)=>{const x=f.get(w);(x==null||x>E)&&f.set(w,E)};let u=c.refs[c.i++];const m=new Map,d=()=>{for(const w of r){const E=w.id.client,x=n.get(E);x?(x.i--,h.clients.set(E,x.refs.slice(x.i)),n.delete(E),x.i=0,x.refs=[]):h.clients.set(E,[w]),s=s.filter(D=>D!==E)}r.length=0};for(;;){if(u.constructor!==Be){const E=lt(m,u.id.client,()=>pe(e,u.id.client))-u.id.clock;if(E<0)r.push(u),g(u.id.client,u.id.clock-1),d();else{const x=u.getMissing(t,e);if(x!==null){r.push(u);const D=n.get(x)||{refs:[],i:0};if(D.refs.length===D.i)g(x,pe(e,x)),d();else{u=D.refs[D.i++];continue}}else(E===0||E<u.length)&&(u.integrate(t,E),m.set(u.id.client,u.id.clock+u.length))}}if(r.length>0)u=r.pop();else if(c!==null&&c.i<c.refs.length)u=c.refs[c.i++];else{if(c=i(),c===null)break;u=c.refs[c.i++]}}if(h.clients.size>0){const w=new Dt;return Ei(w,h,new Map),$(w.restEncoder,0),{missing:f,update:w.toUint8Array()}}return null},Zu=(t,e)=>Ei(t,e.doc.store,e.beforeState),Qu=(t,e,n,r=new hn(t))=>G(e,s=>{s.local=!1;let i=!1;const c=s.doc,h=c.store,f=Ku(r,c),g=Xu(s,h,f),u=h.pendingStructs;if(u){for(const[d,w]of u.missing)if(w<pe(h,d)){i=!0;break}if(g){for(const[d,w]of g.missing){const E=u.missing.get(d);(E==null||E>w)&&u.missing.set(d,w)}u.update=qr([u.update,g.update])}}else h.pendingStructs=g;const m=eo(r,s,h);if(h.pendingDs){const d=new hn(bn(h.pendingDs));U(d.restDecoder);const w=eo(d,s,h);m&&w?h.pendingDs=qr([m,w]):h.pendingDs=m||w}else h.pendingDs=m;if(i){const d=h.pendingStructs.update;h.pendingStructs=null,Aa(s.doc,d)}},n,!1),Aa=(t,e,n,r=hn)=>{const s=bn(e);Qu(s,t,n,new r(s))},eh=(t,e,n)=>Aa(t,e,n,xa),th=(t,e,n=new Map)=>{Ei(t,e.store,n),kn(t,Gu(e.store))},nh=(t,e=new Uint8Array([0]),n=new Dt)=>{const r=va(e);th(n,t,r);const s=[n.toUint8Array()];if(t.store.pendingDs&&s.push(t.store.pendingDs),t.store.pendingStructs&&s.push(ph(t.store.pendingStructs.update,e)),s.length>1){if(n.constructor===hr)return fh(s.map((i,c)=>c===0?i:mh(i)));if(n.constructor===Dt)return qr(s)}return s[0]},Sa=(t,e)=>nh(t,e,new hr),rh=t=>{const e=new Map,n=U(t.restDecoder);for(let r=0;r<n;r++){const s=U(t.restDecoder),i=U(t.restDecoder);e.set(s,i)}return e},va=t=>rh(new _a(bn(t)));class sh{constructor(){this.l=[]}}const to=()=>new sh,no=(t,e)=>t.l.push(e),ro=(t,e)=>{const n=t.l,r=n.length;t.l=n.filter(s=>e!==s),r===t.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},Ia=(t,e,n)=>ui(t.l,[e,n]);class nn{constructor(e,n){this.client=e,this.clock=n}}const yr=(t,e)=>t===e||t!==null&&e!==null&&t.client===e.client&&t.clock===e.clock,L=(t,e)=>new nn(t,e),ih=t=>{for(const[e,n]of t.doc.share.entries())if(n===t)return e;throw Le()},Jt=(t,e)=>e===void 0?!t.deleted:e.sv.has(t.id.client)&&(e.sv.get(t.id.client)||0)>t.id.clock&&!Ea(e.ds,t.id),zs=(t,e)=>{const n=lt(t.meta,zs,Mt),r=t.doc.store;n.has(e)||(e.sv.forEach((s,i)=>{s<pe(r,i)&&bt(t,L(i,s))}),ba(t,e.ds,s=>{}),n.add(e))};class Ca{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const ki=t=>{const e=new Map;return t.clients.forEach((n,r)=>{const s=n[n.length-1];e.set(r,s.id.clock+s.length)}),e},pe=(t,e)=>{const n=t.clients.get(e);if(n===void 0)return 0;const r=n[n.length-1];return r.id.clock+r.length},Ta=(t,e)=>{let n=t.clients.get(e.id.client);if(n===void 0)n=[],t.clients.set(e.id.client,n);else{const r=n[n.length-1];if(r.id.clock+r.length!==e.id.clock)throw Le()}n.push(e)},Xe=(t,e)=>{let n=0,r=t.length-1,s=t[r],i=s.id.clock;if(i===e)return r;let c=Ke(e/(i+s.length-1)*r);for(;n<=r;){if(s=t[c],i=s.id.clock,i<=e){if(e<i+s.length)return c;n=c+1}else r=c-1;c=Ke((n+r)/2)}throw Le()},oh=(t,e)=>{const n=t.clients.get(e.client);return n[Xe(n,e.clock)]},Os=oh,Ys=(t,e,n)=>{const r=Xe(e,n),s=e[r];return s.id.clock<n&&s instanceof ce?(e.splice(r+1,0,Kr(t,s,n-s.id.clock)),r+1):r},bt=(t,e)=>{const n=t.doc.store.clients.get(e.client);return n[Ys(t,n,e.clock)]},so=(t,e,n)=>{const r=e.clients.get(n.client),s=Xe(r,n.clock),i=r[s];return n.clock!==i.id.clock+i.length-1&&i.constructor!==Ue&&r.splice(s+1,0,Kr(t,i,n.clock-i.id.clock+1)),i},ah=(t,e,n)=>{const r=t.clients.get(e.id.client);r[Xe(r,e.id.clock)]=n},Ma=(t,e,n,r,s)=>{if(r===0)return;const i=n+r;let c=Ys(t,e,n),h;do h=e[c++],i<h.id.clock+h.length&&Ys(t,e,i),s(h);while(c<e.length&&e[c].id.clock<i)};class ch{constructor(e,n,r){this.doc=e,this.deleteSet=new ur,this.beforeState=ki(e.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=n,this.meta=new Map,this.local=r,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}}const io=(t,e)=>e.deleteSet.clients.size===0&&!Yc(e.afterState,(n,r)=>e.beforeState.get(r)!==n)?!1:(yi(e.deleteSet),Zu(t,e),kn(t,e.deleteSet),!0),oo=(t,e,n)=>{const r=e._item;(r===null||r.id.clock<(t.beforeState.get(r.id.client)||0)&&!r.deleted)&&lt(t.changed,e,Mt).add(n)},Dr=(t,e)=>{let n=t[e],r=t[e-1],s=e;for(;s>0;n=r,r=t[--s-1]){if(r.deleted===n.deleted&&r.constructor===n.constructor&&r.mergeWith(n)){n instanceof ce&&n.parentSub!==null&&n.parent._map.get(n.parentSub)===n&&n.parent._map.set(n.parentSub,r);continue}break}const i=e-s;return i&&t.splice(e+1-i,i),i},lh=(t,e,n)=>{for(const[r,s]of t.clients.entries()){const i=e.clients.get(r);for(let c=s.length-1;c>=0;c--){const h=s[c],f=h.clock+h.len;for(let g=Xe(i,h.clock),u=i[g];g<i.length&&u.id.clock<f;u=i[++g]){const m=i[g];if(h.clock+h.len<=m.id.clock)break;m instanceof ce&&m.deleted&&!m.keep&&n(m)&&m.gc(e,!1)}}}},uh=(t,e)=>{t.clients.forEach((n,r)=>{const s=e.clients.get(r);for(let i=n.length-1;i>=0;i--){const c=n[i],h=Vo(s.length-1,1+Xe(s,c.clock+c.len-1));for(let f=h,g=s[f];f>0&&g.id.clock>=c.clock;g=s[f])f-=1+Dr(s,f)}})},Da=(t,e)=>{if(e<t.length){const n=t[e],r=n.doc,s=r.store,i=n.deleteSet,c=n._mergeStructs;try{yi(i),n.afterState=ki(n.doc.store),r.emit("beforeObserverCalls",[n,r]);const h=[];n.changed.forEach((f,g)=>h.push(()=>{(g._item===null||!g._item.deleted)&&g._callObserver(n,f)})),h.push(()=>{n.changedParentTypes.forEach((f,g)=>{g._dEH.l.length>0&&(g._item===null||!g._item.deleted)&&(f=f.filter(u=>u.target._item===null||!u.target._item.deleted),f.forEach(u=>{u.currentTarget=g,u._path=null}),f.sort((u,m)=>u.path.length-m.path.length),Ia(g._dEH,f,n))})}),h.push(()=>r.emit("afterTransaction",[n,r])),ui(h,[]),n._needFormattingCleanup&&Mh(n)}finally{r.gc&&lh(i,s,r.gcFilter),uh(i,s),n.afterState.forEach((u,m)=>{const d=n.beforeState.get(m)||0;if(d!==u){const w=s.clients.get(m),E=Bt(Xe(w,d),1);for(let x=w.length-1;x>=E;)x-=1+Dr(w,x)}});for(let u=c.length-1;u>=0;u--){const{client:m,clock:d}=c[u].id,w=s.clients.get(m),E=Xe(w,d);E+1<w.length&&Dr(w,E+1)>1||E>0&&Dr(w,E)}if(!n.local&&n.afterState.get(r.clientID)!==n.beforeState.get(r.clientID)&&($u(mi,da,"[yjs] ",pa,ga,"Changed the client-id because another client seems to be using it."),r.clientID=ka()),r.emit("afterTransactionCleanup",[n,r]),r._observers.has("update")){const u=new hr;io(u,n)&&r.emit("update",[u.toUint8Array(),n.origin,r,n])}if(r._observers.has("updateV2")){const u=new Dt;io(u,n)&&r.emit("updateV2",[u.toUint8Array(),n.origin,r,n])}const{subdocsAdded:h,subdocsLoaded:f,subdocsRemoved:g}=n;(h.size>0||g.size>0||f.size>0)&&(h.forEach(u=>{u.clientID=r.clientID,u.collectionid==null&&(u.collectionid=r.collectionid),r.subdocs.add(u)}),g.forEach(u=>r.subdocs.delete(u)),r.emit("subdocs",[{loaded:f,added:h,removed:g},r,n]),g.forEach(u=>u.destroy())),t.length<=e+1?(r._transactionCleanups=[],r.emit("afterAllTransactions",[r,t])):Da(t,e+1)}}},G=(t,e,n=null,r=!0)=>{const s=t._transactionCleanups;let i=!1,c=null;t._transaction===null&&(i=!0,t._transaction=new ch(t,n,r),s.push(t._transaction),s.length===1&&t.emit("beforeAllTransactions",[t]),t.emit("beforeTransaction",[t._transaction,t]));try{c=e(t._transaction)}finally{if(i){const h=t._transaction===s[0];t._transaction=null,h&&Da(s,0)}}return c};function*hh(t){const e=U(t.restDecoder);for(let n=0;n<e;n++){const r=U(t.restDecoder),s=t.readClient();let i=U(t.restDecoder);for(let c=0;c<r;c++){const h=t.readInfo();if(h===10){const f=U(t.restDecoder);yield new Be(L(s,i),f),i+=f}else if((es&h)!==0){const f=(h&(it|Te))===0,g=new ce(L(s,i),null,(h&Te)===Te?t.readLeftID():null,null,(h&it)===it?t.readRightID():null,f?t.readParentInfo()?t.readString():t.readLeftID():null,f&&(h&Vn)===Vn?t.readString():null,Wa(t,h));yield g,i+=g.length}else{const f=t.readLen();yield new Ue(L(s,i),f),i+=f}}}}class _i{constructor(e,n){this.gen=hh(e),this.curr=null,this.done=!1,this.filterSkips=n,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===Be);return this.curr}}class xi{constructor(e){this.currClient=0,this.startClock=0,this.written=0,this.encoder=e,this.clientStructs=[]}}const fh=t=>qr(t,xa,hr),dh=(t,e)=>{if(t.constructor===Ue){const{client:n,clock:r}=t.id;return new Ue(L(n,r+e),t.length-e)}else if(t.constructor===Be){const{client:n,clock:r}=t.id;return new Be(L(n,r+e),t.length-e)}else{const n=t,{client:r,clock:s}=n.id;return new ce(L(r,s+e),null,L(r,s+e-1),null,n.rightOrigin,n.parent,n.parentSub,n.content.splice(e))}},qr=(t,e=hn,n=Dt)=>{if(t.length===1)return t[0];const r=t.map(u=>new e(bn(u)));let s=r.map(u=>new _i(u,!0)),i=null;const c=new n,h=new xi(c);for(;s=s.filter(d=>d.curr!==null),s.sort((d,w)=>{if(d.curr.id.client===w.curr.id.client){const E=d.curr.id.clock-w.curr.id.clock;return E===0?d.curr.constructor===w.curr.constructor?0:d.curr.constructor===Be?1:-1:E}else return w.curr.id.client-d.curr.id.client}),s.length!==0;){const u=s[0],m=u.curr.id.client;if(i!==null){let d=u.curr,w=!1;for(;d!==null&&d.id.clock+d.length<=i.struct.id.clock+i.struct.length&&d.id.client>=i.struct.id.client;)d=u.next(),w=!0;if(d===null||d.id.client!==m||w&&d.id.clock>i.struct.id.clock+i.struct.length)continue;if(m!==i.struct.id.client)gt(h,i.struct,i.offset),i={struct:d,offset:0},u.next();else if(i.struct.id.clock+i.struct.length<d.id.clock)if(i.struct.constructor===Be)i.struct.length=d.id.clock+d.length-i.struct.id.clock;else{gt(h,i.struct,i.offset);const E=d.id.clock-i.struct.id.clock-i.struct.length;i={struct:new Be(L(m,i.struct.id.clock+i.struct.length),E),offset:0}}else{const E=i.struct.id.clock+i.struct.length-d.id.clock;E>0&&(i.struct.constructor===Be?i.struct.length-=E:d=dh(d,E)),i.struct.mergeWith(d)||(gt(h,i.struct,i.offset),i={struct:d,offset:0},u.next())}}else i={struct:u.curr,offset:0},u.next();for(let d=u.curr;d!==null&&d.id.client===m&&d.id.clock===i.struct.id.clock+i.struct.length&&d.constructor!==Be;d=u.next())gt(h,i.struct,i.offset),i={struct:d,offset:0}}i!==null&&(gt(h,i.struct,i.offset),i=null),Ai(h);const f=r.map(u=>bi(u)),g=Hu(f);return kn(c,g),c.toUint8Array()},ph=(t,e,n=hn,r=Dt)=>{const s=va(e),i=new r,c=new xi(i),h=new n(bn(t)),f=new _i(h,!1);for(;f.curr;){const u=f.curr,m=u.id.client,d=s.get(m)||0;if(f.curr.constructor===Be){f.next();continue}if(u.id.clock+u.length>d)for(gt(c,u,Bt(d-u.id.clock,0)),f.next();f.curr&&f.curr.id.client===m;)gt(c,f.curr,0),f.next();else for(;f.curr&&f.curr.id.client===m&&f.curr.id.clock+f.curr.length<=d;)f.next()}Ai(c);const g=bi(h);return kn(i,g),i.toUint8Array()},Oa=t=>{t.written>0&&(t.clientStructs.push({written:t.written,restEncoder:Ye(t.encoder.restEncoder)}),t.encoder.restEncoder=ts(),t.written=0)},gt=(t,e,n)=>{t.written>0&&t.currClient!==e.id.client&&Oa(t),t.written===0&&(t.currClient=e.id.client,t.encoder.writeClient(e.id.client),$(t.encoder.restEncoder,e.id.clock+n)),e.write(t.encoder,n),t.written++},Ai=t=>{Oa(t);const e=t.encoder.restEncoder;$(e,t.clientStructs.length);for(let n=0;n<t.clientStructs.length;n++){const r=t.clientStructs[n];$(e,r.written),ns(e,r.restEncoder)}},gh=(t,e,n,r)=>{const s=new n(bn(t)),i=new _i(s,!1),c=new r,h=new xi(c);for(let g=i.curr;g!==null;g=i.next())gt(h,e(g),0);Ai(h);const f=bi(s);return kn(c,f),c.toUint8Array()},mh=t=>gh(t,jl,hn,hr),ao="You must not compute changes after the event-handler fired.";class us{constructor(e,n){this.target=e,this.currentTarget=e,this.transaction=n,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=wh(this.currentTarget,this.target))}deletes(e){return Ea(this.transaction.deleteSet,e.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw Ve(ao);const e=new Map,n=this.target;this.transaction.changed.get(n).forEach(s=>{if(s!==null){const i=n._map.get(s);let c,h;if(this.adds(i)){let f=i.left;for(;f!==null&&this.adds(f);)f=f.left;if(this.deletes(i))if(f!==null&&this.deletes(f))c="delete",h=As(f.content.getContent());else return;else f!==null&&this.deletes(f)?(c="update",h=As(f.content.getContent())):(c="add",h=void 0)}else if(this.deletes(i))c="delete",h=As(i.content.getContent());else return;e.set(s,{action:c,oldValue:h})}}),this._keys=e}return this._keys}get delta(){return this.changes.delta}adds(e){return e.id.clock>=(this.transaction.beforeState.get(e.id.client)||0)}get changes(){let e=this._changes;if(e===null){if(this.transaction.doc._transactionCleanups.length===0)throw Ve(ao);const n=this.target,r=Mt(),s=Mt(),i=[];if(e={added:r,deleted:s,delta:i,keys:this.keys},this.transaction.changed.get(n).has(null)){let h=null;const f=()=>{h&&i.push(h)};for(let g=n._start;g!==null;g=g.right)g.deleted?this.deletes(g)&&!this.adds(g)&&((h===null||h.delete===void 0)&&(f(),h={delete:0}),h.delete+=g.length,s.add(g)):this.adds(g)?((h===null||h.insert===void 0)&&(f(),h={insert:[]}),h.insert=h.insert.concat(g.content.getContent()),r.add(g)):((h===null||h.retain===void 0)&&(f(),h={retain:0}),h.retain+=g.length);h!==null&&h.retain===void 0&&f()}this._changes=e}return e}}const wh=(t,e)=>{const n=[];for(;e._item!==null&&e!==t;){if(e._item.parentSub!==null)n.unshift(e._item.parentSub);else{let r=0,s=e._item.parent._start;for(;s!==e._item&&s!==null;)!s.deleted&&s.countable&&(r+=s.length),s=s.right;n.unshift(r)}e=e._item.parent}return n},Ee=()=>{Pu("Invalid access: Add Yjs type to a document before reading data.")},Ra=80;let Si=0;class yh{constructor(e,n){e.marker=!0,this.p=e,this.index=n,this.timestamp=Si++}}const bh=t=>{t.timestamp=Si++},Ua=(t,e,n)=>{t.p.marker=!1,t.p=e,e.marker=!0,t.index=n,t.timestamp=Si++},Eh=(t,e,n)=>{if(t.length>=Ra){const r=t.reduce((s,i)=>s.timestamp<i.timestamp?s:i);return Ua(r,e,n),r}else{const r=new yh(e,n);return t.push(r),r}},hs=(t,e)=>{if(t._start===null||e===0||t._searchMarker===null)return null;const n=t._searchMarker.length===0?null:t._searchMarker.reduce((i,c)=>Ir(e-i.index)<Ir(e-c.index)?i:c);let r=t._start,s=0;for(n!==null&&(r=n.p,s=n.index,bh(n));r.right!==null&&s<e;){if(!r.deleted&&r.countable){if(e<s+r.length)break;s+=r.length}r=r.right}for(;r.left!==null&&s>e;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);for(;r.left!==null&&r.left.id.client===r.id.client&&r.left.id.clock+r.left.length===r.id.clock;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);return n!==null&&Ir(n.index-s)<r.parent.length/Ra?(Ua(n,r,s),n):Eh(t._searchMarker,r,s)},Yn=(t,e,n)=>{for(let r=t.length-1;r>=0;r--){const s=t[r];if(n>0){let i=s.p;for(i.marker=!1;i&&(i.deleted||!i.countable);)i=i.left,i&&!i.deleted&&i.countable&&(s.index-=i.length);if(i===null||i.marker===!0){t.splice(r,1);continue}s.p=i,i.marker=!0}(e<s.index||n>0&&e===s.index)&&(s.index=Bt(e,s.index+n))}},fs=(t,e,n)=>{const r=t,s=e.changedParentTypes;for(;lt(s,t,()=>[]).push(n),t._item!==null;)t=t._item.parent;Ia(r._eH,n,e)};class we{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=to(),this._dEH=to(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(e,n){this.doc=e,this._item=n}_copy(){throw $e()}clone(){throw $e()}_write(e){}get _first(){let e=this._start;for(;e!==null&&e.deleted;)e=e.right;return e}_callObserver(e,n){!e.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(e){no(this._eH,e)}observeDeep(e){no(this._dEH,e)}unobserve(e){ro(this._eH,e)}unobserveDeep(e){ro(this._dEH,e)}toJSON(){}}const Ba=(t,e,n)=>{t.doc??Ee(),e<0&&(e=t._length+e),n<0&&(n=t._length+n);let r=n-e;const s=[];let i=t._start;for(;i!==null&&r>0;){if(i.countable&&!i.deleted){const c=i.content.getContent();if(c.length<=e)e-=c.length;else{for(let h=e;h<c.length&&r>0;h++)s.push(c[h]),r--;e=0}}i=i.right}return s},La=t=>{t.doc??Ee();const e=[];let n=t._start;for(;n!==null;){if(n.countable&&!n.deleted){const r=n.content.getContent();for(let s=0;s<r.length;s++)e.push(r[s])}n=n.right}return e},Wn=(t,e)=>{let n=0,r=t._start;for(t.doc??Ee();r!==null;){if(r.countable&&!r.deleted){const s=r.content.getContent();for(let i=0;i<s.length;i++)e(s[i],n++,t)}r=r.right}},Na=(t,e)=>{const n=[];return Wn(t,(r,s)=>{n.push(e(r,s,t))}),n},kh=t=>{let e=t._start,n=null,r=0;return{[Symbol.iterator](){return this},next:()=>{if(n===null){for(;e!==null&&e.deleted;)e=e.right;if(e===null)return{done:!0,value:void 0};n=e.content.getContent(),r=0,e=e.right}const s=n[r++];return n.length<=r&&(n=null),{done:!1,value:s}}}},Fa=(t,e)=>{t.doc??Ee();const n=hs(t,e);let r=t._start;for(n!==null&&(r=n.p,e-=n.index);r!==null;r=r.right)if(!r.deleted&&r.countable){if(e<r.length)return r.content.getContent()[e];e-=r.length}},Gr=(t,e,n,r)=>{let s=n;const i=t.doc,c=i.clientID,h=i.store,f=n===null?e._start:n.right;let g=[];const u=()=>{g.length>0&&(s=new ce(L(c,pe(h,c)),s,s&&s.lastId,f,f&&f.id,e,null,new Rt(g)),s.integrate(t,0),g=[])};r.forEach(m=>{if(m===null)g.push(m);else switch(m.constructor){case Number:case Object:case Boolean:case Array:case String:g.push(m);break;default:switch(u(),m.constructor){case Uint8Array:case ArrayBuffer:s=new ce(L(c,pe(h,c)),s,s&&s.lastId,f,f&&f.id,e,null,new fr(new Uint8Array(m))),s.integrate(t,0);break;case _n:s=new ce(L(c,pe(h,c)),s,s&&s.lastId,f,f&&f.id,e,null,new dr(m)),s.integrate(t,0);break;default:if(m instanceof we)s=new ce(L(c,pe(h,c)),s,s&&s.lastId,f,f&&f.id,e,null,new ht(m)),s.integrate(t,0);else throw new Error("Unexpected content type in insert operation")}}}),u()},$a=()=>Ve("Length exceeded!"),Pa=(t,e,n,r)=>{if(n>e._length)throw $a();if(n===0)return e._searchMarker&&Yn(e._searchMarker,n,r.length),Gr(t,e,null,r);const s=n,i=hs(e,n);let c=e._start;for(i!==null&&(c=i.p,n-=i.index,n===0&&(c=c.prev,n+=c&&c.countable&&!c.deleted?c.length:0));c!==null;c=c.right)if(!c.deleted&&c.countable){if(n<=c.length){n<c.length&&bt(t,L(c.id.client,c.id.clock+n));break}n-=c.length}return e._searchMarker&&Yn(e._searchMarker,s,r.length),Gr(t,e,c,r)},_h=(t,e,n)=>{let s=(e._searchMarker||[]).reduce((i,c)=>c.index>i.index?c:i,{index:0,p:e._start}).p;if(s)for(;s.right;)s=s.right;return Gr(t,e,s,n)},Va=(t,e,n,r)=>{if(r===0)return;const s=n,i=r,c=hs(e,n);let h=e._start;for(c!==null&&(h=c.p,n-=c.index);h!==null&&n>0;h=h.right)!h.deleted&&h.countable&&(n<h.length&&bt(t,L(h.id.client,h.id.clock+n)),n-=h.length);for(;r>0&&h!==null;)h.deleted||(r<h.length&&bt(t,L(h.id.client,h.id.clock+r)),h.delete(t),r-=h.length),h=h.right;if(r>0)throw $a();e._searchMarker&&Yn(e._searchMarker,s,-i+r)},Jr=(t,e,n)=>{const r=e._map.get(n);r!==void 0&&r.delete(t)},vi=(t,e,n,r)=>{const s=e._map.get(n)||null,i=t.doc,c=i.clientID;let h;if(r==null)h=new Rt([r]);else switch(r.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:h=new Rt([r]);break;case Uint8Array:h=new fr(r);break;case _n:h=new dr(r);break;default:if(r instanceof we)h=new ht(r);else throw new Error("Unexpected content type")}new ce(L(c,pe(i.store,c)),s,s&&s.lastId,null,null,e,n,h).integrate(t,0)},Ii=(t,e)=>{t.doc??Ee();const n=t._map.get(e);return n!==void 0&&!n.deleted?n.content.getContent()[n.length-1]:void 0},ja=t=>{const e={};return t.doc??Ee(),t._map.forEach((n,r)=>{n.deleted||(e[r]=n.content.getContent()[n.length-1])}),e},Ha=(t,e)=>{t.doc??Ee();const n=t._map.get(e);return n!==void 0&&!n.deleted},xh=(t,e)=>{const n={};return t._map.forEach((r,s)=>{let i=r;for(;i!==null&&(!e.sv.has(i.id.client)||i.id.clock>=(e.sv.get(i.id.client)||0));)i=i.left;i!==null&&Jt(i,e)&&(n[s]=i.content.getContent()[i.length-1])}),n},br=t=>(t.doc??Ee(),Vu(t._map.entries(),e=>!e[1].deleted));class Ah extends us{}class rn extends we{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(e){const n=new rn;return n.push(e),n}_integrate(e,n){super._integrate(e,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new rn}clone(){const e=new rn;return e.insert(0,this.toArray().map(n=>n instanceof we?n.clone():n)),e}get length(){return this.doc??Ee(),this._length}_callObserver(e,n){super._callObserver(e,n),fs(this,e,new Ah(this,e))}insert(e,n){this.doc!==null?G(this.doc,r=>{Pa(r,this,e,n)}):this._prelimContent.splice(e,0,...n)}push(e){this.doc!==null?G(this.doc,n=>{_h(n,this,e)}):this._prelimContent.push(...e)}unshift(e){this.insert(0,e)}delete(e,n=1){this.doc!==null?G(this.doc,r=>{Va(r,this,e,n)}):this._prelimContent.splice(e,n)}get(e){return Fa(this,e)}toArray(){return La(this)}slice(e=0,n=this.length){return Ba(this,e,n)}toJSON(){return this.map(e=>e instanceof we?e.toJSON():e)}map(e){return Na(this,e)}forEach(e){Wn(this,e)}[Symbol.iterator](){return kh(this)}_write(e){e.writeTypeRef(Wh)}}const Sh=t=>new rn;class vh extends us{constructor(e,n,r){super(e,n),this.keysChanged=r}}class fn extends we{constructor(e){super(),this._prelimContent=null,e===void 0?this._prelimContent=new Map:this._prelimContent=new Map(e)}_integrate(e,n){super._integrate(e,n),this._prelimContent.forEach((r,s)=>{this.set(s,r)}),this._prelimContent=null}_copy(){return new fn}clone(){const e=new fn;return this.forEach((n,r)=>{e.set(r,n instanceof we?n.clone():n)}),e}_callObserver(e,n){fs(this,e,new vh(this,e,n))}toJSON(){this.doc??Ee();const e={};return this._map.forEach((n,r)=>{if(!n.deleted){const s=n.content.getContent()[n.length-1];e[r]=s instanceof we?s.toJSON():s}}),e}get size(){return[...br(this)].length}keys(){return Ds(br(this),e=>e[0])}values(){return Ds(br(this),e=>e[1].content.getContent()[e[1].length-1])}entries(){return Ds(br(this),e=>[e[0],e[1].content.getContent()[e[1].length-1]])}forEach(e){this.doc??Ee(),this._map.forEach((n,r)=>{n.deleted||e(n.content.getContent()[n.length-1],r,this)})}[Symbol.iterator](){return this.entries()}delete(e){this.doc!==null?G(this.doc,n=>{Jr(n,this,e)}):this._prelimContent.delete(e)}set(e,n){return this.doc!==null?G(this.doc,r=>{vi(r,this,e,n)}):this._prelimContent.set(e,n),n}get(e){return Ii(this,e)}has(e){return Ha(this,e)}clear(){this.doc!==null?G(this.doc,e=>{this.forEach(function(n,r,s){Jr(e,s,r)})}):this._prelimContent.clear()}_write(e){e.writeTypeRef(Kh)}}const Ih=t=>new fn,wt=(t,e)=>t===e||typeof t=="object"&&typeof e=="object"&&t&&e&&Pl(t,e);class Ws{constructor(e,n,r,s){this.left=e,this.right=n,this.index=r,this.currentAttributes=s}forward(){switch(this.right===null&&Le(),this.right.content.constructor){case le:this.right.deleted||xn(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}}const co=(t,e,n)=>{for(;e.right!==null&&n>0;){switch(e.right.content.constructor){case le:e.right.deleted||xn(e.currentAttributes,e.right.content);break;default:e.right.deleted||(n<e.right.length&&bt(t,L(e.right.id.client,e.right.id.clock+n)),e.index+=e.right.length,n-=e.right.length);break}e.left=e.right,e.right=e.right.right}return e},Er=(t,e,n,r)=>{const s=new Map,i=r?hs(e,n):null;if(i){const c=new Ws(i.p.left,i.p,i.index,s);return co(t,c,n-i.index)}else{const c=new Ws(null,e._start,0,s);return co(t,c,n)}},qa=(t,e,n,r)=>{for(;n.right!==null&&(n.right.deleted===!0||n.right.content.constructor===le&&wt(r.get(n.right.content.key),n.right.content.value));)n.right.deleted||r.delete(n.right.content.key),n.forward();const s=t.doc,i=s.clientID;r.forEach((c,h)=>{const f=n.left,g=n.right,u=new ce(L(i,pe(s.store,i)),f,f&&f.lastId,g,g&&g.id,e,null,new le(h,c));u.integrate(t,0),n.right=u,n.forward()})},xn=(t,e)=>{const{key:n,value:r}=e;r===null?t.delete(n):t.set(n,r)},Ga=(t,e)=>{for(;t.right!==null;){if(!(t.right.deleted||t.right.content.constructor===le&&wt(e[t.right.content.key]??null,t.right.content.value)))break;t.forward()}},Ja=(t,e,n,r)=>{const s=t.doc,i=s.clientID,c=new Map;for(const h in r){const f=r[h],g=n.currentAttributes.get(h)??null;if(!wt(g,f)){c.set(h,g);const{left:u,right:m}=n;n.right=new ce(L(i,pe(s.store,i)),u,u&&u.lastId,m,m&&m.id,e,null,new le(h,f)),n.right.integrate(t,0),n.forward()}}return c},Rs=(t,e,n,r,s)=>{n.currentAttributes.forEach((d,w)=>{s[w]===void 0&&(s[w]=null)});const i=t.doc,c=i.clientID;Ga(n,s);const h=Ja(t,e,n,s),f=r.constructor===String?new Ze(r):r instanceof we?new ht(r):new Lt(r);let{left:g,right:u,index:m}=n;e._searchMarker&&Yn(e._searchMarker,n.index,f.getLength()),u=new ce(L(c,pe(i.store,c)),g,g&&g.lastId,u,u&&u.id,e,null,f),u.integrate(t,0),n.right=u,n.index=m,n.forward(),qa(t,e,n,h)},lo=(t,e,n,r,s)=>{const i=t.doc,c=i.clientID;Ga(n,s);const h=Ja(t,e,n,s);e:for(;n.right!==null&&(r>0||h.size>0&&(n.right.deleted||n.right.content.constructor===le));){if(!n.right.deleted)switch(n.right.content.constructor){case le:{const{key:f,value:g}=n.right.content,u=s[f];if(u!==void 0){if(wt(u,g))h.delete(f);else{if(r===0)break e;h.set(f,g)}n.right.delete(t)}else n.currentAttributes.set(f,g);break}default:r<n.right.length&&bt(t,L(n.right.id.client,n.right.id.clock+r)),r-=n.right.length;break}n.forward()}if(r>0){let f="";for(;r>0;r--)f+=`
`;n.right=new ce(L(c,pe(i.store,c)),n.left,n.left&&n.left.lastId,n.right,n.right&&n.right.id,e,null,new Ze(f)),n.right.integrate(t,0),n.forward()}qa(t,e,n,h)},za=(t,e,n,r,s)=>{let i=e;const c=Ae();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===le){const g=i.content;c.set(g.key,g)}i=i.right}let h=0,f=!1;for(;e!==i;){if(n===e&&(f=!0),!e.deleted){const g=e.content;switch(g.constructor){case le:{const{key:u,value:m}=g,d=r.get(u)??null;(c.get(u)!==g||d===m)&&(e.delete(t),h++,!f&&(s.get(u)??null)===m&&d!==m&&(d===null?s.delete(u):s.set(u,d))),!f&&!e.deleted&&xn(s,g);break}}}e=e.right}return h},Ch=(t,e)=>{for(;e&&e.right&&(e.right.deleted||!e.right.countable);)e=e.right;const n=new Set;for(;e&&(e.deleted||!e.countable);){if(!e.deleted&&e.content.constructor===le){const r=e.content.key;n.has(r)?e.delete(t):n.add(r)}e=e.left}},Th=t=>{let e=0;return G(t.doc,n=>{let r=t._start,s=t._start,i=Ae();const c=Vs(i);for(;s;){if(s.deleted===!1)switch(s.content.constructor){case le:xn(c,s.content);break;default:e+=za(n,r,s,i,c),i=Vs(c),r=s;break}s=s.right}}),e},Mh=t=>{const e=new Set,n=t.doc;for(const[r,s]of t.afterState.entries()){const i=t.beforeState.get(r)||0;s!==i&&Ma(t,n.store.clients.get(r),i,s,c=>{!c.deleted&&c.content.constructor===le&&c.constructor!==Ue&&e.add(c.parent)})}G(n,r=>{ba(t,t.deleteSet,s=>{if(s instanceof Ue||!s.parent._hasFormatting||e.has(s.parent))return;const i=s.parent;s.content.constructor===le?e.add(i):Ch(r,s)});for(const s of e)Th(s)})},uo=(t,e,n)=>{const r=n,s=Vs(e.currentAttributes),i=e.right;for(;n>0&&e.right!==null;){if(e.right.deleted===!1)switch(e.right.content.constructor){case ht:case Lt:case Ze:n<e.right.length&&bt(t,L(e.right.id.client,e.right.id.clock+n)),n-=e.right.length,e.right.delete(t);break}e.forward()}i&&za(t,i,e.right,s,e.currentAttributes);const c=(e.left||e.right).parent;return c._searchMarker&&Yn(c._searchMarker,e.index,-r+n),e};class Dh extends us{constructor(e,n,r){super(e,n),this.childListChanged=!1,this.keysChanged=new Set,r.forEach(s=>{s===null?this.childListChanged=!0:this.keysChanged.add(s)})}get changes(){if(this._changes===null){const e={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=e}return this._changes}get delta(){if(this._delta===null){const e=this.target.doc,n=[];G(e,r=>{const s=new Map,i=new Map;let c=this.target._start,h=null;const f={};let g="",u=0,m=0;const d=()=>{if(h!==null){let w=null;switch(h){case"delete":m>0&&(w={delete:m}),m=0;break;case"insert":(typeof g=="object"||g.length>0)&&(w={insert:g},s.size>0&&(w.attributes={},s.forEach((E,x)=>{E!==null&&(w.attributes[x]=E)}))),g="";break;case"retain":u>0&&(w={retain:u},$l(f)||(w.attributes=Ll({},f))),u=0;break}w&&n.push(w),h=null}};for(;c!==null;){switch(c.content.constructor){case ht:case Lt:this.adds(c)?this.deletes(c)||(d(),h="insert",g=c.content.getContent()[0],d()):this.deletes(c)?(h!=="delete"&&(d(),h="delete"),m+=1):c.deleted||(h!=="retain"&&(d(),h="retain"),u+=1);break;case Ze:this.adds(c)?this.deletes(c)||(h!=="insert"&&(d(),h="insert"),g+=c.content.str):this.deletes(c)?(h!=="delete"&&(d(),h="delete"),m+=c.length):c.deleted||(h!=="retain"&&(d(),h="retain"),u+=c.length);break;case le:{const{key:w,value:E}=c.content;if(this.adds(c)){if(!this.deletes(c)){const x=s.get(w)??null;wt(x,E)?E!==null&&c.delete(r):(h==="retain"&&d(),wt(E,i.get(w)??null)?delete f[w]:f[w]=E)}}else if(this.deletes(c)){i.set(w,E);const x=s.get(w)??null;wt(x,E)||(h==="retain"&&d(),f[w]=x)}else if(!c.deleted){i.set(w,E);const x=f[w];x!==void 0&&(wt(x,E)?x!==null&&c.delete(r):(h==="retain"&&d(),E===null?delete f[w]:f[w]=E))}c.deleted||(h==="insert"&&d(),xn(s,c.content));break}}c=c.right}for(d();n.length>0;){const w=n[n.length-1];if(w.retain!==void 0&&w.attributes===void 0)n.pop();else break}}),this._delta=n}return this._delta}}class dn extends we{constructor(e){super(),this._pending=e!==void 0?[()=>this.insert(0,e)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??Ee(),this._length}_integrate(e,n){super._integrate(e,n);try{this._pending.forEach(r=>r())}catch(r){console.error(r)}this._pending=null}_copy(){return new dn}clone(){const e=new dn;return e.applyDelta(this.toDelta()),e}_callObserver(e,n){super._callObserver(e,n);const r=new Dh(this,e,n);fs(this,e,r),!e.local&&this._hasFormatting&&(e._needFormattingCleanup=!0)}toString(){this.doc??Ee();let e="",n=this._start;for(;n!==null;)!n.deleted&&n.countable&&n.content.constructor===Ze&&(e+=n.content.str),n=n.right;return e}toJSON(){return this.toString()}applyDelta(e,{sanitize:n=!0}={}){this.doc!==null?G(this.doc,r=>{const s=new Ws(null,this._start,0,new Map);for(let i=0;i<e.length;i++){const c=e[i];if(c.insert!==void 0){const h=!n&&typeof c.insert=="string"&&i===e.length-1&&s.right===null&&c.insert.slice(-1)===`
`?c.insert.slice(0,-1):c.insert;(typeof h!="string"||h.length>0)&&Rs(r,this,s,h,c.attributes||{})}else c.retain!==void 0?lo(r,this,s,c.retain,c.attributes||{}):c.delete!==void 0&&uo(r,s,c.delete)}}):this._pending.push(()=>this.applyDelta(e))}toDelta(e,n,r){this.doc??Ee();const s=[],i=new Map,c=this.doc;let h="",f=this._start;function g(){if(h.length>0){const m={};let d=!1;i.forEach((E,x)=>{d=!0,m[x]=E});const w={insert:h};d&&(w.attributes=m),s.push(w),h=""}}const u=()=>{for(;f!==null;){if(Jt(f,e)||n!==void 0&&Jt(f,n))switch(f.content.constructor){case Ze:{const m=i.get("ychange");e!==void 0&&!Jt(f,e)?(m===void 0||m.user!==f.id.client||m.type!=="removed")&&(g(),i.set("ychange",r?r("removed",f.id):{type:"removed"})):n!==void 0&&!Jt(f,n)?(m===void 0||m.user!==f.id.client||m.type!=="added")&&(g(),i.set("ychange",r?r("added",f.id):{type:"added"})):m!==void 0&&(g(),i.delete("ychange")),h+=f.content.str;break}case ht:case Lt:{g();const m={insert:f.content.getContent()[0]};if(i.size>0){const d={};m.attributes=d,i.forEach((w,E)=>{d[E]=w})}s.push(m);break}case le:Jt(f,e)&&(g(),xn(i,f.content));break}f=f.right}g()};return e||n?G(c,m=>{e&&zs(m,e),n&&zs(m,n),u()},"cleanup"):u(),s}insert(e,n,r){if(n.length<=0)return;const s=this.doc;s!==null?G(s,i=>{const c=Er(i,this,e,!r);r||(r={},c.currentAttributes.forEach((h,f)=>{r[f]=h})),Rs(i,this,c,n,r)}):this._pending.push(()=>this.insert(e,n,r))}insertEmbed(e,n,r){const s=this.doc;s!==null?G(s,i=>{const c=Er(i,this,e,!r);Rs(i,this,c,n,r||{})}):this._pending.push(()=>this.insertEmbed(e,n,r||{}))}delete(e,n){if(n===0)return;const r=this.doc;r!==null?G(r,s=>{uo(s,Er(s,this,e,!0),n)}):this._pending.push(()=>this.delete(e,n))}format(e,n,r){if(n===0)return;const s=this.doc;s!==null?G(s,i=>{const c=Er(i,this,e,!1);c.right!==null&&lo(i,this,c,n,r)}):this._pending.push(()=>this.format(e,n,r))}removeAttribute(e){this.doc!==null?G(this.doc,n=>{Jr(n,this,e)}):this._pending.push(()=>this.removeAttribute(e))}setAttribute(e,n){this.doc!==null?G(this.doc,r=>{vi(r,this,e,n)}):this._pending.push(()=>this.setAttribute(e,n))}getAttribute(e){return Ii(this,e)}getAttributes(){return ja(this)}_write(e){e.writeTypeRef(Xh)}}const Oh=t=>new dn;class Us{constructor(e,n=()=>!0){this._filter=n,this._root=e,this._currentNode=e._start,this._firstCall=!0,e.doc??Ee()}[Symbol.iterator](){return this}next(){let e=this._currentNode,n=e&&e.content&&e.content.type;if(e!==null&&(!this._firstCall||e.deleted||!this._filter(n)))do if(n=e.content.type,!e.deleted&&(n.constructor===pn||n.constructor===Ot)&&n._start!==null)e=n._start;else for(;e!==null;){const r=e.next;if(r!==null){e=r;break}else e.parent===this._root?e=null:e=e.parent._item}while(e!==null&&(e.deleted||!this._filter(e.content.type)));return this._firstCall=!1,e===null?{value:void 0,done:!0}:(this._currentNode=e,{value:e.content.type,done:!1})}}class Ot extends we{constructor(){super(),this._prelimContent=[]}get firstChild(){const e=this._first;return e?e.content.getContent()[0]:null}_integrate(e,n){super._integrate(e,n),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Ot}clone(){const e=new Ot;return e.insert(0,this.toArray().map(n=>n instanceof we?n.clone():n)),e}get length(){return this.doc??Ee(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(e){return new Us(this,e)}querySelector(e){e=e.toUpperCase();const r=new Us(this,s=>s.nodeName&&s.nodeName.toUpperCase()===e).next();return r.done?null:r.value}querySelectorAll(e){return e=e.toUpperCase(),yt(new Us(this,n=>n.nodeName&&n.nodeName.toUpperCase()===e))}_callObserver(e,n){fs(this,e,new Bh(this,n,e))}toString(){return Na(this,e=>e.toString()).join("")}toJSON(){return this.toString()}toDOM(e=document,n={},r){const s=e.createDocumentFragment();return r!==void 0&&r._createAssociation(s,this),Wn(this,i=>{s.insertBefore(i.toDOM(e,n,r),null)}),s}insert(e,n){this.doc!==null?G(this.doc,r=>{Pa(r,this,e,n)}):this._prelimContent.splice(e,0,...n)}insertAfter(e,n){if(this.doc!==null)G(this.doc,r=>{const s=e&&e instanceof we?e._item:e;Gr(r,this,s,n)});else{const r=this._prelimContent,s=e===null?0:r.findIndex(i=>i===e)+1;if(s===0&&e!==null)throw Ve("Reference item not found");r.splice(s,0,...n)}}delete(e,n=1){this.doc!==null?G(this.doc,r=>{Va(r,this,e,n)}):this._prelimContent.splice(e,n)}toArray(){return La(this)}push(e){this.insert(this.length,e)}unshift(e){this.insert(0,e)}get(e){return Fa(this,e)}slice(e=0,n=this.length){return Ba(this,e,n)}forEach(e){Wn(this,e)}_write(e){e.writeTypeRef(Qh)}}const Rh=t=>new Ot;class pn extends Ot{constructor(e="UNDEFINED"){super(),this.nodeName=e,this._prelimAttrs=new Map}get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_integrate(e,n){super._integrate(e,n),this._prelimAttrs.forEach((r,s)=>{this.setAttribute(s,r)}),this._prelimAttrs=null}_copy(){return new pn(this.nodeName)}clone(){const e=new pn(this.nodeName),n=this.getAttributes();return Fl(n,(r,s)=>{e.setAttribute(s,r)}),e.insert(0,this.toArray().map(r=>r instanceof we?r.clone():r)),e}toString(){const e=this.getAttributes(),n=[],r=[];for(const h in e)r.push(h);r.sort();const s=r.length;for(let h=0;h<s;h++){const f=r[h];n.push(f+'="'+e[f]+'"')}const i=this.nodeName.toLocaleLowerCase(),c=n.length>0?" "+n.join(" "):"";return`<${i}${c}>${super.toString()}</${i}>`}removeAttribute(e){this.doc!==null?G(this.doc,n=>{Jr(n,this,e)}):this._prelimAttrs.delete(e)}setAttribute(e,n){this.doc!==null?G(this.doc,r=>{vi(r,this,e,n)}):this._prelimAttrs.set(e,n)}getAttribute(e){return Ii(this,e)}hasAttribute(e){return Ha(this,e)}getAttributes(e){return e?xh(this,e):ja(this)}toDOM(e=document,n={},r){const s=e.createElement(this.nodeName),i=this.getAttributes();for(const c in i){const h=i[c];typeof h=="string"&&s.setAttribute(c,h)}return Wn(this,c=>{s.appendChild(c.toDOM(e,n,r))}),r!==void 0&&r._createAssociation(s,this),s}_write(e){e.writeTypeRef(Zh),e.writeKey(this.nodeName)}}const Uh=t=>new pn(t.readKey());class Bh extends us{constructor(e,n,r){super(e,r),this.childListChanged=!1,this.attributesChanged=new Set,n.forEach(s=>{s===null?this.childListChanged=!0:this.attributesChanged.add(s)})}}class zr extends fn{constructor(e){super(),this.hookName=e}_copy(){return new zr(this.hookName)}clone(){const e=new zr(this.hookName);return this.forEach((n,r)=>{e.set(r,n)}),e}toDOM(e=document,n={},r){const s=n[this.hookName];let i;return s!==void 0?i=s.createDom(this):i=document.createElement(this.hookName),i.setAttribute("data-yjs-hook",this.hookName),r!==void 0&&r._createAssociation(i,this),i}_write(e){e.writeTypeRef(ef),e.writeKey(this.hookName)}}const Lh=t=>new zr(t.readKey());class Yr extends dn{get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_copy(){return new Yr}clone(){const e=new Yr;return e.applyDelta(this.toDelta()),e}toDOM(e=document,n,r){const s=e.createTextNode(this.toString());return r!==void 0&&r._createAssociation(s,this),s}toString(){return this.toDelta().map(e=>{const n=[];for(const s in e.attributes){const i=[];for(const c in e.attributes[s])i.push({key:c,value:e.attributes[s][c]});i.sort((c,h)=>c.key<h.key?-1:1),n.push({nodeName:s,attrs:i})}n.sort((s,i)=>s.nodeName<i.nodeName?-1:1);let r="";for(let s=0;s<n.length;s++){const i=n[s];r+=`<${i.nodeName}`;for(let c=0;c<i.attrs.length;c++){const h=i.attrs[c];r+=` ${h.key}="${h.value}"`}r+=">"}r+=e.insert;for(let s=n.length-1;s>=0;s--)r+=`</${n[s].nodeName}>`;return r}).join("")}toJSON(){return this.toString()}_write(e){e.writeTypeRef(tf)}}const Nh=t=>new Yr;class Ci{constructor(e,n){this.id=e,this.length=n}get deleted(){throw $e()}mergeWith(e){return!1}write(e,n,r){throw $e()}integrate(e,n){throw $e()}}const Fh=0;class Ue extends Ci{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,n){n>0&&(this.id.clock+=n,this.length-=n),Ta(e.doc.store,this)}write(e,n){e.writeInfo(Fh),e.writeLen(this.length-n)}getMissing(e,n){return null}}class fr{constructor(e){this.content=e}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new fr(this.content)}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeBuf(this.content)}getRef(){return 3}}const $h=t=>new fr(t.readBuf());class Kn{constructor(e){this.len=e}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new Kn(this.len)}splice(e){const n=new Kn(this.len-e);return this.len=e,n}mergeWith(e){return this.len+=e.len,!0}integrate(e,n){Hr(e.deleteSet,n.id.client,n.id.clock,this.len),n.markDeleted()}delete(e){}gc(e){}write(e,n){e.writeLen(this.len-n)}getRef(){return 1}}const Ph=t=>new Kn(t.readLen()),Ya=(t,e)=>new _n({guid:t,...e,shouldLoad:e.shouldLoad||e.autoLoad||!1});class dr{constructor(e){e._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=e;const n={};this.opts=n,e.gc||(n.gc=!1),e.autoLoad&&(n.autoLoad=!0),e.meta!==null&&(n.meta=e.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new dr(Ya(this.doc.guid,this.opts))}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){this.doc._item=n,e.subdocsAdded.add(this.doc),this.doc.shouldLoad&&e.subdocsLoaded.add(this.doc)}delete(e){e.subdocsAdded.has(this.doc)?e.subdocsAdded.delete(this.doc):e.subdocsRemoved.add(this.doc)}gc(e){}write(e,n){e.writeString(this.doc.guid),e.writeAny(this.opts)}getRef(){return 9}}const Vh=t=>new dr(Ya(t.readString(),t.readAny()));class Lt{constructor(e){this.embed=e}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new Lt(this.embed)}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeJSON(this.embed)}getRef(){return 5}}const jh=t=>new Lt(t.readJSON());class le{constructor(e,n){this.key=e,this.value=n}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new le(this.key,this.value)}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){const r=n.parent;r._searchMarker=null,r._hasFormatting=!0}delete(e){}gc(e){}write(e,n){e.writeKey(this.key),e.writeJSON(this.value)}getRef(){return 6}}const Hh=t=>new le(t.readKey(),t.readJSON());class Wr{constructor(e){this.arr=e}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Wr(this.arr)}splice(e){const n=new Wr(this.arr.slice(e));return this.arr=this.arr.slice(0,e),n}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){const r=this.arr.length;e.writeLen(r-n);for(let s=n;s<r;s++){const i=this.arr[s];e.writeString(i===void 0?"undefined":JSON.stringify(i))}}getRef(){return 2}}const qh=t=>{const e=t.readLen(),n=[];for(let r=0;r<e;r++){const s=t.readString();s==="undefined"?n.push(void 0):n.push(JSON.parse(s))}return new Wr(n)},Gh=Pr("node_env")==="development";class Rt{constructor(e){this.arr=e,Gh&&Yo(e)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Rt(this.arr)}splice(e){const n=new Rt(this.arr.slice(e));return this.arr=this.arr.slice(0,e),n}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){const r=this.arr.length;e.writeLen(r-n);for(let s=n;s<r;s++){const i=this.arr[s];e.writeAny(i)}}getRef(){return 8}}const Jh=t=>{const e=t.readLen(),n=[];for(let r=0;r<e;r++)n.push(t.readAny());return new Rt(n)};class Ze{constructor(e){this.str=e}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new Ze(this.str)}splice(e){const n=new Ze(this.str.slice(e));this.str=this.str.slice(0,e);const r=this.str.charCodeAt(e-1);return r>=55296&&r<=56319&&(this.str=this.str.slice(0,e-1)+"",n.str=""+n.str.slice(1)),n}mergeWith(e){return this.str+=e.str,!0}integrate(e,n){}delete(e){}gc(e){}write(e,n){e.writeString(n===0?this.str:this.str.slice(n))}getRef(){return 4}}const zh=t=>new Ze(t.readString()),Yh=[Sh,Ih,Oh,Uh,Rh,Lh,Nh],Wh=0,Kh=1,Xh=2,Zh=3,Qh=4,ef=5,tf=6;class ht{constructor(e){this.type=e}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new ht(this.type._copy())}splice(e){throw $e()}mergeWith(e){return!1}integrate(e,n){this.type._integrate(e.doc,n)}delete(e){let n=this.type._start;for(;n!==null;)n.deleted?n.id.clock<(e.beforeState.get(n.id.client)||0)&&e._mergeStructs.push(n):n.delete(e),n=n.right;this.type._map.forEach(r=>{r.deleted?r.id.clock<(e.beforeState.get(r.id.client)||0)&&e._mergeStructs.push(r):r.delete(e)}),e.changed.delete(this.type)}gc(e){let n=this.type._start;for(;n!==null;)n.gc(e,!0),n=n.right;this.type._start=null,this.type._map.forEach(r=>{for(;r!==null;)r.gc(e,!0),r=r.left}),this.type._map=new Map}write(e,n){this.type._write(e)}getRef(){return 7}}const nf=t=>new ht(Yh[t.readTypeRef()](t)),Kr=(t,e,n)=>{const{client:r,clock:s}=e.id,i=new ce(L(r,s+n),e,L(r,s+n-1),e.right,e.rightOrigin,e.parent,e.parentSub,e.content.splice(n));return e.deleted&&i.markDeleted(),e.keep&&(i.keep=!0),e.redone!==null&&(i.redone=L(e.redone.client,e.redone.clock+n)),e.right=i,i.right!==null&&(i.right.left=i),t._mergeStructs.push(i),i.parentSub!==null&&i.right===null&&i.parent._map.set(i.parentSub,i),e.length=n,i};class ce extends Ci{constructor(e,n,r,s,i,c,h,f){super(e,f.getLength()),this.origin=r,this.left=n,this.right=s,this.rightOrigin=i,this.parent=c,this.parentSub=h,this.redone=null,this.content=f,this.info=this.content.isCountable()?Hi:0}set marker(e){(this.info&vs)>0!==e&&(this.info^=vs)}get marker(){return(this.info&vs)>0}get keep(){return(this.info&ji)>0}set keep(e){this.keep!==e&&(this.info^=ji)}get countable(){return(this.info&Hi)>0}get deleted(){return(this.info&Ss)>0}set deleted(e){this.deleted!==e&&(this.info^=Ss)}markDeleted(){this.info|=Ss}getMissing(e,n){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=pe(n,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=pe(n,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===nn&&this.id.client!==this.parent.client&&this.parent.clock>=pe(n,this.parent.client))return this.parent.client;if(this.origin&&(this.left=so(e,n,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=bt(e,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===Ue||this.right&&this.right.constructor===Ue)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===ce?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===ce&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===nn){const r=Os(n,this.parent);r.constructor===Ue?this.parent=null:this.parent=r.content.type}return null}integrate(e,n){if(n>0&&(this.id.clock+=n,this.left=so(e,e.doc.store,L(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(n),this.length-=n),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let r=this.left,s;if(r!==null)s=r.right;else if(this.parentSub!==null)for(s=this.parent._map.get(this.parentSub)||null;s!==null&&s.left!==null;)s=s.left;else s=this.parent._start;const i=new Set,c=new Set;for(;s!==null&&s!==this.right;){if(c.add(s),i.add(s),yr(this.origin,s.origin)){if(s.id.client<this.id.client)r=s,i.clear();else if(yr(this.rightOrigin,s.rightOrigin))break}else if(s.origin!==null&&c.has(Os(e.doc.store,s.origin)))i.has(Os(e.doc.store,s.origin))||(r=s,i.clear());else break;s=s.right}this.left=r}if(this.left!==null){const r=this.left.right;this.right=r,this.left.right=this}else{let r;if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start,this.parent._start=this;this.right=r}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(e)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),Ta(e.doc.store,this),this.content.integrate(e,this),oo(e,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(e)}else new Ue(this.id,this.length).integrate(e,0)}get next(){let e=this.right;for(;e!==null&&e.deleted;)e=e.right;return e}get prev(){let e=this.left;for(;e!==null&&e.deleted;)e=e.left;return e}get lastId(){return this.length===1?this.id:L(this.id.client,this.id.clock+this.length-1)}mergeWith(e){if(this.constructor===e.constructor&&yr(e.origin,this.lastId)&&this.right===e&&yr(this.rightOrigin,e.rightOrigin)&&this.id.client===e.id.client&&this.id.clock+this.length===e.id.clock&&this.deleted===e.deleted&&this.redone===null&&e.redone===null&&this.content.constructor===e.content.constructor&&this.content.mergeWith(e.content)){const n=this.parent._searchMarker;return n&&n.forEach(r=>{r.p===e&&(r.p=this,!this.deleted&&this.countable&&(r.index-=this.length))}),e.keep&&(this.keep=!0),this.right=e.right,this.right!==null&&(this.right.left=this),this.length+=e.length,!0}return!1}delete(e){if(!this.deleted){const n=this.parent;this.countable&&this.parentSub===null&&(n._length-=this.length),this.markDeleted(),Hr(e.deleteSet,this.id.client,this.id.clock,this.length),oo(e,n,this.parentSub),this.content.delete(e)}}gc(e,n){if(!this.deleted)throw Le();this.content.gc(e),n?ah(e,this,new Ue(this.id,this.length)):this.content=new Kn(this.length)}write(e,n){const r=n>0?L(this.id.client,this.id.clock+n-1):this.origin,s=this.rightOrigin,i=this.parentSub,c=this.content.getRef()&es|(r===null?0:Te)|(s===null?0:it)|(i===null?0:Vn);if(e.writeInfo(c),r!==null&&e.writeLeftID(r),s!==null&&e.writeRightID(s),r===null&&s===null){const h=this.parent;if(h._item!==void 0){const f=h._item;if(f===null){const g=ih(h);e.writeParentInfo(!0),e.writeString(g)}else e.writeParentInfo(!1),e.writeLeftID(f.id)}else h.constructor===String?(e.writeParentInfo(!0),e.writeString(h)):h.constructor===nn?(e.writeParentInfo(!1),e.writeLeftID(h)):Le();i!==null&&e.writeString(i)}this.content.write(e,n)}}const Wa=(t,e)=>rf[e&es](t),rf=[()=>{Le()},Ph,qh,$h,zh,jh,Hh,nf,Jh,Vh,()=>{Le()}],sf=10;class Be extends Ci{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,n){Le()}write(e,n){e.writeInfo(sf),$(e.restEncoder,this.length-n)}getMissing(e,n){return null}}const Ka=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof Vi<"u"?Vi:{},Xa="__ $YJS$ __";Ka[Xa]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");Ka[Xa]=!0;const Nt=t=>ln((e,n)=>{t.onerror=r=>n(new Error(r.target.error)),t.onsuccess=r=>e(r.target.result)}),of=(t,e)=>ln((n,r)=>{const s=indexedDB.open(t);s.onupgradeneeded=i=>e(i.target.result),s.onerror=i=>r(Ve(i.target.error)),s.onsuccess=i=>{const c=i.target.result;c.onversionchange=()=>{c.close()},n(c)}}),af=t=>Nt(indexedDB.deleteDatabase(t)),cf=(t,e)=>e.forEach(n=>t.createObjectStore.apply(t,n)),Rn=(t,e,n="readwrite")=>{const r=t.transaction(e,n);return e.map(s=>mf(r,s))},Za=(t,e)=>Nt(t.count(e)),lf=(t,e)=>Nt(t.get(e)),Qa=(t,e)=>Nt(t.delete(e)),uf=(t,e,n)=>Nt(t.put(e,n)),Ks=(t,e)=>Nt(t.add(e)),hf=(t,e,n)=>Nt(t.getAll(e,n)),ff=(t,e,n)=>{let r=null;return gf(t,e,s=>(r=s,!1),n).then(()=>r)},df=(t,e=null)=>ff(t,e,"prev"),pf=(t,e)=>ln((n,r)=>{t.onerror=r,t.onsuccess=async s=>{const i=s.target.result;if(i===null||await e(i)===!1)return n();i.continue()}}),gf=(t,e,n,r="next")=>pf(t.openKeyCursor(e,r),s=>n(s.key)),mf=(t,e)=>t.objectStore(e),wf=(t,e)=>IDBKeyRange.upperBound(t,e),yf=(t,e)=>IDBKeyRange.lowerBound(t,e),Bs="custom",ec="updates",tc=500,nc=(t,e=()=>{},n=()=>{})=>{const[r]=Rn(t.db,[ec]);return hf(r,yf(t._dbref,!1)).then(s=>{t._destroyed||(e(r),G(t.doc,()=>{s.forEach(i=>eh(t.doc,i))},t,!1),n(r))}).then(()=>df(r).then(s=>{t._dbref=s+1})).then(()=>Za(r).then(s=>{t._dbsize=s})).then(()=>r)},bf=(t,e=!0)=>nc(t).then(n=>{(e||t._dbsize>=tc)&&Ks(n,Sa(t.doc)).then(()=>Qa(n,wf(t._dbref,!0))).then(()=>Za(n).then(r=>{t._dbsize=r}))});class Ef extends Zc{constructor(e,n){super(),this.doc=n,this.name=e,this._dbref=0,this._dbsize=0,this._destroyed=!1,this.db=null,this.synced=!1,this._db=of(e,r=>cf(r,[["updates",{autoIncrement:!0}],["custom"]])),this.whenSynced=ln(r=>this.on("synced",()=>r(this))),this._db.then(r=>{this.db=r,nc(this,c=>Ks(c,Sa(n)),()=>{if(this._destroyed)return this;this.synced=!0,this.emit("synced",[this])})}),this._storeTimeout=1e3,this._storeTimeoutId=null,this._storeUpdate=(r,s)=>{if(this.db&&s!==this){const[i]=Rn(this.db,[ec]);Ks(i,r),++this._dbsize>=tc&&(this._storeTimeoutId!==null&&clearTimeout(this._storeTimeoutId),this._storeTimeoutId=setTimeout(()=>{bf(this,!1),this._storeTimeoutId=null},this._storeTimeout))}},n.on("update",this._storeUpdate),this.destroy=this.destroy.bind(this),n.on("destroy",this.destroy)}destroy(){return this._storeTimeoutId&&clearTimeout(this._storeTimeoutId),this.doc.off("update",this._storeUpdate),this.doc.off("destroy",this.destroy),this._destroyed=!0,this._db.then(e=>{e.close()})}clearData(){return this.destroy().then(()=>{af(this.name)})}get(e){return this._db.then(n=>{const[r]=Rn(n,[Bs],"readonly");return lf(r,e)})}set(e,n){return this._db.then(r=>{const[s]=Rn(r,[Bs]);return uf(s,n,e)})}del(e){return this._db.then(n=>{const[r]=Rn(n,[Bs]);return Qa(r,e)})}}const rc="schwalbvault",Et=new _n,kf=typeof window<"u",Or=kf?new Ef(rc,Et):null,_f=Et.getMap("characters"),Un=Et.getMap("campaigns"),xf=Et.getMap("enemies"),Af=Et.getMap("encounters"),Sf=Et.getMap("images"),vf=Et.getMap("deletedIds"),If=()=>new Promise(t=>{if(!Or){t();return}Or.synced?t():Or.on("synced",()=>{t()})}),Mp=Object.freeze(Object.defineProperty({__proto__:null,campaignsMap:Un,charactersMap:_f,deletedIdsMap:vf,doc:Et,encountersMap:Af,enemiesMap:xf,imagesMap:Sf,provider:Or,waitForSync:If},Symbol.toStringTag,{value:"Module"}));const kr="0123456789abcdef";class It{constructor(e){this.bytes=e}static ofInner(e){if(e.length!==16)throw new TypeError("not 128-bit length");return new It(e)}static fromFieldsV7(e,n,r,s){if(!Number.isInteger(e)||!Number.isInteger(n)||!Number.isInteger(r)||!Number.isInteger(s)||e<0||n<0||r<0||s<0||e>0xffffffffffff||n>4095||r>1073741823||s>4294967295)throw new RangeError("invalid field value");const i=new Uint8Array(16);return i[0]=e/2**40,i[1]=e/2**32,i[2]=e/2**24,i[3]=e/2**16,i[4]=e/2**8,i[5]=e,i[6]=112|n>>>8,i[7]=n,i[8]=128|r>>>24,i[9]=r>>>16,i[10]=r>>>8,i[11]=r,i[12]=s>>>24,i[13]=s>>>16,i[14]=s>>>8,i[15]=s,new It(i)}static parse(e){var n,r,s,i;let c;switch(e.length){case 32:c=(n=/^[0-9a-f]{32}$/i.exec(e))===null||n===void 0?void 0:n[0];break;case 36:c=(r=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||r===void 0?void 0:r.slice(1,6).join("");break;case 38:c=(s=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(e))===null||s===void 0?void 0:s.slice(1,6).join("");break;case 45:c=(i=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(e))===null||i===void 0?void 0:i.slice(1,6).join("");break}if(c){const h=new Uint8Array(16);for(let f=0;f<16;f+=4){const g=parseInt(c.substring(2*f,2*f+8),16);h[f+0]=g>>>24,h[f+1]=g>>>16,h[f+2]=g>>>8,h[f+3]=g}return new It(h)}else throw new SyntaxError("could not parse UUID string")}toString(){let e="";for(let n=0;n<this.bytes.length;n++)e+=kr.charAt(this.bytes[n]>>>4),e+=kr.charAt(this.bytes[n]&15),(n===3||n===5||n===7||n===9)&&(e+="-");return e}toHex(){let e="";for(let n=0;n<this.bytes.length;n++)e+=kr.charAt(this.bytes[n]>>>4),e+=kr.charAt(this.bytes[n]&15);return e}toJSON(){return this.toString()}getVariant(){const e=this.bytes[8]>>>4;if(e<0)throw new Error("unreachable");if(e<=7)return this.bytes.every(n=>n===0)?"NIL":"VAR_0";if(e<=11)return"VAR_10";if(e<=13)return"VAR_110";if(e<=15)return this.bytes.every(n=>n===255)?"MAX":"VAR_RESERVED";throw new Error("unreachable")}getVersion(){return this.getVariant()==="VAR_10"?this.bytes[6]>>>4:void 0}clone(){return new It(this.bytes.slice(0))}equals(e){return this.compareTo(e)===0}compareTo(e){for(let n=0;n<16;n++){const r=this.bytes[n]-e.bytes[n];if(r!==0)return Math.sign(r)}return 0}}class Cf{constructor(e){this.timestamp_biased=0,this.counter=0,this.random=e??Tf()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(e,n){let r=this.generateOrAbortCore(e,n);return r===void 0&&(this.timestamp_biased=0,r=this.generateOrAbortCore(e,n)),r}generateOrAbortCore(e,n){if(!Number.isInteger(e)||e<0||e>0xffffffffffff)throw new RangeError("`unixTsMs` must be a 48-bit unsigned integer");if(n<0||n>0xffffffffffff)throw new RangeError("`rollbackAllowance` out of reasonable range");if(e++,e>this.timestamp_biased)this.timestamp_biased=e,this.resetCounter();else if(e+n>=this.timestamp_biased)this.counter++,this.counter>4398046511103&&(this.timestamp_biased++,this.resetCounter());else return;return It.fromFieldsV7(this.timestamp_biased-1,Math.trunc(this.counter/2**30),this.counter&2**30-1,this.random.nextUint32())}resetCounter(){this.counter=this.random.nextUint32()*1024+(this.random.nextUint32()&1023)}generateV4(){const e=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return e[6]=64|e[6]>>>4,e[8]=128|e[8]>>>2,It.ofInner(e)}}const Tf=()=>{if(typeof crypto<"u"&&typeof crypto.getRandomValues<"u")return new Mf;if(typeof UUIDV7_DENY_WEAK_RNG<"u"&&UUIDV7_DENY_WEAK_RNG)throw new Error("no cryptographically strong RNG available");return{nextUint32:()=>Math.trunc(Math.random()*65536)*65536+Math.trunc(Math.random()*65536)}};class Mf{constructor(){this.buffer=new Uint32Array(8),this.cursor=65535}nextUint32(){return this.cursor>=this.buffer.length&&(crypto.getRandomValues(this.buffer),this.cursor=0),this.buffer[this.cursor++]}}let ho;const $n=()=>Df().toString(),Df=()=>(ho||(ho=new Cf)).generate(),{floor:Of,random:Rf}=Math,Xn="Trystero",Zn=(t,e)=>Array(t).fill().map(e),fo="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",sc=t=>Zn(t,()=>fo[Of(Rf()*fo.length)]).join(""),zt=sc(20),At=Promise.all.bind(Promise),ic=typeof window<"u",{entries:Xs,fromEntries:oc,keys:Uf}=Object,tt=()=>{},nt=t=>new Error(`${Xn}: ${t}`),Bf=new TextEncoder,Lf=new TextDecoder,sn=t=>Bf.encode(t),Rr=t=>Lf.decode(t),_r=(...t)=>t.join("@"),Nf=(t,e,n,r)=>(t.relayUrls||e).slice(0,t.relayUrls?t.relayUrls.length:t.relayRedundancy||n),Qn=JSON.stringify,er=JSON.parse,po=3333,xr={};let Pn=null,Zs=null;const Ff=()=>{Pn||(Pn=new Promise(t=>{Zs=t}).finally(()=>{Zs=null,Pn=null}))},$f=()=>Zs?.(),Pf=(t,e)=>{const n={},r=()=>{const s=new WebSocket(t);s.onclose=()=>{if(Pn){Pn.then(r);return}xr[t]??=po,setTimeout(r,xr[t]),xr[t]*=2},s.onmessage=i=>e(i.data),n.socket=s,n.url=s.url,n.ready=new Promise(i=>s.onopen=()=>{i(n),xr[t]=po}),n.send=i=>{s.readyState===1&&s.send(i)}};return r(),n},Vf=()=>{if(ic){const t=new AbortController;return addEventListener("online",$f,{signal:t.signal}),addEventListener("offline",Ff,{signal:t.signal}),()=>t.abort()}return tt},Ti="AES-GCM",jf={},Hf=t=>btoa(String.fromCharCode.apply(null,new Uint8Array(t))),qf=t=>{const e=atob(t);return new Uint8Array(e.length).map((n,r)=>e.charCodeAt(r)).buffer},Gf=async(t,e)=>new Uint8Array(await crypto.subtle.digest(t,sn(e))),Bn=async t=>jf[t]||=Array.from(await Gf("SHA-1",t)).map(e=>e.toString(36)).join(""),Jf=async(t,e,n)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},sn(`${t}:${e}:${n}`)),{name:Ti},!1,["encrypt","decrypt"]),ac="$",cc=",",zf=async(t,e)=>{const n=crypto.getRandomValues(new Uint8Array(16));return n.join(cc)+ac+Hf(await crypto.subtle.encrypt({name:Ti,iv:n},await t,sn(e)))},Yf=async(t,e)=>{const[n,r]=e.split(ac);return Rr(await crypto.subtle.decrypt({name:Ti,iv:new Uint8Array(n.split(cc))},await t,qf(r)))},Wf=5e3,go="icegatheringstatechange",mo="offer",Kf="answer",wo=(t,{rtcConfig:e,rtcPolyfill:n,turnConfig:r})=>{const s=new(n||RTCPeerConnection)({iceServers:Xf.concat(r||[]),...e}),i={};let c=!1,h=!1,f=null;const g=m=>{m.binaryType="arraybuffer",m.bufferedAmountLowThreshold=65535,m.onmessage=d=>i.data?.(d.data),m.onopen=()=>i.connect?.(),m.onclose=()=>i.close?.(),m.onerror=d=>i.error?.(d)},u=m=>Promise.race([new Promise(d=>{const w=()=>{m.iceGatheringState==="complete"&&(m.removeEventListener(go,w),d())};m.addEventListener(go,w),w()}),new Promise(d=>setTimeout(d,Wf))]).then(()=>({type:m.localDescription.type,sdp:m.localDescription.sdp.replace(/a=ice-options:trickle\s\n/g,"")}));return t?(f=s.createDataChannel("data"),g(f)):s.ondatachannel=({channel:m})=>{f=m,g(m)},s.onnegotiationneeded=async()=>{try{c=!0,await s.setLocalDescription();const m=await u(s);i.signal?.(m)}catch(m){i.error?.(m)}finally{c=!1}},s.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(s.connectionState)&&i.close?.()},s.ontrack=m=>{i.track?.(m.track,m.streams[0]),i.stream?.(m.streams[0])},s.onremovestream=m=>i.stream?.(m.stream),t&&(s.canTrickleIceCandidates||s.onnegotiationneeded()),{created:Date.now(),connection:s,get channel(){return f},get isDead(){return s.connectionState==="closed"},async signal(m){if(!(f?.readyState==="open"&&!m.sdp?.includes("a=rtpmap")))try{if(m.type===mo){if(c||s.signalingState!=="stable"&&!h){if(t)return;await At([s.setLocalDescription({type:"rollback"}),s.setRemoteDescription(m)])}else await s.setRemoteDescription(m);await s.setLocalDescription();const d=await u(s);return i.signal?.(d),d}else if(m.type===Kf){h=!0;try{await s.setRemoteDescription(m)}finally{h=!1}}}catch(d){i.error?.(d)}},sendData:m=>f.send(m),destroy:()=>{f?.close(),s.close(),c=!1,h=!1},setHandlers:m=>Object.assign(i,m),offerPromise:t?new Promise(m=>i.signal=d=>{d.type===mo&&m(d)}):Promise.resolve(),addStream:m=>m.getTracks().forEach(d=>s.addTrack(d,m)),removeStream:m=>s.getSenders().filter(d=>m.getTracks().includes(d.track)).forEach(d=>s.removeTrack(d)),addTrack:(m,d)=>s.addTrack(m,d),removeTrack:m=>{const d=s.getSenders().find(w=>w.track===m);d&&s.removeTrack(d)},replaceTrack:(m,d)=>{const w=s.getSenders().find(E=>E.track===m);if(w)return w.replaceTrack(d)}}},Xf=[...Zn(3,(t,e)=>`stun:stun${e||""}.l.google.com:19302`),"stun:stun.cloudflare.com:3478"].map(t=>({urls:t})),Zf=Object.getPrototypeOf(Uint8Array),Ur=12,lc=0,Br=lc+Ur,Lr=Br+1,Ln=Lr+1,Nn=Ln+1,_t=16*2**10-Nn,Ar=255,yo="bufferedamountlow",Gt=t=>"@_"+t,Qf=(t,e,n)=>{const r={},s={},i={},c={},h={},f={},g={},u={onPeerJoin:tt,onPeerLeave:tt,onPeerStream:tt,onPeerTrack:tt},m=(_,S)=>(_?Array.isArray(_)?_:[_]:Uf(r)).flatMap(R=>{const N=r[R];return N?S(R,N):(console.warn(`${Xn}: no peer with id ${R} found`),[])}),d=_=>{r[_]&&(r[_].destroy(),delete r[_],delete c[_],delete h[_],u.onPeerLeave(_),e(_))},w=_=>{if(s[_])return i[_];if(!_)throw nt("action type argument is required");const S=sn(_);if(S.byteLength>Ur)throw nt(`action type string "${_}" (${S.byteLength}b) exceeds byte limit (${Ur}). Hint: choose a shorter name.`);const R=new Uint8Array(Ur);R.set(S);let N=0;return s[_]={onComplete:tt,onProgress:tt,setOnComplete:J=>s[_]={...s[_],onComplete:J},setOnProgress:J=>s[_]={...s[_],onProgress:J},send:async(J,v,M,Z)=>{if(M&&typeof M!="object")throw nt("action meta argument must be an object");const ye=typeof J;if(ye==="undefined")throw nt("action data cannot be undefined");const ue=ye!=="string",Ne=J instanceof Blob,j=Ne||J instanceof ArrayBuffer||J instanceof Zf;if(M&&!j)throw nt("action meta argument can only be used with binary data");const F=j?new Uint8Array(Ne?await J.arrayBuffer():J):sn(ue?Qn(J):J),Y=M?sn(Qn(M)):null,Q=Math.ceil(F.byteLength/_t)+(M?1:0)||1,oe=Zn(Q,(ae,he)=>{const De=he===Q-1,be=M&&he===0,ve=new Uint8Array(Nn+(be?Y.byteLength:De?F.byteLength-_t*(Q-(M?2:1)):_t));return ve.set(R),ve.set([N],Br),ve.set([De|be<<1|j<<2|ue<<3],Lr),ve.set([Math.round((he+1)/Q*Ar)],Ln),ve.set(M?be?Y:F.subarray((he-1)*_t,he*_t):F.subarray(he*_t,(he+1)*_t),Nn),ve});return N=N+1&Ar,At(m(v,async(ae,he)=>{const{channel:De}=he;let be=0;for(;be<Q;){const ve=oe[be];if(De.bufferedAmount>De.bufferedAmountLowThreshold&&await new Promise(gr=>{const mr=()=>{De.removeEventListener(yo,mr),gr()};De.addEventListener(yo,mr)}),!r[ae])break;he.sendData(ve),be++,Z?.(ve[Ln]/Ar,ae,M)}}))}},i[_]||=[s[_].send,s[_].setOnComplete,s[_].setOnProgress]},E=(_,S)=>{const R=new Uint8Array(S),N=Rr(R.subarray(lc,Br)).replaceAll("\0",""),[J]=R.subarray(Br,Lr),[v]=R.subarray(Lr,Ln),[M]=R.subarray(Ln,Nn),Z=R.subarray(Nn),ye=!!(v&1),ue=!!(v&2),Ne=!!(v&4),j=!!(v&8);if(!s[N]){console.warn(`${Xn}: received message with unregistered type (${N})`);return}c[_]||={},c[_][N]||={};const F=c[_][N][J]||={chunks:[]};if(ue?F.meta=er(Rr(Z)):F.chunks.push(Z),s[N].onProgress(M/Ar,_,F.meta),!ye)return;const Y=new Uint8Array(F.chunks.reduce((Q,oe)=>Q+oe.byteLength,0));if(F.chunks.reduce((Q,oe)=>(Y.set(oe,Q),Q+oe.byteLength),0),delete c[_][N][J],Ne)s[N].onComplete(Y,_,F.meta);else{const Q=Rr(Y);s[N].onComplete(j?er(Q):Q,_)}},x=async()=>{await kt(""),await new Promise(_=>setTimeout(_,99)),Xs(r).forEach(([_,S])=>{S.destroy(),delete r[_]}),n()},[D,O]=w(Gt("ping")),[re,V]=w(Gt("pong")),[A,C]=w(Gt("signal")),[X,_e]=w(Gt("stream")),[xe,Pt]=w(Gt("track")),[kt,Vt]=w(Gt("leave"));return t((_,S)=>{r[S]||(r[S]=_,_.setHandlers({data:R=>E(S,R),stream:R=>{u.onPeerStream(R,S,f[S]),delete f[S]},track:(R,N)=>{u.onPeerTrack(R,N,S,g[S]),delete g[S]},signal:R=>A(R,S),close:()=>d(S),error:R=>{console.error(R),d(S)}}),u.onPeerJoin(S))}),O((_,S)=>re("",S)),V((_,S)=>{h[S]?.(),delete h[S]}),C((_,S)=>r[S]?.signal(_)),_e((_,S)=>f[S]=_),Pt((_,S)=>g[S]=_),Vt((_,S)=>d(S)),ic&&addEventListener("beforeunload",x),{makeAction:w,leave:x,ping:async _=>{if(!_)throw nt("ping() must be called with target peer ID");const S=Date.now();return D("",_),await new Promise(R=>h[_]=R),Date.now()-S},getPeers:()=>oc(Xs(r).map(([_,S])=>[_,S.connection])),addStream:(_,S,R)=>m(S,async(N,J)=>{R&&await X(R,N),J.addStream(_)}),removeStream:(_,S)=>m(S,(R,N)=>N.removeStream(_)),addTrack:(_,S,R,N)=>m(R,async(J,v)=>{N&&await xe(N,J),v.addTrack(_,S)}),removeTrack:(_,S)=>m(S,(R,N)=>N.removeTrack(_)),replaceTrack:(_,S,R,N)=>m(R,async(J,v)=>{N&&await xe(N,J),v.replaceTrack(_,S)}),onPeerJoin:_=>u.onPeerJoin=_,onPeerLeave:_=>u.onPeerLeave=_,onPeerStream:_=>u.onPeerStream=_,onPeerTrack:_=>u.onPeerTrack=_}},ed=20,td=5333,bo=57333,nd=({init:t,subscribe:e,announce:n})=>{const r={};let s=!1,i,c,h,f;return(g,u,m)=>{const{appId:d}=g;if(r[d]?.[u])return r[d][u];const w={},E={},x=_r(Xn,d,u),D=Bn(x),O=Bn(_r(x,zt)),re=Jf(g.password||"",d,u),V=v=>async M=>({type:M.type,sdp:await v(re,M.sdp)}),A=V(Yf),C=V(zf),X=()=>wo(!0,g),_e=(v,M,Z)=>{if(E[M]){E[M]!==v&&v.destroy();return}E[M]=v,J(v,M),w[M]?.forEach((ye,ue)=>{ue!==Z&&ye.destroy()}),delete w[M]},xe=(v,M)=>{E[M]===v&&delete E[M]},Pt=(v,M)=>{if(E[v])return;const Z=w[v]?.[M];Z&&(delete w[v][M],Z.destroy())},kt=v=>(c.push(...Zn(v,X)),At(c.splice(0,v).map(M=>M.offerPromise.then(C).then(Z=>({peer:M,offer:Z}))))),Vt=(v,M)=>m?.({error:`incorrect password (${g.password}) when decrypting ${M}`,appId:d,peerId:v,roomId:u}),_=v=>async(M,Z,ye)=>{const[ue,Ne]=await At([D,O]);if(M!==ue&&M!==Ne)return;const{peerId:j,offer:F,answer:Y,peer:Q}=typeof Z=="string"?er(Z):Z;if(!(j===zt||E[j])){if(j&&!F&&!Y){if(w[j]?.[v])return;const[[{peer:oe,offer:ae}],he]=await At([kt(1),Bn(_r(x,j))]);w[j]||=[],w[j][v]=oe,setTimeout(()=>Pt(j,v),S[v]*.9),oe.setHandlers({connect:()=>_e(oe,j,v),close:()=>xe(oe,j)}),ye(he,Qn({peerId:zt,offer:ae}))}else if(F){if(w[j]?.[v]&&zt>j)return;const ae=wo(!1,g);ae.setHandlers({connect:()=>_e(ae,j,v),close:()=>xe(ae,j)});let he;try{he=await A(F)}catch{Vt(j,"offer");return}if(ae.isDead)return;const[De,be]=await At([Bn(_r(x,j)),ae.signal(he)]);ye(De,Qn({peerId:zt,answer:await C(be)}))}else if(Y){let oe;try{oe=await A(Y)}catch{Vt(j,"answer");return}if(Q)Q.setHandlers({connect:()=>_e(Q,j,v),close:()=>xe(Q,j)}),Q.signal(oe);else{const ae=w[j]?.[v];ae&&!ae.isDead&&ae.signal(oe)}}}};if(!g)throw nt("requires a config map as the first argument");if(!d&&!g.firebaseApp)throw nt("config map is missing appId field");if(!u)throw nt("roomId argument required");if(!s){const v=t(g);c=Zn(ed,X),i=Array.isArray(v)?v:[v],s=!0,h=setInterval(()=>c=c.filter(M=>{const Z=Date.now()-M.created<bo;return Z||M.destroy(),Z}),bo*1.03),f=g.manualRelayReconnection?tt:Vf()}const S=i.map(()=>td),R=[],N=i.map(async(v,M)=>e(await v,await D,await O,_(M),kt));At([D,O]).then(([v,M])=>{const Z=async(ye,ue)=>{const Ne=await n(ye,v,M);typeof Ne=="number"&&(S[ue]=Ne),R[ue]=setTimeout(()=>Z(ye,ue),S[ue])};N.forEach(async(ye,ue)=>{await ye,Z(await i[ue],ue)})});let J=tt;return r[d]||={},r[d][u]=Qf(v=>J=v,v=>delete E[v],()=>{delete r[d][u],R.forEach(clearTimeout),N.forEach(async v=>(await v)()),clearInterval(h),f(),s=!1})}},Ls={},uc={},Mn={},Dn={},On={},Eo={},Sr={},rd="announce",hc=20,ko=10,sd=33333,id=120333,od=3,ad=async t=>{if(Ls[t])return Ls[t];const e=(await Bn(t)).slice(0,hc);return Ls[t]=e,uc[e]=t,e},_o=async(t,e,n)=>t.send(Qn({action:rd,info_hash:await ad(e),peer_id:zt,...n})),xo=(t,e,n)=>console.warn(`${Xn}: torrent tracker ${n?"failure":"warning"} from ${t} - ${e}`),fc=nd({init:t=>Nf(t,cd,od).map(e=>{const n=Pf(e,s=>{const i=er(s),c=i["failure reason"],h=i["warning message"],{interval:f}=i,g=uc[i.info_hash];if(c){xo(r,c,!0);return}if(h&&xo(r,h),f&&f*1e3>On[r]&&Dn[r][g]){const u=Math.min(f*1e3,id);clearInterval(Mn[r][g]),On[r]=u,Mn[r][g]=setInterval(Dn[r][g],u)}Eo[i.offer_id]||(i.offer||i.answer)&&(Eo[i.offer_id]=!0,Sr[r][g]?.(i))}),{url:r}=n;return Sr[r]={},n.ready}),subscribe:(t,e,n,r,s)=>{const{url:i}=t,c=async()=>{const h=oc((await s(ko)).map(f=>[sc(hc),f]));Sr[t.url][e]=f=>{if(f.offer)r(e,{offer:f.offer,peerId:f.peer_id},(g,u)=>_o(t,e,{answer:er(u).answer,offer_id:f.offer_id,to_peer_id:f.peer_id}));else if(f.answer){const g=h[f.offer_id];g&&r(e,{answer:f.answer,peerId:f.peer_id,peer:g.peer})}},_o(t,e,{numwant:ko,offers:Xs(h).map(([f,{offer:g}])=>({offer_id:f,offer:g}))})};return On[i]=sd,Dn[i]||={},Dn[i][e]=c,Mn[i]||={},Mn[i][e]=setInterval(c,On[i]),c(),()=>{clearInterval(Mn[i][e]),delete Sr[i][e],delete Dn[i][e]}},announce:t=>On[t.url]}),cd=["tracker.webtorrent.dev","tracker.openwebtorrent.com","tracker.btorrent.xyz","tracker.files.fm:7073/announce"].map(t=>"wss://"+t),Dp={NEXT_ROLL:"Prxima Rolagem",ROUNDS:"Rodadas",MINUTES:"Minutos",HOURS:"Horas",DAYS:"Dias",LUCK_ENDS:"Sorte Encerra",PERMANENT:"Indeterminado",END_OF_ROUND:"Fim da Rodada",CONCENTRATION:"Concentrao"},on={ADD:"ADD",SET:"SET",MULT:"MULT"},Op={str:"Fora",agi:"Agilidade",int:"Intelecto",wil:"Vontade",defense:"Defesa",speed:"Deslocamento",health:"Vida",damage:"Dano (Dados)",boons:"Boons/Banes",healing_rate:"Taxa de Cura"},pt={WEAPON:"Weapon",ARMOR:"Armor",SHIELD:"Shield",CONSUMABLE:"Consumable",EXPLOSIVE:"Explosive",OTHER:"Other"},Rp=["Aeromancy","Alchemy","Alteration","Animism","Astromancy","Chaos","Chronomancy","Conjuration","Cryomancy","Dark Arts","Destruction","Divination","Eldritch","Enchantment","Evocation","Geomancy","Hydromancy","Illusion","Invocation","Necromancy","Oneiromancy","Order","Primal","Protection","Psychomancy","Pyromancy","Shadowmancy","Skullduggery","Spiritualism","Symbolism","Technomancy","Teleportation","War"],ld=[[1,0,0,0,0,0,0,0,0,0,0],[2,1,0,0,0,0,0,0,0,0,0],[3,2,1,0,0,0,0,0,0,0,0],[4,2,1,1,0,0,0,0,0,0,0],[5,2,2,1,1,0,0,0,0,0,0],[6,3,2,2,1,1,0,0,0,0,0],[7,3,2,2,2,1,1,0,0,0,0],[8,3,2,2,2,1,1,1,0,0,0],[9,3,3,2,2,2,1,1,1,0,0],[10,3,3,3,2,2,1,1,1,1,0],[11,3,3,3,3,2,1,1,1,1,1]],Up=["Air","Alteration","Arcana","Battle","Celestial","Chaos","Conjuration","Curse","Death","Demonology","Destruction","Divination","Enchantment","Ether","Fey","Fire","Forbidden","Illusion","Life","Metal","Nature","Necromancy","Order","Primal","Protection","Rune","Shadow","Song","Soul","Spiritualism","Storm","Technomancy","Telekinesis","Telepathy","Teleportation","Theurgy","Time","Transformation","Water"];function Bp(t,e){return t<0||t>10||e<0||e>10?0:ld[t]?.[e]??0}var Re="INUMBER",An="IOP1",Sn="IOP2",vn="IOP3",ot="IVAR",Ut="IVARNAME",gn="IFUNCALL",ds="IFUNDEF",Se="IEXPR",Mi="IEXPREVAL",Ft="IMEMBER",ps="IENDSTATEMENT",mn="IARRAY";function P(t,e){this.type=t,this.value=e??0}P.prototype.toString=function(){switch(this.type){case Re:case An:case Sn:case vn:case ot:case Ut:case ps:return this.value;case gn:return"CALL "+this.value;case ds:return"DEF "+this.value;case mn:return"ARRAY "+this.value;case Ft:return"."+this.value;default:return"Invalid Instruction"}};function gs(t){return new P(An,t)}function ft(t){return new P(Sn,t)}function dc(t){return new P(vn,t)}function Qs(t,e,n,r,s){for(var i=[],c=[],h,f,g,u,m=0;m<t.length;m++){var d=t[m],w=d.type;if(w===Re||w===Ut)Array.isArray(d.value)?i.push.apply(i,Qs(d.value.map(function(E){return new P(Re,E)}).concat(new P(mn,d.value.length)),e,n,r,s)):i.push(d);else if(w===ot&&s.hasOwnProperty(d.value))d=new P(Re,s[d.value]),i.push(d);else if(w===Sn&&i.length>1)f=i.pop(),h=i.pop(),u=n[d.value],d=new P(Re,u(h.value,f.value)),i.push(d);else if(w===vn&&i.length>2)g=i.pop(),f=i.pop(),h=i.pop(),d.value==="?"?i.push(h.value?f.value:g.value):(u=r[d.value],d=new P(Re,u(h.value,f.value,g.value)),i.push(d));else if(w===An&&i.length>0)h=i.pop(),u=e[d.value],d=new P(Re,u(h.value)),i.push(d);else if(w===Se){for(;i.length>0;)c.push(i.shift());c.push(new P(Se,Qs(d.value,e,n,r,s)))}else if(w===Ft&&i.length>0)h=i.pop(),i.push(new P(Re,h.value[d.value]));else{for(;i.length>0;)c.push(i.shift());c.push(d)}}for(;i.length>0;)c.push(i.shift());return c}function pc(t,e,n){for(var r=[],s=0;s<t.length;s++){var i=t[s],c=i.type;if(c===ot&&i.value===e)for(var h=0;h<n.tokens.length;h++){var f=n.tokens[h],g;f.type===An?g=gs(f.value):f.type===Sn?g=ft(f.value):f.type===vn?g=dc(f.value):g=new P(f.type,f.value),r.push(g)}else c===Se?r.push(new P(Se,pc(i.value,e,n))):r.push(i)}return r}function St(t,e,n){var r=[],s,i,c,h,f,g;if(Di(t))return et(t,n);for(var u=t.length,m=0;m<u;m++){var d=t[m],w=d.type;if(w===Re||w===Ut)r.push(d.value);else if(w===Sn)i=r.pop(),s=r.pop(),d.value==="and"?r.push(s?!!St(i,e,n):!1):d.value==="or"?r.push(s?!0:!!St(i,e,n)):d.value==="="?(h=e.binaryOps[d.value],r.push(h(s,St(i,e,n),n))):(h=e.binaryOps[d.value],r.push(h(et(s,n),et(i,n))));else if(w===vn)c=r.pop(),i=r.pop(),s=r.pop(),d.value==="?"?r.push(St(s?i:c,e,n)):(h=e.ternaryOps[d.value],r.push(h(et(s,n),et(i,n),et(c,n))));else if(w===ot)if(d.value in e.functions)r.push(e.functions[d.value]);else if(d.value in e.unaryOps&&e.parser.isOperatorEnabled(d.value))r.push(e.unaryOps[d.value]);else{var E=n[d.value];if(E!==void 0)r.push(E);else throw new Error("undefined variable: "+d.value)}else if(w===An)s=r.pop(),h=e.unaryOps[d.value],r.push(h(et(s,n)));else if(w===gn){for(g=d.value,f=[];g-- >0;)f.unshift(et(r.pop(),n));if(h=r.pop(),h.apply&&h.call)r.push(h.apply(void 0,f));else throw new Error(h+" is not a function")}else if(w===ds)r.push((function(){for(var x=r.pop(),D=[],O=d.value;O-- >0;)D.unshift(r.pop());var re=r.pop(),V=function(){for(var A=Object.assign({},n),C=0,X=D.length;C<X;C++)A[D[C]]=arguments[C];return St(x,e,A)};return Object.defineProperty(V,"name",{value:re,writable:!1}),n[re]=V,V})());else if(w===Se)r.push(ud(d,e));else if(w===Mi)r.push(d);else if(w===Ft)s=r.pop(),r.push(s[d.value]);else if(w===ps)r.pop();else if(w===mn){for(g=d.value,f=[];g-- >0;)f.unshift(r.pop());r.push(f)}else throw new Error("invalid Expression")}if(r.length>1)throw new Error("invalid Expression (parity)");return r[0]===0?0:et(r[0],n)}function ud(t,e,n){return Di(t)?t:{type:Mi,value:function(r){return St(t.value,e,r)}}}function Di(t){return t&&t.type===Mi}function et(t,e){return Di(t)?t.value(e):t}function Oi(t,e){for(var n=[],r,s,i,c,h,f,g=0;g<t.length;g++){var u=t[g],m=u.type;if(m===Re)typeof u.value=="number"&&u.value<0?n.push("("+u.value+")"):Array.isArray(u.value)?n.push("["+u.value.map(Ao).join(", ")+"]"):n.push(Ao(u.value));else if(m===Sn)s=n.pop(),r=n.pop(),c=u.value,e?c==="^"?n.push("Math.pow("+r+", "+s+")"):c==="and"?n.push("(!!"+r+" && !!"+s+")"):c==="or"?n.push("(!!"+r+" || !!"+s+")"):c==="||"?n.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+r+"),("+s+")))"):c==="=="?n.push("("+r+" === "+s+")"):c==="!="?n.push("("+r+" !== "+s+")"):c==="["?n.push(r+"[("+s+") | 0]"):n.push("("+r+" "+c+" "+s+")"):c==="["?n.push(r+"["+s+"]"):n.push("("+r+" "+c+" "+s+")");else if(m===vn)if(i=n.pop(),s=n.pop(),r=n.pop(),c=u.value,c==="?")n.push("("+r+" ? "+s+" : "+i+")");else throw new Error("invalid Expression");else if(m===ot||m===Ut)n.push(u.value);else if(m===An)r=n.pop(),c=u.value,c==="-"||c==="+"?n.push("("+c+r+")"):e?c==="not"?n.push("(!"+r+")"):c==="!"?n.push("fac("+r+")"):n.push(c+"("+r+")"):c==="!"?n.push("("+r+"!)"):n.push("("+c+" "+r+")");else if(m===gn){for(f=u.value,h=[];f-- >0;)h.unshift(n.pop());c=n.pop(),n.push(c+"("+h.join(", ")+")")}else if(m===ds){for(s=n.pop(),f=u.value,h=[];f-- >0;)h.unshift(n.pop());r=n.pop(),e?n.push("("+r+" = function("+h.join(", ")+") { return "+s+" })"):n.push("("+r+"("+h.join(", ")+") = "+s+")")}else if(m===Ft)r=n.pop(),n.push(r+"."+u.value);else if(m===mn){for(f=u.value,h=[];f-- >0;)h.unshift(n.pop());n.push("["+h.join(", ")+"]")}else if(m===Se)n.push("("+Oi(u.value,e)+")");else if(m!==ps)throw new Error("invalid Expression")}return n.length>1&&(e?n=[n.join(",")]:n=[n.join(";")]),String(n[0])}function Ao(t){return typeof t=="string"?JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):t}function Wt(t,e){for(var n=0;n<t.length;n++)if(t[n]===e)return!0;return!1}function Ri(t,e,n){n=n||{};for(var r=!!n.withMembers,s=null,i=0;i<t.length;i++){var c=t[i];c.type===ot||c.type===Ut?!r&&!Wt(e,c.value)?e.push(c.value):(s!==null&&(Wt(e,s)||e.push(s)),s=c.value):c.type===Ft&&r&&s!==null?s+="."+c.value:c.type===Se?Ri(c.value,e,n):s!==null&&(Wt(e,s)||e.push(s),s=null)}s!==null&&!Wt(e,s)&&e.push(s)}function Pe(t,e){this.tokens=t,this.parser=e,this.unaryOps=e.unaryOps,this.binaryOps=e.binaryOps,this.ternaryOps=e.ternaryOps,this.functions=e.functions}Pe.prototype.simplify=function(t){return t=t||{},new Pe(Qs(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,t),this.parser)};Pe.prototype.substitute=function(t,e){return e instanceof Pe||(e=this.parser.parse(String(e))),new Pe(pc(this.tokens,t,e),this.parser)};Pe.prototype.evaluate=function(t){return t=t||{},St(this.tokens,this,t)};Pe.prototype.toString=function(){return Oi(this.tokens,!1)};Pe.prototype.symbols=function(t){t=t||{};var e=[];return Ri(this.tokens,e,t),e};Pe.prototype.variables=function(t){t=t||{};var e=[];Ri(this.tokens,e,t);var n=this.functions;return e.filter(function(r){return!(r in n)})};Pe.prototype.toJSFunction=function(t,e){var n=this,r=new Function(t,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+Oi(this.simplify(e).tokens,!0)+"; }");return function(){return r.apply(n,arguments)}};var tr="TEOF",z="TOP",ms="TNUMBER",gc="TSTRING",at="TPAREN",wn="TBRACKET",ws="TCOMMA",Ui="TNAME",Bi="TSEMICOLON";function mc(t,e,n){this.type=t,this.value=e,this.index=n}mc.prototype.toString=function(){return this.type+": "+this.value};function ne(t,e){this.pos=0,this.current=null,this.unaryOps=t.unaryOps,this.binaryOps=t.binaryOps,this.ternaryOps=t.ternaryOps,this.consts=t.consts,this.expression=e,this.savedPosition=0,this.savedCurrent=null,this.options=t.options,this.parser=t}ne.prototype.newToken=function(t,e,n){return new mc(t,e,n??this.pos)};ne.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current};ne.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent};ne.prototype.next=function(){if(this.pos>=this.expression.length)return this.newToken(tr,"EOF");if(this.isWhitespace()||this.isComment())return this.next();if(this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName())return this.current;this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')};ne.prototype.isString=function(){var t=!1,e=this.pos,n=this.expression.charAt(e);if(n==="'"||n==='"')for(var r=this.expression.indexOf(n,e+1);r>=0&&this.pos<this.expression.length;){if(this.pos=r+1,this.expression.charAt(r-1)!=="\\"){var s=this.expression.substring(e+1,r);this.current=this.newToken(gc,this.unescape(s),e),t=!0;break}r=this.expression.indexOf(n,r+1)}return t};ne.prototype.isParen=function(){var t=this.expression.charAt(this.pos);return t==="("||t===")"?(this.current=this.newToken(at,t),this.pos++,!0):!1};ne.prototype.isBracket=function(){var t=this.expression.charAt(this.pos);return(t==="["||t==="]")&&this.isOperatorEnabled("[")?(this.current=this.newToken(wn,t),this.pos++,!0):!1};ne.prototype.isComma=function(){var t=this.expression.charAt(this.pos);return t===","?(this.current=this.newToken(ws,","),this.pos++,!0):!1};ne.prototype.isSemicolon=function(){var t=this.expression.charAt(this.pos);return t===";"?(this.current=this.newToken(Bi,";"),this.pos++,!0):!1};ne.prototype.isConst=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var n=this.expression.charAt(e);if(n.toUpperCase()===n.toLowerCase()&&(e===this.pos||n!=="_"&&n!=="."&&(n<"0"||n>"9")))break}if(e>t){var r=this.expression.substring(t,e);if(r in this.consts)return this.current=this.newToken(ms,this.consts[r]),this.pos+=r.length,!0}return!1};ne.prototype.isNamedOp=function(){for(var t=this.pos,e=t;e<this.expression.length;e++){var n=this.expression.charAt(e);if(n.toUpperCase()===n.toLowerCase()&&(e===this.pos||n!=="_"&&(n<"0"||n>"9")))break}if(e>t){var r=this.expression.substring(t,e);if(this.isOperatorEnabled(r)&&(r in this.binaryOps||r in this.unaryOps||r in this.ternaryOps))return this.current=this.newToken(z,r),this.pos+=r.length,!0}return!1};ne.prototype.isName=function(){for(var t=this.pos,e=t,n=!1;e<this.expression.length;e++){var r=this.expression.charAt(e);if(r.toUpperCase()===r.toLowerCase()){if(e===this.pos&&(r==="$"||r==="_")){r==="_"&&(n=!0);continue}else if(e===this.pos||!n||r!=="_"&&(r<"0"||r>"9"))break}else n=!0}if(n){var s=this.expression.substring(t,e);return this.current=this.newToken(Ui,s),this.pos+=s.length,!0}return!1};ne.prototype.isWhitespace=function(){for(var t=!1,e=this.expression.charAt(this.pos);(e===" "||e==="	"||e===`
`||e==="\r")&&(t=!0,this.pos++,!(this.pos>=this.expression.length));)e=this.expression.charAt(this.pos);return t};var hd=/^[0-9a-f]{4}$/i;ne.prototype.unescape=function(t){var e=t.indexOf("\\");if(e<0)return t;for(var n=t.substring(0,e);e>=0;){var r=t.charAt(++e);switch(r){case"'":n+="'";break;case'"':n+='"';break;case"\\":n+="\\";break;case"/":n+="/";break;case"b":n+="\b";break;case"f":n+="\f";break;case"n":n+=`
`;break;case"r":n+="\r";break;case"t":n+="	";break;case"u":var s=t.substring(e+1,e+5);hd.test(s)||this.parseError("Illegal escape sequence: \\u"+s),n+=String.fromCharCode(parseInt(s,16)),e+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+r+'"')}++e;var i=t.indexOf("\\",e);n+=t.substring(e,i<0?t.length:i),e=i}return n};ne.prototype.isComment=function(){var t=this.expression.charAt(this.pos);return t==="/"&&this.expression.charAt(this.pos+1)==="*"?(this.pos=this.expression.indexOf("*/",this.pos)+2,this.pos===1&&(this.pos=this.expression.length),!0):!1};ne.prototype.isRadixInteger=function(){var t=this.pos;if(t>=this.expression.length-2||this.expression.charAt(t)!=="0")return!1;++t;var e,n;if(this.expression.charAt(t)==="x")e=16,n=/^[0-9a-f]$/i,++t;else if(this.expression.charAt(t)==="b")e=2,n=/^[01]$/i,++t;else return!1;for(var r=!1,s=t;t<this.expression.length;){var i=this.expression.charAt(t);if(n.test(i))t++,r=!0;else break}return r&&(this.current=this.newToken(ms,parseInt(this.expression.substring(s,t),e)),this.pos=t),r};ne.prototype.isNumber=function(){for(var t=!1,e=this.pos,n=e,r=e,s=!1,i=!1,c;e<this.expression.length&&(c=this.expression.charAt(e),c>="0"&&c<="9"||!s&&c===".");)c==="."?s=!0:i=!0,e++,t=i;if(t&&(r=e),c==="e"||c==="E"){e++;for(var h=!0,f=!1;e<this.expression.length;){if(c=this.expression.charAt(e),h&&(c==="+"||c==="-"))h=!1;else if(c>="0"&&c<="9")f=!0,h=!1;else break;e++}f||(e=r)}return t?(this.current=this.newToken(ms,parseFloat(this.expression.substring(n,e))),this.pos=e):this.pos=r,t};ne.prototype.isOperator=function(){var t=this.pos,e=this.expression.charAt(this.pos);if(e==="+"||e==="-"||e==="*"||e==="/"||e==="%"||e==="^"||e==="?"||e===":"||e===".")this.current=this.newToken(z,e);else if(e===""||e==="")this.current=this.newToken(z,"*");else if(e===">")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(z,">="),this.pos++):this.current=this.newToken(z,">");else if(e==="<")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(z,"<="),this.pos++):this.current=this.newToken(z,"<");else if(e==="|")if(this.expression.charAt(this.pos+1)==="|")this.current=this.newToken(z,"||"),this.pos++;else return!1;else if(e==="=")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(z,"=="),this.pos++):this.current=this.newToken(z,e);else if(e==="!")this.expression.charAt(this.pos+1)==="="?(this.current=this.newToken(z,"!="),this.pos++):this.current=this.newToken(z,e);else return!1;return this.pos++,this.isOperatorEnabled(this.current.value)?!0:(this.pos=t,!1)};ne.prototype.isOperatorEnabled=function(t){return this.parser.isOperatorEnabled(t)};ne.prototype.getCoordinates=function(){var t=0,e,n=-1;do t++,e=this.pos-n,n=this.expression.indexOf(`
`,n+1);while(n>=0&&n<this.pos);return{line:t,column:e}};ne.prototype.parseError=function(t){var e=this.getCoordinates();throw new Error("parse error ["+e.line+":"+e.column+"]: "+t)};function W(t,e,n){this.parser=t,this.tokens=e,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=n.allowMemberAccess!==!1}W.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()};W.prototype.tokenMatches=function(t,e){return typeof e>"u"?!0:Array.isArray(e)?Wt(e,t.value):typeof e=="function"?e(t):t.value===e};W.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()};W.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken};W.prototype.accept=function(t,e){return this.nextToken.type===t&&this.tokenMatches(this.nextToken,e)?(this.next(),!0):!1};W.prototype.expect=function(t,e){if(!this.accept(t,e)){var n=this.tokens.getCoordinates();throw new Error("parse error ["+n.line+":"+n.column+"]: Expected "+(e||t))}};W.prototype.parseAtom=function(t){var e=this.tokens.unaryOps;function n(s){return s.value in e}if(this.accept(Ui)||this.accept(z,n))t.push(new P(ot,this.current.value));else if(this.accept(ms))t.push(new P(Re,this.current.value));else if(this.accept(gc))t.push(new P(Re,this.current.value));else if(this.accept(at,"("))this.parseExpression(t),this.expect(at,")");else if(this.accept(wn,"["))if(this.accept(wn,"]"))t.push(new P(mn,0));else{var r=this.parseArrayList(t);t.push(new P(mn,r))}else throw new Error("unexpected "+this.nextToken)};W.prototype.parseExpression=function(t){var e=[];this.parseUntilEndStatement(t,e)||(this.parseVariableAssignmentExpression(e),!this.parseUntilEndStatement(t,e)&&this.pushExpression(t,e))};W.prototype.pushExpression=function(t,e){for(var n=0,r=e.length;n<r;n++)t.push(e[n])};W.prototype.parseUntilEndStatement=function(t,e){return this.accept(Bi)?(this.nextToken&&this.nextToken.type!==tr&&!(this.nextToken.type===at&&this.nextToken.value===")")&&e.push(new P(ps)),this.nextToken.type!==tr&&this.parseExpression(e),t.push(new P(Se,e)),!0):!1};W.prototype.parseArrayList=function(t){for(var e=0;!this.accept(wn,"]");)for(this.parseExpression(t),++e;this.accept(ws);)this.parseExpression(t),++e;return e};W.prototype.parseVariableAssignmentExpression=function(t){for(this.parseConditionalExpression(t);this.accept(z,"=");){var e=t.pop(),n=[],r=t.length-1;if(e.type===gn){if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var s=0,i=e.value+1;s<i;s++){var c=r-s;t[c].type===ot&&(t[c]=new P(Ut,t[c].value))}this.parseVariableAssignmentExpression(n),t.push(new P(Se,n)),t.push(new P(ds,e.value));continue}if(e.type!==ot&&e.type!==Ft)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(n),t.push(new P(Ut,e.value)),t.push(new P(Se,n)),t.push(ft("="))}};W.prototype.parseConditionalExpression=function(t){for(this.parseOrExpression(t);this.accept(z,"?");){var e=[],n=[];this.parseConditionalExpression(e),this.expect(z,":"),this.parseConditionalExpression(n),t.push(new P(Se,e)),t.push(new P(Se,n)),t.push(dc("?"))}};W.prototype.parseOrExpression=function(t){for(this.parseAndExpression(t);this.accept(z,"or");){var e=[];this.parseAndExpression(e),t.push(new P(Se,e)),t.push(ft("or"))}};W.prototype.parseAndExpression=function(t){for(this.parseComparison(t);this.accept(z,"and");){var e=[];this.parseComparison(e),t.push(new P(Se,e)),t.push(ft("and"))}};var fd=["==","!=","<","<=",">=",">","in"];W.prototype.parseComparison=function(t){for(this.parseAddSub(t);this.accept(z,fd);){var e=this.current;this.parseAddSub(t),t.push(ft(e.value))}};var dd=["+","-","||"];W.prototype.parseAddSub=function(t){for(this.parseTerm(t);this.accept(z,dd);){var e=this.current;this.parseTerm(t),t.push(ft(e.value))}};var pd=["*","/","%"];W.prototype.parseTerm=function(t){for(this.parseFactor(t);this.accept(z,pd);){var e=this.current;this.parseFactor(t),t.push(ft(e.value))}};W.prototype.parseFactor=function(t){var e=this.tokens.unaryOps;function n(s){return s.value in e}if(this.save(),this.accept(z,n)){if(this.current.value!=="-"&&this.current.value!=="+"){if(this.nextToken.type===at&&this.nextToken.value==="("){this.restore(),this.parseExponential(t);return}else if(this.nextToken.type===Bi||this.nextToken.type===ws||this.nextToken.type===tr||this.nextToken.type===at&&this.nextToken.value===")"){this.restore(),this.parseAtom(t);return}}var r=this.current;this.parseFactor(t),t.push(gs(r.value))}else this.parseExponential(t)};W.prototype.parseExponential=function(t){for(this.parsePostfixExpression(t);this.accept(z,"^");)this.parseFactor(t),t.push(ft("^"))};W.prototype.parsePostfixExpression=function(t){for(this.parseFunctionCall(t);this.accept(z,"!");)t.push(gs("!"))};W.prototype.parseFunctionCall=function(t){var e=this.tokens.unaryOps;function n(i){return i.value in e}if(this.accept(z,n)){var r=this.current;this.parseAtom(t),t.push(gs(r.value))}else for(this.parseMemberExpression(t);this.accept(at,"(");)if(this.accept(at,")"))t.push(new P(gn,0));else{var s=this.parseArgumentList(t);t.push(new P(gn,s))}};W.prototype.parseArgumentList=function(t){for(var e=0;!this.accept(at,")");)for(this.parseExpression(t),++e;this.accept(ws);)this.parseExpression(t),++e;return e};W.prototype.parseMemberExpression=function(t){for(this.parseAtom(t);this.accept(z,".")||this.accept(wn,"[");){var e=this.current;if(e.value==="."){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect(Ui),t.push(new P(Ft,this.current.value))}else if(e.value==="["){if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(t),this.expect(wn,"]"),t.push(ft("["))}else throw new Error("unexpected symbol: "+e.value)}};function gd(t,e){return Number(t)+Number(e)}function md(t,e){return t-e}function wd(t,e){return t*e}function yd(t,e){return t/e}function bd(t,e){return t%e}function Ed(t,e){return Array.isArray(t)&&Array.isArray(e)?t.concat(e):""+t+e}function kd(t,e){return t===e}function _d(t,e){return t!==e}function xd(t,e){return t>e}function Ad(t,e){return t<e}function Sd(t,e){return t>=e}function vd(t,e){return t<=e}function Id(t,e){return!!(t&&e)}function Cd(t,e){return!!(t||e)}function Td(t,e){return Wt(e,t)}function Md(t){return(Math.exp(t)-Math.exp(-t))/2}function Dd(t){return(Math.exp(t)+Math.exp(-t))/2}function Od(t){return t===1/0?1:t===-1/0?-1:(Math.exp(t)-Math.exp(-t))/(Math.exp(t)+Math.exp(-t))}function Rd(t){return t===-1/0?t:Math.log(t+Math.sqrt(t*t+1))}function Ud(t){return Math.log(t+Math.sqrt(t*t-1))}function Bd(t){return Math.log((1+t)/(1-t))/2}function So(t){return Math.log(t)*Math.LOG10E}function Ld(t){return-t}function Nd(t){return!t}function Fd(t){return t<0?Math.ceil(t):Math.floor(t)}function $d(t){return Math.random()*(t||1)}function vo(t){return Li(t+1)}function Pd(t){return isFinite(t)&&t===Math.round(t)}var Vd=4.7421875,Ns=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function Li(t){var e,n;if(Pd(t)){if(t<=0)return isFinite(t)?1/0:NaN;if(t>171)return 1/0;for(var r=t-2,s=t-1;r>1;)s*=r,r--;return s===0&&(s=1),s}if(t<.5)return Math.PI/(Math.sin(Math.PI*t)*Li(1-t));if(t>=171.35)return 1/0;if(t>85){var i=t*t,c=i*t,h=c*t,f=h*t;return Math.sqrt(2*Math.PI/t)*Math.pow(t/Math.E,t)*(1+1/(12*t)+1/(288*i)-139/(51840*c)-571/(2488320*h)+163879/(209018880*f)+5246819/(75246796800*f*t))}--t,n=Ns[0];for(var g=1;g<Ns.length;++g)n+=Ns[g]/(t+g);return e=t+Vd+.5,Math.sqrt(2*Math.PI)*Math.pow(e,t+.5)*Math.exp(-e)*n}function jd(t){return Array.isArray(t)?t.length:String(t).length}function Io(){for(var t=0,e=0,n=0;n<arguments.length;n++){var r=Math.abs(arguments[n]),s;e<r?(s=e/r,t=t*s*s+1,e=r):r>0?(s=r/e,t+=s*s):t+=r}return e===1/0?1/0:e*Math.sqrt(t)}function Co(t,e,n){return t?e:n}function Hd(t,e){return typeof e>"u"||+e==0?Math.round(t):(t=+t,e=-+e,isNaN(t)||!(typeof e=="number"&&e%1===0)?NaN:(t=t.toString().split("e"),t=Math.round(+(t[0]+"e"+(t[1]?+t[1]-e:-e))),t=t.toString().split("e"),+(t[0]+"e"+(t[1]?+t[1]+e:e))))}function qd(t,e,n){return n&&(n[t]=e),e}function Gd(t,e){return t[e|0]}function Jd(t){return arguments.length===1&&Array.isArray(t)?Math.max.apply(Math,t):Math.max.apply(Math,arguments)}function zd(t){return arguments.length===1&&Array.isArray(t)?Math.min.apply(Math,t):Math.min.apply(Math,arguments)}function Yd(t,e){if(typeof t!="function")throw new Error("First argument to map is not a function");if(!Array.isArray(e))throw new Error("Second argument to map is not an array");return e.map(function(n,r){return t(n,r)})}function Wd(t,e,n){if(typeof t!="function")throw new Error("First argument to fold is not a function");if(!Array.isArray(n))throw new Error("Second argument to fold is not an array");return n.reduce(function(r,s,i){return t(r,s,i)},e)}function Kd(t,e){if(typeof t!="function")throw new Error("First argument to filter is not a function");if(!Array.isArray(e))throw new Error("Second argument to filter is not an array");return e.filter(function(n,r){return t(n,r)})}function Xd(t,e){if(!(Array.isArray(e)||typeof e=="string"))throw new Error("Second argument to indexOf is not a string or array");return e.indexOf(t)}function Zd(t,e){if(!Array.isArray(e))throw new Error("Second argument to join is not an array");return e.join(t)}function Qd(t){return(t>0)-(t<0)||+t}var To=1/3;function ep(t){return t<0?-Math.pow(-t,To):Math.pow(t,To)}function tp(t){return Math.exp(t)-1}function np(t){return Math.log(1+t)}function rp(t){return Math.log(t)/Math.LN2}function $t(t){this.options=t||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||Md,cosh:Math.cosh||Dd,tanh:Math.tanh||Od,asinh:Math.asinh||Rd,acosh:Math.acosh||Ud,atanh:Math.atanh||Bd,sqrt:Math.sqrt,cbrt:Math.cbrt||ep,log:Math.log,log2:Math.log2||rp,ln:Math.log,lg:Math.log10||So,log10:Math.log10||So,expm1:Math.expm1||tp,log1p:Math.log1p||np,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||Fd,"-":Ld,"+":Number,exp:Math.exp,not:Nd,length:jd,"!":vo,sign:Math.sign||Qd},this.binaryOps={"+":gd,"-":md,"*":wd,"/":yd,"%":bd,"^":Math.pow,"||":Ed,"==":kd,"!=":_d,">":xd,"<":Ad,">=":Sd,"<=":vd,and:Id,or:Cd,in:Td,"=":qd,"[":Gd},this.ternaryOps={"?":Co},this.functions={random:$d,fac:vo,min:zd,max:Jd,hypot:Math.hypot||Io,pyt:Math.hypot||Io,pow:Math.pow,atan2:Math.atan2,if:Co,gamma:Li,roundTo:Hd,map:Yd,fold:Wd,filter:Kd,indexOf:Xd,join:Zd},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}$t.prototype.parse=function(t){var e=[],n=new W(this,new ne(this,t),{allowMemberAccess:this.options.allowMemberAccess});return n.parseExpression(e),n.expect(tr,"EOF"),new Pe(e,this)};$t.prototype.evaluate=function(t,e){return this.parse(t).evaluate(e)};var wc=new $t;$t.parse=function(t){return wc.parse(t)};$t.evaluate=function(t,e){return wc.parse(t).evaluate(e)};var Mo={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};function sp(t){return Mo.hasOwnProperty(t)?Mo[t]:t}$t.prototype.isOperatorEnabled=function(t){var e=sp(t),n=this.options.operators||{};return!(e in n)||!!n[e]};const ip=new $t,op={name:"",level:1,ancestry:"",paths:{novice:"",expert:"",master:""},attributes:[{name:"Strength",value:10,key:"str"},{name:"Agility",value:10,key:"agi"},{name:"Intellect",value:10,key:"int"},{name:"Will",value:10,key:"wil"}],currency:{gp:0,sp:0,cp:0},naturalDefense:10,bonusDamage:0,speed:10,currentRound:1,languages:[],senses:[],afflictions:[],effects:[],notes:"",campaignId:null,campaignName:null,gmName:null,combatActive:!1,initiative:!1,acted:!1,spells:[],talents:[],equipment:[]},I=Me(JSON.parse(JSON.stringify(op))),Nr=Me([]),Kt=Me({type:null,isOpen:!1,data:null}),Lp=Me("acoes"),Ni=Me(24),In=Me(24),yn=Me(0),nr=Me(!1),Fi=Me(!1),Do={autoOpenHistory:!1,stickyHistory:!1,theme:"dark"};function ap(){const t=typeof localStorage<"u"?localStorage.getItem("wwv_app_settings"):null,{subscribe:e,set:n,update:r}=Me(t?{...Do,...JSON.parse(t)}:Do);return{subscribe:e,set:s=>{typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(s)),n(s)},update:s=>{r(i=>{const c=s(i);return typeof localStorage<"u"&&localStorage.setItem("wwv_app_settings",JSON.stringify(c)),c})}}}const yc=ap();nr.subscribe(t=>{t&&Fi.set(!1)});const pr=ge(I,t=>{const e=t.effects.filter(r=>r.isActive),n=t.talents.filter(r=>(r.isPassive||r.activityType==="Passive")&&r.effect).map(r=>({...r.effect,id:`talent-effect-${r.id}`,name:r.name,sourceType:"talent",sourceId:r.id}));return[...e,...n]});function an(t,e){if(typeof t=="number")return t;if(!t)return 0;const n=String(t).trim();if(!isNaN(Number(n)))return Number(n);try{const r={};Array.isArray(e.attributes)&&e.attributes.forEach(i=>{r[i.key]=i.value}),r.level=e.level||0;const s=n.replace(/@(\w+)/g,"$1");return ip.evaluate(s,r)}catch{return 0}}function ys(t,e,n,r){let s=e||0;const i=n.flatMap(g=>Array.isArray(g.modifiers)?g.modifiers:[]),c=i.filter(g=>g.target===t&&g.type===on.SET);return c.length>0&&(s=an(c[c.length-1].value,r)),i.filter(g=>g.target===t&&g.type===on.ADD).forEach(g=>{s+=an(g.value,r)}),i.filter(g=>g.target===t&&g.type===on.MULT).forEach(g=>{s*=an(g.value,r)}),Math.floor(s)}const bc=ge([I,pr],([t,e])=>{const n={};return Array.isArray(t.attributes)&&t.attributes.forEach(r=>{n[r.key]=ys(r.key,r.value,e,t)}),n}),cp=ge([I,In,pr],([t,e,n])=>ys("health",e,n,t)),Np=ge([cp,Ni],([t,e])=>Math.max(0,t-e)),Fp=ge([yn,In],([t,e])=>e>0?Math.min(100,t/e*100):100),lp=ge([yn,In],([t,e])=>t>=e),$p=ge([yn,In,lp],([t,e,n])=>t>=e/2&&!n),Pp=ge([I,bc,pr],([t,e,n])=>{let r=ys("speed",t.speed,n,t);const s=t.afflictions;return s.includes("Held")||s.includes("Stunned")||s.includes("Unconscious")||s.includes("Incapacitated")?0:((s.includes("Blinded")||s.includes("Weakened"))&&(r=Math.floor(r/2)),s.includes("Slowed")&&(r=Math.min(r,2)),Math.max(0,r))}),Vp=ge([I,pr],([t,e])=>{let n=t.naturalDefense,r=0;const s=t.equipment.find(i=>i.type===pt.ARMOR&&i.equipped);if(s){const i=s.defenseFixed||0,c=t.naturalDefense+(s.defenseMod||0);s.defenseFixed&&s.defenseMod?n=Math.max(i,c):s.defenseFixed?n=i:s.defenseMod&&(n=t.naturalDefense+s.defenseMod)}return t.equipment.filter(i=>i.type===pt.SHIELD&&i.equippedState).forEach(i=>{r+=i.defenseMod||0}),ys("defense",n+r,e,t)});ge([I,pr],([t,e])=>{const r=e.flatMap(s=>Array.isArray(s.modifiers)?s.modifiers:[]).filter(s=>s.target==="damage"&&s.type===on.ADD).reduce((s,i)=>s+an(i.value,t),0);return(t.bonusDamage||0)+r});const Fe={updateCurrency:(t,e)=>{I.update(n=>{let r=n.currency.gp*100+n.currency.sp*10+n.currency.cp,s=0;return t==="gp"&&(s=e*100),t==="sp"&&(s=e*10),t==="cp"&&(s=e),r+=s,r<0&&(r=0),{...n,currency:{gp:Math.floor(r/100),sp:Math.floor(r%100/10),cp:r%100%10}}})},advanceRound:t=>{I.update(e=>{const n=e.currentRound||1;if(t==="next"){const r=(e.effects||[]).map(s=>{if(s.isActive&&s.duration==="ROUNDS"&&s.roundsLeft>0){const i=s.roundsLeft-1;return i<=0?{...s,roundsLeft:0,isActive:!1}:{...s,roundsLeft:i}}return s});return{...e,currentRound:n+1,effects:r}}else return{...e,currentRound:Math.max(1,n-1)}})},addToHistory:(t,e=!0)=>{const n=H(I),r=H(Nr);if(t.id&&r.find(c=>c.id===t.id))return;const s={id:t.id||$n(),timestamp:t.timestamp||new Date,charName:n.name,source:t.source||"gm",name:t.name||"Action",...t};Nr.update(c=>[s,...c]),H(yc).autoOpenHistory?nr.set(!0):H(nr)||Fi.set(!0),e&&n.campaignId&&Fs(async()=>{const{syncRoll:c}=await Promise.resolve().then(()=>ni);return{syncRoll:c}},void 0,import.meta.url).then(({syncRoll:c})=>{c(s)})},clearHistory:()=>Nr.set([]),addItem:t=>I.update(e=>({...e,equipment:[...e.equipment,t]})),updateItem:t=>I.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?t:n)})),deleteItem:t=>I.update(e=>({...e,equipment:e.equipment.filter(n=>n.id!==t)})),useConsumable:t=>{if(t.quantity>0){const e=H(rt);Fe.updateItem({...t,quantity:t.quantity-1}),Fe.addToHistory({source:"item",name:t.name,description:e("sofww.item_types.consumable")+`: ${t.name}`})}},equipItem:(t,e=null)=>{I.update(n=>{let r=[...n.equipment];return t.type===pt.ARMOR?r=r.map(s=>s.id===t.id?{...s,equipped:!s.equipped}:s.type===pt.ARMOR&&t.type===pt.ARMOR&&!t.equipped?{...s,equipped:!1}:s):(t.type===pt.WEAPON||t.type===pt.SHIELD)&&(r=r.map(s=>s.id===t.id?{...s,equippedState:e}:s)),{...n,equipment:r}})},toggleAffliction:t=>{I.update(e=>e.afflictions.includes(t)?{...e,afflictions:e.afflictions.filter(n=>n!==t)}:{...e,afflictions:[...e.afflictions,t]})},addLanguage:t=>I.update(e=>({...e,languages:[...e.languages,t]})),removeLanguage:t=>I.update(e=>({...e,languages:e.languages.filter((n,r)=>r!==t)})),addSense:t=>I.update(e=>({...e,senses:[...e.senses||[],t]})),removeSense:t=>I.update(e=>({...e,senses:(e.senses||[]).filter((n,r)=>r!==t)})),confirmRest:()=>{I.update(e=>{const n=e.spells.map(s=>({...s,castings:s.maxCastings})),r=e.talents.map(s=>({...s,uses:s.maxUses}));return{...e,spells:n,talents:r}}),yn.set(0);const t=H(Ni);In.set(t),Kt.set({type:null,isOpen:!1,data:null})},finalizeRoll:(t,e,n=[])=>{const r=H(I),s=H(bc),i=H(rt),c=t.type==="weapon_attack",h=t.type==="luck",f=t.type==="weapon_damage",g=t?.source,u=g?.name||i("common.labels.action"),m=(d,w)=>d.traits&&d.traits.toLowerCase().includes(w.toLowerCase());if(f){let d=parseInt(g.damageDice)||0;const w=g.grip&&g.grip.toLowerCase()==="two"||g.equippedState&&g.equippedState.toLowerCase()==="two";m(g,"Versatile")&&w&&(d+=1);let E=r.bonusDamage||0;m(g,"Light")&&E>1&&(E-=1);const x=n.flatMap(C=>Array.isArray(C.modifiers)?C.modifiers:[]).filter(C=>C.target==="damage"&&C.type===on.ADD).reduce((C,X)=>C+an(X.value,r),0),D=E+x,O=Math.max(0,d+D+e);let re=[],V=0,A=[];for(let C=0;C<O;C++){let X=Math.floor(Math.random()*6)+1;if(X===1&&m(g,"Brutal")){const _e=Math.floor(Math.random()*6)+1;A.push(`1->${_e}`),X=_e}else A.push(`${X}`);re.push(X),V+=X}yn.set(V),Fe.addToHistory({source:"damage",name:g.name,description:`${i("history.source.damage")}: ${O}d6 ${m(g,"Brutal")?"(Brutal)":""}`,formula:`${O}d6 [${re.join(", ")}] ${A.some(C=>C.includes("->"))?`(Rolagens: ${A.join(", ")})`:""}`,total:V,effectsApplied:n.map(C=>C.name)}),g.type===pt.EXPLOSIVE&&Fe.useConsumable(g)}else{const d=Math.floor(Math.random()*20)+1;let w=0,E=i("history.source.luck");if(t.type==="attribute")w=(s[t.source.key]||t.source.value)-10,E=i(`sofww.attributes.${t.source.key}`);else if(c){let A="str",C=i("sofww.attributes.str");g.range==="Ranged"&&(A="agi",C=i("sofww.attributes.agi"),m(g,"Thrown")&&(A="str",C=i("sofww.attributes.str"))),m(g,"Nimble")&&(A="agi",C=i("sofww.attributes.agi")),w=(s[A]||10)-10,E=C}const x=n.flatMap(A=>Array.isArray(A.modifiers)?A.modifiers:[]).filter(A=>A.target==="boons"&&A.type===on.ADD).reduce((A,C)=>A+an(C.value,r),0);e+=x;let D=0,O="";if(e!==0){const A=Math.abs(e);let C=[];for(let _e=0;_e<A;_e++)C.push(Math.floor(Math.random()*6)+1);const X=Math.max(...C);e>0?(D=X,O=` + ${X} [${i("sofdl.rolls.boon")}]`):(D=-X,O=` - ${X} [${i("sofdl.rolls.bane")}]`)}const re=d+w+D;let V="";if(c?V=`${i("history.source.attack")} (${E})`:h?V=i("history.source.luck"):V=`${i("history.source.attribute")}: ${u}`,e!==0&&(V+=` ${i("sofdl.rolls.attribute_test",{values:{attr:"",modifier:e}}).replace(/^[^ ]+ /,"")}`),c&&d===20){let A=[];m(g,"Bludgeoning")&&A.push(i("sofww.afflictions.vulnerable.name")),m(g,"Piercing")&&A.push(i("sofww.afflictions.weakened.name")),m(g,"Slashing")&&A.push("+1d6 Dmg"),A.length>0&&(V+=`
CRTICO! ${A.join(" ")} `)}Fe.addToHistory({source:c?"attack":h?"luck":"attribute",name:u,description:V,formula:`d20(${d})${w!==0?(w>=0?"+":"")+w:""}${O} `,total:re,crit:d===20,effectsApplied:n.map(A=>A.name)}),I.update(A=>({...A,effects:A.effects.map(C=>C.isActive&&C.duration==="NEXT_ROLL"?{...C,isActive:!1}:C)})),c&&m(g,"Reload")&&I.update(A=>({...A,equipment:A.equipment.map(C=>C.id===g.id?{...C,isLoaded:!1}:C)}))}Kt.set({type:null,isOpen:!1,data:null})},reloadWeapon:t=>{const e=H(rt);I.update(n=>({...n,equipment:n.equipment.map(r=>r.id===t.id?{...r,isLoaded:!0}:r)})),Fe.addToHistory({source:"attribute",name:e("actions.reload"),description:`${e("actions.reload")}: ${t.name}`})},addSpell:t=>I.update(e=>({...e,spells:[...e.spells,t]})),updateSpell:t=>I.update(e=>({...e,spells:e.spells.map(n=>n.id===t.id?t:n)})),deleteSpell:t=>I.update(e=>({...e,spells:e.spells.filter(n=>n.id!==t)})),commitSpellCast:t=>{t.castings>0&&(I.update(e=>({...e,spells:e.spells.map(n=>n.id===t.id?{...n,castings:n.castings-1}:n)})),Fe.addToHistory({source:"spell",name:t.name,description:t.description}),Kt.set({type:null,isOpen:!1,data:null}))},addTalent:t=>I.update(e=>({...e,talents:[...e.talents,t]})),updateTalent:t=>I.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?t:n)})),deleteTalent:t=>I.update(e=>({...e,talents:e.talents.filter(n=>n.id!==t)})),commitTalentUse:t=>{t.activityType==="Duration"&&t.duration==="LUCK_ENDS"?I.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?{...n,uses:0}:n)})):t.maxUses&&I.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?{...n,uses:n.uses-1}:n)})),Fe.addToHistory({source:"talent",name:t.name,description:t.description}),Kt.set({type:null,isOpen:!1,data:null})},recoverTalent:t=>{I.update(e=>({...e,talents:e.talents.map(n=>n.id===t&&n.uses<n.maxUses?{...n,uses:(n.uses||0)+1}:n)}))},rollLuckTalent:t=>{const e=H(rt),n=Math.floor(Math.random()*20)+1,r=n>=10,i=H(I).talents.find(c=>c.id===t);Fe.addToHistory({source:"luck",name:`${e("character.history.source.luck")} - ${i?.name||e("character.talents.title")}`,formula:`d20(${n})`,total:n,description:r?e("character.dice_roll.luck_success",{values:{total:n}}):e("character.dice_roll.luck_failure",{values:{total:n}})}),r&&I.update(c=>({...c,talents:c.talents.map(h=>h.id===t?{...h,uses:1}:h)}))},addEffect:t=>I.update(e=>({...e,effects:[...e.effects,t]})),updateEffect:t=>I.update(e=>({...e,effects:e.effects.map(n=>n.id===t.id?t:n)})),deleteEffect:t=>I.update(e=>({...e,effects:e.effects.filter(n=>n.id!==t)})),toggleEffect:t=>I.update(e=>({...e,effects:e.effects.map(n=>{if(n.id===t){const r=!n.isActive;return{...n,isActive:r,roundsLeft:r&&n.duration==="ROUNDS"&&n.initialRounds||n.roundsLeft}}return n})})),cleanInactiveEffects:()=>I.update(t=>({...t,effects:t.effects.filter(e=>e.isActive)})),applyEffectToCharacter:(t,e)=>{const n=t.name||(e?e.name:"Effect"),r=t.description||(e?e.description:""),s={id:$n(),isActive:!0,name:n,description:r,roundsLeft:0,duration:"PERMANENT",modifiers:[],...t};s.duration==="ROUNDS"&&!s.initialRounds&&(s.initialRounds=s.roundsLeft),I.update(i=>({...i,effects:[...i.effects,s]}))},checkLuckEnds:t=>{const e=H(rt),n=Math.floor(Math.random()*20)+1,r=n>=10;Fe.addToHistory({source:"luck",name:e("sofww.duration.luck_ends"),description:r?e("character.dice_roll.luck_success",{values:{total:n}}):e("character.dice_roll.luck_failure",{values:{total:n}})}),r&&I.update(s=>({...s,effects:s.effects.map(i=>i.id===t?{...i,isActive:!1}:i)}))},joinCampaign:t=>{I.update(e=>({...e,campaignId:t.id,campaignName:t.name,gmName:t.gmName||"Game Master"})),Fs(async()=>{const{joinCampaignRoom:e}=await Promise.resolve().then(()=>ni);return{joinCampaignRoom:e}},void 0,import.meta.url).then(({joinCampaignRoom:e})=>{e(t.id,!1)})},leaveCampaign:()=>{I.update(t=>({...t,campaignId:null,campaignName:null,gmName:null,combatActive:!1}))}},up={id:"",system:"sofdl",name:"",ancestry:"",level:0,paths:{novice:"",expert:"",master:""},imageUrl:"",attributes:{strength:10,agility:10,intellect:10,will:10},perception:10,defense:10,health:10,healingRate:2,size:1,speed:10,power:0,damage:0,insanity:0,corruption:0,description:"",notes:"",professions:[],languages:["Comum"],senses:[],afflictions:[],talents:[],spells:[],equipment:[],currency:{gc:0,ss:0,cp:0,bits:0},effects:[],campaignId:null,campaignName:null,gmName:null,campaignApproval:null,combatActive:!1,currentRound:1,initiative:!1,acted:!1,magicSystem:"standard"},T=Me(JSON.parse(JSON.stringify(up))),hp=ge(T,t=>t.attributes),fp=ge(hp,t=>({strength:t.strength-10,agility:t.agility-10,intellect:t.intellect-10,will:t.will-10}));ge(T,t=>t.health-t.damage);const jp=ge(T,t=>t.damage>=t.health/2),Hp=ge(T,t=>t.damage>=t.health),dp=ge(T,t=>t.effects.filter(e=>e.isActive)),qp=ge([T,dp],([t,e])=>{let n=t.healingRate;return e.forEach(r=>{r.modifiers&&r.modifiers.forEach(s=>{s.target==="healing_rate"&&s.type==="ADD"&&(n+=Number(s.value))})}),Math.max(0,n)}),Xt={set:t=>{T.update(e=>{const n={...e,...t};return t.health!==void 0&&t.healingRate===void 0&&(n.healingRate=Math.floor(n.health/4)),n})},updateAttribute:(t,e)=>{T.update(n=>({...n,attributes:{...n.attributes,[t]:e}}))},takeDamage:t=>{T.update(e=>{const n=Math.max(0,Math.min(e.health,e.damage+t));return{...e,damage:n}})},heal:t=>{T.update(e=>{const n=Math.max(0,e.damage-t);return{...e,damage:n}})},updateStat:(t,e)=>{T.update(n=>({...n,[t]:Math.max(0,e)}))},toggleEffect:t=>{T.update(e=>({...e,effects:e.effects.map(n=>n.id===t?{...n,isActive:!n.isActive}:n)}))},deleteEffect:t=>{T.update(e=>({...e,effects:e.effects.filter(n=>n.id!==t)}))},cleanInactiveEffects:()=>{T.update(t=>({...t,effects:t.effects.filter(e=>e.isActive)}))},advanceRound:t=>{T.update(e=>{if(t==="next"){const n=e.effects.map(r=>r.isActive&&r.duration==="END_OF_ROUND"?{...r,isActive:!1}:r);return{...e,currentRound:e.currentRound+1,effects:n}}return{...e,currentRound:Math.max(1,e.currentRound-1)}})},checkLuckEnds:t=>{const n=H(T).effects.find(s=>s.id===t),r=H(rt);Kt.set({type:"pre_roll",isOpen:!0,data:{type:"luck_ends",system:"sofdl",effectId:t,source:{name:n?.name||r("sofdl.rolls.effect")}}})},checkConcentration:t=>{const n=H(T).effects.find(s=>s.id===t),r=H(rt);Kt.set({type:"pre_roll",isOpen:!0,data:{type:"concentration",system:"sofdl",effectId:t,key:"will",source:{name:n?.name||r("sofdl.rolls.concentration")}}})},addSpell:t=>{T.update(e=>({...e,spells:[...e.spells,{...t,id:t.id||$n()}]}))},updateSpell:t=>{T.update(e=>({...e,spells:e.spells.map(n=>n.id===t.id?t:n)}))},deleteSpell:t=>{T.update(e=>({...e,spells:e.spells.filter(n=>n.id!==t)}))},castSpell:t=>{const n=H(T).spells.find(r=>r.id===t);n&&(T.update(r=>({...r,spells:r.spells.map(s=>s.id===t?{...s,castingsUsed:(s.castingsUsed||0)+1}:s)})),Xt.addToHistory({source:"spell",name:n.name,description:n.description,type:"spell"}))},resetSpellCastings:()=>{T.update(t=>({...t,spells:t.spells.map(e=>({...e,castingsUsed:0}))}))},addTalent:t=>{T.update(e=>({...e,talents:[...e.talents,{...t,id:t.id||$n()}]}))},updateTalent:t=>{T.update(e=>({...e,talents:e.talents.map(n=>n.id===t.id?t:n)}))},deleteTalent:t=>{T.update(e=>({...e,talents:e.talents.filter(n=>n.id!==t)}))},useTalent:t=>{const n=H(T).talents.find(r=>r.id===t);n&&(T.update(r=>({...r,talents:r.talents.map(s=>s.id===t&&s.uses>0?{...s,uses:s.uses-1}:s)})),Xt.addToHistory({source:"talent",name:n.name,description:n.description,type:"talent"}))},resetTalentUses:()=>{T.update(t=>({...t,talents:t.talents.map(e=>({...e,uses:e.maxUses}))}))},addSense:t=>{T.update(e=>({...e,senses:e.senses.includes(t)?e.senses:[...e.senses,t]}))},removeSense:t=>{T.update(e=>({...e,senses:e.senses.filter((n,r)=>r!==t)}))},toggleAffliction:t=>{T.update(e=>({...e,afflictions:e.afflictions.includes(t)?e.afflictions.filter(n=>n!==t):[...e.afflictions,t]}))},leaveCampaign:()=>{T.update(t=>({...t,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}))},addToHistory:(t,e=!0)=>{const n=H(T),r={id:t.id||$n(),timestamp:t.timestamp||new Date,charName:n.name,...t};Nr.update(i=>[r,...i]),H(yc).autoOpenHistory?nr.set(!0):H(nr)||Fi.set(!0),e&&n.campaignId&&Fs(async()=>{const{syncRoll:i}=await Promise.resolve().then(()=>ni);return{syncRoll:i}},void 0,import.meta.url).then(({syncRoll:i})=>{i(r)})},addLanguage:t=>T.update(e=>({...e,languages:[...e.languages,t]})),removeLanguage:t=>T.update(e=>({...e,languages:e.languages.filter((n,r)=>r!==t)})),addProfession:t=>T.update(e=>({...e,professions:[...e.professions,t]})),removeProfession:t=>T.update(e=>({...e,professions:e.professions.filter((n,r)=>r!==t)})),updateCurrency:(t,e)=>{T.update(n=>{const r=Math.max(0,(n.currency[t]||0)+e);return{...n,currency:{...n.currency,[t]:r}}})},addItem:t=>T.update(e=>({...e,equipment:[...e.equipment,t]})),updateItem:t=>T.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?t:n)})),deleteItem:t=>T.update(e=>({...e,equipment:e.equipment.filter(n=>n.id!==t)})),useConsumable:t=>{T.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?{...n,quantity:Math.max(0,n.quantity-1)}:n)}))},reloadWeapon:t=>T.update(e=>({...e,equipment:e.equipment.map(n=>n.id===t.id?{...n,isLoaded:!0}:n)})),finalizeRoll:(t,e,n=[])=>{H(T);const r=H(fp),s=t?.type==="weapon_damage"||t?.type==="spell_damage",i=H(rt),c=t?.source?.name||t?.key||i("character.modals.attribute");if(s){const h=t.source?.damage??t.source?.damageDice??"1d6",f=String(h),g=Number(t.source?.damageMod)||0;let u=0,m=[],d="";if(f==="0")u=0,d="0";else if(!f.includes("d"))u=parseInt(f)||0,d=`${u}`,m=[u];else{const D=f.match(/(\d+)d(\d+)/);if(D){const O=parseInt(D[1])||1,re=parseInt(D[2])||6;for(let V=0;V<O;V++){const A=Math.floor(Math.random()*re)+1;u+=A,m.push(A)}d=`${f} [${m.join(", ")}]`}else u=1,d="1"}const w=u+e+g,E=e+g!==0?`${e+g>0?"+":""}${e+g}`:"",x=H(rt);Xt.addToHistory({source:"damage",name:c,description:x("sofdl.rolls.damage_description",{values:{source:c}}),formula:`${d}${E}`,total:w,effectsApplied:n})}else{const h=Math.floor(Math.random()*20)+1;let f=0,g=c;t.type==="attribute"?(f=r[t.key]||0,g=i(`sofdl.attributes.${t.key}`)):t.type==="luck"&&(f=0,g=i("character.luck_test"));let u=0,m="";if(e!==0){const E=Math.abs(e);let x=[];for(let O=0;O<E;O++)x.push(Math.floor(Math.random()*6)+1);const D=Math.max(...x);e>0?(u=D,m=` + ${D} [${i("sofdl.rolls.boon")}]`):(u=-D,m=` - ${D} [${i("sofdl.rolls.bane")}]`)}let d="attribute";t.type==="weapon_attack"?d="attack":(t.type==="luck"||t.type==="luck_ends")&&(d="luck");const w=h+f+u;Xt.addToHistory({source:d,name:g,description:t.type==="luck_ends"?i("sofdl.rolls.luck_ends",{values:{effect:c}}):i("sofdl.rolls.attribute_test",{values:{attr:g,modifier:e}}),formula:`d20(${h})${f!==0?(f>=0?"+":"")+f:""}${m}`,total:w,crit:h===20,effectsApplied:n}),t.type==="luck_ends"&&w>=10&&T.update(E=>({...E,effects:E.effects.map(x=>x.id===t.effectId?{...x,isActive:!1}:x)}))}},rest:()=>{T.update(t=>{const e=t.spells.map(s=>({...s,castingsUsed:0})),n=t.talents.map(s=>({...s,uses:s.isPassive?0:s.maxUses})),r=Math.max(0,t.damage-t.healingRate);return{...t,spells:e,talents:n,damage:r}})}},Ec={appId:rc,trackerUrls:["wss://tracker.openwebtorrent.com","wss://tracker.files.fm:7073/announce","wss://tracker.webtorrent.dev","wss://toad.vibe.community:443/announce","wss://tracker.btorrent.xyz"]},Je=Me({roomId:null,peers:[],currentCharacterId:null,lastGmUpdate:0,isGM:!1,isConnected:!1}),pp=ge(Je,t=>t.lastGmUpdate?Date.now()-t.lastGmUpdate<6e4:!1);let fe=null,mt=null,rr=null,sr=null,ir=null,or=null,Ct=null,We=null,Oo=0,Ro=0;const gp=2e3,mp={appId:"weird-wizard-vault-lobby"},ei=Me([]);function ar(t,e){if(!t)return!0;try{return t.leave(),!0}catch(n){return console.warn(`Failed to leave ${e}:`,n),!1}}function kc(t){return Date.now()-t>=gp}function ti(){if(!kc(Oo))return console.warn("Lobby join rate limited. Skipping duplicate join attempt."),null;Oo=Date.now(),Ct&&(clearInterval(Ct),Ct=null),ar(mt,"existing lobby"),mt=null;try{mt=fc(mp,"public-discovery");const[t,e]=mt.makeAction("discovery");return e(n=>{ei.update(r=>{const s=r.findIndex(i=>i.id===n.id);if(s!==-1){const i=[...r];return i[s]={...n,lastSeen:Date.now()},i}return[...r,{...n,lastSeen:Date.now()}]})}),Ct=setInterval(()=>{const n=Date.now();ei.update(r=>r.filter(s=>n-s.lastSeen<12e4))},6e4),t}catch(t){return console.error("Failed to join lobby:",t),mt=null,null}}let Xr;function wp(){typeof window<"u"&&(sessionStorage.getItem("lobby-initialized")?mt||(Xr=ti()):(sessionStorage.setItem("lobby-initialized","true"),Xr=ti()))}typeof window<"u"&&(wp(),window.addEventListener("beforeunload",()=>{Uo()}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&Uo()}));function Uo(){Ct&&(clearInterval(Ct),Ct=null),We&&(clearInterval(We),We=null),ar(mt,"lobby"),ar(fe,"room"),mt=null,fe=null}let Yt=null;function yp(t,e=!1,n=null){const r=`campaign-${t}`;if(Yt===r&&fe)return Je.update(s=>({...s,isGM:e,currentCharacterId:n})),fe;if(!kc(Ro))return console.warn("Campaign join rate limited. Skipping duplicate join attempt."),fe;Ro=Date.now(),We&&(clearInterval(We),We=null),ar(fe,"existing campaign room"),fe=null,Yt=null,rr=null,sr=null,ir=null,or=null;try{Yt=r,fe=fc(Ec,Yt),Je.set({isConnected:!0,isGM:e,currentCharacterId:n,peers:[],roomId:t,lastGmUpdate:0});const[s,i]=fe.makeAction("combat"),[c,h]=fe.makeAction("history"),[f,g]=fe.makeAction("charUpdate"),[u,m]=fe.makeAction("campaign");return rr=s,sr=c,ir=f,or=u,i(d=>{e||I.update(w=>({...w,currentRound:d.round,combatActive:d.active}))}),m(d=>{Je.update(w=>({...w,lastGmUpdate:Date.now()})),e||I.update(w=>({...w,campaignName:d.name,gmName:d.gmName,passwordHash:d.passwordHash}))}),e&&Xr&&(We=setInterval(()=>{const d=Un.get(t);d&&d.isPublished&&Xr({id:t,name:d.name,gmName:d.gmName||"Mestre",description:d.description})},3e4)),h(d=>{Fe.addToHistory(d,!1)}),g(d=>{if(e){const w=Un.get(t);if(w){const E=w.members||[],x=E.findIndex(A=>A.id===d.id);let D;if(x!==-1){D=[...E];const A=D[x],C={...d};A.campaignApproval==="approved"&&d.campaignApproval==="pending"&&delete C.campaignApproval,D[x]={...A,...C,lastUpdate:Date.now()}}else D=[...E,{...d,lastUpdate:Date.now()}];const O=w.activeEnemies||[],re=O.findIndex(A=>A.id===d.id&&A.type==="player");let V=O;re!==-1&&(V=[...O],V[re]={...V[re],...d}),Un.set(t,{...w,members:D,activeEnemies:V})}}else{const w=H(Je),E=H(I),x=w.currentCharacterId||E?.id;if(x&&x===d.id){const D=d.system==="sofdl";if(d.campaignApproval==="rejected"||d.campaignId===null){D?Xt.leaveCampaign():I.update(O=>({...O,campaignId:null,campaignName:null,gmName:null,campaignApproval:null}));return}D?Xt.set({name:d.name,afflictions:d.afflictions,senses:d.senses,initiative:d.initiative,acted:d.acted,campaignApproval:d.campaignApproval,imageUrl:d.imageUrl,notes:d.notes,damage:d.damage,health:d.health,healingRate:d.healingRate,insanity:d.insanity,corruption:d.corruption,defense:d.defense,speed:d.speed,power:d.power,attributes:d.attributes}):(I.update(O=>({...O,name:d.name||O.name,afflictions:d.afflictions||O.afflictions,senses:d.senses||O.senses,initiative:d.initiative!==void 0?d.initiative:O.initiative??!1,acted:d.acted!==void 0?d.acted:O.acted??!1,campaignApproval:d.campaignApproval||O.campaignApproval,imageUrl:d.imageUrl||O.imageUrl,notes:d.notes!==void 0?d.notes:O.notes})),d.damage!==void 0&&yn.set(d.damage),d.currentHealth!==void 0&&In.set(d.currentHealth),d.normalHealth!==void 0&&Ni.set(d.normalHealth))}}}),fe.onPeerJoin(d=>{if(Je.update(w=>({...w,peers:[...w.peers,d]})),e){const w=Un.get(t);w&&(w.combat&&s(w.combat),u({name:w.name,gmName:w.gmName||"Mestre",passwordHash:w.passwordHash}))}}),fe.onPeerLeave(d=>{Je.update(w=>({...w,peers:w.peers.filter(E=>E!==d)}))}),fe}catch(s){return console.error("Failed to join campaign room:",s),fe=null,Yt=null,Je.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0}),null}}function bp(t,e){rr&&rr(e)}function Ep(t,e){or&&or({name:e.name,gmName:e.gmName||"Mestre",passwordHash:e.passwordHash})}function kp(t){sr&&sr(t)}function _p(t){ir&&ir(t)}function xp(){We&&(clearInterval(We),We=null),ar(fe,"campaign room"),fe=null,Yt=null,rr=null,sr=null,ir=null,or=null,Je.set({isConnected:!1,isGM:!1,currentCharacterId:null,peers:[],roomId:null,lastGmUpdate:0})}const ni=Object.freeze(Object.defineProperty({__proto__:null,isGmOnline:pp,joinCampaignRoom:yp,joinLobby:ti,leaveCampaignRoom:xp,publicCampaigns:ei,roomConfig:Ec,syncCampaign:Ep,syncCharacter:_p,syncCombat:bp,syncRoll:kp,syncState:Je},Symbol.toStringTag,{value:"Module"}));export{Up as $,cp as A,yn as B,Np as C,$p as D,lp as E,Fp as F,Kt as G,Dp as H,pt as I,Op as J,on as K,Xt as L,Rp as M,T as N,Ni as O,In as P,dp as Q,pr as R,bc as S,Vp as T,Pp as U,Lp as V,jp as W,Hp as X,fp as Y,qp as Z,Bp as _,yp as a,up as a0,op as a1,Mp as a2,Cp as b,I as c,_f as d,Un as e,xf as f,Af as g,_p as h,pp as i,fc as j,Ep as k,xp as l,nr as m,bp as n,Je as o,Fi as p,Fe as q,Ec as r,zt as s,vf as t,$n as u,Sf as v,If as w,yc as x,ei as y,Nr as z};
