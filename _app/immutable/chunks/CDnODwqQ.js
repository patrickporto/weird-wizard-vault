import{an as vt,am as fn,y as St,ak as At,h as Tt,ao as ue,ap as ln}from"./LAPZz738.js";function ds(e,t,n=t){var r=new WeakSet;vt(e,"input",async s=>{var o=s?e.defaultValue:e.value;if(o=Ze(e)?Ve(o):o,n(o),ue!==null&&r.add(ue),await fn(),o!==(o=t())){var u=e.selectionStart,m=e.selectionEnd,d=e.value.length;if(e.value=o??"",m!==null){var p=e.value.length;u===m&&m===d&&p>d?(e.selectionStart=p,e.selectionEnd=p):(e.selectionStart=u,e.selectionEnd=Math.min(m,p))}}}),(Tt&&e.defaultValue!==e.value||St(t)==null&&e.value)&&(n(Ze(e)?Ve(e.value):e.value),ue!==null&&r.add(ue)),At(()=>{var s=t();if(e===document.activeElement){var o=ln??ue;if(r.has(o))return}Ze(e)&&s===Ve(e.value)||e.type==="date"&&!s&&!e.value||s!==e.value&&(e.value=s??"")})}function ys(e,t,n=t){vt(e,"change",r=>{var s=r?e.defaultChecked:e.checked;n(s)}),(Tt&&e.defaultChecked!==e.checked||St(t)==null)&&n(e.checked),At(()=>{var r=t();e.checked=!!r})}function Ze(e){var t=e.type;return t==="number"||t==="range"}function Ve(e){return e===""?null:+e}const xt={p:0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2fn,n:0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141n,h:1n,a:0n,b:7n,Gx:0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798n,Gy:0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8n},{p:z,n:ke,Gx:un,Gy:dn,b:Pt}=xt,$=32,pe=64,Ye={publicKey:$+1,publicKeyUncompressed:pe+1,seed:$+$/2},yn=(...e)=>{"captureStackTrace"in Error&&typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(...e)},P=(e="")=>{const t=new Error(e);throw yn(t,P),t},hn=e=>typeof e=="bigint",mn=e=>typeof e=="string",pn=e=>e instanceof Uint8Array||ArrayBuffer.isView(e)&&e.constructor.name==="Uint8Array",Z=(e,t,n="")=>{const r=pn(e),s=e?.length,o=t!==void 0;if(!r||o&&s!==t){const u=n&&`"${n}" `,m=o?` of length ${t}`:"",d=r?`length=${s}`:`type=${typeof e}`;P(u+"expected Uint8Array"+m+", got "+d)}return e},ge=e=>new Uint8Array(e),Et=(e,t)=>e.toString(16).padStart(t,"0"),_t=e=>Array.from(Z(e)).map(t=>Et(t,2)).join(""),F={_0:48,_9:57,A:65,F:70,a:97,f:102},rt=e=>{if(e>=F._0&&e<=F._9)return e-F._0;if(e>=F.A&&e<=F.F)return e-(F.A-10);if(e>=F.a&&e<=F.f)return e-(F.a-10)},Ct=e=>{const t="hex invalid";if(!mn(e))return P(t);const n=e.length,r=n/2;if(n%2)return P(t);const s=ge(r);for(let o=0,u=0;o<r;o++,u+=2){const m=rt(e.charCodeAt(u)),d=rt(e.charCodeAt(u+1));if(m===void 0||d===void 0)return P(t);s[o]=m*16+d}return s},Lt=()=>globalThis?.crypto,ot=()=>Lt()?.subtle??P("crypto.subtle must be defined, consider polyfill"),ie=(...e)=>{const t=ge(e.reduce((r,s)=>r+Z(s).length,0));let n=0;return e.forEach(r=>{t.set(r,n),n+=r.length}),t},We=(e=$)=>Lt().getRandomValues(ge(e)),Re=BigInt,te=(e,t,n,r="bad number: out of range")=>hn(e)&&t<=e&&e<n?e:P(r),f=(e,t=z)=>{const n=e%t;return n>=0n?n:t+n},$e=e=>f(e,ke),gn=(e,t)=>{(e===0n||t<=0n)&&P("no inverse n="+e+" mod="+t);let n=f(e,t),r=t,s=0n,o=1n;for(;n!==0n;){const u=r/n,m=r%n,d=s-o*u;r=n,n=m,s=o,o=d}return r===1n?f(s,t):P("no inverse")},wn=e=>{const t=Ot[e];return typeof t!="function"&&P("hashes."+e+" not set"),t},Xe=e=>e instanceof D?e:P("Point expected"),Bt=e=>f(f(e*e)*e+Pt),at=e=>te(e,0n,z),Le=e=>te(e,1n,z),bn=e=>te(e,1n,ke),fe=e=>(e&1n)===0n,Ut=e=>Uint8Array.of(e),kn=e=>Ut(fe(e)?2:3),Mt=e=>{const t=Bt(Le(e));let n=1n;for(let r=t,s=(z+1n)/4n;s>0n;s>>=1n)s&1n&&(n=n*r%z),r=r*r%z;return f(n*n)===t?n:P("sqrt invalid")};class D{static BASE;static ZERO;X;Y;Z;constructor(t,n,r){this.X=at(t),this.Y=Le(n),this.Z=at(r),Object.freeze(this)}static CURVE(){return xt}static fromAffine(t){const{x:n,y:r}=t;return n===0n&&r===0n?Q:new D(n,r,1n)}static fromBytes(t){Z(t);const{publicKey:n,publicKeyUncompressed:r}=Ye;let s;const o=t.length,u=t[0],m=t.subarray(1),d=Ne(m,0,$);if(o===n&&(u===2||u===3)){let p=Mt(d);const h=fe(p);fe(Re(u))!==h&&(p=f(-p)),s=new D(d,p,1n)}return o===r&&u===4&&(s=new D(d,Ne(m,$,pe),1n)),s?s.assertValidity():P("bad point: not on curve")}static fromHex(t){return D.fromBytes(Ct(t))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}equals(t){const{X:n,Y:r,Z:s}=this,{X:o,Y:u,Z:m}=Xe(t),d=f(n*m),p=f(o*s),h=f(r*m),c=f(u*s);return d===p&&h===c}is0(){return this.equals(Q)}negate(){return new D(this.X,f(-this.Y),this.Z)}double(){return this.add(this)}add(t){const{X:n,Y:r,Z:s}=this,{X:o,Y:u,Z:m}=Xe(t),d=0n,p=Pt;let h=0n,c=0n,i=0n;const w=f(p*3n);let v=f(n*o),T=f(r*u),E=f(s*m),N=f(n+r),_=f(o+u);N=f(N*_),_=f(v+T),N=f(N-_),_=f(n+s);let M=f(o+m);return _=f(_*M),M=f(v+E),_=f(_-M),M=f(r+s),h=f(u+m),M=f(M*h),h=f(T+E),M=f(M-h),i=f(d*_),h=f(w*E),i=f(h+i),h=f(T-i),i=f(T+i),c=f(h*i),T=f(v+v),T=f(T+v),E=f(d*E),_=f(w*_),T=f(T+E),E=f(v-E),E=f(d*E),_=f(_+E),v=f(T*_),c=f(c+v),v=f(M*_),h=f(N*h),h=f(h-v),v=f(N*T),i=f(M*i),i=f(i+v),new D(h,c,i)}subtract(t){return this.add(Xe(t).negate())}multiply(t,n=!0){if(!n&&t===0n)return Q;if(bn(t),t===1n)return this;if(this.equals(ne))return Un(t).p;let r=Q,s=ne;for(let o=this;t>0n;o=o.double(),t>>=1n)t&1n?r=r.add(o):n&&(s=s.add(o));return r}multiplyUnsafe(t){return this.multiply(t,!1)}toAffine(){const{X:t,Y:n,Z:r}=this;if(this.equals(Q))return{x:0n,y:0n};if(r===1n)return{x:t,y:n};const s=gn(r,z);return f(r*s)!==1n&&P("inverse invalid"),{x:f(t*s),y:f(n*s)}}assertValidity(){const{x:t,y:n}=this.toAffine();return Le(t),Le(n),f(n*n)===Bt(t)?this:P("bad point: not on curve")}toBytes(t=!0){const{x:n,y:r}=this.assertValidity().toAffine(),s=V(n);return t?ie(kn(r),s):ie(Ut(4),s,V(r))}toHex(t){return _t(this.toBytes(t))}}const ne=new D(un,dn,1n),Q=new D(0n,1n,0n);D.BASE=ne;D.ZERO=Q;const vn=(e,t,n)=>ne.multiply(t,!1).add(e.multiply(n,!1)).assertValidity(),se=e=>Re("0x"+(_t(e)||"0")),Ne=(e,t,n)=>se(e.subarray(t,n)),Sn=2n**256n,V=e=>Ct(Et(te(e,0n,Sn),pe)),An=e=>{const t=se(Z(e,$,"secret key"));return te(t,1n,ke,"invalid secret key: outside of range")},ct="SHA-256",Ot={hmacSha256Async:async(e,t)=>{const n=ot(),r="HMAC",s=await n.importKey("raw",e,{name:r,hash:{name:ct}},!1,["sign"]);return ge(await n.sign(r,s,t))},hmacSha256:void 0,sha256Async:async e=>ge(await ot().digest(ct,e)),sha256:void 0},Tn=(e=We(Ye.seed))=>{Z(e),(e.length<Ye.seed||e.length>1024)&&P("expected 40-1024b");const t=f(se(e),ke-1n);return V(t+1n)},xn=e=>t=>{const n=Tn(t);return{secretKey:n,publicKey:e(n)}},Rt=e=>Uint8Array.from("BIP0340/"+e,t=>t.charCodeAt(0)),Nt="aux",Ht="nonce",Dt="challenge",je=(e,...t)=>{const n=wn("sha256"),r=n(Rt(e));return n(ie(r,r,...t))},Ie=async(e,...t)=>{const n=Ot.sha256Async,r=await n(Rt(e));return await n(ie(r,r,...t))},Qe=e=>{const t=An(e),n=ne.multiply(t),{x:r,y:s}=n.assertValidity().toAffine(),o=fe(s)?t:$e(-t),u=V(r);return{d:o,px:u}},et=e=>$e(se(e)),$t=(...e)=>et(je(Dt,...e)),Kt=async(...e)=>et(await Ie(Dt,...e)),Zt=e=>Qe(e).px,Pn=xn(Zt),Vt=(e,t,n)=>{const{px:r,d:s}=Qe(t);return{m:Z(e),px:r,d:s,a:Z(n,$)}},Xt=e=>{const t=et(e);t===0n&&P("sign failed: k is zero");const{px:n,d:r}=Qe(V(t));return{rx:n,k:r}},Yt=(e,t,n,r)=>ie(t,V($e(e+n*r))),jt="invalid signature produced",En=(e,t,n=We($))=>{const{m:r,px:s,d:o,a:u}=Vt(e,t,n),m=je(Nt,u),d=V(o^se(m)),p=je(Ht,d,s,r),{rx:h,k:c}=Xt(p),i=$t(h,s,r),w=Yt(c,h,i,o);return Ft(w,r,s)||P(jt),w},_n=async(e,t,n=We($))=>{const{m:r,px:s,d:o,a:u}=Vt(e,t,n),m=await Ie(Nt,u),d=V(o^se(m)),p=await Ie(Ht,d,s,r),{rx:h,k:c}=Xt(p),i=await Kt(h,s,r),w=Yt(c,h,i,o);return await Gt(w,r,s)||P(jt),w},Cn=(e,t)=>e instanceof Promise?e.then(t):t(e),It=(e,t,n,r)=>{const s=Z(e,pe,"signature"),o=Z(t,void 0,"message"),u=Z(n,$,"publicKey");try{const m=se(u),d=Mt(m),p=fe(d)?d:f(-d),h=new D(m,p,1n).assertValidity(),c=V(h.toAffine().x),i=Ne(s,0,$);te(i,1n,z);const w=Ne(s,$,pe);te(w,1n,ke);const v=ie(V(i),c,o);return Cn(r(v),T=>{const{x:E,y:N}=vn(h,w,$e(-T)).toAffine();return!(!fe(N)||E!==i)})}catch{return!1}},Ft=(e,t,n)=>It(e,t,n,$t),Gt=async(e,t,n)=>It(e,t,n,Kt),Jt={keygen:Pn,getPublicKey:Zt,sign:En,verify:Ft,signAsync:_n,verifyAsync:Gt},He=8,Ln=256,qt=Math.ceil(Ln/He)+1,Fe=2**(He-1),Bn=()=>{const e=[];let t=ne,n=t;for(let r=0;r<qt;r++){n=t,e.push(n);for(let s=1;s<Fe;s++)n=n.add(t),e.push(n);t=n.double()}return e};let it;const ft=(e,t)=>{const n=t.negate();return e?n:t},Un=e=>{const t=it||(it=Bn());let n=Q,r=ne;const s=2**He,o=s,u=Re(s-1),m=Re(He);for(let d=0;d<qt;d++){let p=Number(e&u);e>>=m,p>Fe&&(p-=o,e+=1n);const h=d*Fe,c=h,i=h+Math.abs(p)-1,w=d%2!==0,v=p<0;p===0?r=r.add(ft(w,t[c])):n=n.add(ft(v,t[i]))}return e!==0n&&P("invalid wnaf"),{p:n,f:r}},{floor:Ge,random:Mn,sin:On}=Math,we="Trystero",be=(e,t)=>Array(e).fill().map(t),lt="0123456789AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz",Je=e=>be(e,()=>lt[Ge(Mn()*lt.length)]).join(""),ae=Je(20),ee=Promise.all.bind(Promise),zt=typeof window<"u",{entries:ut,fromEntries:Rn,keys:Nn}=Object,G=()=>{},J=e=>new Error(`${we}: ${e}`),Hn=new TextEncoder,Dn=new TextDecoder,ce=e=>Hn.encode(e),Be=e=>Dn.decode(e),qe=e=>e.reduce((t,n)=>t+n.toString(16).padStart(2,"0"),""),Pe=(...e)=>e.join("@"),$n=(e,t)=>{const n=[...e],r=()=>{const o=On(t++)*1e4;return o-Ge(o)};let s=n.length;for(;s;){const o=Ge(r()*s--);[n[s],n[o]]=[n[o],n[s]]}return n},Kn=(e,t,n,r)=>(e.relayUrls||$n(t,Wt(e.appId))).slice(0,e.relayUrls?e.relayUrls.length:e.relayRedundancy||n),q=JSON.stringify,De=JSON.parse,Wt=(e,t=Number.MAX_SAFE_INTEGER)=>e.split("").reduce((n,r)=>n+r.charCodeAt(0),0)%t,dt=3333,Ee={};let me=null,ze=null;const Zn=()=>{me||(me=new Promise(e=>{ze=e}).finally(()=>{ze=null,me=null}))},Vn=()=>ze?.(),Xn=(e,t)=>{const n={},r=()=>{const s=new WebSocket(e);s.onclose=()=>{if(me){me.then(r);return}Ee[e]??=dt,setTimeout(r,Ee[e]),Ee[e]*=2},s.onmessage=o=>t(o.data),n.socket=s,n.url=s.url,n.ready=new Promise(o=>s.onopen=()=>{o(n),Ee[e]=dt}),n.send=o=>{s.readyState===1&&s.send(o)}};return r(),n},Yn=()=>{if(zt){const e=new AbortController;return addEventListener("online",Vn,{signal:e.signal}),addEventListener("offline",Zn,{signal:e.signal}),()=>e.abort()}return G},tt="AES-GCM",jn={},In=e=>btoa(String.fromCharCode.apply(null,new Uint8Array(e))),Fn=e=>{const t=atob(e);return new Uint8Array(t.length).map((n,r)=>t.charCodeAt(r)).buffer},Qt=async(e,t)=>new Uint8Array(await crypto.subtle.digest(e,ce(t))),_e=async e=>jn[e]||=Array.from(await Qt("SHA-1",e)).map(t=>t.toString(36)).join(""),Gn=async(e,t,n)=>crypto.subtle.importKey("raw",await crypto.subtle.digest({name:"SHA-256"},ce(`${e}:${t}:${n}`)),{name:tt},!1,["encrypt","decrypt"]),en="$",tn=",",Jn=async(e,t)=>{const n=crypto.getRandomValues(new Uint8Array(16));return n.join(tn)+en+In(await crypto.subtle.encrypt({name:tt,iv:n},await e,ce(t)))},qn=async(e,t)=>{const[n,r]=t.split(en);return Be(await crypto.subtle.decrypt({name:tt,iv:new Uint8Array(n.split(tn))},await e,Fn(r)))},zn=5e3,yt="icegatheringstatechange",ht="offer",Wn="answer",mt=(e,{rtcConfig:t,rtcPolyfill:n,turnConfig:r})=>{const s=new(n||RTCPeerConnection)({iceServers:Qn.concat(r||[]),...t}),o={};let u=!1,m=!1,d=null;const p=c=>{c.binaryType="arraybuffer",c.bufferedAmountLowThreshold=65535,c.onmessage=i=>o.data?.(i.data),c.onopen=()=>o.connect?.(),c.onclose=()=>o.close?.(),c.onerror=i=>o.error?.(i)},h=c=>Promise.race([new Promise(i=>{const w=()=>{c.iceGatheringState==="complete"&&(c.removeEventListener(yt,w),i())};c.addEventListener(yt,w),w()}),new Promise(i=>setTimeout(i,zn))]).then(()=>({type:c.localDescription.type,sdp:c.localDescription.sdp.replace(/a=ice-options:trickle\s\n/g,"")}));return e?(d=s.createDataChannel("data"),p(d)):s.ondatachannel=({channel:c})=>{d=c,p(c)},s.onnegotiationneeded=async()=>{try{u=!0,await s.setLocalDescription();const c=await h(s);o.signal?.(c)}catch(c){o.error?.(c)}finally{u=!1}},s.onconnectionstatechange=()=>{["disconnected","failed","closed"].includes(s.connectionState)&&o.close?.()},s.ontrack=c=>{o.track?.(c.track,c.streams[0]),o.stream?.(c.streams[0])},s.onremovestream=c=>o.stream?.(c.stream),e&&(s.canTrickleIceCandidates||s.onnegotiationneeded()),{created:Date.now(),connection:s,get channel(){return d},get isDead(){return s.connectionState==="closed"},async signal(c){if(!(d?.readyState==="open"&&!c.sdp?.includes("a=rtpmap")))try{if(c.type===ht){if(u||s.signalingState!=="stable"&&!m){if(e)return;await ee([s.setLocalDescription({type:"rollback"}),s.setRemoteDescription(c)])}else await s.setRemoteDescription(c);await s.setLocalDescription();const i=await h(s);return o.signal?.(i),i}else if(c.type===Wn){m=!0;try{await s.setRemoteDescription(c)}finally{m=!1}}}catch(i){o.error?.(i)}},sendData:c=>d.send(c),destroy:()=>{d?.close(),s.close(),u=!1,m=!1},setHandlers:c=>Object.assign(o,c),offerPromise:e?new Promise(c=>o.signal=i=>{i.type===ht&&c(i)}):Promise.resolve(),addStream:c=>c.getTracks().forEach(i=>s.addTrack(i,c)),removeStream:c=>s.getSenders().filter(i=>c.getTracks().includes(i.track)).forEach(i=>s.removeTrack(i)),addTrack:(c,i)=>s.addTrack(c,i),removeTrack:c=>{const i=s.getSenders().find(w=>w.track===c);i&&s.removeTrack(i)},replaceTrack:(c,i)=>{const w=s.getSenders().find(v=>v.track===c);if(w)return w.replaceTrack(i)}}},Qn=[...be(3,(e,t)=>`stun:stun${t||""}.l.google.com:19302`),"stun:stun.cloudflare.com:3478"].map(e=>({urls:e})),es=Object.getPrototypeOf(Uint8Array),Ue=12,nn=0,Me=nn+Ue,Oe=Me+1,ye=Oe+1,he=ye+1,W=16*2**10-he,Ce=255,pt="bufferedamountlow",oe=e=>"@_"+e,ts=(e,t,n)=>{const r={},s={},o={},u={},m={},d={},p={},h={onPeerJoin:G,onPeerLeave:G,onPeerStream:G,onPeerTrack:G},c=(a,l)=>(a?Array.isArray(a)?a:[a]:Nn(r)).flatMap(b=>{const k=r[b];return k?l(b,k):(console.warn(`${we}: no peer with id ${b} found`),[])}),i=a=>{r[a]&&(r[a].destroy(),delete r[a],delete u[a],delete m[a],h.onPeerLeave(a),t(a))},w=a=>{if(s[a])return o[a];if(!a)throw J("action type argument is required");const l=ce(a);if(l.byteLength>Ue)throw J(`action type string "${a}" (${l.byteLength}b) exceeds byte limit (${Ue}). Hint: choose a shorter name.`);const b=new Uint8Array(Ue);b.set(l);let k=0;return s[a]={onComplete:G,onProgress:G,setOnComplete:A=>s[a]={...s[a],onComplete:A},setOnProgress:A=>s[a]={...s[a],onProgress:A},send:async(A,y,g,x)=>{if(g&&typeof g!="object")throw J("action meta argument must be an object");const H=typeof A;if(H==="undefined")throw J("action data cannot be undefined");const L=H!=="string",X=A instanceof Blob,S=X||A instanceof ArrayBuffer||A instanceof es;if(g&&!S)throw J("action meta argument can only be used with binary data");const O=S?new Uint8Array(X?await A.arrayBuffer():A):ce(L?q(A):A),K=g?ce(q(g)):null,C=Math.ceil(O.byteLength/W)+(g?1:0)||1,B=be(C,(U,R)=>{const Y=R===C-1,j=g&&R===0,I=new Uint8Array(he+(j?K.byteLength:Y?O.byteLength-W*(C-(g?2:1)):W));return I.set(b),I.set([k],Me),I.set([Y|j<<1|S<<2|L<<3],Oe),I.set([Math.round((R+1)/C*Ce)],ye),I.set(g?j?K:O.subarray((R-1)*W,R*W):O.subarray(R*W,(R+1)*W),he),I});return k=k+1&Ce,ee(c(y,async(U,R)=>{const{channel:Y}=R;let j=0;for(;j<C;){const I=B[j];if(Y.bufferedAmount>Y.bufferedAmountLowThreshold&&await new Promise(cn=>{const st=()=>{Y.removeEventListener(pt,st),cn()};Y.addEventListener(pt,st)}),!r[U])break;R.sendData(I),j++,x?.(I[ye]/Ce,U,g)}}))}},o[a]||=[s[a].send,s[a].setOnComplete,s[a].setOnProgress]},v=(a,l)=>{const b=new Uint8Array(l),k=Be(b.subarray(nn,Me)).replaceAll("\0",""),[A]=b.subarray(Me,Oe),[y]=b.subarray(Oe,ye),[g]=b.subarray(ye,he),x=b.subarray(he),H=!!(y&1),L=!!(y&2),X=!!(y&4),S=!!(y&8);if(!s[k]){console.warn(`${we}: received message with unregistered type (${k})`);return}u[a]||={},u[a][k]||={};const O=u[a][k][A]||={chunks:[]};if(L?O.meta=De(Be(x)):O.chunks.push(x),s[k].onProgress(g/Ce,a,O.meta),!H)return;const K=new Uint8Array(O.chunks.reduce((C,B)=>C+B.byteLength,0));if(O.chunks.reduce((C,B)=>(K.set(B,C),C+B.byteLength),0),delete u[a][k][A],X)s[k].onComplete(K,a,O.meta);else{const C=Be(K);s[k].onComplete(S?De(C):C,a)}},T=async()=>{await Te(""),await new Promise(a=>setTimeout(a,99)),ut(r).forEach(([a,l])=>{l.destroy(),delete r[a]}),n()},[E,N]=w(oe("ping")),[_,M]=w(oe("pong")),[ve,Se]=w(oe("signal")),[Ae,le]=w(oe("stream")),[re,Ke]=w(oe("track")),[Te,xe]=w(oe("leave"));return e((a,l)=>{r[l]||(r[l]=a,a.setHandlers({data:b=>v(l,b),stream:b=>{h.onPeerStream(b,l,d[l]),delete d[l]},track:(b,k)=>{h.onPeerTrack(b,k,l,p[l]),delete p[l]},signal:b=>ve(b,l),close:()=>i(l),error:b=>{console.error(b),i(l)}}),h.onPeerJoin(l))}),N((a,l)=>_("",l)),M((a,l)=>{m[l]?.(),delete m[l]}),Se((a,l)=>r[l]?.signal(a)),le((a,l)=>d[l]=a),Ke((a,l)=>p[l]=a),xe((a,l)=>i(l)),zt&&addEventListener("beforeunload",T),{makeAction:w,leave:T,ping:async a=>{if(!a)throw J("ping() must be called with target peer ID");const l=Date.now();return E("",a),await new Promise(b=>m[a]=b),Date.now()-l},getPeers:()=>Rn(ut(r).map(([a,l])=>[a,l.connection])),addStream:(a,l,b)=>c(l,async(k,A)=>{b&&await Ae(b,k),A.addStream(a)}),removeStream:(a,l)=>c(l,(b,k)=>k.removeStream(a)),addTrack:(a,l,b,k)=>c(b,async(A,y)=>{k&&await re(k,A),y.addTrack(a,l)}),removeTrack:(a,l)=>c(l,(b,k)=>k.removeTrack(a)),replaceTrack:(a,l,b,k)=>c(b,async(A,y)=>{k&&await re(k,A),y.replaceTrack(a,l)}),onPeerJoin:a=>h.onPeerJoin=a,onPeerLeave:a=>h.onPeerLeave=a,onPeerStream:a=>h.onPeerStream=a,onPeerTrack:a=>h.onPeerTrack=a}},ns=20,ss=5333,gt=57333,rs=({init:e,subscribe:t,announce:n})=>{const r={};let s=!1,o,u,m,d;return(p,h,c)=>{const{appId:i}=p;if(r[i]?.[h])return r[i][h];const w={},v={},T=Pe(we,i,h),E=_e(T),N=_e(Pe(T,ae)),_=Gn(p.password||"",i,h),M=y=>async g=>({type:g.type,sdp:await y(_,g.sdp)}),ve=M(qn),Se=M(Jn),Ae=()=>mt(!0,p),le=(y,g,x)=>{if(v[g]){v[g]!==y&&y.destroy();return}v[g]=y,A(y,g),w[g]?.forEach((H,L)=>{L!==x&&H.destroy()}),delete w[g]},re=(y,g)=>{v[g]===y&&delete v[g]},Ke=(y,g)=>{if(v[y])return;const x=w[y]?.[g];x&&(delete w[y][g],x.destroy())},Te=y=>(u.push(...be(y,Ae)),ee(u.splice(0,y).map(g=>g.offerPromise.then(Se).then(x=>({peer:g,offer:x}))))),xe=(y,g)=>c?.({error:`incorrect password (${p.password}) when decrypting ${g}`,appId:i,peerId:y,roomId:h}),a=y=>async(g,x,H)=>{const[L,X]=await ee([E,N]);if(g!==L&&g!==X)return;const{peerId:S,offer:O,answer:K,peer:C}=typeof x=="string"?De(x):x;if(!(S===ae||v[S])){if(S&&!O&&!K){if(w[S]?.[y])return;const[[{peer:B,offer:U}],R]=await ee([Te(1),_e(Pe(T,S))]);w[S]||=[],w[S][y]=B,setTimeout(()=>Ke(S,y),l[y]*.9),B.setHandlers({connect:()=>le(B,S,y),close:()=>re(B,S)}),H(R,q({peerId:ae,offer:U}))}else if(O){if(w[S]?.[y]&&ae>S)return;const U=mt(!1,p);U.setHandlers({connect:()=>le(U,S,y),close:()=>re(U,S)});let R;try{R=await ve(O)}catch{xe(S,"offer");return}if(U.isDead)return;const[Y,j]=await ee([_e(Pe(T,S)),U.signal(R)]);H(Y,q({peerId:ae,answer:await Se(j)}))}else if(K){let B;try{B=await ve(K)}catch{xe(S,"answer");return}if(C)C.setHandlers({connect:()=>le(C,S,y),close:()=>re(C,S)}),C.signal(B);else{const U=w[S]?.[y];U&&!U.isDead&&U.signal(B)}}}};if(!p)throw J("requires a config map as the first argument");if(!i&&!p.firebaseApp)throw J("config map is missing appId field");if(!h)throw J("roomId argument required");if(!s){const y=e(p);u=be(ns,Ae),o=Array.isArray(y)?y:[y],s=!0,m=setInterval(()=>u=u.filter(g=>{const x=Date.now()-g.created<gt;return x||g.destroy(),x}),gt*1.03),d=p.manualRelayReconnection?G:Yn()}const l=o.map(()=>ss),b=[],k=o.map(async(y,g)=>t(await y,await E,await N,a(g),Te));ee([E,N]).then(([y,g])=>{const x=async(H,L)=>{const X=await n(H,y,g);typeof X=="number"&&(l[L]=X),b[L]=setTimeout(()=>x(H,L),l[L])};k.forEach(async(H,L)=>{await H,x(await o[L],L)})});let A=G;return r[i]||={},r[i][h]=ts(y=>A=y,y=>delete v[y],()=>{delete r[i][h],b.forEach(clearTimeout),k.forEach(async y=>(await y)()),clearInterval(m),d(),s=!1})}},os=5,sn="x",rn="EVENT",{secretKey:as,publicKey:cs}=Jt.keygen(),is=qe(cs),nt={},de={},fs={},on=()=>Math.floor(Date.now()/1e3),an=e=>fs[e]??=Wt(e,1e4)+2e4,wt=async(e,t)=>{const n={kind:an(e),tags:[[sn,e]],created_at:on(),content:t,pubkey:is},r=await Qt("SHA-256",q([0,n.pubkey,n.created_at,n.kind,n.tags,n.content]));return q([rn,{...n,id:qe(r),sig:qe(await Jt.signAsync(r,as))}])},bt=(e,t)=>(nt[e]=t,q(["REQ",e,{kinds:[an(t)],since:on(),["#"+sn]:[t]}])),kt=e=>(delete nt[e],q(["CLOSE",e])),hs=rs({init:e=>Kn(e,ls,os).map(t=>{const n=Xn(t,r=>{const[s,o,u,m]=De(r);if(s!==rn){const d=`${we}: relay failure from ${n.url} - `;s==="NOTICE"?console.warn(d+o):s==="OK"&&!u&&console.warn(d+m);return}de[o]?.(nt[o],u.content)});return n.ready}),subscribe:(e,t,n,r)=>{const s=Je(64),o=Je(64);return de[s]=de[o]=(u,m)=>r(u,m,async(d,p)=>e.send(await wt(d,p))),e.send(bt(s,t)),e.send(bt(o,n)),()=>{e.send(kt(s)),e.send(kt(o)),delete de[s],delete de[o]}},announce:async(e,t)=>e.send(await wt(t,q({peerId:ae})))}),ls=["black.nostrcity.club","ftp.halifax.rwth-aachen.de/nostr","nos.lol","nostr.cool110.xyz","nostr.data.haus","nostr.sathoarder.com","nostr.vulpem.com","relay.agorist.space","relay.binaryrobot.com","relay.damus.io","relay.fountain.fm","relay.mostro.network","relay.nostraddress.com","relay.nostrdice.com","relay.nostromo.social","relay.oldenburg.cool","relay.verified-nostr.com","yabu.me/v2"].map(e=>"wss://"+e);export{ys as a,ds as b,hs as j,ae as s};
